<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>odoo.tools.translate &mdash; Amr  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Amr
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">odoo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Amr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../odoo.html">odoo</a></li>
      <li class="breadcrumb-item active">odoo.tools.translate</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for odoo.tools.translate</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># Part of Odoo. See LICENSE file for full copyright and licensing details.</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">locale</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">tokenize</span> <span class="kn">import</span> <span class="n">generate_tokens</span><span class="p">,</span> <span class="n">STRING</span><span class="p">,</span> <span class="n">NEWLINE</span><span class="p">,</span> <span class="n">INDENT</span><span class="p">,</span> <span class="n">DEDENT</span>
<span class="kn">import</span> <span class="nn">polib</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">suppress</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">babel.messages</span> <span class="kn">import</span> <span class="n">extract</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span><span class="p">,</span> <span class="n">html</span>
<span class="kn">from</span> <span class="nn">markupsafe</span> <span class="kn">import</span> <span class="n">escape</span><span class="p">,</span> <span class="n">Markup</span>
<span class="kn">from</span> <span class="nn">psycopg2.extras</span> <span class="kn">import</span> <span class="n">Json</span>

<span class="kn">import</span> <span class="nn">odoo</span>
<span class="kn">from</span> <span class="nn">odoo.exceptions</span> <span class="kn">import</span> <span class="n">UserError</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">pycompat</span>
<span class="kn">from</span> <span class="nn">.misc</span> <span class="kn">import</span> <span class="n">file_open</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">get_iso_codes</span><span class="p">,</span> <span class="n">SKIPPED_ELEMENT_TYPES</span>

<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">PYTHON_TRANSLATION_COMMENT</span> <span class="o">=</span> <span class="s1">&#39;odoo-python&#39;</span>

<span class="c1"># translation used for javascript code in web client</span>
<span class="n">JAVASCRIPT_TRANSLATION_COMMENT</span> <span class="o">=</span> <span class="s1">&#39;odoo-javascript&#39;</span>
<span class="c1"># used to notify web client that these translations should be loaded in the UI</span>
<span class="c1"># deprecated comment since Odoo 16.0</span>
<span class="n">WEB_TRANSLATION_COMMENT</span> <span class="o">=</span> <span class="s2">&quot;openerp-web&quot;</span>

<span class="n">SKIPPED_ELEMENTS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">)</span>

<span class="n">_LOCALE2WIN32</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;af_ZA&#39;</span><span class="p">:</span> <span class="s1">&#39;Afrikaans_South Africa&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sq_AL&#39;</span><span class="p">:</span> <span class="s1">&#39;Albanian_Albania&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ar_SA&#39;</span><span class="p">:</span> <span class="s1">&#39;Arabic_Saudi Arabia&#39;</span><span class="p">,</span>
    <span class="s1">&#39;eu_ES&#39;</span><span class="p">:</span> <span class="s1">&#39;Basque_Spain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;be_BY&#39;</span><span class="p">:</span> <span class="s1">&#39;Belarusian_Belarus&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bs_BA&#39;</span><span class="p">:</span> <span class="s1">&#39;Bosnian_Bosnia and Herzegovina&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bg_BG&#39;</span><span class="p">:</span> <span class="s1">&#39;Bulgarian_Bulgaria&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ca_ES&#39;</span><span class="p">:</span> <span class="s1">&#39;Catalan_Spain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hr_HR&#39;</span><span class="p">:</span> <span class="s1">&#39;Croatian_Croatia&#39;</span><span class="p">,</span>
    <span class="s1">&#39;zh_CN&#39;</span><span class="p">:</span> <span class="s1">&#39;Chinese_China&#39;</span><span class="p">,</span>
    <span class="s1">&#39;zh_TW&#39;</span><span class="p">:</span> <span class="s1">&#39;Chinese_Taiwan&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cs_CZ&#39;</span><span class="p">:</span> <span class="s1">&#39;Czech_Czech Republic&#39;</span><span class="p">,</span>
    <span class="s1">&#39;da_DK&#39;</span><span class="p">:</span> <span class="s1">&#39;Danish_Denmark&#39;</span><span class="p">,</span>
    <span class="s1">&#39;nl_NL&#39;</span><span class="p">:</span> <span class="s1">&#39;Dutch_Netherlands&#39;</span><span class="p">,</span>
    <span class="s1">&#39;et_EE&#39;</span><span class="p">:</span> <span class="s1">&#39;Estonian_Estonia&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fa_IR&#39;</span><span class="p">:</span> <span class="s1">&#39;Farsi_Iran&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ph_PH&#39;</span><span class="p">:</span> <span class="s1">&#39;Filipino_Philippines&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fi_FI&#39;</span><span class="p">:</span> <span class="s1">&#39;Finnish_Finland&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fr_FR&#39;</span><span class="p">:</span> <span class="s1">&#39;French_France&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fr_BE&#39;</span><span class="p">:</span> <span class="s1">&#39;French_France&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fr_CH&#39;</span><span class="p">:</span> <span class="s1">&#39;French_France&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fr_CA&#39;</span><span class="p">:</span> <span class="s1">&#39;French_France&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ga&#39;</span><span class="p">:</span> <span class="s1">&#39;Scottish Gaelic&#39;</span><span class="p">,</span>
    <span class="s1">&#39;gl_ES&#39;</span><span class="p">:</span> <span class="s1">&#39;Galician_Spain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ka_GE&#39;</span><span class="p">:</span> <span class="s1">&#39;Georgian_Georgia&#39;</span><span class="p">,</span>
    <span class="s1">&#39;de_DE&#39;</span><span class="p">:</span> <span class="s1">&#39;German_Germany&#39;</span><span class="p">,</span>
    <span class="s1">&#39;el_GR&#39;</span><span class="p">:</span> <span class="s1">&#39;Greek_Greece&#39;</span><span class="p">,</span>
    <span class="s1">&#39;gu&#39;</span><span class="p">:</span> <span class="s1">&#39;Gujarati_India&#39;</span><span class="p">,</span>
    <span class="s1">&#39;he_IL&#39;</span><span class="p">:</span> <span class="s1">&#39;Hebrew_Israel&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hi_IN&#39;</span><span class="p">:</span> <span class="s1">&#39;Hindi&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hu&#39;</span><span class="p">:</span> <span class="s1">&#39;Hungarian_Hungary&#39;</span><span class="p">,</span>
    <span class="s1">&#39;is_IS&#39;</span><span class="p">:</span> <span class="s1">&#39;Icelandic_Iceland&#39;</span><span class="p">,</span>
    <span class="s1">&#39;id_ID&#39;</span><span class="p">:</span> <span class="s1">&#39;Indonesian_Indonesia&#39;</span><span class="p">,</span>
    <span class="s1">&#39;it_IT&#39;</span><span class="p">:</span> <span class="s1">&#39;Italian_Italy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ja_JP&#39;</span><span class="p">:</span> <span class="s1">&#39;Japanese_Japan&#39;</span><span class="p">,</span>
    <span class="s1">&#39;kn_IN&#39;</span><span class="p">:</span> <span class="s1">&#39;Kannada&#39;</span><span class="p">,</span>
    <span class="s1">&#39;km_KH&#39;</span><span class="p">:</span> <span class="s1">&#39;Khmer&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ko_KR&#39;</span><span class="p">:</span> <span class="s1">&#39;Korean_Korea&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lo_LA&#39;</span><span class="p">:</span> <span class="s1">&#39;Lao_Laos&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lt_LT&#39;</span><span class="p">:</span> <span class="s1">&#39;Lithuanian_Lithuania&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="s1">&#39;Latvian_Latvia&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ml_IN&#39;</span><span class="p">:</span> <span class="s1">&#39;Malayalam_India&#39;</span><span class="p">,</span>
    <span class="s1">&#39;mi_NZ&#39;</span><span class="p">:</span> <span class="s1">&#39;Maori&#39;</span><span class="p">,</span>
    <span class="s1">&#39;mn&#39;</span><span class="p">:</span> <span class="s1">&#39;Cyrillic_Mongolian&#39;</span><span class="p">,</span>
    <span class="s1">&#39;no_NO&#39;</span><span class="p">:</span> <span class="s1">&#39;Norwegian_Norway&#39;</span><span class="p">,</span>
    <span class="s1">&#39;nn_NO&#39;</span><span class="p">:</span> <span class="s1">&#39;Norwegian-Nynorsk_Norway&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pl&#39;</span><span class="p">:</span> <span class="s1">&#39;Polish_Poland&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pt_PT&#39;</span><span class="p">:</span> <span class="s1">&#39;Portuguese_Portugal&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pt_BR&#39;</span><span class="p">:</span> <span class="s1">&#39;Portuguese_Brazil&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ro_RO&#39;</span><span class="p">:</span> <span class="s1">&#39;Romanian_Romania&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ru_RU&#39;</span><span class="p">:</span> <span class="s1">&#39;Russian_Russia&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sr_CS&#39;</span><span class="p">:</span> <span class="s1">&#39;Serbian (Cyrillic)_Serbia and Montenegro&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sk_SK&#39;</span><span class="p">:</span> <span class="s1">&#39;Slovak_Slovakia&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sl_SI&#39;</span><span class="p">:</span> <span class="s1">&#39;Slovenian_Slovenia&#39;</span><span class="p">,</span>
    <span class="c1">#should find more specific locales for Spanish countries,</span>
    <span class="c1">#but better than nothing</span>
    <span class="s1">&#39;es_AR&#39;</span><span class="p">:</span> <span class="s1">&#39;Spanish_Spain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;es_BO&#39;</span><span class="p">:</span> <span class="s1">&#39;Spanish_Spain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;es_CL&#39;</span><span class="p">:</span> <span class="s1">&#39;Spanish_Spain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;es_CO&#39;</span><span class="p">:</span> <span class="s1">&#39;Spanish_Spain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;es_CR&#39;</span><span class="p">:</span> <span class="s1">&#39;Spanish_Spain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;es_DO&#39;</span><span class="p">:</span> <span class="s1">&#39;Spanish_Spain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;es_EC&#39;</span><span class="p">:</span> <span class="s1">&#39;Spanish_Spain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;es_ES&#39;</span><span class="p">:</span> <span class="s1">&#39;Spanish_Spain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;es_GT&#39;</span><span class="p">:</span> <span class="s1">&#39;Spanish_Spain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;es_HN&#39;</span><span class="p">:</span> <span class="s1">&#39;Spanish_Spain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;es_MX&#39;</span><span class="p">:</span> <span class="s1">&#39;Spanish_Spain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;es_NI&#39;</span><span class="p">:</span> <span class="s1">&#39;Spanish_Spain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;es_PA&#39;</span><span class="p">:</span> <span class="s1">&#39;Spanish_Spain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;es_PE&#39;</span><span class="p">:</span> <span class="s1">&#39;Spanish_Spain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;es_PR&#39;</span><span class="p">:</span> <span class="s1">&#39;Spanish_Spain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;es_PY&#39;</span><span class="p">:</span> <span class="s1">&#39;Spanish_Spain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;es_SV&#39;</span><span class="p">:</span> <span class="s1">&#39;Spanish_Spain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;es_UY&#39;</span><span class="p">:</span> <span class="s1">&#39;Spanish_Spain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;es_VE&#39;</span><span class="p">:</span> <span class="s1">&#39;Spanish_Spain&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sv_SE&#39;</span><span class="p">:</span> <span class="s1">&#39;Swedish_Sweden&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ta_IN&#39;</span><span class="p">:</span> <span class="s1">&#39;English_Australia&#39;</span><span class="p">,</span>
    <span class="s1">&#39;th_TH&#39;</span><span class="p">:</span> <span class="s1">&#39;Thai_Thailand&#39;</span><span class="p">,</span>
    <span class="s1">&#39;tr_TR&#39;</span><span class="p">:</span> <span class="s1">&#39;Turkish_Turkey&#39;</span><span class="p">,</span>
    <span class="s1">&#39;uk_UA&#39;</span><span class="p">:</span> <span class="s1">&#39;Ukrainian_Ukraine&#39;</span><span class="p">,</span>
    <span class="s1">&#39;vi_VN&#39;</span><span class="p">:</span> <span class="s1">&#39;Vietnamese_Viet Nam&#39;</span><span class="p">,</span>
    <span class="s1">&#39;tlh_TLH&#39;</span><span class="p">:</span> <span class="s1">&#39;Klingon&#39;</span><span class="p">,</span>

<span class="p">}</span>

<span class="c1"># these direct uses of CSV are ok.</span>
<span class="kn">import</span> <span class="nn">csv</span> <span class="c1"># pylint: disable=deprecated-module</span>
<div class="viewcode-block" id="UNIX_LINE_TERMINATOR">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.UNIX_LINE_TERMINATOR">[docs]</a>
<span class="k">class</span> <span class="nc">UNIX_LINE_TERMINATOR</span><span class="p">(</span><span class="n">csv</span><span class="o">.</span><span class="n">excel</span><span class="p">):</span>
    <span class="n">lineterminator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span></div>


<span class="n">csv</span><span class="o">.</span><span class="n">register_dialect</span><span class="p">(</span><span class="s2">&quot;UNIX&quot;</span><span class="p">,</span> <span class="n">UNIX_LINE_TERMINATOR</span><span class="p">)</span>


<span class="c1"># FIXME: holy shit this whole thing needs to be cleaned up hard it&#39;s a mess</span>
<div class="viewcode-block" id="encode">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.encode">[docs]</a>
<span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span></div>



<span class="c1"># which elements are translated inline</span>
<span class="n">TRANSLATED_ELEMENTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;abbr&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;bdi&#39;</span><span class="p">,</span> <span class="s1">&#39;bdo&#39;</span><span class="p">,</span> <span class="s1">&#39;br&#39;</span><span class="p">,</span> <span class="s1">&#39;cite&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;del&#39;</span><span class="p">,</span> <span class="s1">&#39;dfn&#39;</span><span class="p">,</span> <span class="s1">&#39;em&#39;</span><span class="p">,</span>
    <span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;ins&#39;</span><span class="p">,</span> <span class="s1">&#39;kbd&#39;</span><span class="p">,</span> <span class="s1">&#39;keygen&#39;</span><span class="p">,</span> <span class="s1">&#39;mark&#39;</span><span class="p">,</span> <span class="s1">&#39;math&#39;</span><span class="p">,</span> <span class="s1">&#39;meter&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span>
    <span class="s1">&#39;progress&#39;</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;samp&#39;</span><span class="p">,</span> <span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="s1">&#39;span&#39;</span><span class="p">,</span> <span class="s1">&#39;strong&#39;</span><span class="p">,</span> <span class="s1">&#39;sub&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sup&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="s1">&#39;wbr&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="s1">&#39;option&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Which attributes must be translated. This is a dict, where the value indicates</span>
<span class="c1"># a condition for a node to have the attribute translatable.</span>
<span class="n">TRANSLATED_ATTRS</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">({</span>
    <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;add-label&#39;</span><span class="p">,</span> <span class="s1">&#39;help&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;avg&#39;</span><span class="p">,</span> <span class="s1">&#39;confirm&#39;</span><span class="p">,</span> <span class="s1">&#39;placeholder&#39;</span><span class="p">,</span> <span class="s1">&#39;alt&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;aria-label&#39;</span><span class="p">,</span>
    <span class="s1">&#39;aria-keyshortcuts&#39;</span><span class="p">,</span> <span class="s1">&#39;aria-placeholder&#39;</span><span class="p">,</span> <span class="s1">&#39;aria-roledescription&#39;</span><span class="p">,</span> <span class="s1">&#39;aria-valuetext&#39;</span><span class="p">,</span>
    <span class="s1">&#39;value_label&#39;</span><span class="p">,</span> <span class="s1">&#39;data-tooltip&#39;</span><span class="p">,</span> <span class="s1">&#39;data-editor-message&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">,</span>
<span class="p">},</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="translate_attrib_value">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.translate_attrib_value">[docs]</a>
<span class="k">def</span> <span class="nf">translate_attrib_value</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="c1"># check if the value attribute of a node must be translated</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;input&#39;</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="s1">&#39;datetimepicker-input&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">classes</span>
        <span class="ow">or</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;input&#39;</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;hidden&#39;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="s1">&#39;o_translatable_input_hidden&#39;</span> <span class="ow">in</span> <span class="n">classes</span>
    <span class="p">)</span></div>


<span class="n">TRANSLATED_ATTRS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="n">value</span><span class="o">=</span><span class="n">translate_attrib_value</span><span class="p">,</span>
    <span class="n">text</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;field&#39;</span> <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;widget&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;url&#39;</span><span class="p">),</span>
    <span class="o">**</span><span class="p">{</span><span class="sa">f</span><span class="s1">&#39;t-attf-</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">cond</span> <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">TRANSLATED_ATTRS</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
<span class="p">)</span>

<span class="n">avoid_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s*&lt;!DOCTYPE&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>


<div class="viewcode-block" id="translate_xml_node">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.translate_xml_node">[docs]</a>
<span class="k">def</span> <span class="nf">translate_xml_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">parse</span><span class="p">,</span> <span class="n">serialize</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return the translation of the given XML/HTML node.</span>

<span class="sd">        :param node:</span>
<span class="sd">        :param callback: callback(text) returns translated text or None</span>
<span class="sd">        :param parse: parse(text) returns a node (text is unicode)</span>
<span class="sd">        :param serialize: serialize(node) returns unicode text</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">nonspace</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return whether ``text`` is a string with non-space characters. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">text</span><span class="o">.</span><span class="n">isspace</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">translatable</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return whether the given node can be translated as a whole. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="n">TRANSLATED_ELEMENTS</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;t-&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">translatable</span><span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">hastext</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return whether the given node contains some text to translate at the</span>
<span class="sd">            given child node position.  The text may be before the child node,</span>
<span class="sd">            inside it, or after it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="c1"># there is some text before node[pos]</span>
            <span class="n">nonspace</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="n">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span> <span class="k">if</span> <span class="n">pos</span> <span class="k">else</span> <span class="n">node</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span>
                <span class="n">pos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">translatable</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
                <span class="ow">and</span> <span class="p">(</span>
                    <span class="nb">any</span><span class="p">(</span>  <span class="c1"># attribute to translate</span>
                        <span class="n">val</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">TRANSLATED_ATTRS</span> <span class="ow">and</span> <span class="n">TRANSLATED_ATTRS</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">node</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">node</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">)</span>
                    <span class="c1"># node[pos] contains some text to translate</span>
                    <span class="ow">or</span> <span class="n">hastext</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
                    <span class="c1"># node[pos] has no text, but there is some text after it</span>
                    <span class="ow">or</span> <span class="n">hastext</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Translate the given node. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">SKIPPED_ELEMENT_TYPES</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="n">SKIPPED_ELEMENTS</span>
            <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t-translation&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;off&quot;</span>
            <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;attribute&#39;</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TRANSLATED_ATTRS</span>
            <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">getparent</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">avoid_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">return</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># check for some text to translate at the given position</span>
            <span class="k">if</span> <span class="n">hastext</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
                <span class="c1"># move all translatable children nodes from the given position</span>
                <span class="c1"># into a &lt;div&gt; element</span>
                <span class="n">div</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">)</span>
                <span class="n">div</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="n">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span> <span class="k">if</span> <span class="n">pos</span> <span class="k">else</span> <span class="n">node</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
                <span class="k">while</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="ow">and</span> <span class="n">translatable</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="n">pos</span><span class="p">]):</span>
                    <span class="n">div</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>

                <span class="c1"># translate the content of the &lt;div&gt; element as a whole</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">serialize</span><span class="p">(</span><span class="n">div</span><span class="p">)[</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>
                <span class="n">original</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">translated</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">translated</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">translated</span><span class="p">)</span>
                    <span class="c1"># &lt;div/&gt; is used to auto fix crapy result</span>
                    <span class="n">result_elem</span> <span class="o">=</span> <span class="n">parse_html</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;div&gt;</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&lt;/div&gt;&quot;</span><span class="p">)</span>
                    <span class="c1"># change the tag to &lt;span/&gt; which is one of TRANSLATED_ELEMENTS</span>
                    <span class="c1"># so that &#39;result_elem&#39; can be checked by translatable and hastext</span>
                    <span class="n">result_elem</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;span&#39;</span>
                    <span class="k">if</span> <span class="n">translatable</span><span class="p">(</span><span class="n">result_elem</span><span class="p">)</span> <span class="ow">and</span> <span class="n">hastext</span><span class="p">(</span><span class="n">result_elem</span><span class="p">):</span>
                        <span class="n">div</span> <span class="o">=</span> <span class="n">result_elem</span>
                        <span class="k">if</span> <span class="n">pos</span><span class="p">:</span>
                            <span class="n">node</span><span class="p">[</span><span class="n">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">div</span><span class="o">.</span><span class="n">text</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">div</span><span class="o">.</span><span class="n">text</span>

                <span class="c1"># move the content of the &lt;div&gt; element back inside node</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">div</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">div</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                <span class="k">break</span>

            <span class="c1"># node[pos] is not translatable as a whole, process it recursively</span>
            <span class="n">process</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
            <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># translate the attributes of the node</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">nonspace</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">TRANSLATED_ATTRS</span> <span class="ow">and</span> <span class="n">TRANSLATED_ATTRS</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">node</span><span class="p">):</span>
                <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">callback</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="ow">or</span> <span class="n">val</span><span class="p">)</span>

    <span class="n">process</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">node</span></div>



<div class="viewcode-block" id="parse_xml">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.parse_xml">[docs]</a>
<span class="k">def</span> <span class="nf">parse_xml</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></div>


<div class="viewcode-block" id="serialize_xml">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.serialize_xml">[docs]</a>
<span class="k">def</span> <span class="nf">serialize_xml</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;xml&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;unicode&#39;</span><span class="p">)</span></div>



<span class="n">MODIFIER_ATTRS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;invisible&quot;</span><span class="p">,</span> <span class="s2">&quot;readonly&quot;</span><span class="p">,</span> <span class="s2">&quot;required&quot;</span><span class="p">,</span> <span class="s2">&quot;column_invisible&quot;</span><span class="p">,</span> <span class="s2">&quot;attrs&quot;</span><span class="p">,</span> <span class="s2">&quot;states&quot;</span><span class="p">}</span>
<div class="viewcode-block" id="xml_term_adapter">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.xml_term_adapter">[docs]</a>
<span class="k">def</span> <span class="nf">xml_term_adapter</span><span class="p">(</span><span class="n">term_en</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns an `adapter(term)` function that will ensure the modifiers are copied</span>
<span class="sd">    from the base `term_en` to the translated `term` when the XML structure of</span>
<span class="sd">    both terms match. `term_en` and any input `term` to the adapter must be valid</span>
<span class="sd">    XML terms. Using the adapter only makes sense if `term_en` contains some tags</span>
<span class="sd">    from TRANSLATED_ELEMENTS.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">orig_node</span> <span class="o">=</span> <span class="n">parse_xml</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;div&gt;</span><span class="si">{</span><span class="n">term_en</span><span class="si">}</span><span class="s2">&lt;/div&gt;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">same_struct_iter</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">left</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="n">right</span><span class="o">.</span><span class="n">tag</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Non matching struct&quot;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span>
        <span class="n">left_iter</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">iterchildren</span><span class="p">()</span>
        <span class="n">right_iter</span> <span class="o">=</span> <span class="n">right</span><span class="o">.</span><span class="n">iterchildren</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">lc</span><span class="p">,</span> <span class="n">rc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">left_iter</span><span class="p">,</span> <span class="n">right_iter</span><span class="p">):</span>
            <span class="k">yield from</span> <span class="n">same_struct_iter</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">rc</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">next</span><span class="p">(</span><span class="n">left_iter</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">next</span><span class="p">(</span><span class="n">right_iter</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Non matching struct&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">adapter</span><span class="p">(</span><span class="n">term</span><span class="p">):</span>
        <span class="n">new_node</span> <span class="o">=</span> <span class="n">parse_xml</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;div&gt;</span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s2">&lt;/div&gt;&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">orig_n</span><span class="p">,</span> <span class="n">new_n</span> <span class="ow">in</span> <span class="n">same_struct_iter</span><span class="p">(</span><span class="n">orig_node</span><span class="p">,</span> <span class="n">new_node</span><span class="p">):</span>
                <span class="n">removed_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">new_n</span><span class="o">.</span><span class="n">attrib</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">MODIFIER_ATTRS</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">orig_n</span><span class="o">.</span><span class="n">attrib</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">removed_attrs</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">new_n</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">keep_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">orig_n</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">MODIFIER_ATTRS</span><span class="p">}</span>
                <span class="n">new_n</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">keep_attrs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># non-matching structure</span>
            <span class="k">return</span> <span class="n">term</span>

        <span class="c1"># remove tags &lt;div&gt; and &lt;/div&gt; from result</span>
        <span class="k">return</span> <span class="n">serialize_xml</span><span class="p">(</span><span class="n">new_node</span><span class="p">)[</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">adapter</span></div>



<span class="n">_HTML_PARSER</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">HTMLParser</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="parse_html">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.parse_html">[docs]</a>
<span class="k">def</span> <span class="nf">parse_html</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">parse</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">fragment_fromstring</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="n">_HTML_PARSER</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Error while parsing view:</span><span class="se">\n\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="k">return</span> <span class="n">parse</span></div>


<div class="viewcode-block" id="serialize_html">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.serialize_html">[docs]</a>
<span class="k">def</span> <span class="nf">serialize_html</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;unicode&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="xml_translate">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.xml_translate">[docs]</a>
<span class="k">def</span> <span class="nf">xml_translate</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Translate an XML value (string), using `callback` for translating text</span>
<span class="sd">        appearing in `value`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">parse_xml</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">translate_xml_node</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">parse_xml</span><span class="p">,</span> <span class="n">serialize_xml</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">serialize_xml</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">etree</span><span class="o">.</span><span class="n">ParseError</span><span class="p">:</span>
        <span class="c1"># fallback for translated terms: use an HTML parser and wrap the term</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">parse_html</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;&lt;div&gt;</span><span class="si">%s</span><span class="s2">&lt;/div&gt;&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">translate_xml_node</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">parse_xml</span><span class="p">,</span> <span class="n">serialize_xml</span><span class="p">)</span>
        <span class="c1"># remove tags &lt;div&gt; and &lt;/div&gt; from result</span>
        <span class="k">return</span> <span class="n">serialize_xml</span><span class="p">(</span><span class="n">result</span><span class="p">)[</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span></div>


<div class="viewcode-block" id="xml_term_converter">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.xml_term_converter">[docs]</a>
<span class="k">def</span> <span class="nf">xml_term_converter</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Convert the HTML fragment ``value`` to XML if necessary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># wrap value inside a div and parse it as HTML</span>
    <span class="n">div</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;div&gt;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&lt;/div&gt;&quot;</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">div</span><span class="p">,</span> <span class="n">etree</span><span class="o">.</span><span class="n">HTMLParser</span><span class="p">())</span>
    <span class="c1"># root is html &gt; body &gt; div</span>
    <span class="c1"># serialize div as XML and discard surrounding tags</span>
    <span class="k">return</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">root</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;unicode&#39;</span><span class="p">)[</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span></div>


<div class="viewcode-block" id="html_translate">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.html_translate">[docs]</a>
<span class="k">def</span> <span class="nf">html_translate</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Translate an HTML value (string), using `callback` for translating text</span>
<span class="sd">        appearing in `value`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># value may be some HTML fragment, wrap it into a div</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">parse_html</span><span class="p">(</span><span class="s2">&quot;&lt;div&gt;</span><span class="si">%s</span><span class="s2">&lt;/div&gt;&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">translate_xml_node</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">parse_html</span><span class="p">,</span> <span class="n">serialize_html</span><span class="p">)</span>
        <span class="c1"># remove tags &lt;div&gt; and &lt;/div&gt; from result</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">serialize_html</span><span class="p">(</span><span class="n">result</span><span class="p">)[</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Cannot translate malformed HTML, using source value instead&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="html_term_converter">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.html_term_converter">[docs]</a>
<span class="k">def</span> <span class="nf">html_term_converter</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Convert the HTML fragment ``value`` to XML if necessary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># wrap value inside a div and parse it as HTML</span>
    <span class="n">div</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;div&gt;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&lt;/div&gt;&quot;</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">div</span><span class="p">,</span> <span class="n">etree</span><span class="o">.</span><span class="n">HTMLParser</span><span class="p">())</span>
    <span class="c1"># root is html &gt; body &gt; div</span>
    <span class="c1"># serialize div as HTML and discard surrounding tags</span>
    <span class="k">return</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">root</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;unicode&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">)[</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span></div>



<div class="viewcode-block" id="get_text_content">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.get_text_content">[docs]</a>
<span class="k">def</span> <span class="nf">get_text_content</span><span class="p">(</span><span class="n">term</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return the textual content of the given term. &quot;&quot;&quot;</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">term</span><span class="p">)</span><span class="o">.</span><span class="n">text_content</span><span class="p">()</span>
    <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">())</span></div>


<div class="viewcode-block" id="is_text">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.is_text">[docs]</a>
<span class="k">def</span> <span class="nf">is_text</span><span class="p">(</span><span class="n">term</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return whether the term has only text. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;_&gt;</span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s2">&lt;/_&gt;&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span></div>


<span class="n">xml_translate</span><span class="o">.</span><span class="n">get_text_content</span> <span class="o">=</span> <span class="n">get_text_content</span>
<span class="n">html_translate</span><span class="o">.</span><span class="n">get_text_content</span> <span class="o">=</span> <span class="n">get_text_content</span>

<span class="n">xml_translate</span><span class="o">.</span><span class="n">term_converter</span> <span class="o">=</span> <span class="n">xml_term_converter</span>
<span class="n">html_translate</span><span class="o">.</span><span class="n">term_converter</span> <span class="o">=</span> <span class="n">html_term_converter</span>

<span class="n">xml_translate</span><span class="o">.</span><span class="n">is_text</span> <span class="o">=</span> <span class="n">is_text</span>
<span class="n">html_translate</span><span class="o">.</span><span class="n">is_text</span> <span class="o">=</span> <span class="n">is_text</span>

<span class="n">xml_translate</span><span class="o">.</span><span class="n">term_adapter</span> <span class="o">=</span> <span class="n">xml_term_adapter</span>

<div class="viewcode-block" id="translate_sql_constraint">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.translate_sql_constraint">[docs]</a>
<span class="k">def</span> <span class="nf">translate_sql_constraint</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">lang</span><span class="p">):</span>
    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT COALESCE(c.message-&gt;&gt;</span><span class="si">%s</span><span class="s2">, c.message-&gt;&gt;&#39;en_US&#39;) as message</span>
<span class="s2">        FROM ir_model_constraint c</span>
<span class="s2">        WHERE name=</span><span class="si">%s</span><span class="s2"> and type=&#39;u&#39;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="GettextAlias">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.GettextAlias">[docs]</a>
<span class="k">class</span> <span class="nc">GettextAlias</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_get_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># find current DB based on thread/worker db name (see netsvc)</span>
        <span class="n">db_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">(),</span> <span class="s1">&#39;dbname&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">db_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">odoo</span><span class="o">.</span><span class="n">sql_db</span><span class="o">.</span><span class="n">db_connect</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_cr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">allow_create</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># try, in order: cr, cursor, self.env.cr, self.cr,</span>
        <span class="c1"># request.env.cr</span>
        <span class="k">if</span> <span class="s1">&#39;cr&#39;</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s1">&#39;cr&#39;</span><span class="p">],</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;cursor&#39;</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s1">&#39;cursor&#39;</span><span class="p">],</span> <span class="kc">False</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;env&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;cr&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">cr</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">odoo.http</span> <span class="kn">import</span> <span class="n">request</span>
            <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="n">allow_create</span><span class="p">:</span>
            <span class="c1"># create a new cursor</span>
            <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_db</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">(),</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_get_uid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="c1"># try, in order: uid, user, self.env.uid</span>
        <span class="k">if</span> <span class="s1">&#39;uid&#39;</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;user&#39;</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">])</span>      <span class="c1"># user may be a record</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span>

    <span class="k">def</span> <span class="nf">_get_lang</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="c1"># try, in order: context.get(&#39;lang&#39;), kwargs[&#39;context&#39;].get(&#39;lang&#39;),</span>
        <span class="c1"># self.env.lang, self.localcontext.get(&#39;lang&#39;), request.env.lang</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">):</span>
            <span class="n">lang</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lang</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kwargs&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">):</span>
                <span class="n">lang</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;context&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lang</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;env&#39;</span><span class="p">):</span>
                <span class="n">lang</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lang</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;localcontext&#39;</span><span class="p">):</span>
                    <span class="n">lang</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">localcontext</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lang</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">odoo.http</span> <span class="kn">import</span> <span class="n">request</span>
                    <span class="n">lang</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lang</span><span class="p">:</span>
                <span class="c1"># Last resort: attempt to guess the language of the user</span>
                <span class="c1"># Pitfall: some operations are performed in sudo mode, and we</span>
                <span class="c1">#          don&#39;t know the original uid, so the language may</span>
                <span class="c1">#          be wrong when the admin language differs.</span>
                <span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">dummy</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cr</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">allow_create</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_uid</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cr</span> <span class="ow">and</span> <span class="n">uid</span><span class="p">:</span>
                    <span class="n">env</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="n">lang</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">context_get</span><span class="p">()[</span><span class="s1">&#39;lang&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lang</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">translation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_translation</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">args</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Markup</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">())):</span>
                <span class="n">translation</span> <span class="o">=</span> <span class="n">escape</span><span class="p">(</span><span class="n">translation</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">translation</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                <span class="n">bad</span> <span class="o">=</span> <span class="n">translation</span>
                <span class="c1"># fallback: apply to source before logging exception (in case source fails)</span>
                <span class="n">translation</span> <span class="o">=</span> <span class="n">source</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">)</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Bad translation </span><span class="si">%r</span><span class="s1"> for string </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">bad</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">translation</span>

    <span class="k">def</span> <span class="nf">_get_translation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span><span class="o">.</span><span class="n">f_back</span>
            <span class="n">lang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_lang</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lang</span> <span class="ow">and</span> <span class="n">lang</span> <span class="o">!=</span> <span class="s1">&#39;en_US&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">module</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
                    <span class="n">path_info</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get_resource_from_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="n">module</span> <span class="o">=</span> <span class="n">path_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">path_info</span> <span class="k">else</span> <span class="s1">&#39;base&#39;</span>
                <span class="k">return</span> <span class="n">code_translations</span><span class="o">.</span><span class="n">get_python_translations</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;no translation language detected, skipping translation for &quot;</span><span class="si">%r</span><span class="s1">&quot; &#39;</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;translation went wrong for &quot;</span><span class="si">%r</span><span class="s1">&quot;, skipped&#39;</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
                <span class="c1"># if so, double-check the root/base translations filenames</span>
        <span class="k">return</span> <span class="n">source</span></div>



<span class="nd">@functools</span><span class="o">.</span><span class="n">total_ordering</span>
<span class="k">class</span> <span class="nc">_lt</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Lazy code translation</span>

<span class="sd">    Similar to GettextAlias but the translation lookup will be done only at</span>
<span class="sd">    __str__ execution.</span>

<span class="sd">    A code using translated global variables such as:</span>

<span class="sd">    LABEL = _lt(&quot;User&quot;)</span>

<span class="sd">    def _compute_label(self):</span>
<span class="sd">        context = {&#39;lang&#39;: self.partner_id.lang}</span>
<span class="sd">        self.user_label = LABEL</span>

<span class="sd">    works as expected (unlike the classic GettextAlias implementation).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_source&#39;</span><span class="p">,</span> <span class="s1">&#39;_args&#39;</span><span class="p">,</span> <span class="s1">&#39;_module&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">args</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span>

        <span class="n">frame</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfile</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="n">path_info</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get_resource_from_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_module</span> <span class="o">=</span> <span class="n">path_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">path_info</span> <span class="k">else</span> <span class="s1">&#39;base&#39;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Call _._get_translation() like _() does, so that we have the same number</span>
        <span class="c1"># of stack frames calling _get_translation()</span>
        <span class="n">translation</span> <span class="o">=</span> <span class="n">_</span><span class="o">.</span><span class="n">_get_translation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">translation</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                <span class="n">bad</span> <span class="o">=</span> <span class="n">translation</span>
                <span class="c1"># fallback: apply to source before logging exception (in case source fails)</span>
                <span class="n">translation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Bad translation </span><span class="si">%r</span><span class="s1"> for string </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">bad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">translation</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Prevent using equal operators</span>

<span class="sd">        Prevent direct comparisons with ``self``.</span>
<span class="sd">        One should compare the translation of ``self._source`` as ``str(self) == X``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="c1"># Call _._get_translation() like _() does, so that we have the same number</span>
        <span class="c1"># of stack frames calling _get_translation()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_</span><span class="o">.</span><span class="n">_get_translation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="p">)</span> <span class="o">+</span> <span class="n">other</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">_lt</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_</span><span class="o">.</span><span class="n">_get_translation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="p">)</span> <span class="o">+</span> <span class="n">_</span><span class="o">.</span><span class="n">_get_translation</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_source</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="c1"># Call _._get_translation() like _() does, so that we have the same number</span>
        <span class="c1"># of stack frames calling _get_translation()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">other</span> <span class="o">+</span> <span class="n">_</span><span class="o">.</span><span class="n">_get_translation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>

<span class="n">_</span> <span class="o">=</span> <span class="n">GettextAlias</span><span class="p">()</span>


<div class="viewcode-block" id="quote">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.quote">[docs]</a>
<span class="k">def</span> <span class="nf">quote</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns quoted PO term string, with special PO characters escaped&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="sa">r</span><span class="s2">&quot;\n&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">,</span> <span class="s2">&quot;Translation terms may not include escaped newlines (&#39;</span><span class="se">\\</span><span class="s2">n&#39;), please use only literal newlines! (in &#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="n">s</span>
    <span class="k">return</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">)</span> \
                     <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span> \
                     <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">n&quot;</span><span class="se">\n</span><span class="s1">&quot;&#39;</span><span class="p">)</span></div>


<span class="n">re_escaped_char</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">.)&quot;</span><span class="p">)</span>
<span class="n">re_escaped_replacements</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,}</span>

<span class="k">def</span> <span class="nf">_sub_replacement</span><span class="p">(</span><span class="n">match_obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">re_escaped_replacements</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">match_obj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">match_obj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

<div class="viewcode-block" id="unquote">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.unquote">[docs]</a>
<span class="k">def</span> <span class="nf">unquote</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns unquoted PO term string, with special PO characters unescaped&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">re_escaped_char</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">_sub_replacement</span><span class="p">,</span> <span class="nb">str</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="TranslationFileReader">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.TranslationFileReader">[docs]</a>
<span class="k">def</span> <span class="nf">TranslationFileReader</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">fileformat</span><span class="o">=</span><span class="s1">&#39;po&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Iterate over translation file to return Odoo translation entries &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">fileformat</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CSVFileReader</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fileformat</span> <span class="o">==</span> <span class="s1">&#39;po&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PoFileReader</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Bad file format: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fileformat</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Bad file format: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fileformat</span><span class="p">))</span></div>


<div class="viewcode-block" id="CSVFileReader">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.CSVFileReader">[docs]</a>
<span class="k">class</span> <span class="nc">CSVFileReader</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="n">_reader</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">getreader</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">_reader</span><span class="p">(</span><span class="n">source</span><span class="p">),</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_code_src</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>

            <span class="c1"># determine &lt;module&gt;.&lt;imd_name&gt; from res_id</span>
            <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;res_id&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;res_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">():</span>
                <span class="c1"># res_id is an id or line number</span>
                <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;res_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;res_id&quot;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;imd_name&quot;</span><span class="p">):</span>
                <span class="c1"># res_id is an external id and must follow &lt;module&gt;.&lt;name&gt;</span>
                <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">],</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;imd_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;res_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;res_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;model&quot;</span> <span class="ow">or</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;model_terms&quot;</span><span class="p">:</span>
                <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;imd_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;code&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;src&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_code_src</span><span class="p">:</span>
                    <span class="c1"># skip entry due to unicity constrain on code translations</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prev_code_src</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;src&quot;</span><span class="p">]</span>

            <span class="k">yield</span> <span class="n">entry</span></div>


<div class="viewcode-block" id="PoFileReader">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.PoFileReader">[docs]</a>
<span class="k">class</span> <span class="nc">PoFileReader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Iterate over po file to return Odoo translation entries &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">get_pot_path</span><span class="p">(</span><span class="n">source_name</span><span class="p">):</span>
            <span class="c1"># when fileobj is a TemporaryFile, its name is an inter in P3, a string in P2</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">source_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.po&#39;</span><span class="p">):</span>
                <span class="c1"># Normally the path looks like /path/to/xxx/i18n/lang.po</span>
                <span class="c1"># and we try to find the corresponding</span>
                <span class="c1"># /path/to/xxx/i18n/xxx.pot file.</span>
                <span class="c1"># (Sometimes we have &#39;i18n_extra&#39; instead of just &#39;i18n&#39;)</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">source_name</span><span class="p">)</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.pot&#39;</span>
                <span class="n">pot_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">with_name</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">pot_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">pot_path</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># polib accepts a path or the file content as a string, not a fileobj</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pofile</span> <span class="o">=</span> <span class="n">polib</span><span class="o">.</span><span class="n">pofile</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
            <span class="n">pot_path</span> <span class="o">=</span> <span class="n">get_pot_path</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># either a BufferedIOBase or result from NamedTemporaryFile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pofile</span> <span class="o">=</span> <span class="n">polib</span><span class="o">.</span><span class="n">pofile</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
            <span class="n">pot_path</span> <span class="o">=</span> <span class="n">get_pot_path</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pot_path</span><span class="p">:</span>
            <span class="c1"># Make a reader for the POT file</span>
            <span class="c1"># (Because the POT comments are correct on GitHub but the</span>
            <span class="c1"># PO comments tends to be outdated. See LP bug 933496.)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pofile</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">polib</span><span class="o">.</span><span class="n">pofile</span><span class="p">(</span><span class="n">pot_path</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pofile</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">obsolete</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># in case of moduleS keep only the first</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(module[s]?): (\w+)&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">comment</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">module</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="n">comments</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">comment</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;module:&#39;</span><span class="p">)])</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">msgid</span>
            <span class="n">translation</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">msgstr</span>
            <span class="n">found_code_occurrence</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">occurrence</span><span class="p">,</span> <span class="n">line_number</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">occurrences</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(model|model_terms):([\w.]+),([\w]+):(\w+)\.([^ ]+)&#39;</span><span class="p">,</span> <span class="n">occurrence</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="nb">type</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">xmlid</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                    <span class="k">yield</span> <span class="p">{</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
                        <span class="s1">&#39;imd_model&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
                        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="n">field_name</span><span class="p">,</span>
                        <span class="s1">&#39;imd_name&#39;</span><span class="p">:</span> <span class="n">xmlid</span><span class="p">,</span>
                        <span class="s1">&#39;res_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span>
                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">translation</span><span class="p">,</span>
                        <span class="s1">&#39;comments&#39;</span><span class="p">:</span> <span class="n">comments</span><span class="p">,</span>
                        <span class="s1">&#39;module&#39;</span><span class="p">:</span> <span class="n">module</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="k">continue</span>

                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(code):([\w/.]+)&#39;</span><span class="p">,</span> <span class="n">occurrence</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="nb">type</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">found_code_occurrence</span><span class="p">:</span>
                        <span class="c1"># unicity constrain on code translation</span>
                        <span class="k">continue</span>
                    <span class="n">found_code_occurrence</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">yield</span> <span class="p">{</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
                        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                        <span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span>
                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">translation</span><span class="p">,</span>
                        <span class="s1">&#39;comments&#39;</span><span class="p">:</span> <span class="n">comments</span><span class="p">,</span>
                        <span class="s1">&#39;res_id&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">line_number</span><span class="p">),</span>
                        <span class="s1">&#39;module&#39;</span><span class="p">:</span> <span class="n">module</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="k">continue</span>

                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(selection):([\w.]+),([\w]+)&#39;</span><span class="p">,</span> <span class="n">occurrence</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipped deprecated occurrence </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">occurrence</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(sql_constraint|constraint):([\w.]+)&#39;</span><span class="p">,</span> <span class="n">occurrence</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipped deprecated occurrence </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">occurrence</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;malformed po file: unknown occurrence: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">occurrence</span><span class="p">)</span></div>


<div class="viewcode-block" id="TranslationFileWriter">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.TranslationFileWriter">[docs]</a>
<span class="k">def</span> <span class="nf">TranslationFileWriter</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">fileformat</span><span class="o">=</span><span class="s1">&#39;po&#39;</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Iterate over translation file to return Odoo translation entries &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">fileformat</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CSVFileWriter</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fileformat</span> <span class="o">==</span> <span class="s1">&#39;po&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PoFileWriter</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="n">lang</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fileformat</span> <span class="o">==</span> <span class="s1">&#39;tgz&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TarFileWriter</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="n">lang</span><span class="p">)</span>

    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Unrecognized extension: must be one of &#39;</span>
                      <span class="s1">&#39;.csv, .po, or .tgz (received .</span><span class="si">%s</span><span class="s1">).&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">fileformat</span><span class="p">)</span></div>



<div class="viewcode-block" id="CSVFileWriter">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.CSVFileWriter">[docs]</a>
<span class="k">class</span> <span class="nc">CSVFileWriter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">csv_writer</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="s1">&#39;UNIX&#39;</span><span class="p">)</span>
        <span class="c1"># write header first</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">((</span><span class="s2">&quot;module&quot;</span><span class="p">,</span><span class="s2">&quot;type&quot;</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="s2">&quot;res_id&quot;</span><span class="p">,</span><span class="s2">&quot;src&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="p">,</span><span class="s2">&quot;comments&quot;</span><span class="p">))</span>


<div class="viewcode-block" id="CSVFileWriter.write_rows">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.CSVFileWriter.write_rows">[docs]</a>
    <span class="k">def</span> <span class="nf">write_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">module</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">res_id</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">trad</span><span class="p">,</span> <span class="n">comments</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">comments</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">comments</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">((</span><span class="n">module</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">res_id</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">trad</span><span class="p">,</span> <span class="n">comments</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="PoFileWriter">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.PoFileWriter">[docs]</a>
<span class="k">class</span> <span class="nc">PoFileWriter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Iterate over po file to return Odoo translation entries &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lang</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lang</span> <span class="o">=</span> <span class="n">lang</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">po</span> <span class="o">=</span> <span class="n">polib</span><span class="o">.</span><span class="n">POFile</span><span class="p">()</span>

<div class="viewcode-block" id="PoFileWriter.write_rows">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.PoFileWriter.write_rows">[docs]</a>
    <span class="k">def</span> <span class="nf">write_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
        <span class="c1"># we now group the translations by source. That means one translation per source.</span>
        <span class="n">grouped_rows</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">modules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">module</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">res_id</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">trad</span><span class="p">,</span> <span class="n">comments</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">grouped_rows</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">row</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;modules&#39;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;translation&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">trad</span> <span class="o">!=</span> <span class="n">src</span><span class="p">:</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;translation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trad</span>
            <span class="n">row</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;tnrs&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">res_id</span><span class="p">))</span>
            <span class="n">row</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">comments</span><span class="p">)</span>
            <span class="n">modules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">grouped_rows</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang</span><span class="p">:</span>
                <span class="c1"># translation template, so no translation value</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;translation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;translation&#39;</span><span class="p">):</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;translation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_entry</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;modules&#39;</span><span class="p">]),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;tnrs&#39;</span><span class="p">]),</span> <span class="n">src</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;translation&#39;</span><span class="p">],</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">]))</span>

        <span class="kn">import</span> <span class="nn">odoo.release</span> <span class="k">as</span> <span class="nn">release</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">po</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;Translation of </span><span class="si">%s</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span> \
                    <span class="s2">&quot;This file contains the translation of the following modules:</span><span class="se">\n</span><span class="s2">&quot;</span> \
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">release</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">* </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">))</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M+0000&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">po</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Project-Id-Version&#39;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">release</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">release</span><span class="o">.</span><span class="n">version</span><span class="p">),</span>
            <span class="s1">&#39;Report-Msgid-Bugs-To&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;POT-Creation-Date&#39;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
            <span class="s1">&#39;PO-Revision-Date&#39;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
            <span class="s1">&#39;Last-Translator&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Language-Team&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;MIME-Version&#39;</span><span class="p">:</span> <span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;text/plain; charset=UTF-8&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Content-Transfer-Encoding&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Plural-Forms&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># buffer expects bytes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">po</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span></div>


<div class="viewcode-block" id="PoFileWriter.add_entry">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.PoFileWriter.add_entry">[docs]</a>
    <span class="k">def</span> <span class="nf">add_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modules</span><span class="p">,</span> <span class="n">tnrs</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">trad</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">polib</span><span class="o">.</span><span class="n">POEntry</span><span class="p">(</span>
            <span class="n">msgid</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
            <span class="n">msgstr</span><span class="o">=</span><span class="n">trad</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">plural</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;s&#39;</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="n">entry</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;module</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">plural</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modules</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">comments</span><span class="p">:</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">comment</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">comments</span><span class="p">)</span>

        <span class="n">code</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">typy</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">res_id</span> <span class="ow">in</span> <span class="n">tnrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">typy</span> <span class="o">==</span> <span class="s1">&#39;code&#39;</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">res_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res_id</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">res_id</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="c1"># second term of occurrence must be a digit</span>
                <span class="c1"># occurrence line at 0 are discarded when rendered to string</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">occurrences</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">u</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typy</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">res_id</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">occurrences</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">u</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">typy</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">res_id</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">code</span><span class="p">:</span>
            <span class="c1"># TODO 17.0: remove the flag python-format in all PO/POT files</span>
            <span class="c1"># The flag is used in a wrong way. It marks all code translations even for javascript translations.</span>
            <span class="n">entry</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;python-format&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">po</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TarFileWriter">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.TarFileWriter">[docs]</a>
<span class="k">class</span> <span class="nc">TarFileWriter</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lang</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w|gz&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lang</span> <span class="o">=</span> <span class="n">lang</span>

<div class="viewcode-block" id="TarFileWriter.write_rows">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.TarFileWriter.write_rows">[docs]</a>
    <span class="k">def</span> <span class="nf">write_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
        <span class="n">rows_by_module</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rows_by_module</span><span class="p">[</span><span class="n">module</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">mod</span><span class="p">,</span> <span class="n">modrows</span> <span class="ow">in</span> <span class="n">rows_by_module</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">buf</span><span class="p">:</span>
                <span class="n">po</span> <span class="o">=</span> <span class="n">PoFileWriter</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lang</span><span class="p">)</span>
                <span class="n">po</span><span class="o">.</span><span class="n">write_rows</span><span class="p">(</span><span class="n">modrows</span><span class="p">)</span>
                <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="n">info</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">TarInfo</span><span class="p">(</span>
                    <span class="n">join</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s1">&#39;i18n&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{basename}</span><span class="s1">.</span><span class="si">{ext}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">basename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lang</span> <span class="ow">or</span> <span class="n">mod</span><span class="p">,</span>
                        <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;po&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang</span> <span class="k">else</span> <span class="s1">&#39;pot&#39;</span><span class="p">,</span>
                    <span class="p">)))</span>
                <span class="c1"># addfile will read &lt;size&gt; bytes from the buffer so</span>
                <span class="c1"># size *must* be set first</span>
                <span class="n">info</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">addfile</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">=</span><span class="n">buf</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
</div>


<span class="c1"># Methods to export the translation file</span>
<div class="viewcode-block" id="trans_export">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.trans_export">[docs]</a>
<span class="k">def</span> <span class="nf">trans_export</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">modules</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">cr</span><span class="p">):</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">TranslationModuleReader</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">modules</span><span class="o">=</span><span class="n">modules</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="n">lang</span><span class="p">)</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">TranslationFileWriter</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">fileformat</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="n">lang</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">write_rows</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span></div>


<span class="c1"># pylint: disable=redefined-builtin</span>
<div class="viewcode-block" id="trans_export_records">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.trans_export_records">[docs]</a>
<span class="k">def</span> <span class="nf">trans_export_records</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">cr</span><span class="p">):</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">TranslationRecordReader</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="n">lang</span><span class="p">)</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">TranslationFileWriter</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">fileformat</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="n">lang</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">write_rows</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_push</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">source_line</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Sanity check before pushing translation terms &quot;&quot;&quot;</span>
    <span class="n">term</span> <span class="o">=</span> <span class="p">(</span><span class="n">term</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="c1"># Avoid non-char tokens like &#39;:&#39; &#39;...&#39; &#39;.00&#39; etc.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">term</span><span class="p">):</span>
        <span class="n">callback</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">source_line</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_extract_translatable_qweb_terms</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Helper method to walk an etree document representing</span>
<span class="sd">        a QWeb template, and call ``callback(term)`` for each</span>
<span class="sd">        translatable term that is found in the document.</span>

<span class="sd">        :param etree._Element element: root of etree document to extract terms from</span>
<span class="sd">        :param Callable callback: a callable in the form ``f(term, source_line)``,</span>
<span class="sd">                                  that will be called for each extracted term.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># not using elementTree.iterparse because we need to skip sub-trees in case</span>
    <span class="c1"># the ancestor element had a reason to be skipped</span>
    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">element</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">SKIPPED_ELEMENT_TYPES</span><span class="p">):</span> <span class="k">continue</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SKIPPED_ELEMENTS</span>
                <span class="ow">and</span> <span class="s2">&quot;t-js&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="s2">&quot;t-jquery&quot;</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span> <span class="ow">and</span> <span class="s2">&quot;t-operation&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">)</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;attribute&#39;</span> <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TRANSLATED_ATTRS</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;t-translation&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;off&quot;</span><span class="p">):</span>

            <span class="n">_push</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">sourceline</span><span class="p">)</span>
            <span class="c1"># Do not export terms contained on the Component directive of OWL</span>
            <span class="c1"># attributes in this context are most of the time variables,</span>
            <span class="c1"># not real HTML attributes.</span>
            <span class="c1"># Node tags starting with a capital letter are considered OWL Components</span>
            <span class="c1"># and a widespread convention and good practice for DOM tags is to write</span>
            <span class="c1"># them all lower case.</span>
            <span class="c1"># https://www.w3schools.com/html/html5_syntax.asp</span>
            <span class="c1"># https://github.com/odoo/owl/blob/master/doc/reference/component.md#composition</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">el</span><span class="o">.</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;t-component&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span> <span class="ow">and</span> <span class="s1">&#39;t-set-slot&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="n">TRANSLATED_ATTRS</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">att</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                        <span class="n">_push</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="n">att</span><span class="p">],</span> <span class="n">el</span><span class="o">.</span><span class="n">sourceline</span><span class="p">)</span>
            <span class="n">_extract_translatable_qweb_terms</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
        <span class="n">_push</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">tail</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">sourceline</span><span class="p">)</span>


<div class="viewcode-block" id="babel_extract_qweb">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.babel_extract_qweb">[docs]</a>
<span class="k">def</span> <span class="nf">babel_extract_qweb</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">comment_tags</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Babel message extractor for qweb template files.</span>

<span class="sd">    :param fileobj: the file-like object the messages should be extracted from</span>
<span class="sd">    :param keywords: a list of keywords (i.e. function names) that should</span>
<span class="sd">                     be recognized as translation functions</span>
<span class="sd">    :param comment_tags: a list of translator tags to search for and</span>
<span class="sd">                         include in the results</span>
<span class="sd">    :param options: a dictionary of additional options (optional)</span>
<span class="sd">    :return: an iterator over ``(lineno, funcname, message, comments)``</span>
<span class="sd">             tuples</span>
<span class="sd">    :rtype: Iterable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">handle_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">lineno</span><span class="p">):</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">lineno</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>
    <span class="n">_extract_translatable_qweb_terms</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">(),</span> <span class="n">handle_text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="extract_formula_terms">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.extract_formula_terms">[docs]</a>
<span class="k">def</span> <span class="nf">extract_formula_terms</span><span class="p">(</span><span class="n">formula</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract strings in a spreadsheet formula which are arguments to &#39;_t&#39; functions</span>

<span class="sd">        &gt;&gt;&gt; extract_formula_terms(&#39;=_t(&quot;Hello&quot;) + _t(&quot;Raoul&quot;)&#39;)</span>
<span class="sd">        [&quot;Hello&quot;, &quot;Raoul&quot;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">generate_tokens</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">formula</span><span class="p">)</span><span class="o">.</span><span class="n">readline</span><span class="p">)</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">(</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="n">NEWLINE</span><span class="p">,</span> <span class="n">INDENT</span><span class="p">,</span> <span class="n">DEDENT</span><span class="p">})</span>
    <span class="k">for</span> <span class="n">t1</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">t1</span><span class="o">.</span><span class="n">string</span> <span class="o">==</span> <span class="s1">&#39;_t&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t2</span> <span class="ow">and</span> <span class="n">t2</span><span class="o">.</span><span class="n">string</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span><span class="p">:</span>
            <span class="n">t3</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">t4</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t4</span> <span class="ow">and</span> <span class="n">t4</span><span class="o">.</span><span class="n">string</span> <span class="o">==</span> <span class="s1">&#39;)&#39;</span> <span class="ow">and</span> <span class="n">t3</span> <span class="ow">and</span> <span class="n">t3</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">STRING</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">t3</span><span class="o">.</span><span class="n">string</span><span class="p">[</span><span class="mi">1</span><span class="p">:][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># strip leading and trailing quotes</span></div>



<div class="viewcode-block" id="extract_spreadsheet_terms">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.extract_spreadsheet_terms">[docs]</a>
<span class="k">def</span> <span class="nf">extract_spreadsheet_terms</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">comment_tags</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Babel message extractor for spreadsheet data files.</span>

<span class="sd">    :param fileobj: the file-like object the messages should be extracted from</span>
<span class="sd">    :param keywords: a list of keywords (i.e. function names) that should</span>
<span class="sd">                     be recognized as translation functions</span>
<span class="sd">    :param comment_tags: a list of translator tags to search for and</span>
<span class="sd">                         include in the results</span>
<span class="sd">    :param options: a dictionary of additional options (optional)</span>
<span class="sd">    :return: an iterator over ``(lineno, funcname, message, comments)``</span>
<span class="sd">             tuples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">terms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sheet</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sheets&#39;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">sheet</span><span class="p">[</span><span class="s1">&#39;cells&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">):</span>
                <span class="n">terms</span> <span class="o">+=</span> <span class="n">extract_formula_terms</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">markdown_link</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[(.+)\]\(.+\)&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">markdown_link</span><span class="p">:</span>
                    <span class="n">terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">markdown_link</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">figure</span> <span class="ow">in</span> <span class="n">sheet</span><span class="p">[</span><span class="s1">&#39;figures&#39;</span><span class="p">]:</span>
            <span class="n">terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">figure</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;baselineDescr&#39;</span> <span class="ow">in</span> <span class="n">figure</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]:</span>
                <span class="n">terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">figure</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;baselineDescr&#39;</span><span class="p">])</span>
    <span class="n">pivots</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pivots&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="n">lists</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lists&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">data_source</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">lists</span><span class="p">,</span> <span class="n">pivots</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">data_source</span><span class="p">:</span>
            <span class="n">terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_source</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">global_filter</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;globalFilters&#39;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="n">terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">global_filter</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">terms</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">term</span><span class="p">)</span>
    <span class="p">)</span></div>


<span class="n">ImdInfo</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;ExternalId&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="s1">&#39;module&#39;</span><span class="p">])</span>


<div class="viewcode-block" id="TranslationReader">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.TranslationReader">[docs]</a>
<span class="k">class</span> <span class="nc">TranslationReader</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span> <span class="o">=</span> <span class="n">cr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lang</span> <span class="o">=</span> <span class="n">lang</span> <span class="ow">or</span> <span class="s1">&#39;en_US&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">odoo</span><span class="o">.</span><span class="n">SUPERUSER_ID</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_to_translate</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">module</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">res_id</span><span class="p">,</span> <span class="n">ttype</span><span class="p">,</span> <span class="n">comments</span><span class="p">,</span> <span class="n">_record_id</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_translate</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">ttype</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">res_id</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">encode</span><span class="p">(</span><span class="n">odoo</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">ustr</span><span class="p">(</span><span class="n">value</span><span class="p">)),</span> <span class="n">comments</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_push_translation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">ttype</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">res_id</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">record_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Insert a translation that will be used in the file generation</span>
<span class="sd">        In po file will create an entry</span>
<span class="sd">        #: &lt;ttype&gt;:&lt;name&gt;:&lt;res_id&gt;</span>
<span class="sd">        #, &lt;comment&gt;</span>
<span class="sd">        msgid &quot;&lt;source&gt;&quot;</span>
<span class="sd">        record_id is the database id of the record being translated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># empty and one-letter terms are ignored, they probably are not meant to be</span>
        <span class="c1"># translated, and would be very hard to translate anyway.</span>
        <span class="n">sanitized_term</span> <span class="o">=</span> <span class="p">(</span><span class="n">source</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># remove non-alphanumeric chars</span>
        <span class="n">sanitized_term</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\W+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sanitized_term</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sanitized_term</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">sanitized_term</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_to_translate</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">module</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">res_id</span><span class="p">,</span> <span class="n">ttype</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">comments</span> <span class="ow">or</span> <span class="p">()),</span> <span class="n">record_id</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_export_imdinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">imd_per_id</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ImdInfo</span><span class="p">]):</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_translatable_records</span><span class="p">(</span><span class="n">imd_per_id</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">records</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">env</span> <span class="o">=</span> <span class="n">records</span><span class="o">.</span><span class="n">env</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">check_translations</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">imd_per_id</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">module</span>
            <span class="n">xml_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">imd_per_id</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># ir_actions_actions.name is filtered because unlike other inherited fields,</span>
                <span class="c1"># this field is inherited as postgresql inherited columns.</span>
                <span class="c1"># From our business perspective, the parent column is no need to be translated,</span>
                <span class="c1"># but it is need to be set to jsonb column, since the child columns need to be translated</span>
                <span class="c1"># And export the parent field may make one value to be translated twice in transifex</span>
                <span class="c1">#</span>
                <span class="c1"># Some ir_model_fields.field_description are filtered</span>
                <span class="c1"># because their fields have falsy attribute export_string_translation</span>
                <span class="k">if</span> <span class="p">(</span>
                        <span class="ow">not</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">translate</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">)</span>
                        <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;ir.actions.actions.name&#39;</span>
                        <span class="ow">or</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;ir.model.fields.field_description&#39;</span>
                            <span class="ow">and</span> <span class="ow">not</span> <span class="n">env</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">export_string_translation</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">model</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">field_name</span>
                <span class="n">value_en</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
                <span class="n">value_lang</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lang</span><span class="p">)[</span><span class="n">field_name</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
                <span class="n">trans_type</span> <span class="o">=</span> <span class="s1">&#39;model_terms&#39;</span> <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;model&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">translation_dictionary</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_translation_dictionary</span><span class="p">(</span><span class="n">value_en</span><span class="p">,</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_lang</span><span class="p">:</span> <span class="n">value_lang</span><span class="p">})</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to extract terms from </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">xml_name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">term_en</span><span class="p">,</span> <span class="n">term_langs</span> <span class="ow">in</span> <span class="n">translation_dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">term_lang</span> <span class="o">=</span> <span class="n">term_langs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lang</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_push_translation</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">trans_type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">xml_name</span><span class="p">,</span> <span class="n">term_en</span><span class="p">,</span> <span class="n">record_id</span><span class="o">=</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">term_lang</span> <span class="k">if</span> <span class="n">term_lang</span> <span class="o">!=</span> <span class="n">term_en</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_translatable_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imd_records</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Filter the records that are translatable</span>

<span class="sd">        A record is considered as untranslatable if:</span>
<span class="sd">        - it does not exist</span>
<span class="sd">        - the model is flagged with _translate=False</span>
<span class="sd">        - it is a field of a model flagged with _translate=False</span>
<span class="sd">        - it is a selection of a field of a model flagged with _translate=False</span>

<span class="sd">        :param records: a list of namedtuple ImdInfo belonging to the same model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">imd_records</span><span class="p">))</span><span class="o">.</span><span class="n">model</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unable to find object </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;_unknown&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">_translate</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">()</span>

        <span class="n">res_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">res_id</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">imd_records</span><span class="p">]</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">res_ids</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">res_ids</span><span class="p">):</span>
            <span class="n">missing_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">res_ids</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
            <span class="n">missing_records</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">module</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">imd_records</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">res_id</span> <span class="ow">in</span> <span class="n">missing_ids</span><span class="p">]</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unable to find records of type </span><span class="si">%r</span><span class="s2"> with external ids </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_records</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">records</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">records</span>

        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;ir.model.fields.selection&#39;</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">selection</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
                <span class="n">fields</span><span class="p">[</span><span class="n">selection</span><span class="o">.</span><span class="n">field_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">selection</span>
            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">selection</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">field_name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span>
                <span class="n">field_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">field_model</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">field_model</span><span class="o">.</span><span class="n">_translate</span> <span class="ow">or</span>
                        <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field_model</span><span class="o">.</span><span class="n">_fields</span><span class="p">):</span>
                    <span class="c1"># the selection is linked to a model with _translate=False, remove it</span>
                    <span class="n">records</span> <span class="o">-=</span> <span class="n">selection</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;ir.model.fields&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
                <span class="n">field_name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span>
                <span class="n">field_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">field_model</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">field_model</span><span class="o">.</span><span class="n">_translate</span> <span class="ow">or</span>
                        <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field_model</span><span class="o">.</span><span class="n">_fields</span><span class="p">):</span>
                    <span class="c1"># the field is linked to a model with _translate=False, remove it</span>
                    <span class="n">records</span> <span class="o">-=</span> <span class="n">field</span>

        <span class="k">return</span> <span class="n">records</span></div>



<div class="viewcode-block" id="TranslationRecordReader">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.TranslationRecordReader">[docs]</a>
<span class="k">class</span> <span class="nc">TranslationRecordReader</span><span class="p">(</span><span class="n">TranslationReader</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Retrieve translations for specified records, the reader will</span>
<span class="sd">    1. create external ids for records without external ids</span>
<span class="sd">    2. export translations for stored translated and inherited translated fields</span>
<span class="sd">    :param cr: cursor to database to export</span>
<span class="sd">    :param model_name: model_name for the records to export</span>
<span class="sd">    :param ids: ids of the records to export</span>
<span class="sd">    :param field_names: field names to export, if not set, export all translatable fields</span>
<span class="sd">    :param lang: language code to retrieve the translations retrieve source terms only if not set</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">field_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_field_names</span> <span class="o">=</span> <span class="n">field_names</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_records</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_export_translatable_records</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_records</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_names</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_export_translatable_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">records</span><span class="p">,</span> <span class="n">field_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Export translations of all stored/inherited translated fields. Create external id if needed. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">records</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="n">records</span><span class="o">.</span><span class="n">_fields</span>

        <span class="k">if</span> <span class="n">records</span><span class="o">.</span><span class="n">_inherits</span><span class="p">:</span>
            <span class="n">inherited_fields</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">records</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">inherited_field</span><span class="p">:</span>
                    <span class="n">inherited_fields</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">inherited_field</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">parent_mname</span><span class="p">,</span> <span class="n">parent_fname</span> <span class="ow">in</span> <span class="n">records</span><span class="o">.</span><span class="n">_inherits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">parent_mname</span> <span class="ow">in</span> <span class="n">inherited_fields</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_export_translatable_records</span><span class="p">(</span><span class="n">records</span><span class="p">[</span><span class="n">parent_fname</span><span class="p">],</span> <span class="n">inherited_fields</span><span class="p">[</span><span class="n">parent_mname</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">translate</span> <span class="ow">and</span> <span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">store</span> <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">records</span><span class="o">.</span><span class="n">_BaseModel__ensure_xml_id</span><span class="p">()</span>

        <span class="n">model_name</span> <span class="o">=</span> <span class="n">records</span><span class="o">.</span><span class="n">_name</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT min(concat(module, &#39;.&#39;, name)), res_id</span>
<span class="s2">                             FROM ir_model_data</span>
<span class="s2">                            WHERE model = </span><span class="si">%s</span>
<span class="s2">                              AND res_id = ANY(</span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                         GROUP BY model, res_id&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">records</span><span class="o">.</span><span class="n">ids</span><span class="p">))</span>

        <span class="n">imd_per_id</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">res_id</span><span class="p">:</span> <span class="n">ImdInfo</span><span class="p">((</span><span class="n">tmp</span> <span class="o">:=</span> <span class="n">module_xml_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="mi">1</span><span class="p">],</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">res_id</span><span class="p">,</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">module_xml_name</span><span class="p">,</span> <span class="n">res_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_export_imdinfo</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">imd_per_id</span><span class="p">)</span></div>



<div class="viewcode-block" id="TranslationModuleReader">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.TranslationModuleReader">[docs]</a>
<span class="k">class</span> <span class="nc">TranslationModuleReader</span><span class="p">(</span><span class="n">TranslationReader</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Retrieve translated records per module</span>

<span class="sd">    :param cr: cursor to database to export</span>
<span class="sd">    :param modules: list of modules to filter the exported terms, can be [&#39;all&#39;]</span>
<span class="sd">                    records with no external id are always ignored</span>
<span class="sd">    :param lang: language code to retrieve the translations</span>
<span class="sd">                 retrieve source terms only if not set</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">modules</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span> <span class="o">=</span> <span class="n">modules</span> <span class="ow">or</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">path</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">odoo</span><span class="o">.</span><span class="n">addons</span><span class="o">.</span><span class="n">__path__</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_installed_modules</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">m</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.module.module&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search_read</span><span class="p">([(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;installed&#39;</span><span class="p">)],</span> <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_export_translatable_records</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_export_translatable_resources</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_export_translatable_records</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Export translations of all translated records having an external id &quot;&quot;&quot;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT min(name), model, res_id, module</span>
<span class="s2">                     FROM ir_model_data</span>
<span class="s2">                    WHERE module = ANY(</span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                 GROUP BY model, res_id, module</span>
<span class="s2">                 ORDER BY module, model, min(name)&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;all&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">:</span>
            <span class="n">query_param</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_installed_modules</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">query_param</span><span class="p">,))</span>

        <span class="n">records_per_model</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">xml_name</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">res_id</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="n">records_per_model</span><span class="p">[</span><span class="n">model</span><span class="p">][</span><span class="n">res_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">ImdInfo</span><span class="p">(</span><span class="n">xml_name</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">res_id</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">imd_per_id</span> <span class="ow">in</span> <span class="n">records_per_model</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_export_imdinfo</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">imd_per_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_module_from_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">rec</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path_list</span><span class="p">:</span>
            <span class="n">mp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rec</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dirname</span> <span class="o">!=</span> <span class="n">mp</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">mp</span><span class="p">):]</span>
                <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">&#39;base&#39;</span> <span class="c1"># files that are not in a module are considered as being in &#39;base&#39; module</span>

    <span class="k">def</span> <span class="nf">_verified_module_filepaths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
        <span class="n">fabsolutepath</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">frelativepath</span> <span class="o">=</span> <span class="n">fabsolutepath</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">):]</span>
        <span class="n">display_path</span> <span class="o">=</span> <span class="s2">&quot;addons</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">frelativepath</span>
        <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_module_from_path</span><span class="p">(</span><span class="n">fabsolutepath</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;all&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span> <span class="ow">or</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modules</span><span class="p">)</span> <span class="ow">and</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_installed_modules</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
                <span class="n">display_path</span> <span class="o">=</span> <span class="n">display_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">module</span><span class="p">,</span> <span class="n">fabsolutepath</span><span class="p">,</span> <span class="n">frelativepath</span><span class="p">,</span> <span class="n">display_path</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_babel_extract_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">extract_method</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="n">trans_type</span><span class="o">=</span><span class="s1">&#39;code&#39;</span><span class="p">,</span>
                               <span class="n">extra_comments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extract_keywords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;_&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}):</span>

        <span class="n">module</span><span class="p">,</span> <span class="n">fabsolutepath</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">display_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verified_module_filepaths</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">module</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">extra_comments</span> <span class="o">=</span> <span class="n">extra_comments</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">src_file</span> <span class="o">=</span> <span class="n">file_open</span><span class="p">(</span><span class="n">fabsolutepath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">extract_method</span> <span class="o">==</span> <span class="s1">&#39;python&#39;</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;encoding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;UTF-8&#39;</span>
            <span class="n">translations</span> <span class="o">=</span> <span class="n">code_translations</span><span class="o">.</span><span class="n">get_python_translations</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lang</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">translations</span> <span class="o">=</span> <span class="n">code_translations</span><span class="o">.</span><span class="n">get_web_translations</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lang</span><span class="p">)</span>
            <span class="n">translations</span> <span class="o">=</span> <span class="p">{</span><span class="n">tran</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]:</span> <span class="n">tran</span><span class="p">[</span><span class="s1">&#39;string&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">tran</span> <span class="ow">in</span> <span class="n">translations</span><span class="p">[</span><span class="s1">&#39;messages&#39;</span><span class="p">]}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">extracted</span> <span class="ow">in</span> <span class="n">extract</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">extract_method</span><span class="p">,</span> <span class="n">src_file</span><span class="p">,</span> <span class="n">keywords</span><span class="o">=</span><span class="n">extract_keywords</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">):</span>
                <span class="c1"># Babel 0.9.6 yields lineno, message, comments</span>
                <span class="c1"># Babel 1.3 yields lineno, message, comments, context</span>
                <span class="n">lineno</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">comments</span> <span class="o">=</span> <span class="n">extracted</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">translations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_push_translation</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">trans_type</span><span class="p">,</span> <span class="n">display_path</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span>
                                 <span class="n">encode</span><span class="p">(</span><span class="n">message</span><span class="p">),</span> <span class="n">comments</span> <span class="o">+</span> <span class="n">extra_comments</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to extract terms from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fabsolutepath</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">src_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_export_translatable_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Export translations for static terms</span>

<span class="sd">        This will include:</span>
<span class="sd">        - the python strings marked with _() or _lt()</span>
<span class="sd">        - the javascript strings marked with _t() or _lt() inside static/src/js/</span>
<span class="sd">        - the strings inside Qweb files inside static/src/xml/</span>
<span class="sd">        - the spreadsheet data files</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Also scan these non-addon paths</span>
        <span class="k">for</span> <span class="n">bin_path</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;osv&#39;</span><span class="p">,</span> <span class="s1">&#39;report&#39;</span><span class="p">,</span> <span class="s1">&#39;modules&#39;</span><span class="p">,</span> <span class="s1">&#39;service&#39;</span><span class="p">,</span> <span class="s1">&#39;tools&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_path_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;root_path&#39;</span><span class="p">],</span> <span class="n">bin_path</span><span class="p">),</span> <span class="kc">True</span><span class="p">))</span>
        <span class="c1"># non-recursive scan for individual files in root directory but without</span>
        <span class="c1"># scanning subdirectories that may contain addons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;root_path&#39;</span><span class="p">],</span> <span class="kc">False</span><span class="p">))</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Scanning modules at paths: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path_list</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">recursive</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path_list</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Scanning files of modules at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">followlinks</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="s1">&#39;*.py&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_babel_extract_terms</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="s1">&#39;python&#39;</span><span class="p">,</span>
                                              <span class="n">extra_comments</span><span class="o">=</span><span class="p">[</span><span class="n">PYTHON_TRANSLATION_COMMENT</span><span class="p">],</span>
                                              <span class="n">extract_keywords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;_&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;_lt&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
                <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;*/static/src*&#39;</span><span class="p">):</span>
                    <span class="c1"># Javascript source files</span>
                    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="s1">&#39;*.js&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_babel_extract_terms</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="s1">&#39;javascript&#39;</span><span class="p">,</span>
                                                  <span class="n">extra_comments</span><span class="o">=</span><span class="p">[</span><span class="n">JAVASCRIPT_TRANSLATION_COMMENT</span><span class="p">],</span>
                                                  <span class="n">extract_keywords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;_t&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;_lt&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
                    <span class="c1"># QWeb template files</span>
                    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="s1">&#39;*.xml&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_babel_extract_terms</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="s1">&#39;odoo.tools.translate:babel_extract_qweb&#39;</span><span class="p">,</span>
                                                  <span class="n">extra_comments</span><span class="o">=</span><span class="p">[</span><span class="n">JAVASCRIPT_TRANSLATION_COMMENT</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;*/data/*&#39;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="s1">&#39;*_dashboard.json&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_babel_extract_terms</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="s1">&#39;odoo.tools.translate:extract_spreadsheet_terms&#39;</span><span class="p">,</span>
                                                  <span class="n">extra_comments</span><span class="o">=</span><span class="p">[</span><span class="n">JAVASCRIPT_TRANSLATION_COMMENT</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">recursive</span><span class="p">:</span>
                    <span class="c1"># due to topdown, first iteration is in first level</span>
                    <span class="k">break</span></div>



<div class="viewcode-block" id="DeepDefaultDict">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.DeepDefaultDict">[docs]</a>
<span class="k">def</span> <span class="nf">DeepDefaultDict</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">DeepDefaultDict</span><span class="p">)</span></div>



<div class="viewcode-block" id="TranslationImporter">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.TranslationImporter">[docs]</a>
<span class="k">class</span> <span class="nc">TranslationImporter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Helper object for importing translation files to a database.</span>
<span class="sd">    This class provides a convenient API to load the translations from many</span>
<span class="sd">    files and import them all at once, which helps speeding up the whole import.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cr</span> <span class="o">=</span> <span class="n">cr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">odoo</span><span class="o">.</span><span class="n">SUPERUSER_ID</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># {model_name: {field_name: {xmlid: {lang: value}}}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_translations</span> <span class="o">=</span> <span class="n">DeepDefaultDict</span><span class="p">()</span>
        <span class="c1"># {model_name: {field_name: {xmlid: {src: {lang: value}}}}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_terms_translations</span> <span class="o">=</span> <span class="n">DeepDefaultDict</span><span class="p">()</span>

<div class="viewcode-block" id="TranslationImporter.load_file">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.TranslationImporter.load_file">[docs]</a>
    <span class="k">def</span> <span class="nf">load_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">xmlids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Load translations from the given file path.</span>

<span class="sd">        :param filepath: file path to open</span>
<span class="sd">        :param lang: language code of the translations contained in the file;</span>
<span class="sd">                     the language must be present and activated in the database</span>
<span class="sd">        :param xmlids: if given, only translations for records with xmlid in xmlids will be loaded</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">),</span> <span class="n">file_open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileobj</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;loading base translation file </span><span class="si">%s</span><span class="s1"> for language </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
            <span class="n">fileformat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filepath</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">fileformat</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">xmlids</span><span class="o">=</span><span class="n">xmlids</span><span class="p">)</span></div>


<div class="viewcode-block" id="TranslationImporter.load">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.TranslationImporter.load">[docs]</a>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">,</span> <span class="n">fileformat</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">xmlids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load translations from the given file object.</span>

<span class="sd">        :param fileobj: buffer open to a translation file</span>
<span class="sd">        :param fileformat: format of the `fielobj` file, one of &#39;po&#39; or &#39;csv&#39;</span>
<span class="sd">        :param lang: language code of the translations contained in `fileobj`;</span>
<span class="sd">                     the language must be present and activated in the database</span>
<span class="sd">        :param xmlids: if given, only translations for records with xmlid in xmlids will be loaded</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;loading translation file for language </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.lang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_lang_get</span><span class="p">(</span><span class="n">lang</span><span class="p">):</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t read translation for lang &#39;</span><span class="si">%s</span><span class="s2">&#39;, language not found&quot;</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">TranslationFileReader</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">fileformat</span><span class="o">=</span><span class="n">fileformat</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">xmlids</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">iso_lang</span> <span class="o">=</span> <span class="n">get_iso_codes</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;[lang: </span><span class="si">%s</span><span class="s1">][format: </span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iso_lang</span> <span class="ow">or</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="n">fileformat</span><span class="p">)</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t read translation file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reader</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">xmlids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">xmlids</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xmlids</span><span class="p">,</span> <span class="nb">set</span><span class="p">):</span>
            <span class="n">xmlids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">xmlids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">):</span>  <span class="c1"># ignore empty translations</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;code&#39;</span><span class="p">:</span>  <span class="c1"># ignore code translations</span>
                <span class="k">continue</span>
            <span class="n">model_name</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;imd_model&#39;</span><span class="p">)</span>
            <span class="n">module_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">model_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">xmlid</span> <span class="o">=</span> <span class="n">module_name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;imd_name&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">xmlids</span> <span class="ow">and</span> <span class="n">xmlid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xmlids</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;model&#39;</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_translations</span><span class="p">[</span><span class="n">model_name</span><span class="p">][</span><span class="n">field_name</span><span class="p">][</span><span class="n">xmlid</span><span class="p">][</span><span class="n">lang</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;model_terms&#39;</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_terms_translations</span><span class="p">[</span><span class="n">model_name</span><span class="p">][</span><span class="n">field_name</span><span class="p">][</span><span class="n">xmlid</span><span class="p">][</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]][</span><span class="n">lang</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="TranslationImporter.save">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.TranslationImporter.save">[docs]</a>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Save translations to the database.</span>

<span class="sd">        For a record with &#39;noupdate&#39; in ``ir_model_data``, its existing translations</span>
<span class="sd">        will be overwritten if ``force_overwrite or (not noupdate and overwrite)``.</span>

<span class="sd">        An existing translation means:</span>
<span class="sd">        * model translation: the ``jsonb`` value in database has the language code as key;</span>
<span class="sd">        * model terms translation: the term value in the language is different from the term value in ``en_US``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_translations</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_terms_translations</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span>
        <span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">model_dictionary</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_terms_translations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">Model</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>
            <span class="n">model_table</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">_table</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">_fields</span>
            <span class="c1"># field_name, {xmlid: {src: {lang: value}}}</span>
            <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_dictionary</span> <span class="ow">in</span> <span class="n">model_dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">sub_xmlids</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">split_for_in_conditions</span><span class="p">(</span><span class="n">field_dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="c1"># [module_name, imd_name, module_name, imd_name, ...]</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">xmlid</span> <span class="ow">in</span> <span class="n">sub_xmlids</span><span class="p">:</span>
                        <span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">xmlid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                        SELECT m.id, imd.module || &#39;.&#39; || imd.name, m.&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s1">&quot;, imd.noupdate</span>
<span class="s1">                        FROM &quot;</span><span class="si">{</span><span class="n">model_table</span><span class="si">}</span><span class="s1">&quot; m, &quot;ir_model_data&quot; imd</span>
<span class="s1">                        WHERE m.id = imd.res_id</span>
<span class="s1">                        AND (</span><span class="si">{</span><span class="s2">&quot; OR &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;(imd.module = </span><span class="si">%s</span><span class="s2"> AND imd.name = </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="si">}</span><span class="s1">)</span>
<span class="s1">                    &#39;&#39;&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

                    <span class="c1"># [id, translations, id, translations, ...]</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">xmlid</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">noupdate</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">values</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">_value_en</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_en_US&#39;</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;en_US&#39;</span><span class="p">])</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">_value_en</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="c1"># {src: {lang: value}}</span>
                        <span class="n">record_dictionary</span> <span class="o">=</span> <span class="n">field_dictionary</span><span class="p">[</span><span class="n">xmlid</span><span class="p">]</span>
                        <span class="n">langs</span> <span class="o">=</span> <span class="p">{</span><span class="n">lang</span> <span class="k">for</span> <span class="n">translations</span> <span class="ow">in</span> <span class="n">record_dictionary</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">translations</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
                        <span class="n">translation_dictionary</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_translation_dictionary</span><span class="p">(</span>
                            <span class="n">_value_en</span><span class="p">,</span>
                            <span class="p">{</span>
                                <span class="n">k</span><span class="p">:</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">langs</span>
                            <span class="p">}</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">force_overwrite</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">noupdate</span> <span class="ow">and</span> <span class="n">overwrite</span><span class="p">):</span>
                            <span class="c1"># overwrite existing translations</span>
                            <span class="k">for</span> <span class="n">term_en</span><span class="p">,</span> <span class="n">translations</span> <span class="ow">in</span> <span class="n">record_dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="n">translation_dictionary</span><span class="p">[</span><span class="n">term_en</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">translations</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># keep existing translations</span>
                            <span class="k">for</span> <span class="n">term_en</span><span class="p">,</span> <span class="n">translations</span> <span class="ow">in</span> <span class="n">record_dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="n">translations</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">translation_dictionary</span><span class="p">[</span><span class="n">term_en</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">term_en</span><span class="p">})</span>
                                <span class="n">translation_dictionary</span><span class="p">[</span><span class="n">term_en</span><span class="p">]</span> <span class="o">=</span> <span class="n">translations</span>

                        <span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">langs</span><span class="p">:</span>
                            <span class="c1"># translate and confirm model_terms translations</span>
                            <span class="n">values</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="k">lambda</span> <span class="n">term</span><span class="p">:</span> <span class="n">translation_dictionary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lang</span><span class="p">),</span> <span class="n">_value_en</span><span class="p">)</span>
                            <span class="n">values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">id_</span><span class="p">,</span> <span class="n">Json</span><span class="p">(</span><span class="n">values</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
                        <span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                            UPDATE &quot;</span><span class="si">{</span><span class="n">model_table</span><span class="si">}</span><span class="s2">&quot; AS m</span>
<span class="s2">                            SET &quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&quot; =  t.value</span>
<span class="s2">                            FROM (</span>
<span class="s2">                                VALUES </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">::jsonb)&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="si">}</span>
<span class="s2">                            ) AS t(id, value)</span>
<span class="s2">                            WHERE m.id = t.id</span>
<span class="s2">                        &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_terms_translations</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">model_dictionary</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_translations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">Model</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>
            <span class="n">model_table</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">_table</span>
            <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_dictionary</span> <span class="ow">in</span> <span class="n">model_dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">sub_field_dictionary</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">split_for_in_conditions</span><span class="p">(</span><span class="n">field_dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="c1"># [xmlid, translations, xmlid, translations, ...]</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">xmlid</span><span class="p">,</span> <span class="n">translations</span> <span class="ow">in</span> <span class="n">sub_field_dictionary</span><span class="p">:</span>
                        <span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="o">*</span><span class="n">xmlid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">Json</span><span class="p">(</span><span class="n">translations</span><span class="p">)])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">force_overwrite</span><span class="p">:</span>
                        <span class="n">value_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;CASE WHEN </span><span class="si">{</span><span class="n">overwrite</span><span class="si">}</span><span class="s2"> IS TRUE AND imd.noupdate IS FALSE</span>
<span class="s2">                        THEN m.&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&quot; || t.value</span>
<span class="s2">                        ELSE t.value || m.&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&quot;END&quot;&quot;&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;m.&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s1">&quot; || t.value&#39;</span>
                    <span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                        UPDATE &quot;</span><span class="si">{</span><span class="n">model_table</span><span class="si">}</span><span class="s2">&quot; AS m</span>
<span class="s2">                        SET &quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&quot; = </span><span class="si">{</span><span class="n">value_query</span><span class="si">}</span>
<span class="s2">                        FROM (</span>
<span class="s2">                            VALUES </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">::jsonb)&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span><span class="si">}</span>
<span class="s2">                        ) AS t(imd_module, imd_name, value)</span>
<span class="s2">                        JOIN &quot;ir_model_data&quot; AS imd</span>
<span class="s2">                        ON imd.&quot;model&quot; = &#39;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&#39; AND imd.name = t.imd_name AND imd.module = t.imd_module</span>
<span class="s2">                        WHERE imd.&quot;res_id&quot; = m.&quot;id&quot;</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_translations</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>
        <span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;translations are loaded successfully&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="trans_load">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.trans_load">[docs]</a>
<span class="k">def</span> <span class="nf">trans_load</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The function trans_load is deprecated in favor of TranslationImporter&#39;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
    <span class="n">translation_importer</span> <span class="o">=</span> <span class="n">TranslationImporter</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">translation_importer</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
    <span class="n">translation_importer</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span></div>



<div class="viewcode-block" id="trans_load_data">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.trans_load_data">[docs]</a>
<span class="k">def</span> <span class="nf">trans_load_data</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">,</span> <span class="n">fileformat</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The function trans_load_data is deprecated in favor of TranslationImporter&#39;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
    <span class="n">translation_importer</span> <span class="o">=</span> <span class="n">TranslationImporter</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">translation_importer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">fileformat</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
    <span class="n">translation_importer</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_locales">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.get_locales">[docs]</a>
<span class="k">def</span> <span class="nf">get_locales</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">lang</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">getlocale</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span><span class="p">:</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="n">_LOCALE2WIN32</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">enc</span><span class="p">):</span>
        <span class="n">ln</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">_build_localename</span><span class="p">((</span><span class="n">lang</span><span class="p">,</span> <span class="n">enc</span><span class="p">))</span>
        <span class="k">yield</span> <span class="n">ln</span>
        <span class="n">nln</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nln</span> <span class="o">!=</span> <span class="n">ln</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">nln</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">):</span> <span class="k">yield</span> <span class="n">x</span>

    <span class="n">prefenc</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">getpreferredencoding</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">prefenc</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">process</span><span class="p">(</span><span class="n">prefenc</span><span class="p">):</span> <span class="k">yield</span> <span class="n">x</span>

        <span class="n">prefenc</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;latin1&#39;</span><span class="p">:</span> <span class="s1">&#39;latin9&#39;</span><span class="p">,</span>
            <span class="s1">&#39;iso-8859-1&#39;</span><span class="p">:</span> <span class="s1">&#39;iso8859-15&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cp1252&#39;</span><span class="p">:</span> <span class="s1">&#39;1252&#39;</span><span class="p">,</span>
        <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prefenc</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">prefenc</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">process</span><span class="p">(</span><span class="n">prefenc</span><span class="p">):</span> <span class="k">yield</span> <span class="n">x</span>

    <span class="k">yield</span> <span class="n">lang</span></div>



<div class="viewcode-block" id="resetlocale">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.resetlocale">[docs]</a>
<span class="k">def</span> <span class="nf">resetlocale</span><span class="p">():</span>
    <span class="c1"># locale.resetlocale is bugged with some locales.</span>
    <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">get_locales</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="n">LC_ALL</span><span class="p">,</span> <span class="n">ln</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">locale</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
            <span class="k">continue</span></div>



<div class="viewcode-block" id="load_language">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.load_language">[docs]</a>
<span class="k">def</span> <span class="nf">load_language</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">lang</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Loads a translation terms for a language.</span>

<span class="sd">    Used mainly to automate language loading at db initialization.</span>

<span class="sd">    :param cr:</span>
<span class="sd">    :param str lang: language ISO code with optional underscore (``_``) and</span>
<span class="sd">        l10n flavor (ex: &#39;fr&#39;, &#39;fr_BE&#39;, but not &#39;fr-BE&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">odoo</span><span class="o">.</span><span class="n">SUPERUSER_ID</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">lang_ids</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.lang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">lang</span><span class="p">)])</span><span class="o">.</span><span class="n">ids</span>
    <span class="n">installer</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;base.language.install&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;lang_ids&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lang_ids</span><span class="p">)]})</span>
    <span class="n">installer</span><span class="o">.</span><span class="n">lang_install</span><span class="p">()</span></div>




<div class="viewcode-block" id="get_po_paths">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.get_po_paths">[docs]</a>
<span class="k">def</span> <span class="nf">get_po_paths</span><span class="p">(</span><span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lang</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">lang_base</span> <span class="o">=</span> <span class="n">lang</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">lang_base</span> <span class="o">==</span> <span class="s1">&#39;es&#39;</span> <span class="ow">and</span> <span class="n">lang</span> <span class="o">!=</span> <span class="s1">&#39;es_ES&#39;</span><span class="p">:</span>
        <span class="c1"># force es_419 as fallback language for the spanish variations</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;es_419&#39;</span><span class="p">:</span>
            <span class="n">langs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;es_419&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">langs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;es_419&#39;</span><span class="p">,</span> <span class="n">lang</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">langs</span> <span class="o">=</span> <span class="p">[</span><span class="n">lang_base</span><span class="p">,</span> <span class="n">lang</span><span class="p">]</span>

    <span class="n">po_paths</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">path</span>
        <span class="k">for</span> <span class="n">lang_</span> <span class="ow">in</span> <span class="n">langs</span>
        <span class="k">for</span> <span class="n">dir_</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;i18n&#39;</span><span class="p">,</span> <span class="s1">&#39;i18n_extra&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">path</span> <span class="o">:=</span> <span class="n">join</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">dir_</span><span class="p">,</span> <span class="n">lang_</span> <span class="o">+</span> <span class="s1">&#39;.po&#39;</span><span class="p">))</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">po_paths</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">file_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>



<div class="viewcode-block" id="CodeTranslations">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.CodeTranslations">[docs]</a>
<span class="k">class</span> <span class="nc">CodeTranslations</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># {(module_name, lang): {src: value}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">python_translations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># {(module_name, lang): {&#39;message&#39;: [{&#39;id&#39;: src, &#39;string&#39;: value}]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web_translations</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_read_code_translations_file</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">filter_func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; read and return code translations from fileobj with filter filter_func</span>

<span class="sd">        :param func filter_func: a filter function to drop unnecessary code translations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># current, we assume the fileobj is from the source code, which only contains the translation for the current module</span>
        <span class="c1"># don&#39;t use it in the import logic</span>
        <span class="n">translations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">TranslationFileReader</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">fileformat</span><span class="o">=</span><span class="s1">&#39;po&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;code&#39;</span> <span class="ow">and</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">filter_func</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                <span class="n">translations</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">translations</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_code_translations</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">filter_func</span><span class="p">):</span>
        <span class="n">po_paths</span> <span class="o">=</span> <span class="n">get_po_paths</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
        <span class="n">translations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">po_path</span> <span class="ow">in</span> <span class="n">po_paths</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">file_open</span><span class="p">(</span><span class="n">po_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileobj</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">CodeTranslations</span><span class="o">.</span><span class="n">_read_code_translations_file</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="n">filter_func</span><span class="p">)</span>
                <span class="n">translations</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="n">iso_lang</span> <span class="o">=</span> <span class="n">get_iso_codes</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;[lang: </span><span class="si">%s</span><span class="s1">][format: </span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iso_lang</span> <span class="ow">or</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="s1">&#39;po&#39;</span><span class="p">)</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t read translation file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">translations</span>

    <span class="k">def</span> <span class="nf">_load_python_translations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">lang</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">filter_func</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="c1"># In the pot files with new translations, a code translation should have either</span>
            <span class="c1"># PYTHON_TRANSLATION_COMMENT or JAVASCRIPT_TRANSLATION_COMMENT for comments.</span>
            <span class="c1"># If a comment has neither the above comments, the pot file uses the deprecated</span>
            <span class="c1"># comments. And all code translations are stored as python translations.</span>
            <span class="k">return</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">PYTHON_TRANSLATION_COMMENT</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">]</span>
                    <span class="ow">or</span> <span class="n">JAVASCRIPT_TRANSLATION_COMMENT</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">])</span>
        <span class="n">translations</span> <span class="o">=</span> <span class="n">CodeTranslations</span><span class="o">.</span><span class="n">_get_code_translations</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">filter_func</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">python_translations</span><span class="p">[(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">lang</span><span class="p">)]</span> <span class="o">=</span> <span class="n">translations</span>

    <span class="k">def</span> <span class="nf">_load_web_translations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">lang</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">filter_func</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">JAVASCRIPT_TRANSLATION_COMMENT</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">]</span>
                    <span class="ow">or</span> <span class="n">WEB_TRANSLATION_COMMENT</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">])</span>
        <span class="n">translations</span> <span class="o">=</span> <span class="n">CodeTranslations</span><span class="o">.</span><span class="n">_get_code_translations</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">filter_func</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">web_translations</span><span class="p">[(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">lang</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">src</span><span class="p">,</span> <span class="s2">&quot;string&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span> <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">translations</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="p">}</span>

<div class="viewcode-block" id="CodeTranslations.get_python_translations">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.CodeTranslations.get_python_translations">[docs]</a>
    <span class="k">def</span> <span class="nf">get_python_translations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">lang</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">python_translations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_python_translations</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">python_translations</span><span class="p">[(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">lang</span><span class="p">)]</span></div>


<div class="viewcode-block" id="CodeTranslations.get_web_translations">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.translate.CodeTranslations.get_web_translations">[docs]</a>
    <span class="k">def</span> <span class="nf">get_web_translations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">lang</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">web_translations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_web_translations</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">web_translations</span><span class="p">[(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">lang</span><span class="p">)]</span></div>
</div>



<span class="n">code_translations</span> <span class="o">=</span> <span class="n">CodeTranslations</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_get_translation_upgrade_queries</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return a pair of lists ``migrate_queries, cleanup_queries`` of SQL queries. The queries in</span>
<span class="sd">    ``migrate_queries`` do migrate the data from table ``_ir_translation`` to the corresponding</span>
<span class="sd">    field&#39;s column, while the queries in ``cleanup_queries`` remove the corresponding data from</span>
<span class="sd">    table ``_ir_translation``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Model</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">registry</span><span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">dbname</span><span class="p">)[</span><span class="n">field</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span>
    <span class="n">translation_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">migrate_queries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cleanup_queries</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            WITH t AS (</span>
<span class="s2">                SELECT it.res_id as res_id, jsonb_object_agg(it.lang, it.value) AS value, bool_or(imd.noupdate) AS noupdate</span>
<span class="s2">                  FROM _ir_translation it</span>
<span class="s2">             LEFT JOIN ir_model_data imd</span>
<span class="s2">                    ON imd.model = %s AND imd.res_id = it.res_id AND imd.module != &#39;__export__&#39;</span>
<span class="s2">                 WHERE it.type = &#39;model&#39; AND it.name = %s AND it.state = &#39;translated&#39;</span>
<span class="s2">              GROUP BY it.res_id</span>
<span class="s2">            )</span>
<span class="s2">            UPDATE </span><span class="si">{</span><span class="n">Model</span><span class="o">.</span><span class="n">_table</span><span class="si">}</span><span class="s2"> m</span>
<span class="s2">               SET &quot;</span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot; = CASE WHEN t.noupdate IS FALSE THEN t.value || m.&quot;</span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="s2">                                         ELSE m.&quot;</span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot; || t.value</span>
<span class="s2">                                     END</span>
<span class="s2">              FROM t</span>
<span class="s2">             WHERE t.res_id = m.id</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">migrate_queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">mogrify</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="n">Model</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">translation_name</span><span class="p">])</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;DELETE FROM _ir_translation WHERE type = &#39;model&#39; AND name = </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="n">cleanup_queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">mogrify</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="n">translation_name</span><span class="p">])</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>

    <span class="c1"># upgrade model_terms translation: one update per field per record</span>
    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">):</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT code FROM res_lang WHERE active = &#39;t&#39;&quot;</span><span class="p">)</span>
        <span class="n">languages</span> <span class="o">=</span> <span class="p">{</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()}</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT t.res_id, m.&quot;</span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;, t.value, t.noupdate</span>
<span class="s2">              FROM t</span>
<span class="s2">              JOIN &quot;</span><span class="si">{</span><span class="n">Model</span><span class="o">.</span><span class="n">_table</span><span class="si">}</span><span class="s2">&quot; m ON t.res_id = m.id</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">translation_name</span> <span class="o">==</span> <span class="s1">&#39;ir.ui.view,arch_db&#39;</span><span class="p">:</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id from ir_module_module WHERE name = &#39;website&#39; AND state=&#39;installed&#39;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">():</span>
                <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    SELECT t.res_id, m.&quot;</span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;, t.value, t.noupdate, l.code</span>
<span class="s2">                      FROM t</span>
<span class="s2">                      JOIN &quot;</span><span class="si">{</span><span class="n">Model</span><span class="o">.</span><span class="n">_table</span><span class="si">}</span><span class="s2">&quot; m ON t.res_id = m.id</span>
<span class="s2">                      JOIN website w ON m.website_id = w.id</span>
<span class="s2">                      JOIN res_lang l ON w.default_lang_id = l.id</span>
<span class="s2">                    UNION</span>
<span class="s2">                    SELECT t.res_id, m.&quot;</span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;, t.value, t.noupdate, &#39;en_US&#39;</span>
<span class="s2">                      FROM t</span>
<span class="s2">                      JOIN &quot;</span><span class="si">{</span><span class="n">Model</span><span class="o">.</span><span class="n">_table</span><span class="si">}</span><span class="s2">&quot; m ON t.res_id = m.id</span>
<span class="s2">                     WHERE m.website_id IS NULL</span>
<span class="s2">                &quot;&quot;&quot;</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            WITH t0 AS (</span>
<span class="s2">                -- aggregate translations by source term --</span>
<span class="s2">                SELECT res_id, lang, jsonb_object_agg(src, value) AS value</span>
<span class="s2">                  FROM _ir_translation</span>
<span class="s2">                 WHERE type = &#39;model_terms&#39; AND name = %s AND state = &#39;translated&#39;</span>
<span class="s2">              GROUP BY res_id, lang</span>
<span class="s2">            ),</span>
<span class="s2">            t AS (</span>
<span class="s2">                -- aggregate translations by lang --</span>
<span class="s2">                SELECT t0.res_id AS res_id, jsonb_object_agg(t0.lang, t0.value) AS value, bool_or(imd.noupdate) AS noupdate</span>
<span class="s2">                  FROM t0</span>
<span class="s2">             LEFT JOIN ir_model_data imd</span>
<span class="s2">                    ON imd.model = %s AND imd.res_id = t0.res_id</span>
<span class="s2">              GROUP BY t0.res_id</span>
<span class="s2">            )&quot;&quot;&quot;</span> <span class="o">+</span> <span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="n">translation_name</span><span class="p">,</span> <span class="n">Model</span><span class="o">.</span><span class="n">_name</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">new_translations</span><span class="p">,</span> <span class="n">translations</span><span class="p">,</span> <span class="n">noupdate</span><span class="p">,</span> <span class="o">*</span><span class="n">extra</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">new_translations</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># new_translations contains translations updated from the latest po files</span>
            <span class="n">src_value</span> <span class="o">=</span> <span class="n">new_translations</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;en_US&#39;</span><span class="p">)</span>
            <span class="n">src_terms</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_trans_terms</span><span class="p">(</span><span class="n">src_value</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">lang</span><span class="p">,</span> <span class="n">dst_value</span> <span class="ow">in</span> <span class="n">new_translations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">terms_mapping</span> <span class="o">=</span> <span class="n">translations</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">dst_terms</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_trans_terms</span><span class="p">(</span><span class="n">dst_value</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">src_term</span><span class="p">,</span> <span class="n">dst_term</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">src_terms</span><span class="p">,</span> <span class="n">dst_terms</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">src_term</span> <span class="o">==</span> <span class="n">dst_term</span> <span class="ow">or</span> <span class="n">noupdate</span><span class="p">:</span>
                        <span class="n">terms_mapping</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">src_term</span><span class="p">,</span> <span class="n">dst_term</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">terms_mapping</span><span class="p">[</span><span class="n">src_term</span><span class="p">]</span> <span class="o">=</span> <span class="n">dst_term</span>
            <span class="n">new_values</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">lang</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">terms_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">src_value</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">lang</span><span class="p">,</span> <span class="n">terms_mapping</span> <span class="ow">in</span> <span class="n">translations</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="s2">&quot;en_US&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_values</span><span class="p">:</span>
                <span class="n">new_values</span><span class="p">[</span><span class="s2">&quot;en_US&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="n">src_value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extra</span> <span class="ow">and</span> <span class="n">extra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_values</span><span class="p">:</span>
                <span class="n">new_values</span><span class="p">[</span><span class="n">extra</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="n">src_value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">extra</span><span class="p">:</span>
                <span class="n">missing_languages</span> <span class="o">=</span> <span class="n">languages</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">translations</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">missing_languages</span><span class="p">:</span>
                    <span class="n">src_value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="n">src_value</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">missing_languages</span><span class="p">):</span>
                        <span class="n">new_values</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">=</span> <span class="n">src_value</span>
            <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;UPDATE &quot;</span><span class="si">{</span><span class="n">Model</span><span class="o">.</span><span class="n">_table</span><span class="si">}</span><span class="s1">&quot; SET &quot;</span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot; = %s WHERE id = %s&#39;</span>
            <span class="n">migrate_queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">mogrify</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="n">Json</span><span class="p">(</span><span class="n">new_values</span><span class="p">),</span> <span class="n">id_</span><span class="p">])</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;DELETE FROM _ir_translation WHERE type = &#39;model_terms&#39; AND name = </span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="n">cleanup_queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">mogrify</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="n">translation_name</span><span class="p">])</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">migrate_queries</span><span class="p">,</span> <span class="n">cleanup_queries</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Amr.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>