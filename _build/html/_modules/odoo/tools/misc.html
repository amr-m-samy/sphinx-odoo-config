<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>odoo.tools.misc &mdash; Amr  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Amr
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">odoo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Amr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../odoo.html">odoo</a></li>
      <li class="breadcrumb-item active">odoo.tools.misc</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for odoo.tools.misc</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># Part of Odoo. See LICENSE file for full copyright and licensing details.</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Miscellaneous tools used by OpenERP.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">cProfile</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">hmac</span> <span class="k">as</span> <span class="nn">hmac_lib</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span> <span class="k">as</span> <span class="nn">pickle_</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">unicodedata</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">MutableMapping</span><span class="p">,</span> <span class="n">MutableSet</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">ContextDecorator</span><span class="p">,</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">difflib</span> <span class="kn">import</span> <span class="n">HtmlDiff</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">islice</span><span class="p">,</span> <span class="n">groupby</span> <span class="k">as</span> <span class="n">itergroupby</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span>

<span class="kn">import</span> <span class="nn">babel</span>
<span class="kn">import</span> <span class="nn">babel.dates</span>
<span class="kn">import</span> <span class="nn">markupsafe</span>
<span class="kn">import</span> <span class="nn">passlib.utils</span>
<span class="kn">import</span> <span class="nn">pytz</span>
<span class="kn">import</span> <span class="nn">werkzeug.utils</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>

<span class="kn">import</span> <span class="nn">odoo</span>
<span class="kn">import</span> <span class="nn">odoo.addons</span>
<span class="c1"># get_encodings, ustr and exception_to_unicode were originally from tools.misc.</span>
<span class="c1"># There are moved to loglevels until we refactor tools.</span>
<span class="kn">from</span> <span class="nn">odoo.loglevels</span> <span class="kn">import</span> <span class="n">get_encodings</span><span class="p">,</span> <span class="n">ustr</span><span class="p">,</span> <span class="n">exception_to_unicode</span>     <span class="c1"># noqa</span>
<span class="kn">from</span> <span class="nn">odoo.tools.float_utils</span> <span class="kn">import</span> <span class="n">float_round</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">pycompat</span>
<span class="kn">from</span> <span class="nn">.cache</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">.parse_version</span> <span class="kn">import</span> <span class="n">parse_version</span>
<span class="kn">from</span> <span class="nn">.which</span> <span class="kn">import</span> <span class="n">which</span>

<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># List of etree._Element subclasses that we choose to ignore when parsing XML.</span>
<span class="c1"># We include the *Base ones just in case, currently they seem to be subclasses of the _* ones.</span>
<span class="n">SKIPPED_ELEMENT_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">_Comment</span><span class="p">,</span> <span class="n">etree</span><span class="o">.</span><span class="n">_ProcessingInstruction</span><span class="p">,</span> <span class="n">etree</span><span class="o">.</span><span class="n">CommentBase</span><span class="p">,</span> <span class="n">etree</span><span class="o">.</span><span class="n">PIBase</span><span class="p">,</span> <span class="n">etree</span><span class="o">.</span><span class="n">_Entity</span><span class="p">)</span>

<span class="c1"># Configure default global parser</span>
<span class="n">etree</span><span class="o">.</span><span class="n">set_default_parser</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">XMLParser</span><span class="p">(</span><span class="n">resolve_entities</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="n">NON_BREAKING_SPACE</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\N{NO-BREAK SPACE}</span><span class="s1">&#39;</span>

<span class="c1">#----------------------------------------------------------</span>
<span class="c1"># Subprocesses</span>
<span class="c1">#----------------------------------------------------------</span>

<div class="viewcode-block" id="find_in_path">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.find_in_path">[docs]</a>
<span class="k">def</span> <span class="nf">find_in_path</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">defpath</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bin_path&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;bin_path&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
        <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;bin_path&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">which</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">_exec_pipe</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Since 16.0, just use `subprocess`.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">prog</span><span class="p">,)</span> <span class="o">+</span> <span class="n">args</span>
    <span class="c1"># on win32, passing close_fds=True is not compatible</span>
    <span class="c1"># with redirecting std[in/err/out]</span>
    <span class="n">close_fds</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s2">&quot;posix&quot;</span>
    <span class="n">pop</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">bufsize</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">close_fds</span><span class="o">=</span><span class="n">close_fds</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pop</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="n">pop</span><span class="o">.</span><span class="n">stdout</span>

<div class="viewcode-block" id="exec_command_pipe">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.exec_command_pipe">[docs]</a>
<span class="k">def</span> <span class="nf">exec_command_pipe</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Since 16.0, use `subprocess` directly.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">prog</span> <span class="o">=</span> <span class="n">find_in_path</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">prog</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Command `</span><span class="si">%s</span><span class="s1">` not found.&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_exec_pipe</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span></div>


<span class="c1">#----------------------------------------------------------</span>
<span class="c1"># Postgres subprocesses</span>
<span class="c1">#----------------------------------------------------------</span>

<div class="viewcode-block" id="find_pg_tool">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.find_pg_tool">[docs]</a>
<span class="k">def</span> <span class="nf">find_pg_tool</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pg_path&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pg_path&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pg_path&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">which</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Command `</span><span class="si">%s</span><span class="s1">` not found.&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="exec_pg_environ">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.exec_pg_environ">[docs]</a>
<span class="k">def</span> <span class="nf">exec_pg_environ</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Force the database PostgreSQL environment variables to the database</span>
<span class="sd">    configuration of Odoo.</span>

<span class="sd">    Note: On systems where pg_restore/pg_dump require an explicit password</span>
<span class="sd">    (i.e.  on Windows where TCP sockets are used), it is necessary to pass the</span>
<span class="sd">    postgres user password in the PGPASSWORD environment variable or in a</span>
<span class="sd">    special .pgpass file.</span>

<span class="sd">    See also http://www.postgresql.org/docs/8.4/static/libpq-envars.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">odoo</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;db_host&#39;</span><span class="p">]:</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;PGHOST&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;db_host&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">odoo</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;db_port&#39;</span><span class="p">]:</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;PGPORT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">odoo</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;db_port&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">odoo</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;db_user&#39;</span><span class="p">]:</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;PGUSER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;db_user&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">odoo</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;db_password&#39;</span><span class="p">]:</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;PGPASSWORD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;db_password&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">env</span></div>


<div class="viewcode-block" id="exec_pg_command">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.exec_pg_command">[docs]</a>
<span class="k">def</span> <span class="nf">exec_pg_command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Since 16.0, use `subprocess` directly.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">prog</span> <span class="o">=</span> <span class="n">find_pg_tool</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">exec_pg_environ</span><span class="p">()</span>
    <span class="n">args2</span> <span class="o">=</span> <span class="p">(</span><span class="n">prog</span><span class="p">,)</span> <span class="o">+</span> <span class="n">args</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">args2</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Postgres subprocess </span><span class="si">%s</span><span class="s1"> error </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args2</span><span class="p">,</span> <span class="n">rc</span><span class="p">))</span></div>


<div class="viewcode-block" id="exec_pg_command_pipe">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.exec_pg_command_pipe">[docs]</a>
<span class="k">def</span> <span class="nf">exec_pg_command_pipe</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Since 16.0, use `subprocess` directly.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">prog</span> <span class="o">=</span> <span class="n">find_pg_tool</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">exec_pg_environ</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">_exec_pipe</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span></div>


<span class="c1">#----------------------------------------------------------</span>
<span class="c1"># File paths</span>
<span class="c1">#----------------------------------------------------------</span>

<div class="viewcode-block" id="file_path">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.file_path">[docs]</a>
<span class="k">def</span> <span class="nf">file_path</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">filter_ext</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,),</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify that a file exists under a known `addons_path` directory and return its full path.</span>

<span class="sd">    Examples::</span>

<span class="sd">    &gt;&gt;&gt; file_path(&#39;hr&#39;)</span>
<span class="sd">    &gt;&gt;&gt; file_path(&#39;hr/static/description/icon.png&#39;)</span>
<span class="sd">    &gt;&gt;&gt; file_path(&#39;hr/static/description/icon.png&#39;, filter_ext=(&#39;.png&#39;, &#39;.jpg&#39;))</span>

<span class="sd">    :param str file_path: absolute file path, or relative path within any `addons_path` directory</span>
<span class="sd">    :param list[str] filter_ext: optional list of supported extensions (lowercase, with leading dot)</span>
<span class="sd">    :param env: optional environment, required for a file path within a temporary directory</span>
<span class="sd">        created using `file_open_temporary_directory()`</span>
<span class="sd">    :return: the absolute path to the file</span>
<span class="sd">    :raise FileNotFoundError: if the file is not found under the known `addons_path` directories</span>
<span class="sd">    :raise ValueError: if the file doesn&#39;t have one of the supported extensions (`filter_ext`)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">root_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;root_path&#39;</span><span class="p">])</span>
    <span class="n">addons_paths</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">addons</span><span class="o">.</span><span class="n">__path__</span> <span class="o">+</span> <span class="p">[</span><span class="n">root_path</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">env</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">transaction</span><span class="p">,</span> <span class="s1">&#39;__file_open_tmp_paths&#39;</span><span class="p">):</span>
        <span class="n">addons_paths</span> <span class="o">+=</span> <span class="n">env</span><span class="o">.</span><span class="n">transaction</span><span class="o">.</span><span class="n">__file_open_tmp_paths</span>
    <span class="n">is_abs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">normalized_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normcase</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">filter_ext</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">normalized_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">filter_ext</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported file: &quot;</span> <span class="o">+</span> <span class="n">file_path</span><span class="p">)</span>

    <span class="c1"># ignore leading &#39;addons/&#39; if present, it&#39;s the final component of root_path, but</span>
    <span class="c1"># may sometimes be included in relative paths</span>
    <span class="k">if</span> <span class="n">normalized_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;addons&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">):</span>
        <span class="n">normalized_path</span> <span class="o">=</span> <span class="n">normalized_path</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>

    <span class="k">for</span> <span class="n">addons_dir</span> <span class="ow">in</span> <span class="n">addons_paths</span><span class="p">:</span>
        <span class="c1"># final path sep required to avoid partial match</span>
        <span class="n">parent_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normcase</span><span class="p">(</span><span class="n">addons_dir</span><span class="p">))</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="p">(</span><span class="n">normalized_path</span> <span class="k">if</span> <span class="n">is_abs</span> <span class="k">else</span>
                 <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normcase</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_path</span><span class="p">,</span> <span class="n">normalized_path</span><span class="p">))))</span>
        <span class="k">if</span> <span class="n">fpath</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">parent_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fpath</span>

    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;File not found: &quot;</span> <span class="o">+</span> <span class="n">file_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="file_open">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.file_open">[docs]</a>
<span class="k">def</span> <span class="nf">file_open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">filter_ext</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Open a file from within the addons_path directories, as an absolute or relative path.</span>

<span class="sd">    Examples::</span>

<span class="sd">        &gt;&gt;&gt; file_open(&#39;hr/static/description/icon.png&#39;)</span>
<span class="sd">        &gt;&gt;&gt; file_open(&#39;hr/static/description/icon.png&#39;, filter_ext=(&#39;.png&#39;, &#39;.jpg&#39;))</span>
<span class="sd">        &gt;&gt;&gt; with file_open(&#39;/opt/odoo/addons/hr/static/description/icon.png&#39;, &#39;rb&#39;) as f:</span>
<span class="sd">        ...     contents = f.read()</span>

<span class="sd">    :param name: absolute or relative path to a file located inside an addon</span>
<span class="sd">    :param mode: file open mode, as for `open()`</span>
<span class="sd">    :param list[str] filter_ext: optional list of supported extensions (lowercase, with leading dot)</span>
<span class="sd">    :param env: optional environment, required to open a file within a temporary directory</span>
<span class="sd">        created using `file_open_temporary_directory()`</span>
<span class="sd">    :return: file object, as returned by `open()`</span>
<span class="sd">    :raise FileNotFoundError: if the file is not found under the known `addons_path` directories</span>
<span class="sd">    :raise ValueError: if the file doesn&#39;t have one of the supported extensions (`filter_ext`)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">filter_ext</span><span class="o">=</span><span class="n">filter_ext</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;b&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
            <span class="c1"># Force encoding for text mode, as system locale could affect default encoding,</span>
            <span class="c1"># even with the latest Python 3 versions.</span>
            <span class="c1"># Note: This is not covered by a unit test, due to the platform dependency.</span>
            <span class="c1">#       For testing purposes you should be able to force a non-UTF8 encoding with:</span>
            <span class="c1">#         `sudo locale-gen fr_FR; LC_ALL=fr_FR.iso8859-1 python3 ...&#39;</span>
            <span class="c1"># See also PEP-540, although we can&#39;t rely on that at the moment.</span>
            <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Not a file: &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span></div>



<div class="viewcode-block" id="file_open_temporary_directory">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.file_open_temporary_directory">[docs]</a>
<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">file_open_temporary_directory</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create and return a temporary directory added to the directories `file_open` is allowed to read from.</span>

<span class="sd">    `file_open` will be allowed to open files within the temporary directory</span>
<span class="sd">    only for environments of the same transaction than `env`.</span>
<span class="sd">    Meaning, other transactions/requests from other users or even other databases</span>
<span class="sd">    won&#39;t be allowed to open files from this directory.</span>

<span class="sd">    Examples::</span>

<span class="sd">        &gt;&gt;&gt; with odoo.tools.file_open_temporary_directory(self.env) as module_dir:</span>
<span class="sd">        ...    with zipfile.ZipFile(&#39;foo.zip&#39;, &#39;r&#39;) as z:</span>
<span class="sd">        ...        z.extract(&#39;foo/__manifest__.py&#39;, module_dir)</span>
<span class="sd">        ...    with odoo.tools.file_open(&#39;foo/__manifest__.py&#39;, env=self.env) as f:</span>
<span class="sd">        ...        manifest = f.read()</span>

<span class="sd">    :param env: environment for which the temporary directory is created.</span>
<span class="sd">    :return: the absolute path to the created temporary directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">transaction</span><span class="p">,</span> <span class="s1">&#39;__file_open_tmp_paths&#39;</span><span class="p">),</span> <span class="s1">&#39;Reentrancy is not implemented for this method&#39;</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">module_dir</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">env</span><span class="o">.</span><span class="n">transaction</span><span class="o">.</span><span class="n">__file_open_tmp_paths</span> <span class="o">=</span> <span class="p">(</span><span class="n">module_dir</span><span class="p">,)</span>
            <span class="k">yield</span> <span class="n">module_dir</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">env</span><span class="o">.</span><span class="n">transaction</span><span class="o">.</span><span class="n">__file_open_tmp_paths</span></div>



<span class="c1">#----------------------------------------------------------</span>
<span class="c1"># iterables</span>
<span class="c1">#----------------------------------------------------------</span>
<div class="viewcode-block" id="flatten">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.flatten">[docs]</a>
<span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flatten a list of elements into a unique list</span>
<span class="sd">    Author: Christophe Simonis (christophe@tinyerp.com)</span>

<span class="sd">    Examples::</span>
<span class="sd">    &gt;&gt;&gt; flatten([&#39;a&#39;])</span>
<span class="sd">    [&#39;a&#39;]</span>
<span class="sd">    &gt;&gt;&gt; flatten(&#39;b&#39;)</span>
<span class="sd">    [&#39;b&#39;]</span>
<span class="sd">    &gt;&gt;&gt; flatten( [] )</span>
<span class="sd">    []</span>
<span class="sd">    &gt;&gt;&gt; flatten( [[], [[]]] )</span>
<span class="sd">    []</span>
<span class="sd">    &gt;&gt;&gt; flatten( [[[&#39;a&#39;,&#39;b&#39;], &#39;c&#39;], &#39;d&#39;, [&#39;e&#39;, [], &#39;f&#39;]] )</span>
<span class="sd">    [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;, &#39;f&#39;]</span>
<span class="sd">    &gt;&gt;&gt; t = (1,2,(3,), [4, 5, [6, [7], (8, 9), ([10, 11, (12, 13)]), [14, [], (15,)], []]])</span>
<span class="sd">    &gt;&gt;&gt; flatten(t)</span>
<span class="sd">    [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Iterable</span><span class="p">):</span>
            <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">flatten</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">r</span></div>


<div class="viewcode-block" id="reverse_enumerate">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.reverse_enumerate">[docs]</a>
<span class="k">def</span> <span class="nf">reverse_enumerate</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Like enumerate but in the other direction</span>

<span class="sd">    Usage::</span>

<span class="sd">        &gt;&gt;&gt; a = [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;]</span>
<span class="sd">        &gt;&gt;&gt; it = reverse_enumerate(a)</span>
<span class="sd">        &gt;&gt;&gt; it.next()</span>
<span class="sd">        (2, &#39;c&#39;)</span>
<span class="sd">        &gt;&gt;&gt; it.next()</span>
<span class="sd">        (1, &#39;b&#39;)</span>
<span class="sd">        &gt;&gt;&gt; it.next()</span>
<span class="sd">        (0, &#39;a&#39;)</span>
<span class="sd">        &gt;&gt;&gt; it.next()</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">          File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span>
<span class="sd">        StopIteration</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">l</span><span class="p">))</span></div>


<div class="viewcode-block" id="partition">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.partition">[docs]</a>
<span class="k">def</span> <span class="nf">partition</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">elems</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return a pair equivalent to:</span>
<span class="sd">    ``filter(pred, elems), filter(lambda x: not pred(x), elems)`` &quot;&quot;&quot;</span>
    <span class="n">yes</span><span class="p">,</span> <span class="n">nos</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">:</span>
        <span class="p">(</span><span class="n">yes</span> <span class="k">if</span> <span class="n">pred</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">else</span> <span class="n">nos</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">yes</span><span class="p">,</span> <span class="n">nos</span></div>


<div class="viewcode-block" id="topological_sort">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.topological_sort">[docs]</a>
<span class="k">def</span> <span class="nf">topological_sort</span><span class="p">(</span><span class="n">elems</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return a list of elements sorted so that their dependencies are listed</span>
<span class="sd">    before them in the result.</span>

<span class="sd">    :param elems: specifies the elements to sort with their dependencies; it is</span>
<span class="sd">        a dictionary like `{element: dependencies}` where `dependencies` is a</span>
<span class="sd">        collection of elements that must appear before `element`. The elements</span>
<span class="sd">        of `dependencies` are not required to appear in `elems`; they will</span>
<span class="sd">        simply not appear in the result.</span>

<span class="sd">    :returns: a list with the keys of `elems` sorted according to their</span>
<span class="sd">        specification.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># the algorithm is inspired by [Tarjan 1976],</span>
    <span class="c1"># http://en.wikipedia.org/wiki/Topological_sorting#Algorithms</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
            <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">:</span>
                <span class="c1"># first visit all dependencies of n, then append n to result</span>
                <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">[</span><span class="n">n</span><span class="p">]:</span>
                    <span class="n">visit</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">:</span>
        <span class="n">visit</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="merge_sequences">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.merge_sequences">[docs]</a>
<span class="k">def</span> <span class="nf">merge_sequences</span><span class="p">(</span><span class="o">*</span><span class="n">iterables</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Merge several iterables into a list. The result is the union of the</span>
<span class="sd">        iterables, ordered following the partial order given by the iterables,</span>
<span class="sd">        with a bias towards the end for the last iterable::</span>

<span class="sd">            seq = merge_sequences([&#39;A&#39;, &#39;B&#39;, &#39;C&#39;])</span>
<span class="sd">            assert seq == [&#39;A&#39;, &#39;B&#39;, &#39;C&#39;]</span>

<span class="sd">            seq = merge_sequences(</span>
<span class="sd">                [&#39;A&#39;, &#39;B&#39;, &#39;C&#39;],</span>
<span class="sd">                [&#39;Z&#39;],                  # &#39;Z&#39; can be anywhere</span>
<span class="sd">                [&#39;Y&#39;, &#39;C&#39;],             # &#39;Y&#39; must precede &#39;C&#39;;</span>
<span class="sd">                [&#39;A&#39;, &#39;X&#39;, &#39;Y&#39;],        # &#39;X&#39; must follow &#39;A&#39; and precede &#39;Y&#39;</span>
<span class="sd">            )</span>
<span class="sd">            assert seq == [&#39;A&#39;, &#39;B&#39;, &#39;X&#39;, &#39;Y&#39;, &#39;C&#39;, &#39;Z&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># we use an OrderedDict to keep elements in order by default</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>                <span class="c1"># {item: elems_before_item}</span>
    <span class="k">for</span> <span class="n">iterable</span> <span class="ow">in</span> <span class="n">iterables</span><span class="p">:</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="p">:</span>
                <span class="n">deps</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">deps</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="n">item</span>
    <span class="k">return</span> <span class="n">topological_sort</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span></div>



<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">xlwt</span>

    <span class="c1"># add some sanitization to respect the excel sheet name restrictions</span>
    <span class="c1"># as the sheet name is often translatable, can not control the input</span>
<div class="viewcode-block" id="PatchedWorkbook">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.PatchedWorkbook">[docs]</a>
    <span class="k">class</span> <span class="nc">PatchedWorkbook</span><span class="p">(</span><span class="n">xlwt</span><span class="o">.</span><span class="n">Workbook</span><span class="p">):</span>
<div class="viewcode-block" id="PatchedWorkbook.add_sheet">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.PatchedWorkbook.add_sheet">[docs]</a>
        <span class="k">def</span> <span class="nf">add_sheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">cell_overwrite_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="c1"># invalid Excel character: []:*?/\</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[\[\]:*?/</span><span class="se">\\</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

            <span class="c1"># maximum size is 31 characters</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="mi">31</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">PatchedWorkbook</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add_sheet</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cell_overwrite_ok</span><span class="o">=</span><span class="n">cell_overwrite_ok</span><span class="p">)</span></div>
</div>


    <span class="n">xlwt</span><span class="o">.</span><span class="n">Workbook</span> <span class="o">=</span> <span class="n">PatchedWorkbook</span>

<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">xlwt</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">xlsxwriter</span>

    <span class="c1"># add some sanitization to respect the excel sheet name restrictions</span>
    <span class="c1"># as the sheet name is often translatable, can not control the input</span>
<div class="viewcode-block" id="PatchedXlsxWorkbook">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.PatchedXlsxWorkbook">[docs]</a>
    <span class="k">class</span> <span class="nc">PatchedXlsxWorkbook</span><span class="p">(</span><span class="n">xlsxwriter</span><span class="o">.</span><span class="n">Workbook</span><span class="p">):</span>

        <span class="c1"># TODO when xlsxwriter bump to 0.9.8, add worksheet_class=None parameter instead of kw</span>
<div class="viewcode-block" id="PatchedXlsxWorkbook.add_worksheet">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.PatchedXlsxWorkbook.add_worksheet">[docs]</a>
        <span class="k">def</span> <span class="nf">add_worksheet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                <span class="c1"># invalid Excel character: []:*?/\</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[\[\]:*?/</span><span class="se">\\</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

                <span class="c1"># maximum size is 31 characters</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="mi">31</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">PatchedXlsxWorkbook</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>
</div>


    <span class="n">xlsxwriter</span><span class="o">.</span><span class="n">Workbook</span> <span class="o">=</span> <span class="n">PatchedXlsxWorkbook</span>

<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">xlsxwriter</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="to_xml">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.to_xml">[docs]</a>
<span class="k">def</span> <span class="nf">to_xml</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Since 16.0, use proper escaping methods (e.g. `markupsafe.escape`).&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">,</span><span class="s1">&#39;&amp;amp;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span><span class="s1">&#39;&amp;lt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&amp;gt;&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_iso_codes">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.get_iso_codes">[docs]</a>
<span class="k">def</span> <span class="nf">get_iso_codes</span><span class="p">(</span><span class="n">lang</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">lang</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lang</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">lang</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">lang</span> <span class="o">=</span> <span class="n">lang</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">lang</span></div>


<div class="viewcode-block" id="scan_languages">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.scan_languages">[docs]</a>
<span class="k">def</span> <span class="nf">scan_languages</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Returns all languages supported by OpenERP for translation</span>

<span class="sd">    :returns: a list of (lang_code, lang_name) pairs</span>
<span class="sd">    :rtype: [(str, unicode)]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># read (code, name) from languages in base/data/res.lang.csv</span>
        <span class="k">with</span> <span class="n">file_open</span><span class="p">(</span><span class="s1">&#39;base/data/res.lang.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">csv_reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
            <span class="n">code_index</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">)</span>
            <span class="n">name_index</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">code_index</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="n">name_index</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span>
            <span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not read res.lang.csv&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">result</span> <span class="ow">or</span> <span class="p">[(</span><span class="s1">&#39;en_US&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;English&#39;</span><span class="p">)],</span> <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span></div>


<div class="viewcode-block" id="mod10r">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.mod10r">[docs]</a>
<span class="k">def</span> <span class="nf">mod10r</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Input number : account or invoice number</span>
<span class="sd">    Output return: the same number completed with the recursive mod10</span>
<span class="sd">    key</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">codec</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">report</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">result</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">digit</span> <span class="ow">in</span> <span class="n">number</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="n">digit</span>
        <span class="k">if</span> <span class="n">digit</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">codec</span><span class="p">[</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">digit</span><span class="p">)</span> <span class="o">+</span> <span class="n">report</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span> <span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span> <span class="o">+</span> <span class="nb">str</span><span class="p">((</span><span class="mi">10</span> <span class="o">-</span> <span class="n">report</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span></div>


<div class="viewcode-block" id="str2bool">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.str2bool">[docs]</a>
<span class="k">def</span> <span class="nf">str2bool</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">ustr</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;y yes 1 true t on&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">n</span> <span class="o">=</span> <span class="s1">&#39;n no 0 false f off&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Use 0/1/yes/no/true/false/on/off&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">y</span></div>


<div class="viewcode-block" id="human_size">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.human_size">[docs]</a>
<span class="k">def</span> <span class="nf">human_size</span><span class="p">(</span><span class="n">sz</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the size in a human readable format</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sz</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">units</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;bytes&#39;</span><span class="p">,</span> <span class="s1">&#39;Kb&#39;</span><span class="p">,</span> <span class="s1">&#39;Mb&#39;</span><span class="p">,</span> <span class="s1">&#39;Gb&#39;</span><span class="p">,</span> <span class="s1">&#39;Tb&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">sz</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sz</span><span class="p">)</span>
    <span class="n">s</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sz</span><span class="p">),</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">s</span> <span class="o">&gt;=</span> <span class="mi">1024</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">units</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">/=</span> <span class="mi">1024</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%0.2f</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">units</span><span class="p">[</span><span class="n">i</span><span class="p">])</span></div>


<div class="viewcode-block" id="logged">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.logged">[docs]</a>
<span class="k">def</span> <span class="nf">logged</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Since 16.0, it&#39;s never been super useful.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>

        <span class="n">vector</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Call -&gt; function: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">vector</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  arg </span><span class="si">%02d</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">pformat</span><span class="p">(</span><span class="n">arg</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">vector</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  kwarg </span><span class="si">%10s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">pformat</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

        <span class="n">timeb4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">vector</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  result: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pformat</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
        <span class="n">vector</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  time delta: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">timeb4</span><span class="p">))</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vector</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">return</span> <span class="n">wrapper</span></div>


<div class="viewcode-block" id="profile">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.profile">[docs]</a>
<span class="k">class</span> <span class="nc">profile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Since 16.0.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">cProfile</span><span class="o">.</span><span class="n">Profile</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">runcall</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">profile</span><span class="o">.</span><span class="n">dump_stats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.cprof&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,)))</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">return</span> <span class="n">wrapper</span></div>


<div class="viewcode-block" id="detect_ip_addr">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.detect_ip_addr">[docs]</a>
<span class="k">def</span> <span class="nf">detect_ip_addr</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Try a very crude method to figure out a valid external</span>
<span class="sd">       IP or hostname for the current machine. Don&#39;t rely on this</span>
<span class="sd">       for binding to an interface, but it could be used as basis</span>
<span class="sd">       for constructing a remote URL to the server.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Since 16.0.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_detect_ip_addr</span><span class="p">():</span>
        <span class="kn">from</span> <span class="nn">array</span> <span class="kn">import</span> <span class="n">array</span>
        <span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span><span class="p">,</span> <span class="n">unpack</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">fcntl</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">fcntl</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">ip_addr</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fcntl</span><span class="p">:</span> <span class="c1"># not UNIX:</span>
            <span class="n">host</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
            <span class="n">ip_addr</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># UNIX:</span>
            <span class="c1"># get all interfaces:</span>
            <span class="n">nbytes</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">32</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="n">nbytes</span><span class="p">)</span>
            <span class="c1">#print &#39;names: &#39;, names</span>
            <span class="n">outbytes</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;iL&#39;</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">ioctl</span><span class="p">(</span> <span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mh">0x8912</span><span class="p">,</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;iL&#39;</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">names</span><span class="o">.</span><span class="n">buffer_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">])))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">namestr</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>

            <span class="c1"># try 64 bit kernel:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">outbytes</span><span class="p">,</span> <span class="mi">40</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">namestr</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">16</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;lo&#39;</span><span class="p">:</span>
                    <span class="n">ip_addr</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">namestr</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">20</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">24</span><span class="p">])</span>
                    <span class="k">break</span>

            <span class="c1"># try 32 bit kernel:</span>
            <span class="k">if</span> <span class="n">ip_addr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ifaces</span> <span class="o">=</span> <span class="p">[</span><span class="n">namestr</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">32</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">outbytes</span><span class="p">,</span> <span class="mi">32</span><span class="p">)]</span>

                <span class="k">for</span> <span class="n">ifname</span> <span class="ow">in</span> <span class="p">[</span><span class="n">iface</span> <span class="k">for</span> <span class="n">iface</span> <span class="ow">in</span> <span class="n">ifaces</span> <span class="k">if</span> <span class="n">iface</span> <span class="k">if</span> <span class="n">iface</span> <span class="o">!=</span> <span class="s1">&#39;lo&#39;</span><span class="p">]:</span>
                    <span class="n">ip_addr</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">fcntl</span><span class="o">.</span><span class="n">ioctl</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mh">0x8915</span><span class="p">,</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;256s&#39;</span><span class="p">,</span> <span class="n">ifname</span><span class="p">[:</span><span class="mi">15</span><span class="p">]))[</span><span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">])</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="n">ip_addr</span> <span class="ow">or</span> <span class="s1">&#39;localhost&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">ip_addr</span> <span class="o">=</span> <span class="n">_detect_ip_addr</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">ip_addr</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>
    <span class="k">return</span> <span class="n">ip_addr</span></div>


<span class="n">DEFAULT_SERVER_DATE_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span>
<span class="n">DEFAULT_SERVER_TIME_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;%H:%M:%S&quot;</span>
<span class="n">DEFAULT_SERVER_DATETIME_FORMAT</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
    <span class="n">DEFAULT_SERVER_DATE_FORMAT</span><span class="p">,</span>
    <span class="n">DEFAULT_SERVER_TIME_FORMAT</span><span class="p">)</span>

<span class="n">DATE_LENGTH</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">DEFAULT_SERVER_DATE_FORMAT</span><span class="p">))</span>

<span class="c1"># Python&#39;s strftime supports only the format directives</span>
<span class="c1"># that are available on the platform&#39;s libc, so in order to</span>
<span class="c1"># be cross-platform we map to the directives required by</span>
<span class="c1"># the C standard (1989 version), always available on platforms</span>
<span class="c1"># with a C standard implementation.</span>
<span class="n">DATETIME_FORMATS_MAP</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;%C&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1"># century</span>
        <span class="s1">&#39;%D&#39;</span><span class="p">:</span> <span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">,</span> <span class="c1"># modified %y-&gt;%Y</span>
        <span class="s1">&#39;</span><span class="si">%e</span><span class="s1">&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;</span><span class="si">%E</span><span class="s1">&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1"># special modifier</span>
        <span class="s1">&#39;</span><span class="si">%F</span><span class="s1">&#39;</span><span class="p">:</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span><span class="p">:</span> <span class="s1">&#39;%Y&#39;</span><span class="p">,</span> <span class="c1"># modified %y-&gt;%Y</span>
        <span class="s1">&#39;</span><span class="si">%G</span><span class="s1">&#39;</span><span class="p">:</span> <span class="s1">&#39;%Y&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%h&#39;</span><span class="p">:</span> <span class="s1">&#39;%b&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%k&#39;</span><span class="p">:</span> <span class="s1">&#39;%H&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%l&#39;</span><span class="p">:</span> <span class="s1">&#39;%I&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%n&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%O&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1"># special modifier</span>
        <span class="s1">&#39;%P&#39;</span><span class="p">:</span> <span class="s1">&#39;%p&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%R&#39;</span><span class="p">:</span> <span class="s1">&#39;%H:%M&#39;</span><span class="p">,</span>
        <span class="s1">&#39;</span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">:</span> <span class="s1">&#39;%I:%M:%S %p&#39;</span><span class="p">,</span>
        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1">#num of seconds since epoch</span>
        <span class="s1">&#39;%T&#39;</span><span class="p">:</span> <span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%t&#39;</span><span class="p">:</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="c1"># tab</span>
        <span class="s1">&#39;</span><span class="si">%u</span><span class="s1">&#39;</span><span class="p">:</span> <span class="s1">&#39; %w&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%V&#39;</span><span class="p">:</span> <span class="s1">&#39;%W&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%y&#39;</span><span class="p">:</span> <span class="s1">&#39;%Y&#39;</span><span class="p">,</span> <span class="c1"># Even if %y works, it&#39;s ambiguous, so we should use %Y</span>
        <span class="s1">&#39;%+&#39;</span><span class="p">:</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span>

        <span class="c1"># %Z is a special case that causes 2 problems at least:</span>
        <span class="c1">#  - the timezone names we use (in res_user.context_tz) come</span>
        <span class="c1">#    from pytz, but not all these names are recognized by</span>
        <span class="c1">#    strptime(), so we cannot convert in both directions</span>
        <span class="c1">#    when such a timezone is selected and %Z is in the format</span>
        <span class="c1">#  - %Z is replaced by an empty string in strftime() when</span>
        <span class="c1">#    there is not tzinfo in a datetime value (e.g when the user</span>
        <span class="c1">#    did not pick a context_tz). The resulting string does not</span>
        <span class="c1">#    parse back if the format requires %Z.</span>
        <span class="c1"># As a consequence, we strip it completely from format strings.</span>
        <span class="c1"># The user can always have a look at the context_tz in</span>
        <span class="c1"># preferences to check the timezone.</span>
        <span class="s1">&#39;%z&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;%Z&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">POSIX_TO_LDML</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span>
    <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="s1">&#39;EEEE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="s1">&#39;MMM&#39;</span><span class="p">,</span>
    <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="s1">&#39;MMMM&#39;</span><span class="p">,</span>
    <span class="c1">#&#39;c&#39;: &#39;&#39;,</span>
    <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="s1">&#39;dd&#39;</span><span class="p">,</span>
    <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="s1">&#39;HH&#39;</span><span class="p">,</span>
    <span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="s1">&#39;hh&#39;</span><span class="p">,</span>
    <span class="s1">&#39;j&#39;</span><span class="p">:</span> <span class="s1">&#39;DDD&#39;</span><span class="p">,</span>
    <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="s1">&#39;MM&#39;</span><span class="p">,</span>
    <span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="s1">&#39;mm&#39;</span><span class="p">,</span>
    <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span>
    <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="s1">&#39;ss&#39;</span><span class="p">,</span>
    <span class="s1">&#39;U&#39;</span><span class="p">:</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span>
    <span class="s1">&#39;w&#39;</span><span class="p">:</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span>
    <span class="s1">&#39;W&#39;</span><span class="p">:</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span>
    <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="s1">&#39;yy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="s1">&#39;yyyy&#39;</span><span class="p">,</span>
    <span class="c1"># see comments above, and babel&#39;s format_datetime assumes an UTC timezone</span>
    <span class="c1"># for naive datetime objects</span>
    <span class="c1">#&#39;z&#39;: &#39;Z&#39;,</span>
    <span class="c1">#&#39;Z&#39;: &#39;z&#39;,</span>
<span class="p">}</span>

<div class="viewcode-block" id="posix_to_ldml">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.posix_to_ldml">[docs]</a>
<span class="k">def</span> <span class="nf">posix_to_ldml</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">locale</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Converts a posix/strftime pattern into an LDML date format pattern.</span>

<span class="sd">    :param fmt: non-extended C89/C90 strftime pattern</span>
<span class="sd">    :param locale: babel locale used for locale-specific conversions (e.g. %x and %X)</span>
<span class="sd">    :return: unicode</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">quoted</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">fmt</span><span class="p">:</span>
        <span class="c1"># LDML date format patterns uses letters, so letters must be quoted</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pc</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span>
            <span class="n">quoted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="k">else</span> <span class="s2">&quot;&#39;&#39;&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">quoted</span><span class="p">:</span>
            <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
            <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">quoted</span><span class="p">))</span>
            <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
            <span class="n">quoted</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">pc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;%&#39;</span><span class="p">:</span> <span class="c1"># escaped percent</span>
                <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="c1"># date format, short seems to match</span>
                <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="n">date_formats</span><span class="p">[</span><span class="s1">&#39;short&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pattern</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="c1"># time format, seems to include seconds. short does not</span>
                <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="n">time_formats</span><span class="p">[</span><span class="s1">&#39;medium&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pattern</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># look up format char in static mapping</span>
                <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">POSIX_TO_LDML</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
            <span class="n">pc</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;%&#39;</span><span class="p">:</span>
            <span class="n">pc</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="c1"># flush anything remaining in quoted buffer</span>
    <span class="k">if</span> <span class="n">quoted</span><span class="p">:</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">quoted</span><span class="p">))</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span></div>


<div class="viewcode-block" id="split_every">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.split_every">[docs]</a>
<span class="k">def</span> <span class="nf">split_every</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">piece_maker</span><span class="o">=</span><span class="nb">tuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Splits an iterable into length-n pieces. The last piece will be shorter</span>
<span class="sd">       if ``n`` does not evenly divide the iterable length.</span>

<span class="sd">       :param int n: maximum size of each generated chunk</span>
<span class="sd">       :param Iterable iterable: iterable to chunk into pieces</span>
<span class="sd">       :param piece_maker: callable taking an iterable and collecting each</span>
<span class="sd">                           chunk from its slice, *must consume the entire slice*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
    <span class="n">piece</span> <span class="o">=</span> <span class="n">piece_maker</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
    <span class="k">while</span> <span class="n">piece</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">piece</span>
        <span class="n">piece</span> <span class="o">=</span> <span class="n">piece_maker</span><span class="p">(</span><span class="n">islice</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span></div>


<span class="c1"># port of python 2.6&#39;s attrgetter with support for dotted notation</span>
<span class="n">raise_error</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>  <span class="c1"># sentinel</span>
<div class="viewcode-block" id="resolve_attr">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.resolve_attr">[docs]</a>
<span class="k">def</span> <span class="nf">resolve_attr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">raise_error</span><span class="p">):</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="s2">&quot;Since 16.0, component of `attrgetter`.&quot;</span><span class="p">,</span>
        <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="n">raise_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">obj</span><span class="si">}</span><span class="s2">&#39; object has no attribute &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="o">==</span> <span class="n">default</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">obj</span></div>


<div class="viewcode-block" id="attrgetter">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.attrgetter">[docs]</a>
<span class="k">def</span> <span class="nf">attrgetter</span><span class="p">(</span><span class="o">*</span><span class="n">items</span><span class="p">):</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Since 16.0, super old backport of Python 2.6&#39;s `operator.attrgetter`.&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">resolve_attr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">resolve_attr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">items</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">g</span></div>


<div class="viewcode-block" id="discardattr">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.discardattr">[docs]</a>
<span class="k">def</span> <span class="nf">discardattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Perform a ``delattr(obj, key)`` but without crashing if ``key`` is not present. &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">delattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span></div>


<span class="c1"># ---------------------------------------------</span>
<span class="c1"># String management</span>
<span class="c1"># ---------------------------------------------</span>

<span class="c1"># Inspired by http://stackoverflow.com/questions/517923</span>
<div class="viewcode-block" id="remove_accents">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.remove_accents">[docs]</a>
<span class="k">def</span> <span class="nf">remove_accents</span><span class="p">(</span><span class="n">input_str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Suboptimal-but-better-than-nothing way to replace accented</span>
<span class="sd">    latin letters by an ASCII equivalent. Will obviously change the</span>
<span class="sd">    meaning of input_str and work only for some cases&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">input_str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">input_str</span>
    <span class="n">input_str</span> <span class="o">=</span> <span class="n">ustr</span><span class="p">(</span><span class="n">input_str</span><span class="p">)</span>
    <span class="n">nkfd_form</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s1">&#39;NFKD&#39;</span><span class="p">,</span> <span class="n">input_str</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">nkfd_form</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">combining</span><span class="p">(</span><span class="n">c</span><span class="p">)])</span></div>


<div class="viewcode-block" id="unquote">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.unquote">[docs]</a>
<span class="k">class</span> <span class="nc">unquote</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A subclass of str that implements repr() without enclosing quotation marks</span>
<span class="sd">       or escaping, keeping the original string untouched. The name come from Lisp&#39;s unquote.</span>
<span class="sd">       One of the uses for this is to preserve or insert bare variable names within dicts during eval()</span>
<span class="sd">       of a dict&#39;s repr(). Use with care.</span>

<span class="sd">       Some examples (notice that there are never quotes surrounding</span>
<span class="sd">       the ``active_id`` name:</span>

<span class="sd">       &gt;&gt;&gt; unquote(&#39;active_id&#39;)</span>
<span class="sd">       active_id</span>
<span class="sd">       &gt;&gt;&gt; d = {&#39;test&#39;: unquote(&#39;active_id&#39;)}</span>
<span class="sd">       &gt;&gt;&gt; d</span>
<span class="sd">       {&#39;test&#39;: active_id}</span>
<span class="sd">       &gt;&gt;&gt; print d</span>
<span class="sd">       {&#39;test&#39;: active_id}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span></div>



<div class="viewcode-block" id="mute_logger">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.mute_logger">[docs]</a>
<span class="k">class</span> <span class="nc">mute_logger</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Temporary suppress the logging.</span>

<span class="sd">    Can be used as context manager or decorator::</span>

<span class="sd">        @mute_logger(&#39;odoo.plic.ploc&#39;)</span>
<span class="sd">        def do_stuff():</span>
<span class="sd">            blahblah()</span>

<span class="sd">        with mute_logger(&#39;odoo.foo.bar&#39;):</span>
<span class="sd">            do_suff()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">loggers</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loggers</span> <span class="o">=</span> <span class="n">loggers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">logger_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">logger_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_params</span><span class="p">[</span><span class="n">logger_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">,</span> <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exc_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exc_tb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">logger_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loggers</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">logger_name</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">,</span> <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_params</span><span class="p">[</span><span class="n">logger_name</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">deco</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">deco</span>

<div class="viewcode-block" id="mute_logger.emit">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.mute_logger.emit">[docs]</a>
    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="k">pass</span></div>
</div>



<div class="viewcode-block" id="lower_logging">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.lower_logging">[docs]</a>
<span class="k">class</span> <span class="nc">lower_logging</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Temporary lower the max logging level.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_level</span><span class="p">,</span> <span class="n">to_level</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_handlers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_propagate</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">had_error_log</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_level</span> <span class="o">=</span> <span class="n">max_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_level</span> <span class="o">=</span> <span class="n">to_level</span> <span class="ow">or</span> <span class="n">max_level</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_handlers</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_propagate</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">had_error_log</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exc_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exc_tb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_handlers</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_propagate</span>

<div class="viewcode-block" id="lower_logging.emit">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.lower_logging.emit">[docs]</a>
    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">levelno</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_level</span><span class="p">:</span>
            <span class="n">record</span><span class="o">.</span><span class="n">levelname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">record</span><span class="o">.</span><span class="n">levelname</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">record</span><span class="o">.</span><span class="n">levelno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_level</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">had_error_log</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">record</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Traceback (most recent call last):&#39;</span><span class="p">,</span> <span class="s1">&#39;_Traceback_ (most recent call last):&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">levelno</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_handlers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">level</span> <span class="o">&lt;=</span> <span class="n">record</span><span class="o">.</span><span class="n">levelno</span><span class="p">:</span>
                    <span class="n">handler</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">record</span><span class="p">)</span></div>
</div>



<span class="n">_ph</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
<div class="viewcode-block" id="CountingStream">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.CountingStream">[docs]</a>
<span class="k">class</span> <span class="nc">CountingStream</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Stream wrapper counting the number of element it has yielded. Similar</span>
<span class="sd">    role to ``enumerate``, but for use when the iteration process of the stream</span>
<span class="sd">    isn&#39;t fully under caller control (the stream can be iterated from multiple</span>
<span class="sd">    points including within a library)</span>

<span class="sd">    ``start`` allows overriding the starting index (the index before the first</span>
<span class="sd">    item is returned).</span>

<span class="sd">    On each iteration (call to :meth:`~.next`), increases its :attr:`~.index`</span>
<span class="sd">    by one.</span>

<span class="sd">    .. attribute:: index</span>

<span class="sd">        ``int``, index of the last yielded element in the stream. If the stream</span>
<span class="sd">        has ended, will give an index 1-past the stream</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">start</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
<div class="viewcode-block" id="CountingStream.next">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.CountingStream.next">[docs]</a>
    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">,</span> <span class="n">_ph</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="n">_ph</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">val</span></div>

    <span class="fm">__next__</span> <span class="o">=</span> <span class="nb">next</span></div>


<div class="viewcode-block" id="stripped_sys_argv">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.stripped_sys_argv">[docs]</a>
<span class="k">def</span> <span class="nf">stripped_sys_argv</span><span class="p">(</span><span class="o">*</span><span class="n">strip_args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return sys.argv with some arguments stripped, suitable for reexecution or subprocesses&quot;&quot;&quot;</span>
    <span class="n">strip_args</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">strip_args</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--save&#39;</span><span class="p">,</span> <span class="s1">&#39;-u&#39;</span><span class="p">,</span> <span class="s1">&#39;--update&#39;</span><span class="p">,</span> <span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--init&#39;</span><span class="p">,</span> <span class="s1">&#39;--i18n-overwrite&#39;</span><span class="p">]))</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">strip_args</span><span class="p">)</span>
    <span class="n">takes_value</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">takes_value</span><span class="p">())</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">strip_args</span><span class="p">)</span>

    <span class="n">longs</span><span class="p">,</span> <span class="n">shorts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">itergroupby</span><span class="p">(</span><span class="n">strip_args</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;--&#39;</span><span class="p">)))</span>
    <span class="n">longs_eq</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">longs</span> <span class="k">if</span> <span class="n">takes_value</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[:]</span>

    <span class="k">def</span> <span class="nf">strip</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">shorts</span><span class="p">)</span> \
            <span class="ow">or</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">longs_eq</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">longs</span><span class="p">)</span> \
            <span class="ow">or</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">strip_args</span><span class="p">)</span> <span class="ow">and</span> <span class="n">takes_value</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]])</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">strip</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span></div>


<div class="viewcode-block" id="ConstantMapping">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.ConstantMapping">[docs]</a>
<span class="k">class</span> <span class="nc">ConstantMapping</span><span class="p">(</span><span class="n">Mapping</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An immutable mapping returning the provided value for every single key.</span>

<span class="sd">    Useful for default value to methods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_value&#39;</span><span class="p">]</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        defaultdict updates its length for each individually requested key, is</span>
<span class="sd">        that really useful?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        same as len, defaultdict updates its iterable keyset with each key</span>
<span class="sd">        requested, is there a point for this?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">([])</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span></div>



<div class="viewcode-block" id="dumpstacks">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.dumpstacks">[docs]</a>
<span class="k">def</span> <span class="nf">dumpstacks</span><span class="p">(</span><span class="n">sig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thread_idents</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Signal handler: dump a stack trace for each existing thread or given</span>
<span class="sd">    thread(s) specified through the ``thread_idents`` sequence.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">extract_stack</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">traceback</span><span class="o">.</span><span class="n">extract_stack</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>
            <span class="k">yield</span> <span class="s1">&#39;File: &quot;</span><span class="si">%s</span><span class="s1">&quot;, line </span><span class="si">%d</span><span class="s1">, in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">yield</span> <span class="s2">&quot;  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(),)</span>

    <span class="c1"># code from http://stackoverflow.com/questions/132058/getting-stack-trace-from-a-running-python-application#answer-2569696</span>
    <span class="c1"># modified for python 2.5 compatibility</span>
    <span class="n">threads_info</span> <span class="o">=</span> <span class="p">{</span><span class="n">th</span><span class="o">.</span><span class="n">ident</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;repr&#39;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="n">th</span><span class="p">),</span>
                               <span class="s1">&#39;uid&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="s1">&#39;uid&#39;</span><span class="p">,</span> <span class="s1">&#39;n/a&#39;</span><span class="p">),</span>
                               <span class="s1">&#39;dbname&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="s1">&#39;dbname&#39;</span><span class="p">,</span> <span class="s1">&#39;n/a&#39;</span><span class="p">),</span>
                               <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;n/a&#39;</span><span class="p">),</span>
                               <span class="s1">&#39;query_count&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="s1">&#39;query_count&#39;</span><span class="p">,</span> <span class="s1">&#39;n/a&#39;</span><span class="p">),</span>
                               <span class="s1">&#39;query_time&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="s1">&#39;query_time&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                               <span class="s1">&#39;perf_t0&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="s1">&#39;perf_t0&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)}</span>
                    <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">threading</span><span class="o">.</span><span class="n">enumerate</span><span class="p">()}</span>
    <span class="k">for</span> <span class="n">threadId</span><span class="p">,</span> <span class="n">stack</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">_current_frames</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">thread_idents</span> <span class="ow">or</span> <span class="n">threadId</span> <span class="ow">in</span> <span class="n">thread_idents</span><span class="p">:</span>
            <span class="n">thread_info</span> <span class="o">=</span> <span class="n">threads_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">threadId</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">query_time</span> <span class="o">=</span> <span class="n">thread_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;query_time&#39;</span><span class="p">)</span>
            <span class="n">perf_t0</span> <span class="o">=</span> <span class="n">thread_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;perf_t0&#39;</span><span class="p">)</span>
            <span class="n">remaining_time</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">query_time</span> <span class="ow">and</span> <span class="n">perf_t0</span><span class="p">:</span>
                <span class="n">remaining_time</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">perf_t0</span> <span class="o">-</span> <span class="n">query_time</span><span class="p">)</span>
                <span class="n">query_time</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">query_time</span>
            <span class="c1"># qc:query_count qt:query_time pt:python_time (aka remaining time)</span>
            <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"># Thread: </span><span class="si">%s</span><span class="s2"> (db:</span><span class="si">%s</span><span class="s2">) (uid:</span><span class="si">%s</span><span class="s2">) (url:</span><span class="si">%s</span><span class="s2">) (qc:</span><span class="si">%s</span><span class="s2"> qt:</span><span class="si">%s</span><span class="s2"> pt:</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">thread_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;repr&#39;</span><span class="p">,</span> <span class="n">threadId</span><span class="p">),</span>
                         <span class="n">thread_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dbname&#39;</span><span class="p">,</span> <span class="s1">&#39;n/a&#39;</span><span class="p">),</span>
                         <span class="n">thread_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uid&#39;</span><span class="p">,</span> <span class="s1">&#39;n/a&#39;</span><span class="p">),</span>
                         <span class="n">thread_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;n/a&#39;</span><span class="p">),</span>
                         <span class="n">thread_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;query_count&#39;</span><span class="p">,</span> <span class="s1">&#39;n/a&#39;</span><span class="p">),</span>
                         <span class="n">query_time</span> <span class="ow">or</span> <span class="s1">&#39;n/a&#39;</span><span class="p">,</span>
                         <span class="n">remaining_time</span> <span class="ow">or</span> <span class="s1">&#39;n/a&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">extract_stack</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">odoo</span><span class="o">.</span><span class="n">evented</span><span class="p">:</span>
        <span class="c1"># code from http://stackoverflow.com/questions/12510648/in-gevent-how-can-i-dump-stack-traces-of-all-running-greenlets</span>
        <span class="kn">import</span> <span class="nn">gc</span>
        <span class="kn">from</span> <span class="nn">greenlet</span> <span class="kn">import</span> <span class="n">greenlet</span>
        <span class="k">for</span> <span class="n">ob</span> <span class="ow">in</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_objects</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ob</span><span class="p">,</span> <span class="n">greenlet</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">ob</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"># Greenlet: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ob</span><span class="p">,))</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">extract_stack</span><span class="p">(</span><span class="n">ob</span><span class="o">.</span><span class="n">gr_frame</span><span class="p">):</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code</span><span class="p">))</span></div>


<div class="viewcode-block" id="freehash">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.freehash">[docs]</a>
<span class="k">def</span> <span class="nf">freehash</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="n">frozendict</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">freehash</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span></div>


<div class="viewcode-block" id="clean_context">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.clean_context">[docs]</a>
<span class="k">def</span> <span class="nf">clean_context</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; This function take a dictionary and remove each entry with its key</span>
<span class="sd">    starting with ``default_``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;default_&#39;</span><span class="p">)}</span></div>



<div class="viewcode-block" id="frozendict">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.frozendict">[docs]</a>
<span class="k">class</span> <span class="nc">frozendict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; An implementation of an immutable dictionary. &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;&#39;__delitem__&#39; not supported on frozendict&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;&#39;__setitem__&#39; not supported on frozendict&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="frozendict.clear">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.frozendict.clear">[docs]</a>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;&#39;clear&#39; not supported on frozendict&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="frozendict.pop">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.frozendict.pop">[docs]</a>
    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;&#39;pop&#39; not supported on frozendict&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="frozendict.popitem">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.frozendict.popitem">[docs]</a>
    <span class="k">def</span> <span class="nf">popitem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;&#39;popitem&#39; not supported on frozendict&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="frozendict.setdefault">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.frozendict.setdefault">[docs]</a>
    <span class="k">def</span> <span class="nf">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;&#39;setdefault&#39; not supported on frozendict&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="frozendict.update">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.frozendict.update">[docs]</a>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;&#39;update&#39; not supported on frozendict&quot;</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">frozenset</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">freehash</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span></div>



<div class="viewcode-block" id="Collector">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.Collector">[docs]</a>
<span class="k">class</span> <span class="nc">Collector</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; A mapping from keys to tuples.  This implements a relation, and can be</span>
<span class="sd">        seen as a space optimization for ``defaultdict(tuple)``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">())</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="Collector.add">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.Collector.add">[docs]</a>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span> <span class="o">+</span> <span class="p">(</span><span class="n">val</span><span class="p">,)</span></div>


<div class="viewcode-block" id="Collector.discard_keys_and_values">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.Collector.discard_keys_and_values">[docs]</a>
    <span class="k">def</span> <span class="nf">discard_keys_and_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">excludes</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">excludes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">vals</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excludes</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="StackMap">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.StackMap">[docs]</a>
<span class="k">class</span> <span class="nc">StackMap</span><span class="p">(</span><span class="n">MutableMapping</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; A stack of mappings behaving as a single mapping, and used to implement</span>
<span class="sd">        nested scopes. The lookups search the stack from top to bottom, and</span>
<span class="sd">        returns the first value found. Mutable operations modify the topmost</span>
<span class="sd">        mapping only.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_maps&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maps</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">m</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_maps</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">mapping</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">({</span><span class="n">key</span> <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maps</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">})</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">u</span><span class="s2">&quot;&lt;StackMap </span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maps</span>

<div class="viewcode-block" id="StackMap.pushmap">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.StackMap.pushmap">[docs]</a>
    <span class="k">def</span> <span class="nf">pushmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maps</span><span class="o">.</span><span class="n">append</span><span class="p">({}</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">m</span><span class="p">)</span></div>


<div class="viewcode-block" id="StackMap.popmap">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.StackMap.popmap">[docs]</a>
    <span class="k">def</span> <span class="nf">popmap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maps</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="OrderedSet">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.OrderedSet">[docs]</a>
<span class="k">class</span> <span class="nc">OrderedSet</span><span class="p">(</span><span class="n">MutableSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; A set collection that remembers the elements first insertion order. &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_map&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elems</span><span class="o">=</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_map</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_map</span><span class="p">)</span>

<div class="viewcode-block" id="OrderedSet.add">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.OrderedSet.add">[docs]</a>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_map</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="OrderedSet.discard">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.OrderedSet.discard">[docs]</a>
    <span class="k">def</span> <span class="nf">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_map</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="OrderedSet.update">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.OrderedSet.update">[docs]</a>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elems</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_map</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">elems</span><span class="p">,</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">None</span><span class="p">)))</span></div>


<div class="viewcode-block" id="OrderedSet.difference_update">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.OrderedSet.difference_update">[docs]</a>
    <span class="k">def</span> <span class="nf">difference_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elems</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">elems</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">!r}</span><span class="s1">)&#39;</span></div>



<div class="viewcode-block" id="LastOrderedSet">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.LastOrderedSet">[docs]</a>
<span class="k">class</span> <span class="nc">LastOrderedSet</span><span class="p">(</span><span class="n">OrderedSet</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; A set collection that remembers the elements last insertion order. &quot;&quot;&quot;</span>
<div class="viewcode-block" id="LastOrderedSet.add">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.LastOrderedSet.add">[docs]</a>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem</span><span class="p">):</span>
        <span class="n">OrderedSet</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span>
        <span class="n">OrderedSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Callbacks">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.Callbacks">[docs]</a>
<span class="k">class</span> <span class="nc">Callbacks</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; A simple queue of callback functions.  Upon run, every function is</span>
<span class="sd">    called (in addition order), and the queue is emptied.</span>

<span class="sd">    ::</span>

<span class="sd">        callbacks = Callbacks()</span>

<span class="sd">        # add foo</span>
<span class="sd">        def foo():</span>
<span class="sd">            print(&quot;foo&quot;)</span>

<span class="sd">        callbacks.add(foo)</span>

<span class="sd">        # add bar</span>
<span class="sd">        callbacks.add</span>
<span class="sd">        def bar():</span>
<span class="sd">            print(&quot;bar&quot;)</span>

<span class="sd">        # add foo again</span>
<span class="sd">        callbacks.add(foo)</span>

<span class="sd">        # call foo(), bar(), foo(), then clear the callback queue</span>
<span class="sd">        callbacks.run()</span>

<span class="sd">    The queue also provides a ``data`` dictionary, that may be freely used to</span>
<span class="sd">    store anything, but is mostly aimed at aggregating data for callbacks.  The</span>
<span class="sd">    dictionary is automatically cleared by ``run()`` once all callback functions</span>
<span class="sd">    have been called.</span>

<span class="sd">    ::</span>

<span class="sd">        # register foo to process aggregated data</span>
<span class="sd">        @callbacks.add</span>
<span class="sd">        def foo():</span>
<span class="sd">            print(sum(callbacks.data[&#39;foo&#39;]))</span>

<span class="sd">        callbacks.data.setdefault(&#39;foo&#39;, []).append(1)</span>
<span class="sd">        ...</span>
<span class="sd">        callbacks.data.setdefault(&#39;foo&#39;, []).append(2)</span>
<span class="sd">        ...</span>
<span class="sd">        callbacks.data.setdefault(&#39;foo&#39;, []).append(3)</span>

<span class="sd">        # call foo(), which prints 6</span>
<span class="sd">        callbacks.run()</span>

<span class="sd">    Given the global nature of ``data``, the keys should identify in a unique</span>
<span class="sd">    way the data being stored.  It is recommended to use strings with a</span>
<span class="sd">    structure like ``&quot;{module}.{feature}&quot;``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_funcs&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="Callbacks.add">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.Callbacks.add">[docs]</a>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Add the given function. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span></div>


<div class="viewcode-block" id="Callbacks.run">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.Callbacks.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Call all the functions (in addition order), then clear associated data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="n">func</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>


<div class="viewcode-block" id="Callbacks.clear">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.Callbacks.clear">[docs]</a>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Remove all callbacks and data from self. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_funcs</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="ReversedIterable">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.ReversedIterable">[docs]</a>
<span class="k">class</span> <span class="nc">ReversedIterable</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; An iterable implementing the reversal of another iterable. &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;iterable&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterable</span> <span class="o">=</span> <span class="n">iterable</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterable</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__reversed__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterable</span><span class="p">)</span></div>



<div class="viewcode-block" id="groupby">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.groupby">[docs]</a>
<span class="k">def</span> <span class="nf">groupby</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return a collection of pairs ``(key, elements)`` from ``iterable``. The</span>
<span class="sd">        ``key`` is a function computing a key value for each element. This</span>
<span class="sd">        function is similar to ``itertools.groupby``, but aggregates all</span>
<span class="sd">        elements under the same key, not only consecutive elements.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">arg</span><span class="p">:</span> <span class="n">arg</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
        <span class="n">groups</span><span class="p">[</span><span class="n">key</span><span class="p">(</span><span class="n">elem</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">()</span></div>


<div class="viewcode-block" id="unique">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.unique">[docs]</a>
<span class="k">def</span> <span class="nf">unique</span><span class="p">(</span><span class="n">it</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; &quot;Uniquifier&quot; for the provided iterable: will output each element of</span>
<span class="sd">    the iterable once.</span>

<span class="sd">    The iterable&#39;s elements must be hashahble.</span>

<span class="sd">    :param Iterable it:</span>
<span class="sd">    :rtype: Iterator</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">e</span></div>


<div class="viewcode-block" id="submap">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.submap">[docs]</a>
<span class="k">def</span> <span class="nf">submap</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a filtered copy of the mapping where only some keys are present.</span>

<span class="sd">    :param Mapping mapping: the original dict-like structure to filter</span>
<span class="sd">    :param Iterable keys: the list of keys to keep</span>
<span class="sd">    :return dict: a filtered dict copy of the original mapping</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mapping</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span></div>


<div class="viewcode-block" id="Reverse">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.Reverse">[docs]</a>
<span class="k">class</span> <span class="nc">Reverse</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Wraps a value and reverses its ordering, useful in key functions when</span>
<span class="sd">    mixing ascending and descending sort on non-numeric data as the</span>
<span class="sd">    ``reverse`` parameter can not do piecemeal reordering.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">val</span>
    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">val</span>

    <span class="k">def</span> <span class="fm">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">&lt;=</span> <span class="n">other</span><span class="o">.</span><span class="n">val</span>
    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">val</span>
    <span class="k">def</span> <span class="fm">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">other</span><span class="o">.</span><span class="n">val</span>
    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">val</span></div>


<div class="viewcode-block" id="ignore">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.ignore">[docs]</a>
<span class="k">def</span> <span class="nf">ignore</span><span class="p">(</span><span class="o">*</span><span class="n">exc</span><span class="p">):</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Since 16.0 `odoo.tools.ignore` is replaced by `contextlib.suppress`.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="o">*</span><span class="n">exc</span><span class="p">)</span></div>


<div class="viewcode-block" id="replace_exceptions">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.replace_exceptions">[docs]</a>
<span class="k">class</span> <span class="nc">replace_exceptions</span><span class="p">(</span><span class="n">ContextDecorator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hide some exceptions behind another error. Can be used as a function</span>
<span class="sd">    decorator or as a context manager.</span>

<span class="sd">    .. code-block:</span>

<span class="sd">        @route(&#39;/super/secret/route&#39;, auth=&#39;public&#39;)</span>
<span class="sd">        @replace_exceptions(AccessError, by=NotFound())</span>
<span class="sd">        def super_secret_route(self):</span>
<span class="sd">            if not request.session.uid:</span>
<span class="sd">                raise AccessError(&quot;Route hidden to non logged-in users&quot;)</span>
<span class="sd">            ...</span>

<span class="sd">        def some_util():</span>
<span class="sd">            ...</span>
<span class="sd">            with replace_exceptions(ValueError, by=UserError(&quot;Invalid argument&quot;)):</span>
<span class="sd">                ...</span>
<span class="sd">            ...</span>

<span class="sd">    :param exceptions: the exception classes to catch and replace.</span>
<span class="sd">    :param by: the exception to raise instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">exceptions</span><span class="p">,</span> <span class="n">by</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exceptions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing exceptions&quot;</span><span class="p">)</span>

        <span class="n">wrong_exc</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">exc</span> <span class="k">for</span> <span class="n">exc</span> <span class="ow">in</span> <span class="n">exceptions</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wrong_exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">wrong_exc</span><span class="si">}</span><span class="s2"> is not an exception class.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exceptions</span> <span class="o">=</span> <span class="n">exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">by</span> <span class="o">=</span> <span class="n">by</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exceptions</span><span class="p">):</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">by</span> <span class="kn">from</span> <span class="nn">exc_value</span></div>


<span class="n">html_escape</span> <span class="o">=</span> <span class="n">markupsafe</span><span class="o">.</span><span class="n">escape</span>

<div class="viewcode-block" id="get_lang">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.get_lang">[docs]</a>
<span class="k">def</span> <span class="nf">get_lang</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">lang_code</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve the first lang object installed, by checking the parameter lang_code,</span>
<span class="sd">    the context and then the company. If no lang is installed from those variables,</span>
<span class="sd">    fallback on english or on the first lang installed in the system.</span>

<span class="sd">    :param env:</span>
<span class="sd">    :param str lang_code: the locale (i.e. en_US)</span>
<span class="sd">    :return res.lang: the first lang found that is installed on the system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">langs</span> <span class="o">=</span> <span class="p">[</span><span class="n">code</span> <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.lang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_installed</span><span class="p">()]</span>
    <span class="n">lang</span> <span class="o">=</span> <span class="s1">&#39;en_US&#39;</span> <span class="k">if</span> <span class="s1">&#39;en_US&#39;</span> <span class="ow">in</span> <span class="n">langs</span> <span class="k">else</span> <span class="n">langs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">lang_code</span> <span class="ow">and</span> <span class="n">lang_code</span> <span class="ow">in</span> <span class="n">langs</span><span class="p">:</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="n">lang_code</span>
    <span class="k">elif</span> <span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">langs</span><span class="p">:</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">company_id</span><span class="o">.</span><span class="n">partner_id</span><span class="o">.</span><span class="n">lang</span> <span class="ow">in</span> <span class="n">langs</span><span class="p">:</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">company_id</span><span class="o">.</span><span class="n">partner_id</span><span class="o">.</span><span class="n">lang</span>
    <span class="k">return</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.lang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_lang_get</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span></div>


<div class="viewcode-block" id="babel_locale_parse">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.babel_locale_parse">[docs]</a>
<span class="k">def</span> <span class="nf">babel_locale_parse</span><span class="p">(</span><span class="n">lang_code</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">babel</span><span class="o">.</span><span class="n">Locale</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">lang_code</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">babel</span><span class="o">.</span><span class="n">Locale</span><span class="o">.</span><span class="n">default</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">babel</span><span class="o">.</span><span class="n">Locale</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;en_US&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="formatLang">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.formatLang">[docs]</a>
<span class="k">def</span> <span class="nf">formatLang</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">grouping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">monetary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">currency_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rounding_method</span><span class="o">=</span><span class="s1">&#39;HALF-EVEN&#39;</span><span class="p">,</span> <span class="n">rounding_unit</span><span class="o">=</span><span class="s1">&#39;decimals&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function will format a number `value` to the appropriate format of the language used.</span>

<span class="sd">    :param Object env: The environment.</span>
<span class="sd">    :param float value: The value to be formatted.</span>
<span class="sd">    :param int digits: The number of decimals digits.</span>
<span class="sd">    :param bool grouping: Usage of language grouping or not.</span>
<span class="sd">    :param bool monetary: Usage of thousands separator or not.</span>
<span class="sd">        .. deprecated:: 13.0</span>
<span class="sd">    :param str dp: Name of the decimals precision to be used. This will override ``digits``</span>
<span class="sd">                   and ``currency_obj`` precision.</span>
<span class="sd">    :param Object currency_obj: Currency to be used. This will override ``digits`` precision.</span>
<span class="sd">    :param str rounding_method: The rounding method to be used:</span>
<span class="sd">        **&#39;HALF-UP&#39;** will round to the closest number with ties going away from zero,</span>
<span class="sd">        **&#39;HALF-DOWN&#39;** will round to the closest number with ties going towards zero,</span>
<span class="sd">        **&#39;HALF_EVEN&#39;** will round to the closest number with ties going to the closest</span>
<span class="sd">        even number,</span>
<span class="sd">        **&#39;UP&#39;** will always round away from 0,</span>
<span class="sd">        **&#39;DOWN&#39;** will always round towards 0.</span>
<span class="sd">    :param str rounding_unit: The rounding unit to be used:</span>
<span class="sd">        **decimals** will round to decimals with ``digits`` or ``dp`` precision,</span>
<span class="sd">        **units** will round to units without any decimals,</span>
<span class="sd">        **thousands** will round to thousands without any decimals,</span>
<span class="sd">        **lakhs** will round to lakhs without any decimals,</span>
<span class="sd">        **millions** will round to millions without any decimals.</span>

<span class="sd">    :returns: The value formatted.</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># We don&#39;t want to return 0</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="n">rounding_unit</span> <span class="o">==</span> <span class="s1">&#39;decimals&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dp</span><span class="p">:</span>
            <span class="n">digits</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;decimal.precision&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">precision_get</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">currency_obj</span><span class="p">:</span>
            <span class="n">digits</span> <span class="o">=</span> <span class="n">currency_obj</span><span class="o">.</span><span class="n">decimal_places</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">digits</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">rounding_unit_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;decimals&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;thousands&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
        <span class="s1">&#39;lakhs&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="o">**</span><span class="mi">5</span><span class="p">,</span>
        <span class="s1">&#39;millions&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">value</span> <span class="o">/=</span> <span class="n">rounding_unit_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rounding_unit</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">rounded_value</span> <span class="o">=</span> <span class="n">float_round</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">precision_digits</span><span class="o">=</span><span class="n">digits</span><span class="p">,</span> <span class="n">rounding_method</span><span class="o">=</span><span class="n">rounding_method</span><span class="p">)</span>
    <span class="n">formatted_value</span> <span class="o">=</span> <span class="n">get_lang</span><span class="p">(</span><span class="n">env</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;%.</span><span class="si">{</span><span class="n">digits</span><span class="si">}</span><span class="s1">f&#39;</span><span class="p">,</span> <span class="n">rounded_value</span><span class="p">,</span> <span class="n">grouping</span><span class="o">=</span><span class="n">grouping</span><span class="p">,</span> <span class="n">monetary</span><span class="o">=</span><span class="n">monetary</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">currency_obj</span> <span class="ow">and</span> <span class="n">currency_obj</span><span class="o">.</span><span class="n">symbol</span><span class="p">:</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="p">(</span><span class="n">formatted_value</span><span class="p">,</span> <span class="n">NON_BREAKING_SPACE</span><span class="p">,</span> <span class="n">currency_obj</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>

        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">arguments</span> <span class="k">if</span> <span class="n">currency_obj</span><span class="o">.</span><span class="n">position</span> <span class="o">==</span> <span class="s1">&#39;after&#39;</span> <span class="k">else</span> <span class="n">arguments</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">formatted_value</span></div>



<div class="viewcode-block" id="format_date">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.format_date">[docs]</a>
<span class="k">def</span> <span class="nf">format_date</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">lang_code</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">date_format</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Formats the date in a given format.</span>

<span class="sd">        :param env: an environment.</span>
<span class="sd">        :param date, datetime or string value: the date to format.</span>
<span class="sd">        :param string lang_code: the lang code, if not specified it is extracted from the</span>
<span class="sd">            environment context.</span>
<span class="sd">        :param string date_format: the format or the date (LDML format), if not specified the</span>
<span class="sd">            default format of the lang.</span>
<span class="sd">        :return: date formatted in the specified format.</span>
<span class="sd">        :rtype: string</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">DATE_LENGTH</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">DATE_LENGTH</span><span class="p">:</span>
            <span class="c1"># a datetime, convert to correct timezone</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Datetime</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Datetime</span><span class="o">.</span><span class="n">context_timestamp</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.lang&#39;</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Datetime</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">:</span>
        <span class="c1"># a datetime, convert to correct timezone</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Datetime</span><span class="o">.</span><span class="n">context_timestamp</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.lang&#39;</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>

    <span class="n">lang</span> <span class="o">=</span> <span class="n">get_lang</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">lang_code</span><span class="p">)</span>
    <span class="n">locale</span> <span class="o">=</span> <span class="n">babel_locale_parse</span><span class="p">(</span><span class="n">lang</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">date_format</span><span class="p">:</span>
        <span class="n">date_format</span> <span class="o">=</span> <span class="n">posix_to_ldml</span><span class="p">(</span><span class="n">lang</span><span class="o">.</span><span class="n">date_format</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">locale</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">babel</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">format_date</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">date_format</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">locale</span><span class="p">)</span></div>


<div class="viewcode-block" id="parse_date">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.parse_date">[docs]</a>
<span class="k">def</span> <span class="nf">parse_date</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">lang_code</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Parse the date from a given format. If it is not a valid format for the</span>
<span class="sd">        localization, return the original string.</span>

<span class="sd">        :param env: an environment.</span>
<span class="sd">        :param string value: the date to parse.</span>
<span class="sd">        :param string lang_code: the lang code, if not specified it is extracted from the</span>
<span class="sd">            environment context.</span>
<span class="sd">        :return: date object from the localized string</span>
<span class="sd">        :rtype: datetime.date</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">lang</span> <span class="o">=</span> <span class="n">get_lang</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">lang_code</span><span class="p">)</span>
    <span class="n">locale</span> <span class="o">=</span> <span class="n">babel_locale_parse</span><span class="p">(</span><span class="n">lang</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">babel</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">parse_date</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">locale</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">value</span></div>



<div class="viewcode-block" id="format_datetime">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.format_datetime">[docs]</a>
<span class="k">def</span> <span class="nf">format_datetime</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dt_format</span><span class="o">=</span><span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="n">lang_code</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Formats the datetime in a given format.</span>

<span class="sd">    :param env:</span>
<span class="sd">    :param str|datetime value: naive datetime to format either in string or in datetime</span>
<span class="sd">    :param str tz: name of the timezone  in which the given datetime should be localized</span>
<span class="sd">    :param str dt_format: one of full, long, medium, or short, or a custom date/time pattern compatible with `babel` lib</span>
<span class="sd">    :param str lang_code: ISO code of the language to use to render the given datetime</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Datetime</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">value</span>

    <span class="n">tz_name</span> <span class="o">=</span> <span class="n">tz</span> <span class="ow">or</span> <span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">tz</span> <span class="ow">or</span> <span class="s1">&#39;UTC&#39;</span>
    <span class="n">utc_datetime</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">is_dst</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">context_tz</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="n">tz_name</span><span class="p">)</span>
        <span class="n">localized_datetime</span> <span class="o">=</span> <span class="n">utc_datetime</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">context_tz</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">localized_datetime</span> <span class="o">=</span> <span class="n">utc_datetime</span>

    <span class="n">lang</span> <span class="o">=</span> <span class="n">get_lang</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">lang_code</span><span class="p">)</span>

    <span class="n">locale</span> <span class="o">=</span> <span class="n">babel_locale_parse</span><span class="p">(</span><span class="n">lang</span><span class="o">.</span><span class="n">code</span> <span class="ow">or</span> <span class="n">lang_code</span><span class="p">)</span>  <span class="c1"># lang can be inactive, so `lang`is empty</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dt_format</span><span class="p">:</span>
        <span class="n">date_format</span> <span class="o">=</span> <span class="n">posix_to_ldml</span><span class="p">(</span><span class="n">lang</span><span class="o">.</span><span class="n">date_format</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">locale</span><span class="p">)</span>
        <span class="n">time_format</span> <span class="o">=</span> <span class="n">posix_to_ldml</span><span class="p">(</span><span class="n">lang</span><span class="o">.</span><span class="n">time_format</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">locale</span><span class="p">)</span>
        <span class="n">dt_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">date_format</span><span class="p">,</span> <span class="n">time_format</span><span class="p">)</span>

    <span class="c1"># Babel allows to format datetime in a specific language without change locale</span>
    <span class="c1"># So month 1 = January in English, and janvier in French</span>
    <span class="c1"># Be aware that the default value for format is &#39;medium&#39;, instead of &#39;short&#39;</span>
    <span class="c1">#     medium:  Jan 5, 2016, 10:20:31 PM |   5 janv. 2016 22:20:31</span>
    <span class="c1">#     short:   1/5/16, 10:20 PM         |   5/01/16 22:20</span>
    <span class="c1"># Formatting available here : http://babel.pocoo.org/en/latest/dates.html#date-fields</span>
    <span class="k">return</span> <span class="n">babel</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">format_datetime</span><span class="p">(</span><span class="n">localized_datetime</span><span class="p">,</span> <span class="n">dt_format</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">locale</span><span class="p">)</span></div>



<div class="viewcode-block" id="format_time">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.format_time">[docs]</a>
<span class="k">def</span> <span class="nf">format_time</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">time_format</span><span class="o">=</span><span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="n">lang_code</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Format the given time (hour, minute and second) with the current user preference (language, format, ...)</span>

<span class="sd">        :param env:</span>
<span class="sd">        :param value: the time to format</span>
<span class="sd">        :type value: `datetime.time` instance. Could be timezoned to display tzinfo according to format (e.i.: &#39;full&#39; format)</span>
<span class="sd">        :param tz: name of the timezone  in which the given datetime should be localized</span>
<span class="sd">        :param time_format: one of full, long, medium, or short, or a custom time pattern</span>
<span class="sd">        :param lang_code: ISO</span>

<span class="sd">        :rtype str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">):</span>
        <span class="n">localized_datetime</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Datetime</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">tz_name</span> <span class="o">=</span> <span class="n">tz</span> <span class="ow">or</span> <span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">tz</span> <span class="ow">or</span> <span class="s1">&#39;UTC&#39;</span>
        <span class="n">utc_datetime</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">is_dst</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">context_tz</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="n">tz_name</span><span class="p">)</span>
            <span class="n">localized_datetime</span> <span class="o">=</span> <span class="n">utc_datetime</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">context_tz</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">localized_datetime</span> <span class="o">=</span> <span class="n">utc_datetime</span>

    <span class="n">lang</span> <span class="o">=</span> <span class="n">get_lang</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">lang_code</span><span class="p">)</span>
    <span class="n">locale</span> <span class="o">=</span> <span class="n">babel_locale_parse</span><span class="p">(</span><span class="n">lang</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">time_format</span><span class="p">:</span>
        <span class="n">time_format</span> <span class="o">=</span> <span class="n">posix_to_ldml</span><span class="p">(</span><span class="n">lang</span><span class="o">.</span><span class="n">time_format</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">locale</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">babel</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">format_time</span><span class="p">(</span><span class="n">localized_datetime</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">time_format</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">locale</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_format_time_ago</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">time_delta</span><span class="p">,</span> <span class="n">lang_code</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_direction</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">lang_code</span><span class="p">:</span>
        <span class="n">langs</span> <span class="o">=</span> <span class="p">[</span><span class="n">code</span> <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.lang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_installed</span><span class="p">()]</span>
        <span class="n">lang_code</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;lang&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">langs</span> <span class="k">else</span> <span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">company_id</span><span class="o">.</span><span class="n">partner_id</span><span class="o">.</span><span class="n">lang</span> <span class="ow">or</span> <span class="n">langs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">locale</span> <span class="o">=</span> <span class="n">babel_locale_parse</span><span class="p">(</span><span class="n">lang_code</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">babel</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">format_timedelta</span><span class="p">(</span><span class="o">-</span><span class="n">time_delta</span><span class="p">,</span> <span class="n">add_direction</span><span class="o">=</span><span class="n">add_direction</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">locale</span><span class="p">)</span>


<div class="viewcode-block" id="format_decimalized_number">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.format_decimalized_number">[docs]</a>
<span class="k">def</span> <span class="nf">format_decimalized_number</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">decimal</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format a number to display to nearest metrics unit next to it.</span>

<span class="sd">    Do not display digits if all visible digits are null.</span>
<span class="sd">    Do not display units higher then &quot;Tera&quot; because most of people don&#39;t know what</span>
<span class="sd">    a &quot;Yotta&quot; is.</span>

<span class="sd">    &gt;&gt;&gt; format_decimalized_number(123_456.789)</span>
<span class="sd">    123.5k</span>
<span class="sd">    &gt;&gt;&gt; format_decimalized_number(123_000.789)</span>
<span class="sd">    123k</span>
<span class="sd">    &gt;&gt;&gt; format_decimalized_number(-123_456.789)</span>
<span class="sd">    -123.5k</span>
<span class="sd">    &gt;&gt;&gt; format_decimalized_number(0.789)</span>
<span class="sd">    0.8</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1000.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%g%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">decimal</span><span class="p">),</span> <span class="n">unit</span><span class="p">)</span>
        <span class="n">number</span> <span class="o">/=</span> <span class="mf">1000.0</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%g%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">decimal</span><span class="p">),</span> <span class="s1">&#39;T&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="format_decimalized_amount">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.format_decimalized_amount">[docs]</a>
<span class="k">def</span> <span class="nf">format_decimalized_amount</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format a amount to display the currency and also display the metric unit of the amount.</span>

<span class="sd">    &gt;&gt;&gt; format_decimalized_amount(123_456.789, res.currency(&quot;$&quot;))</span>
<span class="sd">    $123.5k</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">formated_amount</span> <span class="o">=</span> <span class="n">format_decimalized_number</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">currency</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">formated_amount</span>

    <span class="k">if</span> <span class="n">currency</span><span class="o">.</span><span class="n">position</span> <span class="o">==</span> <span class="s1">&#39;before&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">currency</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">formated_amount</span><span class="p">)</span>

    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">formated_amount</span><span class="p">,</span> <span class="n">currency</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="format_amount">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.format_amount">[docs]</a>
<span class="k">def</span> <span class="nf">format_amount</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="n">lang_code</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;%.</span><span class="si">{0}</span><span class="s2">f&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">currency</span><span class="o">.</span><span class="n">decimal_places</span><span class="p">)</span>
    <span class="n">lang</span> <span class="o">=</span> <span class="n">get_lang</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">lang_code</span><span class="p">)</span>

    <span class="n">formatted_amount</span> <span class="o">=</span> <span class="n">lang</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">currency</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">amount</span><span class="p">),</span> <span class="n">grouping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">monetary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\N{NO-BREAK SPACE}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;-</span><span class="se">\N{ZERO WIDTH NO-BREAK SPACE}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">pre</span> <span class="o">=</span> <span class="n">post</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">currency</span><span class="o">.</span><span class="n">position</span> <span class="o">==</span> <span class="s1">&#39;before&#39;</span><span class="p">:</span>
        <span class="n">pre</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="si">{symbol}</span><span class="se">\N{NO-BREAK SPACE}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="n">currency</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">post</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\N{NO-BREAK SPACE}</span><span class="si">{symbol}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="n">currency</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="si">{pre}{0}{post}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">formatted_amount</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="n">post</span><span class="p">)</span></div>



<div class="viewcode-block" id="format_duration">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.format_duration">[docs]</a>
<span class="k">def</span> <span class="nf">format_duration</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Format a float: used to display integral or fractional values as</span>
<span class="sd">        human-readable time spans (e.g. 1.5 as &quot;01:30&quot;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">minutes</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">minutes</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">minutes</span> <span class="o">==</span> <span class="mi">60</span><span class="p">:</span>
        <span class="n">minutes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">hours</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;-</span><span class="si">%02d</span><span class="s1">:</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%02d</span><span class="s1">:</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span><span class="p">)</span></div>


<span class="n">consteq</span> <span class="o">=</span> <span class="n">hmac_lib</span><span class="o">.</span><span class="n">compare_digest</span>

<span class="n">_PICKLE_SAFE_NAMES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;builtins&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;set&#39;</span><span class="p">,</span>  <span class="c1"># Required to support `set()` for Python &lt; 3.8</span>
    <span class="p">],</span>
    <span class="s1">&#39;datetime&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;datetime&#39;</span><span class="p">,</span>
        <span class="s1">&#39;date&#39;</span><span class="p">,</span>
        <span class="s1">&#39;time&#39;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s1">&#39;pytz&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;_p&#39;</span><span class="p">,</span>
        <span class="s1">&#39;_UTC&#39;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">}</span>

<span class="c1"># https://docs.python.org/3/library/pickle.html#restricting-globals</span>
<span class="c1"># forbid globals entirely: str/unicode, int/long, float, bool, tuple, list, dict, None</span>
<div class="viewcode-block" id="Unpickler">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.Unpickler">[docs]</a>
<span class="k">class</span> <span class="nc">Unpickler</span><span class="p">(</span><span class="n">pickle_</span><span class="o">.</span><span class="n">Unpickler</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
<div class="viewcode-block" id="Unpickler.find_class">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.Unpickler.find_class">[docs]</a>
    <span class="k">def</span> <span class="nf">find_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">safe_names</span> <span class="o">=</span> <span class="n">_PICKLE_SAFE_NAMES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">safe_names</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">find_class</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;global &#39;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&#39; is forbidden&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span></div>
</div>

<span class="k">def</span> <span class="nf">_pickle_load</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ASCII&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">unpickler</span> <span class="o">=</span> <span class="n">Unpickler</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">unpickler</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Failed unpickling data, returning default: </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">errors</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">errors</span>
<span class="n">pickle</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">(</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;.pickle&#39;</span><span class="p">)</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">load</span> <span class="o">=</span> <span class="n">_pickle_load</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">loads</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ASCII&#39;</span><span class="p">:</span> <span class="n">_pickle_load</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">dump</span> <span class="o">=</span> <span class="n">pickle_</span><span class="o">.</span><span class="n">dump</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span> <span class="o">=</span> <span class="n">pickle_</span><span class="o">.</span><span class="n">dumps</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span> <span class="o">=</span> <span class="n">pickle_</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span>


<div class="viewcode-block" id="ReadonlyDict">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.ReadonlyDict">[docs]</a>
<span class="k">class</span> <span class="nc">ReadonlyDict</span><span class="p">(</span><span class="n">Mapping</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper for an unmodifiable dictionary, not even updatable using `dict.update`.</span>

<span class="sd">    This is similar to a `frozendict`, with one drawback and one advantage:</span>

<span class="sd">    - `dict.update` works for a `frozendict` but not for a `ReadonlyDict`.</span>
<span class="sd">    - `json.dumps` works for a `frozendict` by default but not for a `ReadonlyDict`.</span>

<span class="sd">    This comes from the fact `frozendict` inherits from `dict`</span>
<span class="sd">    while `ReadonlyDict` inherits from `collections.abc.Mapping`.</span>

<span class="sd">    So, depending on your needs,</span>
<span class="sd">    whether you absolutely must prevent the dictionary from being updated (e.g., for security reasons)</span>
<span class="sd">    or you require it to be supported by `json.dumps`, you can choose either option.</span>

<span class="sd">        E.g.</span>
<span class="sd">          data = ReadonlyDict({&#39;foo&#39;: &#39;bar&#39;})</span>
<span class="sd">          data[&#39;baz&#39;] = &#39;xyz&#39; # raises exception</span>
<span class="sd">          data.update({&#39;baz&#39;, &#39;xyz&#39;}) # raises exception</span>
<span class="sd">          dict.update(data, {&#39;baz&#39;: &#39;xyz&#39;}) # raises exception</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="p">)</span></div>



<div class="viewcode-block" id="DotDict">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.DotDict">[docs]</a>
<span class="k">class</span> <span class="nc">DotDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper for dot.notation access to dictionary attributes</span>

<span class="sd">        E.g.</span>
<span class="sd">          foo = DotDict({&#39;bar&#39;: False})</span>
<span class="sd">          return foo.bar</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrib</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attrib</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DotDict</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">val</span></div>



<div class="viewcode-block" id="get_diff">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.get_diff">[docs]</a>
<span class="k">def</span> <span class="nf">get_diff</span><span class="p">(</span><span class="n">data_from</span><span class="p">,</span> <span class="n">data_to</span><span class="p">,</span> <span class="n">custom_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dark_color_scheme</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return, in an HTML table, the diff between two texts.</span>

<span class="sd">    :param tuple data_from: tuple(text, name), name will be used as table header</span>
<span class="sd">    :param tuple data_to: tuple(text, name), name will be used as table header</span>
<span class="sd">    :param tuple custom_style: string, style css including &lt;style&gt; tag.</span>
<span class="sd">    :param bool dark_color_scheme: true if dark color scheme is used</span>
<span class="sd">    :return: a string containing the diff in an HTML table format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">handle_style</span><span class="p">(</span><span class="n">html_diff</span><span class="p">,</span> <span class="n">custom_style</span><span class="p">,</span> <span class="n">dark_color_scheme</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; The HtmlDiff lib will add some useful classes on the DOM to</span>
<span class="sd">        identify elements. Simply append to those classes some BS4 ones.</span>
<span class="sd">        For the table to fit the modal width, some custom style is needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">to_append</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;diff_header&#39;</span><span class="p">:</span> <span class="s1">&#39;bg-600 text-center align-top px-2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;diff_next&#39;</span><span class="p">:</span> <span class="s1">&#39;d-none&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="n">to_append</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">html_diff</span> <span class="o">=</span> <span class="n">html_diff</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">))</span>
        <span class="n">html_diff</span> <span class="o">=</span> <span class="n">html_diff</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;nowrap&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;#7f2d2f&#39;</span><span class="p">,</span> <span class="s1">&#39;#406a2d&#39;</span><span class="p">,</span> <span class="s1">&#39;#51232f&#39;</span><span class="p">,</span> <span class="s1">&#39;#3f483b&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">dark_color_scheme</span> <span class="k">else</span> <span class="p">(</span>
            <span class="s1">&#39;#ffc1c0&#39;</span><span class="p">,</span> <span class="s1">&#39;#abf2bc&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffebe9&#39;</span><span class="p">,</span> <span class="s1">&#39;#e6ffec&#39;</span><span class="p">)</span>
        <span class="n">html_diff</span> <span class="o">+=</span> <span class="n">custom_style</span> <span class="ow">or</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            &lt;style&gt;</span>
<span class="s1">                .modal-dialog.modal-lg:has(table.diff) {</span>
<span class="s1">                    max-width: 1600px;</span>
<span class="s1">                    padding-left: 1.75rem;</span>
<span class="s1">                    padding-right: 1.75rem;</span>
<span class="s1">                }</span>
<span class="s1">                table.diff { width: 100</span><span class="si">%%</span><span class="s1">; }</span>
<span class="s1">                table.diff th.diff_header { width: 50</span><span class="si">%%</span><span class="s1">; }</span>
<span class="s1">                table.diff td.diff_header { white-space: nowrap; }</span>
<span class="s1">                table.diff td { word-break: break-all; vertical-align: top; }</span>
<span class="s1">                table.diff .diff_chg, table.diff .diff_sub, table.diff .diff_add {</span>
<span class="s1">                    display: inline-block;</span>
<span class="s1">                    color: inherit;</span>
<span class="s1">                }</span>
<span class="s1">                table.diff .diff_sub, table.diff td:nth-child(3) &gt; .diff_chg { background-color: </span><span class="si">%s</span><span class="s1"> }</span>
<span class="s1">                table.diff .diff_add, table.diff td:nth-child(6) &gt; .diff_chg { background-color: </span><span class="si">%s</span><span class="s1"> }</span>
<span class="s1">                table.diff td:nth-child(3):has(&gt;.diff_chg, .diff_sub) { background-color: </span><span class="si">%s</span><span class="s1"> }</span>
<span class="s1">                table.diff td:nth-child(6):has(&gt;.diff_chg, .diff_add) { background-color: </span><span class="si">%s</span><span class="s1"> }</span>
<span class="s1">            &lt;/style&gt;</span>
<span class="s1">        &#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">colors</span>
        <span class="k">return</span> <span class="n">html_diff</span>

    <span class="n">diff</span> <span class="o">=</span> <span class="n">HtmlDiff</span><span class="p">(</span><span class="n">tabsize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">make_table</span><span class="p">(</span>
        <span class="n">data_from</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span>
        <span class="n">data_to</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span>
        <span class="n">data_from</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">data_to</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">context</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Show only diff lines, not all the code</span>
        <span class="n">numlines</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">handle_style</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">custom_style</span><span class="p">,</span> <span class="n">dark_color_scheme</span><span class="p">)</span></div>



<div class="viewcode-block" id="hmac">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.hmac">[docs]</a>
<span class="k">def</span> <span class="nf">hmac</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">hash_function</span><span class="o">=</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute HMAC with `database.secret` config parameter as key.</span>

<span class="sd">    :param env: sudo environment to use for retrieving config parameter</span>
<span class="sd">    :param message: message to authenticate</span>
<span class="sd">    :param scope: scope of the authentication, to have different signature for the same</span>
<span class="sd">        message in different usage</span>
<span class="sd">    :param hash_function: hash function to use for HMAC (default: SHA-256)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">scope</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Non-empty scope required&#39;</span><span class="p">)</span>

    <span class="n">secret</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.config_parameter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;database.secret&#39;</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">((</span><span class="n">scope</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">hmac_lib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
        <span class="n">secret</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
        <span class="n">message</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
        <span class="n">hash_function</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div>



<span class="n">ADDRESS_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(.*?)(\s[0-9][0-9\S]*)?(?: - (.+))?$&#39;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
<div class="viewcode-block" id="street_split">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.street_split">[docs]</a>
<span class="k">def</span> <span class="nf">street_split</span><span class="p">(</span><span class="n">street</span><span class="p">):</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">ADDRESS_REGEX</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">street</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">match</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;street_name&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
        <span class="s1">&#39;street_number&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
        <span class="s1">&#39;street_number2&#39;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
    <span class="p">}</span></div>



<div class="viewcode-block" id="is_list_of">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.is_list_of">[docs]</a>
<span class="k">def</span> <span class="nf">is_list_of</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return True if the given values is a list / tuple of the given type.</span>

<span class="sd">    :param values: The values to check</span>
<span class="sd">    :param type_: The type of the elements in the list / tuple</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">values</span><span class="p">)</span></div>



<div class="viewcode-block" id="has_list_types">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.has_list_types">[docs]</a>
<span class="k">def</span> <span class="nf">has_list_types</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return True if the given values have the same types as</span>
<span class="sd">    the one given in argument, in the same order.</span>

<span class="sd">    :param values: The values to check</span>
<span class="sd">    :param types: The types of the elements in the list / tuple</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">types</span><span class="p">)</span>
        <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">type_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">types</span><span class="p">))</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="get_flag">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.get_flag">[docs]</a>
<span class="k">def</span> <span class="nf">get_flag</span><span class="p">(</span><span class="n">country_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the emoji representing the flag linked to the country code.</span>

<span class="sd">    This emoji is composed of the two regional indicator emoji of the country code.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;1f1</span><span class="si">{</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">+</span><span class="mi">165</span><span class="si">:</span><span class="s2">02x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">country_code</span><span class="p">)</span></div>



<div class="viewcode-block" id="format_frame">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.format_frame">[docs]</a>
<span class="k">def</span> <span class="nf">format_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">code</span><span class="o">.</span><span class="n">co_name</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">code</span><span class="o">.</span><span class="n">co_filename</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="si">}</span><span class="s1">&#39;</span></div>



<div class="viewcode-block" id="named_to_positional_printf">
<a class="viewcode-back" href="../../../odoo.tools.html#odoo.tools.misc.named_to_positional_printf">[docs]</a>
<span class="k">def</span> <span class="nf">named_to_positional_printf</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Convert a named printf-style format string with its arguments to an</span>
<span class="sd">    equivalent positional format string with its arguments. This implementation</span>
<span class="sd">    does not support escaped ``%`` characters (``&quot;%%&quot;``).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;</span><span class="si">%%</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">string</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported escaped &#39;%&#39; in format string </span><span class="si">{</span><span class="n">string</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">_PrintfArgs</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">string</span> <span class="o">%</span> <span class="n">args</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">values</span><span class="p">)</span></div>



<span class="k">class</span> <span class="nc">_PrintfArgs</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Helper object to turn a named printf-style format string into a positional one. &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;mapping&#39;</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">mapping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Amr.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>