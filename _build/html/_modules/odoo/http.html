<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>odoo.http &mdash; Amr  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Amr
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">odoo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Amr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../odoo.html">odoo</a></li>
      <li class="breadcrumb-item active">odoo.http</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for odoo.http</h1><div class="highlight"><pre>
<span></span><span class="c1"># Part of Odoo. See LICENSE file for full copyright and licensing details.</span>
<span class="sa">r</span><span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">Odoo HTTP layer / WSGI application</span>

<span class="sd">The main duty of this module is to prepare and dispatch all http</span>
<span class="sd">requests to their corresponding controllers: from a raw http request</span>
<span class="sd">arriving on the WSGI entrypoint to a :class:`~http.Request`: arriving at</span>
<span class="sd">a module controller with a fully setup ORM available.</span>

<span class="sd">Application developers mostly know this module thanks to the</span>
<span class="sd">:class:`~odoo.http.Controller`: class and its companion the</span>
<span class="sd">:func:`~odoo.http.route`: method decorator. Together they are used to</span>
<span class="sd">register methods responsible of delivering web content to matching URLS.</span>

<span class="sd">Those two are only the tip of the iceberg, below is an ascii graph that</span>
<span class="sd">shows the various processing layers each request passes through before</span>
<span class="sd">ending at the @route decorated endpoint. Hopefully, this graph and the</span>
<span class="sd">attached function descriptions will help you understand this module.</span>

<span class="sd">Here be dragons:</span>

<span class="sd">    Application.__call__</span>
<span class="sd">        +-&gt; Request._serve_static</span>
<span class="sd">        |</span>
<span class="sd">        +-&gt; Request._serve_nodb</span>
<span class="sd">        |   -&gt; App.nodb_routing_map.match</span>
<span class="sd">        |   -&gt; Dispatcher.pre_dispatch</span>
<span class="sd">        |   -&gt; Dispatcher.dispatch</span>
<span class="sd">        |      -&gt; route_wrapper</span>
<span class="sd">        |         -&gt; endpoint</span>
<span class="sd">        |   -&gt; Dispatcher.post_dispatch</span>
<span class="sd">        |</span>
<span class="sd">        +-&gt; Request._serve_db</span>
<span class="sd">            -&gt; model.retrying</span>
<span class="sd">               -&gt; Request._serve_ir_http</span>
<span class="sd">                  -&gt; env[&#39;ir.http&#39;]._match</span>
<span class="sd">                  -&gt; env[&#39;ir.http&#39;]._authenticate</span>
<span class="sd">                  -&gt; env[&#39;ir.http&#39;]._pre_dispatch</span>
<span class="sd">                     -&gt; Dispatcher.pre_dispatch</span>
<span class="sd">                  -&gt; Dispatcher.dispatch</span>
<span class="sd">                     -&gt; env[&#39;ir.http&#39;]._dispatch</span>
<span class="sd">                        -&gt; route_wrapper</span>
<span class="sd">                           -&gt; endpoint</span>
<span class="sd">                  -&gt; env[&#39;ir.http&#39;]._post_dispatch</span>
<span class="sd">                     -&gt; Dispatcher.post_dispatch</span>

<span class="sd">Application.__call__</span>
<span class="sd">  WSGI entry point, it sanitizes the request, it wraps it in a werkzeug</span>
<span class="sd">  request and itself in an Odoo http request. The Odoo http request is</span>
<span class="sd">  exposed at ``http.request`` then it is forwarded to either</span>
<span class="sd">  ``_serve_static``, ``_serve_nodb`` or ``_serve_db`` depending on the</span>
<span class="sd">  request path and the presence of a database. It is also responsible of</span>
<span class="sd">  ensuring any error is properly logged and encapsuled in a HTTP error</span>
<span class="sd">  response.</span>

<span class="sd">Request._serve_static</span>
<span class="sd">  Handle all requests to ``/&lt;module&gt;/static/&lt;asset&gt;`` paths, open the</span>
<span class="sd">  underlying file on the filesystem and stream it via</span>
<span class="sd">  :meth:``Request.send_file``</span>

<span class="sd">Request._serve_nodb</span>
<span class="sd">  Handle requests to ``@route(auth=&#39;none&#39;)`` endpoints when the user is</span>
<span class="sd">  not connected to a database. It performs limited operations, just</span>
<span class="sd">  matching the auth=&#39;none&#39; endpoint using the request path and then it</span>
<span class="sd">  delegates to Dispatcher.</span>

<span class="sd">Request._serve_db</span>
<span class="sd">  Handle all requests that are not static when it is possible to connect</span>
<span class="sd">  to a database. It opens a session and initializes the ORM before</span>
<span class="sd">  forwarding the request to ``retrying`` and ``_serve_ir_http``.</span>

<span class="sd">service.model.retrying</span>
<span class="sd">  Protect against SQL serialisation errors (when two different</span>
<span class="sd">  transactions write on the same record), when such an error occurs this</span>
<span class="sd">  function resets the session and the environment then re-dispatches the</span>
<span class="sd">  request.</span>

<span class="sd">Request._serve_ir_http</span>
<span class="sd">  Delegate most of the effort to the ``ir.http`` abstract model which</span>
<span class="sd">  itself calls RequestDispatch back. ``ir.http`` grants modularity in</span>
<span class="sd">  the http stack. The notable difference with nodb is that there is an</span>
<span class="sd">  authentication layer and a mechanism to serve pages that are not</span>
<span class="sd">  accessible through controllers.</span>

<span class="sd">ir.http._authenticate</span>
<span class="sd">  Ensure the user on the current environment fulfill the requirement of</span>
<span class="sd">  ``@route(auth=...)``. Using the ORM outside of abstract models is</span>
<span class="sd">  unsafe prior of calling this function.</span>

<span class="sd">ir.http._pre_dispatch/Dispatcher.pre_dispatch</span>
<span class="sd">  Prepare the system the handle the current request, often used to save</span>
<span class="sd">  some extra query-string parameters in the session (e.g. ?debug=1)</span>

<span class="sd">ir.http._dispatch/Dispatcher.dispatch</span>
<span class="sd">  Deserialize the HTTP request body into ``request.params`` according to</span>
<span class="sd">  @route(type=...), call the controller endpoint, serialize its return</span>
<span class="sd">  value into an HTTP Response object.</span>

<span class="sd">ir.http._post_dispatch/Dispatcher.post_dispatch</span>
<span class="sd">  Post process the response returned by the controller endpoint. Used to</span>
<span class="sd">  inject various headers such as Content-Security-Policy.</span>

<span class="sd">route_wrapper, closure of the http.route decorator</span>
<span class="sd">  Sanitize the request parameters, call the route endpoint and</span>
<span class="sd">  optionally coerce the endpoint result.</span>

<span class="sd">endpoint</span>
<span class="sd">  The @route(...) decorated controller method.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">cgi</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">collections.abc</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">hmac</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">mimetypes</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">zlib</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span> <span class="k">as</span> <span class="n">opj</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>
<span class="kn">from</span> <span class="nn">zlib</span> <span class="kn">import</span> <span class="n">adler32</span>

<span class="kn">import</span> <span class="nn">babel.core</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">geoip2.database</span>
    <span class="kn">import</span> <span class="nn">geoip2.models</span>
    <span class="kn">import</span> <span class="nn">geoip2.errors</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">geoip2</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">maxminddb</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">maxminddb</span> <span class="o">=</span> <span class="kc">None</span>

<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">import</span> <span class="nn">werkzeug.datastructures</span>
<span class="kn">import</span> <span class="nn">werkzeug.exceptions</span>
<span class="kn">import</span> <span class="nn">werkzeug.local</span>
<span class="kn">import</span> <span class="nn">werkzeug.routing</span>
<span class="kn">import</span> <span class="nn">werkzeug.security</span>
<span class="kn">import</span> <span class="nn">werkzeug.wrappers</span>
<span class="kn">import</span> <span class="nn">werkzeug.wsgi</span>
<span class="kn">from</span> <span class="nn">werkzeug.urls</span> <span class="kn">import</span> <span class="n">URL</span><span class="p">,</span> <span class="n">url_parse</span><span class="p">,</span> <span class="n">url_encode</span><span class="p">,</span> <span class="n">url_quote</span>
<span class="kn">from</span> <span class="nn">werkzeug.exceptions</span> <span class="kn">import</span> <span class="p">(</span><span class="n">HTTPException</span><span class="p">,</span> <span class="n">BadRequest</span><span class="p">,</span> <span class="n">Forbidden</span><span class="p">,</span>
                                 <span class="n">NotFound</span><span class="p">,</span> <span class="n">InternalServerError</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">werkzeug.middleware.proxy_fix</span> <span class="kn">import</span> <span class="n">ProxyFix</span> <span class="k">as</span> <span class="n">ProxyFix_</span>
    <span class="n">ProxyFix</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">ProxyFix_</span><span class="p">,</span> <span class="n">x_for</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">x_proto</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">x_host</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">werkzeug.contrib.fixers</span> <span class="kn">import</span> <span class="n">ProxyFix</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">werkzeug.utils</span> <span class="kn">import</span> <span class="n">send_file</span> <span class="k">as</span> <span class="n">_send_file</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.tools._vendor.send_file</span> <span class="kn">import</span> <span class="n">send_file</span> <span class="k">as</span> <span class="n">_send_file</span>

<span class="kn">import</span> <span class="nn">odoo</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">UserError</span><span class="p">,</span> <span class="n">AccessError</span><span class="p">,</span> <span class="n">AccessDenied</span>
<span class="kn">from</span> <span class="nn">.modules.module</span> <span class="kn">import</span> <span class="n">get_manifest</span>
<span class="kn">from</span> <span class="nn">.modules.registry</span> <span class="kn">import</span> <span class="n">Registry</span>
<span class="kn">from</span> <span class="nn">.service</span> <span class="kn">import</span> <span class="n">security</span><span class="p">,</span> <span class="n">model</span> <span class="k">as</span> <span class="n">service_model</span>
<span class="kn">from</span> <span class="nn">.tools</span> <span class="kn">import</span> <span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">consteq</span><span class="p">,</span> <span class="n">date_utils</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">parse_version</span><span class="p">,</span>
                    <span class="n">profiler</span><span class="p">,</span> <span class="n">submap</span><span class="p">,</span> <span class="n">unique</span><span class="p">,</span> <span class="n">ustr</span><span class="p">,)</span>
<span class="kn">from</span> <span class="nn">.tools.func</span> <span class="kn">import</span> <span class="n">filter_kwargs</span><span class="p">,</span> <span class="n">lazy_property</span>
<span class="kn">from</span> <span class="nn">.tools.mimetypes</span> <span class="kn">import</span> <span class="n">guess_mimetype</span>
<span class="kn">from</span> <span class="nn">.tools.misc</span> <span class="kn">import</span> <span class="n">pickle</span>
<span class="kn">from</span> <span class="nn">.tools._vendor</span> <span class="kn">import</span> <span class="n">sessions</span>
<span class="kn">from</span> <span class="nn">.tools._vendor.useragents</span> <span class="kn">import</span> <span class="n">UserAgent</span>


<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># =========================================================</span>
<span class="c1"># Lib fixes</span>
<span class="c1"># =========================================================</span>

<span class="c1"># Add potentially missing (older ubuntu) font mime types</span>
<span class="n">mimetypes</span><span class="o">.</span><span class="n">add_type</span><span class="p">(</span><span class="s1">&#39;application/font-woff&#39;</span><span class="p">,</span> <span class="s1">&#39;.woff&#39;</span><span class="p">)</span>
<span class="n">mimetypes</span><span class="o">.</span><span class="n">add_type</span><span class="p">(</span><span class="s1">&#39;application/vnd.ms-fontobject&#39;</span><span class="p">,</span> <span class="s1">&#39;.eot&#39;</span><span class="p">)</span>
<span class="n">mimetypes</span><span class="o">.</span><span class="n">add_type</span><span class="p">(</span><span class="s1">&#39;application/x-font-ttf&#39;</span><span class="p">,</span> <span class="s1">&#39;.ttf&#39;</span><span class="p">)</span>
<span class="n">mimetypes</span><span class="o">.</span><span class="n">add_type</span><span class="p">(</span><span class="s1">&#39;image/webp&#39;</span><span class="p">,</span> <span class="s1">&#39;.webp&#39;</span><span class="p">)</span>
<span class="c1"># Add potentially wrong (detected on windows) svg mime types</span>
<span class="n">mimetypes</span><span class="o">.</span><span class="n">add_type</span><span class="p">(</span><span class="s1">&#39;image/svg+xml&#39;</span><span class="p">,</span> <span class="s1">&#39;.svg&#39;</span><span class="p">)</span>
<span class="c1"># this one can be present on windows with the value &#39;text/plain&#39; which</span>
<span class="c1"># breaks loading js files from an addon&#39;s static folder</span>
<span class="n">mimetypes</span><span class="o">.</span><span class="n">add_type</span><span class="p">(</span><span class="s1">&#39;text/javascript&#39;</span><span class="p">,</span> <span class="s1">&#39;.js&#39;</span><span class="p">)</span>

<span class="c1"># To remove when corrected in Babel</span>
<span class="n">babel</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">LOCALE_ALIASES</span><span class="p">[</span><span class="s1">&#39;nb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nb_NO&#39;</span>


<span class="c1"># =========================================================</span>
<span class="c1"># Const</span>
<span class="c1"># =========================================================</span>

<span class="c1"># The validity duration of a preflight response, one day.</span>
<span class="n">CORS_MAX_AGE</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span>

<span class="c1"># The HTTP methods that do not require a CSRF validation.</span>
<span class="n">CSRF_FREE_METHODS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">,</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">,</span> <span class="s1">&#39;TRACE&#39;</span><span class="p">)</span>

<span class="c1"># The default csrf token lifetime, a salt against BREACH, one year</span>
<span class="n">CSRF_TOKEN_SALT</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">365</span>

<span class="c1"># The default lang to use when the browser doesn&#39;t specify it</span>
<span class="n">DEFAULT_LANG</span> <span class="o">=</span> <span class="s1">&#39;en_US&#39;</span>

<span class="c1"># The dictionary to initialise a new session with.</span>
<div class="viewcode-block" id="get_default_session">
<a class="viewcode-back" href="../../odoo.html#odoo.http.get_default_session">[docs]</a>
<span class="k">def</span> <span class="nf">get_default_session</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># &#39;lang&#39;: request.default_lang()  # must be set at runtime</span>
        <span class="s1">&#39;db&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;uid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;session_token&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">}</span></div>


<span class="n">DEFAULT_MAX_CONTENT_LENGTH</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c1"># 128MiB</span>

<span class="c1"># Two empty objects used when the geolocalization failed. They have the</span>
<span class="c1"># sames attributes as real countries/cities except that accessing them</span>
<span class="c1"># evaluates to None.</span>
<span class="k">if</span> <span class="n">geoip2</span><span class="p">:</span>
    <span class="n">GEOIP_EMPTY_COUNTRY</span> <span class="o">=</span> <span class="n">geoip2</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Country</span><span class="p">({})</span>
    <span class="n">GEOIP_EMPTY_CITY</span> <span class="o">=</span> <span class="n">geoip2</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">City</span><span class="p">({})</span>

<span class="c1"># The request mimetypes that transport JSON in their body.</span>
<span class="n">JSON_MIMETYPES</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json-rpc&#39;</span><span class="p">)</span>

<span class="n">MISSING_CSRF_WARNING</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">No CSRF validation token provided for path </span><span class="si">%r</span>

<span class="s2">Odoo URLs are CSRF-protected by default (when accessed with unsafe</span>
<span class="s2">HTTP methods). See</span>
<span class="s2">https://www.odoo.com/documentation/17.0/developer/reference/addons/http.html#csrf</span>
<span class="s2">for more details.</span>

<span class="s2">* if this endpoint is accessed through Odoo via py-QWeb form, embed a CSRF</span>
<span class="s2">  token in the form, Tokens are available via `request.csrf_token()`</span>
<span class="s2">  can be provided through a hidden input and must be POST-ed named</span>
<span class="s2">  `csrf_token` e.g. in your form add:</span>
<span class="s2">      &lt;input type=&quot;hidden&quot; name=&quot;csrf_token&quot; t-att-value=&quot;request.csrf_token()&quot;/&gt;</span>

<span class="s2">* if the form is generated or posted in javascript, the token value is</span>
<span class="s2">  available as `csrf_token` on `web.core` and as the `csrf_token`</span>
<span class="s2">  value in the default js-qweb execution context</span>

<span class="s2">* if the form is accessed by an external third party (e.g. REST API</span>
<span class="s2">  endpoint, payment gateway callback) you will need to disable CSRF</span>
<span class="s2">  protection (and implement your own protection if necessary) by</span>
<span class="s2">  passing the `csrf=False` parameter to the `route` decorator.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># The @route arguments to propagate from the decorated method to the</span>
<span class="c1"># routing rule.</span>
<span class="n">ROUTING_KEYS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;defaults&#39;</span><span class="p">,</span> <span class="s1">&#39;subdomain&#39;</span><span class="p">,</span> <span class="s1">&#39;build_only&#39;</span><span class="p">,</span> <span class="s1">&#39;strict_slashes&#39;</span><span class="p">,</span> <span class="s1">&#39;redirect_to&#39;</span><span class="p">,</span>
    <span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="s1">&#39;methods&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">if</span> <span class="n">parse_version</span><span class="p">(</span><span class="n">werkzeug</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">parse_version</span><span class="p">(</span><span class="s1">&#39;2.0.2&#39;</span><span class="p">):</span>
    <span class="c1"># Werkzeug 2.0.2 adds the websocket option. If a websocket request</span>
    <span class="c1"># (ws/wss) is trying to access an HTTP route, a WebsocketMismatch</span>
    <span class="c1"># exception is raised. On the other hand, Werkzeug 0.16 does not</span>
    <span class="c1"># support the websocket routing key. In order to bypass this issue,</span>
    <span class="c1"># let&#39;s add the websocket key only when appropriate.</span>
    <span class="n">ROUTING_KEYS</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;websocket&#39;</span><span class="p">)</span>

<span class="c1"># The default duration of a user session cookie. Inactive sessions are reaped</span>
<span class="c1"># server-side as well with a threshold that can be set via an optional</span>
<span class="c1"># config parameter `sessions.max_inactivity_seconds` (default: SESSION_LIFETIME)</span>
<span class="n">SESSION_LIFETIME</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span>

<span class="c1"># The cache duration for static content from the filesystem, one week.</span>
<span class="n">STATIC_CACHE</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span>

<span class="c1"># The cache duration for content where the url uniquely identifies the</span>
<span class="c1"># content (usually using a hash), one year.</span>
<span class="n">STATIC_CACHE_LONG</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">365</span>


<span class="c1"># =========================================================</span>
<span class="c1"># Helpers</span>
<span class="c1"># =========================================================</span>

<div class="viewcode-block" id="SessionExpiredException">
<a class="viewcode-back" href="../../odoo.html#odoo.http.SessionExpiredException">[docs]</a>
<span class="k">class</span> <span class="nc">SessionExpiredException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="content_disposition">
<a class="viewcode-back" href="../../odoo.html#odoo.http.content_disposition">[docs]</a>
<span class="k">def</span> <span class="nf">content_disposition</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;attachment; filename*=UTF-8&#39;&#39;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">url_quote</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">unsafe</span><span class="o">=</span><span class="s1">&#39;()&lt;&gt;@,;:&quot;/[]?=</span><span class="si">{}</span><span class="se">\\</span><span class="s1">*</span><span class="se">\&#39;</span><span class="s1">%&#39;</span><span class="p">)</span> <span class="c1"># RFC6266</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="db_list">
<a class="viewcode-back" href="../../odoo.html#odoo.http.db_list">[docs]</a>
<span class="k">def</span> <span class="nf">db_list</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the list of available databases.</span>

<span class="sd">    :param bool force: See :func:`~odoo.service.db.list_dbs`:</span>
<span class="sd">    :param host: The Host used to replace %h and %d in the dbfilters</span>
<span class="sd">        regexp. Taken from the current request when omitted.</span>
<span class="sd">    :returns: the list of available databases</span>
<span class="sd">    :rtype: List[str]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dbs</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">list_dbs</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="n">db_filter</span><span class="p">(</span><span class="n">dbs</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span></div>


<div class="viewcode-block" id="db_filter">
<a class="viewcode-back" href="../../odoo.html#odoo.http.db_filter">[docs]</a>
<span class="k">def</span> <span class="nf">db_filter</span><span class="p">(</span><span class="n">dbs</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the subset of ``dbs`` that match the dbfilter or the dbname</span>
<span class="sd">    server configuration. In case neither are configured, return ``dbs``</span>
<span class="sd">    as-is.</span>

<span class="sd">    :param Iterable[str] dbs: The list of database names to filter.</span>
<span class="sd">    :param host: The Host used to replace %h and %d in the dbfilters</span>
<span class="sd">        regexp. Taken from the current request when omitted.</span>
<span class="sd">    :returns: The original list filtered.</span>
<span class="sd">    :rtype: List[str]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dbfilter&#39;</span><span class="p">]:</span>
        <span class="c1">#        host</span>
        <span class="c1">#     -----------</span>
        <span class="c1"># www.example.com:80</span>
        <span class="c1">#     -------</span>
        <span class="c1">#     domain</span>
        <span class="k">if</span> <span class="n">host</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">host</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_HOST&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">host</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;www.&#39;</span><span class="p">):</span>
            <span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">dbfilter_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;dbfilter&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;%h&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">host</span><span class="p">))</span>
                              <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">domain</span><span class="p">)))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">db</span> <span class="k">for</span> <span class="n">db</span> <span class="ow">in</span> <span class="n">dbs</span> <span class="k">if</span> <span class="n">dbfilter_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">db</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;db_name&#39;</span><span class="p">]:</span>
        <span class="c1"># In case --db-filter is not provided and --database is passed, Odoo will</span>
        <span class="c1"># use the value of --database as a comma separated list of exposed databases.</span>
        <span class="n">exposed_dbs</span> <span class="o">=</span> <span class="p">{</span><span class="n">db</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">db</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;db_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)}</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">exposed_dbs</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">dbs</span><span class="p">))</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">dbs</span><span class="p">)</span></div>



<div class="viewcode-block" id="dispatch_rpc">
<a class="viewcode-back" href="../../odoo.html#odoo.http.dispatch_rpc">[docs]</a>
<span class="k">def</span> <span class="nf">dispatch_rpc</span><span class="p">(</span><span class="n">service_name</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform a RPC call.</span>

<span class="sd">    :param str service_name: either &quot;common&quot;, &quot;db&quot; or &quot;object&quot;.</span>
<span class="sd">    :param str method: the method name of the given service to execute</span>
<span class="sd">    :param Mapping params: the keyword arguments for method call</span>
<span class="sd">    :return: the return value of the called method</span>
<span class="sd">    :rtype: Any</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rpc_dispatchers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;common&#39;</span><span class="p">:</span> <span class="n">odoo</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">dispatch</span><span class="p">,</span>
        <span class="s1">&#39;db&#39;</span><span class="p">:</span> <span class="n">odoo</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">dispatch</span><span class="p">,</span>
        <span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="n">odoo</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dispatch</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">with</span> <span class="n">borrow_request</span><span class="p">():</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">dbname</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">dispatch</span> <span class="o">=</span> <span class="n">rpc_dispatchers</span><span class="p">[</span><span class="n">service_name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dispatch</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></div>



<div class="viewcode-block" id="is_cors_preflight">
<a class="viewcode-back" href="../../odoo.html#odoo.http.is_cors_preflight">[docs]</a>
<span class="k">def</span> <span class="nf">is_cors_preflight</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;OPTIONS&#39;</span> <span class="ow">and</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">routing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cors&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>



<div class="viewcode-block" id="serialize_exception">
<a class="viewcode-back" href="../../odoo.html#odoo.http.serialize_exception">[docs]</a>
<span class="k">def</span> <span class="nf">serialize_exception</span><span class="p">(</span><span class="n">exception</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="n">module</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span><span class="o">.</span><span class="vm">__module__</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">module</span> <span class="k">else</span> <span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span>
        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">ustr</span><span class="p">(</span><span class="n">exception</span><span class="p">),</span>
        <span class="s1">&#39;arguments&#39;</span><span class="p">:</span> <span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
        <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="p">{}),</span>
    <span class="p">}</span></div>



<span class="c1"># =========================================================</span>
<span class="c1"># File Streaming</span>
<span class="c1"># =========================================================</span>

<div class="viewcode-block" id="send_file">
<a class="viewcode-back" href="../../odoo.html#odoo.http.send_file">[docs]</a>
<span class="k">def</span> <span class="nf">send_file</span><span class="p">(</span><span class="n">filepath_or_fp</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">as_attachment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mtime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">add_etags</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cache_timeout</span><span class="o">=</span><span class="n">STATIC_CACHE</span><span class="p">,</span> <span class="n">conditional</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;odoo.http.send_file is deprecated, please use odoo.http.Stream instead.&#39;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_send_file</span><span class="p">(</span>
        <span class="n">filepath_or_fp</span><span class="p">,</span>
        <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span>
        <span class="n">mimetype</span><span class="o">=</span><span class="n">mimetype</span><span class="p">,</span>
        <span class="n">as_attachment</span><span class="o">=</span><span class="n">as_attachment</span><span class="p">,</span>
        <span class="n">download_name</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
        <span class="n">last_modified</span><span class="o">=</span><span class="n">mtime</span><span class="p">,</span>
        <span class="n">etag</span><span class="o">=</span><span class="n">add_etags</span><span class="p">,</span>
        <span class="n">max_age</span><span class="o">=</span><span class="n">cache_timeout</span><span class="p">,</span>
        <span class="n">response_class</span><span class="o">=</span><span class="n">Response</span><span class="p">,</span>
        <span class="n">conditional</span><span class="o">=</span><span class="n">conditional</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="Stream">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Stream">[docs]</a>
<span class="k">class</span> <span class="nc">Stream</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Send the content of a file, an attachment or a binary field via HTTP</span>

<span class="sd">    This utility is safe, cache-aware and uses the best available</span>
<span class="sd">    streaming strategy. Works best with the --x-sendfile cli option.</span>

<span class="sd">    Create a Stream via one of the constructors: :meth:`~from_path`:,</span>
<span class="sd">    :meth:`~from_attachment`: or :meth:`~from_binary_field`:, generate</span>
<span class="sd">    the corresponding HTTP response object via :meth:`~get_response`:.</span>

<span class="sd">    Instantiating a Stream object manually without using one of the</span>
<span class="sd">    dedicated constructors is discouraged.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># &#39;data&#39; or &#39;path&#39; or &#39;url&#39;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">url</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">mimetype</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">as_attachment</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">download_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">conditional</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">etag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">last_modified</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">max_age</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">immutable</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">size</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="Stream.from_path">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Stream.from_path">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_path</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">filter_ext</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Create a :class:`~Stream`: from an addon resource. &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filter_ext</span><span class="p">)</span>
        <span class="n">check</span> <span class="o">=</span> <span class="n">adler32</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;path&#39;</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="n">download_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
            <span class="n">etag</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">stat</span><span class="o">.</span><span class="n">st_size</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">check</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">last_modified</span><span class="o">=</span><span class="n">stat</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="n">stat</span><span class="o">.</span><span class="n">st_size</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Stream.from_attachment">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Stream.from_attachment">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_attachment</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attachment</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Create a :class:`~Stream`: from an ir.attachment record. &quot;&quot;&quot;</span>
        <span class="n">attachment</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">mimetype</span><span class="o">=</span><span class="n">attachment</span><span class="o">.</span><span class="n">mimetype</span><span class="p">,</span>
            <span class="n">download_name</span><span class="o">=</span><span class="n">attachment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">conditional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">etag</span><span class="o">=</span><span class="n">attachment</span><span class="o">.</span><span class="n">checksum</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">attachment</span><span class="o">.</span><span class="n">store_fname</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;path&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">safe_join</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">filestore</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">db</span><span class="p">)),</span>
                <span class="n">attachment</span><span class="o">.</span><span class="n">store_fname</span>
            <span class="p">)</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_modified</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_mtime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_size</span>

        <span class="k">elif</span> <span class="n">attachment</span><span class="o">.</span><span class="n">db_datas</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">attachment</span><span class="o">.</span><span class="n">raw</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_modified</span> <span class="o">=</span> <span class="n">attachment</span><span class="o">.</span><span class="n">write_date</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">attachment</span><span class="o">.</span><span class="n">url</span><span class="p">:</span>
            <span class="c1"># When the URL targets a file located in an addon, assume it</span>
            <span class="c1"># is a path to the resource. It saves an indirection and</span>
            <span class="c1"># stream the file right away.</span>
            <span class="n">static_path</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">get_static_file</span><span class="p">(</span>
                <span class="n">attachment</span><span class="o">.</span><span class="n">url</span><span class="p">,</span>
                <span class="n">host</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_HOST&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">static_path</span><span class="p">:</span>
                <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">static_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;url&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">attachment</span><span class="o">.</span><span class="n">url</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="Stream.from_binary_field">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Stream.from_binary_field">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_binary_field</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Create a :class:`~Stream`: from a binary field. &quot;&quot;&quot;</span>
        <span class="n">data_b64</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">data_b64</span><span class="p">)</span> <span class="k">if</span> <span class="n">data_b64</span> <span class="k">else</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">etag</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.attachment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_compute_checksum</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="n">last_modified</span><span class="o">=</span><span class="n">record</span><span class="o">.</span><span class="n">write_date</span> <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">_log_access</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Stream.read">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Stream.read">[docs]</a>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Get the stream content as bytes. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;url&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot read an URL&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>


<div class="viewcode-block" id="Stream.get_response">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Stream.get_response">[docs]</a>
    <span class="k">def</span> <span class="nf">get_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_attachment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">immutable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">send_file_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the corresponding :class:`~Response` for the current stream.</span>

<span class="sd">        :param bool as_attachment: Indicate to the browser that it</span>
<span class="sd">            should offer to save the file instead of displaying it.</span>
<span class="sd">        :param bool immutable: Add the ``immutable`` directive to the</span>
<span class="sd">            ``Cache-Control`` response header, allowing intermediary</span>
<span class="sd">            proxies to aggressively cache the response. This option</span>
<span class="sd">            also set the ``max-age`` directive to 1 year.</span>
<span class="sd">        :param send_file_kwargs: Other keyword arguments to send to</span>
<span class="sd">            :func:`odoo.tools._vendor.send_file.send_file` instead of</span>
<span class="sd">            the stream sensitive values. Discouraged.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">),</span> <span class="s2">&quot;Invalid type: </span><span class="si">{self.type!r}</span><span class="s2">, should be &#39;url&#39;, &#39;data&#39; or &#39;path&#39;.&quot;</span>
        <span class="k">assert</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;There is nothing to stream, missing </span><span class="si">{self.type!r}</span><span class="s2"> attribute.&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;url&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="mi">301</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">as_attachment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">as_attachment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_attachment</span>
        <span class="k">if</span> <span class="n">immutable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">immutable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">immutable</span>

        <span class="n">send_file_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mimetype&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mimetype</span><span class="p">,</span>
            <span class="s1">&#39;as_attachment&#39;</span><span class="p">:</span> <span class="n">as_attachment</span><span class="p">,</span>
            <span class="s1">&#39;download_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_name</span><span class="p">,</span>
            <span class="s1">&#39;conditional&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditional</span><span class="p">,</span>
            <span class="s1">&#39;etag&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">etag</span><span class="p">,</span>
            <span class="s1">&#39;last_modified&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_modified</span><span class="p">,</span>
            <span class="s1">&#39;max_age&#39;</span><span class="p">:</span> <span class="n">STATIC_CACHE_LONG</span> <span class="k">if</span> <span class="n">immutable</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_age</span><span class="p">,</span>
            <span class="s1">&#39;environ&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span>
            <span class="s1">&#39;response_class&#39;</span><span class="p">:</span> <span class="n">Response</span><span class="p">,</span>
            <span class="o">**</span><span class="n">send_file_kwargs</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_send_file</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="o">**</span><span class="n">send_file_kwargs</span><span class="p">)</span>

        <span class="c1"># self.type == &#39;path&#39;</span>
        <span class="n">send_file_kwargs</span><span class="p">[</span><span class="s1">&#39;use_x_sendfile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;x_sendfile&#39;</span><span class="p">]:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>  <span class="c1"># outside of the filestore</span>
                <span class="n">fspath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;data_dir&#39;</span><span class="p">],</span> <span class="s1">&#39;filestore&#39;</span><span class="p">))</span>
                <span class="n">x_accel_redirect</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/web/filestore/</span><span class="si">{</span><span class="n">fspath</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">send_file_kwargs</span><span class="p">[</span><span class="s1">&#39;use_x_sendfile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">_send_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">send_file_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">immutable</span> <span class="ow">and</span> <span class="n">res</span><span class="o">.</span><span class="n">cache_control</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">cache_control</span><span class="p">[</span><span class="s2">&quot;immutable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># None sets the directive</span>

        <span class="k">if</span> <span class="s1">&#39;X-Sendfile&#39;</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Accel-Redirect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_accel_redirect</span>

            <span class="c1"># In case of X-Sendfile/X-Accel-Redirect, the body is empty,</span>
            <span class="c1"># yet werkzeug gives the length of the file. This makes</span>
            <span class="c1"># NGINX wait for content that&#39;ll never arrive.</span>
            <span class="n">res</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>

        <span class="k">return</span> <span class="n">res</span></div>
</div>



<span class="c1"># =========================================================</span>
<span class="c1"># Controller and routes</span>
<span class="c1"># =========================================================</span>

<div class="viewcode-block" id="Controller">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Controller">[docs]</a>
<span class="k">class</span> <span class="nc">Controller</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class mixin that provide module controllers the ability to serve</span>
<span class="sd">    content over http and to be extended in child modules.</span>

<span class="sd">    Each class :ref:`inheriting &lt;python:tut-inheritance&gt;` from</span>
<span class="sd">    :class:`~odoo.http.Controller` can use the :func:`~odoo.http.route`:</span>
<span class="sd">    decorator to route matching incoming web requests to decorated</span>
<span class="sd">    methods.</span>

<span class="sd">    Like models, controllers can be extended by other modules. The</span>
<span class="sd">    extension mechanism is different because controllers can work in a</span>
<span class="sd">    database-free environment and therefore cannot use</span>
<span class="sd">    :class:~odoo.api.Registry:.</span>

<span class="sd">    To *override* a controller, :ref:`inherit &lt;python:tut-inheritance&gt;`</span>
<span class="sd">    from its class, override relevant methods and re-expose them with</span>
<span class="sd">    :func:`~odoo.http.route`:. Please note that the decorators of all</span>
<span class="sd">    methods are combined, if the overriding method’s decorator has no</span>
<span class="sd">    argument all previous ones will be kept, any provided argument will</span>
<span class="sd">    override previously defined ones.</span>

<span class="sd">    .. code-block:</span>

<span class="sd">        class GreetingController(odoo.http.Controller):</span>
<span class="sd">            @route(&#39;/greet&#39;, type=&#39;http&#39;, auth=&#39;public&#39;)</span>
<span class="sd">            def greeting(self):</span>
<span class="sd">                return &#39;Hello&#39;</span>

<span class="sd">        class UserGreetingController(GreetingController):</span>
<span class="sd">            @route(auth=&#39;user&#39;)  # override auth, keep path and type</span>
<span class="sd">            def greeting(self):</span>
<span class="sd">                return super().handler()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">children_classes</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>  <span class="c1"># indexed by module</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">Controller</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">path</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;odoo&#39;</span><span class="p">,</span> <span class="s1">&#39;addons&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">Controller</span><span class="o">.</span><span class="n">children_classes</span><span class="p">[</span><span class="n">module</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span></div>



<div class="viewcode-block" id="route">
<a class="viewcode-back" href="../../odoo.html#odoo.http.route">[docs]</a>
<span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="n">route</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">routing</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorate a controller method in order to route incoming requests</span>
<span class="sd">    matching the given URL and options to the decorated method.</span>

<span class="sd">    .. warning::</span>
<span class="sd">        It is mandatory to re-decorate any method that is overridden in</span>
<span class="sd">        controller extensions but the arguments can be omitted. See</span>
<span class="sd">        :class:`~odoo.http.Controller` for more details.</span>

<span class="sd">    :param Union[str, Iterable[str]] route: The paths that the decorated</span>
<span class="sd">        method is serving. Incoming HTTP request paths matching this</span>
<span class="sd">        route will be routed to this decorated method. See `werkzeug</span>
<span class="sd">        routing documentation &lt;http://werkzeug.pocoo.org/docs/routing/&gt;`_</span>
<span class="sd">        for the format of route expressions.</span>
<span class="sd">    :param str type: The type of request, either ``&#39;json&#39;`` or</span>
<span class="sd">        ``&#39;http&#39;``. It describes where to find the request parameters</span>
<span class="sd">        and how to serialize the response.</span>
<span class="sd">    :param str auth: The authentication method, one of the following:</span>

<span class="sd">        * ``&#39;user&#39;``: The user must be authenticated and the current</span>
<span class="sd">          request will be executed using the rights of the user.</span>
<span class="sd">        * ``&#39;public&#39;``: The user may or may not be authenticated. If he</span>
<span class="sd">          isn&#39;t, the current request will be executed using the shared</span>
<span class="sd">          Public user.</span>
<span class="sd">        * ``&#39;none&#39;``: The method is always active, even if there is no</span>
<span class="sd">          database. Mainly used by the framework and authentication</span>
<span class="sd">          modules. The request code will not have any facilities to</span>
<span class="sd">          access the current user.</span>
<span class="sd">    :param Iterable[str] methods: A list of http methods (verbs) this</span>
<span class="sd">        route applies to. If not specified, all methods are allowed.</span>
<span class="sd">    :param str cors: The Access-Control-Allow-Origin cors directive value.</span>
<span class="sd">    :param bool csrf: Whether CSRF protection should be enabled for the</span>
<span class="sd">        route. Enabled by default for ``&#39;http&#39;``-type requests, disabled</span>
<span class="sd">        by default for ``&#39;json&#39;``-type requests.</span>
<span class="sd">    :param Callable[[Exception], Response] handle_params_access_error:</span>
<span class="sd">        Implement a custom behavior if an error occurred when retrieving the record</span>
<span class="sd">        from the URL parameters (access error or missing error).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">endpoint</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;function </span><span class="si">{</span><span class="n">endpoint</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">endpoint</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&gt;&quot;</span>

        <span class="c1"># Sanitize the routing</span>
        <span class="k">assert</span> <span class="n">routing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;http&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_dispatchers</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">route</span><span class="p">:</span>
            <span class="n">routing</span><span class="p">[</span><span class="s1">&#39;routes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">route</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">route</span><span class="p">]</span>
        <span class="n">wrong</span> <span class="o">=</span> <span class="n">routing</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wrong</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> defined with invalid routing parameter &#39;method&#39;, assuming &#39;methods&#39;&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="n">routing</span><span class="p">[</span><span class="s1">&#39;methods&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wrong</span>

        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">route_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
            <span class="n">params_ok</span> <span class="o">=</span> <span class="n">filter_kwargs</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="n">params_ko</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">params_ok</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">params_ko</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> called ignoring args </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">params_ko</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">params_ok</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">routing</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;http&#39;</span><span class="p">:</span>  <span class="c1"># _generate_routing_rules() ensures type is set</span>
                <span class="k">return</span> <span class="n">Response</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="n">route_wrapper</span><span class="o">.</span><span class="n">original_routing</span> <span class="o">=</span> <span class="n">routing</span>
        <span class="n">route_wrapper</span><span class="o">.</span><span class="n">original_endpoint</span> <span class="o">=</span> <span class="n">endpoint</span>
        <span class="k">return</span> <span class="n">route_wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span></div>


<span class="k">def</span> <span class="nf">_generate_routing_rules</span><span class="p">(</span><span class="n">modules</span><span class="p">,</span> <span class="n">nodb_only</span><span class="p">,</span> <span class="n">converters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Two-fold algorithm used to (1) determine which method in the</span>
<span class="sd">    controller inheritance tree should bind to what URL with respect to</span>
<span class="sd">    the list of installed modules and (2) merge the various @route</span>
<span class="sd">    arguments of said method with the @route arguments of the method it</span>
<span class="sd">    overrides.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">is_valid</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Determine if the class is defined in an addon. &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;odoo&#39;</span><span class="p">,</span> <span class="s1">&#39;addons&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">path</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">modules</span>

    <span class="k">def</span> <span class="nf">get_leaf_classes</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the classes that have no child and that have ``cls`` as</span>
<span class="sd">        ancestor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">subcls</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">is_valid</span><span class="p">(</span><span class="n">subcls</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_leaf_classes</span><span class="p">(</span><span class="n">subcls</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">is_valid</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">build_controllers</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create dummy controllers that inherit only from the controllers</span>
<span class="sd">        defined at the given ``modules`` (often system wide modules or</span>
<span class="sd">        installed modules). Modules in this context are Odoo addons.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Controllers defined outside of odoo addons are outside of the</span>
        <span class="c1"># controller inheritance/extension mechanism.</span>
        <span class="k">yield from</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">()</span> <span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="n">Controller</span><span class="o">.</span><span class="n">children_classes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">[]))</span>

        <span class="c1"># Controllers defined inside of odoo addons can be extended in</span>
        <span class="c1"># other installed addons. Rebuild the class inheritance here.</span>
        <span class="n">highest_controllers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
            <span class="n">highest_controllers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">Controller</span><span class="o">.</span><span class="n">children_classes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="p">[]))</span>

        <span class="k">for</span> <span class="n">top_ctrl</span> <span class="ow">in</span> <span class="n">highest_controllers</span><span class="p">:</span>
            <span class="n">leaf_controllers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">get_leaf_classes</span><span class="p">(</span><span class="n">top_ctrl</span><span class="p">)))</span>

            <span class="n">name</span> <span class="o">=</span> <span class="n">top_ctrl</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">if</span> <span class="n">leaf_controllers</span> <span class="o">!=</span> <span class="p">[</span><span class="n">top_ctrl</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">+=</span> <span class="s1">&#39; (extended by </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span>  <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">bot_ctrl</span><span class="o">.</span><span class="vm">__name__</span>
                    <span class="k">for</span> <span class="n">bot_ctrl</span> <span class="ow">in</span> <span class="n">leaf_controllers</span>
                    <span class="k">if</span> <span class="n">bot_ctrl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">top_ctrl</span>
                <span class="p">)</span>

            <span class="n">Ctrl</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">leaf_controllers</span><span class="p">)),</span> <span class="p">{})</span>
            <span class="k">yield</span> <span class="n">Ctrl</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="n">build_controllers</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">method_name</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">):</span>

            <span class="c1"># Skip this method if it is not @route decorated anywhere in</span>
            <span class="c1"># the hierarchy</span>
            <span class="k">def</span> <span class="nf">is_method_a_route</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s1">&#39;original_routing&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">is_method_a_route</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">ctrl</span><span class="p">)</span><span class="o">.</span><span class="n">mro</span><span class="p">())):</span>
                <span class="k">continue</span>

            <span class="n">merged_routing</span> <span class="o">=</span> <span class="p">{</span>
                <span class="c1"># &#39;type&#39;: &#39;http&#39;,  # set below</span>
                <span class="s1">&#39;auth&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>
                <span class="s1">&#39;methods&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;routes&#39;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s1">&#39;readonly&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">unique</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">ctrl</span><span class="p">)</span><span class="o">.</span><span class="n">mro</span><span class="p">()[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])):</span>  <span class="c1"># ancestors first</span>
                <span class="k">if</span> <span class="n">method_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">submethod</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">method_name</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">submethod</span><span class="p">,</span> <span class="s1">&#39;original_routing&#39;</span><span class="p">):</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The endpoint </span><span class="si">%s</span><span class="s2"> is not decorated by @route(), decorating it myself.&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">method_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">submethod</span> <span class="o">=</span> <span class="n">route</span><span class="p">()(</span><span class="n">submethod</span><span class="p">)</span>

                <span class="n">_check_and_complete_route_definition</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">submethod</span><span class="p">,</span> <span class="n">merged_routing</span><span class="p">)</span>

                <span class="n">merged_routing</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">submethod</span><span class="o">.</span><span class="n">original_routing</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">merged_routing</span><span class="p">[</span><span class="s1">&#39;routes&#39;</span><span class="p">]:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is a controller endpoint without any route, skipping.&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">method_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">nodb_only</span> <span class="ow">and</span> <span class="n">merged_routing</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">merged_routing</span><span class="p">[</span><span class="s1">&#39;routes&#39;</span><span class="p">]:</span>
                <span class="c1"># duplicates the function (partial) with a copy of the</span>
                <span class="c1"># original __dict__ (update_wrapper) to keep a reference</span>
                <span class="c1"># to `original_routing` and `original_endpoint`, assign</span>
                <span class="c1"># the merged routing ONLY on the duplicated function to</span>
                <span class="c1"># ensure method&#39;s immutability.</span>
                <span class="n">endpoint</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
                <span class="n">functools</span><span class="o">.</span><span class="n">update_wrapper</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
                <span class="n">endpoint</span><span class="o">.</span><span class="n">routing</span> <span class="o">=</span> <span class="n">merged_routing</span>

                <span class="k">yield</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_and_complete_route_definition</span><span class="p">(</span><span class="n">controller_cls</span><span class="p">,</span> <span class="n">submethod</span><span class="p">,</span> <span class="n">merged_routing</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify and complete the route definition.</span>

<span class="sd">    * Ensure &#39;type&#39; is defined on each method&#39;s own routing.</span>
<span class="sd">    * also ensure overrides don&#39;t change the routing type.</span>

<span class="sd">    :param submethod: route method</span>
<span class="sd">    :param dict merged_routing: accumulated routing values (defaults + submethod ancestor methods)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default_type</span> <span class="o">=</span> <span class="n">submethod</span><span class="o">.</span><span class="n">original_routing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;http&#39;</span><span class="p">)</span>
    <span class="n">routing_type</span> <span class="o">=</span> <span class="n">merged_routing</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="n">default_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">submethod</span><span class="o">.</span><span class="n">original_routing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">routing_type</span><span class="p">):</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;The endpoint </span><span class="si">%s</span><span class="s2"> changes the route type, using the original type: </span><span class="si">%r</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">controller_cls</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">controller_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">submethod</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">routing_type</span><span class="p">)</span>
    <span class="n">submethod</span><span class="o">.</span><span class="n">original_routing</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">routing_type</span>

<span class="c1"># =========================================================</span>
<span class="c1"># Session</span>
<span class="c1"># =========================================================</span>

<div class="viewcode-block" id="FilesystemSessionStore">
<a class="viewcode-back" href="../../odoo.html#odoo.http.FilesystemSessionStore">[docs]</a>
<span class="k">class</span> <span class="nc">FilesystemSessionStore</span><span class="p">(</span><span class="n">sessions</span><span class="o">.</span><span class="n">FilesystemSessionStore</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Place where to load and save session objects. &quot;&quot;&quot;</span>
<div class="viewcode-block" id="FilesystemSessionStore.get_session_filename">
<a class="viewcode-back" href="../../odoo.html#odoo.http.FilesystemSessionStore.get_session_filename">[docs]</a>
    <span class="k">def</span> <span class="nf">get_session_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">):</span>
        <span class="c1"># scatter sessions across 256 directories</span>
        <span class="n">sha_dir</span> <span class="o">=</span> <span class="n">sid</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">sha_dir</span><span class="p">)</span>
        <span class="n">session_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">sid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">session_path</span></div>


<div class="viewcode-block" id="FilesystemSessionStore.save">
<a class="viewcode-back" href="../../odoo.html#odoo.http.FilesystemSessionStore.save">[docs]</a>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="n">session_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_session_filename</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">sid</span><span class="p">)</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">session_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="mo">0o0755</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">session</span><span class="p">)</span></div>


<div class="viewcode-block" id="FilesystemSessionStore.get">
<a class="viewcode-back" href="../../odoo.html#odoo.http.FilesystemSessionStore.get">[docs]</a>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">):</span>
        <span class="c1"># retro compatibility</span>
        <span class="n">old_path</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_session_filename</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
        <span class="n">session_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_session_filename</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">old_path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">session_path</span><span class="p">):</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">session_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="mo">0o0755</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">old_path</span><span class="p">,</span> <span class="n">session_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span></div>


<div class="viewcode-block" id="FilesystemSessionStore.rotate">
<a class="viewcode-back" href="../../odoo.html#odoo.http.FilesystemSessionStore.rotate">[docs]</a>
    <span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_key</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">uid</span> <span class="ow">and</span> <span class="n">env</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">session_token</span> <span class="o">=</span> <span class="n">security</span><span class="o">.</span><span class="n">compute_session_token</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">should_rotate</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">session</span><span class="p">)</span></div>


<div class="viewcode-block" id="FilesystemSessionStore.vacuum">
<a class="viewcode-back" href="../../odoo.html#odoo.http.FilesystemSessionStore.vacuum">[docs]</a>
    <span class="k">def</span> <span class="nf">vacuum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_lifetime</span><span class="o">=</span><span class="n">SESSION_LIFETIME</span><span class="p">):</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">max_lifetime</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">session_store</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">session_store</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">OSError</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Session">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Session">[docs]</a>
<span class="k">class</span> <span class="nc">Session</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Structure containing data persisted across requests. &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;can_save&#39;</span><span class="p">,</span> <span class="s1">&#39;_Session__data&#39;</span><span class="p">,</span> <span class="s1">&#39;is_dirty&#39;</span><span class="p">,</span> <span class="s1">&#39;is_explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;is_new&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;should_rotate&#39;</span><span class="p">,</span> <span class="s1">&#39;sid&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">can_save</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_dirty</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_explicit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_new</span> <span class="o">=</span> <span class="n">new</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">should_rotate</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">sid</span>

    <span class="c1">#</span>
    <span class="c1"># MutableMapping implementation with DocDict-like extension</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;geoip&#39;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;request.session.geoip have been moved to request.geoip&#39;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">geoip</span> <span class="k">if</span> <span class="n">request</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_dirty</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_dirty</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__slots__</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

<div class="viewcode-block" id="Session.clear">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Session.clear">[docs]</a>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_dirty</span> <span class="o">=</span> <span class="kc">True</span></div>


    <span class="c1">#</span>
    <span class="c1"># Session methods</span>
    <span class="c1">#</span>
<div class="viewcode-block" id="Session.authenticate">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Session.authenticate">[docs]</a>
    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbname</span><span class="p">,</span> <span class="n">login</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Authenticate the current user with the given db, login and</span>
<span class="sd">        password. If successful, store the authentication parameters in</span>
<span class="sd">        the current session, unless multi-factor-auth (MFA) is</span>
<span class="sd">        activated. In that case, that last part will be done by</span>
<span class="sd">        :ref:`finalize`.</span>

<span class="sd">        .. versionchanged:: saas-15.3</span>
<span class="sd">           The current request is no longer updated using the user and</span>
<span class="sd">           context of the session when the authentication is done using</span>
<span class="sd">           a database different than request.db. It is up to the caller</span>
<span class="sd">           to open a new cursor/registry/env on the given database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wsgienv</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;interactive&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;base_location&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">url_root</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">),</span>
            <span class="s1">&#39;HTTP_HOST&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HTTP_HOST&#39;</span><span class="p">],</span>
            <span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="n">registry</span> <span class="o">=</span> <span class="n">Registry</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span>
        <span class="n">pre_uid</span> <span class="o">=</span> <span class="n">registry</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">wsgienv</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_login</span> <span class="o">=</span> <span class="n">login</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_uid</span> <span class="o">=</span> <span class="n">pre_uid</span>

        <span class="k">with</span> <span class="n">registry</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cr</span><span class="p">:</span>
            <span class="n">env</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">pre_uid</span><span class="p">,</span> <span class="p">{})</span>

            <span class="c1"># if 2FA is disabled we finalize immediately</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">pre_uid</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">_mfa_url</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">request</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span> <span class="ow">is</span> <span class="bp">self</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">db</span> <span class="o">==</span> <span class="n">dbname</span><span class="p">:</span>
            <span class="c1"># Like update_env(user=request.session.uid) but works when uid is None</span>
            <span class="n">request</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
            <span class="n">request</span><span class="o">.</span><span class="n">update_context</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
            <span class="c1"># request env needs to be able to access the latest changes from the auth layers</span>
            <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">pre_uid</span></div>


<div class="viewcode-block" id="Session.finalize">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Session.finalize">[docs]</a>
    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finalizes a partial session, should be called on MFA validation</span>
<span class="sd">        to convert a partial / pre-session into a logged-in one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">login</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;pre_login&#39;</span><span class="p">)</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;pre_uid&#39;</span><span class="p">)</span>

        <span class="n">env</span> <span class="o">=</span> <span class="n">env</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">uid</span><span class="p">)</span>
        <span class="n">user_context</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">context_get</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">should_rotate</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;db&#39;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">db_name</span><span class="p">,</span>
            <span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="n">login</span><span class="p">,</span>
            <span class="s1">&#39;uid&#39;</span><span class="p">:</span> <span class="n">uid</span><span class="p">,</span>
            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="n">user_context</span><span class="p">,</span>
            <span class="s1">&#39;session_token&#39;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">_compute_session_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">),</span>
        <span class="p">})</span></div>


<div class="viewcode-block" id="Session.logout">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Session.logout">[docs]</a>
    <span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep_db</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="k">if</span> <span class="n">keep_db</span> <span class="k">else</span> <span class="n">get_default_session</span><span class="p">()[</span><span class="s1">&#39;db&#39;</span><span class="p">]</span>  <span class="c1"># None</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">get_default_session</span><span class="p">(),</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;lang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">default_lang</span><span class="p">()</span> <span class="k">if</span> <span class="n">request</span> <span class="k">else</span> <span class="n">DEFAULT_LANG</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">should_rotate</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">request</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="p">:</span>
            <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.http&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_post_logout</span><span class="p">()</span></div>


<div class="viewcode-block" id="Session.touch">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Session.touch">[docs]</a>
    <span class="k">def</span> <span class="nf">touch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_dirty</span> <span class="o">=</span> <span class="kc">True</span></div>
</div>




<span class="c1"># =========================================================</span>
<span class="c1"># GeoIP</span>
<span class="c1"># =========================================================</span>

<div class="viewcode-block" id="GeoIP">
<a class="viewcode-back" href="../../odoo.html#odoo.http.GeoIP">[docs]</a>
<span class="k">class</span> <span class="nc">GeoIP</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ip Geolocalization utility, determine information such as the</span>
<span class="sd">    country or the timezone of the user based on their IP Address.</span>

<span class="sd">    The instances share the same API as `:class:`geoip2.models.City`</span>
<span class="sd">    &lt;https://geoip2.readthedocs.io/en/latest/#geoip2.models.City&gt;`_.</span>

<span class="sd">    When the IP couldn&#39;t be geolocalized (missing database, bad address)</span>
<span class="sd">    then an empty object is returned. This empty object can be used like</span>
<span class="sd">    a regular one with the exception that all info are set None.</span>

<span class="sd">    :param str ip: The IP Address to geo-localize</span>

<span class="sd">    .. note:</span>

<span class="sd">        The geoip info the the current request are available at</span>
<span class="sd">        :attr:`~odoo.http.request.geoip`.</span>

<span class="sd">    .. code-block:</span>

<span class="sd">        &gt;&gt;&gt; GeoIP(&#39;127.0.0.1&#39;).country.iso_code</span>
<span class="sd">        &gt;&gt;&gt; odoo_ip = socket.gethostbyname(&#39;odoo.com&#39;)</span>
<span class="sd">        &gt;&gt;&gt; GeoIP(odoo_ip).country.iso_code</span>
<span class="sd">        &#39;FR&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">_city_record</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">root</span><span class="o">.</span><span class="n">geoip_city_db</span><span class="o">.</span><span class="n">city</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">maxminddb</span><span class="o">.</span><span class="n">InvalidDatabaseError</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">GEOIP_EMPTY_CITY</span>
        <span class="k">except</span> <span class="n">geoip2</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">AddressNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">GEOIP_EMPTY_CITY</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">_country_record</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;_city_record&#39;</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># the City class inherits from the Country class and the</span>
            <span class="c1"># city record is in cache already, save a geolocalization</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_city_record</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">root</span><span class="o">.</span><span class="n">geoip_country_db</span><span class="o">.</span><span class="n">country</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">maxminddb</span><span class="o">.</span><span class="n">InvalidDatabaseError</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_city_record</span>
        <span class="k">except</span> <span class="n">geoip2</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">AddressNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">GEOIP_EMPTY_COUNTRY</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">country_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">country</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">continent</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">country_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">country</span><span class="o">.</span><span class="n">iso_code</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">continent</span><span class="o">.</span><span class="n">code</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="c1"># Be smart and determine whether the attribute exists on the</span>
        <span class="c1"># country object or on the city object.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">GEOIP_EMPTY_COUNTRY</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_country_record</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">GEOIP_EMPTY_CITY</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_city_record</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> has no attribute </span><span class="si">{</span><span class="n">attr</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">country_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="c1"># Old dict API, undocumented for now, will be deprecated some day</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;country_name&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">country_name</span>

        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;country_code&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">country_code</span>

        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;city&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">city</span><span class="o">.</span><span class="n">name</span>

        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;latitude&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">latitude</span>

        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;longitude&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">longitude</span>

        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;region&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdivisions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">iso_code</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdivisions</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;time_zone&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">time_zone</span>

        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;The dictionnary GeoIP API is deprecated.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;The dictionnary GeoIP API is deprecated.&quot;</span><span class="p">)</span></div>


<span class="c1"># =========================================================</span>
<span class="c1"># Request and Response</span>
<span class="c1"># =========================================================</span>

<span class="c1"># Thread local global request object</span>
<span class="n">_request_stack</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">local</span><span class="o">.</span><span class="n">LocalStack</span><span class="p">()</span>
<span class="n">request</span> <span class="o">=</span> <span class="n">_request_stack</span><span class="p">()</span>

<div class="viewcode-block" id="borrow_request">
<a class="viewcode-back" href="../../odoo.html#odoo.http.borrow_request">[docs]</a>
<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">borrow_request</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Get the current request and unexpose it from the local stack. &quot;&quot;&quot;</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">_request_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">req</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">_request_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">req</span><span class="p">)</span></div>



<div class="viewcode-block" id="make_request_wrap_methods">
<a class="viewcode-back" href="../../odoo.html#odoo.http.make_request_wrap_methods">[docs]</a>
<span class="k">def</span> <span class="nf">make_request_wrap_methods</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">getter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_HTTPRequest__wrapped</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_HTTPRequest__wrapped</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">getter</span><span class="p">,</span> <span class="n">setter</span></div>



<div class="viewcode-block" id="HTTPRequest">
<a class="viewcode-back" href="../../odoo.html#odoo.http.HTTPRequest">[docs]</a>
<span class="k">class</span> <span class="nc">HTTPRequest</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">):</span>
        <span class="n">httprequest</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">wrappers</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">httprequest</span><span class="o">.</span><span class="n">user_agent_class</span> <span class="o">=</span> <span class="n">UserAgent</span>  <span class="c1"># use vendored userAgent since it will be removed in 2.1</span>
        <span class="n">httprequest</span><span class="o">.</span><span class="n">parameter_storage_class</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">datastructures</span><span class="o">.</span><span class="n">ImmutableOrderedMultiDict</span>
        <span class="n">httprequest</span><span class="o">.</span><span class="n">max_content_length</span> <span class="o">=</span> <span class="n">DEFAULT_MAX_CONTENT_LENGTH</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__wrapped</span> <span class="o">=</span> <span class="n">httprequest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__environ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__wrapped</span><span class="o">.</span><span class="n">environ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environ</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">value</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__environ</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;werkzeug.&#39;</span><span class="p">,</span> <span class="s1">&#39;wsgi.&#39;</span><span class="p">,</span> <span class="s1">&#39;socket&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;wsgi.url_scheme&#39;</span><span class="p">])</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span></div>



<span class="n">HTTPREQUEST_ATTRIBUTES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;__str__&#39;</span><span class="p">,</span> <span class="s1">&#39;__repr__&#39;</span><span class="p">,</span> <span class="s1">&#39;__exit__&#39;</span><span class="p">,</span>
    <span class="s1">&#39;accept_charsets&#39;</span><span class="p">,</span> <span class="s1">&#39;accept_languages&#39;</span><span class="p">,</span> <span class="s1">&#39;accept_mimetypes&#39;</span><span class="p">,</span> <span class="s1">&#39;access_route&#39;</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">,</span> <span class="s1">&#39;authorization&#39;</span><span class="p">,</span> <span class="s1">&#39;base_url&#39;</span><span class="p">,</span>
    <span class="s1">&#39;charset&#39;</span><span class="p">,</span> <span class="s1">&#39;content_encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;content_length&#39;</span><span class="p">,</span> <span class="s1">&#39;content_md5&#39;</span><span class="p">,</span> <span class="s1">&#39;content_type&#39;</span><span class="p">,</span> <span class="s1">&#39;cookies&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span>
    <span class="s1">&#39;encoding_errors&#39;</span><span class="p">,</span> <span class="s1">&#39;files&#39;</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="s1">&#39;full_path&#39;</span><span class="p">,</span> <span class="s1">&#39;get_data&#39;</span><span class="p">,</span> <span class="s1">&#39;get_json&#39;</span><span class="p">,</span> <span class="s1">&#39;headers&#39;</span><span class="p">,</span> <span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="s1">&#39;host_url&#39;</span><span class="p">,</span> <span class="s1">&#39;if_match&#39;</span><span class="p">,</span>
    <span class="s1">&#39;if_modified_since&#39;</span><span class="p">,</span> <span class="s1">&#39;if_none_match&#39;</span><span class="p">,</span> <span class="s1">&#39;if_range&#39;</span><span class="p">,</span> <span class="s1">&#39;if_unmodified_since&#39;</span><span class="p">,</span> <span class="s1">&#39;is_json&#39;</span><span class="p">,</span> <span class="s1">&#39;is_secure&#39;</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
    <span class="s1">&#39;max_content_length&#39;</span><span class="p">,</span> <span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;mimetype&#39;</span><span class="p">,</span> <span class="s1">&#39;mimetype_params&#39;</span><span class="p">,</span> <span class="s1">&#39;origin&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;pragma&#39;</span><span class="p">,</span> <span class="s1">&#39;query_string&#39;</span><span class="p">,</span> <span class="s1">&#39;range&#39;</span><span class="p">,</span>
    <span class="s1">&#39;referrer&#39;</span><span class="p">,</span> <span class="s1">&#39;remote_addr&#39;</span><span class="p">,</span> <span class="s1">&#39;remote_user&#39;</span><span class="p">,</span> <span class="s1">&#39;root_path&#39;</span><span class="p">,</span> <span class="s1">&#39;root_url&#39;</span><span class="p">,</span> <span class="s1">&#39;scheme&#39;</span><span class="p">,</span> <span class="s1">&#39;script_root&#39;</span><span class="p">,</span> <span class="s1">&#39;server&#39;</span><span class="p">,</span> <span class="s1">&#39;session&#39;</span><span class="p">,</span>
    <span class="s1">&#39;trusted_hosts&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;url_charset&#39;</span><span class="p">,</span> <span class="s1">&#39;url_root&#39;</span><span class="p">,</span> <span class="s1">&#39;user_agent&#39;</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">,</span>
<span class="p">]</span>
<span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">HTTPREQUEST_ATTRIBUTES</span><span class="p">:</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">HTTPRequest</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="nb">property</span><span class="p">(</span><span class="o">*</span><span class="n">make_request_wrap_methods</span><span class="p">(</span><span class="n">attr</span><span class="p">)))</span>


<div class="viewcode-block" id="Response">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Response">[docs]</a>
<span class="k">class</span> <span class="nc">Response</span><span class="p">(</span><span class="n">werkzeug</span><span class="o">.</span><span class="n">wrappers</span><span class="o">.</span><span class="n">Response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Outgoing HTTP response with body, status, headers and qweb support.</span>
<span class="sd">    In addition to the :class:`werkzeug.wrappers.Response` parameters,</span>
<span class="sd">    this class&#39;s constructor can take the following additional</span>
<span class="sd">    parameters for QWeb Lazy Rendering.</span>

<span class="sd">    :param str template: template to render</span>
<span class="sd">    :param dict qcontext: Rendering context to use</span>
<span class="sd">    :param int uid: User id to use for the ir.ui.view render call,</span>
<span class="sd">        ``None`` to use the request&#39;s user (the default)</span>

<span class="sd">    these attributes are available as parameters on the Response object</span>
<span class="sd">    and can be altered at any time before rendering</span>

<span class="sd">    Also exposes all the attributes and methods of</span>
<span class="sd">    :class:`werkzeug.wrappers.Response`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default_mimetype</span> <span class="o">=</span> <span class="s1">&#39;text/html&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;template&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">qcontext</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;qcontext&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;uid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_default</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">qcontext</span><span class="p">,</span> <span class="n">uid</span><span class="p">)</span>

<div class="viewcode-block" id="Response.load">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Response.load">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="s2">&quot;&lt;function&gt;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the return value of an endpoint into a Response.</span>

<span class="sd">        :param result: The endpoint return value to load the Response from.</span>
<span class="sd">        :type result: Union[Response, werkzeug.wrappers.BaseResponse,</span>
<span class="sd">            werkzeug.exceptions.HTTPException, str, bytes, NoneType]</span>
<span class="sd">        :param str fname: The endpoint function name wherefrom the</span>
<span class="sd">            result emanated, used for logging.</span>
<span class="sd">        :returns: The created :class:`~odoo.http.Response`.</span>
<span class="sd">        :rtype: Response</span>
<span class="sd">        :raises TypeError: When ``result`` type is none of the above-</span>
<span class="sd">            mentioned type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Response</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPException</span><span class="p">):</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> returns an HTTPException instead of raising it.&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">result</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">wrappers</span><span class="o">.</span><span class="n">Response</span><span class="p">):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">force_type</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">set_default</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">response</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2"> returns an invalid value: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Response.set_default">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Response.set_default">[docs]</a>
    <span class="k">def</span> <span class="nf">set_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qcontext</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qcontext</span> <span class="o">=</span> <span class="n">qcontext</span> <span class="ow">or</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qcontext</span><span class="p">[</span><span class="s1">&#39;response_template&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">uid</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_qweb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<div class="viewcode-block" id="Response.render">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Response.render">[docs]</a>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Renders the Response&#39;s template, returns the result. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qcontext</span><span class="p">[</span><span class="s1">&#39;request&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;ir.ui.view&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">_render_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qcontext</span><span class="p">)</span></div>


<div class="viewcode-block" id="Response.flatten">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Response.flatten">[docs]</a>
    <span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forces the rendering of the response&#39;s template, sets the result</span>
<span class="sd">        as response body and unsets :attr:`.template`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Response.set_cookie">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Response.set_cookie">[docs]</a>
    <span class="k">def</span> <span class="nf">set_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expires</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">httponly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">samesite</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cookie_type</span><span class="o">=</span><span class="s1">&#39;required&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The default expires in Werkzeug is None, which means a session cookie.</span>
<span class="sd">        We want to continue to support the session cookie, but not by default.</span>
<span class="sd">        Now the default is arbitrary 1 year.</span>
<span class="sd">        So if you want a cookie of session, you have to explicitly pass expires=None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">expires</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># not provided value -&gt; default value -&gt; 1 year</span>
            <span class="n">expires</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">db</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.http&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_is_allowed_cookie</span><span class="p">(</span><span class="n">cookie_type</span><span class="p">):</span>
            <span class="n">max_age</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="n">max_age</span><span class="p">,</span> <span class="n">expires</span><span class="o">=</span><span class="n">expires</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">,</span> <span class="n">httponly</span><span class="o">=</span><span class="n">httponly</span><span class="p">,</span> <span class="n">samesite</span><span class="o">=</span><span class="n">samesite</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="FutureResponse">
<a class="viewcode-back" href="../../odoo.html#odoo.http.FutureResponse">[docs]</a>
<span class="k">class</span> <span class="nc">FutureResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    werkzeug.Response mock class that only serves as placeholder for</span>
<span class="sd">    headers to be injected in the final response.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># used by werkzeug.Response.set_cookie</span>
    <span class="n">charset</span> <span class="o">=</span> <span class="s1">&#39;utf-8&#39;</span>
    <span class="n">max_cookie_size</span> <span class="o">=</span> <span class="mi">4093</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">datastructures</span><span class="o">.</span><span class="n">Headers</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_charset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">charset</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">werkzeug</span><span class="o">.</span><span class="n">Response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">expires</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">httponly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">samesite</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cookie_type</span><span class="o">=</span><span class="s1">&#39;required&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">expires</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># not forced value -&gt; default value -&gt; 1 year</span>
            <span class="n">expires</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">365</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">db</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.http&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_is_allowed_cookie</span><span class="p">(</span><span class="n">cookie_type</span><span class="p">):</span>
            <span class="n">max_age</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">werkzeug</span><span class="o">.</span><span class="n">Response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="n">max_age</span><span class="p">,</span> <span class="n">expires</span><span class="o">=</span><span class="n">expires</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">,</span> <span class="n">httponly</span><span class="o">=</span><span class="n">httponly</span><span class="p">,</span> <span class="n">samesite</span><span class="o">=</span><span class="n">samesite</span><span class="p">)</span></div>



<div class="viewcode-block" id="Request">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Request">[docs]</a>
<span class="k">class</span> <span class="nc">Request</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper around the incoming HTTP request with deserialized request</span>
<span class="sd">    parameters, session utilities and request dispatching logic.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">httprequest</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span> <span class="o">=</span> <span class="n">httprequest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">future_response</span> <span class="o">=</span> <span class="n">FutureResponse</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatcher</span> <span class="o">=</span> <span class="n">_dispatchers</span><span class="p">[</span><span class="s1">&#39;http&#39;</span><span class="p">](</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># until we match</span>
        <span class="c1">#self.params = {}  # set by the Dispatcher</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">geoip</span> <span class="o">=</span> <span class="n">GeoIP</span><span class="p">(</span><span class="n">httprequest</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_post_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_session_and_dbname</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_session_and_dbname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The session is explicit when it comes from the query-string or</span>
        <span class="c1"># the header. It is implicit when it comes from the cookie or</span>
        <span class="c1"># that is does not exist yet. The explicit session should be</span>
        <span class="c1"># used in this request only, it should not be saved on the</span>
        <span class="c1"># response cookie.</span>
        <span class="n">sid</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X-Openerp-Session-Id&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">sid</span><span class="p">:</span>
            <span class="n">is_explicit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">)</span>
            <span class="n">is_explicit</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">sid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">session_store</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">session_store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">sid</span>  <span class="c1"># in case the session was not persisted</span>
        <span class="n">session</span><span class="o">.</span><span class="n">is_explicit</span> <span class="o">=</span> <span class="n">is_explicit</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">get_default_session</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">session</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">):</span>
            <span class="n">session</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;lang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_lang</span><span class="p">()</span>

        <span class="n">dbname</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HTTP_HOST&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">db</span> <span class="ow">and</span> <span class="n">db_filter</span><span class="p">([</span><span class="n">session</span><span class="o">.</span><span class="n">db</span><span class="p">],</span> <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">):</span>
            <span class="n">dbname</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">db</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_dbs</span> <span class="o">=</span> <span class="n">db_list</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_dbs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dbname</span> <span class="o">=</span> <span class="n">all_dbs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># monodb</span>

        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">db</span> <span class="o">!=</span> <span class="n">dbname</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Logged into database </span><span class="si">%r</span><span class="s2">, but dbfilter rejects it; logging session out.&quot;</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">logout</span><span class="p">(</span><span class="n">keep_db</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">dbname</span>

        <span class="n">session</span><span class="o">.</span><span class="n">is_dirty</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">session</span><span class="p">,</span> <span class="n">dbname</span>

    <span class="c1"># =====================================================</span>
    <span class="c1"># Getters and setters</span>
    <span class="c1"># =====================================================</span>
<div class="viewcode-block" id="Request.update_env">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Request.update_env">[docs]</a>
    <span class="k">def</span> <span class="nf">update_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">su</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Update the environment of the current request.</span>

<span class="sd">        :param user: optional user/user id to change the current user</span>
<span class="sd">        :type user: int or :class:`res.users record&lt;~odoo.addons.base.models.res_users.Users&gt;`</span>
<span class="sd">        :param dict context: optional context dictionary to change the current context</span>
<span class="sd">        :param bool su: optional boolean to change the superuser mode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># None is a sentinel, it keeps the same cursor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">su</span><span class="p">)</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span></div>


<div class="viewcode-block" id="Request.update_context">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Request.update_context">[docs]</a>
    <span class="k">def</span> <span class="nf">update_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">overrides</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Override the environment context of the current request with the</span>
<span class="sd">        values of ``overrides``. To replace the entire context, please</span>
<span class="sd">        use :meth:`~update_env` instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_env</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">overrides</span><span class="p">))</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span>

    <span class="nd">@context</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Use request.update_context instead.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span>

    <span class="nd">@uid</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">uid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Use request.update_env instead.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span>

    <span class="nd">@cr</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">cr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Close the cursor instead.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You cannot replace the cursor attached to the current request.&quot;</span><span class="p">)</span>

    <span class="n">_cr</span> <span class="o">=</span> <span class="n">cr</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">best_lang</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">accept_languages</span><span class="o">.</span><span class="n">best</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lang</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">code</span><span class="p">,</span> <span class="n">territory</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">babel</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">parse_locale</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">territory</span><span class="p">:</span>
                <span class="n">lang</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">territory</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lang</span> <span class="o">=</span> <span class="n">babel</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">LOCALE_ALIASES</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">lang</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># =====================================================</span>
    <span class="c1"># Helpers</span>
    <span class="c1"># =====================================================</span>
<div class="viewcode-block" id="Request.csrf_token">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Request.csrf_token">[docs]</a>
    <span class="k">def</span> <span class="nf">csrf_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates and returns a CSRF token for the current session</span>

<span class="sd">        :param Optional[int] time_limit: the CSRF token should only be</span>
<span class="sd">            valid for the specified duration (in second), by default</span>
<span class="sd">            48h, ``None`` for the token to be valid as long as the</span>
<span class="sd">            current user&#39;s session is.</span>
<span class="sd">        :returns: ASCII token string</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">secret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.config_parameter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;database.secret&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">secret</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CSRF protection requires a configured database secret&quot;</span><span class="p">)</span>

        <span class="c1"># if no `time_limit` =&gt; distant 1y expiry so max_ts acts as salt, e.g. vs BREACH</span>
        <span class="n">max_ts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="n">time_limit</span> <span class="ow">or</span> <span class="n">CSRF_TOKEN_SALT</span><span class="p">))</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">sid</span><span class="si">}{</span><span class="n">max_ts</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="n">hm</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">secret</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hm</span><span class="si">}</span><span class="s1">o</span><span class="si">{</span><span class="n">max_ts</span><span class="si">}</span><span class="s1">&#39;</span></div>


<div class="viewcode-block" id="Request.validate_csrf">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Request.validate_csrf">[docs]</a>
    <span class="k">def</span> <span class="nf">validate_csrf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csrf</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Is the given csrf token valid ?</span>

<span class="sd">        :param str csrf: The token to validate.</span>
<span class="sd">        :returns: ``True`` when valid, ``False`` when not.</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">csrf</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">secret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.config_parameter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;database.secret&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">secret</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CSRF protection requires a configured database secret&quot;</span><span class="p">)</span>

        <span class="n">hm</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">max_ts</span> <span class="o">=</span> <span class="n">csrf</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">sid</span><span class="si">}{</span><span class="n">max_ts</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">max_ts</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_ts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()):</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="n">hm_expected</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">secret</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span> <span class="n">msg</span><span class="p">,</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">consteq</span><span class="p">(</span><span class="n">hm</span><span class="p">,</span> <span class="n">hm_expected</span><span class="p">)</span></div>


<div class="viewcode-block" id="Request.default_context">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Request.default_context">[docs]</a>
    <span class="k">def</span> <span class="nf">default_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">get_default_session</span><span class="p">()[</span><span class="s1">&#39;context&#39;</span><span class="p">],</span> <span class="n">lang</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_lang</span><span class="p">())</span></div>


<div class="viewcode-block" id="Request.default_lang">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Request.default_lang">[docs]</a>
    <span class="k">def</span> <span class="nf">default_lang</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns default user language according to request specification</span>

<span class="sd">        :returns: Preferred language if specified or &#39;en_US&#39;</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_lang</span> <span class="ow">or</span> <span class="n">DEFAULT_LANG</span></div>


<div class="viewcode-block" id="Request.get_http_params">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Request.get_http_params">[docs]</a>
    <span class="k">def</span> <span class="nf">get_http_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract key=value pairs from the query string and the forms</span>
<span class="sd">        present in the body (both application/x-www-form-urlencoded and</span>
<span class="sd">        multipart/form-data).</span>

<span class="sd">        :returns: The merged key-value pairs.</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">form</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">files</span>
        <span class="p">}</span>
        <span class="n">params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">params</span></div>


<div class="viewcode-block" id="Request.get_json_data">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Request.get_json_data">[docs]</a>
    <span class="k">def</span> <span class="nf">get_json_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">as_text</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span></div>


    <span class="k">def</span> <span class="nf">_get_profiler_context_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a profiler when the profiling is enabled and the requested</span>
<span class="sd">        URL is profile-safe. Otherwise, get a context-manager that does</span>
<span class="sd">        nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">profile_session</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">profile_expiration</span> <span class="o">&lt;</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()):</span>
                <span class="c1"># avoid having session profiling for too long if user forgets to disable profiling</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">profile_session</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Profiling expiration reached, disabling profiling&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;set_profiling&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Profiling disabled on set_profiling route&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/websocket&#39;</span><span class="p">):</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Profiling disabled for websocket&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">odoo</span><span class="o">.</span><span class="n">evented</span><span class="p">:</span>
                <span class="c1"># only longpolling should be in a evented server, but this is an additional safety</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Profiling disabled for evented server&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">profiler</span><span class="o">.</span><span class="n">Profiler</span><span class="p">(</span>
                        <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span>
                        <span class="n">description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">full_path</span><span class="p">,</span>
                        <span class="n">profile_session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">profile_session</span><span class="p">,</span>
                        <span class="n">collectors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">profile_collectors</span><span class="p">,</span>
                        <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">profile_params</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failure during Profiler creation&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">profile_session</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">nullcontext</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_inject_future_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">future_response</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>

<div class="viewcode-block" id="Request.make_response">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Request.make_response">[docs]</a>
    <span class="k">def</span> <span class="nf">make_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Helper for non-HTML responses, or HTML responses with custom</span>
<span class="sd">        response headers or cookies.</span>

<span class="sd">        While handlers can just return the HTML markup of a page they want to</span>
<span class="sd">        send as a string if non-HTML data is returned they need to create a</span>
<span class="sd">        complete response object, or the returned data will not be correctly</span>
<span class="sd">        interpreted by the clients.</span>

<span class="sd">        :param str data: response body</span>
<span class="sd">        :param int status: http status code</span>
<span class="sd">        :param headers: HTTP headers to set on the response</span>
<span class="sd">        :type headers: ``[(name, value)]``</span>
<span class="sd">        :param collections.abc.Mapping cookies: cookies to set on the client</span>
<span class="sd">        :returns: a response object.</span>
<span class="sd">        :rtype: :class:`~odoo.http.Response`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cookies</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cookies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="Request.make_json_response">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Request.make_json_response">[docs]</a>
    <span class="k">def</span> <span class="nf">make_json_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Helper for JSON responses, it json-serializes ``data`` and</span>
<span class="sd">        sets the Content-Type header accordingly if none is provided.</span>

<span class="sd">        :param data: the data that will be json-serialized into the response body</span>
<span class="sd">        :param int status: http status code</span>
<span class="sd">        :param List[(str, str)] headers: HTTP headers to set on the response</span>
<span class="sd">        :param collections.abc.Mapping cookies: cookies to set on the client</span>
<span class="sd">        :rtype: :class:`~odoo.http.Response`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">date_utils</span><span class="o">.</span><span class="n">json_default</span><span class="p">)</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">datastructures</span><span class="o">.</span><span class="n">Headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;Content-Type&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;application/json; charset=utf-8&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_response</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">.</span><span class="n">to_wsgi_list</span><span class="p">(),</span> <span class="n">cookies</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span></div>


<div class="viewcode-block" id="Request.not_found">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Request.not_found">[docs]</a>
    <span class="k">def</span> <span class="nf">not_found</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Shortcut for a `HTTP 404</span>
<span class="sd">        &lt;http://tools.ietf.org/html/rfc7231#section-6.5.4&gt;`_ (Not Found)</span>
<span class="sd">        response</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">NotFound</span><span class="p">(</span><span class="n">description</span><span class="p">)</span></div>


<div class="viewcode-block" id="Request.redirect">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Request.redirect">[docs]</a>
    <span class="k">def</span> <span class="nf">redirect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="mi">303</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># compatibility, Werkzeug support URL as location</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">URL</span><span class="p">):</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="n">to_url</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">local</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">url_parse</span><span class="p">(</span><span class="n">location</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">netloc</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_url</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.http&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_redirect</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">Response</span><span class="o">=</span><span class="n">Response</span><span class="p">)</span></div>


<div class="viewcode-block" id="Request.redirect_query">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Request.redirect_query">[docs]</a>
    <span class="k">def</span> <span class="nf">redirect_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="mi">303</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">+=</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="n">url_encode</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="n">local</span><span class="p">)</span></div>


<div class="viewcode-block" id="Request.render">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Request.render">[docs]</a>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">qcontext</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Lazy render of a QWeb template.</span>

<span class="sd">        The actual rendering of the given template will occur at then end of</span>
<span class="sd">        the dispatching. Meanwhile, the template and/or qcontext can be</span>
<span class="sd">        altered or even replaced by a static response.</span>

<span class="sd">        :param str template: template to render</span>
<span class="sd">        :param dict qcontext: Rendering context to use</span>
<span class="sd">        :param bool lazy: whether the template rendering should be deferred</span>
<span class="sd">                          until the last possible moment</span>
<span class="sd">        :param dict kw: forwarded to werkzeug&#39;s Response object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="n">template</span><span class="p">,</span> <span class="n">qcontext</span><span class="o">=</span><span class="n">qcontext</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lazy</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span></div>


    <span class="k">def</span> <span class="nf">_save_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Save a modified session on disk. &quot;&quot;&quot;</span>
        <span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sess</span><span class="o">.</span><span class="n">can_save</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">sess</span><span class="o">.</span><span class="n">should_rotate</span><span class="p">:</span>
            <span class="n">root</span><span class="o">.</span><span class="n">session_store</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>  <span class="c1"># it saves</span>
        <span class="k">elif</span> <span class="n">sess</span><span class="o">.</span><span class="n">is_dirty</span><span class="p">:</span>
            <span class="n">root</span><span class="o">.</span><span class="n">session_store</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">sess</span><span class="p">)</span>

        <span class="c1"># We must not set the cookie if the session id was specified</span>
        <span class="c1"># using a http header or a GET parameter.</span>
        <span class="c1"># There are two reasons to this:</span>
        <span class="c1"># - When using one of those two means we consider that we are</span>
        <span class="c1">#   overriding the cookie, which means creating a new session on</span>
        <span class="c1">#   top of an already existing session and we don&#39;t want to</span>
        <span class="c1">#   create a mess with the &#39;normal&#39; session (the one using the</span>
        <span class="c1">#   cookie). That is a special feature of the Javascript Session.</span>
        <span class="c1"># - It could allow session fixation attacks.</span>
        <span class="n">cookie_sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sess</span><span class="o">.</span><span class="n">is_explicit</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">is_dirty</span> <span class="ow">or</span> <span class="n">cookie_sid</span> <span class="o">!=</span> <span class="n">sess</span><span class="o">.</span><span class="n">sid</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">future_response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="n">sess</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="n">SESSION_LIFETIME</span><span class="p">,</span> <span class="n">httponly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_request_dispatcher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">):</span>
        <span class="n">routing</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">endpoint</span><span class="o">.</span><span class="n">routing</span>
        <span class="n">dispatcher_cls</span> <span class="o">=</span> <span class="n">_dispatchers</span><span class="p">[</span><span class="n">routing</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_cors_preflight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">dispatcher_cls</span><span class="o">.</span><span class="n">is_compatible_with</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="n">compatible_dispatchers</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">disp</span><span class="o">.</span><span class="n">routing_type</span>
                <span class="k">for</span> <span class="n">disp</span> <span class="ow">in</span> <span class="n">_dispatchers</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">disp</span><span class="o">.</span><span class="n">is_compatible_with</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request inferred type is compatible with </span><span class="si">{</span><span class="n">compatible_dispatchers</span><span class="si">}</span><span class="s2"> but </span><span class="si">{</span><span class="n">routing</span><span class="p">[</span><span class="s1">&#39;routes&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">!r}</span><span class="s2"> is type=</span><span class="si">{</span><span class="n">routing</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatcher</span> <span class="o">=</span> <span class="n">dispatcher_cls</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="c1"># =====================================================</span>
    <span class="c1"># Routing</span>
    <span class="c1"># =====================================================</span>
    <span class="k">def</span> <span class="nf">_serve_static</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Serve a static file from the file system. &quot;&quot;&quot;</span>
        <span class="n">module</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;/static/&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">statics</span><span class="p">[</span><span class="n">module</span><span class="p">]</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">safe_join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">Stream</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span>
                <span class="n">max_age</span><span class="o">=</span><span class="mi">0</span> <span class="k">if</span> <span class="s1">&#39;assets&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">debug</span> <span class="k">else</span> <span class="n">STATIC_CACHE</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">root</span><span class="o">.</span><span class="n">set_csp</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFound</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Module &quot;</span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s1">&quot; not found.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>  <span class="c1"># cover both missing file and invalid permissions</span>
            <span class="k">raise</span> <span class="n">NotFound</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;File &quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">&quot; not found in module </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_serve_nodb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dispatch the request to its matching controller in a</span>
<span class="sd">        database-free environment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">router</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">nodb_routing_map</span><span class="o">.</span><span class="n">bind_to_environ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">rule</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">return_rule</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_request_dispatcher</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">pre_dispatch</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">post_dispatch</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">_serve_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the user session and load the ORM before forwarding the</span>
<span class="sd">        request to ``_serve_ir_http``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">Registry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">check_signaling</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">,</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">):</span>
            <span class="c1"># psycopg2 error or attribute error while constructing</span>
            <span class="c1"># the registry. That means either</span>
            <span class="c1">#  - the database probably does not exists anymore, or</span>
            <span class="c1">#  - the database is corrupted, or</span>
            <span class="c1">#  - the database version doesn&#39;t match the server version.</span>
            <span class="c1"># So remove the database from the cookie</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">root</span><span class="o">.</span><span class="n">session_store</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;/web&#39;</span><span class="p">:</span>
                <span class="c1"># Internal Server Error</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serve_nodb</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">cursor</span><span class="p">())</span> <span class="k">as</span> <span class="n">cr</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">service_model</span><span class="o">.</span><span class="n">retrying</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_serve_ir_http</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exc</span><span class="o">.</span><span class="n">code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span>  <span class="c1"># bubble up to odoo.http.Application.__call__</span>
                <span class="n">exc</span><span class="o">.</span><span class="n">error_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;ir.http&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_handle_error</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
                <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_serve_ir_http</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delegate most of the processing to the ir.http model that is</span>
<span class="sd">        extensible by applications.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ir_http</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;ir.http&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">rule</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">ir_http</span><span class="o">.</span><span class="n">_match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NotFound</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_http_params</span><span class="p">()</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">ir_http</span><span class="o">.</span><span class="n">_serve_fallback</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">post_dispatch</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">response</span>
            <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_request_dispatcher</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
        <span class="n">ir_http</span><span class="o">.</span><span class="n">_authenticate</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>
        <span class="n">ir_http</span><span class="o">.</span><span class="n">_pre_dispatch</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="c1"># the registry can have been reniewed by dispatch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;ir.http&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_post_dispatch</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div>



<span class="c1"># =========================================================</span>
<span class="c1"># Core type-specialized dispatchers</span>
<span class="c1"># =========================================================</span>

<span class="n">_dispatchers</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="Dispatcher">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Dispatcher">[docs]</a>
<span class="k">class</span> <span class="nc">Dispatcher</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="n">routing_type</span><span class="p">:</span> <span class="nb">str</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">()</span>
        <span class="n">_dispatchers</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">routing_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>

<div class="viewcode-block" id="Dispatcher.is_compatible_with">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Dispatcher.is_compatible_with">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">is_compatible_with</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if the current request is compatible with this</span>
<span class="sd">        dispatcher.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="Dispatcher.pre_dispatch">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Dispatcher.pre_dispatch">[docs]</a>
    <span class="k">def</span> <span class="nf">pre_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the system before dispatching the request to its</span>
<span class="sd">        controller. This method is often overridden in ir.http to</span>
<span class="sd">        extract some info from the request query-string or headers and</span>
<span class="sd">        to save them in the session or in the context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">routing</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">endpoint</span><span class="o">.</span><span class="n">routing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">can_save</span> <span class="o">=</span> <span class="n">routing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;save_session&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">set_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">future_response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">set</span>
        <span class="n">cors</span> <span class="o">=</span> <span class="n">routing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cors&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cors</span><span class="p">:</span>
            <span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">,</span> <span class="n">cors</span><span class="p">)</span>
            <span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;Access-Control-Allow-Methods&#39;</span><span class="p">,</span> <span class="p">(</span>
                <span class="s1">&#39;POST&#39;</span> <span class="k">if</span> <span class="n">routing</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span>
                <span class="k">else</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">routing</span><span class="p">[</span><span class="s1">&#39;methods&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
            <span class="p">))</span>

        <span class="k">if</span> <span class="n">cors</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span>
            <span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;Access-Control-Max-Age&#39;</span><span class="p">,</span> <span class="n">CORS_MAX_AGE</span><span class="p">)</span>
            <span class="n">set_header</span><span class="p">(</span><span class="s1">&#39;Access-Control-Allow-Headers&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;Origin, X-Requested-With, Content-Type, Accept, Authorization&#39;</span><span class="p">)</span>
            <span class="n">werkzeug</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="n">Response</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">204</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;max_content_length&#39;</span> <span class="ow">in</span> <span class="n">routing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">max_content_length</span> <span class="o">=</span> <span class="n">routing</span><span class="p">[</span><span class="s1">&#39;max_content_length&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="Dispatcher.dispatch">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Dispatcher.dispatch">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract the params from the request&#39;s body and call the</span>
<span class="sd">        endpoint. While it is preferred to override ir.http._pre_dispatch</span>
<span class="sd">        and ir.http._post_dispatch, this method can be override to have</span>
<span class="sd">        a tight control over the dispatching.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="Dispatcher.post_dispatch">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Dispatcher.post_dispatch">[docs]</a>
    <span class="k">def</span> <span class="nf">post_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manipulate the HTTP response to inject various headers, also</span>
<span class="sd">        save the session when it is dirty.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">_save_session</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">_inject_future_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">root</span><span class="o">.</span><span class="n">set_csp</span><span class="p">(</span><span class="n">response</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dispatcher.handle_error">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Dispatcher.handle_error">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">handle_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Callable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform the exception into a valid HTTP response. Called upon</span>
<span class="sd">        any exception while serving a request.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>
</div>



<div class="viewcode-block" id="HttpDispatcher">
<a class="viewcode-back" href="../../odoo.html#odoo.http.HttpDispatcher">[docs]</a>
<span class="k">class</span> <span class="nc">HttpDispatcher</span><span class="p">(</span><span class="n">Dispatcher</span><span class="p">):</span>
    <span class="n">routing_type</span> <span class="o">=</span> <span class="s1">&#39;http&#39;</span>

<div class="viewcode-block" id="HttpDispatcher.is_compatible_with">
<a class="viewcode-back" href="../../odoo.html#odoo.http.HttpDispatcher.is_compatible_with">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">is_compatible_with</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="HttpDispatcher.dispatch">
<a class="viewcode-back" href="../../odoo.html#odoo.http.HttpDispatcher.dispatch">[docs]</a>
    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform http-related actions such as deserializing the request</span>
<span class="sd">        body and query-string and checking cors/csrf while dispatching a</span>
<span class="sd">        request to a ``type=&#39;http&#39;`` route.</span>

<span class="sd">        See :meth:`~odoo.http.Response.load` method for the compatible</span>
<span class="sd">        endpoint return types.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get_http_params</span><span class="p">(),</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>

        <span class="c1"># Check for CSRF token for relevant requests</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">CSRF_FREE_METHODS</span> <span class="ow">and</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">routing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;csrf&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/web/database/selector&#39;</span><span class="p">)</span>

            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;csrf_token&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">validate_csrf</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;CSRF validation failed on path &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">MISSING_CSRF_WARNING</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s1">&#39;Session expired (invalid CSRF token)&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;ir.http&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_dispatch</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">endpoint</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">)</span></div>


<div class="viewcode-block" id="HttpDispatcher.handle_error">
<a class="viewcode-back" href="../../odoo.html#odoo.http.HttpDispatcher.handle_error">[docs]</a>
    <span class="k">def</span> <span class="nf">handle_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Callable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle any exception that occurred while dispatching a request</span>
<span class="sd">        to a `type=&#39;http&#39;` route. Also handle exceptions that occurred</span>
<span class="sd">        when no route matched the request path, when no fallback page</span>
<span class="sd">        could be delivered and that the request ``Content-Type`` was not</span>
<span class="sd">        json.</span>

<span class="sd">        :param Exception exc: the exception that occurred.</span>
<span class="sd">        :returns: a WSGI application</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">SessionExpiredException</span><span class="p">):</span>
            <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span>
            <span class="n">was_connected</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">uid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">session</span><span class="o">.</span><span class="n">logout</span><span class="p">(</span><span class="n">keep_db</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">redirect_query</span><span class="p">(</span><span class="s1">&#39;/web/login&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;redirect&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">full_path</span><span class="p">})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">is_explicit</span> <span class="ow">and</span> <span class="n">was_connected</span><span class="p">:</span>
                <span class="n">root</span><span class="o">.</span><span class="n">session_store</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
                <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="n">SESSION_LIFETIME</span><span class="p">,</span> <span class="n">httponly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">exc</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">)</span>
           <span class="k">else</span> <span class="n">Forbidden</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="p">(</span><span class="n">AccessDenied</span><span class="p">,</span> <span class="n">AccessError</span><span class="p">))</span>
           <span class="k">else</span> <span class="n">BadRequest</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">UserError</span><span class="p">)</span>
           <span class="k">else</span> <span class="n">InternalServerError</span><span class="p">()</span>  <span class="c1"># hide the real error</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="JsonRPCDispatcher">
<a class="viewcode-back" href="../../odoo.html#odoo.http.JsonRPCDispatcher">[docs]</a>
<span class="k">class</span> <span class="nc">JsonRPCDispatcher</span><span class="p">(</span><span class="n">Dispatcher</span><span class="p">):</span>
    <span class="n">routing_type</span> <span class="o">=</span> <span class="s1">&#39;json&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jsonrequest</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="JsonRPCDispatcher.is_compatible_with">
<a class="viewcode-back" href="../../odoo.html#odoo.http.JsonRPCDispatcher.is_compatible_with">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">is_compatible_with</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">mimetype</span> <span class="ow">in</span> <span class="n">JSON_MIMETYPES</span></div>


<div class="viewcode-block" id="JsonRPCDispatcher.dispatch">
<a class="viewcode-back" href="../../odoo.html#odoo.http.JsonRPCDispatcher.dispatch">[docs]</a>
    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        `JSON-RPC 2 &lt;http://www.jsonrpc.org/specification&gt;`_ over HTTP.</span>

<span class="sd">        Our implementation differs from the specification on two points:</span>

<span class="sd">        1. The ``method`` member of the JSON-RPC request payload is</span>
<span class="sd">           ignored as the HTTP path is already used to route the request</span>
<span class="sd">           to the controller.</span>
<span class="sd">        2. We only support parameter structures by-name, i.e. the</span>
<span class="sd">           ``params`` member of the JSON-RPC request payload MUST be a</span>
<span class="sd">           JSON Object and not a JSON Array.</span>

<span class="sd">        In addition, it is possible to pass a context that replaces</span>
<span class="sd">        the session context via a special ``context`` argument that is</span>
<span class="sd">        removed prior to calling the endpoint.</span>

<span class="sd">        Successful request::</span>

<span class="sd">          --&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;call&quot;, &quot;params&quot;: {&quot;arg1&quot;: &quot;val1&quot; }, &quot;id&quot;: null}</span>

<span class="sd">          &lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: { &quot;res1&quot;: &quot;val1&quot; }, &quot;id&quot;: null}</span>

<span class="sd">        Request producing a error::</span>

<span class="sd">          --&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;call&quot;, &quot;params&quot;: {&quot;arg1&quot;: &quot;val1&quot; }, &quot;id&quot;: null}</span>

<span class="sd">          &lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;error&quot;: {&quot;code&quot;: 1, &quot;message&quot;: &quot;End user error message.&quot;, &quot;data&quot;: {&quot;code&quot;: &quot;codestring&quot;, &quot;debug&quot;: &quot;traceback&quot; } }, &quot;id&quot;: null}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jsonrequest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get_json_data</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jsonrequest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="c1"># must use abort+Response to bypass handle_error</span>
            <span class="n">werkzeug</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="n">Response</span><span class="p">(</span><span class="s2">&quot;Invalid JSON data&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="c1"># must use abort+Response to bypass handle_error</span>
            <span class="n">werkzeug</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="n">Response</span><span class="p">(</span><span class="s2">&quot;Invalid JSON-RPC data&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jsonrequest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;params&#39;</span><span class="p">,</span> <span class="p">{}),</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;ir.http&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_dispatch</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>


<div class="viewcode-block" id="JsonRPCDispatcher.handle_error">
<a class="viewcode-back" href="../../odoo.html#odoo.http.JsonRPCDispatcher.handle_error">[docs]</a>
    <span class="k">def</span> <span class="nf">handle_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Callable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle any exception that occurred while dispatching a request to</span>
<span class="sd">        a `type=&#39;json&#39;` route. Also handle exceptions that occurred when</span>
<span class="sd">        no route matched the request path, that no fallback page could</span>
<span class="sd">        be delivered and that the request ``Content-Type`` was json.</span>

<span class="sd">        :param exc: the exception that occurred.</span>
<span class="sd">        :returns: a WSGI application</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>  <span class="c1"># this code is the JSON-RPC level code, it is</span>
                          <span class="c1"># distinct from the HTTP status code. This</span>
                          <span class="c1"># code is ignored and the value 200 (while</span>
                          <span class="c1"># misleading) is totally arbitrary.</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s2">&quot;Odoo Server Error&quot;</span><span class="p">,</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">serialize_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">NotFound</span><span class="p">):</span>
            <span class="n">error</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">404</span>
            <span class="n">error</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;404: Not Found&quot;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">SessionExpiredException</span><span class="p">):</span>
            <span class="n">error</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="n">error</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Odoo Session Expired&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_id</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">response</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">response</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">make_json_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span></div>



<span class="c1"># =========================================================</span>
<span class="c1"># WSGI Entry Point</span>
<span class="c1"># =========================================================</span>

<div class="viewcode-block" id="Application">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Application">[docs]</a>
<span class="k">class</span> <span class="nc">Application</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Odoo WSGI application &quot;&quot;&quot;</span>
    <span class="c1"># See also: https://www.python.org/dev/peps/pep-3333</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">statics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Map module names to their absolute ``static`` path on the file</span>
<span class="sd">        system.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mod2path</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">addons_path</span> <span class="ow">in</span> <span class="n">odoo</span><span class="o">.</span><span class="n">addons</span><span class="o">.</span><span class="n">__path__</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">addons_path</span><span class="p">):</span>
                <span class="n">manifest</span> <span class="o">=</span> <span class="n">get_manifest</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
                <span class="n">static_path</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="n">addons_path</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">manifest</span>
                        <span class="ow">and</span> <span class="p">(</span><span class="n">manifest</span><span class="p">[</span><span class="s1">&#39;installable&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">manifest</span><span class="p">[</span><span class="s1">&#39;assets&#39;</span><span class="p">])</span>
                        <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">static_path</span><span class="p">)):</span>
                    <span class="n">mod2path</span><span class="p">[</span><span class="n">module</span><span class="p">]</span> <span class="o">=</span> <span class="n">static_path</span>
        <span class="k">return</span> <span class="n">mod2path</span>

<div class="viewcode-block" id="Application.get_static_file">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Application.get_static_file">[docs]</a>
    <span class="k">def</span> <span class="nf">get_static_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the full-path of the file if the url resolves to a local</span>
<span class="sd">        static file, otherwise return None.</span>

<span class="sd">        Without the second host parameters, ``url`` must be an absolute</span>
<span class="sd">        path, others URLs are considered faulty.</span>

<span class="sd">        With the second host parameters, ``url`` can also be a full URI</span>
<span class="sd">        and the authority found in the URL (if any) is validated against</span>
<span class="sd">        the given ``host``.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">netloc</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">path_netloc</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">static</span><span class="p">,</span> <span class="n">resource</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">netloc</span> <span class="ow">and</span> <span class="n">netloc</span> <span class="o">!=</span> <span class="n">host</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">path_netloc</span> <span class="ow">and</span> <span class="n">path_netloc</span> <span class="o">!=</span> <span class="n">host</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">module</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statics</span> <span class="ow">or</span> <span class="n">static</span> <span class="o">!=</span> <span class="s1">&#39;static&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">resource</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">file_path</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s1">/static/</span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>


    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">nodb_routing_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nodb_routing_map</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">routing</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">strict_slashes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">converters</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">url</span><span class="p">,</span> <span class="n">endpoint</span> <span class="ow">in</span> <span class="n">_generate_routing_rules</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">odoo</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">server_wide_modules</span><span class="p">,</span> <span class="n">nodb_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">routing</span> <span class="o">=</span> <span class="n">submap</span><span class="p">(</span><span class="n">endpoint</span><span class="o">.</span><span class="n">routing</span><span class="p">,</span> <span class="n">ROUTING_KEYS</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">routing</span><span class="p">[</span><span class="s1">&#39;methods&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;OPTIONS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">routing</span><span class="p">[</span><span class="s1">&#39;methods&#39;</span><span class="p">]:</span>
                <span class="n">routing</span><span class="p">[</span><span class="s1">&#39;methods&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">routing</span><span class="p">[</span><span class="s1">&#39;methods&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;OPTIONS&#39;</span><span class="p">]</span>
            <span class="n">rule</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">routing</span><span class="o">.</span><span class="n">Rule</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span> <span class="o">**</span><span class="n">routing</span><span class="p">)</span>
            <span class="n">rule</span><span class="o">.</span><span class="n">merge_slashes</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">nodb_routing_map</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">nodb_routing_map</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">session_store</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">session_dir</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;HTTP sessions stored in: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FilesystemSessionStore</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">session_class</span><span class="o">=</span><span class="n">Session</span><span class="p">,</span> <span class="n">renew_missing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="Application.get_db_router">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Application.get_db_router">[docs]</a>
    <span class="k">def</span> <span class="nf">get_db_router</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodb_routing_map</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.http&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">routing_map</span><span class="p">()</span></div>


    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">geoip_city_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">geoip2</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;geoip_city_db&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">maxminddb</span><span class="o">.</span><span class="n">InvalidDatabaseError</span><span class="p">):</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Couldn&#39;t load Geoip City file at </span><span class="si">%s</span><span class="s2">. IP Resolver disabled.&quot;</span><span class="p">,</span>
                <span class="n">config</span><span class="p">[</span><span class="s1">&#39;geoip_city_db&#39;</span><span class="p">],</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">raise</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">geoip_country_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">geoip2</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;geoip_country_db&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">maxminddb</span><span class="o">.</span><span class="n">InvalidDatabaseError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t load Geoip Country file (</span><span class="si">%s</span><span class="s2">). Fallbacks on Geoip City.&quot;</span><span class="p">,</span> <span class="n">exc</span><span class="p">,)</span>
            <span class="k">raise</span>

<div class="viewcode-block" id="Application.set_csp">
<a class="viewcode-back" href="../../odoo.html#odoo.http.Application.set_csp">[docs]</a>
    <span class="k">def</span> <span class="nf">set_csp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span>
        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;X-Content-Type-Options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nosniff&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;Content-Security-Policy&#39;</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">mime</span><span class="p">,</span> <span class="n">_params</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">parse_header</span><span class="p">(</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mime</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;image/&#39;</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Security-Policy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default-src &#39;none&#39;&quot;</span></div>


    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        WSGI application entry point.</span>

<span class="sd">        :param dict environ: container for CGI environment variables</span>
<span class="sd">            such as the request HTTP headers, the source IP address and</span>
<span class="sd">            the body as an io file.</span>
<span class="sd">        :param callable start_response: function provided by the WSGI</span>
<span class="sd">            server that this application must call in order to send the</span>
<span class="sd">            HTTP response status line and the response headers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span>
        <span class="n">current_thread</span><span class="o">.</span><span class="n">query_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">current_thread</span><span class="o">.</span><span class="n">query_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">current_thread</span><span class="o">.</span><span class="n">perf_t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">current_thread</span><span class="p">,</span> <span class="s1">&#39;dbname&#39;</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">current_thread</span><span class="o">.</span><span class="n">dbname</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">current_thread</span><span class="p">,</span> <span class="s1">&#39;uid&#39;</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">current_thread</span><span class="o">.</span><span class="n">uid</span>

        <span class="k">if</span> <span class="n">odoo</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;proxy_mode&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HTTP_X_FORWARDED_HOST&quot;</span><span class="p">):</span>
            <span class="c1"># The ProxyFix middleware has a side effect of updating the</span>
            <span class="c1"># environ, see https://github.com/pallets/werkzeug/pull/2184</span>
            <span class="k">def</span> <span class="nf">fake_app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">def</span> <span class="nf">fake_start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="n">ProxyFix</span><span class="p">(</span><span class="n">fake_app</span><span class="p">)(</span><span class="n">environ</span><span class="p">,</span> <span class="n">fake_start_response</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">HTTPRequest</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span> <span class="k">as</span> <span class="n">httprequest</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">httprequest</span><span class="p">)</span>
            <span class="n">_request_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">request</span><span class="o">.</span><span class="n">_post_init</span><span class="p">()</span>
            <span class="n">current_thread</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">httprequest</span><span class="o">.</span><span class="n">url</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_static_file</span><span class="p">(</span><span class="n">httprequest</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">_serve_static</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">request</span><span class="o">.</span><span class="n">_get_profiler_context_manager</span><span class="p">():</span>
                        <span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">_serve_db</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">_serve_nodb</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">response</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="c1"># Valid (2xx/3xx) response returned via werkzeug.exceptions.abort.</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exc</span><span class="o">.</span><span class="n">code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">get_response</span><span class="p">()</span>
                    <span class="n">HttpDispatcher</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">post_dispatch</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">response</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>

                <span class="c1"># Logs the error here so the traceback starts with ``__call__``.</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="s1">&#39;loglevel&#39;</span><span class="p">):</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">loglevel</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="s1">&#39;exc_info&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">SessionExpiredException</span><span class="p">):</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="p">(</span><span class="n">UserError</span><span class="p">,</span> <span class="n">AccessError</span><span class="p">)):</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception during request handling.&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Ensure there is always a WSGI handler attached to the exception.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="s1">&#39;error_response&#39;</span><span class="p">):</span>
                    <span class="n">exc</span><span class="o">.</span><span class="n">error_response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">handle_error</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">exc</span><span class="o">.</span><span class="n">error_response</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="n">_request_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span></div>



<span class="n">root</span> <span class="o">=</span> <span class="n">Application</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Amr.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>