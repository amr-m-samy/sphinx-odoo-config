<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>odoo.models &mdash; Amr  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Amr
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">odoo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Amr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../odoo.html">odoo</a></li>
      <li class="breadcrumb-item active">odoo.models</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for odoo.models</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># Part of Odoo. See LICENSE file for full copyright and licensing details.</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object Relational Mapping module:</span>
<span class="sd">     * Hierarchical structure</span>
<span class="sd">     * Constraints consistency and validation</span>
<span class="sd">     * Object metadata depends on its status</span>
<span class="sd">     * Optimised processing by complex query (multiple actions at once)</span>
<span class="sd">     * Default field values</span>
<span class="sd">     * Permissions optimisation</span>
<span class="sd">     * Persistent object: DB postgresql</span>
<span class="sd">     * Data conversion</span>
<span class="sd">     * Multi-level caching system</span>
<span class="sd">     * Two different inheritance mechanisms</span>
<span class="sd">     * Rich set of field types:</span>
<span class="sd">          - classical (varchar, integer, boolean, ...)</span>
<span class="sd">          - relational (one2many, many2one, many2many)</span>
<span class="sd">          - functional</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">dateutil</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">pytz</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">MutableMapping</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">closing</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">getmembers</span><span class="p">,</span> <span class="n">currentframe</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">attrgetter</span><span class="p">,</span> <span class="n">itemgetter</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">babel</span>
<span class="kn">import</span> <span class="nn">babel.dates</span>
<span class="kn">import</span> <span class="nn">dateutil.relativedelta</span>
<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">import</span> <span class="nn">psycopg2.extensions</span>
<span class="kn">from</span> <span class="nn">psycopg2.extras</span> <span class="kn">import</span> <span class="n">Json</span>

<span class="kn">import</span> <span class="nn">odoo</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">SUPERUSER_ID</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">api</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">tools</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">AccessError</span><span class="p">,</span> <span class="n">MissingError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="n">UserError</span>
<span class="kn">from</span> <span class="nn">.tools</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">clean_context</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">CountingStream</span><span class="p">,</span> <span class="n">date_utils</span><span class="p">,</span> <span class="n">discardattr</span><span class="p">,</span>
    <span class="n">DEFAULT_SERVER_DATE_FORMAT</span><span class="p">,</span> <span class="n">DEFAULT_SERVER_DATETIME_FORMAT</span><span class="p">,</span> <span class="n">frozendict</span><span class="p">,</span>
    <span class="n">get_lang</span><span class="p">,</span> <span class="n">LastOrderedSet</span><span class="p">,</span> <span class="n">lazy_classproperty</span><span class="p">,</span> <span class="n">OrderedSet</span><span class="p">,</span> <span class="n">ormcache</span><span class="p">,</span>
    <span class="n">partition</span><span class="p">,</span> <span class="n">populate</span><span class="p">,</span> <span class="n">Query</span><span class="p">,</span> <span class="n">ReversedIterable</span><span class="p">,</span> <span class="n">split_every</span><span class="p">,</span> <span class="n">unique</span><span class="p">,</span> <span class="n">SQL</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.tools.lru</span> <span class="kn">import</span> <span class="n">LRU</span>
<span class="kn">from</span> <span class="nn">.tools.translate</span> <span class="kn">import</span> <span class="n">_</span><span class="p">,</span> <span class="n">_lt</span>

<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">_unlink</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;.unlink&#39;</span><span class="p">)</span>

<span class="n">regex_alphanumeric</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[a-z0-9_]+$&#39;</span><span class="p">)</span>
<span class="n">regex_order</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    ^</span>
<span class="s1">    (\s*</span>
<span class="s1">        (?P&lt;term&gt;((?P&lt;field&gt;[a-z0-9_]+|&quot;[a-z0-9_]+&quot;)(\.(?P&lt;property&gt;[a-z0-9_]+))?(:(?P&lt;func&gt;[a-z_]+))?))</span>
<span class="s1">        (\s+(?P&lt;direction&gt;desc|asc))?</span>
<span class="s1">        (\s+(?P&lt;nulls&gt;nulls\ first|nulls\ last))?</span>
<span class="s1">        \s*</span>
<span class="s1">        (,|$)</span>
<span class="s1">    )+</span>
<span class="s1">    (?&lt;!,)</span>
<span class="s1">    $</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="n">regex_object_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[a-z0-9_.]+$&#39;</span><span class="p">)</span>
<span class="n">regex_pg_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[a-z_][a-z0-9_$]*$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
<span class="n">regex_field_agg</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\w+)(?::(\w+)(?:\((\w+)\))?)?&#39;</span><span class="p">)</span>  <span class="c1"># For read_group</span>
<span class="n">regex_read_group_spec</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\w+)(\.(\w+))?(?::(\w+))?$&#39;</span><span class="p">)</span>  <span class="c1"># For _read_group</span>

<span class="n">AUTOINIT_RECALCULATE_STORED_FIELDS</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="n">INSERT_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">SQL_DEFAULT</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">AsIs</span><span class="p">(</span><span class="s2">&quot;DEFAULT&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="parse_read_group_spec">
<a class="viewcode-back" href="../../odoo.html#odoo.models.parse_read_group_spec">[docs]</a>
<span class="k">def</span> <span class="nf">parse_read_group_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return a triplet corresponding to the given groupby/path/aggregate specification. &quot;&quot;&quot;</span>
    <span class="n">res_match</span> <span class="o">=</span> <span class="n">regex_read_group_spec</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">res_match</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Invalid aggregate/groupby specification </span><span class="si">{</span><span class="n">spec</span><span class="si">!r}</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;- Valid aggregate specification looks like &quot;&lt;field_name&gt;:&lt;agg&gt;&quot; example: &quot;quantity:sum&quot;.</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;- Valid groupby specification looks like &quot;&lt;no_datish_field_name&gt;&quot; or &quot;&lt;datish_field_name&gt;:&lt;granularity&gt;&quot; example: &quot;date:month&quot; or &quot;&lt;properties_field_name&gt;.&lt;property&gt;:&lt;granularity&gt;&quot;.&#39;</span>
        <span class="p">)</span>

    <span class="n">groups</span> <span class="o">=</span> <span class="n">res_match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">groups</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">groups</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span></div>


<div class="viewcode-block" id="check_object_name">
<a class="viewcode-back" href="../../odoo.html#odoo.models.check_object_name">[docs]</a>
<span class="k">def</span> <span class="nf">check_object_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Check if the given name is a valid model name.</span>

<span class="sd">        The _name attribute in osv and osv_memory object is subject to</span>
<span class="sd">        some restrictions. This function returns True or False whether</span>
<span class="sd">        the given name is allowed or not.</span>

<span class="sd">        TODO: this is an approximation. The goal in this approximation</span>
<span class="sd">        is to disallow uppercase characters (in some places, we quote</span>
<span class="sd">        table/column names and in other not, which leads to this kind</span>
<span class="sd">        of errors:</span>

<span class="sd">            psycopg2.ProgrammingError: relation &quot;xxx&quot; does not exist).</span>

<span class="sd">        The same restriction should apply to both osv and osv_memory</span>
<span class="sd">        objects for consistency.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">regex_object_name</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="raise_on_invalid_object_name">
<a class="viewcode-back" href="../../odoo.html#odoo.models.raise_on_invalid_object_name">[docs]</a>
<span class="k">def</span> <span class="nf">raise_on_invalid_object_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_object_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The _name attribute </span><span class="si">%s</span><span class="s2"> is not valid.&quot;</span> <span class="o">%</span> <span class="n">name</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_pg_name">
<a class="viewcode-back" href="../../odoo.html#odoo.models.check_pg_name">[docs]</a>
<span class="k">def</span> <span class="nf">check_pg_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Check whether the given name is a valid PostgreSQL identifier name. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">regex_pg_name</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Invalid characters in table name </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Table name </span><span class="si">%r</span><span class="s2"> is too long&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span></div>


<span class="c1"># match private methods, to prevent their remote invocation</span>
<span class="n">regex_private</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(_.*|init)$&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="check_method_name">
<a class="viewcode-back" href="../../odoo.html#odoo.models.check_method_name">[docs]</a>
<span class="k">def</span> <span class="nf">check_method_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Raise an ``AccessError`` if ``name`` is a private method name. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">regex_private</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">AccessError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Private methods (such as </span><span class="si">%s</span><span class="s1">) cannot be called remotely.&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span></div>



<div class="viewcode-block" id="check_property_field_value_name">
<a class="viewcode-back" href="../../odoo.html#odoo.models.check_property_field_value_name">[docs]</a>
<span class="k">def</span> <span class="nf">check_property_field_value_name</span><span class="p">(</span><span class="n">property_name</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">regex_alphanumeric</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">property_name</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">property_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">512</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrong property field value name </span><span class="si">{</span><span class="n">property_name</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="fix_import_export_id_paths">
<a class="viewcode-back" href="../../odoo.html#odoo.models.fix_import_export_id_paths">[docs]</a>
<span class="k">def</span> <span class="nf">fix_import_export_id_paths</span><span class="p">(</span><span class="n">fieldname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fixes the id fields in import and exports, and splits field paths</span>
<span class="sd">    on &#39;/&#39;.</span>

<span class="sd">    :param str fieldname: name of the field to import/export</span>
<span class="sd">    :return: split field name</span>
<span class="sd">    :rtype: list of str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fixed_db_id</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([^/])\.id&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\1/.id&#39;</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">)</span>
    <span class="n">fixed_external_id</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([^/]):id&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\1/id&#39;</span><span class="p">,</span> <span class="n">fixed_db_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fixed_external_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="to_company_ids">
<a class="viewcode-back" href="../../odoo.html#odoo.models.to_company_ids">[docs]</a>
<span class="k">def</span> <span class="nf">to_company_ids</span><span class="p">(</span><span class="n">companies</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">companies</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">companies</span><span class="o">.</span><span class="n">ids</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">companies</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">companies</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">companies</span><span class="p">]</span></div>



<div class="viewcode-block" id="check_company_domain_parent_of">
<a class="viewcode-back" href="../../odoo.html#odoo.models.check_company_domain_parent_of">[docs]</a>
<span class="k">def</span> <span class="nf">check_company_domain_parent_of</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">companies</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">companies</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;company_id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;company_id&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_of&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">companies</span><span class="p">])]</span>

    <span class="n">companies</span> <span class="o">=</span> <span class="p">[</span><span class="nb">id</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">to_company_ids</span><span class="p">(</span><span class="n">companies</span><span class="p">)</span> <span class="k">if</span> <span class="nb">id</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">companies</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[(</span><span class="s1">&#39;company_id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]</span>

    <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;company_id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;company_id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="p">[</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">companies</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">rec</span><span class="o">.</span><span class="n">parent_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">])]</span></div>



<div class="viewcode-block" id="MetaModel">
<a class="viewcode-back" href="../../odoo.html#odoo.models.MetaModel">[docs]</a>
<span class="k">class</span> <span class="nc">MetaModel</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">Meta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; The metaclass of all model classes.</span>
<span class="sd">        Its main purpose is to register the models per module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">module_to_models</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="c1"># this prevents assignment of non-fields on recordsets</span>
        <span class="n">attrs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;__slots__&#39;</span><span class="p">,</span> <span class="p">())</span>
        <span class="c1"># this collects the fields defined on the class (via Field.__set_name__())</span>
        <span class="n">attrs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;_field_definitions&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">if</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_register&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="c1"># determine &#39;_module&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;_module&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;__module__&#39;</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">module</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;odoo.addons.&#39;</span><span class="p">),</span> \
                    <span class="sa">f</span><span class="s2">&quot;Invalid import of </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">, it should start with &#39;odoo.addons&#39;.&quot;</span>
                <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;_module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>

            <span class="c1"># determine model &#39;_name&#39; and normalize &#39;_inherits&#39;</span>
            <span class="n">inherit</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_inherit&#39;</span><span class="p">,</span> <span class="p">())</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inherit</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">inherit</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;_inherit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">inherit</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;_name&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inherit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inherit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">name</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;__init__&#39;</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;__init__&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The method </span><span class="si">%s</span><span class="s2">.__init__ doesn&#39;t match the new signature in module </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;__module__&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_read&#39;</span><span class="p">)):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: method BaseModel._read() has been replaced by BaseModel._fetch_query()&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_register&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># Remember which models to instantiate for this module.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module_to_models</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_abstract</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherit</span><span class="p">:</span>
            <span class="c1"># this class defines a model: add magic fields</span>
            <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="n">field</span><span class="o">.</span><span class="n">__set_name__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">add_default</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                    <span class="n">field</span><span class="o">.</span><span class="n">__set_name__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

            <span class="n">add</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">Id</span><span class="p">(</span><span class="n">automatic</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">add_default</span><span class="p">(</span><span class="s1">&#39;display_name&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span>
                <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Display Name&#39;</span><span class="p">,</span> <span class="n">automatic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_display_name&#39;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_log_access&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto</span><span class="p">):</span>
                <span class="n">add_default</span><span class="p">(</span><span class="s1">&#39;create_uid&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span>
                    <span class="s1">&#39;res.users&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Created by&#39;</span><span class="p">,</span> <span class="n">automatic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                <span class="n">add_default</span><span class="p">(</span><span class="s1">&#39;create_date&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">Datetime</span><span class="p">(</span>
                    <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Created on&#39;</span><span class="p">,</span> <span class="n">automatic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                <span class="n">add_default</span><span class="p">(</span><span class="s1">&#39;write_uid&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span>
                    <span class="s1">&#39;res.users&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Last Updated by&#39;</span><span class="p">,</span> <span class="n">automatic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                <span class="n">add_default</span><span class="p">(</span><span class="s1">&#39;write_date&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">Datetime</span><span class="p">(</span>
                    <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Last Updated on&#39;</span><span class="p">,</span> <span class="n">automatic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span></div>



<div class="viewcode-block" id="NewId">
<a class="viewcode-back" href="../../odoo.html#odoo.models.NewId">[docs]</a>
<span class="k">class</span> <span class="nc">NewId</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Pseudo-ids for new records, encapsulating an optional origin id (actual</span>
<span class="sd">        record id) and an optional reference (any value).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">,</span> <span class="s1">&#39;ref&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span>

    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">NewId</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">origin</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">ref</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">ref</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="ow">or</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;&lt;NewId origin=</span><span class="si">%r</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="k">else</span>
            <span class="s2">&quot;&lt;NewId ref=</span><span class="si">%r</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="k">else</span>
            <span class="s2">&quot;&lt;NewId 0x</span><span class="si">%x</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="p">:</span>
            <span class="n">id_part</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">id_part</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;NewId_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">id_part</span></div>



<div class="viewcode-block" id="origin_ids">
<a class="viewcode-back" href="../../odoo.html#odoo.models.origin_ids">[docs]</a>
<span class="k">def</span> <span class="nf">origin_ids</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return an iterator over the origin ids corresponding to ``ids``.</span>
<span class="sd">        Actual ids are returned as is, and ids without origin are not returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">id_</span> <span class="ow">or</span> <span class="n">id_</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">ids</span> <span class="k">if</span> <span class="p">(</span><span class="n">id_</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">id_</span><span class="p">,</span> <span class="s2">&quot;origin&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)))</span></div>



<div class="viewcode-block" id="OriginIds">
<a class="viewcode-back" href="../../odoo.html#odoo.models.OriginIds">[docs]</a>
<span class="k">class</span> <span class="nc">OriginIds</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; A reversible iterable returning the origin ids of a collection of ``ids``. &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">origin_ids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__reversed__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">origin_ids</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">))</span></div>



<div class="viewcode-block" id="expand_ids">
<a class="viewcode-back" href="../../odoo.html#odoo.models.expand_ids">[docs]</a>
<span class="k">def</span> <span class="nf">expand_ids</span><span class="p">(</span><span class="n">id0</span><span class="p">,</span> <span class="n">ids</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return an iterator of unique ids from the concatenation of ``[id0]`` and</span>
<span class="sd">        ``ids``, and of the same kind (all real or all new).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">yield</span> <span class="n">id0</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="p">{</span><span class="n">id0</span><span class="p">}</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">id0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">id_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span> <span class="o">==</span> <span class="n">kind</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">id_</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span></div>



<span class="n">IdType</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">NewId</span><span class="p">)</span>


<span class="c1"># maximum number of prefetched records</span>
<span class="n">PREFETCH_MAX</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="c1"># special columns automatically created by the ORM</span>
<span class="n">LOG_ACCESS_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;create_uid&#39;</span><span class="p">,</span> <span class="s1">&#39;create_date&#39;</span><span class="p">,</span> <span class="s1">&#39;write_uid&#39;</span><span class="p">,</span> <span class="s1">&#39;write_date&#39;</span><span class="p">]</span>
<span class="n">MAGIC_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">LOG_ACCESS_COLUMNS</span>

<span class="c1"># read_group stuff</span>
<span class="n">READ_GROUP_TIME_GRANULARITY</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;hour&#39;</span><span class="p">:</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">relativedelta</span><span class="o">.</span><span class="n">relativedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="s1">&#39;day&#39;</span><span class="p">:</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">relativedelta</span><span class="o">.</span><span class="n">relativedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="s1">&#39;week&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">),</span>
    <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">relativedelta</span><span class="o">.</span><span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="s1">&#39;quarter&#39;</span><span class="p">:</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">relativedelta</span><span class="o">.</span><span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
    <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">relativedelta</span><span class="o">.</span><span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># valid SQL aggregation functions</span>
<span class="n">READ_GROUP_AGGREGATE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;sum&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">table</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;SUM(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="p">),</span>
    <span class="s1">&#39;avg&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">table</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;AVG(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="p">),</span>
    <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">table</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;MAX(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="p">),</span>
    <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">table</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;MIN(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="p">),</span>
    <span class="s1">&#39;bool_and&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">table</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;BOOL_AND(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="p">),</span>
    <span class="s1">&#39;bool_or&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">table</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;BOOL_OR(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="p">),</span>
    <span class="s1">&#39;array_agg&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">table</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ARRAY_AGG(</span><span class="si">%s</span><span class="s1"> ORDER BY </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)),</span>
    <span class="c1"># &#39;recordset&#39; aggregates will be post-processed to become recordsets</span>
    <span class="s1">&#39;recordset&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">table</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ARRAY_AGG(</span><span class="si">%s</span><span class="s1"> ORDER BY </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)),</span>
    <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">table</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;COUNT(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="p">),</span>
    <span class="s1">&#39;count_distinct&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">table</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;COUNT(DISTINCT </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">READ_GROUP_DISPLAY_FORMAT</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># Careful with week/year formats:</span>
    <span class="c1">#  - yyyy (lower) must always be used, *except* for week+year formats</span>
    <span class="c1">#  - YYYY (upper) must always be used for week+year format</span>
    <span class="c1">#         e.g. 2006-01-01 is W52 2005 in some locales (de_DE),</span>
    <span class="c1">#                         and W1 2006 for others</span>
    <span class="c1">#</span>
    <span class="c1"># Mixing both formats, e.g. &#39;MMM YYYY&#39; would yield wrong results,</span>
    <span class="c1"># such as 2006-01-01 being formatted as &quot;January 2005&quot; in some locales.</span>
    <span class="c1"># Cfr: http://babel.pocoo.org/en/latest/dates.html#date-fields</span>
    <span class="s1">&#39;hour&#39;</span><span class="p">:</span> <span class="s1">&#39;hh:00 dd MMM&#39;</span><span class="p">,</span>
    <span class="s1">&#39;day&#39;</span><span class="p">:</span> <span class="s1">&#39;dd MMM yyyy&#39;</span><span class="p">,</span> <span class="c1"># yyyy = normal year</span>
    <span class="s1">&#39;week&#39;</span><span class="p">:</span> <span class="s2">&quot;&#39;W&#39;w YYYY&quot;</span><span class="p">,</span>  <span class="c1"># w YYYY = ISO week-year</span>
    <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="s1">&#39;MMMM yyyy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;quarter&#39;</span><span class="p">:</span> <span class="s1">&#39;QQQ yyyy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="s1">&#39;yyyy&#39;</span><span class="p">,</span>
<span class="p">}</span>


<span class="c1"># THE DEFINITION AND REGISTRY CLASSES</span>
<span class="c1">#</span>
<span class="c1"># The framework deals with two kinds of classes for models: the &quot;definition&quot;</span>
<span class="c1"># classes and the &quot;registry&quot; classes.</span>
<span class="c1">#</span>
<span class="c1"># The &quot;definition&quot; classes are the ones defined in modules source code: they</span>
<span class="c1"># define models and extend them.  Those classes are essentially &quot;static&quot;, for</span>
<span class="c1"># whatever that means in Python.  The only exception is custom models: their</span>
<span class="c1"># definition class is created dynamically.</span>
<span class="c1">#</span>
<span class="c1"># The &quot;registry&quot; classes are the ones you find in the registry.  They are the</span>
<span class="c1"># actual classes of the recordsets of their model.  The &quot;registry&quot; class of a</span>
<span class="c1"># model is created dynamically when the registry is built.  It inherits (in the</span>
<span class="c1"># Python sense) from all the definition classes of the model, and possibly other</span>
<span class="c1"># registry classes (when the model inherits from another model).  It also</span>
<span class="c1"># carries model metadata inferred from its parent classes.</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># THE REGISTRY CLASS OF A MODEL</span>
<span class="c1">#</span>
<span class="c1"># In the simplest case, a model&#39;s registry class inherits from all the classes</span>
<span class="c1"># that define the model in a flat hierarchy.  Consider the model definition</span>
<span class="c1"># below.  The registry class of model &#39;a&#39; inherits from the definition classes</span>
<span class="c1"># A1, A2, A3, in reverse order, to match the expected overriding order.  The</span>
<span class="c1"># registry class carries inferred metadata that is shared between all the</span>
<span class="c1"># model&#39;s instances for a given registry.</span>
<span class="c1">#</span>
<span class="c1">#       class A1(Model):                      Model</span>
<span class="c1">#           _name = &#39;a&#39;                       / | \</span>
<span class="c1">#                                            A3 A2 A1   &lt;- definition classes</span>
<span class="c1">#       class A2(Model):                      \ | /</span>
<span class="c1">#           _inherit = &#39;a&#39;                      a       &lt;- registry class: registry[&#39;a&#39;]</span>
<span class="c1">#                                               |</span>
<span class="c1">#       class A3(Model):                     records    &lt;- model instances, like env[&#39;a&#39;]</span>
<span class="c1">#           _inherit = &#39;a&#39;</span>
<span class="c1">#</span>
<span class="c1"># Note that when the model inherits from another model, we actually make the</span>
<span class="c1"># registry classes inherit from each other, so that extensions to an inherited</span>
<span class="c1"># model are visible in the registry class of the child model, like in the</span>
<span class="c1"># following example.</span>
<span class="c1">#</span>
<span class="c1">#       class A1(Model):</span>
<span class="c1">#           _name = &#39;a&#39;                       Model</span>
<span class="c1">#                                            / / \ \</span>
<span class="c1">#       class B1(Model):                    / /   \ \</span>
<span class="c1">#           _name = &#39;b&#39;                    / A2   A1 \</span>
<span class="c1">#                                         B2  \   /  B1</span>
<span class="c1">#       class B2(Model):                   \   \ /   /</span>
<span class="c1">#           _name = &#39;b&#39;                     \   a   /</span>
<span class="c1">#           _inherit = [&#39;a&#39;, &#39;b&#39;]            \  |  /</span>
<span class="c1">#                                             \ | /</span>
<span class="c1">#       class A2(Model):                        b</span>
<span class="c1">#           _inherit = &#39;a&#39;</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># THE FIELDS OF A MODEL</span>
<span class="c1">#</span>
<span class="c1"># The fields of a model are given by the model&#39;s definition classes, inherited</span>
<span class="c1"># models (&#39;_inherit&#39; and &#39;_inherits&#39;) and other parties, like custom fields.</span>
<span class="c1"># Note that a field can be partially overridden when it appears on several</span>
<span class="c1"># definition classes of its model.  In that case, the field&#39;s final definition</span>
<span class="c1"># depends on the presence or absence of each definition class, which itself</span>
<span class="c1"># depends on the modules loaded in the registry.</span>
<span class="c1">#</span>
<span class="c1"># By design, the registry class has access to all the fields on the model&#39;s</span>
<span class="c1"># definition classes.  When possible, the field is used directly from the</span>
<span class="c1"># model&#39;s registry class.  There are a number of cases where the field cannot be</span>
<span class="c1"># used directly:</span>
<span class="c1">#  - the field is related (and bits may not be shared);</span>
<span class="c1">#  - the field is overridden on definition classes;</span>
<span class="c1">#  - the field is defined for another model (and accessible by mixin).</span>
<span class="c1">#</span>
<span class="c1"># The last case prevents sharing the field, because the field object is specific</span>
<span class="c1"># to a model, and is used as a key in several key dictionaries, like the record</span>
<span class="c1"># cache and pending computations.</span>
<span class="c1">#</span>
<span class="c1"># Setting up a field on its definition class helps saving memory and time.</span>
<span class="c1"># Indeed, when sharing is possible, the field&#39;s setup is almost entirely done</span>
<span class="c1"># where the field was defined.  It is thus done when the definition class was</span>
<span class="c1"># created, and it may be reused across registries.</span>
<span class="c1">#</span>
<span class="c1"># In the example below, the field &#39;foo&#39; appears once on its model&#39;s definition</span>
<span class="c1"># classes.  Assuming that it is not related, that field can be set up directly</span>
<span class="c1"># on its definition class.  If the model appears in several registries, the</span>
<span class="c1"># field &#39;foo&#39; is effectively shared across registries.</span>
<span class="c1">#</span>
<span class="c1">#       class A1(Model):                      Model</span>
<span class="c1">#           _name = &#39;a&#39;                        / \</span>
<span class="c1">#           foo = ...                         /   \</span>
<span class="c1">#           bar = ...                       A2     A1</span>
<span class="c1">#                                            bar    foo, bar</span>
<span class="c1">#       class A2(Model):                      \   /</span>
<span class="c1">#           _inherit = &#39;a&#39;                     \ /</span>
<span class="c1">#           bar = ...                           a</span>
<span class="c1">#                                                bar</span>
<span class="c1">#</span>
<span class="c1"># On the other hand, the field &#39;bar&#39; is overridden in its model&#39;s definition</span>
<span class="c1"># classes.  In that case, the framework recreates the field on the model&#39;s</span>
<span class="c1"># registry class.  The field&#39;s setup will be based on its definitions, and will</span>
<span class="c1"># not be shared across registries.</span>
<span class="c1">#</span>
<span class="c1"># The so-called magic fields (&#39;id&#39;, &#39;display_name&#39;, ...) used to be added on</span>
<span class="c1"># registry classes.  But doing so prevents them from being shared.  So instead,</span>
<span class="c1"># we add them on definition classes that define a model without extending it.</span>
<span class="c1"># This increases the number of fields that are shared across registries.</span>

<div class="viewcode-block" id="is_definition_class">
<a class="viewcode-back" href="../../odoo.html#odoo.models.is_definition_class">[docs]</a>
<span class="k">def</span> <span class="nf">is_definition_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return whether ``cls`` is a model definition class. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">MetaModel</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;pool&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="is_registry_class">
<a class="viewcode-back" href="../../odoo.html#odoo.models.is_registry_class">[docs]</a>
<span class="k">def</span> <span class="nf">is_registry_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return whether ``cls`` is a model registry class. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;pool&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="BaseModel">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel">[docs]</a>
<span class="k">class</span> <span class="nc">BaseModel</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">MetaModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for Odoo models.</span>

<span class="sd">    Odoo models are created by inheriting one of the following:</span>

<span class="sd">    *   :class:`Model` for regular database-persisted models</span>

<span class="sd">    *   :class:`TransientModel` for temporary data, stored in the database but</span>
<span class="sd">        automatically vacuumed every so often</span>

<span class="sd">    *   :class:`AbstractModel` for abstract super classes meant to be shared by</span>
<span class="sd">        multiple inheriting models</span>

<span class="sd">    The system automatically instantiates every model once per database. Those</span>
<span class="sd">    instances represent the available models on each database, and depend on</span>
<span class="sd">    which modules are installed on that database. The actual class of each</span>
<span class="sd">    instance is built from the Python classes that create and inherit from the</span>
<span class="sd">    corresponding model.</span>

<span class="sd">    Every model instance is a &quot;recordset&quot;, i.e., an ordered collection of</span>
<span class="sd">    records of the model. Recordsets are returned by methods like</span>
<span class="sd">    :meth:`~.browse`, :meth:`~.search`, or field accesses. Records have no</span>
<span class="sd">    explicit representation: a record is represented as a recordset of one</span>
<span class="sd">    record.</span>

<span class="sd">    To create a class that should not be instantiated,</span>
<span class="sd">    the :attr:`~odoo.models.BaseModel._register` attribute may be set to False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;env&#39;</span><span class="p">,</span> <span class="s1">&#39;_ids&#39;</span><span class="p">,</span> <span class="s1">&#39;_prefetch_ids&#39;</span><span class="p">]</span>

    <span class="n">_auto</span> <span class="o">=</span> <span class="kc">False</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Whether a database table should be created.</span>
<span class="sd">    If set to ``False``, override :meth:`~odoo.models.BaseModel.init`</span>
<span class="sd">    to create the database table.</span>

<span class="sd">    Automatically defaults to `True` for :class:`Model` and</span>
<span class="sd">    :class:`TransientModel`, `False` for :class:`AbstractModel`.</span>

<span class="sd">    .. tip:: To create a model without any table, inherit</span>
<span class="sd">            from :class:`~odoo.models.AbstractModel`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_register</span> <span class="o">=</span> <span class="kc">False</span>           <span class="c1">#: registry visibility</span>
    <span class="n">_abstract</span> <span class="o">=</span> <span class="kc">True</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Whether the model is *abstract*.</span>

<span class="sd">    .. seealso:: :class:`AbstractModel`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_transient</span> <span class="o">=</span> <span class="kc">False</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Whether the model is *transient*.</span>

<span class="sd">    .. seealso:: :class:`TransientModel`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_name</span> <span class="o">=</span> <span class="kc">None</span>                <span class="c1">#: the model name (in dot-notation, module namespace)</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="kc">None</span>         <span class="c1">#: the model&#39;s informal name</span>
    <span class="n">_module</span> <span class="o">=</span> <span class="kc">None</span>              <span class="c1">#: the model&#39;s module (in the Odoo sense)</span>
    <span class="n">_custom</span> <span class="o">=</span> <span class="kc">False</span>             <span class="c1">#: should be True for custom models only</span>

    <span class="n">_inherit</span> <span class="o">=</span> <span class="p">()</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Python-inherited models:</span>

<span class="sd">    :type: str or list(str)</span>

<span class="sd">    .. note::</span>

<span class="sd">        * If :attr:`._name` is set, name(s) of parent models to inherit from</span>
<span class="sd">        * If :attr:`._name` is unset, name of a single model to extend in-place</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_inherits</span> <span class="o">=</span> <span class="n">frozendict</span><span class="p">()</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;dictionary {&#39;parent_model&#39;: &#39;m2o_field&#39;} mapping the _name of the parent business</span>
<span class="sd">    objects to the names of the corresponding foreign key fields to use::</span>

<span class="sd">      _inherits = {</span>
<span class="sd">          &#39;a.model&#39;: &#39;a_field_id&#39;,</span>
<span class="sd">          &#39;b.model&#39;: &#39;b_field_id&#39;</span>
<span class="sd">      }</span>

<span class="sd">    implements composition-based inheritance: the new model exposes all</span>
<span class="sd">    the fields of the inherited models but stores none of them:</span>
<span class="sd">    the values themselves remain stored on the linked record.</span>

<span class="sd">    .. warning::</span>

<span class="sd">      if multiple fields with the same name are defined in the</span>
<span class="sd">      :attr:`~odoo.models.Model._inherits`-ed models, the inherited field will</span>
<span class="sd">      correspond to the last one (in the inherits list order).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_table</span> <span class="o">=</span> <span class="kc">None</span>               <span class="c1">#: SQL table name used by model if :attr:`_auto`</span>
    <span class="n">_table_query</span> <span class="o">=</span> <span class="kc">None</span>         <span class="c1">#: SQL expression of the table&#39;s content (optional)</span>
    <span class="n">_sql_constraints</span> <span class="o">=</span> <span class="p">[]</span>       <span class="c1">#: SQL constraints [(name, sql_def, message)]</span>

    <span class="n">_rec_name</span> <span class="o">=</span> <span class="kc">None</span>            <span class="c1">#: field to use for labeling records, default: ``name``</span>
    <span class="n">_rec_names_search</span> <span class="o">=</span> <span class="kc">None</span>    <span class="c1">#: fields to consider in ``name_search``</span>
    <span class="n">_order</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span>               <span class="c1">#: default order field for searching results</span>
    <span class="n">_parent_name</span> <span class="o">=</span> <span class="s1">&#39;parent_id&#39;</span>  <span class="c1">#: the many2one field used as parent field</span>
    <span class="n">_parent_store</span> <span class="o">=</span> <span class="kc">False</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;set to True to compute parent_path field.</span>

<span class="sd">    Alongside a :attr:`~.parent_path` field, sets up an indexed storage</span>
<span class="sd">    of the tree structure of records, to enable faster hierarchical queries</span>
<span class="sd">    on the records of the current model using the ``child_of`` and</span>
<span class="sd">    ``parent_of`` domain operators.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_active_name</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;field to use for active records, automatically set to either ``&quot;active&quot;``</span>
<span class="sd">    or ``&quot;x_active&quot;``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_fold_name</span> <span class="o">=</span> <span class="s1">&#39;fold&#39;</span>         <span class="c1">#: field to determine folded groups in kanban views</span>

    <span class="n">_translate</span> <span class="o">=</span> <span class="kc">True</span>           <span class="c1"># False disables translations export for this model (Old API)</span>
    <span class="n">_check_company_auto</span> <span class="o">=</span> <span class="kc">False</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;On write and create, call ``_check_company`` to ensure companies</span>
<span class="sd">    consistency on the relational fields having ``check_company=True``</span>
<span class="sd">    as attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_allow_sudo_commands</span> <span class="o">=</span> <span class="kc">True</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Allow One2many and Many2many Commands targeting this model in an environment using `sudo()` or `with_user()`.</span>
<span class="sd">    By disabling this flag, security-sensitive models protect themselves</span>
<span class="sd">    against malicious manipulation of One2many or Many2many fields</span>
<span class="sd">    through an environment using `sudo` or a more priviledged user.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_depends</span> <span class="o">=</span> <span class="n">frozendict</span><span class="p">()</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;dependencies of models backed up by SQL views</span>
<span class="sd">    ``{model_name: field_names}``, where ``field_names`` is an iterable.</span>
<span class="sd">    This is only used to determine the changes to flush to database before</span>
<span class="sd">    executing ``search()`` or ``read_group()``. It won&#39;t be used for cache</span>
<span class="sd">    invalidation or recomputing fields.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># default values for _transient_vacuum()</span>
    <span class="n">_transient_max_count</span> <span class="o">=</span> <span class="n">lazy_classproperty</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;osv_memory_count_limit&#39;</span><span class="p">))</span>
    <span class="s2">&quot;maximum number of transient records, unlimited if ``0``&quot;</span>
    <span class="n">_transient_max_hours</span> <span class="o">=</span> <span class="n">lazy_classproperty</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transient_age_limit&#39;</span><span class="p">))</span>
    <span class="s2">&quot;maximum idle lifetime (in hours), unlimited if ``0``&quot;</span>

    <span class="k">def</span> <span class="nf">_valid_field_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return whether the given parameter name is valid for the field. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;related_sudo&#39;</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_add_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Add the given ``field`` under the given ``name`` in the class &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span>

        <span class="c1"># Assert the name is an existing field in the model, or any model in the _inherits</span>
        <span class="c1"># or a custom field (starting by `x_`)</span>
        <span class="n">is_class_field</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">fields</span><span class="o">.</span><span class="n">Field</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">cls</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">inherit</span><span class="p">]</span> <span class="k">for</span> <span class="n">inherit</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_inherits</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">is_class_field</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_is_manual_name</span><span class="p">(</span><span class="n">name</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The field `</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">` is not defined in the `</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="si">}</span><span class="s2">` Python class and does not start with &#39;x_&#39;&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Assert the attribute to assign is a Field</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;You can only add `fields.Field` objects to a model fields&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">),</span> <span class="n">Field</span><span class="p">):</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;In model </span><span class="si">%r</span><span class="s2">, field </span><span class="si">%r</span><span class="s2"> overriding existing value&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="n">field</span><span class="o">.</span><span class="n">_toplevel</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">field</span><span class="o">.</span><span class="n">__set_name__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="c1"># add field as an attribute and in cls._fields (for reflection)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_pop_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Remove the field with the given ``name`` from the model.</span>
<span class="sd">            This method should only be used for manual fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">discardattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_rec_name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
            <span class="c1"># fixup _rec_name and display_name&#39;s dependencies</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_rec_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">display_name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">field_depends</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">field_depends</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">display_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                    <span class="n">dep</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">field_depends</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">display_name</span><span class="p">]</span> <span class="k">if</span> <span class="n">dep</span> <span class="o">!=</span> <span class="n">name</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">field</span>

    <span class="c1">#</span>
    <span class="c1"># Goal: try to apply inheritance at the instantiation level and</span>
    <span class="c1">#       put objects in the pool var</span>
    <span class="c1">#</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_build_model</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">cr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Instantiate a given model in the registry.</span>

<span class="sd">        This method creates or extends a &quot;registry&quot; class for the given model.</span>
<span class="sd">        This &quot;registry&quot; class carries inferred model metadata, and inherits (in</span>
<span class="sd">        the Python sense) from all classes that define the model, and possibly</span>
<span class="sd">        other registry classes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;_constraints&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Model attribute &#39;_constraints&#39; is no longer supported, &quot;</span>
                            <span class="s2">&quot;please use @api.constrains on methods instead.&quot;</span><span class="p">)</span>

        <span class="c1"># Keep links to non-inherited constraints in cls; this is useful for</span>
        <span class="c1"># instance when exporting translations</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_local_sql_constraints</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_sql_constraints&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="c1"># all models except &#39;base&#39; implicitly inherit from &#39;base&#39;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_inherit</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;base&#39;</span><span class="p">:</span>
            <span class="n">parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">)</span>

        <span class="c1"># create or retrieve the model&#39;s class</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pool</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Model </span><span class="si">%r</span><span class="s2"> does not exist in registry.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">ModelClass</span> <span class="o">=</span> <span class="n">pool</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">ModelClass</span><span class="o">.</span><span class="n">_build_model_check_base</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
            <span class="n">check_parent</span> <span class="o">=</span> <span class="n">ModelClass</span><span class="o">.</span><span class="n">_build_model_check_parent</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ModelClass</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,),</span> <span class="p">{</span>
                <span class="s1">&#39;_name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;_register&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;_original_module&#39;</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_module</span><span class="p">,</span>
                <span class="s1">&#39;_inherit_module&#39;</span><span class="p">:</span> <span class="p">{},</span>                  <span class="c1"># map parent to introducing module</span>
                <span class="s1">&#39;_inherit_children&#39;</span><span class="p">:</span> <span class="n">OrderedSet</span><span class="p">(),</span>      <span class="c1"># names of children models</span>
                <span class="s1">&#39;_inherits_children&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span>            <span class="c1"># names of children models</span>
                <span class="s1">&#39;_fields&#39;</span><span class="p">:</span> <span class="p">{},</span>                          <span class="c1"># populated in _setup_base()</span>
            <span class="p">})</span>
            <span class="n">check_parent</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_build_model_check_parent</span>

        <span class="c1"># determine all the classes the model should inherit from</span>
        <span class="n">bases</span> <span class="o">=</span> <span class="n">LastOrderedSet</span><span class="p">([</span><span class="bp">cls</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pool</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Model </span><span class="si">%r</span><span class="s2"> inherits from non-existing model </span><span class="si">%r</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="p">))</span>
            <span class="n">parent_class</span> <span class="o">=</span> <span class="n">pool</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">parent_class</span><span class="o">.</span><span class="n">__base_classes</span><span class="p">:</span>
                    <span class="n">bases</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">check_parent</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parent_class</span><span class="p">)</span>
                <span class="n">bases</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">parent_class</span><span class="p">)</span>
                <span class="n">ModelClass</span><span class="o">.</span><span class="n">_inherit_module</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_module</span>
                <span class="n">parent_class</span><span class="o">.</span><span class="n">_inherit_children</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># ModelClass.__bases__ must be assigned those classes; however, this</span>
        <span class="c1"># operation is quite slow, so we do it once in method _prepare_setup()</span>
        <span class="n">ModelClass</span><span class="o">.</span><span class="n">__base_classes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">bases</span><span class="p">)</span>

        <span class="c1"># determine the attributes of the model&#39;s class</span>
        <span class="n">ModelClass</span><span class="o">.</span><span class="n">_build_model_attributes</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>

        <span class="n">check_pg_name</span><span class="p">(</span><span class="n">ModelClass</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>

        <span class="c1"># Transience</span>
        <span class="k">if</span> <span class="n">ModelClass</span><span class="o">.</span><span class="n">_transient</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ModelClass</span><span class="o">.</span><span class="n">_log_access</span><span class="p">,</span> \
                <span class="s2">&quot;TransientModels must have log_access turned on, &quot;</span> \
                <span class="s2">&quot;in order to implement their vacuum policy&quot;</span>

        <span class="c1"># link the class to the registry, and update the registry</span>
        <span class="n">ModelClass</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">pool</span>
        <span class="n">pool</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ModelClass</span>

        <span class="k">return</span> <span class="n">ModelClass</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_build_model_check_base</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Check whether ``model_class`` can be extended with ``cls``. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_abstract</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_abstract</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> transforms the abstract model </span><span class="si">%r</span><span class="s2"> into a non-abstract model. &quot;</span>
                   <span class="s2">&quot;That class should either inherit from AbstractModel, or set a different &#39;_name&#39;.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_transient</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_transient</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_transient</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> transforms the transient model </span><span class="si">%r</span><span class="s2"> into a non-transient model. &quot;</span>
                       <span class="s2">&quot;That class should either inherit from TransientModel, or set a different &#39;_name&#39;.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> transforms the model </span><span class="si">%r</span><span class="s2"> into a transient model. &quot;</span>
                       <span class="s2">&quot;That class should either inherit from Model, or set a different &#39;_name&#39;.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_build_model_check_parent</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">parent_class</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Check whether ``model_class`` can inherit from ``parent_class``. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_abstract</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">parent_class</span><span class="o">.</span><span class="n">_abstract</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;In </span><span class="si">%s</span><span class="s2">, the abstract model </span><span class="si">%r</span><span class="s2"> cannot inherit from the non-abstract model </span><span class="si">%r</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">parent_class</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_build_model_attributes</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pool</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Initialize base model attributes. &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_log_access</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_auto</span>
        <span class="n">inherits</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">depends</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_sql_constraints</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__base_classes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">is_definition_class</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
                <span class="c1"># the following attributes are not taken from registry classes</span>
                <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="n">_inherit</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">base</span><span class="o">.</span><span class="n">_description</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The model </span><span class="si">%s</span><span class="s2"> has no _description&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">_description</span> <span class="ow">or</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_description</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">_table</span> <span class="ow">or</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_table</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_log_access</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s1">&#39;_log_access&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_log_access</span><span class="p">)</span>

            <span class="n">inherits</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">_inherits</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">mname</span><span class="p">,</span> <span class="n">fnames</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="n">_depends</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">depends</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">mname</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="n">_sql_constraints</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_sql_constraints</span><span class="p">[</span><span class="n">cons</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cons</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">_sql_constraints</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_sql_constraints</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="c1"># avoid assigning an empty dict to save memory</span>
        <span class="k">if</span> <span class="n">inherits</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_inherits</span> <span class="o">=</span> <span class="n">inherits</span>
        <span class="k">if</span> <span class="n">depends</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_depends</span> <span class="o">=</span> <span class="n">depends</span>

        <span class="c1"># update _inherits_children of parent models</span>
        <span class="k">for</span> <span class="n">parent_name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_inherits</span><span class="p">:</span>
            <span class="n">pool</span><span class="p">[</span><span class="n">parent_name</span><span class="p">]</span><span class="o">.</span><span class="n">_inherits_children</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

        <span class="c1"># recompute attributes of _inherit_children models</span>
        <span class="k">for</span> <span class="n">child_name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_inherit_children</span><span class="p">:</span>
            <span class="n">child_class</span> <span class="o">=</span> <span class="n">pool</span><span class="p">[</span><span class="n">child_name</span><span class="p">]</span>
            <span class="n">child_class</span><span class="o">.</span><span class="n">_build_model_attributes</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_init_constraints_onchanges</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="c1"># store list of sql constraint qualified names</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_sql_constraints</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_sql_constraints</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_table</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span>

        <span class="c1"># reset properties memoized on cls</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_constraint_methods</span> <span class="o">=</span> <span class="n">BaseModel</span><span class="o">.</span><span class="n">_constraint_methods</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_ondelete_methods</span> <span class="o">=</span> <span class="n">BaseModel</span><span class="o">.</span><span class="n">_ondelete_methods</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_onchange_methods</span> <span class="o">=</span> <span class="n">BaseModel</span><span class="o">.</span><span class="n">_onchange_methods</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_constraint_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return a list of methods implementing Python constraints. &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">is_constraint</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;_constrains&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
            <span class="c1"># wrap func into a proxy function with explicit &#39;_constrains&#39;</span>
            <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">wrapper</span>

        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">getmembers</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">is_constraint</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">_constrains</span><span class="p">):</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">wrap</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">_constrains</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="n">_constrains</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;method </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">: @constrains parameter </span><span class="si">%r</span><span class="s2"> is not a field name&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">or</span> <span class="n">field</span><span class="o">.</span><span class="n">inverse</span> <span class="ow">or</span> <span class="n">field</span><span class="o">.</span><span class="n">inherited</span><span class="p">):</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;method </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">: @constrains parameter </span><span class="si">%r</span><span class="s2"> is not writeable&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

        <span class="c1"># optimization: memoize result on cls, it will not be recomputed</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_constraint_methods</span> <span class="o">=</span> <span class="n">methods</span>
        <span class="k">return</span> <span class="n">methods</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_ondelete_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return a list of methods implementing checks before unlinking. &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">is_ondelete</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;_ondelete&#39;</span><span class="p">)</span>

        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="n">func</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">getmembers</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">is_ondelete</span><span class="p">)]</span>
        <span class="c1"># optimization: memoize results on cls, it will not be recomputed</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_ondelete_methods</span> <span class="o">=</span> <span class="n">methods</span>
        <span class="k">return</span> <span class="n">methods</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_onchange_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return a dictionary mapping field names to onchange methods. &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">is_onchange</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;_onchange&#39;</span><span class="p">)</span>

        <span class="c1"># collect onchange methods on the model&#39;s class</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">getmembers</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">is_onchange</span><span class="p">):</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="n">_onchange</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
                    <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">methods</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;@api.onchange</span><span class="si">%r</span><span class="s2"> parameters must be field names -&gt; not valid: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">func</span><span class="o">.</span><span class="n">_onchange</span><span class="p">,</span> <span class="n">missing</span>
                <span class="p">)</span>

        <span class="c1"># add onchange methods to implement &quot;change_default&quot; on fields</span>
        <span class="k">def</span> <span class="nf">onchange_default</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_write</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.default&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_model_defaults</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">condition</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">change_default</span><span class="p">:</span>
                <span class="n">methods</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">onchange_default</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span>

        <span class="c1"># optimization: memoize result on cls, it will not be recomputed</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_onchange_methods</span> <span class="o">=</span> <span class="n">methods</span>
        <span class="k">return</span> <span class="n">methods</span>

    <span class="k">def</span> <span class="nf">_is_an_ordinary_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">is_an_ordinary_table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ensure_xml_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Create missing external ids for records in ``self``, and return an</span>
<span class="sd">            iterator of pairs ``(record, xmlid)`` for the records in ``self``.</span>

<span class="sd">        :rtype: Iterable[Model, str | None]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">((</span><span class="n">record</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">iter</span><span class="p">([])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_an_ordinary_table</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;You can not export the column ID of model </span><span class="si">%s</span><span class="s2">, because the &quot;</span>
                <span class="s2">&quot;table </span><span class="si">%s</span><span class="s2"> is not an ordinary table.&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">))</span>

        <span class="n">modname</span> <span class="o">=</span> <span class="s1">&#39;__export__&#39;</span>

        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT res_id, module, name</span>
<span class="s2">            FROM ir_model_data</span>
<span class="s2">            WHERE model = </span><span class="si">%s</span><span class="s2"> AND res_id IN </span><span class="si">%s</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)))</span>
        <span class="n">xids</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">res_id</span><span class="p">:</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">res_id</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">def</span> <span class="nf">to_xid</span><span class="p">(</span><span class="n">record_id</span><span class="p">):</span>
            <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">=</span> <span class="n">xids</span><span class="p">[</span><span class="n">record_id</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="k">if</span> <span class="n">module</span> <span class="k">else</span> <span class="n">name</span>

        <span class="c1"># create missing xml ids</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xids</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">missing</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">to_xid</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span>
            <span class="p">)</span>

        <span class="n">xids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="n">modname</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">r</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span>
                <span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">8</span><span class="p">],</span>
            <span class="p">)))</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">missing</span>
        <span class="p">)</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;res_id&#39;</span><span class="p">]</span>

        <span class="c1"># disable eventual async callback / support for the extent of</span>
        <span class="c1"># the COPY FROM, as these are apparently incompatible</span>
        <span class="n">callback</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">get_wait_callback</span><span class="p">()</span>
        <span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">set_wait_callback</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">copy_from</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span>
                <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="sa">u</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">modname</span><span class="p">,</span>
                        <span class="n">record</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                        <span class="n">xids</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">missing</span>
                <span class="p">)),</span>
                <span class="n">table</span><span class="o">=</span><span class="s1">&#39;ir_model_data&#39;</span><span class="p">,</span>
                <span class="n">columns</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">set_wait_callback</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">invalidate_model</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">to_xid</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_export_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">_is_toplevel_call</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Export fields of the records in ``self``.</span>

<span class="sd">        :param list fields: list of lists of fields to traverse</span>
<span class="sd">        :param bool _is_toplevel_call:</span>
<span class="sd">            used when recursing, avoid using when calling from outside</span>
<span class="sd">        :return: list of lists of corresponding values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">import_compatible</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;import_compat&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">splittor</span><span class="p">(</span><span class="n">rs</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot; Splits the self recordset in batches of 1000 (to avoid</span>
<span class="sd">            entire-recordset-prefetch-effects) &amp; removes the previous batch</span>
<span class="sd">            from the cache after it&#39;s been iterated in full</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="p">),</span> <span class="mi">1000</span><span class="p">):</span>
                <span class="n">sub</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mi">1000</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">rec</span>
                <span class="n">sub</span><span class="o">.</span><span class="n">invalidate_recordset</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_toplevel_call</span><span class="p">:</span>
            <span class="n">splittor</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">rs</span><span class="p">:</span> <span class="n">rs</span>

        <span class="c1"># memory stable but ends up prefetching 275 fields (???)</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">splittor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># main line of record, initially empty</span>
            <span class="n">current</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>

            <span class="c1"># list of primary fields followed by secondary field(s)</span>
            <span class="n">primary_done</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># process column by column</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">name</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">primary_done</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;.id&#39;</span><span class="p">:</span>
                    <span class="n">current</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>
                    <span class="n">current</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

                    <span class="c1"># this part could be simpler, but it has to be done this way</span>
                    <span class="c1"># in order to reproduce the former behavior</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
                        <span class="n">current</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_export</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">primary_done</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                        <span class="c1"># recursively export the fields that follow name; use</span>
                        <span class="c1"># &#39;display_name&#39; where no subfield is exported</span>
                        <span class="n">fields2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">or</span> <span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span> <span class="k">else</span> <span class="p">[])</span>
                                   <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>

                        <span class="c1"># in import_compat mode, m2m should always be exported as</span>
                        <span class="c1"># a comma-separated list of xids or names in a single cell</span>
                        <span class="k">if</span> <span class="n">import_compatible</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2many&#39;</span><span class="p">:</span>
                            <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="c1"># find out which subfield the user wants &amp; its</span>
                            <span class="c1"># location as we might not get it as the first</span>
                            <span class="c1"># column we encounter</span>
                            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;display_name&#39;</span><span class="p">]:</span>
                                <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
                                    <span class="n">index</span> <span class="o">=</span> <span class="n">fields2</span><span class="o">.</span><span class="n">index</span><span class="p">([</span><span class="n">name</span><span class="p">])</span>
                                    <span class="k">break</span>
                            <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="c1"># not found anything, assume we just want the</span>
                                <span class="c1"># display_name in the first column</span>
                                <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="n">index</span> <span class="o">=</span> <span class="n">i</span>

                            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>
                                <span class="n">xml_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">xid</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">xid</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">__ensure_xml_id</span><span class="p">()]</span>
                                <span class="n">current</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xml_ids</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">current</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_export</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
                            <span class="k">continue</span>

                        <span class="n">lines2</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">_export_rows</span><span class="p">(</span><span class="n">fields2</span><span class="p">,</span> <span class="n">_is_toplevel_call</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">lines2</span><span class="p">:</span>
                            <span class="c1"># merge first line with record&#39;s main line</span>
                            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines2</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                                <span class="k">if</span> <span class="n">val</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                                    <span class="n">current</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                            <span class="c1"># append the other lines at the end</span>
                            <span class="n">lines</span> <span class="o">+=</span> <span class="n">lines2</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">current</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># if any xid should be exported, only do so at toplevel</span>
        <span class="k">if</span> <span class="n">_is_toplevel_call</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">):</span>
            <span class="n">bymodels</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
            <span class="n">xidmap</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="c1"># collect all the tuples in &quot;lines&quot; (along with their coordinates)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                        <span class="n">bymodels</span><span class="p">[</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">xidmap</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
            <span class="c1"># for each model, xid-export everything and inject in matrix</span>
            <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">bymodels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">record</span><span class="p">,</span> <span class="n">xid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="o">.</span><span class="n">__ensure_xml_id</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xidmap</span><span class="o">.</span><span class="n">pop</span><span class="p">((</span><span class="n">record</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">)):</span>
                        <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">xid</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">xidmap</span><span class="p">,</span> <span class="s2">&quot;failed to export xids for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">xidmap</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">lines</span>

<div class="viewcode-block" id="BaseModel.export_data">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.export_data">[docs]</a>
    <span class="k">def</span> <span class="nf">export_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields_to_export</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Export fields for selected objects</span>

<span class="sd">        This method is used when exporting data via client menu</span>

<span class="sd">        :param list fields_to_export: list of fields</span>
<span class="sd">        :returns: dictionary with a *datas* matrix</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">is_admin</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_group</span><span class="p">(</span><span class="s1">&#39;base.group_allow_export&#39;</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;You don&#39;t have the rights to export data. Please contact an Administrator.&quot;</span><span class="p">))</span>
        <span class="n">fields_to_export</span> <span class="o">=</span> <span class="p">[</span><span class="n">fix_import_export_id_paths</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields_to_export</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;datas&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_export_rows</span><span class="p">(</span><span class="n">fields_to_export</span><span class="p">)}</span></div>


<div class="viewcode-block" id="BaseModel.load">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.load">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempts to load the data matrix, and returns a list of ids (or</span>
<span class="sd">        ``False`` if there was an error and no id could be generated) and a</span>
<span class="sd">        list of messages.</span>

<span class="sd">        The ids are those of the records created and saved (in database), in</span>
<span class="sd">        the same order they were extracted from the file. They can be passed</span>
<span class="sd">        directly to :meth:`~read`</span>

<span class="sd">        :param fields: list of fields to import, at the same index as the corresponding data</span>
<span class="sd">        :type fields: list(str)</span>
<span class="sd">        :param data: row-major matrix of data to import</span>
<span class="sd">        :type data: list(list(str))</span>
<span class="sd">        :returns: {ids: list(int)|False, messages: [Message][, lastrow: int]}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>

        <span class="c1"># determine values of mode, current_module and noupdate</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;init&#39;</span><span class="p">)</span>
        <span class="n">current_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="s1">&#39;__import__&#39;</span><span class="p">)</span>
        <span class="n">noupdate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;noupdate&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># add current module in context for the conversion of xml ids</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">_import_current_module</span><span class="o">=</span><span class="n">current_module</span><span class="p">)</span>

        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">savepoint</span><span class="p">(</span><span class="n">flush</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">fix_import_export_id_paths</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>
        <span class="n">fg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_get</span><span class="p">()</span>

        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># list of (xid, vals, info) for records to be created in batch</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">batch_xml_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="c1"># models in which we may have created / modified data, therefore might</span>
        <span class="c1"># require flushing in order to name_search: the root model and any</span>
        <span class="c1"># o2m</span>
        <span class="n">creatable_models</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">field_path</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;.id&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">model_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_fields</span><span class="p">[</span><span class="n">field_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">odoo</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">):</span>
                <span class="c1"># this only applies for toplevel m2o (?) fields</span>
                <span class="k">if</span> <span class="n">field_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name_create_enabled_fieds&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}):</span>
                    <span class="n">creatable_models</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model_fields</span><span class="p">[</span><span class="n">field_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">field_path</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;.id&#39;</span><span class="p">):</span>
                    <span class="k">break</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">],</span> <span class="n">odoo</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">One2many</span><span class="p">):</span>
                    <span class="n">comodel</span> <span class="o">=</span> <span class="n">model_fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">comodel_name</span>
                    <span class="n">creatable_models</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">comodel</span><span class="p">)</span>
                    <span class="n">model_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">comodel</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span>

        <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">xml_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">batch</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">xml_id</span> <span class="ow">and</span> <span class="n">model</span><span class="p">),</span> \
                <span class="s2">&quot;flush can specify *either* an external id or a model, not both&quot;</span>

            <span class="k">if</span> <span class="n">xml_id</span> <span class="ow">and</span> <span class="n">xml_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">batch_xml_ids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">xml_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">:</span>
                    <span class="k">return</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">and</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">creatable_models</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">xml_id</span><span class="o">=</span><span class="n">xid</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">vals</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">noupdate</span><span class="o">=</span><span class="n">noupdate</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">xid</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">batch</span>
            <span class="p">]</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">batch_xml_ids</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="c1"># try to create in batch</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">cr</span><span class="o">.</span><span class="n">savepoint</span><span class="p">():</span>
                    <span class="n">recs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_records</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;update&#39;</span><span class="p">)</span>
                    <span class="n">ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">recs</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">InternalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># broken transaction, exit and hope the source error was already logged</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">):</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="n">data_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;info&#39;</span><span class="p">]</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;Unknown database error: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)))</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># try again, this time record by record</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rec_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">cr</span><span class="o">.</span><span class="n">savepoint</span><span class="p">():</span>
                        <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_records</span><span class="p">([</span><span class="n">rec_data</span><span class="p">],</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;update&#39;</span><span class="p">)</span>
                        <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">Warning</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="n">rec_data</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;warning&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                <span class="k">except</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="n">rec_data</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">PGERROR_TO_OE</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">pgcode</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="n">fg</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">e</span><span class="p">)))</span>
                    <span class="c1"># Failed to write, log to messages, rollback savepoint (to</span>
                    <span class="c1"># avoid broken transaction) and keep going</span>
                    <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span> <span class="n">UserError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="n">rec_data</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                    <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Error while loading record&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="n">rec_data</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Unknown error during import:&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">u</span><span class="s1">&#39; </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
                    <span class="n">moreinfo</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Resolve other errors first&#39;</span><span class="p">)</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span> <span class="n">moreinfo</span><span class="o">=</span><span class="n">moreinfo</span><span class="p">))</span>
                    <span class="c1"># Failed for some reason, perhaps due to invalid data supplied,</span>
                    <span class="c1"># rollback savepoint and keep going</span>
                    <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">errors</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="ow">and</span> <span class="p">(</span><span class="n">errors</span> <span class="o">&gt;=</span> <span class="n">i</span> <span class="o">/</span> <span class="mi">10</span><span class="p">):</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;warning&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;Found more than 10 errors and more than one error per 10 records, interrupted to avoid showing too many errors.&quot;</span><span class="p">)</span>
                    <span class="p">})</span>
                    <span class="k">break</span>

        <span class="c1"># make &#39;flush&#39; available to the methods below, in the case where XMLID</span>
        <span class="c1"># resolution fails, for instance</span>
        <span class="n">flush_recordset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">import_flush</span><span class="o">=</span><span class="n">flush</span><span class="p">,</span> <span class="n">import_cache</span><span class="o">=</span><span class="n">LRU</span><span class="p">(</span><span class="mi">1024</span><span class="p">))</span>

        <span class="c1"># TODO: break load&#39;s API instead of smuggling via context?</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_import_limit&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="n">extracted</span> <span class="o">=</span> <span class="n">flush_recordset</span><span class="o">.</span><span class="n">_extract_records</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

        <span class="n">converted</span> <span class="o">=</span> <span class="n">flush_recordset</span><span class="o">.</span><span class="n">_convert_records</span><span class="p">(</span><span class="n">extracted</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">)</span>

        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rows&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}}</span>
        <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">converted</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;import_file&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;import_skip_records&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;import_skip_records&#39;</span><span class="p">]]):</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="n">xid</span><span class="p">:</span>
                <span class="n">xid</span> <span class="o">=</span> <span class="n">xid</span> <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">xid</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_module</span><span class="p">,</span> <span class="n">xid</span><span class="p">)</span>
                <span class="n">batch_xml_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">xid</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">id</span><span class="p">:</span>
                <span class="n">record</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">xid</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>

        <span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">):</span>
            <span class="n">sp</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># cancel all changes done to the registry/ormcache</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">reset_changes</span><span class="p">()</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">rollback</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">nextrow</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">][</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">nextrow</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">:</span>
            <span class="n">nextrow</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;ids&#39;</span><span class="p">:</span> <span class="n">ids</span><span class="p">,</span>
            <span class="s1">&#39;messages&#39;</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span>
            <span class="s1">&#39;nextrow&#39;</span><span class="p">:</span> <span class="n">nextrow</span><span class="p">,</span>
        <span class="p">}</span></div>


    <span class="k">def</span> <span class="nf">_add_fake_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">odoo.fields</span> <span class="kn">import</span> <span class="n">Char</span><span class="p">,</span> <span class="n">Integer</span>
        <span class="n">fields</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">Char</span><span class="p">(</span><span class="s1">&#39;rec_name&#39;</span><span class="p">)</span>
        <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Char</span><span class="p">(</span><span class="s1">&#39;External ID&#39;</span><span class="p">)</span>
        <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;.id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="s1">&#39;Database ID&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fields</span>

    <span class="k">def</span> <span class="nf">_extract_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields_</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generates record dicts from the data sequence.</span>

<span class="sd">        The result is a generator of dicts mapping field names to raw</span>
<span class="sd">        (unconverted, unvalidated) values.</span>

<span class="sd">        For relational fields, if sub-fields were provided the value will be</span>
<span class="sd">        a list of sub-records</span>

<span class="sd">        The following sub-fields may be set on the record (by key):</span>

<span class="sd">        * None is the display_name for the record (to use with name_create/name_search)</span>
<span class="sd">        * &quot;id&quot; is the External ID for the record</span>
<span class="sd">        * &quot;.id&quot; is the Database ID for the record</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span>
        <span class="c1"># Fake fields to avoid special cases in extractor</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_fake_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="c1"># m2o fields can&#39;t be on multiple lines so exclude them from the</span>
        <span class="c1"># is_relational field rows filter, but special-case it later on to</span>
        <span class="c1"># be handled with relational fields (as it can have subfields)</span>
        <span class="n">is_relational</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">field</span><span class="p">:</span> <span class="n">fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">relational</span>
        <span class="n">get_o2m_values</span> <span class="o">=</span> <span class="n">itemgetter_tuple</span><span class="p">([</span>
            <span class="n">index</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">fnames</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields_</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fields</span><span class="p">[</span><span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;one2many&#39;</span>
        <span class="p">])</span>
        <span class="n">get_nono2m_values</span> <span class="o">=</span> <span class="n">itemgetter_tuple</span><span class="p">([</span>
            <span class="n">index</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">fnames</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields_</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fields</span><span class="p">[</span><span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;one2many&#39;</span>
        <span class="p">])</span>
        <span class="c1"># Checks if the provided row has any non-empty one2many fields</span>
        <span class="k">def</span> <span class="nf">only_o2m_values</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">get_o2m_values</span><span class="p">(</span><span class="n">row</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">get_nono2m_values</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>

        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

            <span class="c1"># copy non-relational fields to record dict</span>
            <span class="n">record</span> <span class="o">=</span> <span class="p">{</span><span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">value</span>
                      <span class="k">for</span> <span class="n">fnames</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fields_</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
                      <span class="k">if</span> <span class="ow">not</span> <span class="n">is_relational</span><span class="p">(</span><span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">])}</span>

            <span class="c1"># Get all following rows which have relational values attached to</span>
            <span class="c1"># the current record (no non-relational values)</span>
            <span class="n">record_span</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">takewhile</span><span class="p">(</span>
                <span class="n">only_o2m_values</span><span class="p">,</span> <span class="n">itertools</span><span class="o">.</span><span class="n">islice</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="c1"># stitch record row back on for relational fields</span>
            <span class="n">record_span</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">([</span><span class="n">row</span><span class="p">],</span> <span class="n">record_span</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">relfield</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">fnames</span> <span class="ow">in</span> <span class="n">fields_</span> <span class="k">if</span> <span class="n">is_relational</span><span class="p">(</span><span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="n">comodel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">fields</span><span class="p">[</span><span class="n">relfield</span><span class="p">]</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span>

                <span class="c1"># get only cells for this sub-field, should be strictly</span>
                <span class="c1"># non-empty, field path [None] is for display_name field</span>
                <span class="n">indices</span><span class="p">,</span> <span class="n">subfields</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">index</span><span class="p">,</span> <span class="n">fnames</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">or</span> <span class="p">[</span><span class="kc">None</span><span class="p">])</span>
                                           <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">fnames</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields_</span><span class="p">)</span>
                                           <span class="k">if</span> <span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">relfield</span><span class="p">))</span>

                <span class="c1"># return all rows which have at least one value for the</span>
                <span class="c1"># subfields of relfield</span>
                <span class="n">relfield_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="n">itemgetter_tuple</span><span class="p">(</span><span class="n">indices</span><span class="p">),</span> <span class="n">record_span</span><span class="p">)</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">it</span><span class="p">)]</span>
                <span class="n">record</span><span class="p">[</span><span class="n">relfield</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">subrecord</span>
                    <span class="k">for</span> <span class="n">subrecord</span><span class="p">,</span> <span class="n">_subinfo</span> <span class="ow">in</span> <span class="n">comodel</span><span class="o">.</span><span class="n">_extract_records</span><span class="p">(</span><span class="n">subfields</span><span class="p">,</span> <span class="n">relfield_data</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
                <span class="p">]</span>

            <span class="k">yield</span> <span class="n">record</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;rows&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span>
                <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="n">index</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">record_span</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">}}</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">record_span</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_convert_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">records</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Converts records from the source iterable (recursive dicts of</span>
<span class="sd">        strings) into forms which can be written to the database (via</span>
<span class="sd">        ``self.create`` or ``(ir.model.data)._update``)</span>

<span class="sd">        :returns: a list of triplets of (id, xid, record)</span>
<span class="sd">        :rtype: list[(int|None, str|None, dict)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">string</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span><span class="p">:</span>
            <span class="n">field_names</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_field_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span>

        <span class="n">convert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.fields.converter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">for_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_log</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;warning&#39;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;error&#39;</span>
            <span class="c1"># logs the logical (not human-readable) field name for automated</span>
            <span class="c1"># processing of response, but injects human readable in message</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="n">field_names</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
            <span class="n">exc_vals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">record</span><span class="o">=</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">field_name</span><span class="p">)</span>
            <span class="n">record</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span> <span class="n">record</span><span class="o">=</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
                          <span class="n">message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">%</span> <span class="n">exc_vals</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># ensure field_name is added to the exception. Used in import to</span>
                <span class="c1"># concatenate multiple errors in the same block</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;field_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_name</span>
                <span class="n">record</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

        <span class="n">stream</span> <span class="o">=</span> <span class="n">CountingStream</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">record</span><span class="p">,</span> <span class="n">extras</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="c1"># xid</span>
            <span class="n">xid</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="c1"># dbid</span>
            <span class="n">dbid</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="s1">&#39;.id&#39;</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dbid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;.id&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="c1"># in case of overridden id column</span>
                    <span class="n">dbid</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;.id&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">dbid</span><span class="p">)]):</span>
                    <span class="n">log</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">extras</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
                        <span class="n">record</span><span class="o">=</span><span class="n">stream</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                        <span class="n">field</span><span class="o">=</span><span class="s1">&#39;.id&#39;</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;Unknown database identifier &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">dbid</span><span class="p">)))</span>
                    <span class="n">dbid</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">converted</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">_log</span><span class="p">,</span> <span class="n">extras</span><span class="p">,</span> <span class="n">stream</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>

            <span class="k">yield</span> <span class="n">dbid</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">converted</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">extras</span><span class="p">,</span> <span class="n">record</span><span class="o">=</span><span class="n">stream</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">excluded_names</span><span class="o">=</span><span class="p">()):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Invoke the constraint methods for which at least one field name is</span>
<span class="sd">        in ``field_names`` and none is in ``excluded_names``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">field_names</span><span class="p">)</span>
        <span class="n">excluded_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">excluded_names</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraint_methods</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">field_names</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">check</span><span class="o">.</span><span class="n">_constrains</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">excluded_names</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">check</span><span class="o">.</span><span class="n">_constrains</span><span class="p">)):</span>
                <span class="n">check</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="BaseModel.default_get">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.default_get">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">default_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; default_get(fields_list) -&gt; default_values</span>

<span class="sd">        Return default values for the fields in ``fields_list``. Default</span>
<span class="sd">        values are determined by the context, user defaults, and the model</span>
<span class="sd">        itself.</span>

<span class="sd">        :param list fields_list: names of field whose default is requested</span>
<span class="sd">        :return: a dictionary mapping field names to their corresponding default values,</span>
<span class="sd">            if they have a default value.</span>
<span class="sd">        :rtype: dict</span>

<span class="sd">        .. note::</span>

<span class="sd">            Unrequested defaults won&#39;t be considered, there is no need to return a</span>
<span class="sd">            value for fields whose names are not in `fields_list`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">parent_fields</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">ir_defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.default&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_model_defaults</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">fields_list</span><span class="p">:</span>
            <span class="c1"># 1. look up context</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;default_&#39;</span> <span class="o">+</span> <span class="n">name</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">:</span>
                <span class="n">defaults</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">continue</span>

            <span class="c1"># 2. look up ir.default</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ir_defaults</span><span class="p">:</span>
                <span class="n">defaults</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ir_defaults</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">continue</span>

            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># 3. look up field.default</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span><span class="p">:</span>
                <span class="n">defaults</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># 4. delegate to parent model</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">inherited</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">related_field</span>
                <span class="n">parent_fields</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># convert default values to the right format</span>
        <span class="c1">#</span>
        <span class="c1"># we explicitly avoid using _convert_to_write() for x2many fields,</span>
        <span class="c1"># because the latter leaves values like [(Command.LINK, 2),</span>
        <span class="c1"># (Command.LINK, 3)], which are not supported by the web client as</span>
        <span class="c1"># default values; stepping through the cache allows to normalize</span>
        <span class="c1"># such a list to [(Command.SET, 0, [2, 3])], which is properly</span>
        <span class="c1"># supported by the web client</span>
        <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">fname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_cache</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">defaults</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_write</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="c1"># add default values for inherited fields</span>
        <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">names</span> <span class="ow">in</span> <span class="n">parent_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">default_get</span><span class="p">(</span><span class="n">names</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">defaults</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_rec_name_fallback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># if self._rec_name is set, it belongs to self._fields</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span> <span class="ow">or</span> <span class="s1">&#39;id&#39;</span>

<div class="viewcode-block" id="BaseModel.user_has_groups">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.user_has_groups">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">user_has_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groups</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return true if the user is member of at least one of the groups in</span>
<span class="sd">        ``groups``, and is not a member of any of the groups in ``groups``</span>
<span class="sd">        preceded by ``!``. Typically used to resolve ``groups`` attribute in</span>
<span class="sd">        view and model definitions.</span>

<span class="sd">        :param str groups: comma-separated list of fully-qualified group</span>
<span class="sd">            external IDs, e.g., ``base.group_user,base.group_system``,</span>
<span class="sd">            optionally preceded by ``!``</span>
<span class="sd">        :return: True if the current user is a member of one of the given groups</span>
<span class="sd">            not preceded by ``!`` and is not member of any of the groups</span>
<span class="sd">            preceded by ``!``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">odoo.http</span> <span class="kn">import</span> <span class="n">request</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span>

        <span class="n">has_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">not_has_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">group_ext_id</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">group_ext_id</span> <span class="o">=</span> <span class="n">group_ext_id</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">group_ext_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;!&#39;</span><span class="p">:</span>
                <span class="n">not_has_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_ext_id</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">has_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_ext_id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">group_ext_id</span> <span class="ow">in</span> <span class="n">not_has_groups</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">group_ext_id</span> <span class="o">==</span> <span class="s1">&#39;base.group_no_one&#39;</span><span class="p">:</span>
                <span class="c1"># check: the group_no_one is effective in debug mode only</span>
                <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">has_group</span><span class="p">(</span><span class="n">group_ext_id</span><span class="p">)</span> <span class="ow">and</span> <span class="n">request</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">has_group</span><span class="p">(</span><span class="n">group_ext_id</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">group_ext_id</span> <span class="ow">in</span> <span class="n">has_groups</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">group_ext_id</span> <span class="o">==</span> <span class="s1">&#39;base.group_no_one&#39;</span><span class="p">:</span>
                <span class="c1"># check: the group_no_one is effective in debug mode only</span>
                <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">has_group</span><span class="p">(</span><span class="n">group_ext_id</span><span class="p">)</span> <span class="ow">and</span> <span class="n">request</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">has_group</span><span class="p">(</span><span class="n">group_ext_id</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="ow">not</span> <span class="n">has_groups</span></div>


<div class="viewcode-block" id="BaseModel.search_count">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.search_count">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">search_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; search_count(domain[, limit=None]) -&gt; int</span>

<span class="sd">        Returns the number of records in the current model matching :ref:`the</span>
<span class="sd">        provided domain &lt;reference/orm/domains&gt;`.</span>

<span class="sd">        :param domain: :ref:`A search domain &lt;reference/orm/domains&gt;`. Use an empty</span>
<span class="sd">                     list to match all records.</span>
<span class="sd">        :param limit: maximum number of record to count (upperbound) (default: all)</span>

<span class="sd">        This is a high-level method, which should not be overridden. Its actual</span>
<span class="sd">        implementation is done by method :meth:`_search`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseModel.search">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.search">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">returns</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; search(domain[, offset=0][, limit=None][, order=None])</span>

<span class="sd">        Search for the records that satisfy the given ``domain``</span>
<span class="sd">        :ref:`search domain &lt;reference/orm/domains&gt;`.</span>

<span class="sd">        :param domain: :ref:`A search domain &lt;reference/orm/domains&gt;`. Use an empty</span>
<span class="sd">                     list to match all records.</span>
<span class="sd">        :param int offset: number of results to ignore (default: none)</span>
<span class="sd">        :param int limit: maximum number of records to return (default: all)</span>
<span class="sd">        :param str order: sort string</span>
<span class="sd">        :returns: at most ``limit`` records matching the search criteria</span>
<span class="sd">        :raise AccessError: if user is not allowed to access requested information</span>

<span class="sd">        This is a high-level method, which should not be overridden. Its actual</span>
<span class="sd">        implementation is done by method :meth:`_search`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_fetch</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="p">[],</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseModel.search_fetch">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.search_fetch">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">returns</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">search_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; search_fetch(domain, field_names[, offset=0][, limit=None][, order=None])</span>

<span class="sd">        Search for the records that satisfy the given ``domain``</span>
<span class="sd">        :ref:`search domain &lt;reference/orm/domains&gt;`, and fetch the given fields</span>
<span class="sd">        to the cache.  This method is like a combination of methods :meth:`search`</span>
<span class="sd">        and :meth:`fetch`, but it performs both tasks with a minimal number of</span>
<span class="sd">        SQL queries.</span>

<span class="sd">        :param domain: :ref:`A search domain &lt;reference/orm/domains&gt;`. Use an empty</span>
<span class="sd">                     list to match all records.</span>
<span class="sd">        :param field_names: a collection of field names to fetch</span>
<span class="sd">        :param int offset: number of results to ignore (default: none)</span>
<span class="sd">        :param int limit: maximum number of records to return (default: all)</span>
<span class="sd">        :param str order: sort string</span>
<span class="sd">        :returns: at most ``limit`` records matching the search criteria</span>
<span class="sd">        :raise AccessError: if user is not allowed to access requested information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># first determine a query that satisfies the domain and access rules</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="c1"># optimization: don&#39;t execute the query at all</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">()</span>

        <span class="n">fields_to_fetch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_fields_to_fetch</span><span class="p">(</span><span class="n">field_names</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">fields_to_fetch</span><span class="p">)</span></div>


    <span class="c1">#</span>
    <span class="c1"># display_name, name_get, name_create, name_search</span>
    <span class="c1">#</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">,)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span> <span class="k">else</span> <span class="p">())</span>
    <span class="k">def</span> <span class="nf">_compute_display_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the value of the `display_name` field.</span>

<span class="sd">        The `display_name` field is a textual representation of the record.</span>
<span class="sd">        This method can be overridden to change the representation.  If needed,</span>
<span class="sd">        it can be made field-dependent using :attr:`~odoo.api.depends` and</span>
<span class="sd">        context-dependent using :attr:`~odoo.api.depends_context`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">:</span>
            <span class="n">convert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">]</span><span class="o">.</span><span class="n">convert_to_display_name</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="n">record</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">],</span> <span class="n">record</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="n">record</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">record</span><span class="o">.</span><span class="n">_name</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>

<div class="viewcode-block" id="BaseModel.name_get">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.name_get">[docs]</a>
    <span class="k">def</span> <span class="nf">name_get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a textual representation for the records in ``self``, with</span>
<span class="sd">        one item output per input record, in the same order.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            Although :meth:`~.name_get` can use context data for richer</span>
<span class="sd">            contextual formatting, as it is the default implementation for</span>
<span class="sd">            :attr:`~.display_name` it is important that it resets to the</span>
<span class="sd">            &quot;default&quot; behaviour if the context keys are empty / missing.</span>

<span class="sd">        .. deprecated:: 17.0</span>
<span class="sd">            Deprecated method, read([`display_name`]) instead</span>

<span class="sd">        :return: list of pairs ``(id, text_repr)`` for each record</span>
<span class="sd">        :rtype: list[(int, str)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Since 17.0, deprecated method, read display_name instead&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">display_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span></div>


<div class="viewcode-block" id="BaseModel.name_create">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.name_create">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">name_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; name_create(name) -&gt; record</span>

<span class="sd">        Create a new record by calling :meth:`~.create` with only one value</span>
<span class="sd">        provided: the display name of the new record.</span>

<span class="sd">        The new record will be initialized with any default values</span>
<span class="sd">        applicable to this model, or provided through the context. The usual</span>
<span class="sd">        behavior of :meth:`~.create` applies.</span>

<span class="sd">        :param name: display name of the record to create</span>
<span class="sd">        :rtype: tuple</span>
<span class="sd">        :return: the (id, display_name) pair value of the created record</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">:</span> <span class="n">name</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">display_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot execute name_create, no _rec_name defined on </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="BaseModel.name_search">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.name_search">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">name_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="s1">&#39;ilike&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; name_search(name=&#39;&#39;, args=None, operator=&#39;ilike&#39;, limit=100) -&gt; records</span>

<span class="sd">        Search for records that have a display name matching the given</span>
<span class="sd">        ``name`` pattern when compared with the given ``operator``, while also</span>
<span class="sd">        matching the optional search domain (``args``).</span>

<span class="sd">        This is used for example to provide suggestions based on a partial</span>
<span class="sd">        value for a relational field. Should usually behave as the reverse of</span>
<span class="sd">        ``display_name``, but that is not guaranteed.</span>

<span class="sd">        This method is equivalent to calling :meth:`~.search` with a search</span>
<span class="sd">        domain based on ``display_name`` and mapping id and display_name on</span>
<span class="sd">        the resulting search.</span>

<span class="sd">        :param str name: the name pattern to match</span>
<span class="sd">        :param list args: optional search domain (see :meth:`~.search` for</span>
<span class="sd">                          syntax), specifying further restrictions</span>
<span class="sd">        :param str operator: domain operator for matching ``name``, such as</span>
<span class="sd">                             ``&#39;like&#39;`` or ``&#39;=&#39;``.</span>
<span class="sd">        :param int limit: optional max number of records to return</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        :return: list of pairs ``(id, display_name)`` for all matching records.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_search</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_order</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">Query</span><span class="p">):</span>
            <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_query</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_fields_to_fetch</span><span class="p">([</span><span class="s1">&#39;display_name&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Some override of `_name_search` return list of ids.</span>
            <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
            <span class="n">records</span><span class="o">.</span><span class="n">fetch</span><span class="p">([</span><span class="s1">&#39;display_name&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">[(</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">display_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="o">.</span><span class="n">sudo</span><span class="p">()]</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_name_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="s1">&#39;ilike&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; _name_search(name=&#39;&#39;, domain=None, operator=&#39;ilike&#39;, limit=None, order=None) -&gt; ids</span>

<span class="sd">        Private implementation of name_search, returning ids or a :class:`Query` object.</span>

<span class="sd">        No default is applied for parameters ``limit`` and ``order``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">domain</span> <span class="ow">or</span> <span class="p">())</span>
        <span class="n">search_fnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_names_search</span> <span class="ow">or</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span> <span class="k">else</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">search_fnames</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot execute name_search, no _rec_name or _rec_names_search defined on </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="c1"># optimize out the default criterion of ``like &#39;&#39;`` that matches everything</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">operator</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;ilike&#39;</span><span class="p">)):</span>
            <span class="n">aggregator</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">AND</span> <span class="k">if</span> <span class="n">operator</span> <span class="ow">in</span> <span class="n">expression</span><span class="o">.</span><span class="n">NEGATIVE_TERM_OPERATORS</span> <span class="k">else</span> <span class="n">expression</span><span class="o">.</span><span class="n">OR</span>
            <span class="n">domain</span> <span class="o">+=</span> <span class="n">aggregator</span><span class="p">([[(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">name</span><span class="p">)]</span> <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">search_fnames</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_add_missing_default_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="c1"># avoid overriding inherited values when parent is set</span>
        <span class="n">avoid_models</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">collect_models_to_avoid</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">parent_mname</span><span class="p">,</span> <span class="n">parent_fname</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_inherits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">parent_fname</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                    <span class="n">avoid_models</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">parent_mname</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># manage the case where an ancestor parent field is set</span>
                    <span class="n">collect_models_to_avoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">parent_mname</span><span class="p">])</span>

        <span class="n">collect_models_to_avoid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">avoid</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
            <span class="c1"># check whether the field is inherited from one of avoid_models</span>
            <span class="k">if</span> <span class="n">avoid_models</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">field</span><span class="o">.</span><span class="n">inherited</span><span class="p">:</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">related_field</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">model_name</span> <span class="ow">in</span> <span class="n">avoid_models</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># compute missing fields</span>
        <span class="n">missing_defaults</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">name</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">values</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">avoid</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">missing_defaults</span><span class="p">:</span>
            <span class="c1"># override defaults with the provided values, never allow the other way around</span>
            <span class="n">defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_get</span><span class="p">(</span><span class="n">missing_defaults</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2many&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="c1"># convert a list of ids into a list of commands</span>
                    <span class="n">defaults</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;one2many&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="c1"># convert a list of dicts into a list of commands</span>
                    <span class="n">defaults</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
            <span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">defaults</span> <span class="o">=</span> <span class="n">values</span>

        <span class="c1"># delegate the default properties to the properties field</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;properties&#39;</span><span class="p">:</span>
                <span class="n">defaults</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">_add_default_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">defaults</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">defaults</span>

<div class="viewcode-block" id="BaseModel.clear_caches">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.clear_caches">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">clear_caches</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Clear the caches</span>

<span class="sd">        This clears the caches associated to methods decorated with</span>
<span class="sd">        ``tools.ormcache``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Deprecated model.clear_cache(), use registry.clear_cache() instead&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">clear_all_caches</span><span class="p">()</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_read_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="p">(),</span> <span class="n">aggregates</span><span class="o">=</span><span class="p">(),</span> <span class="n">having</span><span class="o">=</span><span class="p">(),</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Get fields aggregations specified by ``aggregates`` grouped by the given ``groupby``</span>
<span class="sd">        fields where record are filtered by the ``domain``.</span>

<span class="sd">        :param list domain: :ref:`A search domain &lt;reference/orm/domains&gt;`. Use an empty</span>
<span class="sd">                list to match all records.</span>
<span class="sd">        :param list groupby: list of groupby descriptions by which the records will be grouped.</span>
<span class="sd">                A groupby description is either a field (then it will be grouped by that field)</span>
<span class="sd">                or a string `&#39;field:granularity&#39;`. Right now, the only supported granularities</span>
<span class="sd">                are `&#39;day&#39;`, `&#39;week&#39;`, `&#39;month&#39;`, `&#39;quarter&#39;` or `&#39;year&#39;`, and they only make sense for</span>
<span class="sd">                date/datetime fields.</span>
<span class="sd">        :param list aggregates: list of aggregates specification.</span>
<span class="sd">                Each element is `&#39;field:agg&#39;` (aggregate field with aggregation function `&#39;agg&#39;`).</span>
<span class="sd">                The possible aggregation functions are the ones provided by</span>
<span class="sd">                `PostgreSQL &lt;https://www.postgresql.org/docs/current/static/functions-aggregate.html&gt;`_,</span>
<span class="sd">                `&#39;count_distinct&#39;` with the expected meaning and `&#39;recordset&#39;` to act like `&#39;array_agg&#39;`</span>
<span class="sd">                converted into a recordset.</span>
<span class="sd">        :param list having: A domain where the valid &quot;fields&quot; are the aggregates.</span>
<span class="sd">        :param int offset: optional number of groups to skip</span>
<span class="sd">        :param int limit: optional max number of groups to return</span>
<span class="sd">        :param str order: optional ``order by`` specification, for</span>
<span class="sd">                overriding the natural sort ordering of the groups,</span>
<span class="sd">                see also :meth:`~.search`.</span>
<span class="sd">        :return: list of tuple containing in the order the groups values and aggregates values (flatten):</span>
<span class="sd">                `[(groupby_1_value, ... , aggregate_1_value_aggregate, ...), ...]`.</span>
<span class="sd">                If group is related field, the value of it will be a recordset (with a correct prefetch set).</span>

<span class="sd">        :rtype: list</span>
<span class="sd">        :raise AccessError: if user is not allowed to access requested information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">expression</span><span class="o">.</span><span class="n">is_false</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">groupby</span><span class="p">:</span>
                <span class="c1"># when there is no group, postgresql always return a row</span>
                <span class="k">return</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_empty_value</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span> <span class="n">aggregates</span><span class="p">)</span>
                <span class="p">)]</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>

        <span class="n">fnames_to_flush</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">()</span>

        <span class="n">groupby_terms</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SQL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">:</span>
            <span class="n">groupby_terms</span><span class="p">[</span><span class="n">spec</span><span class="p">],</span> <span class="n">fnames_used</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_groupby</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="n">fnames_to_flush</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fnames_used</span><span class="p">)</span>

        <span class="n">select_terms</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">SQL</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">aggregates</span><span class="p">:</span>
            <span class="n">sql_expr</span><span class="p">,</span> <span class="n">fnames_used</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_select</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="n">select_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sql_expr</span><span class="p">)</span>
            <span class="n">fnames_to_flush</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fnames_used</span><span class="p">)</span>

        <span class="n">sql_having</span><span class="p">,</span> <span class="n">fnames_used</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_having</span><span class="p">(</span><span class="n">having</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">fnames_to_flush</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fnames_used</span><span class="p">)</span>

        <span class="n">sql_order</span><span class="p">,</span> <span class="n">sql_extra_groupby</span><span class="p">,</span> <span class="n">fnames_used</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_orderby</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">groupby_terms</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">fnames_to_flush</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fnames_used</span><span class="p">)</span>

        <span class="n">groupby_terms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">groupby_terms</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="n">query_parts</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;SELECT </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">groupby_terms</span> <span class="o">+</span> <span class="n">select_terms</span><span class="p">)),</span>
            <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;FROM </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">from_clause</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">where_clause</span><span class="p">:</span>
            <span class="n">query_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;WHERE </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">where_clause</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">groupby_terms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sql_extra_groupby</span><span class="p">:</span>
                <span class="n">groupby_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sql_extra_groupby</span><span class="p">)</span>
            <span class="n">query_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;GROUP BY </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">groupby_terms</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">sql_having</span><span class="p">:</span>
            <span class="n">query_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;HAVING </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sql_having</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">sql_order</span><span class="p">:</span>
            <span class="n">query_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;ORDER BY </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sql_order</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">limit</span><span class="p">:</span>
            <span class="n">query_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;LIMIT </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">limit</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">offset</span><span class="p">:</span>
            <span class="n">query_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;OFFSET </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_flush_search</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">fnames_to_flush</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fnames_to_flush</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_check_field_access_rights</span><span class="p">(</span><span class="n">fnames_to_flush</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">query_parts</span><span class="p">))</span>
        <span class="c1"># row_values: [(a1, b1, c1), (a2, b2, c2), ...]</span>
        <span class="n">row_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">row_values</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">row_values</span>

        <span class="c1"># post-process values column by column</span>
        <span class="n">column_iterator</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">row_values</span><span class="p">)</span>

        <span class="c1"># column_result: [(a1, a2, ...), (b1, b2, ...), (c1, c2, ...)]</span>
        <span class="n">column_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">:</span>
            <span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_postprocess_groupby</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="n">column_iterator</span><span class="p">))</span>
            <span class="n">column_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">aggregates</span><span class="p">:</span>
            <span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_postprocess_aggregate</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="n">column_iterator</span><span class="p">))</span>
            <span class="n">column_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">next</span><span class="p">(</span><span class="n">column_iterator</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>

        <span class="c1"># return [(a1, b1, c1), (a2, b2, c2), ...]</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">column_result</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_read_group_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate_spec</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">Query</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">SQL</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return a pair (&lt;SQL expression&gt;, [&lt;field names used in SQL expression&gt;])</span>
<span class="sd">        corresponding to the given aggregation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">aggregate_spec</span> <span class="o">==</span> <span class="s1">&#39;__count&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;COUNT(*)&quot;</span><span class="p">),</span> <span class="p">[]</span>

        <span class="n">fname</span><span class="p">,</span> <span class="n">property_name</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">parse_read_group_spec</span><span class="p">(</span><span class="n">aggregate_spec</span><span class="p">)</span>

        <span class="n">access_fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">property_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">property_name</span> <span class="k">else</span> <span class="n">fname</span>

        <span class="k">if</span> <span class="n">fname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid field </span><span class="si">{</span><span class="n">fname</span><span class="si">!r}</span><span class="s2"> on model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="si">!r}</span><span class="s2"> for </span><span class="si">{</span><span class="n">aggregate_spec</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">func</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Aggregate method is mandatory for </span><span class="si">{</span><span class="n">access_fname</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">READ_GROUP_AGGREGATE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid aggregate method </span><span class="si">{</span><span class="n">func</span><span class="si">!r}</span><span class="s2"> for </span><span class="si">{</span><span class="n">aggregate_spec</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">func</span> <span class="o">==</span> <span class="s1">&#39;recordset&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">relational</span> <span class="ow">or</span> <span class="n">fname</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Aggregate method </span><span class="si">{</span><span class="n">func</span><span class="si">!r}</span><span class="s2"> can be only used on relational field (or id) (for </span><span class="si">{</span><span class="n">aggregate_spec</span><span class="si">!r}</span><span class="s2">).&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">property_name</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;property&#39;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ignore the </span><span class="si">{</span><span class="n">property_name</span><span class="si">!r}</span><span class="s2"> part of </span><span class="si">{</span><span class="n">aggregate_spec</span><span class="si">!r}</span><span class="s2">, this notation is reserved for the Property field&quot;</span><span class="p">)</span>

        <span class="n">sql_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_to_sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">access_fname</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">sql_expr</span> <span class="o">=</span> <span class="n">READ_GROUP_AGGREGATE</span><span class="p">[</span><span class="n">func</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">sql_field</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sql_expr</span><span class="p">,</span> <span class="p">[</span><span class="n">fname</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_read_group_groupby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groupby_spec</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">Query</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">SQL</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return a pair (&lt;SQL expression&gt;, [&lt;field names used in SQL expression&gt;])</span>
<span class="sd">        corresponding to the given groupby element.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fname</span><span class="p">,</span> <span class="n">property_name</span><span class="p">,</span> <span class="n">granularity</span> <span class="o">=</span> <span class="n">parse_read_group_spec</span><span class="p">(</span><span class="n">groupby_spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid field </span><span class="si">{</span><span class="n">fname</span><span class="si">!r}</span><span class="s2"> on model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">property_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;properties&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Property set on a non properties field: </span><span class="si">{</span><span class="n">property_name</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">access_fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">property_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">access_fname</span> <span class="o">=</span> <span class="n">fname</span>

        <span class="k">if</span> <span class="n">granularity</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;properties&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Granularity set on a no-datetime field or property: </span><span class="si">{</span><span class="n">groupby_spec</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">sql_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_to_sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">access_fname</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;datetime&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tz&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pytz</span><span class="o">.</span><span class="n">all_timezones_set</span><span class="p">:</span>
            <span class="n">sql_expr</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;timezone(</span><span class="si">%s</span><span class="s2">, timezone(&#39;UTC&#39;, </span><span class="si">%s</span><span class="s2">))&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;tz&#39;</span><span class="p">],</span> <span class="n">sql_expr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;properties&#39;</span> <span class="ow">and</span> <span class="n">granularity</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">granularity</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Granularity not set on a date(time) field: </span><span class="si">{</span><span class="n">groupby_spec</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">granularity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">READ_GROUP_TIME_GRANULARITY</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Granularity specification isn&#39;t correct: </span><span class="si">{</span><span class="n">granularity</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">granularity</span> <span class="o">==</span> <span class="s1">&#39;week&#39;</span><span class="p">:</span>
                <span class="c1"># first_week_day: 0=Monday, 1=Tuesday, ...</span>
                <span class="n">first_week_day</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">get_lang</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span><span class="o">.</span><span class="n">week_start</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">days_offset</span> <span class="o">=</span> <span class="n">first_week_day</span> <span class="ow">and</span> <span class="mi">7</span> <span class="o">-</span> <span class="n">first_week_day</span>
                <span class="n">interval</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;-</span><span class="si">{</span><span class="n">days_offset</span><span class="si">}</span><span class="s2"> DAY&quot;</span>
                <span class="n">sql_expr</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span>
                    <span class="s2">&quot;(date_trunc(&#39;week&#39;, </span><span class="si">%s</span><span class="s2">::timestamp - INTERVAL </span><span class="si">%s</span><span class="s2">) + INTERVAL </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
                    <span class="n">sql_expr</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sql_expr</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;date_trunc(</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">::timestamp)&quot;</span><span class="p">,</span> <span class="n">granularity</span><span class="p">,</span> <span class="n">sql_expr</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;date&#39;</span><span class="p">:</span>
                <span class="n">sql_expr</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">::date&quot;</span><span class="p">,</span> <span class="n">sql_expr</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;boolean&#39;</span><span class="p">:</span>
            <span class="n">sql_expr</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;COALESCE(</span><span class="si">%s</span><span class="s2">, FALSE)&quot;</span><span class="p">,</span> <span class="n">sql_expr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sql_expr</span><span class="p">,</span> <span class="p">[</span><span class="n">fname</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_read_group_having</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">having_domain</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">Query</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">SQL</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return a pair (&lt;SQL expression&gt;, [&lt;used field name&gt;]) corresponding</span>
<span class="sd">        to the having domain.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">having_domain</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SQL</span><span class="p">(),</span> <span class="p">[]</span>

        <span class="n">stack</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">SQL</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fnames_used</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">SUPPORTED</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;!=&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">having_domain</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;!&#39;</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;(NOT </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()))</span>
            <span class="k">elif</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2"> AND </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()))</span>
            <span class="k">elif</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;|&#39;</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2"> OR </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">left</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">item</span>
                <span class="k">if</span> <span class="n">operator</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SUPPORTED</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid having clause </span><span class="si">{</span><span class="n">item</span><span class="si">!r}</span><span class="s2">: supported comparators are </span><span class="si">{</span><span class="n">SUPPORTED</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">sql_left</span><span class="p">,</span> <span class="n">fnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_select</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
                <span class="n">sql_operator</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">SQL_OPERATORS</span><span class="p">[</span><span class="n">operator</span><span class="p">]</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sql_left</span><span class="p">,</span> <span class="n">sql_operator</span><span class="p">,</span> <span class="n">right</span><span class="p">))</span>
                <span class="n">fnames_used</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid having clause </span><span class="si">{</span><span class="n">item</span><span class="si">!r}</span><span class="s2">: it should be a domain-like clause&quot;</span><span class="p">)</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2"> AND </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()))</span>

        <span class="k">return</span> <span class="n">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fnames_used</span>

    <span class="k">def</span> <span class="nf">_read_group_orderby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">groupby_terms</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">SQL</span><span class="p">],</span>
                            <span class="n">query</span><span class="p">:</span> <span class="n">Query</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">SQL</span><span class="p">,</span> <span class="n">SQL</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return (&lt;SQL expression&gt;, &lt;SQL expression&gt;, [&lt;field names used&gt;])</span>
<span class="sd">        corresponding to the given order and groupby terms.</span>

<span class="sd">        :param order: the order specification</span>
<span class="sd">        :param groupby_terms: the group by terms mapping ({spec: sql_expression})</span>
<span class="sd">        :param query: The query we are building</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">traverse_many2one</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">groupby_terms</span><span class="p">)</span>
            <span class="n">traverse_many2one</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">order</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SQL</span><span class="p">(),</span> <span class="n">SQL</span><span class="p">(),</span> <span class="p">[]</span>

        <span class="n">orderby_terms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">extra_groupby_terms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fnames_used</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">order_part</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">order_match</span> <span class="o">=</span> <span class="n">regex_order</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">order_part</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">order_match</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid order </span><span class="si">{</span><span class="n">order</span><span class="si">!r}</span><span class="s2"> for _read_group()&quot;</span><span class="p">)</span>
            <span class="n">term</span> <span class="o">=</span> <span class="n">order_match</span><span class="p">[</span><span class="s1">&#39;term&#39;</span><span class="p">]</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="p">(</span><span class="n">order_match</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;ASC&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">nulls</span> <span class="o">=</span> <span class="p">(</span><span class="n">order_match</span><span class="p">[</span><span class="s1">&#39;nulls&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

            <span class="n">sql_direction</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span> <span class="k">if</span> <span class="n">direction</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ASC&#39;</span><span class="p">,</span> <span class="s1">&#39;DESC&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">SQL</span><span class="p">()</span>
            <span class="n">sql_nulls</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="n">nulls</span><span class="p">)</span> <span class="k">if</span> <span class="n">nulls</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;NULLS FIRST&#39;</span><span class="p">,</span> <span class="s1">&#39;NULLS LAST&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">SQL</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">term</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groupby_terms</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sql_expr</span><span class="p">,</span> <span class="n">fnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_select</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Order term </span><span class="si">{</span><span class="n">order_part</span><span class="si">!r}</span><span class="s2"> is not a valid aggregate nor valid groupby&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
                <span class="n">orderby_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sql_expr</span><span class="p">,</span> <span class="n">sql_direction</span><span class="p">,</span> <span class="n">sql_nulls</span><span class="p">))</span>
                <span class="n">fnames_used</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">traverse_many2one</span> <span class="ow">and</span> <span class="n">field</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2one&#39;</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span><span class="o">.</span><span class="n">_order</span> <span class="o">!=</span> <span class="s1">&#39;id&#39;</span>
            <span class="p">):</span>
                <span class="c1"># this generates an extra clause to add in the group by</span>
                <span class="n">sql_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_to_sql</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">nulls</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
                <span class="n">orderby_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sql_order</span><span class="p">)</span>
                <span class="n">sql_order_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">mogrify</span><span class="p">(</span><span class="n">sql_order</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="n">extra_groupby_terms</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="n">SQL</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">sql_order_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">sql_expr</span> <span class="o">=</span> <span class="n">groupby_terms</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
                <span class="n">orderby_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sql_expr</span><span class="p">,</span> <span class="n">sql_direction</span><span class="p">,</span> <span class="n">sql_nulls</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">orderby_terms</span><span class="p">),</span> <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extra_groupby_terms</span><span class="p">),</span> <span class="n">fnames_used</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_read_group_check_field_access_rights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Check whether the given field names can be grouped or aggregated. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_field_access_rights</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="n">field_names</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_read_group_empty_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the empty value corresponding to the given groupby spec or aggregate spec. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="o">==</span> <span class="s1">&#39;__count&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="n">fname</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">parse_read_group_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>  <span class="c1"># func is either None, granularity or an aggregate</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;count_distinct&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">func</span> <span class="o">==</span> <span class="s1">&#39;array_agg&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">func</span> <span class="ow">or</span> <span class="n">func</span> <span class="o">==</span> <span class="s1">&#39;recordset&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">relational</span> <span class="ow">or</span> <span class="n">fname</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">relational</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_read_group_postprocess_groupby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groupby_spec</span><span class="p">,</span> <span class="n">raw_values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Convert the given values of ``groupby_spec``</span>
<span class="sd">        from PostgreSQL to the format returned by method ``_read_group()``.</span>

<span class="sd">        The formatting rules can be summarized as:</span>
<span class="sd">        - groupby values of relational fields are converted to recordsets with a correct prefetch set;</span>
<span class="sd">        - NULL values are converted to empty values corresponding to the given aggregate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">empty_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_empty_value</span><span class="p">(</span><span class="n">groupby_spec</span><span class="p">)</span>

        <span class="n">fname</span><span class="p">,</span> <span class="o">*</span><span class="n">__</span> <span class="o">=</span> <span class="n">parse_read_group_spec</span><span class="p">(</span><span class="n">groupby_spec</span><span class="p">)</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">relational</span> <span class="ow">or</span> <span class="n">fname</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>
            <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">relational</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span>
            <span class="n">prefetch_ids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">raw_value</span> <span class="k">for</span> <span class="n">raw_value</span> <span class="ow">in</span> <span class="n">raw_values</span> <span class="k">if</span> <span class="n">raw_value</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">recordset</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">Model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">,),</span> <span class="n">prefetch_ids</span><span class="p">)</span> <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="n">empty_value</span>

            <span class="k">return</span> <span class="p">(</span><span class="n">recordset</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">raw_values</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">((</span><span class="n">value</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">empty_value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">raw_values</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_group_postprocess_aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate_spec</span><span class="p">,</span> <span class="n">raw_values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Convert the given values of ``aggregate_spec``</span>
<span class="sd">        from PostgreSQL to the format returned by method ``_read_group()``.</span>

<span class="sd">        The formatting rules can be summarized as:</span>
<span class="sd">        - &#39;recordset&#39; aggregates are turned into recordsets with a correct prefetch set;</span>
<span class="sd">        - NULL values are converted to empty values corresponding to the given aggregate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">empty_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_empty_value</span><span class="p">(</span><span class="n">aggregate_spec</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">aggregate_spec</span> <span class="o">==</span> <span class="s1">&#39;__count&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">((</span><span class="n">value</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">empty_value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">raw_values</span><span class="p">)</span>

        <span class="n">fname</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">parse_read_group_spec</span><span class="p">(</span><span class="n">aggregate_spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">func</span> <span class="o">==</span> <span class="s1">&#39;recordset&#39;</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span>
            <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">relational</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span>
            <span class="n">prefetch_ids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span>
                <span class="n">id_</span>
                <span class="k">for</span> <span class="n">array_values</span> <span class="ow">in</span> <span class="n">raw_values</span> <span class="k">if</span> <span class="n">array_values</span>
                <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">array_values</span> <span class="k">if</span> <span class="n">id_</span>
            <span class="p">))</span>

            <span class="k">def</span> <span class="nf">recordset</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">empty_value</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">id_</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">value</span> <span class="k">if</span> <span class="n">id_</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">Model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">prefetch_ids</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">(</span><span class="n">recordset</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">raw_values</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">((</span><span class="n">value</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">empty_value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">raw_values</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_read_group_expand_full</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extend the group to include all target records by default.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">groups</span><span class="o">.</span><span class="n">search</span><span class="p">([],</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_read_group_fill_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">annoted_aggregates</span><span class="p">,</span> <span class="n">read_group_result</span><span class="p">,</span> <span class="n">read_group_order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper method for filling in empty groups for all possible values of</span>
<span class="sd">           the field being grouped by&quot;&quot;&quot;</span>
        <span class="n">field_name</span> <span class="o">=</span> <span class="n">groupby</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">group_expand</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">read_group_result</span>

        <span class="c1"># field.group_expand is a callable or the name of a method, that returns</span>
        <span class="c1"># the groups that we want to display for this field, in the form of a</span>
        <span class="c1"># recordset or a list of values (depending on the type of the field).</span>
        <span class="c1"># This is useful to implement kanban views for instance, where some</span>
        <span class="c1"># columns should be displayed even if they don&#39;t contain any record.</span>
        <span class="n">group_expand</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">group_expand</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group_expand</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">group_expand</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">],</span> <span class="n">group_expand</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">group_expand</span><span class="p">)</span>

        <span class="c1"># determine all groups that should be returned</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">read_group_result</span> <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="n">groupby</span><span class="p">]]</span>

        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">relational</span><span class="p">:</span>
            <span class="c1"># groups is a recordset; determine order on groups&#39;s model</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">([</span><span class="n">value</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">])</span>
            <span class="n">order</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">_order</span>
            <span class="k">if</span> <span class="n">read_group_order</span> <span class="o">==</span> <span class="n">groupby</span> <span class="o">+</span> <span class="s1">&#39; desc&#39;</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">reverse_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">group_expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span>
            <span class="n">value2key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">id</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># groups is a list of values</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">group_expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">read_group_order</span> <span class="o">==</span> <span class="n">groupby</span> <span class="o">+</span> <span class="s1">&#39; desc&#39;</span><span class="p">:</span>
                <span class="n">values</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="n">value2key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span>

        <span class="c1"># Merge the current results (list of dicts) with all groups. Determine</span>
        <span class="c1"># the global order of results groups, which is supposed to be in the</span>
        <span class="c1"># same order as read_group_result (in the case of a many2one field).</span>

        <span class="n">read_group_result_as_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">read_group_result</span><span class="p">:</span>
            <span class="n">read_group_result_as_dict</span><span class="p">[</span><span class="n">value2key</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">groupby</span><span class="p">])]</span> <span class="o">=</span> <span class="n">line</span>

        <span class="n">empty_item</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_empty_value</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">annoted_aggregates</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># fill result with the values order</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">value2key</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">read_group_result_as_dict</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_group_result_as_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">empty_item</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="n">groupby</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">read_group_result_as_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">value2key</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">groupby</span><span class="p">])</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>

        <span class="c1"># add folding information if present</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">relational</span> <span class="ow">and</span> <span class="n">groups</span><span class="o">.</span><span class="n">_fold_name</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="n">fold</span> <span class="o">=</span> <span class="p">{</span><span class="n">group</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">group</span><span class="p">[</span><span class="n">groups</span><span class="o">.</span><span class="n">_fold_name</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">browse</span><span class="p">([</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span> <span class="k">if</span> <span class="n">key</span><span class="p">])}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">line</span><span class="p">[</span><span class="s1">&#39;__fold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fold</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_read_group_fill_temporal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">annoted_aggregates</span><span class="p">,</span>
                                  <span class="n">fill_from</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_to</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">min_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper method for filling date/datetime &#39;holes&#39; in a result set.</span>

<span class="sd">        We are in a use case where data are grouped by a date field (typically</span>
<span class="sd">        months but it could be any other interval) and displayed in a chart.</span>

<span class="sd">        Assume we group records by month, and we only have data for June,</span>
<span class="sd">        September and December. By default, plotting the result gives something</span>
<span class="sd">        like::</span>

<span class="sd">                                                ___</span>
<span class="sd">                                      ___      |   |</span>
<span class="sd">                                     |   | ___ |   |</span>
<span class="sd">                                     |___||___||___|</span>
<span class="sd">                                      Jun  Sep  Dec</span>

<span class="sd">        The problem is that December data immediately follow September data,</span>
<span class="sd">        which is misleading for the user. Adding explicit zeroes for missing</span>
<span class="sd">        data gives something like::</span>

<span class="sd">                                                           ___</span>
<span class="sd">                             ___                          |   |</span>
<span class="sd">                            |   |           ___           |   |</span>
<span class="sd">                            |___| ___  ___ |___| ___  ___ |___|</span>
<span class="sd">                             Jun  Jul  Aug  Sep  Oct  Nov  Dec</span>

<span class="sd">        To customize this output, the context key &quot;fill_temporal&quot; can be used</span>
<span class="sd">        under its dictionary format, which has 3 attributes : fill_from,</span>
<span class="sd">        fill_to, min_groups (see params of this function)</span>

<span class="sd">        Fill between bounds:</span>
<span class="sd">        Using either `fill_from` and/or `fill_to` attributes, we can further</span>
<span class="sd">        specify that at least a certain date range should be returned as</span>
<span class="sd">        contiguous groups. Any group outside those bounds will not be removed,</span>
<span class="sd">        but the filling will only occur between the specified bounds. When not</span>
<span class="sd">        specified, existing groups will be used as bounds, if applicable.</span>
<span class="sd">        By specifying such bounds, we can get empty groups before/after any</span>
<span class="sd">        group with data.</span>

<span class="sd">        If we want to fill groups only between August (fill_from)</span>
<span class="sd">        and October (fill_to)::</span>

<span class="sd">                                                     ___</span>
<span class="sd">                                 ___                |   |</span>
<span class="sd">                                |   |      ___      |   |</span>
<span class="sd">                                |___| ___ |___| ___ |___|</span>
<span class="sd">                                 Jun  Aug  Sep  Oct  Dec</span>

<span class="sd">        We still get June and December. To filter them out, we should match</span>
<span class="sd">        `fill_from` and `fill_to` with the domain e.g. ``[&#39;&amp;&#39;,</span>
<span class="sd">        (&#39;date_field&#39;, &#39;&gt;=&#39;, &#39;YYYY-08-01&#39;), (&#39;date_field&#39;, &#39;&lt;&#39;, &#39;YYYY-11-01&#39;)]``::</span>

<span class="sd">                                         ___</span>
<span class="sd">                                    ___ |___| ___</span>
<span class="sd">                                    Aug  Sep  Oct</span>

<span class="sd">        Minimal filling amount:</span>
<span class="sd">        Using `min_groups`, we can specify that we want at least that amount of</span>
<span class="sd">        contiguous groups. This amount is guaranteed to be provided from</span>
<span class="sd">        `fill_from` if specified, or from the lowest existing group otherwise.</span>
<span class="sd">        This amount is not restricted by `fill_to`. If there is an existing</span>
<span class="sd">        group before `fill_from`, `fill_from` is still used as the starting</span>
<span class="sd">        group for min_groups, because the filling does not apply on that</span>
<span class="sd">        existing group. If neither `fill_from` nor `fill_to` is specified, and</span>
<span class="sd">        there is no existing group, no group will be returned.</span>

<span class="sd">        If we set min_groups = 4::</span>

<span class="sd">                                         ___</span>
<span class="sd">                                    ___ |___| ___ ___</span>
<span class="sd">                                    Aug  Sep  Oct Nov</span>

<span class="sd">        :param list data: the data containing groups</span>
<span class="sd">        :param list groupby: list of fields being grouped on</span>
<span class="sd">        :param list annoted_aggregates: dict of &quot;&lt;key_name&gt;:&lt;aggregate specification&gt;&quot;</span>
<span class="sd">        :param str fill_from: (inclusive) string representation of a</span>
<span class="sd">            date/datetime, start bound of the fill_temporal range</span>
<span class="sd">            formats: date -&gt; %Y-%m-%d, datetime -&gt; %Y-%m-%d %H:%M:%S</span>
<span class="sd">        :param str fill_to: (inclusive) string representation of a</span>
<span class="sd">            date/datetime, end bound of the fill_temporal range</span>
<span class="sd">            formats: date -&gt; %Y-%m-%d, datetime -&gt; %Y-%m-%d %H:%M:%S</span>
<span class="sd">        :param int min_groups: minimal amount of required groups for the</span>
<span class="sd">            fill_temporal range (should be &gt;= 1)</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        :return: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: remove min_groups</span>
        <span class="n">first_group</span> <span class="o">=</span> <span class="n">groupby</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">field_name</span> <span class="o">=</span> <span class="n">first_group</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;properties&#39;</span> <span class="ow">and</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">first_group</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="n">granularity</span> <span class="o">=</span> <span class="n">first_group</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">first_group</span> <span class="k">else</span> <span class="s1">&#39;month&#39;</span>
        <span class="n">days_offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">granularity</span> <span class="o">==</span> <span class="s1">&#39;week&#39;</span><span class="p">:</span>
            <span class="c1"># _read_group_process_groupby week groups are dependent on the</span>
            <span class="c1"># locale, so filled groups should be too to avoid overlaps.</span>
            <span class="n">first_week_day</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">get_lang</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span><span class="o">.</span><span class="n">week_start</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">days_offset</span> <span class="o">=</span> <span class="n">first_week_day</span> <span class="ow">and</span> <span class="mi">7</span> <span class="o">-</span> <span class="n">first_week_day</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="n">READ_GROUP_TIME_GRANULARITY</span><span class="p">[</span><span class="n">granularity</span><span class="p">]</span>
        <span class="n">tz</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;datetime&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tz&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pytz</span><span class="o">.</span><span class="n">all_timezones_set</span><span class="p">:</span>
            <span class="n">tz</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">[</span><span class="s1">&#39;tz&#39;</span><span class="p">])</span>

        <span class="c1"># TODO: refactor remaing lines here</span>

        <span class="c1"># existing non null datetimes</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">first_group</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="n">first_group</span><span class="p">]]</span> <span class="ow">or</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="c1"># assumption: existing data is sorted by field &#39;groupby_name&#39;</span>
        <span class="n">existing_from</span><span class="p">,</span> <span class="n">existing_to</span> <span class="o">=</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">existing</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fill_from</span><span class="p">:</span>
            <span class="n">fill_from</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Datetime</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">fill_from</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fill_from</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="k">else</span> <span class="n">odoo</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="n">fill_from</span><span class="p">)</span>
            <span class="n">fill_from</span> <span class="o">=</span> <span class="n">date_utils</span><span class="o">.</span><span class="n">start_of</span><span class="p">(</span><span class="n">fill_from</span><span class="p">,</span> <span class="n">granularity</span><span class="p">)</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days_offset</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tz</span><span class="p">:</span>
                <span class="n">fill_from</span> <span class="o">=</span> <span class="n">tz</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">fill_from</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">existing_from</span><span class="p">:</span>
            <span class="n">fill_from</span> <span class="o">=</span> <span class="n">existing_from</span>
        <span class="k">if</span> <span class="n">fill_to</span><span class="p">:</span>
            <span class="n">fill_to</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Datetime</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">fill_to</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fill_to</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="k">else</span> <span class="n">odoo</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="n">fill_to</span><span class="p">)</span>
            <span class="n">fill_to</span> <span class="o">=</span> <span class="n">date_utils</span><span class="o">.</span><span class="n">start_of</span><span class="p">(</span><span class="n">fill_to</span><span class="p">,</span> <span class="n">granularity</span><span class="p">)</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days_offset</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tz</span><span class="p">:</span>
                <span class="n">fill_to</span> <span class="o">=</span> <span class="n">tz</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">fill_to</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">existing_to</span><span class="p">:</span>
            <span class="n">fill_to</span> <span class="o">=</span> <span class="n">existing_to</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fill_to</span> <span class="ow">and</span> <span class="n">fill_from</span><span class="p">:</span>
            <span class="n">fill_to</span> <span class="o">=</span> <span class="n">fill_from</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fill_from</span> <span class="ow">and</span> <span class="n">fill_to</span><span class="p">:</span>
            <span class="n">fill_from</span> <span class="o">=</span> <span class="n">fill_to</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fill_from</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fill_to</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="k">if</span> <span class="n">min_groups</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fill_to</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">fill_to</span><span class="p">,</span> <span class="n">fill_from</span> <span class="o">+</span> <span class="p">(</span><span class="n">min_groups</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">interval</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fill_to</span> <span class="o">&lt;</span> <span class="n">fill_from</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="n">required_dates</span> <span class="o">=</span> <span class="n">date_utils</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">fill_from</span><span class="p">,</span> <span class="n">fill_to</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">existing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">existing</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">required_dates</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">existing</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">existing</span><span class="p">,</span> <span class="n">required_dates</span><span class="p">))</span>

        <span class="n">empty_item</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_empty_value</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">annoted_aggregates</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">empty_item</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_empty_value</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

        <span class="n">grouped_data</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">grouped_data</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">first_group</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">existing</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">grouped_data</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span> <span class="ow">or</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">empty_item</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="n">first_group</span><span class="p">:</span> <span class="n">dt</span><span class="p">})])</span>

        <span class="k">if</span> <span class="kc">False</span> <span class="ow">in</span> <span class="n">grouped_data</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">grouped_data</span><span class="p">[</span><span class="kc">False</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_read_group_format_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows_dict</span><span class="p">,</span> <span class="n">lazy_groupby</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Helper method to format the data contained in the dictionary data by</span>
<span class="sd">            adding the domain corresponding to its values, the groupbys in the</span>
<span class="sd">            context and by properly formatting the date/datetime values.</span>

<span class="sd">        :param data: a single group</span>
<span class="sd">        :param annotated_groupbys: expanded grouping metainformation</span>
<span class="sd">        :param groupby: original grouping metainformation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">lazy_groupby</span><span class="p">:</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">):</span>
                <span class="n">locale</span> <span class="o">=</span> <span class="n">get_lang</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span><span class="o">.</span><span class="n">code</span>
                <span class="n">fmt</span> <span class="o">=</span> <span class="n">DEFAULT_SERVER_DATETIME_FORMAT</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;datetime&#39;</span> <span class="k">else</span> <span class="n">DEFAULT_SERVER_DATE_FORMAT</span>
                <span class="n">granularity</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">group</span> <span class="k">else</span> <span class="s1">&#39;month&#39;</span>
                <span class="n">interval</span> <span class="o">=</span> <span class="n">READ_GROUP_TIME_GRANULARITY</span><span class="p">[</span><span class="n">granularity</span><span class="p">]</span>

            <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;properties&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_format_result_properties</span><span class="p">(</span><span class="n">rows_dict</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows_dict</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
                    <span class="n">row</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">display_name</span><span class="p">)</span> <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="kc">False</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">id</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2many&#39;</span><span class="p">:</span>
                    <span class="n">other_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">other_row</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other_row</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">)</span>
                                    <span class="k">else</span> <span class="n">other_row</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other_row</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="n">BaseModel</span><span class="p">)</span>
                                    <span class="k">else</span> <span class="n">other_row</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="k">for</span> <span class="n">other_row</span> <span class="ow">in</span> <span class="n">rows_dict</span> <span class="k">if</span> <span class="n">other_row</span><span class="p">[</span><span class="n">group</span><span class="p">]]</span>
                    <span class="n">additional_domain</span> <span class="o">=</span> <span class="p">[(</span><span class="n">field_name</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">,</span> <span class="n">other_values</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">additional_domain</span> <span class="o">=</span> <span class="p">[(</span><span class="n">field_name</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)]</span>

                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)):</span>
                        <span class="n">range_start</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="n">range_end</span> <span class="o">=</span> <span class="n">value</span> <span class="o">+</span> <span class="n">interval</span>
                        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;datetime&#39;</span><span class="p">:</span>
                            <span class="n">tzinfo</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tz&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pytz</span><span class="o">.</span><span class="n">all_timezones_set</span><span class="p">:</span>
                                <span class="n">tzinfo</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">[</span><span class="s1">&#39;tz&#39;</span><span class="p">])</span>
                                <span class="n">range_start</span> <span class="o">=</span> <span class="n">tzinfo</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">range_start</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                                <span class="c1"># take into account possible hour change between start and end</span>
                                <span class="n">range_end</span> <span class="o">=</span> <span class="n">tzinfo</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">range_end</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

                            <span class="n">label</span> <span class="o">=</span> <span class="n">babel</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">format_datetime</span><span class="p">(</span>
                                <span class="n">range_start</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">READ_GROUP_DISPLAY_FORMAT</span><span class="p">[</span><span class="n">granularity</span><span class="p">],</span>
                                <span class="n">tzinfo</span><span class="o">=</span><span class="n">tzinfo</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">locale</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">label</span> <span class="o">=</span> <span class="n">babel</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">format_date</span><span class="p">(</span>
                                <span class="n">value</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">READ_GROUP_DISPLAY_FORMAT</span><span class="p">[</span><span class="n">granularity</span><span class="p">],</span>
                                <span class="n">locale</span><span class="o">=</span><span class="n">locale</span>
                            <span class="p">)</span>

                        <span class="n">range_start</span> <span class="o">=</span> <span class="n">range_start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
                        <span class="n">range_end</span> <span class="o">=</span> <span class="n">range_end</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
                        <span class="n">row</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>  <span class="c1"># TODO should put raw data</span>
                        <span class="n">row</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;__range&#39;</span><span class="p">,</span> <span class="p">{})[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">range_start</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="n">range_end</span><span class="p">}</span>
                        <span class="n">additional_domain</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="s1">&#39;&amp;&#39;</span><span class="p">,</span>
                                <span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="n">range_start</span><span class="p">),</span>
                                <span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="n">range_end</span><span class="p">),</span>
                        <span class="p">]</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                        <span class="c1"># Set the __range of the group containing records with an unset</span>
                        <span class="c1"># date/datetime field value to False.</span>
                        <span class="n">row</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;__range&#39;</span><span class="p">,</span> <span class="p">{})[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;__domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">AND</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;__domain&#39;</span><span class="p">],</span> <span class="n">additional_domain</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_read_group_format_result_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows_dict</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Modify the final read group properties result.</span>

<span class="sd">        Replace the relational properties ids by a tuple with their display names,</span>
<span class="sd">        replace the &quot;raw&quot; tags and selection values by a list containing their labels.</span>
<span class="sd">        Adapt the domains for the Falsy group (we can&#39;t just keep (selection, =, False)</span>
<span class="sd">        e.g. because some values in database might correspond to  option that have</span>
<span class="sd">        been remove on the parent).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You must choose the property you want to group by.&#39;</span><span class="p">)</span>
        <span class="n">fullname</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property_definition</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
        <span class="n">property_type</span> <span class="o">=</span> <span class="n">definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">property_type</span> <span class="o">==</span> <span class="s1">&#39;selection&#39;</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;selection&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="n">options</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">option</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">]:</span>
                    <span class="c1"># can not do (&#39;selection&#39;, &#39;=&#39;, False) because we might have</span>
                    <span class="c1"># option in database that does not exist anymore</span>
                    <span class="n">additional_domain</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">OR</span><span class="p">([</span>
                        <span class="p">[(</span><span class="n">fullname</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)],</span>
                        <span class="p">[(</span><span class="n">fullname</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">,</span> <span class="n">options</span><span class="p">)],</span>
                    <span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">additional_domain</span> <span class="o">=</span> <span class="p">[(</span><span class="n">fullname</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">])]</span>

                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;__domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">AND</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;__domain&#39;</span><span class="p">],</span> <span class="n">additional_domain</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">property_type</span> <span class="o">==</span> <span class="s1">&#39;many2one&#39;</span><span class="p">:</span>
            <span class="n">comodel</span> <span class="o">=</span> <span class="n">definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;comodel&#39;</span><span class="p">)</span>
            <span class="n">prefetch_ids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows_dict</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">])</span>
            <span class="n">all_groups</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows_dict</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">]:</span>
                    <span class="c1"># can not only do (&#39;many2one&#39;, &#39;=&#39;, False) because we might have</span>
                    <span class="c1"># record in database that does not exist anymore</span>
                    <span class="n">additional_domain</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">OR</span><span class="p">([</span>
                        <span class="p">[(</span><span class="n">fullname</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)],</span>
                        <span class="p">[(</span><span class="n">fullname</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">,</span> <span class="n">all_groups</span><span class="p">)],</span>
                    <span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">additional_domain</span> <span class="o">=</span> <span class="p">[(</span><span class="n">fullname</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">])]</span>
                    <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">comodel</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">])</span><span class="o">.</span><span class="n">with_prefetch</span><span class="p">(</span><span class="n">prefetch_ids</span><span class="p">)</span>
                    <span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">],</span> <span class="n">record</span><span class="o">.</span><span class="n">display_name</span><span class="p">)</span>

                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;__domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">AND</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;__domain&#39;</span><span class="p">],</span> <span class="n">additional_domain</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">property_type</span> <span class="o">==</span> <span class="s1">&#39;many2many&#39;</span><span class="p">:</span>
            <span class="n">comodel</span> <span class="o">=</span> <span class="n">definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;comodel&#39;</span><span class="p">)</span>
            <span class="n">prefetch_ids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows_dict</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">])</span>
            <span class="n">all_groups</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows_dict</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">]:</span>
                    <span class="n">additional_domain</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">OR</span><span class="p">([</span>
                        <span class="p">[(</span><span class="n">fullname</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)],</span>
                        <span class="n">expression</span><span class="o">.</span><span class="n">AND</span><span class="p">([[(</span><span class="n">fullname</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">,</span> <span class="n">group</span><span class="p">)]</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">all_groups</span><span class="p">]),</span>
                    <span class="p">])</span> <span class="k">if</span> <span class="n">all_groups</span> <span class="k">else</span> <span class="p">[]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">additional_domain</span> <span class="o">=</span> <span class="p">[(</span><span class="n">fullname</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">])]</span>
                    <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">comodel</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">])</span><span class="o">.</span><span class="n">with_prefetch</span><span class="p">(</span><span class="n">prefetch_ids</span><span class="p">)</span>
                    <span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">],</span> <span class="n">record</span><span class="o">.</span><span class="n">display_name</span><span class="p">)</span>

                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;__domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">AND</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;__domain&#39;</span><span class="p">],</span> <span class="n">additional_domain</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">property_type</span> <span class="o">==</span> <span class="s1">&#39;tags&#39;</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="n">definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">tag</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">]:</span>
                    <span class="n">additional_domain</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">OR</span><span class="p">([</span>
                        <span class="p">[(</span><span class="n">fullname</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)],</span>
                        <span class="n">expression</span><span class="o">.</span><span class="n">AND</span><span class="p">([[(</span><span class="n">fullname</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="p">)]</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">]),</span>
                    <span class="p">])</span> <span class="k">if</span> <span class="n">tags</span> <span class="k">else</span> <span class="p">[]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">additional_domain</span> <span class="o">=</span> <span class="p">[(</span><span class="n">fullname</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">])]</span>
                    <span class="c1"># replace tag raw value with list of raw value, label and color</span>
                    <span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">]</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">])</span>

                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;__domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">AND</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;__domain&#39;</span><span class="p">],</span> <span class="n">additional_domain</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">property_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="n">group</span><span class="p">]:</span>
                    <span class="n">row</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">row</span><span class="p">[</span><span class="s1">&#39;__domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">AND</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;__domain&#39;</span><span class="p">],</span> <span class="p">[(</span><span class="n">fullname</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]])</span>
                    <span class="n">row</span><span class="p">[</span><span class="s1">&#39;__range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">continue</span>

                <span class="c1"># Date / Datetime are not JSONifiable, so they are stored as raw text</span>
                <span class="n">db_format</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">property_type</span> <span class="o">==</span> <span class="s1">&#39;date&#39;</span> <span class="k">else</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span>

                <span class="k">if</span> <span class="n">func</span> <span class="o">==</span> <span class="s1">&#39;week&#39;</span><span class="p">:</span>
                    <span class="c1"># the value is the first day of the week (based on local)</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">db_format</span><span class="p">)</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">db_format</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">date_utils</span><span class="o">.</span><span class="n">start_of</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="n">func</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">db_format</span><span class="p">)</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">date_utils</span><span class="o">.</span><span class="n">end_of</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="n">func</span><span class="p">)</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">db_format</span><span class="p">)</span>

                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;__domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">AND</span><span class="p">([</span>
                    <span class="n">row</span><span class="p">[</span><span class="s1">&#39;__domain&#39;</span><span class="p">],</span>
                    <span class="p">[(</span><span class="n">fullname</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="n">start</span><span class="p">),</span> <span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="p">)],</span>
                <span class="p">])</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;__range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">group</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="n">end</span><span class="p">}}</span>
                <span class="n">row</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">babel</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">format_date</span><span class="p">(</span>
                    <span class="n">row</span><span class="p">[</span><span class="n">group</span><span class="p">],</span>
                    <span class="nb">format</span><span class="o">=</span><span class="n">READ_GROUP_DISPLAY_FORMAT</span><span class="p">[</span><span class="n">func</span><span class="p">],</span>
                    <span class="n">locale</span><span class="o">=</span><span class="n">get_lang</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span><span class="o">.</span><span class="n">code</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows_dict</span><span class="p">:</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;__domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">AND</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;__domain&#39;</span><span class="p">],</span> <span class="p">[(</span><span class="n">fullname</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">fullname</span><span class="p">])]])</span>

<div class="viewcode-block" id="BaseModel.read_group">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.read_group">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">read_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orderby</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the list of records in list view grouped by the given ``groupby`` fields.</span>

<span class="sd">        :param list domain: :ref:`A search domain &lt;reference/orm/domains&gt;`. Use an empty</span>
<span class="sd">                     list to match all records.</span>
<span class="sd">        :param list fields: list of fields present in the list view specified on the object.</span>
<span class="sd">                Each element is either &#39;field&#39; (field name, using the default aggregation),</span>
<span class="sd">                or &#39;field:agg&#39; (aggregate field with aggregation function &#39;agg&#39;),</span>
<span class="sd">                or &#39;name:agg(field)&#39; (aggregate field with &#39;agg&#39; and return it as &#39;name&#39;).</span>
<span class="sd">                The possible aggregation functions are the ones provided by</span>
<span class="sd">                `PostgreSQL &lt;https://www.postgresql.org/docs/current/static/functions-aggregate.html&gt;`_</span>
<span class="sd">                and &#39;count_distinct&#39;, with the expected meaning.</span>
<span class="sd">        :param list groupby: list of groupby descriptions by which the records will be grouped.</span>
<span class="sd">                A groupby description is either a field (then it will be grouped by that field)</span>
<span class="sd">                or a string &#39;field:granularity&#39;. Right now, the only supported granularities</span>
<span class="sd">                are &#39;day&#39;, &#39;week&#39;, &#39;month&#39;, &#39;quarter&#39; or &#39;year&#39;, and they only make sense for</span>
<span class="sd">                date/datetime fields.</span>
<span class="sd">        :param int offset: optional number of groups to skip</span>
<span class="sd">        :param int limit: optional max number of groups to return</span>
<span class="sd">        :param str orderby: optional ``order by`` specification, for</span>
<span class="sd">                             overriding the natural sort ordering of the</span>
<span class="sd">                             groups, see also :py:meth:`~osv.osv.osv.search`</span>
<span class="sd">                             (supported only for many2one fields currently)</span>
<span class="sd">        :param bool lazy: if true, the results are only grouped by the first groupby and the</span>
<span class="sd">                remaining groupbys are put in the __context key.  If false, all the groupbys are</span>
<span class="sd">                done in one call.</span>
<span class="sd">        :return: list of dictionaries(one dictionary for each record) containing:</span>

<span class="sd">                    * the values of fields grouped by the fields in ``groupby`` argument</span>
<span class="sd">                    * __domain: list of tuples specifying the search criteria</span>
<span class="sd">                    * __context: dictionary with argument like ``groupby``</span>
<span class="sd">                    * __range: (date/datetime only) dictionary with field_name:granularity as keys</span>
<span class="sd">                        mapping to a dictionary with keys: &quot;from&quot; (inclusive) and &quot;to&quot; (exclusive)</span>
<span class="sd">                        mapping to a string representation of the temporal bounds of the group</span>
<span class="sd">        :rtype: [{&#39;field_name_1&#39;: value, ...}, ...]</span>
<span class="sd">        :raise AccessError: if user is not allowed to access requested information</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">groupby</span> <span class="o">=</span> <span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">groupby</span>
        <span class="n">lazy_groupby</span> <span class="o">=</span> <span class="n">groupby</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">lazy</span> <span class="k">else</span> <span class="n">groupby</span>

        <span class="c1"># Compatibility layer with _read_group, it should be remove in the second part of the refactoring</span>
        <span class="c1"># - Modify `groupby` default value &#39;month&#39; into specifique groupby specification</span>
        <span class="c1"># - Modify `fields` into aggregates specification of _read_group</span>
        <span class="c1"># - Modify the order to be compatible with the _read_group specification</span>
        <span class="n">annoted_groupby</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Key as the name in the result, value as the explicit groupby specification</span>
        <span class="k">for</span> <span class="n">group_spec</span> <span class="ow">in</span> <span class="n">lazy_groupby</span><span class="p">:</span>
            <span class="n">field_name</span><span class="p">,</span> <span class="n">property_name</span><span class="p">,</span> <span class="n">granularity</span> <span class="o">=</span> <span class="n">parse_read_group_spec</span><span class="p">(</span><span class="n">group_spec</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid field </span><span class="si">{</span><span class="n">field_name</span><span class="si">!r}</span><span class="s2"> on model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">property_name</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;properties&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Property name </span><span class="si">{</span><span class="n">property_name</span><span class="si">!r}</span><span class="s2"> has to be used on a property field.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">):</span>
                <span class="n">annoted_groupby</span><span class="p">[</span><span class="n">group_spec</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">granularity</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;month&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">annoted_groupby</span><span class="p">[</span><span class="n">group_spec</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_spec</span>

        <span class="n">annoted_aggregates</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># Key as the name in the result, value as the explicit aggregate specification</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lazy_groupby</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_count&quot;</span> <span class="k">if</span> <span class="n">lazy</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lazy_groupby</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;__count&#39;</span><span class="p">:</span> <span class="s1">&#39;__count&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">field_spec</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field_spec</span> <span class="o">==</span> <span class="s1">&#39;__count&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">regex_field_agg</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">field_spec</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid field specification </span><span class="si">{</span><span class="n">field_spec</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">fname</span><span class="p">:</span>  <span class="c1"># Manage this kind of specification : &quot;field_min:min(field)&quot;</span>
                <span class="n">annoted_aggregates</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">func</span><span class="p">:</span>  <span class="c1"># Manage this kind of specification : &quot;field:min&quot;</span>
                <span class="n">annoted_aggregates</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid field </span><span class="si">{</span><span class="n">field_name</span><span class="si">!r}</span><span class="s2"> on model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">base_field</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">base_field</span><span class="o">.</span><span class="n">column_type</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">group_operator</span> <span class="ow">and</span> <span class="n">field_spec</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">annoted_groupby</span><span class="p">:</span>
                <span class="n">annoted_aggregates</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">group_operator</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">orderby</span><span class="p">:</span>
            <span class="n">new_terms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">order_term</span> <span class="ow">in</span> <span class="n">orderby</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
                <span class="n">order_term</span> <span class="o">=</span> <span class="n">order_term</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">key_name</span><span class="p">,</span> <span class="n">annoted</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">annoted_groupby</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">annoted_aggregates</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="n">key_name</span> <span class="o">=</span> <span class="n">key_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">order_term</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key_name</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">key_name</span> <span class="o">==</span> <span class="n">order_term</span><span class="p">:</span>
                        <span class="n">order_term</span> <span class="o">=</span> <span class="n">order_term</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">key_name</span><span class="p">,</span> <span class="n">annoted</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="n">new_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order_term</span><span class="p">)</span>
            <span class="n">orderby</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_terms</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">orderby</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">annoted_groupby</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_group</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">annoted_groupby</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">annoted_aggregates</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">orderby</span><span class="p">)</span>
        <span class="n">rows_dict</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">annoted_groupby</span><span class="p">,</span> <span class="n">annoted_aggregates</span><span class="p">),</span> <span class="n">row</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span>
        <span class="p">]</span>

        <span class="n">fill_temporal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fill_temporal&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lazy_groupby</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rows_dict</span> <span class="ow">and</span> <span class="n">fill_temporal</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fill_temporal</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># fill_temporal = {} is equivalent to fill_temporal = True</span>
            <span class="c1"># if fill_temporal is a dictionary and there is no data, there is a chance that we</span>
            <span class="c1"># want to display empty columns anyway, so we should apply the fill_temporal logic</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fill_temporal</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">fill_temporal</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># TODO Shouldn&#39;t be possible with a limit</span>
            <span class="n">rows_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_fill_temporal</span><span class="p">(</span>
                <span class="n">rows_dict</span><span class="p">,</span> <span class="n">lazy_groupby</span><span class="p">,</span>
                <span class="n">annoted_aggregates</span><span class="p">,</span> <span class="o">**</span><span class="n">fill_temporal</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">lazy_groupby</span> <span class="ow">and</span> <span class="n">lazy</span><span class="p">:</span>
            <span class="c1"># Right now, read_group only fill results in lazy mode (by default).</span>
            <span class="c1"># If you need to have the empty groups in &#39;eager&#39; mode, then the</span>
            <span class="c1"># method _read_group_fill_results need to be completely reimplemented</span>
            <span class="c1"># in a sane way</span>
            <span class="c1"># TODO Shouldn&#39;t be possible with a limit or the limit should be in account</span>
            <span class="n">rows_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_fill_results</span><span class="p">(</span>
                <span class="n">domain</span><span class="p">,</span> <span class="n">lazy_groupby</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">annoted_aggregates</span><span class="p">,</span> <span class="n">rows_dict</span><span class="p">,</span> <span class="n">read_group_order</span><span class="o">=</span><span class="n">orderby</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows_dict</span><span class="p">:</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;__domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">domain</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lazy_groupby</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">groupby</span><span class="p">):</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;__context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;group_by&#39;</span><span class="p">:</span> <span class="n">groupby</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">lazy_groupby</span><span class="p">):]}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_format_result</span><span class="p">(</span><span class="n">rows_dict</span><span class="p">,</span> <span class="n">lazy_groupby</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rows_dict</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_inherits_join_calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds missing table select and join clause(s) to ``query`` for reaching</span>
<span class="sd">        the field coming from an &#39;_inherits&#39; parent table (no duplicates).</span>

<span class="sd">        :param alias: name of the initial SQL alias</span>
<span class="sd">        :param fname: name of inherited field to reach</span>
<span class="sd">        :param query: query object on which the JOIN should be added</span>
<span class="sd">        :return: qualified name of field, to be used in SELECT clause</span>

<span class="sd">        .. deprecated:: 17.0</span>
<span class="sd">            Deprecated method, use _field_to_sql() instead</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Deprecated method _inherits_join_calc(), _field_to_sql() instead&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_to_sql</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">mogrify</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_field_to_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="p">(</span><span class="n">Query</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SQL</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return an :class:`SQL` object that represents the value of the given</span>
<span class="sd">        field from the given table alias, in the context of the given query.</span>
<span class="sd">        The query object is necessary for inherited fields, many2one fields and</span>
<span class="sd">        properties fields, where joins are added to the query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">full_fname</span> <span class="o">=</span> <span class="n">fname</span>
        <span class="n">property_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">fname</span><span class="p">:</span>
            <span class="n">fname</span><span class="p">,</span> <span class="n">property_name</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">inherited</span><span class="p">:</span>
            <span class="c1"># retrieve the parent model where field is inherited from</span>
            <span class="n">parent_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">related_field</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span>
            <span class="n">parent_fname</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># LEFT JOIN parent_model._table AS parent_alias ON alias.parent_fname = parent_alias.id</span>
            <span class="n">parent_alias</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">make_alias</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">parent_fname</span><span class="p">)</span>
            <span class="n">query</span><span class="o">.</span><span class="n">add_join</span><span class="p">(</span><span class="s1">&#39;LEFT JOIN&#39;</span><span class="p">,</span> <span class="n">parent_alias</span><span class="p">,</span> <span class="n">parent_model</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">SQL</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_field_to_sql</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">parent_fname</span><span class="p">,</span> <span class="n">query</span><span class="p">),</span>
                <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">parent_alias</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">),</span>
            <span class="p">))</span>
            <span class="c1"># delegate to the parent model</span>
            <span class="k">return</span> <span class="n">parent_model</span><span class="o">.</span><span class="n">_field_to_sql</span><span class="p">(</span><span class="n">parent_alias</span><span class="p">,</span> <span class="n">full_fname</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot convert field </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> to SQL&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2many&#39;</span><span class="p">:</span>
            <span class="c1"># special case for many2many fields: prepare a query on the comodel</span>
            <span class="c1"># in order to reuse the mechanism _apply_ir_rules, then inject the</span>
            <span class="c1"># query as an extra condition of the left join</span>
            <span class="n">comodel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span>
            <span class="n">coquery</span> <span class="o">=</span> <span class="n">comodel</span><span class="o">.</span><span class="n">_where_calc</span><span class="p">([],</span> <span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">comodel</span><span class="o">.</span><span class="n">_apply_ir_rules</span><span class="p">(</span><span class="n">coquery</span><span class="p">)</span>
            <span class="c1"># LEFT JOIN {field.relation} AS rel_alias ON</span>
            <span class="c1">#     alias.id = rel_alias.{field.column1}</span>
            <span class="c1">#     AND rel_alias.{field.column2} IN ({coquery})</span>
            <span class="n">rel_alias</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">make_alias</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">),</span>
                <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">rel_alias</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">column1</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">coquery</span><span class="o">.</span><span class="n">where_clause</span><span class="p">:</span>
                <span class="n">condition</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> AND </span><span class="si">%s</span><span class="s2"> IN </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">condition</span><span class="p">,</span>
                    <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">rel_alias</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">column2</span><span class="p">),</span>
                    <span class="n">coquery</span><span class="o">.</span><span class="n">subselect</span><span class="p">(),</span>
                <span class="p">)</span>
            <span class="n">query</span><span class="o">.</span><span class="n">add_join</span><span class="p">(</span><span class="s2">&quot;LEFT JOIN&quot;</span><span class="p">,</span> <span class="n">rel_alias</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">relation</span><span class="p">,</span> <span class="n">condition</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">rel_alias</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">column2</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prefetch_langs&#39;</span><span class="p">):</span>
            <span class="n">sql_field</span> <span class="o">=</span> <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="n">langs</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_translation_fallback_langs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
            <span class="n">sql_field_langs</span> <span class="o">=</span> <span class="p">[</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-&gt;&gt;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sql_field</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span> <span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">langs</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sql_field_langs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">sql_field_langs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;COALESCE(</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sql_field_langs</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;properties&#39;</span> <span class="ow">and</span> <span class="n">property_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_properties_to_sql</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">property_name</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_field_properties_to_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">property_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                 <span class="n">query</span><span class="p">:</span> <span class="n">Query</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SQL</span><span class="p">:</span>
        <span class="n">definition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_property_definition</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">property_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">property_type</span> <span class="o">=</span> <span class="n">definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>

        <span class="n">sql_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_to_sql</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">sql_property</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sql_field</span><span class="p">,</span> <span class="n">property_name</span><span class="p">)</span>

        <span class="c1"># JOIN on the JSON array</span>
        <span class="k">if</span> <span class="n">property_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;many2many&#39;</span><span class="p">):</span>
            <span class="n">property_alias</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">make_alias</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">property_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">sql_property</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot; CASE</span>
<span class="sd">                        WHEN jsonb_typeof(%(property)s) = &#39;array&#39;</span>
<span class="sd">                        THEN %(property)s</span>
<span class="sd">                        ELSE &#39;[]&#39;::jsonb</span>
<span class="sd">                     END &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="nb">property</span><span class="o">=</span><span class="n">sql_property</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">property_type</span> <span class="o">==</span> <span class="s1">&#39;tags&#39;</span><span class="p">:</span>
                <span class="c1"># ignore invalid tags</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]]</span>
                <span class="c1"># `-&gt;&gt;0 : convert &quot;JSON string&quot; into string</span>
                <span class="n">condition</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-&gt;&gt;0 = ANY(</span><span class="si">%s</span><span class="s2">::text[])&quot;</span><span class="p">,</span>
                    <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">property_alias</span><span class="p">),</span> <span class="n">tags</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">comodel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;comodel&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">comodel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">comodel</span><span class="o">.</span><span class="n">_transient</span> <span class="ow">or</span> <span class="n">comodel</span><span class="o">.</span><span class="n">_abstract</span><span class="p">:</span>
                    <span class="c1"># all value are false, because the model does not exist anymore</span>
                    <span class="c1"># (or is a transient model e.g.)</span>
                    <span class="n">condition</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;FALSE&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># check the existences of the many2many</span>
                    <span class="n">condition</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">::int IN (SELECT id FROM </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
                        <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">property_alias</span><span class="p">),</span> <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">comodel</span><span class="o">.</span><span class="n">_table</span><span class="p">),</span>
                    <span class="p">)</span>

            <span class="n">query</span><span class="o">.</span><span class="n">add_join</span><span class="p">(</span>
                <span class="s2">&quot;LEFT JOIN&quot;</span><span class="p">,</span>
                <span class="n">property_alias</span><span class="p">,</span>
                <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;jsonb_array_elements(</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">sql_property</span><span class="p">),</span>
                <span class="n">condition</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">property_alias</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">property_type</span> <span class="o">==</span> <span class="s1">&#39;selection&#39;</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="n">option</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;selection&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">()]</span>

            <span class="c1"># check the existence of the option</span>
            <span class="n">property_alias</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">make_alias</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">property_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">query</span><span class="o">.</span><span class="n">add_join</span><span class="p">(</span>
                <span class="s2">&quot;LEFT JOIN&quot;</span><span class="p">,</span>
                <span class="n">property_alias</span><span class="p">,</span>
                <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;(SELECT unnest(</span><span class="si">%s</span><span class="s2">::text[]) </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">property_alias</span><span class="p">)),</span>
                <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-&gt;&gt;0 = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sql_property</span><span class="p">,</span> <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">property_alias</span><span class="p">)),</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">property_alias</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">property_type</span> <span class="o">==</span> <span class="s1">&#39;many2one&#39;</span><span class="p">:</span>
            <span class="n">comodel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;comodel&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">comodel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">comodel</span><span class="o">.</span><span class="n">_transient</span> <span class="ow">or</span> <span class="n">comodel</span><span class="o">.</span><span class="n">_abstract</span><span class="p">:</span>
                <span class="c1"># all value are false, because the model does not exist anymore</span>
                <span class="c1"># (or is a transient model e.g.)</span>
                <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;FALSE&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot; CASE</span>
<span class="sd">                        WHEN jsonb_typeof(%(property)s) = &#39;number&#39;</span>
<span class="sd">                         AND (%(property)s)::int IN (SELECT id FROM %(table)s)</span>
<span class="sd">                        THEN %(property)s</span>
<span class="sd">                        ELSE NULL</span>
<span class="sd">                     END &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="nb">property</span><span class="o">=</span><span class="n">sql_property</span><span class="p">,</span>
                <span class="n">table</span><span class="o">=</span><span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">comodel</span><span class="o">.</span><span class="n">_table</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">property_type</span> <span class="o">==</span> <span class="s1">&#39;date&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot; CASE</span>
<span class="sd">                        WHEN jsonb_typeof(%(property)s) = &#39;string&#39;</span>
<span class="sd">                        THEN (%(property)s-&gt;&gt;0)::DATE</span>
<span class="sd">                        ELSE NULL</span>
<span class="sd">                     END &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="nb">property</span><span class="o">=</span><span class="n">sql_property</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">property_type</span> <span class="o">==</span> <span class="s1">&#39;datetime&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot; CASE</span>
<span class="sd">                        WHEN jsonb_typeof(%(property)s) = &#39;string&#39;</span>
<span class="sd">                        THEN to_timestamp(%(property)s-&gt;&gt;0, &#39;YYYY-MM-DD HH24:MI:SS&#39;)</span>
<span class="sd">                        ELSE NULL</span>
<span class="sd">                     END &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="nb">property</span><span class="o">=</span><span class="n">sql_property</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># if the key is not present in the dict, fallback to false instead of none</span>
        <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;COALESCE(</span><span class="si">%s</span><span class="s2">, &#39;false&#39;)&quot;</span><span class="p">,</span> <span class="n">sql_property</span><span class="p">)</span>

<div class="viewcode-block" id="BaseModel.get_property_definition">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.get_property_definition">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">get_property_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the definition of the given property.</span>

<span class="sd">        :param full_name: Name of the field / property</span>
<span class="sd">            (e.g. &quot;property.integer&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s2">&quot;read&quot;</span><span class="p">)</span>
        <span class="n">field_name</span><span class="p">,</span> <span class="n">property_name</span> <span class="o">=</span> <span class="n">full_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">check_property_field_value_name</span><span class="p">(</span><span class="n">property_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrong field name </span><span class="si">{</span><span class="n">field_name</span><span class="si">!r}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
        <span class="n">target_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">definition_record</span><span class="p">]</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot; SELECT definition</span>
<span class="sd">                  FROM %(table)s, jsonb_array_elements(%(field)s) definition</span>
<span class="sd">                 WHERE %(field)s IS NOT NULL AND definition-&gt;&gt;&#39;name&#39; = %(name)s</span>
<span class="sd">                 LIMIT 1 &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="n">table</span><span class="o">=</span><span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">target_model</span><span class="o">.</span><span class="n">_table</span><span class="p">),</span>
            <span class="n">field</span><span class="o">=</span><span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">definition_record_field</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="n">property_name</span><span class="p">,</span>
        <span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">dictfetchone</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;definition&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="p">{}</span></div>


    <span class="k">def</span> <span class="nf">_parent_store_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Compute parent_path field from scratch. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_store</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Each record is associated to a string &#39;parent_path&#39;, that represents</span>
        <span class="c1"># the path from the record&#39;s root node to the record. The path is made</span>
        <span class="c1"># of the node ids suffixed with a slash (see example below). The nodes</span>
        <span class="c1"># in the subtree of record are the ones where &#39;parent_path&#39; starts with</span>
        <span class="c1"># the &#39;parent_path&#39; of record.</span>
        <span class="c1">#</span>
        <span class="c1">#               a                 node | id | parent_path</span>
        <span class="c1">#              / \                  a  | 42 | 42/</span>
        <span class="c1">#            ...  b                 b  | 63 | 42/63/</span>
        <span class="c1">#                / \                c  | 84 | 42/63/84/</span>
        <span class="c1">#               c   d               d  | 85 | 42/63/85/</span>
        <span class="c1">#</span>
        <span class="c1"># Note: the final &#39;/&#39; is necessary to match subtrees correctly: &#39;42/63&#39;</span>
        <span class="c1"># is a prefix of &#39;42/630&#39;, but &#39;42/63/&#39; is not a prefix of &#39;42/630/&#39;.</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing parent_path for table </span><span class="si">%s</span><span class="s1">...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot; WITH RECURSIVE __parent_store_compute(id, parent_path) AS (</span>
<span class="sd">                    SELECT row.id, concat(row.id, &#39;/&#39;)</span>
<span class="sd">                    FROM %(table)s row</span>
<span class="sd">                    WHERE row.%(parent)s IS NULL</span>
<span class="sd">                UNION</span>
<span class="sd">                    SELECT row.id, concat(comp.parent_path, row.id, &#39;/&#39;)</span>
<span class="sd">                    FROM %(table)s row, __parent_store_compute comp</span>
<span class="sd">                    WHERE row.%(parent)s = comp.id</span>
<span class="sd">                )</span>
<span class="sd">                UPDATE %(table)s row SET parent_path = comp.parent_path</span>
<span class="sd">                FROM __parent_store_compute comp</span>
<span class="sd">                WHERE row.id = comp.id &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="n">table</span><span class="o">=</span><span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">),</span>
            <span class="n">parent</span><span class="o">=</span><span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invalidate_model</span><span class="p">([</span><span class="s1">&#39;parent_path&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_check_removed_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_abstract</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># iterate on the database columns to drop the NOT NULL constraints of</span>
        <span class="c1"># fields which were required but have been removed (or will be added by</span>
        <span class="c1"># another module)</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                     <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">column_type</span><span class="p">]</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot; SELECT a.attname, a.attnotnull</span>
<span class="sd">                  FROM pg_class c, pg_attribute a</span>
<span class="sd">                 WHERE c.relname=%s</span>
<span class="sd">                   AND c.oid=a.attrelid</span>
<span class="sd">                   AND a.attisdropped=%s</span>
<span class="sd">                   AND pg_catalog.format_type(a.atttypid, a.atttypmod) NOT IN (&#39;cid&#39;, &#39;tid&#39;, &#39;oid&#39;, &#39;xid&#39;)</span>
<span class="sd">                   AND a.attname NOT IN %s &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">cols</span><span class="p">),</span>
        <span class="p">))</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;column </span><span class="si">%s</span><span class="s2"> is in the table </span><span class="si">%s</span><span class="s2"> but not in the corresponding object </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                              <span class="n">row</span><span class="p">[</span><span class="s1">&#39;attname&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;attnotnull&#39;</span><span class="p">]:</span>
                <span class="n">tools</span><span class="o">.</span><span class="n">drop_not_null</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;attname&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_init_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Initialize the value of the given column for existing rows. &quot;&quot;&quot;</span>
        <span class="c1"># get the default value; ideally, we should use default_get(), but it</span>
        <span class="c1"># fails due to ir.default not being ready</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_write</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_column</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Write value if non-NULL, except for booleans for which False means</span>
        <span class="c1"># the same as NULL - this saves us an expensive query on large tables.</span>
        <span class="n">necessary</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;boolean&#39;</span> <span class="k">else</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">necessary</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Table &#39;</span><span class="si">%s</span><span class="s2">&#39;: setting default value of new column </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span>
                <span class="s2">&quot;UPDATE </span><span class="si">%(table)s</span><span class="s2"> SET </span><span class="si">%(field)s</span><span class="s2"> = </span><span class="si">%(value)s</span><span class="s2"> WHERE </span><span class="si">%(field)s</span><span class="s2"> IS NULL&quot;</span><span class="p">,</span>
                <span class="n">table</span><span class="o">=</span><span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">),</span>
                <span class="n">field</span><span class="o">=</span><span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">column_name</span><span class="p">),</span>
                <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
            <span class="p">))</span>

    <span class="nd">@ormcache</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_table_has_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return whether the model&#39;s table has rows. This method should only</span>
<span class="sd">            be used when updating the database schema (:meth:`~._auto_init`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;SELECT 1 FROM </span><span class="si">%s</span><span class="s1"> LIMIT 1&#39;</span><span class="p">,</span> <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">rowcount</span>

    <span class="k">def</span> <span class="nf">_auto_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Initialize the database schema of ``self``:</span>
<span class="sd">            - create the corresponding table,</span>
<span class="sd">            - create/update the necessary columns/tables for fields,</span>
<span class="sd">            - initialize new columns on existing rows,</span>
<span class="sd">            - add the SQL constraints given on the model,</span>
<span class="sd">            - add the indexes on indexed fields,</span>

<span class="sd">            Also prepare post-init stuff to:</span>
<span class="sd">            - add foreign key constraints,</span>
<span class="sd">            - reflect models, fields, relations and constraints,</span>
<span class="sd">            - mark fields to recompute on existing records.</span>

<span class="sd">            Note: you should not override this method. Instead, you can modify</span>
<span class="sd">            the model&#39;s database schema by overriding method :meth:`~.init`,</span>
<span class="sd">            which is called right after this one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">raise_on_invalid_object_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

        <span class="c1"># This prevents anything called by this method (in particular default</span>
        <span class="c1"># values) from prefetching a field for which the corresponding column</span>
        <span class="c1"># has not been added in database yet!</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">prefetch_fields</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span>
        <span class="n">update_custom_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;update_custom_fields&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">must_create_table</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">tools</span><span class="o">.</span><span class="n">table_exists</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
        <span class="n">parent_path_compute</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">must_create_table</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">make_type</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">field</span><span class="o">.</span><span class="n">column_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; NOT NULL&quot;</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">required</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

                <span class="n">tools</span><span class="o">.</span><span class="n">create_model_table</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">,</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">make_type</span><span class="p">(</span><span class="n">field</span><span class="p">),</span> <span class="n">field</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">column_order</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;id&#39;</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">column_type</span>
                <span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_store</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">tools</span><span class="o">.</span><span class="n">column_exists</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="s1">&#39;parent_path&#39;</span><span class="p">):</span>
                    <span class="n">tools</span><span class="o">.</span><span class="n">create_column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="s1">&#39;parent_path&#39;</span><span class="p">,</span> <span class="s1">&#39;VARCHAR&#39;</span><span class="p">)</span>
                    <span class="n">parent_path_compute</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_parent_path</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">must_create_table</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_removed_columns</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># update the database schema for fields</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">table_columns</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
            <span class="n">fields_to_compute</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">column_order</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">manual</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">update_custom_fields</span><span class="p">:</span>
                    <span class="k">continue</span>            <span class="c1"># don&#39;t update custom fields</span>
                <span class="n">new</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">update_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">compute</span><span class="p">:</span>
                    <span class="n">fields_to_compute</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">fields_to_compute</span><span class="p">:</span>
                <span class="c1"># mark existing records for computation now, so that computed</span>
                <span class="c1"># required fields are flushed before the NOT NULL constraint is</span>
                <span class="c1"># added to the database</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;SELECT id FROM </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)))</span>
                <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">records</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields_to_compute</span><span class="p">:</span>
                        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Prepare computation of </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">add_to_compute</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">records</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_sql_constraints</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">parent_path_compute</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parent_store_compute</span><span class="p">()</span>

<div class="viewcode-block" id="BaseModel.init">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.init">[docs]</a>
    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; This method is called after :meth:`~._auto_init`, and may be</span>
<span class="sd">            overridden to create or modify a model&#39;s database schema.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


    <span class="k">def</span> <span class="nf">_check_parent_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parent_path&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;add a field parent_path on model </span><span class="si">%r</span><span class="s2">: `parent_path = fields.Char(index=True, unaccent=False)`.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;parent_path field on model </span><span class="si">%r</span><span class="s1"> should be indexed! Add index=True to the field definition.&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">unaccent</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;parent_path field on model </span><span class="si">%r</span><span class="s2"> should have unaccent disabled. Add `unaccent=False` to the field definition.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_sql_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Modify this model&#39;s database table constraints so they match the one</span>
<span class="sd">        in _sql_constraints.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span>
        <span class="n">foreign_key_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s*foreign\s+key\b.*&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">definition</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql_constraints</span><span class="p">:</span>
            <span class="n">conname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conname</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">:</span>
                <span class="n">hashed_conname</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">make_identifier</span><span class="p">(</span><span class="n">conname</span><span class="p">)</span>
                <span class="n">current_definition</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">constraint_definition</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">hashed_conname</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">current_definition</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Constraint name </span><span class="si">%r</span><span class="s2"> has more than 63 characters, internal PG identifier is </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">conname</span><span class="p">,</span> <span class="n">hashed_conname</span><span class="p">)</span>
                <span class="n">conname</span> <span class="o">=</span> <span class="n">hashed_conname</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_definition</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">constraint_definition</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">conname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">current_definition</span> <span class="o">==</span> <span class="n">definition</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">current_definition</span><span class="p">:</span>
                <span class="c1"># constraint exists but its definition may have changed</span>
                <span class="n">tools</span><span class="o">.</span><span class="n">drop_constraint</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">conname</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">definition</span><span class="p">:</span>
                <span class="c1"># virtual constraint (e.g. implemented by a custom index)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">post_init</span><span class="p">(</span><span class="n">tools</span><span class="o">.</span><span class="n">check_index_exist</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">conname</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">foreign_key_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">definition</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">post_init</span><span class="p">(</span><span class="n">tools</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">conname</span><span class="p">,</span> <span class="n">definition</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">post_constraint</span><span class="p">(</span><span class="n">tools</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">conname</span><span class="p">,</span> <span class="n">definition</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Update objects that use this one to update their _inherits fields</span>
    <span class="c1">#</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_add_inherited_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Determine inherited fields. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_abstract</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># determine which fields can be inherited</span>
        <span class="n">to_inherit</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="p">(</span><span class="n">parent_fname</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">parent_model_name</span><span class="p">,</span> <span class="n">parent_fname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">parent_model_name</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># add inherited fields that are not redefined locally</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">parent_fname</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="ow">in</span> <span class="n">to_inherit</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
                <span class="c1"># inherited fields are implemented as related fields, with the</span>
                <span class="c1"># following specific properties:</span>
                <span class="c1">#  - reading inherited fields should not bypass access rights</span>
                <span class="c1">#  - copy inherited fields iff their original field is copied</span>
                <span class="n">Field</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span>
                    <span class="n">inherited</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">inherited_field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
                    <span class="n">related</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parent_fname</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">related_sudo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">copy</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">copy</span><span class="p">,</span>
                    <span class="n">readonly</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">readonly</span><span class="p">,</span>
                    <span class="n">export_string_translation</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">export_string_translation</span><span class="p">,</span>
                <span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_inherits_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Missing many2one field definition for _inherits reference &quot;</span><span class="si">%s</span><span class="s1">&quot; in &quot;</span><span class="si">%s</span><span class="s1">&quot;, using default one.&#39;</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                <span class="kn">from</span> <span class="nn">.fields</span> <span class="kn">import</span> <span class="n">Many2one</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">Many2one</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s2">&quot;Automatically created field to link to parent </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">table</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s2">&quot;cascade&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">required</span> <span class="ow">and</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">ondelete</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;cascade&quot;</span><span class="p">,</span> <span class="s2">&quot;restrict&quot;</span><span class="p">)):</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Field definition for _inherits reference &quot;</span><span class="si">%s</span><span class="s1">&quot; in &quot;</span><span class="si">%s</span><span class="s1">&quot; must be marked as &quot;required&quot; with ondelete=&quot;cascade&quot; or &quot;restrict&quot;, forcing it to required + cascade.&#39;</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                <span class="n">field</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">field</span><span class="o">.</span><span class="n">ondelete</span> <span class="o">=</span> <span class="s2">&quot;cascade&quot;</span>
            <span class="n">field</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># reflect fields with delegate=True in dictionary self._inherits</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2one&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">related</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">delegate</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">required</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Field </span><span class="si">%s</span><span class="s2"> with delegate=True must be required.&quot;</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                    <span class="n">field</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">ondelete</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;cascade&#39;</span><span class="p">,</span> <span class="s1">&#39;restrict&#39;</span><span class="p">):</span>
                    <span class="n">field</span><span class="o">.</span><span class="n">ondelete</span> <span class="o">=</span> <span class="s1">&#39;cascade&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">_inherits</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span><span class="o">.</span><span class="n">_inherits_children</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_prepare_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Prepare the setup of the model. &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_setup_done</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># changing base classes is costly, do it only when necessary</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__base_classes</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__base_classes</span>

        <span class="c1"># reset those attributes on the model&#39;s class for _setup_fields() below</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;_rec_name&#39;</span><span class="p">,</span> <span class="s1">&#39;_active_name&#39;</span><span class="p">):</span>
            <span class="n">discardattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_setup_base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Determine the inherited and custom fields of the model. &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_setup_done</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># the classes that define this model, i.e., the ones that are not</span>
        <span class="c1"># registry classes; the purpose of this attribute is to behave as a</span>
        <span class="c1"># cache of [c for c in cls.mro() if not is_registry_class(c))], which</span>
        <span class="c1"># is heavily used in function fields.resolve_mro()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_model_classes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mro</span><span class="p">()</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;pool&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># 1. determine the proper fields of the model: the fields defined on the</span>
        <span class="c1"># class and magic fields, not the inherited or custom ones</span>

        <span class="c1"># retrieve fields from parent classes, and duplicate them on cls to</span>
        <span class="c1"># avoid clashes with inheritance between different models</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="n">discardattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># collect the definitions of each field (base definition + overrides)</span>
        <span class="n">definitions</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">klass</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_model_classes</span><span class="p">):</span>
            <span class="c1"># this condition is an optimization of is_definition_class(klass)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">MetaModel</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">klass</span><span class="o">.</span><span class="n">_field_definitions</span><span class="p">:</span>
                    <span class="n">definitions</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fields_</span> <span class="ow">in</span> <span class="n">definitions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_database_translated_fields</span><span class="p">:</span>
                <span class="c1"># the field is currently translated in the database; ensure the</span>
                <span class="c1"># field is translated to avoid converting its column to varchar</span>
                <span class="c1"># and losing data</span>
                <span class="n">translate</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span>
                    <span class="n">field</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;translate&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">fields_</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;translate&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">args</span>
                <span class="p">),</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">translate</span><span class="p">:</span>
                    <span class="c1"># patch the field definition by adding an override</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Patching </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2"> with translate=True&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="n">fields_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">fields_</span><span class="p">[</span><span class="mi">0</span><span class="p">])(</span><span class="n">translate</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">fields_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_direct</span> <span class="ow">and</span> <span class="n">fields_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fields_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Field</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">fields_</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="n">_base_fields</span><span class="o">=</span><span class="n">fields_</span><span class="p">))</span>

        <span class="c1"># 2. add manual fields</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_init_modules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_add_manual_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># 3. make sure that parent models determine their own fields, then add</span>
        <span class="c1"># inherited fields to cls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inherits_check</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">_setup_base</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_inherited_fields</span><span class="p">()</span>

        <span class="c1"># 4. initialize more field metadata</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_setup_done</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">field</span><span class="o">.</span><span class="n">prepare_setup</span><span class="p">()</span>

        <span class="c1"># 5. determine and validate rec_name</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_rec_name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span> \
                <span class="s2">&quot;Invalid _rec_name=</span><span class="si">%r</span><span class="s2"> for model </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_rec_name</span> <span class="o">=</span> <span class="s1">&#39;name&#39;</span>
        <span class="k">elif</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_custom</span> <span class="ow">and</span> <span class="s1">&#39;x_name&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_rec_name</span> <span class="o">=</span> <span class="s1">&#39;x_name&#39;</span>

        <span class="c1"># 6. determine and validate active_name</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_active_name</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_active_name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span>
                    <span class="ow">and</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_active_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="s1">&#39;x_active&#39;</span><span class="p">)),</span> \
                <span class="p">(</span><span class="s2">&quot;Invalid _active_name=</span><span class="si">%r</span><span class="s2"> for model </span><span class="si">%r</span><span class="s2">; only &#39;active&#39; and &quot;</span>
                <span class="s2">&quot;&#39;x_active&#39; are supported and the field must be present on &quot;</span>
                <span class="s2">&quot;the model&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_active_name</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;active&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_active_name</span> <span class="o">=</span> <span class="s1">&#39;active&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;x_active&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_active_name</span> <span class="o">=</span> <span class="s1">&#39;x_active&#39;</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_setup_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Setup the fields, except for recomputation triggers. &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span>

        <span class="c1"># set up fields</span>
        <span class="n">bad_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">field</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">base_field</span><span class="o">.</span><span class="n">manual</span><span class="p">:</span>
                    <span class="c1"># Something goes wrong when setup a manual field.</span>
                    <span class="c1"># This can happen with related fields using another manual many2one field</span>
                    <span class="c1"># that hasn&#39;t been loaded because the comodel does not exist yet.</span>
                    <span class="c1"># This can also be a manual function field depending on not loaded fields yet.</span>
                    <span class="n">bad_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">raise</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">bad_fields</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_field</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_setup_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Setup recomputation triggers, and complete the model setup. &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span>

        <span class="c1"># register constraints and onchange methods</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_init_constraints_onchanges</span><span class="p">()</span>

<div class="viewcode-block" id="BaseModel.fields_get">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.fields_get">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">fields_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allfields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; fields_get([allfields][, attributes])</span>

<span class="sd">        Return the definition of each field.</span>

<span class="sd">        The returned value is a dictionary (indexed by field name) of</span>
<span class="sd">        dictionaries. The _inherits&#39;d fields are included. The string, help,</span>
<span class="sd">        and selection (if present) attributes are translated.</span>

<span class="sd">        :param list allfields: fields to document, all if empty or not provided</span>
<span class="sd">        :param list attributes: attributes to return for each field, all if empty or not provided</span>
<span class="sd">        :return: dictionary mapping field names to a dictionary mapping attributes to values.</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">allfields</span> <span class="ow">and</span> <span class="n">fname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allfields</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">groups</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">su</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_has_groups</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">groups</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">description</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_description</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="n">attributes</span><span class="p">)</span>
            <span class="n">res</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="n">description</span>

        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="BaseModel.check_field_access_rights">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.check_field_access_rights">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">check_field_access_rights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">field_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check the user access rights on the given fields.</span>

<span class="sd">        :param str operation: one of ``create``, ``read``, ``write``, ``unlink``</span>
<span class="sd">        :param field_names: names of the fields</span>
<span class="sd">        :type field_names: list or None</span>
<span class="sd">        :return: provided fields if fields is truthy (or the fields</span>
<span class="sd">          readable by the current user).</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        :raise AccessError: if the user is not allowed to access</span>
<span class="sd">          the provided fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">su</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">field_names</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">valid</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot; determine whether user has access to field ``fname`` &quot;&quot;&quot;</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_has_groups</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">field_names</span><span class="p">:</span>
            <span class="n">field_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span> <span class="k">if</span> <span class="n">valid</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">invalid_fields</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">field_names</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">(</span><span class="n">name</span><span class="p">)}</span>
            <span class="k">if</span> <span class="n">invalid_fields</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Access Denied by ACLs for operation: </span><span class="si">%s</span><span class="s1">, uid: </span><span class="si">%s</span><span class="s1">, model: </span><span class="si">%s</span><span class="s1">, fields: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                             <span class="n">operation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">invalid_fields</span><span class="p">))</span>

                <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_group</span><span class="p">(</span><span class="s1">&#39;base.group_no_one&#39;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">AccessError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;You do not have enough rights to access the fields </span><span class="se">\&quot;</span><span class="si">%(fields)s</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
                        <span class="s2">&quot; on </span><span class="si">%(document_kind)s</span><span class="s2"> (</span><span class="si">%(document_model)s</span><span class="s2">). &quot;</span>
                        <span class="s2">&quot;Please contact your system administrator.&quot;</span>
                        <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">(Operation: </span><span class="si">%(operation)s</span><span class="s2">)&quot;</span><span class="p">,</span>
                        <span class="n">fields</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">invalid_fields</span><span class="p">)),</span>
                        <span class="n">document_kind</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
                        <span class="n">document_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                        <span class="n">operation</span><span class="o">=</span><span class="n">operation</span><span class="p">,</span>
                    <span class="p">))</span>

                <span class="k">def</span> <span class="nf">format_groups</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">groups</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;always forbidden&quot;</span><span class="p">)</span>

                    <span class="n">anyof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.groups&#39;</span><span class="p">]</span>
                    <span class="n">noneof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.groups&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">):</span>
                            <span class="n">noneof</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">anyof</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                    <span class="n">strs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">anyof</span><span class="p">:</span>
                        <span class="n">strs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                            <span class="s2">&quot;allowed for groups </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                <span class="n">anyof</span><span class="o">.</span><span class="n">sorted</span><span class="p">(</span><span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                                    <span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">display_name</span><span class="p">))</span>
                            <span class="p">),</span>
                        <span class="p">))</span>
                    <span class="k">if</span> <span class="n">noneof</span><span class="p">:</span>
                        <span class="n">strs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                            <span class="s2">&quot;forbidden for groups </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                <span class="n">noneof</span><span class="o">.</span><span class="n">sorted</span><span class="p">(</span><span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                                    <span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">display_name</span><span class="p">))</span>
                            <span class="p">),</span>
                        <span class="p">))</span>
                    <span class="k">return</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">strs</span><span class="p">)</span>

                <span class="k">raise</span> <span class="n">AccessError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;The requested operation can not be completed due to security restrictions.&quot;</span>
                    <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Document type: </span><span class="si">%(document_kind)s</span><span class="s2"> (</span><span class="si">%(document_model)s</span><span class="s2">)&quot;</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Operation: </span><span class="si">%(operation)s</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">User: </span><span class="si">%(user)s</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Fields:&quot;</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="si">%(fields_list)s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">document_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                    <span class="n">document_kind</span><span class="o">=</span><span class="n">description</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                    <span class="n">operation</span><span class="o">=</span><span class="n">operation</span><span class="p">,</span>
                    <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">,</span>
                    <span class="n">fields_list</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="s1">&#39;- </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">format_groups</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">f</span><span class="p">]))</span>
                        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">invalid_fields</span><span class="p">)</span>
                    <span class="p">),</span>
                <span class="p">))</span>

        <span class="k">return</span> <span class="n">field_names</span></div>


<div class="viewcode-block" id="BaseModel.read">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.read">[docs]</a>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="s1">&#39;_classic_read&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; read([fields])</span>

<span class="sd">        Read the requested fields for the records in ``self``, and return their</span>
<span class="sd">        values as a list of dicts.</span>

<span class="sd">        :param list fields: field names to return (default is all fields)</span>
<span class="sd">        :param str load: loading mode, currently the only option is to set to</span>
<span class="sd">            ``None`` to avoid loading the `display_name` of m2o fields</span>
<span class="sd">        :return: a list of dictionaries mapping field names to their values,</span>
<span class="sd">                 with one dictionary per record</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        :raise AccessError: if user is not allowed to access requested information</span>
<span class="sd">        :raise ValueError: if a requested field does not exist</span>

<span class="sd">        This is a high-level method that is not supposed to be overridden. In</span>
<span class="sd">        order to modify how fields are read from database, see methods</span>
<span class="sd">        :meth:`_fetch_query` and :meth:`_read_format`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_field_access_rights</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_origin</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_format</span><span class="p">(</span><span class="n">fnames</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="n">load</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseModel.update_field_translations">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.update_field_translations">[docs]</a>
    <span class="k">def</span> <span class="nf">update_field_translations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">translations</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Update the values of a translated field.</span>

<span class="sd">        :param str field_name: field name</span>
<span class="sd">        :param dict translations: if the field has ``translate=True``, it should be a dictionary</span>
<span class="sd">            like ``{lang: new_value}``; if ``translate`` is a callable, it should be like</span>
<span class="sd">            ``{lang: {old_term: new_term}}``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_field_translations</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">translations</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_update_field_translations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">translations</span><span class="p">,</span> <span class="n">digest</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Private implementation of :meth:`~update_field_translations`.</span>
<span class="sd">        The main difference comes from the extra function ``digest``, which may</span>
<span class="sd">        be used to make identifiers for old terms.</span>

<span class="sd">        :param dict translations:</span>
<span class="sd">            if the field has ``translate=True``, it should be a dictionary like ``{lang: new_value}``</span>
<span class="sd">                new_value: str: the new translation for lang</span>
<span class="sd">                new_value: False: void the current translation for lang and fallback to current en_US value</span>
<span class="sd">            if ``translate`` is a callable, it should be like</span>
<span class="sd">            ``{lang: {old_term: new_term}}``, or ``{lang: {digest(old_term): new_term}}`` when ``digest`` is callable</span>
<span class="sd">                new_value: str: the new translation of old_term for lang</span>
<span class="sd">        :param digest: an optional digest function for the old_term</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;write&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_field_access_rights</span><span class="p">(</span><span class="s1">&#39;write&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">field_name</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rule</span><span class="p">(</span><span class="s1">&#39;write&#39;</span><span class="p">)</span>

        <span class="n">valid_langs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">code</span> <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.lang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_installed</span><span class="p">())</span> <span class="o">|</span> <span class="p">{</span><span class="s1">&#39;en_US&#39;</span><span class="p">}</span>
        <span class="n">missing_langs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">translations</span><span class="p">)</span> <span class="o">-</span> <span class="n">valid_langs</span>
        <span class="k">if</span> <span class="n">missing_langs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;The following languages are not activated: </span><span class="si">%(missing_names)s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">missing_names</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_langs</span><span class="p">))</span>
            <span class="p">)</span>

        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># or raise error</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">related</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">compute</span><span class="p">:</span>
            <span class="c1"># a non-related non-stored computed field cannot be translated, even if it has inverse function</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Strictly speaking, a translated related/computed field cannot be stored</span>
        <span class="c1"># because the compute function only support one language</span>
        <span class="c1"># `not field.store` is a redundant logic.</span>
        <span class="c1"># But some developers store translated related fields.</span>
        <span class="c1"># In these cases, only all translations of the first stored translation field will be updated</span>
        <span class="c1"># For other stored related translated field, the translation for the flush language will be updated</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">related</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
            <span class="n">related_path</span><span class="p">,</span> <span class="n">field_name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="n">related_path</span><span class="p">)</span><span class="o">.</span><span class="n">_update_field_translations</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">translations</span><span class="p">,</span> <span class="n">digest</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># falsy values (except emtpy str) are used to void the corresponding translation</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">translation</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">translation</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">translation</span> <span class="ow">in</span> <span class="n">translations</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Translations for model translated fields only accept falsy values and str&quot;</span><span class="p">))</span>
            <span class="n">value_en</span> <span class="o">=</span> <span class="n">translations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;en_US&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value_en</span> <span class="ow">and</span> <span class="n">value_en</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">translations</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;en_US&#39;</span><span class="p">)</span>
            <span class="n">translations</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">lang</span><span class="p">:</span> <span class="n">translation</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">translation</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">lang</span><span class="p">,</span> <span class="n">translation</span> <span class="ow">in</span> <span class="n">translations</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">translations</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">translation_fallback</span> <span class="o">=</span> <span class="n">translations</span><span class="p">[</span><span class="s1">&#39;en_US&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">translations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;en_US&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
                <span class="k">else</span> <span class="n">translations</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span><span class="p">]</span> <span class="k">if</span> <span class="n">translations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
                <span class="k">else</span> <span class="nb">next</span><span class="p">((</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">translations</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">invalidate_recordset</span><span class="p">([</span><span class="n">field_name</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot; UPDATE %(table)s</span>
<span class="sd">                    SET %(field)s = NULLIF(</span>
<span class="sd">                        jsonb_strip_nulls(%(fallback)s || COALESCE(%(field)s, &#39;{}&#39;::jsonb) || %(value)s),</span>
<span class="sd">                        &#39;{}&#39;::jsonb)</span>
<span class="sd">                    WHERE id = %(id)s</span>
<span class="sd">                &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="n">table</span><span class="o">=</span><span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">),</span>
                <span class="n">field</span><span class="o">=</span><span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">field_name</span><span class="p">),</span>
                <span class="n">fallback</span><span class="o">=</span><span class="n">Json</span><span class="p">({</span><span class="s1">&#39;en_US&#39;</span><span class="p">:</span> <span class="n">translation_fallback</span><span class="p">}),</span>
                <span class="n">value</span><span class="o">=</span><span class="n">Json</span><span class="p">(</span><span class="n">translations</span><span class="p">),</span>
                <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modified</span><span class="p">([</span><span class="n">field_name</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Note:</span>
            <span class="c1"># update terms in &#39;en_US&#39; will not change its value other translated values</span>
            <span class="c1"># record_en = Model_en.create({&#39;html&#39;: &#39;&lt;div&gt;English 1&lt;/div&gt;&lt;div&gt;English 2&lt;div/&gt;&#39;</span>
            <span class="c1"># record_en.update_field_translations(&#39;html&#39;, {&#39;fr_FR&#39;: {&#39;English 2&#39;: &#39;French 2&#39;}}</span>
            <span class="c1"># record_en.update_field_translations(&#39;html&#39;, {&#39;en_US&#39;: {&#39;English 1&#39;: &#39;English 3&#39;}}</span>
            <span class="c1"># assert record_en                            == &#39;&lt;div&gt;English 3&lt;/div&gt;&lt;div&gt;English 2&lt;div/&gt;&#39;</span>
            <span class="c1"># assert record_fr.with_context(lang=&#39;fr_FR&#39;) == &#39;&lt;div&gt;English 1&lt;/div&gt;&lt;div&gt;French 2&lt;div/&gt;&#39;</span>
            <span class="c1"># assert record_nl.with_context(lang=&#39;nl_NL&#39;) == &#39;&lt;div&gt;English 3&lt;/div&gt;&lt;div&gt;English 2&lt;div/&gt;&#39;</span>

            <span class="n">stored_translations</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">_get_stored_translations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">stored_translations</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">old_translations</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">stored_translations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">stored_translations</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">lang</span><span class="p">,</span> <span class="n">translation</span> <span class="ow">in</span> <span class="n">translations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">old_value</span> <span class="o">=</span> <span class="n">old_translations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span> <span class="ow">or</span> <span class="n">old_translations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;en_US&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">digest</span><span class="p">:</span>
                    <span class="n">old_terms</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_trans_terms</span><span class="p">(</span><span class="n">old_value</span><span class="p">)</span>
                    <span class="n">old_terms_digested2value</span> <span class="o">=</span> <span class="p">{</span><span class="n">digest</span><span class="p">(</span><span class="n">old_term</span><span class="p">):</span> <span class="n">old_term</span> <span class="k">for</span> <span class="n">old_term</span> <span class="ow">in</span> <span class="n">old_terms</span><span class="p">}</span>
                    <span class="n">translation</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">old_terms_digested2value</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span> <span class="n">value</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">translation</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">old_terms_digested2value</span>
                    <span class="p">}</span>
                <span class="n">stored_translations</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">translation</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">old_value</span><span class="p">)</span>
                <span class="n">stored_translations</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">update_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="p">[</span><span class="n">stored_translations</span><span class="p">],</span> <span class="n">dirty</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># the following write is incharge of</span>
        <span class="c1"># 1. mark field as modified</span>
        <span class="c1"># 2. execute logics in the override `write` method</span>
        <span class="c1"># 3. update write_date of the record if exists to support &#39;t-cache&#39;</span>
        <span class="c1"># even if the value in cache is the same as the value written</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="BaseModel.get_field_translations">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.get_field_translations">[docs]</a>
    <span class="k">def</span> <span class="nf">get_field_translations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">langs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; get model/model_term translations for records</span>
<span class="sd">        :param str field_name: field name</span>
<span class="sd">        :param list langs: languages</span>

<span class="sd">        :return: (translations, context) where</span>
<span class="sd">            translations: list of dicts like [{&quot;lang&quot;: lang, &quot;source&quot;: source_term, &quot;value&quot;: value_term}]</span>
<span class="sd">            context: {&quot;translation_type&quot;: &quot;text&quot;/&quot;char&quot;, &quot;translation_show_source&quot;: True/False}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
        <span class="c1"># We don&#39;t forbid reading inactive/non-existing languages,</span>
        <span class="n">langs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">langs</span> <span class="ow">or</span> <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.lang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_installed</span><span class="p">()])</span>
        <span class="n">self_lang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">check_translations</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prefetch_langs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">val_en</span> <span class="o">=</span> <span class="n">self_lang</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="s1">&#39;en_US&#39;</span><span class="p">)[</span><span class="n">field_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">):</span>
            <span class="n">translations</span> <span class="o">=</span> <span class="p">[{</span>
                <span class="s1">&#39;lang&#39;</span><span class="p">:</span> <span class="n">lang</span><span class="p">,</span>
                <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">val_en</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">self_lang</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="n">lang</span><span class="p">)[</span><span class="n">field_name</span><span class="p">]</span>
            <span class="p">}</span> <span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">langs</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">translation_dictionary</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_translation_dictionary</span><span class="p">(</span>
                <span class="n">val_en</span><span class="p">,</span> <span class="p">{</span><span class="n">lang</span><span class="p">:</span> <span class="n">self_lang</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="n">lang</span><span class="p">)[</span><span class="n">field_name</span><span class="p">]</span> <span class="k">for</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">langs</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="n">translations</span> <span class="o">=</span> <span class="p">[{</span>
                <span class="s1">&#39;lang&#39;</span><span class="p">:</span> <span class="n">lang</span><span class="p">,</span>
                <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">term_en</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">term_lang</span> <span class="k">if</span> <span class="n">term_lang</span> <span class="o">!=</span> <span class="n">term_en</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="p">}</span> <span class="k">for</span> <span class="n">term_en</span><span class="p">,</span> <span class="n">translations</span> <span class="ow">in</span> <span class="n">translation_dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">lang</span><span class="p">,</span> <span class="n">term_lang</span> <span class="ow">in</span> <span class="n">translations</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;translation_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;text&#39;</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;char&#39;</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;translation_show_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">callable</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">translations</span><span class="p">,</span> <span class="n">context</span></div>


    <span class="k">def</span> <span class="nf">_get_base_lang</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Returns the base language of the record. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="k">return</span> <span class="s1">&#39;en_US&#39;</span>

    <span class="k">def</span> <span class="nf">_read_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnames</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="s1">&#39;_classic_read&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a list of dictionaries mapping field names to their values,</span>
<span class="sd">        with one dictionary per record that exists.</span>

<span class="sd">        The output format is the one expected from the `read` method, which uses</span>
<span class="sd">        this method as its implementation for formatting values.</span>

<span class="sd">        For the properties fields, call convert_to_read_multi instead of convert_to_read</span>
<span class="sd">        to prepare everything (record existences, display name, etc) in batch.</span>

<span class="sd">        The current method is different from `read` because it retrieves its</span>
<span class="sd">        values from the cache without doing a query when it is avoidable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">record</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">})</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
        <span class="n">use_display_name</span> <span class="o">=</span> <span class="p">(</span><span class="n">load</span> <span class="o">==</span> <span class="s1">&#39;_classic_read&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;properties&#39;</span><span class="p">:</span>
                <span class="n">values_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">record</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">values_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
                        <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">MissingError</span><span class="p">:</span>
                        <span class="n">vals</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

                <span class="n">results</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_read_multi</span><span class="p">(</span><span class="n">values_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">records</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">record_read_vals</span><span class="p">,</span> <span class="n">convert_result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
                    <span class="n">record_read_vals</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_result</span>
                <span class="k">continue</span>

            <span class="n">convert</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_read</span>
            <span class="k">for</span> <span class="n">record</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="c1"># missing records have their vals empty</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">vals</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">vals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">record</span><span class="p">,</span> <span class="n">use_display_name</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">MissingError</span><span class="p">:</span>
                    <span class="n">vals</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">vals</span> <span class="k">for</span> <span class="n">record</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">vals</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_fetch_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Read from the database in order to fetch ``field`` (:class:`Field`</span>
<span class="sd">            instance) for ``self`` in cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_field_access_rights</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
        <span class="c1"># determine which fields can be prefetched</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prefetch_fields&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">prefetch</span><span class="p">:</span>
            <span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">name</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="c1"># select fields with the same prefetch group</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">prefetch</span> <span class="o">==</span> <span class="n">field</span><span class="o">.</span><span class="n">prefetch</span>
                <span class="c1"># discard fields with groups that the user may not access</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">groups</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_has_groups</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">groups</span><span class="p">))</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
                <span class="n">fnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span>

<div class="viewcode-block" id="BaseModel.fetch">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.fetch">[docs]</a>
    <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Make sure the given fields are in memory for the records in ``self``,</span>
<span class="sd">        by fetching what is necessary from the database.  Non-stored fields are</span>
<span class="sd">        mostly ignored, except for their stored dependencies. This method should</span>
<span class="sd">        be called to optimize code.</span>

<span class="sd">        :param field_names: a collection of field names to fetch</span>
<span class="sd">        :raise AccessError: if user is not allowed to access requested information</span>

<span class="sd">        This method is implemented thanks to methods :meth:`_search` and</span>
<span class="sd">        :meth:`_fetch_query`, and should not be overridden.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">field_names</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">fields_to_fetch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_fields_to_fetch</span><span class="p">(</span><span class="n">field_names</span><span class="p">,</span> <span class="n">ignore_when_in_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fields_to_fetch</span><span class="p">:</span>
            <span class="c1"># there is nothing to fetch, but we expect an error anyway in case</span>
            <span class="c1"># self is not accessible</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rule</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">MissingError</span><span class="p">:</span>
                <span class="c1"># Method fetch() should never raise a MissingError, but method</span>
                <span class="c1"># check_access_rule() can, because it must read fields on self.</span>
                <span class="c1"># So we restrict &#39;self&#39; to existing records (to avoid an extra</span>
                <span class="c1"># exists() at the end of the method).</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span><span class="o">.</span><span class="n">check_access_rule</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># first determine a query that satisfies the domain and access rules</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">column_type</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields_to_fetch</span><span class="p">):</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">_search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rule</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">MissingError</span><span class="p">:</span>
                <span class="c1"># Method fetch() should never raise a MissingError, but method</span>
                <span class="c1"># check_access_rule() can, because it must read fields on self.</span>
                <span class="c1"># So we restrict &#39;self&#39; to existing records (to avoid an extra</span>
                <span class="c1"># exists() at the end of the method).</span>
                <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rule</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_as_query</span><span class="p">(</span><span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># fetch the fields</span>
        <span class="n">fetched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">fields_to_fetch</span><span class="p">)</span>

        <span class="c1"># possibly raise exception for the records that could not be read</span>
        <span class="k">if</span> <span class="n">fetched</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">forbidden</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span> <span class="o">-</span> <span class="n">fetched</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">forbidden</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.rule&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_make_access_error</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="n">forbidden</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_determine_fields_to_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">ignore_when_in_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Field&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the fields to fetch from database among the given field names,</span>
<span class="sd">        and following the dependencies of computed fields. The method is used</span>
<span class="sd">        by :meth:`fetch` and :meth:`search_fetch`.</span>

<span class="sd">        :param field_names: the list of fields requested</span>
<span class="sd">        :param ignore_when_in_cache: whether to ignore fields that are alreay in cache for ``self``</span>
<span class="sd">        :return: the list of fields that must be fetched</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field_names</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span>

        <span class="n">fields_to_fetch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">field_names_todo</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_field_access_rights</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="n">field_names</span><span class="p">))</span>
        <span class="n">field_names_done</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">}</span>  <span class="c1"># trick: ignore &#39;id&#39;</span>

        <span class="k">while</span> <span class="n">field_names_todo</span><span class="p">:</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="n">field_names_todo</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">field_names_done</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">field_names_done</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid field </span><span class="si">{</span><span class="n">field_name</span><span class="si">!r}</span><span class="s2"> on model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ignore_when_in_cache</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">get_missing_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">)):</span>
                <span class="c1"># field is already in cache: don&#39;t fetch it</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
                <span class="n">fields_to_fetch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># optimization: fetch field dependencies</span>
                <span class="k">for</span> <span class="n">dotname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">field_depends</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                    <span class="n">dep_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">dotname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">dep_field</span><span class="o">.</span><span class="n">store</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dep_field</span><span class="o">.</span><span class="n">prefetch</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="ow">not</span> <span class="n">dep_field</span><span class="o">.</span><span class="n">groups</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_has_groups</span><span class="p">(</span><span class="n">dep_field</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span>
                    <span class="p">)):</span>
                        <span class="n">field_names_todo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dep_field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fields_to_fetch</span>

    <span class="k">def</span> <span class="nf">_fetch_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Fetch the given fields (iterable of :class:`Field` instances) from</span>
<span class="sd">        the given query, put them in cache, and return the fetched records.</span>

<span class="sd">        This method may be overridden to change what fields to actually fetch,</span>
<span class="sd">        or to change the values that are put in cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># determine columns fields and those with their own read() method</span>
        <span class="n">column_fields</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">()</span>
        <span class="n">other_fields</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">assert</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span>
            <span class="p">(</span><span class="n">column_fields</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">column_type</span> <span class="k">else</span> <span class="n">other_fields</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="c1"># necessary to retrieve the en_US value of fields without a translation</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span>
        <span class="n">field_names_to_flush</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">column_fields</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;binary&#39;</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bin_size&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bin_size_&#39;</span> <span class="o">+</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">field_names_to_flush</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush_model</span><span class="p">(</span><span class="n">field_names_to_flush</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">column_fields</span><span class="p">:</span>
            <span class="c1"># the query may involve several tables: we need fully-qualified names</span>
            <span class="n">sql_terms</span> <span class="o">=</span> <span class="p">[</span><span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">column_fields</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_to_sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;binary&#39;</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bin_size&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bin_size_&#39;</span> <span class="o">+</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)):</span>
                    <span class="c1"># PG 9.2 introduces conflicting pg_size_pretty(numeric) -&gt; need ::cast</span>
                    <span class="n">sql</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;pg_size_pretty(length(</span><span class="si">%s</span><span class="s2">)::bigint)&quot;</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span>
                <span class="n">sql_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

            <span class="c1"># select the given columns from the rows in the query</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">*</span><span class="n">sql_terms</span><span class="p">))</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">()</span>

            <span class="c1"># rows = [(id1, a1, b1), (id2, a2, b2), ...]</span>
            <span class="c1"># column_values = [(id1, id2, ...), (a1, a2, ...), (b1, b2, ...)]</span>
            <span class="n">column_values</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">rows</span><span class="p">)</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">column_values</span><span class="p">)</span>
            <span class="n">fetched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>

            <span class="c1"># If we assume that the value of a pending update is in cache, we</span>
            <span class="c1"># can avoid flushing pending updates if the fetched values do not</span>
            <span class="c1"># overwrite values in cache.</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">column_fields</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">column_values</span><span class="p">)</span>
                <span class="c1"># store values in cache, but without overwriting</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">insert_missing</span><span class="p">(</span><span class="n">fetched</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">fetched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="c1"># process non-column fields</span>
        <span class="k">if</span> <span class="n">fetched</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">other_fields</span><span class="p">:</span>
                <span class="n">field</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fetched</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fetched</span>

<div class="viewcode-block" id="BaseModel.get_metadata">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.get_metadata">[docs]</a>
    <span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return some metadata about the given records.</span>

<span class="sd">        :return: list of ownership dictionaries for each requested record</span>
<span class="sd">        :rtype: list of dictionaries with the following keys:</span>

<span class="sd">            * id: object id</span>
<span class="sd">            * create_uid: user who created the record</span>
<span class="sd">            * create_date: date when the record was created</span>
<span class="sd">            * write_uid: last user who changed the record</span>
<span class="sd">            * write_date: date of the last change to the record</span>
<span class="sd">            * xmlid: XML ID to use to refer to this record (if there is one), in format ``module.name``</span>
<span class="sd">            * xmlids: list of dict with xmlid in format ``module.name``, and noupdate as boolean</span>
<span class="sd">            * noupdate: A boolean telling if the record will be updated or not</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">IrModelData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">LOG_ACCESS_COLUMNS</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">]</span>


        <span class="n">xml_data</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">imds</span> <span class="o">=</span> <span class="n">IrModelData</span><span class="o">.</span><span class="n">search_read</span><span class="p">(</span>
            <span class="p">[(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)],</span>
            <span class="p">[</span><span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="s1">&#39;noupdate&#39;</span><span class="p">,</span> <span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">],</span>
            <span class="n">order</span><span class="o">=</span><span class="s1">&#39;id DESC&#39;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">imd</span> <span class="ow">in</span> <span class="n">imds</span><span class="p">:</span>
            <span class="n">xml_data</span><span class="p">[</span><span class="n">imd</span><span class="p">[</span><span class="s1">&#39;res_id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;xmlid&#39;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imd</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">],</span> <span class="n">imd</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]),</span>
                <span class="s1">&#39;noupdate&#39;</span><span class="p">:</span> <span class="n">imd</span><span class="p">[</span><span class="s1">&#39;noupdate&#39;</span><span class="p">],</span>
            <span class="p">})</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="n">main</span> <span class="o">=</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="p">[{}])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">r</span><span class="p">[</span><span class="s1">&#39;xmlid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xmlid&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">r</span><span class="p">[</span><span class="s1">&#39;noupdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;noupdate&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">r</span><span class="p">[</span><span class="s1">&#39;xmlids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xml_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="p">[])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="BaseModel.get_base_url">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.get_base_url">[docs]</a>
    <span class="k">def</span> <span class="nf">get_base_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return rooturl for a specific record.</span>

<span class="sd">        By default, it returns the ir.config.parameter of base_url</span>
<span class="sd">        but it can be overridden by model.</span>

<span class="sd">        :return: the base url for this record</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected singleton or no record: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.config_parameter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;web.base.url&#39;</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_check_company_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">companies</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Domain to be used for company consistency between records regarding this model.</span>

<span class="sd">        :param companies: the allowed companies for the related record</span>
<span class="sd">        :type companies: BaseModel or list or tuple or int or unquote</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">companies</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[(</span><span class="s1">&#39;company_id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;company_id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;company_id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">to_company_ids</span><span class="p">(</span><span class="n">companies</span><span class="p">))]</span>

    <span class="k">def</span> <span class="nf">_check_company</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Check the companies of the values of the given field names.</span>

<span class="sd">        :param list fnames: names of relational fields to check</span>
<span class="sd">        :raises UserError: if the `company_id` of the value of any field is not</span>
<span class="sd">            in `[False, self.company_id]` (or `self` if</span>
<span class="sd">            :class:`~odoo.addons.base.models.res_company`).</span>

<span class="sd">        For :class:`~odoo.addons.base.models.res_users` relational fields,</span>
<span class="sd">        verifies record company is in `company_ids` fields.</span>

<span class="sd">        User with main company A, having access to company A and B, could be</span>
<span class="sd">        assigned or linked to records in company B.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fnames</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="s1">&#39;company_id&#39;</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
            <span class="n">fnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span>

        <span class="n">regular_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">property_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">relational</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">check_company</span> <span class="ow">and</span> \
                    <span class="s1">&#39;company_id&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">company_dependent</span><span class="p">:</span>
                    <span class="n">regular_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">property_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">regular_fields</span> <span class="ow">or</span> <span class="n">property_fields</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">inconsistencies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">company</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">company_id</span> <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">_name</span> <span class="o">!=</span> <span class="s1">&#39;res.company&#39;</span> <span class="k">else</span> <span class="n">record</span>
            <span class="c1"># The first part of the check verifies that all records linked via relation fields are compatible</span>
            <span class="c1"># with the company of the origin document, i.e. `self.account_id.company_id == self.company_id`</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">regular_fields</span><span class="p">:</span>
                <span class="n">corecord</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">sudo</span><span class="p">()[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">corecord</span><span class="p">:</span>
                    <span class="n">domain</span> <span class="o">=</span> <span class="n">corecord</span><span class="o">.</span><span class="n">_check_company_domain</span><span class="p">(</span><span class="n">company</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">domain</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">corecord</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">(</span><span class="n">domain</span><span class="p">):</span>
                        <span class="n">inconsistencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">record</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">corecord</span><span class="p">))</span>
            <span class="c1"># The second part of the check (for property / company-dependent fields) verifies that the records</span>
            <span class="c1"># linked via those relation fields are compatible with the company that owns the property value, i.e.</span>
            <span class="c1"># the company for which the value is being assigned, i.e:</span>
            <span class="c1">#      `self.property_account_payable_id.company_id == self.env.company</span>
            <span class="n">company</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">property_fields</span><span class="p">:</span>
                <span class="n">corecord</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">sudo</span><span class="p">()[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">corecord</span><span class="p">:</span>
                    <span class="n">domain</span> <span class="o">=</span> <span class="n">corecord</span><span class="o">.</span><span class="n">_check_company_domain</span><span class="p">(</span><span class="n">company</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">domain</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">corecord</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">(</span><span class="n">domain</span><span class="p">):</span>
                        <span class="n">inconsistencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">record</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">corecord</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">inconsistencies</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Incompatible companies on records:&quot;</span><span class="p">)]</span>
            <span class="n">company_msg</span> <span class="o">=</span> <span class="n">_lt</span><span class="p">(</span><span class="s2">&quot;- Record is company </span><span class="si">%(company)r</span><span class="s2"> and </span><span class="si">%(field)r</span><span class="s2"> (</span><span class="si">%(fname)s</span><span class="s2">: </span><span class="si">%(values)s</span><span class="s2">) belongs to another company.&quot;</span><span class="p">)</span>
            <span class="n">record_msg</span> <span class="o">=</span> <span class="n">_lt</span><span class="p">(</span><span class="s2">&quot;- </span><span class="si">%(record)r</span><span class="s2"> belongs to company </span><span class="si">%(company)r</span><span class="s2"> and </span><span class="si">%(field)r</span><span class="s2"> (</span><span class="si">%(fname)s</span><span class="s2">: </span><span class="si">%(values)s</span><span class="s2">) belongs to another company.&quot;</span><span class="p">)</span>
            <span class="n">root_company_msg</span> <span class="o">=</span> <span class="n">_lt</span><span class="p">(</span><span class="s2">&quot;- Only a root company can be set on </span><span class="si">%(record)r</span><span class="s2">. Currently set to </span><span class="si">%(company)r</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">record</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">corecords</span> <span class="ow">in</span> <span class="n">inconsistencies</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="s1">&#39;res.company&#39;</span><span class="p">:</span>
                    <span class="n">msg</span><span class="p">,</span> <span class="n">company</span> <span class="o">=</span> <span class="n">company_msg</span><span class="p">,</span> <span class="n">record</span>
                <span class="k">elif</span> <span class="n">record</span> <span class="o">==</span> <span class="n">corecords</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;company_id&#39;</span><span class="p">:</span>
                    <span class="n">msg</span><span class="p">,</span> <span class="n">company</span> <span class="o">=</span> <span class="n">root_company_msg</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">company_id</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span><span class="p">,</span> <span class="n">company</span> <span class="o">=</span> <span class="n">record_msg</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">company_id</span>
                <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">%</span> <span class="p">{</span>
                    <span class="s1">&#39;record&#39;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span>
                    <span class="s1">&#39;company&#39;</span><span class="p">:</span> <span class="n">company</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span>
                    <span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">field_description</span><span class="p">,</span>
                    <span class="s1">&#39;fname&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">display_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">corecords</span><span class="p">),</span>
                <span class="p">})</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>

<div class="viewcode-block" id="BaseModel.check_access_rights">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.check_access_rights">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">check_access_rights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Verify that the given operation is allowed for the current user accord to ir.model.access.</span>

<span class="sd">        :param str operation: one of ``create``, ``read``, ``write``, ``unlink``</span>
<span class="sd">        :param bool raise_exception: whether an exception should be raise if operation is forbidden</span>
<span class="sd">        :return: whether the operation is allowed</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        :raise AccessError: if the operation is forbidden and raise_exception is True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.access&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">raise_exception</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseModel.check_access_rule">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.check_access_rule">[docs]</a>
    <span class="k">def</span> <span class="nf">check_access_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Verify that the given operation is allowed for the current user according to ir.rules.</span>

<span class="sd">        :param str operation: one of ``create``, ``read``, ``write``, ``unlink``</span>
<span class="sd">        :return: None if the operation is allowed</span>
<span class="sd">        :raise UserError: if current ``ir.rules`` do not permit this operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">su</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># SQL Alternative if computing in-memory is too slow for large dataset</span>
        <span class="c1"># invalid = self - self._filter_access_rules(operation)</span>
        <span class="n">invalid</span> <span class="o">=</span> <span class="bp">self</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_access_rules_python</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">invalid</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">forbidden</span> <span class="o">=</span> <span class="n">invalid</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">forbidden</span><span class="p">:</span>
            <span class="c1"># the invalid records are (partially) hidden by access rules</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.rule&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_make_access_error</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">forbidden</span><span class="p">)</span>

        <span class="c1"># If we get here, the invalid records are not in the database.</span>
        <span class="k">if</span> <span class="n">operation</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;unlink&#39;</span><span class="p">):</span>
            <span class="c1"># No need to warn about deleting an already deleted record.</span>
            <span class="c1"># And no error when reading a record that was deleted, to prevent spurious</span>
            <span class="c1"># errors for non-transactional search/read sequences coming from clients.</span>
            <span class="k">return</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Failed operation on deleted record(s): </span><span class="si">%s</span><span class="s1">, uid: </span><span class="si">%s</span><span class="s1">, model: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">MissingError</span><span class="p">(</span>
            <span class="n">_</span><span class="p">(</span><span class="s1">&#39;One of the documents you are trying to access has been deleted, please try again after refreshing.&#39;</span><span class="p">)</span>
            <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">(</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Document type:&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Operation:&#39;</span><span class="p">),</span> <span class="n">operation</span><span class="p">,</span>
                <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Records:&#39;</span><span class="p">),</span> <span class="n">invalid</span><span class="o">.</span><span class="n">ids</span><span class="p">[:</span><span class="mi">6</span><span class="p">],</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;User:&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_filter_access_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the subset of ``self`` for which ``operation`` is allowed. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">su</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_ir_rules</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="o">.</span><span class="n">where_clause</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># determine ids in database that satisfy ir.rules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flush_search</span><span class="p">([])</span>
        <span class="n">query</span><span class="o">.</span><span class="n">add_where</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> IN </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">select</span><span class="p">())</span>
        <span class="n">valid_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()}</span>

        <span class="c1"># return new ids without origin and ids with origin in valid_ids</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">([</span>
            <span class="n">it</span>
            <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">it</span> <span class="ow">or</span> <span class="n">it</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">it</span> <span class="ow">or</span> <span class="n">it</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span> <span class="ow">in</span> <span class="n">valid_ids</span>
        <span class="p">])</span>

    <span class="k">def</span> <span class="nf">_filter_access_rules_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">):</span>
        <span class="n">dom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.rule&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_compute_domain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">(</span><span class="n">dom</span> <span class="ow">or</span> <span class="p">[])</span>

<div class="viewcode-block" id="BaseModel.unlink">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.unlink">[docs]</a>
    <span class="k">def</span> <span class="nf">unlink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; unlink()</span>

<span class="sd">        Deletes the records in ``self``.</span>

<span class="sd">        :raise AccessError: if the user is not allowed to delete all the given records</span>
<span class="sd">        :raise UserError: if the record is default property for other records</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;unlink&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rule</span><span class="p">(</span><span class="s1">&#39;unlink&#39;</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">odoo.addons.base.models.ir_model</span> <span class="kn">import</span> <span class="n">MODULE_UNINSTALL_FLAG</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ondelete_methods</span><span class="p">:</span>
            <span class="c1"># func._ondelete is True if it should be called during uninstallation</span>
            <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="n">_ondelete</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">MODULE_UNINSTALL_FLAG</span><span class="p">):</span>
                <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># TOFIX: this avoids an infinite loop when trying to recompute a</span>
        <span class="c1"># field, which triggers the recomputation of another field using the</span>
        <span class="c1"># same compute function, which then triggers again the computation</span>
        <span class="c1"># of those two fields</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">remove_to_compute</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>

        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span>
        <span class="n">Data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">with_context</span><span class="p">({})</span>
        <span class="n">Defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.default&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span>
        <span class="n">Property</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.property&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span>
        <span class="n">Attachment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.attachment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span>
        <span class="n">ir_property_unlink</span> <span class="o">=</span> <span class="n">Property</span>
        <span class="n">ir_model_data_unlink</span> <span class="o">=</span> <span class="n">Data</span>
        <span class="n">ir_attachment_unlink</span> <span class="o">=</span> <span class="n">Attachment</span>

        <span class="c1"># mark fields that depend on &#39;self&#39; to recompute them after &#39;self&#39; has</span>
        <span class="c1"># been deleted (like updating a sum of lines after deleting one line)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">protecting</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modified</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">sub_ids</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">split_for_in_conditions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">):</span>
            <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">sub_ids</span><span class="p">)</span>

            <span class="c1"># Check if the records are used as default properties.</span>
            <span class="n">refs</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">id_</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">sub_ids</span><span class="p">]</span>
            <span class="n">default_properties</span> <span class="o">=</span> <span class="n">Property</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;value_reference&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">refs</span><span class="p">)])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">MODULE_UNINSTALL_FLAG</span><span class="p">)</span> <span class="ow">and</span> <span class="n">default_properties</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Unable to delete this document because it is used as a default property&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ir_property_unlink</span> <span class="o">|=</span> <span class="n">default_properties</span>

            <span class="c1"># Delete the records&#39; properties.</span>
            <span class="n">ir_property_unlink</span> <span class="o">|=</span> <span class="n">Property</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">refs</span><span class="p">)])</span>

            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span>
                <span class="s2">&quot;DELETE FROM </span><span class="si">%s</span><span class="s2"> WHERE id IN </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">),</span> <span class="n">sub_ids</span><span class="p">,</span>
            <span class="p">))</span>

            <span class="c1"># Removing the ir_model_data reference if the record being deleted</span>
            <span class="c1"># is a record created by xml/csv file, as these are not connected</span>
            <span class="c1"># with real database foreign keys, and would be dangling references.</span>
            <span class="c1">#</span>
            <span class="c1"># Note: the following steps are performed as superuser to avoid</span>
            <span class="c1"># access rights restrictions, and with no context to avoid possible</span>
            <span class="c1"># side-effects during admin calls.</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">Data</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">sub_ids</span><span class="p">)])</span>
            <span class="n">ir_model_data_unlink</span> <span class="o">|=</span> <span class="n">data</span>

            <span class="c1"># For the same reason, remove the defaults having some of the</span>
            <span class="c1"># records as value</span>
            <span class="n">Defaults</span><span class="o">.</span><span class="n">discard_records</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>

            <span class="c1"># For the same reason, remove the relevant records in ir_attachment</span>
            <span class="c1"># (the search is performed with sql as the search method of</span>
            <span class="c1"># ir_attachment is overridden to hide attachments of deleted</span>
            <span class="c1"># records)</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span>
                <span class="s2">&quot;SELECT id FROM ir_attachment WHERE res_model=</span><span class="si">%s</span><span class="s2"> AND res_id IN </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">sub_ids</span><span class="p">,</span>
            <span class="p">))</span>
            <span class="n">ir_attachment_unlink</span> <span class="o">|=</span> <span class="n">Attachment</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>

        <span class="c1"># invalidate the *whole* cache, since the orm does not handle all</span>
        <span class="c1"># changes made in the database, like cascading delete!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">(</span><span class="n">flush</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ir_property_unlink</span><span class="p">:</span>
            <span class="n">ir_property_unlink</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ir_model_data_unlink</span><span class="p">:</span>
            <span class="n">ir_model_data_unlink</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ir_attachment_unlink</span><span class="p">:</span>
            <span class="n">ir_attachment_unlink</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="c1"># auditing: deletions are infrequent and leave no trace in the database</span>
        <span class="n">_unlink</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;User #</span><span class="si">%s</span><span class="s1"> deleted </span><span class="si">%s</span><span class="s1"> records with IDs: </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="BaseModel.write">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; write(vals)</span>

<span class="sd">        Updates all records in ``self`` with the provided values.</span>

<span class="sd">        :param dict vals: fields to update and the value to set on them</span>
<span class="sd">        :raise AccessError: if user is not allowed to modify the specified records/fields</span>
<span class="sd">        :raise ValidationError: if invalid values are specified for selection fields</span>
<span class="sd">        :raise UserError: if a loop would be created in a hierarchy of objects a result of the operation (such as setting an object as its own parent)</span>

<span class="sd">        * For numeric fields (:class:`~odoo.fields.Integer`,</span>
<span class="sd">          :class:`~odoo.fields.Float`) the value should be of the</span>
<span class="sd">          corresponding type</span>
<span class="sd">        * For :class:`~odoo.fields.Boolean`, the value should be a</span>
<span class="sd">          :class:`python:bool`</span>
<span class="sd">        * For :class:`~odoo.fields.Selection`, the value should match the</span>
<span class="sd">          selection values (generally :class:`python:str`, sometimes</span>
<span class="sd">          :class:`python:int`)</span>
<span class="sd">        * For :class:`~odoo.fields.Many2one`, the value should be the</span>
<span class="sd">          database identifier of the record to set</span>
<span class="sd">        * The expected value of a :class:`~odoo.fields.One2many` or</span>
<span class="sd">          :class:`~odoo.fields.Many2many` relational field is a list of</span>
<span class="sd">          :class:`~odoo.fields.Command` that manipulate the relation the</span>
<span class="sd">          implement. There are a total of 7 commands:</span>
<span class="sd">          :meth:`~odoo.fields.Command.create`,</span>
<span class="sd">          :meth:`~odoo.fields.Command.update`,</span>
<span class="sd">          :meth:`~odoo.fields.Command.delete`,</span>
<span class="sd">          :meth:`~odoo.fields.Command.unlink`,</span>
<span class="sd">          :meth:`~odoo.fields.Command.link`,</span>
<span class="sd">          :meth:`~odoo.fields.Command.clear`, and</span>
<span class="sd">          :meth:`~odoo.fields.Command.set`.</span>
<span class="sd">        * For :class:`~odoo.fields.Date` and `~odoo.fields.Datetime`,</span>
<span class="sd">          the value should be either a date(time), or a string.</span>

<span class="sd">          .. warning::</span>

<span class="sd">            If a string is provided for Date(time) fields,</span>
<span class="sd">            it must be UTC-only and formatted according to</span>
<span class="sd">            :const:`odoo.tools.misc.DEFAULT_SERVER_DATE_FORMAT` and</span>
<span class="sd">            :const:`odoo.tools.misc.DEFAULT_SERVER_DATETIME_FORMAT`</span>

<span class="sd">        * Other non-relational fields use a string for value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;write&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_field_access_rights</span><span class="p">(</span><span class="s1">&#39;write&#39;</span><span class="p">,</span> <span class="n">vals</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rule</span><span class="p">(</span><span class="s1">&#39;write&#39;</span><span class="p">)</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span>

        <span class="n">bad_names</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_path&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span><span class="p">:</span>
            <span class="c1"># the superuser can set log_access fields while loading registry</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span> <span class="o">==</span> <span class="n">SUPERUSER_ID</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">ready</span><span class="p">):</span>
                <span class="n">bad_names</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">LOG_ACCESS_COLUMNS</span><span class="p">)</span>

        <span class="c1"># set magic fields</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bad_names</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span><span class="p">:</span>
            <span class="n">vals</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;write_uid&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
            <span class="n">vals</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;write_date&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

        <span class="n">field_values</span> <span class="o">=</span> <span class="p">[]</span>                           <span class="c1"># [(field, value)]</span>
        <span class="n">determine_inverses</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>      <span class="c1"># {inverse: fields}</span>
        <span class="n">fnames_modifying_relations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">protected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">check_company</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid field </span><span class="si">%r</span><span class="s2"> on model </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span>
            <span class="n">field_values</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">inverse</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;one2many&#39;</span><span class="p">,</span> <span class="s1">&#39;many2many&#39;</span><span class="p">):</span>
                    <span class="c1"># The written value is a list of commands that must applied</span>
                    <span class="c1"># on the field&#39;s current value. Because the field is</span>
                    <span class="c1"># protected while being written, the field&#39;s current value</span>
                    <span class="c1"># will not be computed and default to an empty recordset. So</span>
                    <span class="c1"># make sure the field&#39;s value is in cache before writing, in</span>
                    <span class="c1"># order to avoid an inconsistent update.</span>
                    <span class="bp">self</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span>
                <span class="n">determine_inverses</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">inverse</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">is_modifying_relations</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
                <span class="n">fnames_modifying_relations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">inverse</span> <span class="ow">or</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">compute</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">readonly</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">or</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;one2many&#39;</span><span class="p">,</span> <span class="s1">&#39;many2many&#39;</span><span class="p">):</span>
                    <span class="c1"># Protect the field from being recomputed while being</span>
                    <span class="c1"># inversed. In the case of non-stored x2many fields, the</span>
                    <span class="c1"># field&#39;s value may contain unexpeced new records (created</span>
                    <span class="c1"># by command 0). Those new records are necessary for</span>
                    <span class="c1"># inversing the field, but should no longer appear if the</span>
                    <span class="c1"># field is recomputed afterwards. Not protecting the field</span>
                    <span class="c1"># will automatically invalidate the field from the cache,</span>
                    <span class="c1"># forcing its value to be recomputed once dependencies are</span>
                    <span class="c1"># up-to-date.</span>
                    <span class="n">protected</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">field_computed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">[</span><span class="n">field</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">fname</span> <span class="o">==</span> <span class="s1">&#39;company_id&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">relational</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">check_company</span><span class="p">):</span>
                <span class="n">check_company</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># force the computation of fields that are computed with some assigned</span>
        <span class="c1"># fields, but are not assigned themselves</span>
        <span class="n">to_compute</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span>
                      <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">protected</span>
                      <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">compute</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">to_compute</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_recordset</span><span class="p">(</span><span class="n">to_compute</span><span class="p">)</span>

        <span class="c1"># protect fields being written against recomputation</span>
        <span class="k">with</span> <span class="n">env</span><span class="o">.</span><span class="n">protecting</span><span class="p">(</span><span class="n">protected</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
            <span class="c1"># Determine records depending on values. When modifying a relational</span>
            <span class="c1"># field, you have to recompute what depends on the field&#39;s values</span>
            <span class="c1"># before and after modification.  This is because the modification</span>
            <span class="c1"># has an impact on the &quot;data path&quot; between a computed field and its</span>
            <span class="c1"># dependency.  Note that this double call to modified() is only</span>
            <span class="c1"># necessary for relational fields.</span>
            <span class="c1">#</span>
            <span class="c1"># It is best explained with a simple example: consider two sales</span>
            <span class="c1"># orders SO1 and SO2.  The computed total amount on sales orders</span>
            <span class="c1"># indirectly depends on the many2one field &#39;order_id&#39; linking lines</span>
            <span class="c1"># to their sales order.  Now consider the following code:</span>
            <span class="c1">#</span>
            <span class="c1">#   line = so1.line_ids[0]      # pick a line from SO1</span>
            <span class="c1">#   line.order_id = so2         # move the line to SO2</span>
            <span class="c1">#</span>
            <span class="c1"># In this situation, the total amount must be recomputed on *both*</span>
            <span class="c1"># sales order: the line&#39;s order before the modification, and the</span>
            <span class="c1"># line&#39;s order after the modification.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modified</span><span class="p">(</span><span class="n">fnames_modifying_relations</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">real_recs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>

            <span class="c1"># field.write_sequence determines a priority for writing on fields.</span>
            <span class="c1"># Monetary fields need their corresponding currency field in cache</span>
            <span class="c1"># for rounding values. X2many fields must be written last, because</span>
            <span class="c1"># they flush other fields when deleting lines.</span>
            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">field_values</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">write_sequence</span><span class="p">):</span>
                <span class="n">field</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

            <span class="c1"># determine records depending on new values</span>
            <span class="c1">#</span>
            <span class="c1"># Call modified after write, because the modified can trigger a</span>
            <span class="c1"># search which can trigger a flush which can trigger a recompute</span>
            <span class="c1"># which remove the field from the recompute list while all the</span>
            <span class="c1"># values required for the computation could not be yet in cache.</span>
            <span class="c1"># e.g. Write on `name` of `res.partner` trigger the recompute of</span>
            <span class="c1"># `display_name`, which triggers a search on child_ids to find the</span>
            <span class="c1"># childs to which the display_name must be recomputed, which</span>
            <span class="c1"># triggers the flush of `display_name` because the _order of</span>
            <span class="c1"># res.partner includes display_name. The computation of display_name</span>
            <span class="c1"># is then done too soon because the parent_id was not yet written.</span>
            <span class="c1"># (`test_01_website_reset_password_tour`)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modified</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_store</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flush_model</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">])</span>

            <span class="c1"># validate non-inversed fields first</span>
            <span class="n">inverse_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">fs</span> <span class="ow">in</span> <span class="n">determine_inverses</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fs</span><span class="p">]</span>
            <span class="n">real_recs</span><span class="o">.</span><span class="n">_validate_fields</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">inverse_fields</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">fields</span> <span class="ow">in</span> <span class="n">determine_inverses</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="c1"># write again on non-stored fields that have been invalidated from cache</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get_missing_ids</span><span class="p">(</span><span class="n">real_recs</span><span class="p">,</span> <span class="n">field</span><span class="p">)):</span>
                        <span class="n">field</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">real_recs</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>

                <span class="c1"># inverse records that are not being computed</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">determine_inverse</span><span class="p">(</span><span class="n">real_recs</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">AccessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">inherited</span><span class="p">:</span>
                        <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
                        <span class="k">raise</span> <span class="n">AccessError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="si">%(previous_message)s</span><span class="se">\n\n</span><span class="s2">Implicitly accessed through &#39;</span><span class="si">%(document_kind)s</span><span class="s2">&#39; (</span><span class="si">%(document_model)s</span><span class="s2">).&quot;</span><span class="p">,</span>
                            <span class="n">previous_message</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">document_kind</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
                            <span class="n">document_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                        <span class="p">))</span>
                    <span class="k">raise</span>

            <span class="c1"># validate inversed fields</span>
            <span class="n">real_recs</span><span class="o">.</span><span class="n">_validate_fields</span><span class="p">(</span><span class="n">inverse_fields</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">check_company</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_company_auto</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_company</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span></div>


    <span class="k">def</span> <span class="nf">_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Low-level implementation of write()</span>

<span class="sd">        The ids of self should be a database id and unique.</span>
<span class="sd">        Ignore non-existent record.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span>

        <span class="c1"># determine records that require updating parent_path</span>
        <span class="n">parent_records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_store_update_prepare</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span><span class="p">:</span>
            <span class="c1"># set magic fields (already done by write(), but not for computed fields)</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
            <span class="n">vals</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;write_uid&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
            <span class="n">vals</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;write_date&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

        <span class="c1"># determine SQL assignments</span>
        <span class="n">assignments</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">LOG_ACCESS_COLUMNS</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">val</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span>
            <span class="k">assert</span> <span class="n">field</span><span class="o">.</span><span class="n">column_type</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">val</span><span class="p">:</span>
                <span class="c1"># The first param is for the fallback value {&#39;en_US&#39;: &#39;first_written_value&#39;}</span>
                <span class="c1"># which fills the &#39;en_US&#39; key of jsonb only when the old column value is NULL.</span>
                <span class="c1"># The second param is for the real value {&#39;fr_FR&#39;: &#39;French&#39;, &#39;nl_NL&#39;: &#39;Dutch&#39;}</span>
                <span class="n">assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%(field)s</span><span class="s2"> = </span><span class="si">%(fallback)s</span><span class="s2"> || COALESCE(</span><span class="si">%(field)s</span><span class="s2">, &#39;</span><span class="si">{}</span><span class="s2">&#39;::jsonb) || </span><span class="si">%(value)s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">field</span><span class="o">=</span><span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
                    <span class="n">fallback</span><span class="o">=</span><span class="n">Json</span><span class="p">({}</span> <span class="k">if</span> <span class="s1">&#39;en_US&#39;</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">adapted</span> <span class="k">else</span> <span class="p">{</span><span class="s1">&#39;en_US&#39;</span><span class="p">:</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">adapted</span><span class="o">.</span><span class="n">values</span><span class="p">()))}),</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">val</span><span class="p">,</span>
                <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">val</span><span class="p">))</span>

        <span class="c1"># update columns</span>
        <span class="k">if</span> <span class="n">assignments</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sub_ids</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">split_for_in_conditions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">):</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span>
                    <span class="s2">&quot;UPDATE </span><span class="si">%s</span><span class="s2"> SET </span><span class="si">%s</span><span class="s2"> WHERE id IN </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">),</span>
                    <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">assignments</span><span class="p">),</span>
                    <span class="n">sub_ids</span><span class="p">,</span>
                <span class="p">))</span>

        <span class="c1"># update parent_path</span>
        <span class="k">if</span> <span class="n">parent_records</span><span class="p">:</span>
            <span class="n">parent_records</span><span class="o">.</span><span class="n">_parent_store_update</span><span class="p">()</span>

<div class="viewcode-block" id="BaseModel.create">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.create">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model_create_multi</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; create(vals_list) -&gt; records</span>

<span class="sd">        Creates new records for the model.</span>

<span class="sd">        The new records are initialized using the values from the list of dicts</span>
<span class="sd">        ``vals_list``, and if necessary those from :meth:`~.default_get`.</span>

<span class="sd">        :param Union[list[dict], dict] vals_list:</span>
<span class="sd">            values for the model&#39;s fields, as a list of dictionaries::</span>

<span class="sd">                [{&#39;field_name&#39;: field_value, ...}, ...]</span>

<span class="sd">            For backward compatibility, ``vals_list`` may be a dictionary.</span>
<span class="sd">            It is treated as a singleton list ``[vals]``, and a single record</span>
<span class="sd">            is returned.</span>

<span class="sd">            see :meth:`~.write` for details</span>

<span class="sd">        :return: the created records</span>
<span class="sd">        :raise AccessError: if the current user is not allowed to create records of the specified model</span>
<span class="sd">        :raise ValidationError: if user tries to enter invalid value for a selection field</span>
<span class="sd">        :raise ValueError: if a field name specified in the create values does not exist.</span>
<span class="sd">        :raise UserError: if a loop would be created in a hierarchy of objects a result of the operation</span>
<span class="sd">          (such as setting an object as its own parent)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">vals_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">()</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">)</span>

        <span class="n">new_vals_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_create_values</span><span class="p">(</span><span class="n">vals_list</span><span class="p">)</span>

        <span class="c1"># classify fields for each record</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">determine_inverses</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>       <span class="c1"># {inverse: fields}</span>

        <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">new_vals_list</span><span class="p">:</span>
            <span class="n">precomputed</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__precomputed__&#39;</span><span class="p">,</span> <span class="p">())</span>

            <span class="c1"># distribute fields into sets for various purposes</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stored&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stored</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;inversed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inversed</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;inherited&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inherited</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;protected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">protected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid field </span><span class="si">%r</span><span class="s2"> on model </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">company_dependent</span><span class="p">:</span>
                    <span class="n">irprop_def</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.property&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                    <span class="n">cached_def</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_cache</span><span class="p">(</span><span class="n">irprop_def</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                    <span class="n">cached_val</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_cache</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cached_val</span> <span class="o">==</span> <span class="n">cached_def</span><span class="p">:</span>
                        <span class="c1"># val is the same as the default value defined in</span>
                        <span class="c1"># &#39;ir.property&#39;; by design, &#39;ir.property&#39; will not</span>
                        <span class="c1"># create entries specific to these records; skipping the</span>
                        <span class="c1"># field inverse saves 4 SQL queries</span>
                        <span class="k">continue</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
                    <span class="n">stored</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">inherited</span><span class="p">:</span>
                    <span class="n">inherited</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">related_field</span><span class="o">.</span><span class="n">model_name</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">inverse</span> <span class="ow">and</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">precomputed</span><span class="p">:</span>
                    <span class="n">inversed</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="n">determine_inverses</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">inverse</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                <span class="c1"># protect editable computed fields and precomputed fields</span>
                <span class="c1"># against (re)computation</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">compute</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">readonly</span> <span class="ow">or</span> <span class="n">field</span><span class="o">.</span><span class="n">precompute</span><span class="p">):</span>
                    <span class="n">protected</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">field_computed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">[</span><span class="n">field</span><span class="p">]))</span>

            <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># create or update parent records</span>
        <span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">parent_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">parent_data_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stored&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_name</span><span class="p">):</span>
                    <span class="n">parent_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;inherited&#39;</span><span class="p">][</span><span class="n">model_name</span><span class="p">]:</span>
                    <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;stored&#39;</span><span class="p">][</span><span class="n">parent_name</span><span class="p">])</span>
                    <span class="n">parent</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;inherited&#39;</span><span class="p">][</span><span class="n">model_name</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">parent_data_list</span><span class="p">:</span>
                <span class="n">parents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">([</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;inherited&#39;</span><span class="p">][</span><span class="n">model_name</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">parent_data_list</span>
                <span class="p">])</span>
                <span class="k">for</span> <span class="n">parent</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">parents</span><span class="p">,</span> <span class="n">parent_data_list</span><span class="p">):</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stored&#39;</span><span class="p">][</span><span class="n">parent_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">id</span>

        <span class="c1"># create records with stored fields</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span>

        <span class="c1"># protect fields being written against recomputation</span>
        <span class="n">protected</span> <span class="o">=</span> <span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;protected&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;record&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">protecting</span><span class="p">(</span><span class="n">protected</span><span class="p">):</span>
            <span class="c1"># call inverse method for each group of fields</span>
            <span class="k">for</span> <span class="n">fields</span> <span class="ow">in</span> <span class="n">determine_inverses</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="c1"># determine which records to inverse for those fields</span>
                <span class="n">inv_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">}</span>
                <span class="n">rec_vals</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;record&#39;</span><span class="p">],</span> <span class="p">{</span>
                        <span class="n">name</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;inversed&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">inv_names</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;inversed&#39;</span><span class="p">]</span>
                    <span class="p">})</span>
                    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">inv_names</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;inversed&#39;</span><span class="p">])</span>
                <span class="p">]</span>

                <span class="c1"># If a field is not stored, its inverse method will probably</span>
                <span class="c1"># write on its dependencies, which will invalidate the field on</span>
                <span class="c1"># all records. We therefore inverse the field record by record.</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">or</span> <span class="n">field</span><span class="o">.</span><span class="n">company_dependent</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">):</span>
                    <span class="n">batches</span> <span class="o">=</span> <span class="p">[</span><span class="n">rec_vals</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">batches</span> <span class="o">=</span> <span class="p">[[</span><span class="n">rec_data</span><span class="p">]</span> <span class="k">for</span> <span class="n">rec_data</span> <span class="ow">in</span> <span class="n">rec_vals</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">record</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
                        <span class="n">record</span><span class="o">.</span><span class="n">_update_cache</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
                    <span class="n">batch_recs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">record</span> <span class="k">for</span> <span class="n">record</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">))</span>
                    <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">fields</span><span class="p">))</span><span class="o">.</span><span class="n">determine_inverse</span><span class="p">(</span><span class="n">batch_recs</span><span class="p">)</span>

        <span class="c1"># check Python constraints for non-stored inversed fields</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;record&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_validate_fields</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;inversed&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stored&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_company_auto</span><span class="p">:</span>
            <span class="n">records</span><span class="o">.</span><span class="n">_check_company</span><span class="p">()</span>

        <span class="n">import_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_import_current_module&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">import_module</span><span class="p">:</span> <span class="c1"># not an import -&gt; bail</span>
            <span class="k">return</span> <span class="n">records</span>

        <span class="c1"># It is to support setting xids directly in create by</span>
        <span class="c1"># providing an &quot;id&quot; key (otherwise stripped by create) during an import</span>
        <span class="c1"># (which should strip &#39;id&#39; from the input data anyway)</span>
        <span class="n">noupdate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;noupdate&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">xids</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vals_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_update_xmlids</span><span class="p">([</span>
            <span class="p">{</span>
                <span class="s1">&#39;xml_id&#39;</span><span class="p">:</span> <span class="n">xid</span> <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">xid</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">import_module</span><span class="p">,</span> <span class="n">xid</span><span class="p">)),</span>
                <span class="s1">&#39;record&#39;</span><span class="p">:</span> <span class="n">rec</span><span class="p">,</span>
                <span class="c1"># note: this is not used when updating o2ms above...</span>
                <span class="s1">&#39;noupdate&#39;</span><span class="p">:</span> <span class="n">noupdate</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">rec</span><span class="p">,</span> <span class="n">xid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">xids</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xid</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xid</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="n">records</span></div>


    <span class="k">def</span> <span class="nf">_prepare_create_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Clean up and complete the given create values, and return a list of</span>
<span class="sd">        new vals containing:</span>

<span class="sd">        * default values,</span>
<span class="sd">        * discarded forbidden values (magic fields),</span>
<span class="sd">        * precomputed fields.</span>

<span class="sd">        :param list vals_list: List of create values</span>
<span class="sd">        :returns: new list of completed create values</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bad_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_path&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span><span class="p">:</span>
            <span class="c1"># the superuser can set log_access fields while loading registry</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span> <span class="o">==</span> <span class="n">SUPERUSER_ID</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">ready</span><span class="p">):</span>
                <span class="n">bad_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">LOG_ACCESS_COLUMNS</span><span class="p">)</span>

        <span class="c1"># also discard precomputed readonly fields (to force their computation)</span>
        <span class="n">bad_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="n">fname</span>
            <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">precompute</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">readonly</span>
        <span class="p">)</span>

        <span class="n">result_vals_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">vals_list</span><span class="p">:</span>
            <span class="c1"># add default values</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_missing_default_values</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

            <span class="c1"># add magic fields</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">bad_names</span><span class="p">:</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span><span class="p">:</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;create_uid&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;create_date&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;write_uid&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;write_date&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

            <span class="n">result_vals_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

        <span class="c1"># add precomputed fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_precomputed_values</span><span class="p">(</span><span class="n">result_vals_list</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result_vals_list</span>

    <span class="k">def</span> <span class="nf">_add_precomputed_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Add missing precomputed fields to ``vals_list`` values.</span>
<span class="sd">        Only applies for precompute=True fields.</span>

<span class="sd">        :param dict vals_list: list(dict) of create values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">precomputable</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">fname</span><span class="p">:</span> <span class="n">field</span>
            <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">precompute</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">precomputable</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># determine which vals must be completed</span>
        <span class="n">vals_list_todo</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">vals</span>
            <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">vals_list</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">fname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vals</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">precomputable</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">vals_list_todo</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># create new records for the vals that must be completed</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">()</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">vals_list_todo</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">record</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">vals_list_todo</span><span class="p">):</span>
            <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;__precomputed__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">precomputed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">precomputable</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">fname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
                    <span class="c1"># computed stored fields with a column</span>
                    <span class="c1"># have to be computed before create</span>
                    <span class="c1"># s.t. required and constraints can be applied on those fields.</span>
                    <span class="n">vals</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_write</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">fname</span><span class="p">],</span> <span class="bp">self</span><span class="p">)</span>
                    <span class="n">precomputed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Create records from the stored field values in ``data_list``. &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">data_list</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span>

        <span class="c1"># insert rows in batches of maximum INSERT_BATCH_SIZE</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>                                <span class="c1"># ids of created records</span>
        <span class="n">other_fields</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">()</span>             <span class="c1"># non-column fields</span>

        <span class="k">for</span> <span class="n">data_sublist</span> <span class="ow">in</span> <span class="n">split_every</span><span class="p">(</span><span class="n">INSERT_BATCH_SIZE</span><span class="p">,</span> <span class="n">data_list</span><span class="p">):</span>
            <span class="n">stored_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;stored&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_sublist</span><span class="p">]</span>
            <span class="n">fnames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({</span><span class="n">name</span> <span class="k">for</span> <span class="n">stored</span> <span class="ow">in</span> <span class="n">stored_list</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">stored</span><span class="p">})</span>

            <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">stored_list</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">column_type</span><span class="p">:</span>
                    <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">stored</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">stored_list</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">stored</span><span class="p">:</span>
                            <span class="n">colval</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_column</span><span class="p">(</span><span class="n">stored</span><span class="p">[</span><span class="n">fname</span><span class="p">],</span> <span class="bp">self</span><span class="p">,</span> <span class="n">stored</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">colval</span><span class="p">:</span>
                                <span class="k">if</span> <span class="s1">&#39;en_US&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">colval</span><span class="o">.</span><span class="n">adapted</span><span class="p">:</span>
                                    <span class="n">colval</span><span class="o">.</span><span class="n">adapted</span><span class="p">[</span><span class="s1">&#39;en_US&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">colval</span><span class="o">.</span><span class="n">adapted</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                            <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colval</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL_DEFAULT</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">other_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;properties&#39;</span><span class="p">:</span>
                    <span class="c1"># force calling fields.create for properties field because</span>
                    <span class="c1"># we might want to update the parent definition</span>
                    <span class="n">other_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">columns</span><span class="p">:</span>
                <span class="c1"># manage the case where we create empty records</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL_DEFAULT</span><span class="p">)</span>

            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span>
                <span class="s1">&#39;INSERT INTO </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">) VALUES </span><span class="si">%s</span><span class="s1"> RETURNING &quot;id&quot;&#39;</span><span class="p">,</span>
                <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">),</span>
                <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">columns</span><span class="p">)),</span>
                <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">),</span>
            <span class="p">))</span>
            <span class="n">ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">id_</span> <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>

        <span class="c1"># put the new records in cache, and update inverse fields, for many2one</span>
        <span class="c1"># (using bin_size=False to put binary values in the right place)</span>
        <span class="c1">#</span>
        <span class="c1"># cachetoclear is an optimization to avoid modified()&#39;s cost until other_fields are processed</span>
        <span class="n">cachetoclear</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
        <span class="n">inverses_update</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>     <span class="c1"># {(field, value): ids}</span>
        <span class="n">common_set_vals</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">LOG_ACCESS_COLUMNS</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_path&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">records</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">False</span><span class="p">)):</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;record&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span>
            <span class="c1"># DLE P104: test_inherit.py, test_50_search_one2many</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;inherited&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span> <span class="o">**</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;stored&#39;</span><span class="p">])</span>
            <span class="n">set_vals</span> <span class="o">=</span> <span class="n">common_set_vals</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;one2many&#39;</span><span class="p">,</span> <span class="s1">&#39;many2many&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="p">())</span>
                <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">related</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">column_type</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_cache</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">record</span><span class="p">))</span>
                <span class="c1"># DLE P123: `test_adv_activity`, `test_message_assignation_inbox`, `test_message_log`, `test_create_mail_simple`, ...</span>
                <span class="c1"># Set `mail.message.parent_id` to False in cache so it doesn&#39;t do the useless SELECT when computing the modified of `child_ids`</span>
                <span class="c1"># in other words, if `parent_id` is not set, no other message `child_ids` are impacted.</span>
                <span class="c1"># + avoid the fetch of fields which are False. e.g. if a boolean field is not passed in vals and as no default set in the field attributes,</span>
                <span class="c1"># then we know it can be set to False in the cache in the case of a create.</span>
                <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">set_vals</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">compute</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_cache</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">record</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;one2many&#39;</span><span class="p">,</span> <span class="s1">&#39;many2many&#39;</span><span class="p">):</span>
                    <span class="n">cachetoclear</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cache_value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_cache</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">cache_value</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;many2one&#39;</span><span class="p">,</span> <span class="s1">&#39;many2one_reference&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">field_inverses</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                        <span class="n">inverses_update</span><span class="p">[(</span><span class="n">field</span><span class="p">,</span> <span class="n">cache_value</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span> <span class="n">record_ids</span> <span class="ow">in</span> <span class="n">inverses_update</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">field</span><span class="o">.</span><span class="n">_update_inverses</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">record_ids</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># update parent_path</span>
        <span class="n">records</span><span class="o">.</span><span class="n">_parent_store_create</span><span class="p">()</span>

        <span class="c1"># protect fields being written against recomputation</span>
        <span class="n">protected</span> <span class="o">=</span> <span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;protected&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;record&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">protecting</span><span class="p">(</span><span class="n">protected</span><span class="p">):</span>
            <span class="c1"># mark computed fields as todo</span>
            <span class="n">records</span><span class="o">.</span><span class="n">modified</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">other_fields</span><span class="p">:</span>
                <span class="c1"># discard default values from context for other fields</span>
                <span class="n">others</span> <span class="o">=</span> <span class="n">records</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">clean_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">other_fields</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;_sequence&#39;</span><span class="p">)):</span>
                    <span class="n">field</span><span class="o">.</span><span class="n">create</span><span class="p">([</span>
                        <span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stored&#39;</span><span class="p">][</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">other</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">others</span><span class="p">,</span> <span class="n">data_list</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stored&#39;</span><span class="p">]</span>
                    <span class="p">])</span>

                <span class="c1"># mark fields to recompute</span>
                <span class="n">records</span><span class="o">.</span><span class="n">modified</span><span class="p">([</span><span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">other_fields</span><span class="p">],</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># if value in cache has not been updated by other_fields, remove it</span>
            <span class="k">for</span> <span class="n">record</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">cachetoclear</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

        <span class="c1"># check Python constraints for stored fields</span>
        <span class="n">records</span><span class="o">.</span><span class="n">_validate_fields</span><span class="p">(</span><span class="n">name</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stored&#39;</span><span class="p">])</span>
        <span class="n">records</span><span class="o">.</span><span class="n">check_access_rule</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">records</span>

    <span class="k">def</span> <span class="nf">_compute_field_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="n">fields</span><span class="o">.</span><span class="n">determine</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">compute</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">):</span>
            <span class="c1"># check constraints of the fields that have been computed</span>
            <span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">field_computed</span><span class="p">[</span><span class="n">field</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_validate_fields</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parent_store_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Set the parent_path field on ``self`` after its creation. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_store</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot; UPDATE %(table)s node</span>
<span class="sd">                SET parent_path=concat((</span>
<span class="sd">                        SELECT parent.parent_path</span>
<span class="sd">                        FROM %(table)s parent</span>
<span class="sd">                        WHERE parent.id=node.%(parent)s</span>
<span class="sd">                    ), node.id, &#39;/&#39;)</span>
<span class="sd">                WHERE node.id IN %(ids)s</span>
<span class="sd">                RETURNING node.id, node.parent_path &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="n">table</span><span class="o">=</span><span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">),</span>
            <span class="n">parent</span><span class="o">=</span><span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">),</span>
            <span class="n">ids</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span>
        <span class="p">))</span>

        <span class="c1"># update the cache of updated nodes, and determine what to recompute</span>
        <span class="n">updated</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">updated</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;parent_path&#39;</span><span class="p">],</span> <span class="n">updated</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_parent_store_update_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the records in ``self`` that must update their parent_path</span>
<span class="sd">            field. This must be called before updating the parent field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_store</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">()</span>

        <span class="c1"># No need to recompute the values if the parent is the same.</span>
        <span class="n">parent_val</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">parent_val</span><span class="p">:</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span>
                <span class="s2">&quot;(</span><span class="si">%(parent)s</span><span class="s2"> != </span><span class="si">%(value)s</span><span class="s2"> OR </span><span class="si">%(parent)s</span><span class="s2"> IS NULL)&quot;</span><span class="p">,</span>
                <span class="n">parent</span><span class="o">=</span><span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">),</span>
                <span class="n">value</span><span class="o">=</span><span class="n">parent_val</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%(parent)s</span><span class="s2"> IS NOT NULL&quot;</span><span class="p">,</span>
                <span class="n">parent</span><span class="o">=</span><span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span>
            <span class="s2">&quot;SELECT id FROM </span><span class="si">%s</span><span class="s2"> WHERE id IN </span><span class="si">%s</span><span class="s2"> AND </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">),</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span>
            <span class="n">condition</span><span class="p">,</span>
        <span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()])</span>

    <span class="k">def</span> <span class="nf">_parent_store_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Update the parent_path field of ``self``. &quot;&quot;&quot;</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span>

        <span class="c1"># determine new prefix of parent_path</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot; SELECT parent.parent_path</span>
<span class="sd">                FROM %(table)s node, %(table)s parent</span>
<span class="sd">                WHERE node.id = %(id)s AND parent.id = node.%(parent)s &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="n">table</span><span class="o">=</span><span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">),</span>
            <span class="n">parent</span><span class="o">=</span><span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">),</span>
            <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">))</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">cr</span><span class="o">.</span><span class="n">rowcount</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># check for recursion</span>
        <span class="k">if</span> <span class="n">prefix</span><span class="p">:</span>
            <span class="n">parent_ids</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">prefix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_ids</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Recursion Detected.&quot;</span><span class="p">))</span>

        <span class="c1"># update parent_path of all records and their descendants</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot; UPDATE %(table)s child</span>
<span class="sd">                SET parent_path = concat(%(prefix)s, substr(child.parent_path,</span>
<span class="sd">                        length(node.parent_path) - length(node.id || &#39;/&#39;) + 1))</span>
<span class="sd">                FROM %(table)s node</span>
<span class="sd">                WHERE node.id IN %(ids)s</span>
<span class="sd">                AND child.parent_path LIKE concat(node.parent_path, %(wildcard)s)</span>
<span class="sd">                RETURNING child.id, child.parent_path &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="n">table</span><span class="o">=</span><span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">),</span>
            <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
            <span class="n">ids</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span>
            <span class="n">wildcard</span><span class="o">=</span><span class="s1">&#39;%&#39;</span><span class="p">,</span>
        <span class="p">))</span>

        <span class="c1"># update the cache of updated nodes, and determine what to recompute</span>
        <span class="n">updated</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">updated</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;parent_path&#39;</span><span class="p">],</span> <span class="n">updated</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">records</span><span class="o">.</span><span class="n">modified</span><span class="p">([</span><span class="s1">&#39;parent_path&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_load_records_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_records_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_list</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Create or update records of this model, and assign XMLIDs.</span>

<span class="sd">            :param data_list: list of dicts with keys `xml_id` (XMLID to</span>
<span class="sd">                assign), `noupdate` (flag on XMLID), `values` (field values)</span>
<span class="sd">            :param update: should be ``True`` when upgrading a module</span>

<span class="sd">            :return: the records corresponding to ``data_list``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">original_self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">()</span>
        <span class="c1"># records created during installation should not display messages</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">install_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">imd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span>

        <span class="c1"># The algorithm below partitions &#39;data_list&#39; into three sets: the ones</span>
        <span class="c1"># to create, the ones to update, and the others. For each set, we assign</span>
        <span class="c1"># data[&#39;record&#39;] for each data. All those records are then retrieved for</span>
        <span class="c1"># the result.</span>

        <span class="c1"># determine existing xml_ids</span>
        <span class="n">xml_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;xml_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list</span> <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xml_id&#39;</span><span class="p">)]</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]):</span> <span class="n">row</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">imd</span><span class="o">.</span><span class="n">_lookup_xmlids</span><span class="p">(</span><span class="n">xml_ids</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1"># determine which records to create and update</span>
        <span class="n">to_create</span> <span class="o">=</span> <span class="p">[]</span>                  <span class="c1"># list of data</span>
        <span class="n">to_update</span> <span class="o">=</span> <span class="p">[]</span>                  <span class="c1"># list of data</span>
        <span class="n">imd_data_list</span> <span class="o">=</span> <span class="p">[]</span>              <span class="c1"># list of data for _update_xmlids()</span>

        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
            <span class="n">xml_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xml_id&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">xml_id</span><span class="p">:</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">):</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;record&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
                    <span class="n">to_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
                    <span class="n">to_create</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">existing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">xml_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">:</span>
                <span class="n">to_create</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">d_id</span><span class="p">,</span> <span class="n">d_module</span><span class="p">,</span> <span class="n">d_name</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">d_res_id</span><span class="p">,</span> <span class="n">d_noupdate</span><span class="p">,</span> <span class="n">r_id</span> <span class="o">=</span> <span class="n">row</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">!=</span> <span class="n">d_model</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;For external id </span><span class="si">{</span><span class="n">xml_id</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;when trying to create/update a record of model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;found record of different model </span><span class="si">{</span><span class="n">d_model</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">d_id</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">d_res_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r_id</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;record&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span>
                <span class="n">imd_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">update</span> <span class="ow">and</span> <span class="n">d_noupdate</span><span class="p">):</span>
                    <span class="n">to_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">imd</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">d_id</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                <span class="n">to_create</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># update existing records</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">to_update</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;record&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_load_records_write</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">])</span>

        <span class="c1"># check for records to create with an XMLID from another module</span>
        <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;install_module&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">module</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">module</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">to_create</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xml_id&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;xml_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Creating record </span><span class="si">%s</span><span class="s2"> in module </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;xml_id&#39;</span><span class="p">],</span> <span class="n">module</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;import_file&#39;</span><span class="p">):</span>
            <span class="n">existing_modules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.module.module&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">search</span><span class="p">([])</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">to_create</span><span class="p">:</span>
                <span class="n">xml_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xml_id&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">xml_id</span><span class="p">:</span>
                    <span class="n">module_name</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">record_id</span> <span class="o">=</span> <span class="n">xml_id</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">sep</span> <span class="ow">and</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">existing_modules</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span>
                            <span class="n">_</span><span class="p">(</span><span class="s2">&quot;The record </span><span class="si">%(xml_id)s</span><span class="s2"> has the module prefix </span><span class="si">%(module_name)s</span><span class="s2">. This is the part before the &#39;.&#39; in the external id. Because the prefix refers to an existing module, the record would be deleted when the module is upgraded. Use either no prefix and no dot or a prefix that isn&#39;t an existing module. For example, __import__, resulting in the external id __import__.</span><span class="si">%(record_id)s</span><span class="s2">.&quot;</span><span class="p">,</span>
                              <span class="n">xml_id</span><span class="o">=</span><span class="n">xml_id</span><span class="p">,</span> <span class="n">module_name</span><span class="o">=</span><span class="n">module_name</span><span class="p">,</span> <span class="n">record_id</span><span class="o">=</span><span class="n">record_id</span><span class="p">))</span>

        <span class="c1"># create records</span>
        <span class="k">if</span> <span class="n">to_create</span><span class="p">:</span>
            <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_records_create</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">to_create</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">to_create</span><span class="p">,</span> <span class="n">records</span><span class="p">):</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;record&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;xml_id&#39;</span><span class="p">):</span>
                    <span class="c1"># add XML ids for parent records that have just been created</span>
                    <span class="k">for</span> <span class="n">parent_model</span><span class="p">,</span> <span class="n">parent_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parent_field</span><span class="p">):</span>
                            <span class="n">imd_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                                <span class="s1">&#39;xml_id&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;xml_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">parent_model</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="s1">&#39;record&#39;</span><span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="n">parent_field</span><span class="p">],</span>
                                <span class="s1">&#39;noupdate&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;noupdate&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                            <span class="p">})</span>
                    <span class="n">imd_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># create or update XMLIDs</span>
        <span class="n">imd</span><span class="o">.</span><span class="n">_update_xmlids</span><span class="p">(</span><span class="n">imd_data_list</span><span class="p">,</span> <span class="n">update</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">original_self</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;record&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">))</span>

    <span class="c1"># TODO: ameliorer avec NULL</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_where_calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">active_test</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes the WHERE clause needed to implement an OpenERP domain.</span>

<span class="sd">        :param list domain: the domain to compute</span>
<span class="sd">        :param bool active_test: whether the default filtering of records with</span>
<span class="sd">            ``active`` field set to ``False`` should be applied.</span>
<span class="sd">        :return: the query expressing the given domain as provided in domain</span>
<span class="sd">        :rtype: Query</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if the object has an active field (&#39;active&#39;, &#39;x_active&#39;), filter out all</span>
        <span class="c1"># inactive records unless they were explicitly asked for</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_name</span> <span class="ow">and</span> <span class="n">active_test</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active_test&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="c1"># the item[0] trick below works for domain items and &#39;&amp;&#39;/&#39;|&#39;/&#39;!&#39;</span>
            <span class="c1"># operators too</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_name</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">domain</span><span class="p">):</span>
                <span class="n">domain</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_active_name</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="n">domain</span>

        <span class="k">if</span> <span class="n">domain</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">expression</span><span class="o">.</span><span class="n">expression</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">query</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_qorder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">regex_order</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;Invalid </span><span class="se">\&quot;</span><span class="s2">order</span><span class="se">\&quot;</span><span class="s2"> specified (</span><span class="si">%s</span><span class="s2">).&quot;</span>
                <span class="s2">&quot; A valid </span><span class="se">\&quot;</span><span class="s2">order</span><span class="se">\&quot;</span><span class="s2"> specification is a comma-separated list of valid field names&quot;</span>
                <span class="s2">&quot; (optionally followed by asc/desc for the direction)&quot;</span><span class="p">,</span>
                <span class="n">word</span><span class="p">,</span>
            <span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_apply_ir_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;read&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add what&#39;s missing in ``query`` to implement all appropriate ir.rules</span>
<span class="sd">          (using the ``model_name``&#39;s rules or the current model&#39;s rules if ``model_name`` is None)</span>

<span class="sd">        :param query: the current query object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">su</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># apply main rules on the object</span>
        <span class="n">Rule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.rule&#39;</span><span class="p">]</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">Rule</span><span class="o">.</span><span class="n">_compute_domain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">domain</span><span class="p">:</span>
            <span class="n">expression</span><span class="o">.</span><span class="n">expression</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_order_to_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">Query</span><span class="p">,</span> <span class="n">alias</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">reverse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SQL</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return an :class:`SQL` object that represents the given ORDER BY</span>
<span class="sd">        clause, without the ORDER BY keyword.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">order</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">order</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_qorder</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

        <span class="n">alias</span> <span class="o">=</span> <span class="n">alias</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span>

        <span class="n">terms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">order_part</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">order_match</span> <span class="o">=</span> <span class="n">regex_order</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">order_part</span><span class="p">)</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="n">order_match</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span>

            <span class="n">property_name</span> <span class="o">=</span> <span class="n">order_match</span><span class="p">[</span><span class="s1">&#39;property&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">property_name</span><span class="p">:</span>
                <span class="n">field_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">property_name</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">direction</span> <span class="o">=</span> <span class="p">(</span><span class="n">order_match</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">nulls</span> <span class="o">=</span> <span class="p">(</span><span class="n">order_match</span><span class="p">[</span><span class="s1">&#39;nulls&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;ASC&#39;</span> <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;DESC&#39;</span> <span class="k">else</span> <span class="s1">&#39;DESC&#39;</span>
                <span class="k">if</span> <span class="n">nulls</span><span class="p">:</span>
                    <span class="n">nulls</span> <span class="o">=</span> <span class="s1">&#39;NULLS LAST&#39;</span> <span class="k">if</span> <span class="n">nulls</span> <span class="o">==</span> <span class="s1">&#39;NULLS FIRST&#39;</span> <span class="k">else</span> <span class="s1">&#39;NULLS FIRST&#39;</span>

            <span class="n">sql_direction</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span> <span class="k">if</span> <span class="n">direction</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ASC&#39;</span><span class="p">,</span> <span class="s1">&#39;DESC&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">SQL</span><span class="p">()</span>
            <span class="n">sql_nulls</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="n">nulls</span><span class="p">)</span> <span class="k">if</span> <span class="n">nulls</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;NULLS FIRST&#39;</span><span class="p">,</span> <span class="s1">&#39;NULLS LAST&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">SQL</span><span class="p">()</span>

            <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_field_to_sql</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">sql_direction</span><span class="p">,</span> <span class="n">sql_nulls</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">term</span><span class="p">:</span>
                <span class="n">terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_order_field_to_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="n">SQL</span><span class="p">,</span>
                            <span class="n">nulls</span><span class="p">:</span> <span class="n">SQL</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">Query</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SQL</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return an :class:`SQL` object that represents the ordering by the</span>
<span class="sd">        given field.</span>

<span class="sd">        :param direction: one of ``SQL(&quot;ASC&quot;)``, ``SQL(&quot;DESC&quot;)``, ``SQL()``</span>
<span class="sd">        :param nulls: one of ``SQL(&quot;NULLS FIRST&quot;)``, ``SQL(&quot;NULLS LAST&quot;)``, ``SQL()``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">full_name</span> <span class="o">=</span> <span class="n">field_name</span>
        <span class="n">property_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">field_name</span><span class="p">:</span>
            <span class="n">field_name</span><span class="p">,</span> <span class="n">property_name</span> <span class="o">=</span> <span class="n">field_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid field </span><span class="si">{</span><span class="n">field_name</span><span class="si">!r}</span><span class="s2"> on model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">property_name</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;properties&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Order a property (</span><span class="si">{</span><span class="n">property_name</span><span class="si">!r}</span><span class="s1">) on a non-properties field (</span><span class="si">{</span><span class="n">field_name</span><span class="si">!r}</span><span class="s1">)&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">inherited</span><span class="p">:</span>
            <span class="c1"># delegate to the parent model via a join</span>
            <span class="n">parent_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">related_field</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span>
            <span class="n">parent_fname</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">parent_alias</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">make_alias</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">parent_fname</span><span class="p">)</span>
            <span class="n">query</span><span class="o">.</span><span class="n">add_join</span><span class="p">(</span><span class="s1">&#39;LEFT JOIN&#39;</span><span class="p">,</span> <span class="n">parent_alias</span><span class="p">,</span> <span class="n">parent_model</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">SQL</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_field_to_sql</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">parent_fname</span><span class="p">,</span> <span class="n">query</span><span class="p">),</span>
                <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">parent_alias</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">),</span>
            <span class="p">))</span>
            <span class="k">return</span> <span class="n">parent_model</span><span class="o">.</span><span class="n">_order_field_to_sql</span><span class="p">(</span><span class="n">parent_alias</span><span class="p">,</span> <span class="n">full_name</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">nulls</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">column_type</span><span class="p">):</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Model </span><span class="si">%r</span><span class="s2"> cannot be sorted on field </span><span class="si">%r</span><span class="s2"> (not a column)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2one&#39;</span><span class="p">:</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;__m2o_order_seen&#39;</span><span class="p">,</span> <span class="p">())</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">__m2o_order_seen</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">((</span><span class="n">field</span><span class="p">,</span> <span class="o">*</span><span class="n">seen</span><span class="p">)))</span>

            <span class="c1"># figure out the applicable order_by for the m2o</span>
            <span class="n">comodel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span>
            <span class="n">coorder</span> <span class="o">=</span> <span class="n">comodel</span><span class="o">.</span><span class="n">_order</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">regex_order</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">coorder</span><span class="p">):</span>
                <span class="c1"># _order is complex, can&#39;t use it here, so we default to _rec_name</span>
                <span class="n">coorder</span> <span class="o">=</span> <span class="n">comodel</span><span class="o">.</span><span class="n">_rec_name</span>

            <span class="k">if</span> <span class="n">coorder</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>
                <span class="n">sql_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_to_sql</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sql_field</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">nulls</span><span class="p">)</span>

            <span class="c1"># instead of ordering by the field&#39;s raw value, use the comodel&#39;s</span>
            <span class="c1"># order on many2one values</span>
            <span class="n">terms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">nulls</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;NULLS FIRST&#39;</span><span class="p">:</span>
                <span class="n">terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> IS NOT NULL&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_to_sql</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">query</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">nulls</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;NULLS LAST&#39;</span><span class="p">:</span>
                <span class="n">terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> IS NULL&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_to_sql</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">query</span><span class="p">)))</span>

            <span class="c1"># LEFT JOIN the comodel table, in order to include NULL values, too</span>
            <span class="n">coalias</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">make_alias</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
            <span class="n">query</span><span class="o">.</span><span class="n">add_join</span><span class="p">(</span><span class="s1">&#39;LEFT JOIN&#39;</span><span class="p">,</span> <span class="n">coalias</span><span class="p">,</span> <span class="n">comodel</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">SQL</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_field_to_sql</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">query</span><span class="p">),</span>
                <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">coalias</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">),</span>
            <span class="p">))</span>

            <span class="c1"># delegate the order to the comodel</span>
            <span class="n">reverse</span> <span class="o">=</span> <span class="n">direction</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;DESC&#39;</span>
            <span class="n">term</span> <span class="o">=</span> <span class="n">comodel</span><span class="o">.</span><span class="n">_order_to_sql</span><span class="p">(</span><span class="n">coorder</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="n">coalias</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">term</span><span class="p">:</span>
                <span class="n">terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span>

        <span class="n">sql_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_to_sql</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;boolean&#39;</span><span class="p">:</span>
            <span class="n">sql_field</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;COALESCE(</span><span class="si">%s</span><span class="s2">, FALSE)&quot;</span><span class="p">,</span> <span class="n">sql_field</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;properties&#39;</span> <span class="ow">and</span> <span class="n">property_name</span><span class="p">:</span>
            <span class="n">sql_field</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">sql_field</span><span class="p">,</span> <span class="n">property_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sql_field</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">nulls</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_generate_order_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_spec</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempt to construct an appropriate ORDER BY clause based on order_spec, which must be</span>
<span class="sd">        a comma-separated list of valid field names, optionally followed by an ASC or DESC direction.</span>

<span class="sd">        :raise ValueError in case order_spec is malformed</span>

<span class="sd">        .. deprecated:: 17.0</span>
<span class="sd">            Deprecated method, use _order_to_sql() instead</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Deprecated method _generate_order_by(), _order_to_sql() instead&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_to_sql</span><span class="p">(</span><span class="n">order_spec</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">order_by_clause</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">mogrify</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">order_by_clause</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39; ORDER BY </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">order_by_clause</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_flush_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Flush all the fields appearing in `domain`, `fields` and `order`.</span>

<span class="sd">        Note that ``order=None`` actually means no order, so if you expect some</span>
<span class="sd">        fallback order, you have to provide it yourself.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">seen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

        <span class="n">to_flush</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">OrderedSet</span><span class="p">)</span>             <span class="c1"># {model_name: field_names}</span>
        <span class="k">if</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">to_flush</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">collect_from_domain</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">domain</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">comodel</span> <span class="o">=</span> <span class="n">collect_from_path</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;child_of&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_of&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">comodel</span><span class="o">.</span><span class="n">_parent_store</span><span class="p">:</span>
                    <span class="c1"># hierarchy operators need the parent field</span>
                    <span class="n">collect_from_path</span><span class="p">(</span><span class="n">comodel</span><span class="p">,</span> <span class="n">comodel</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;any&#39;</span><span class="p">,</span> <span class="s1">&#39;not any&#39;</span><span class="p">):</span>
                    <span class="n">collect_from_domain</span><span class="p">(</span><span class="n">comodel</span><span class="p">,</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">collect_from_path</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
            <span class="c1"># path is a dot-separated sequence of field names</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">to_flush</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;one2many&#39;</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">inverse_name</span><span class="p">:</span>
                    <span class="n">to_flush</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">inverse_name</span><span class="p">)</span>
                    <span class="n">field_domain</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_domain_list</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">field_domain</span><span class="p">:</span>
                        <span class="n">collect_from_domain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">],</span> <span class="n">field_domain</span><span class="p">)</span>
                <span class="c1"># DLE P111: `test_message_process_email_partner_find`</span>
                <span class="c1"># Search on res.users with email_normalized in domain</span>
                <span class="c1"># must trigger the recompute and flush of res.partner.email_normalized</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">related</span><span class="p">:</span>
                    <span class="c1"># DLE P129: `test_transit_multi_companies`</span>
                    <span class="c1"># `self.env[&#39;stock.picking&#39;].search([(&#39;product_id&#39;, &#39;=&#39;, product.id)])`</span>
                    <span class="c1"># Should flush `stock.move.picking_ids` as `product_id` on `stock.picking` is defined as:</span>
                    <span class="c1"># `product_id = fields.Many2one(&#39;product.product&#39;, &#39;Product&#39;, related=&#39;move_lines.product_id&#39;, readonly=False)`</span>
                    <span class="n">collect_from_path</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">related</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">relational</span><span class="p">:</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span>
            <span class="c1"># return the model found by traversing all fields (used in collect_from_domain)</span>
            <span class="k">return</span> <span class="n">model</span>

        <span class="c1"># flush the order fields</span>
        <span class="k">if</span> <span class="n">order</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">order_part</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
                <span class="n">order_field</span> <span class="o">=</span> <span class="n">order_part</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">order_field</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">to_flush</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">order_field</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">relational</span><span class="p">:</span>
                        <span class="n">comodel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span>
                        <span class="n">comodel</span><span class="o">.</span><span class="n">_flush_search</span><span class="p">([],</span> <span class="n">order</span><span class="o">=</span><span class="n">comodel</span><span class="o">.</span><span class="n">_order</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="n">seen</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_name</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active_test&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">to_flush</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_active_name</span><span class="p">)</span>

        <span class="n">collect_from_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>

        <span class="c1"># Check access of fields with groups</span>
        <span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_names</span> <span class="ow">in</span> <span class="n">to_flush</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">check_field_access_rights</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="n">field_names</span><span class="p">)</span>

        <span class="c1"># also take into account the fields in the record rules</span>
        <span class="k">if</span> <span class="n">ir_rule_domain</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.rule&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_compute_domain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">):</span>
            <span class="n">collect_from_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ir_rule_domain</span><span class="p">)</span>

        <span class="c1"># flush model dependencies (recursively)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_depends</span><span class="p">:</span>
            <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>
            <span class="k">while</span> <span class="n">models</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_names</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_depends</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">to_flush</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">field_names</span><span class="p">)</span>
                    <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model_name</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_names</span> <span class="ow">in</span> <span class="n">to_flush</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">flush_model</span><span class="p">(</span><span class="n">field_names</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">access_rights_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private implementation of search() method, allowing specifying the uid to use for the access right check.</span>
<span class="sd">        This is useful for example when filling in the selection list for a drop-down and avoiding access rights errors,</span>
<span class="sd">        by specifying ``access_rights_uid=1`` to bypass access rights check, but not ir.rules!</span>
<span class="sd">        This is ok at the security level because this method is private and not callable through XML-RPC.</span>

<span class="sd">        No default order is applied when the method is invoked without parameter ``order``.</span>

<span class="sd">        :param access_rights_uid: optional user ID to use when checking access rights</span>
<span class="sd">                                  (not for ir.rules, this is only for ir.model.access)</span>
<span class="sd">        :return: a :class:`Query` object that represents the matching records</span>

<span class="sd">        This method may be overridden to modify the domain being searched, or to</span>
<span class="sd">        do some post-filtering of the resulting query object. Be careful with</span>
<span class="sd">        the latter option, though, as it might hurt performance. Indeed, by</span>
<span class="sd">        default the returned query object is not actually executed, and it can</span>
<span class="sd">        be injected as a value in a domain in order to generate sub-queries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">access_rights_uid</span><span class="p">)</span> <span class="k">if</span> <span class="n">access_rights_uid</span> <span class="k">else</span> <span class="bp">self</span>
        <span class="n">model</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">expression</span><span class="o">.</span><span class="n">is_false</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
            <span class="c1"># optimization: no need to query, as no record satisfies the domain</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">()</span><span class="o">.</span><span class="n">_as_query</span><span class="p">()</span>

        <span class="c1"># the flush must be done before the _where_calc(), as the latter can do some selects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flush_search</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_where_calc</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_ir_rules</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">query</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order_to_sql</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">limit</span>
        <span class="n">query</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>

        <span class="k">return</span> <span class="n">query</span>

    <span class="k">def</span> <span class="nf">_as_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return a :class:`Query` that corresponds to the recordset ``self``.</span>
<span class="sd">        This method is convenient for making a query object with a known result.</span>

<span class="sd">        :param ordered: whether the recordset order must be enforced by the query</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_query</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">set_result_ids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">,</span> <span class="n">ordered</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span>

<div class="viewcode-block" id="BaseModel.copy_data">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.copy_data">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">returns</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">copy_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy given record&#39;s data with all its fields values</span>

<span class="sd">        :param default: field values to override in the original values of the copied record</span>
<span class="sd">        :return: list with a dictionary containing all the field values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># In the old API, this method took a single id and return a dict. When</span>
        <span class="c1"># invoked with the new API, it returned a list of dicts.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>

        <span class="c1"># avoid recursion through already copied records in case of circular relationship</span>
        <span class="k">if</span> <span class="s1">&#39;__copy_data_seen&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">:</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">__copy_data_seen</span><span class="o">=</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">))</span>
        <span class="n">seen_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">[</span><span class="s1">&#39;__copy_data_seen&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">seen_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="n">seen_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="n">default</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">default</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="c1"># build a black list of fields that should not be copied</span>
        <span class="n">blacklist</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">MAGIC_COLUMNS</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;parent_path&#39;</span><span class="p">])</span>
        <span class="n">whitelist</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">inherited</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">blacklist_given_fields</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
            <span class="c1"># blacklist the fields that are given by inheritance</span>
            <span class="k">for</span> <span class="n">parent_model</span><span class="p">,</span> <span class="n">parent_field</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_inherits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">blacklist</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">parent_field</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">parent_field</span> <span class="ow">in</span> <span class="n">default</span><span class="p">:</span>
                    <span class="c1"># all the fields of &#39;parent_model&#39; are given by the record:</span>
                    <span class="c1"># default[parent_field], except the ones redefined in self</span>
                    <span class="n">blacklist</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">parent_model</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span> <span class="o">-</span> <span class="n">whitelist</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">blacklist_given_fields</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">parent_model</span><span class="p">])</span>

        <span class="n">blacklist_given_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">fields_to_copy</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">field</span>
                          <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                          <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">copy</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">default</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">blacklist</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields_to_copy</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;one2many&#39;</span><span class="p">:</span>
                <span class="c1"># duplicate following the order of the ids because we&#39;ll rely on</span>
                <span class="c1"># it later for copying translations in copy_translation()!</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">rec</span><span class="o">.</span><span class="n">copy_data</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">sorted</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">)]</span>
                <span class="c1"># the lines are duplicated using the wrong (old) parent, but then are</span>
                <span class="c1"># reassigned to the correct one thanks to the (Command.CREATE, 0, ...)</span>
                <span class="n">default</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">line</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2many&#39;</span><span class="p">:</span>
                <span class="n">default</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">ids</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">default</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_write</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">default</span><span class="p">]</span></div>


<div class="viewcode-block" id="BaseModel.copy_translations">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.copy_translations">[docs]</a>
    <span class="k">def</span> <span class="nf">copy_translations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">excluded</span><span class="o">=</span><span class="p">()):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Recursively copy the translations from original to new record</span>

<span class="sd">        :param self: the original record</span>
<span class="sd">        :param new: the new record (copy of the original one)</span>
<span class="sd">        :param excluded: a container of user-provided field names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="c1"># avoid recursion through already copied records in case of circular relationship</span>
        <span class="k">if</span> <span class="s1">&#39;__copy_translations_seen&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">old</span><span class="o">.</span><span class="n">_context</span><span class="p">:</span>
            <span class="n">old</span> <span class="o">=</span> <span class="n">old</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">__copy_translations_seen</span><span class="o">=</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">))</span>
        <span class="n">seen_map</span> <span class="o">=</span> <span class="n">old</span><span class="o">.</span><span class="n">_context</span><span class="p">[</span><span class="s1">&#39;__copy_translations_seen&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">old</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">seen_map</span><span class="p">[</span><span class="n">old</span><span class="o">.</span><span class="n">_name</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="n">seen_map</span><span class="p">[</span><span class="n">old</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">old</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">valid_langs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">code</span> <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.lang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_installed</span><span class="p">())</span> <span class="o">|</span> <span class="p">{</span><span class="s1">&#39;en_US&#39;</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">old</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">copy</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">inherited</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">excluded</span><span class="p">:</span>
                <span class="c1"># inherited fields that come from a user-provided parent record</span>
                <span class="c1"># must not copy translations, as the parent record is not a copy</span>
                <span class="c1"># of the old parent record</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;one2many&#39;</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excluded</span><span class="p">:</span>
                <span class="c1"># we must recursively copy the translations for o2m; here we</span>
                <span class="c1"># rely on the order of the ids to match the translations as</span>
                <span class="c1"># foreseen in copy_data()</span>
                <span class="n">old_lines</span> <span class="o">=</span> <span class="n">old</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">sorted</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
                <span class="n">new_lines</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">sorted</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">old_line</span><span class="p">,</span> <span class="n">new_line</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">old_lines</span><span class="p">,</span> <span class="n">new_lines</span><span class="p">):</span>
                    <span class="c1"># don&#39;t pass excluded as it is not about those lines</span>
                    <span class="n">old_line</span><span class="o">.</span><span class="n">copy_translations</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excluded</span> <span class="ow">and</span> <span class="n">old</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                <span class="c1"># for translatable fields we copy their translations</span>
                <span class="n">old_stored_translations</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">_get_stored_translations</span><span class="p">(</span><span class="n">old</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">old_stored_translations</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">lang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span> <span class="ow">or</span> <span class="s1">&#39;en_US&#39;</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">new</span><span class="o">.</span><span class="n">update_field_translations</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">{</span>
                        <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">old_stored_translations</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">valid_langs</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">lang</span>
                    <span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">old_translations</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">k</span><span class="p">:</span> <span class="n">old_stored_translations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">old_stored_translations</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">valid_langs</span>
                    <span class="p">}</span>
                    <span class="c1"># {from_lang_term: {lang: to_lang_term}</span>
                    <span class="n">translation_dictionary</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_translation_dictionary</span><span class="p">(</span>
                        <span class="n">old_translations</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">old_translations</span><span class="p">[</span><span class="s1">&#39;en_US&#39;</span><span class="p">]),</span>
                        <span class="n">old_translations</span>
                    <span class="p">)</span>
                    <span class="c1"># {lang: {old_term: new_term}}</span>
                    <span class="n">translations</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">from_lang_term</span><span class="p">,</span> <span class="n">to_lang_terms</span> <span class="ow">in</span> <span class="n">translation_dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">lang</span><span class="p">,</span> <span class="n">to_lang_term</span> <span class="ow">in</span> <span class="n">to_lang_terms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">translations</span><span class="p">[</span><span class="n">lang</span><span class="p">][</span><span class="n">from_lang_term</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_lang_term</span>
                    <span class="n">new</span><span class="o">.</span><span class="n">update_field_translations</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">translations</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseModel.copy">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.copy">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">returns</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; copy(default=None)</span>

<span class="sd">        Duplicate record ``self`` updating it with default values</span>

<span class="sd">        :param dict default: dictionary of field values to override in the</span>
<span class="sd">               original values of the copied record, e.g: ``{&#39;field_name&#39;: overridden_value, ...}``</span>
<span class="sd">        :returns: new record</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">copy_data</span><span class="p">(</span><span class="n">default</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">record_copy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">from_copy_translation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">copy_translations</span><span class="p">(</span><span class="n">record_copy</span><span class="p">,</span> <span class="n">excluded</span><span class="o">=</span><span class="n">default</span> <span class="ow">or</span> <span class="p">())</span>

        <span class="k">return</span> <span class="n">record_copy</span></div>


<div class="viewcode-block" id="BaseModel.copy_multi">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.copy_multi">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">returns</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">copy_multi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; copy_multi(default=None)</span>

<span class="sd">        Duplicate records in ``self`` updating it with default values</span>

<span class="sd">        :param dict default: dictionary of field values to override in the</span>
<span class="sd">               original values of the copied records, e.g: ``{&#39;field_name&#39;: overridden_value, ...}``</span>
<span class="sd">        :returns: new records</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">([</span><span class="n">record</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">default</span><span class="p">)</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">])</span></div>


<div class="viewcode-block" id="BaseModel.exists">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.exists">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">returns</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;  exists() -&gt; records</span>

<span class="sd">        Returns the subset of records in ``self`` that exist.</span>
<span class="sd">        It can be used as a test on records::</span>

<span class="sd">            if record.exists():</span>
<span class="sd">                ...</span>

<span class="sd">        By convention, new records are returned as existing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_ids</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">partition</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">NewId</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table_query</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">add_where</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> IN </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ids</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">select</span><span class="p">())</span>
        <span class="n">valid_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span> <span class="o">+</span> <span class="n">new_ids</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">valid_ids</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_check_recursion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies that there is no loop in a hierarchical structure of records,</span>
<span class="sd">        by following the parent relationship using the **parent** field until a</span>
<span class="sd">        loop is detected or until a top-level record is found.</span>

<span class="sd">        :param parent: optional parent field name (default: ``self._parent_name``)</span>
<span class="sd">        :return: **True** if no loop was found, **False** otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent</span><span class="p">:</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span>

        <span class="c1"># must ignore &#39;active&#39; flag, ir.rules, etc. =&gt; direct SQL query</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush_model</span><span class="p">([</span><span class="n">parent</span><span class="p">])</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">:</span>
            <span class="n">current_id</span> <span class="o">=</span> <span class="nb">id</span>
            <span class="n">seen_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">current_id</span><span class="p">}</span>
            <span class="k">while</span> <span class="n">current_id</span><span class="p">:</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span>
                    <span class="s2">&quot;SELECT </span><span class="si">%s</span><span class="s2"> FROM </span><span class="si">%s</span><span class="s2"> WHERE id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">parent</span><span class="p">),</span> <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">),</span> <span class="n">current_id</span><span class="p">,</span>
                <span class="p">))</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                <span class="n">current_id</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">current_id</span> <span class="ow">in</span> <span class="n">seen_ids</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="n">seen_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">current_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_check_m2m_recursion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies that there is no loop in a directed graph of records, by</span>
<span class="sd">        following a many2many relationship with the given field name.</span>

<span class="sd">        :param field_name: field to check</span>
<span class="sd">        :return: **True** if no loop was found, **False** otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">field</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2many&#39;</span> <span class="ow">and</span>
                <span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">):</span>
            <span class="c1"># field must be a many2many on itself</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid field_name: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field_name</span><span class="p">,))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">flush_model</span><span class="p">([</span><span class="n">field_name</span><span class="p">])</span>

        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span>
        <span class="n">succs</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>        <span class="c1"># transitive closure of successors</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>        <span class="c1"># transitive closure of predecessors</span>
        <span class="n">todo</span><span class="p">,</span> <span class="n">done</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">todo</span><span class="p">:</span>
            <span class="c1"># retrieve the respective successors of the nodes in &#39;todo&#39;</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot; SELECT %(col1)s, %(col2)s FROM %(rel)s</span>
<span class="sd">                    WHERE %(col1)s IN %(ids)s AND %(col2)s IS NOT NULL &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="n">rel</span><span class="o">=</span><span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">relation</span><span class="p">),</span>
                <span class="n">col1</span><span class="o">=</span><span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">column1</span><span class="p">),</span>
                <span class="n">col2</span><span class="o">=</span><span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">column2</span><span class="p">),</span>
                <span class="n">ids</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">todo</span><span class="p">),</span>
            <span class="p">))</span>
            <span class="n">done</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">todo</span><span class="p">)</span>
            <span class="n">todo</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">id1</span><span class="p">,</span> <span class="n">id2</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
                <span class="c1"># connect id1 and its predecessors to id2 and its successors</span>
                <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">([</span><span class="n">id1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="n">id1</span><span class="p">]),</span>
                                              <span class="p">[</span><span class="n">id2</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">succs</span><span class="p">[</span><span class="n">id2</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>    <span class="c1"># we found a cycle here!</span>
                    <span class="n">succs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                    <span class="n">preds</span><span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">id2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="n">todo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id2</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_get_external_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the External ID(s) of any database record.</span>

<span class="sd">        **Synopsis**: ``_get_external_ids() -&gt; { &#39;id&#39;: [&#39;module.external_id&#39;] }``</span>

<span class="sd">        :return: map of ids to the list of their fully qualified External IDs</span>
<span class="sd">                 in the form ``module.key``, or an empty list when there&#39;s no External</span>
<span class="sd">                 ID for a record, e.g.::</span>

<span class="sd">                     { &#39;id&#39;: [&#39;module.ext_id&#39;, &#39;module.ext_id_bis&#39;],</span>
<span class="sd">                       &#39;id2&#39;: [] }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">search_read</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;res_id&#39;</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">):</span>
            <span class="n">result</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;res_id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(module)s</span><span class="s1">.</span><span class="si">%(name)s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">_origin</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span>
        <span class="p">}</span>

<div class="viewcode-block" id="BaseModel.get_external_id">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.get_external_id">[docs]</a>
    <span class="k">def</span> <span class="nf">get_external_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the External ID of any database record, if there</span>
<span class="sd">        is one. This method works as a possible implementation</span>
<span class="sd">        for a function field, to be able to add it to any</span>
<span class="sd">        model object easily, referencing it as ``Model.get_external_id``.</span>

<span class="sd">        When multiple External IDs exist for a record, only one</span>
<span class="sd">        of them is returned (randomly).</span>

<span class="sd">        :return: map of ids to their fully qualified XML ID,</span>
<span class="sd">                 defaulting to an empty string when there&#39;s none</span>
<span class="sd">                 (to be usable as a function field),</span>
<span class="sd">                 e.g.::</span>

<span class="sd">                     { &#39;id&#39;: &#39;module.ext_id&#39;,</span>
<span class="sd">                       &#39;id2&#39;: &#39;&#39; }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_external_ids</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">val</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span></div>


<div class="viewcode-block" id="BaseModel.is_transient">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.is_transient">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">is_transient</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return whether the model is transient.</span>

<span class="sd">        See :class:`TransientModel`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_transient</span></div>


<div class="viewcode-block" id="BaseModel.search_read">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.search_read">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">search_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">read_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Perform a :meth:`search_fetch` followed by a :meth:`_read_format`.</span>

<span class="sd">        :param domain: Search domain, see ``args`` parameter in :meth:`search`.</span>
<span class="sd">            Defaults to an empty domain that will match all records.</span>
<span class="sd">        :param fields: List of fields to read, see ``fields`` parameter in :meth:`read`.</span>
<span class="sd">            Defaults to all fields.</span>
<span class="sd">        :param int offset: Number of records to skip, see ``offset`` parameter in :meth:`search`.</span>
<span class="sd">            Defaults to 0.</span>
<span class="sd">        :param int limit: Maximum number of records to return, see ``limit`` parameter in :meth:`search`.</span>
<span class="sd">            Defaults to no limit.</span>
<span class="sd">        :param order: Columns to sort result, see ``order`` parameter in :meth:`search`.</span>
<span class="sd">            Defaults to no sort.</span>
<span class="sd">        :param read_kwargs: All read keywords arguments used to call</span>
<span class="sd">            ``read(..., **read_kwargs)`` method e.g. you can use</span>
<span class="sd">            ``search_read(..., load=&#39;&#39;)`` in order to avoid computing display_name</span>
<span class="sd">        :return: List of dictionaries containing the asked fields.</span>
<span class="sd">        :rtype: list(dict).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_field_access_rights</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_fetch</span><span class="p">(</span><span class="n">domain</span> <span class="ow">or</span> <span class="p">[],</span> <span class="n">fields</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

        <span class="c1"># Method _read_format() ignores &#39;active_test&#39;, but it would forward it</span>
        <span class="c1"># to any downstream search call(e.g. for x2m or computed fields), and</span>
        <span class="c1"># this is not the desired behavior. The flag was presumably only meant</span>
        <span class="c1"># for the main search().</span>
        <span class="k">if</span> <span class="s1">&#39;active_test&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;active_test&#39;</span><span class="p">]</span>
            <span class="n">records</span> <span class="o">=</span> <span class="n">records</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">records</span><span class="o">.</span><span class="n">_read_format</span><span class="p">(</span><span class="n">fnames</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span> <span class="o">**</span><span class="n">read_kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseModel.toggle_active">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.toggle_active">[docs]</a>
    <span class="k">def</span> <span class="nf">toggle_active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Inverses the value of :attr:`active` on the records in ``self``.&quot;</span>
        <span class="n">active_recs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_active_name</span><span class="p">)</span>
        <span class="n">active_recs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_active_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="p">(</span><span class="bp">self</span> <span class="o">-</span> <span class="n">active_recs</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">_active_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="BaseModel.action_archive">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.action_archive">[docs]</a>
    <span class="k">def</span> <span class="nf">action_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets :attr:`active` to ``False`` on a recordset, by calling</span>
<span class="sd">         :meth:`toggle_active` on its currently active records.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">record</span><span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_active_name</span><span class="p">])</span><span class="o">.</span><span class="n">toggle_active</span><span class="p">()</span></div>


<div class="viewcode-block" id="BaseModel.action_unarchive">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.action_unarchive">[docs]</a>
    <span class="k">def</span> <span class="nf">action_unarchive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets :attr:`active` to ``True`` on a recordset, by calling</span>
<span class="sd">        :meth:`toggle_active` on its currently inactive records.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">record</span><span class="p">:</span> <span class="ow">not</span> <span class="n">record</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_active_name</span><span class="p">])</span><span class="o">.</span><span class="n">toggle_active</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_register_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; stuff to do right after the registry is built &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_unregister_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Clean up what `~._register_hook` has done. &quot;&quot;&quot;</span>

    <span class="c1">#</span>
    <span class="c1"># Instance creation</span>
    <span class="c1">#</span>
    <span class="c1"># An instance represents an ordered collection of records in a given</span>
    <span class="c1"># execution environment. The instance object refers to the environment, and</span>
    <span class="c1"># the records themselves are represented by their cache dictionary. The &#39;id&#39;</span>
    <span class="c1"># of each record is found in its corresponding cache dictionary.</span>
    <span class="c1">#</span>
    <span class="c1"># This design has the following advantages:</span>
    <span class="c1">#  - cache access is direct and thus fast;</span>
    <span class="c1">#  - one can consider records without an &#39;id&#39; (see new records);</span>
    <span class="c1">#  - the global cache is only an index to &quot;resolve&quot; a record &#39;id&#39;.</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">prefetch_ids</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Create a recordset instance.</span>

<span class="sd">        :param env: an environment</span>
<span class="sd">        :param ids: a tuple of record ids</span>
<span class="sd">        :param prefetch_ids: a reversible iterable of record ids (for prefetching)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span> <span class="o">=</span> <span class="n">ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_ids</span> <span class="o">=</span> <span class="n">prefetch_ids</span>

<div class="viewcode-block" id="BaseModel.browse">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.browse">[docs]</a>
    <span class="k">def</span> <span class="nf">browse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; browse([ids]) -&gt; records</span>

<span class="sd">        Returns a recordset for the ids provided as parameter in the current</span>
<span class="sd">        environment.</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            self.browse([7, 18, 12])</span>
<span class="sd">            res.partner(7, 18, 12)</span>

<span class="sd">        :param ids: id(s)</span>
<span class="sd">        :type ids: int or iterable(int) or None</span>
<span class="sd">        :return: recordset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">()</span>
        <span class="k">elif</span> <span class="n">ids</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">(</span><span class="n">ids</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span></div>


    <span class="c1">#</span>
    <span class="c1"># Internal properties, for manipulating the instance&#39;s implementation</span>
    <span class="c1">#</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the list of actual record ids corresponding to ``self``. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">origin_ids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">))</span>

    <span class="c1"># backward-compatibility with former browse records</span>
    <span class="n">_cr</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span>
    <span class="n">_uid</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
    <span class="n">_context</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Conversion methods</span>
    <span class="c1">#</span>

<div class="viewcode-block" id="BaseModel.ensure_one">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.ensure_one">[docs]</a>
    <span class="k">def</span> <span class="nf">ensure_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify that the current recordset holds a single record.</span>

<span class="sd">        :raise odoo.exceptions.ValueError: ``len(self) != 1``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># unpack to ensure there is only one value is faster than len when true and</span>
            <span class="c1"># has a significant impact as this check is largely called</span>
            <span class="n">_id</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected singleton: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseModel.with_env">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.with_env">[docs]</a>
    <span class="k">def</span> <span class="nf">with_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a new version of this recordset attached to the provided environment.</span>

<span class="sd">        :param env:</span>
<span class="sd">        :type env: :class:`~odoo.api.Environment`</span>

<span class="sd">        .. note::</span>
<span class="sd">            The returned recordset has the same prefetch object as ``self``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_ids</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseModel.sudo">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.sudo">[docs]</a>
    <span class="k">def</span> <span class="nf">sudo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; sudo([flag=True])</span>

<span class="sd">        Returns a new version of this recordset with superuser mode enabled or</span>
<span class="sd">        disabled, depending on `flag`. The superuser mode does not change the</span>
<span class="sd">        current user, and simply bypasses access rights checks.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            Using ``sudo`` could cause data access to cross the</span>
<span class="sd">            boundaries of record rules, possibly mixing records that</span>
<span class="sd">            are meant to be isolated (e.g. records from different</span>
<span class="sd">            companies in multi-company environments).</span>

<span class="sd">            It may lead to un-intuitive results in methods which select one</span>
<span class="sd">            record among many - for example getting the default company, or</span>
<span class="sd">            selecting a Bill of Materials.</span>

<span class="sd">        .. note::</span>

<span class="sd">            The returned recordset has the same prefetch object as ``self``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">su</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_env</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="n">su</span><span class="o">=</span><span class="n">flag</span><span class="p">))</span></div>


<div class="viewcode-block" id="BaseModel.with_user">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.with_user">[docs]</a>
    <span class="k">def</span> <span class="nf">with_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; with_user(user)</span>

<span class="sd">        Return a new version of this recordset attached to the given user, in</span>
<span class="sd">        non-superuser mode, unless `user` is the superuser (by convention, the</span>
<span class="sd">        superuser is always in superuser mode.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_env</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">su</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span></div>


<div class="viewcode-block" id="BaseModel.with_company">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.with_company">[docs]</a>
    <span class="k">def</span> <span class="nf">with_company</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">company</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; with_company(company)</span>

<span class="sd">        Return a new version of this recordset with a modified context, such that::</span>

<span class="sd">            result.env.company = company</span>
<span class="sd">            result.env.companies = self.env.companies | company</span>

<span class="sd">        :param company: main company of the new environment.</span>
<span class="sd">        :type company: :class:`~odoo.addons.base.models.res_company` or int</span>

<span class="sd">        .. warning::</span>

<span class="sd">            When using an unauthorized company for current user,</span>
<span class="sd">            accessing the company(ies) on the environment may trigger</span>
<span class="sd">            an AccessError if not done in a sudoed environment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">company</span><span class="p">:</span>
            <span class="c1"># With company = None/False/0/[]/empty recordset: keep current environment</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="n">company_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">company</span><span class="p">)</span>
        <span class="n">allowed_company_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;allowed_company_ids&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">allowed_company_ids</span> <span class="ow">and</span> <span class="n">company_id</span> <span class="o">==</span> <span class="n">allowed_company_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="c1"># Copy the allowed_company_ids list</span>
        <span class="c1"># to avoid modifying the context of the current environment.</span>
        <span class="n">allowed_company_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">allowed_company_ids</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">company_id</span> <span class="ow">in</span> <span class="n">allowed_company_ids</span><span class="p">:</span>
            <span class="n">allowed_company_ids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">company_id</span><span class="p">)</span>
        <span class="n">allowed_company_ids</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">company_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">allowed_company_ids</span><span class="o">=</span><span class="n">allowed_company_ids</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseModel.with_context">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.with_context">[docs]</a>
    <span class="k">def</span> <span class="nf">with_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; with_context([context][, **overrides]) -&gt; Model</span>

<span class="sd">        Returns a new version of this recordset attached to an extended</span>
<span class="sd">        context.</span>

<span class="sd">        The extended context is either the provided ``context`` in which</span>
<span class="sd">        ``overrides`` are merged or the *current* context in which</span>
<span class="sd">        ``overrides`` are merged e.g.::</span>

<span class="sd">            # current context is {&#39;key1&#39;: True}</span>
<span class="sd">            r2 = records.with_context({}, key2=True)</span>
<span class="sd">            # -&gt; r2._context is {&#39;key2&#39;: True}</span>
<span class="sd">            r2 = records.with_context(key2=True)</span>
<span class="sd">            # -&gt; r2._context is {&#39;key1&#39;: True, &#39;key2&#39;: True}</span>

<span class="sd">        .. note:</span>

<span class="sd">            The returned recordset has the same prefetch object as ``self``.</span>
<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: RST210</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">args</span> <span class="ow">and</span> <span class="s1">&#39;force_company&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="s1">&#39;force_company&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Context key &#39;force_company&#39; is no longer supported. &quot;</span>
                <span class="s2">&quot;Use with_company(company) instead.&quot;</span><span class="p">,</span>
                <span class="n">stack_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">args</span> <span class="ow">and</span> <span class="s1">&#39;company&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="s1">&#39;company&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Context key &#39;company&#39; is not recommended, because &quot;</span>
                <span class="s2">&quot;of its special meaning in @depends_context.&quot;</span><span class="p">,</span>
                <span class="n">stack_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;allowed_company_ids&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">context</span> <span class="ow">and</span> <span class="s1">&#39;allowed_company_ids&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">:</span>
            <span class="c1"># Force &#39;allowed_company_ids&#39; to be kept when context is overridden</span>
            <span class="c1"># without &#39;allowed_company_ids&#39;</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;allowed_company_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">[</span><span class="s1">&#39;allowed_company_ids&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_env</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">))</span></div>


<div class="viewcode-block" id="BaseModel.with_prefetch">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.with_prefetch">[docs]</a>
    <span class="k">def</span> <span class="nf">with_prefetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefetch_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; with_prefetch([prefetch_ids]) -&gt; records</span>

<span class="sd">        Return a new version of this recordset that uses the given prefetch ids,</span>
<span class="sd">        or ``self``&#39;s ids if not given.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">prefetch_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prefetch_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">,</span> <span class="n">prefetch_ids</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_update_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Update the cache of ``self`` with ``values``.</span>

<span class="sd">            :param values: dict of field values, in any format.</span>
<span class="sd">            :param validate: whether values must be checked</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">field_values</span> <span class="o">=</span> <span class="p">[(</span><span class="n">fields</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid field </span><span class="si">%r</span><span class="s2"> on model </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span>

        <span class="c1"># convert monetary fields after other columns for correct value rounding</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">field_values</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">write_sequence</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_cache</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">check_dirty</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># set inverse fields on new records in the comodel</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">relational</span><span class="p">:</span>
                <span class="n">inv_recs</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">inv_recs</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># we need to adapt the value of the inverse fields to integrate self into it:</span>
                <span class="c1"># x2many fields should add self, while many2one fields should replace with self</span>
                <span class="k">for</span> <span class="n">invf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">field_inverses</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                    <span class="n">invf</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="n">inv_recs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_convert_to_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Convert the ``values`` dictionary from the cache format to the</span>
<span class="sd">        record format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">convert_to_record</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_convert_to_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Convert the ``values`` dictionary into the format of :meth:`write`. &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_write</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">NewId</span><span class="p">):</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="c1">#</span>
    <span class="c1"># Record traversal and update</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_mapped_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Apply function ``func`` on all records in ``self``, and return the</span>
<span class="sd">            result as a list or a recordset (if ``func`` returns recordsets).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">func</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">BaseModel</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="n">vals</span><span class="p">)</span>         <span class="c1"># union of all recordsets</span>
            <span class="k">return</span> <span class="n">vals</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">vals</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>

<div class="viewcode-block" id="BaseModel.mapped">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.mapped">[docs]</a>
    <span class="k">def</span> <span class="nf">mapped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply ``func`` on all records in ``self``, and return the result as a</span>
<span class="sd">        list or a recordset (if ``func`` return recordsets). In the latter</span>
<span class="sd">        case, the order of the returned recordset is arbitrary.</span>

<span class="sd">        :param func: a function or a dot-separated sequence of field names</span>
<span class="sd">        :type func: callable or str</span>
<span class="sd">        :return: self if func is falsy, result of func applied to all ``self`` records.</span>
<span class="sd">        :rtype: list or recordset</span>

<span class="sd">        .. code-block:: python3</span>

<span class="sd">            # returns a list of summing two fields for each record in the set</span>
<span class="sd">            records.mapped(lambda r: r.field1 + r.field2)</span>

<span class="sd">        The provided function can be a string to get field values:</span>

<span class="sd">        .. code-block:: python3</span>

<span class="sd">            # returns a list of names</span>
<span class="sd">            records.mapped(&#39;name&#39;)</span>

<span class="sd">            # returns a recordset of partners</span>
<span class="sd">            records.mapped(&#39;partner_id&#39;)</span>

<span class="sd">            # returns the union of all partner banks, with duplicates removed</span>
<span class="sd">            records.mapped(&#39;partner_id.bank_ids&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">func</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>                 <span class="c1"># support for an empty path of fields</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">recs</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                <span class="n">recs</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="n">recs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">recs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapped_func</span><span class="p">(</span><span class="n">func</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseModel.filtered">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.filtered">[docs]</a>
    <span class="k">def</span> <span class="nf">filtered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the records in ``self`` satisfying ``func``.</span>

<span class="sd">        :param func: a function or a dot-separated sequence of field names</span>
<span class="sd">        :type func: callable or str</span>
<span class="sd">        :return: recordset of records satisfying func, may be empty.</span>

<span class="sd">        .. code-block:: python3</span>

<span class="sd">            # only keep records whose company is the current user&#39;s</span>
<span class="sd">            records.filtered(lambda r: r.company_id == user.company_id)</span>

<span class="sd">            # only keep records whose partner is a company</span>
<span class="sd">            records.filtered(&quot;partner_id.is_company&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">func</span>
            <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">rec</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">([</span><span class="n">rec</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">func</span><span class="p">(</span><span class="n">rec</span><span class="p">)])</span></div>


<div class="viewcode-block" id="BaseModel.grouped">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.grouped">[docs]</a>
    <span class="k">def</span> <span class="nf">grouped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Eagerly groups the records of ``self`` by the ``key``, returning a</span>
<span class="sd">        dict from the ``key``&#39;s result to recordsets. All the resulting</span>
<span class="sd">        recordsets are guaranteed to be part of the same prefetch-set.</span>

<span class="sd">        Provides a convenience method to partition existing recordsets without</span>
<span class="sd">        the overhead of a :meth:`~.read_group`, but performs no aggregation.</span>

<span class="sd">        .. note:: unlike :func:`itertools.groupby`, does not care about input</span>
<span class="sd">                  ordering, however the tradeoff is that it can not be lazy</span>

<span class="sd">        :param key: either a callable from a :class:`Model` to a (hashable)</span>
<span class="sd">                    value, or a field name. In the latter case, it is equivalent</span>
<span class="sd">                    to ``itemgetter(key)`` (aka the named field&#39;s value)</span>
<span class="sd">        :type key: callable | str</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">itemgetter</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="n">collator</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">collator</span><span class="p">[</span><span class="n">key</span><span class="p">(</span><span class="n">record</span><span class="p">)]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>

        <span class="n">browse</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">prefetch_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_ids</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">browse</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">collator</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span></div>


<div class="viewcode-block" id="BaseModel.filtered_domain">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.filtered_domain">[docs]</a>
    <span class="k">def</span> <span class="nf">filtered_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the records in ``self`` satisfying the domain and keeping the same order.</span>

<span class="sd">        :param domain: :ref:`A search domain &lt;reference/orm/domains&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">domain</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">leaf</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">domain</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">leaf</span> <span class="o">==</span> <span class="s1">&#39;|&#39;</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="o">|</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">leaf</span> <span class="o">==</span> <span class="s1">&#39;!&#39;</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span> <span class="o">-</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">leaf</span> <span class="o">==</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">leaf</span> <span class="o">==</span> <span class="n">expression</span><span class="o">.</span><span class="n">TRUE_LEAF</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">leaf</span> <span class="o">==</span> <span class="n">expression</span><span class="o">.</span><span class="n">FALSE_LEAF</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">comparator</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">=</span> <span class="n">leaf</span>
                <span class="k">if</span> <span class="n">comparator</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;child_of&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_of&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;company_id&#39;</span><span class="p">:</span>  <span class="c1"># avoid an explicit search</span>
                        <span class="n">value_companies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s1">&#39;child_of&#39;</span><span class="p">:</span>
                            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">record</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">company_id</span><span class="o">.</span><span class="n">parent_ids</span> <span class="o">&amp;</span> <span class="n">value_companies</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">record</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">company_id</span> <span class="o">&amp;</span> <span class="n">value_companies</span><span class="o">.</span><span class="n">parent_ids</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="n">leaf</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_ids</span><span class="p">))</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.id&#39;</span><span class="p">):</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                <span class="c1"># determine the field with the final type for values</span>
                <span class="n">field</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                        <span class="n">field</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span>
                        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">comparator</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;ilike&#39;</span><span class="p">,</span> <span class="s1">&#39;=like&#39;</span><span class="p">,</span> <span class="s1">&#39;=ilike&#39;</span><span class="p">,</span> <span class="s1">&#39;not ilike&#39;</span><span class="p">,</span> <span class="s1">&#39;not like&#39;</span><span class="p">):</span>
                    <span class="n">value_esc</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">comparator</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,)</span>
                    <span class="k">if</span> <span class="n">field</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="p">{</span><span class="n">Datetime</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">}</span>
                <span class="k">elif</span> <span class="n">field</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">Datetime</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="n">matching_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="ow">and</span> <span class="n">comparator</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;any&#39;</span><span class="p">,</span> <span class="s1">&#39;not any&#39;</span><span class="p">):</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">))</span> <span class="ow">and</span> <span class="n">value</span><span class="p">:</span>
                            <span class="n">v</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;display_name&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">ids</span> <span class="ow">or</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">field</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">):</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">Datetime</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s1">&#39;=&#39;</span><span class="p">:</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span>
                    <span class="k">elif</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s1">&#39;!=&#39;</span><span class="p">:</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span>
                    <span class="k">elif</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s1">&#39;=?&#39;</span><span class="p">:</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">or</span> <span class="p">(</span><span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s1">&#39;in&#39;</span><span class="p">:</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="n">value</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">value</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s1">&#39;not in&#39;</span><span class="p">:</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="n">value</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">value</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">value</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">value</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">:</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">:</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">value</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s1">&#39;ilike&#39;</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">value_esc</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s1">&#39;not ilike&#39;</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s1">&#39;like&#39;</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">value</span> <span class="ow">and</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span> <span class="n">value_esc</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s1">&#39;not like&#39;</span><span class="p">:</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="n">x</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s1">&#39;=like&#39;</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">value_esc</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s1">&#39;=ilike&#39;</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value_esc</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="k">elif</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s1">&#39;any&#39;</span><span class="p">:</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">comparator</span> <span class="o">==</span> <span class="s1">&#39;not any&#39;</span><span class="p">:</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid term domain &#39;</span><span class="si">{</span><span class="n">leaf</span><span class="si">}</span><span class="s2">&#39;, operator &#39;</span><span class="si">{</span><span class="n">comparator</span><span class="si">}</span><span class="s2">&#39; doesn&#39;t exist.&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                        <span class="n">matching_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matching_ids</span><span class="p">)</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>

        <span class="p">[</span><span class="n">result_ids</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">id_</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span> <span class="k">if</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">result_ids</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseModel.sorted">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.sorted">[docs]</a>
    <span class="k">def</span> <span class="nf">sorted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the recordset ``self`` ordered by ``key``.</span>

<span class="sd">        :param key: either a function of one argument that returns a</span>
<span class="sd">            comparison key for each record, or a field name, or ``None``, in</span>
<span class="sd">            which case records are ordered according the default model&#39;s order</span>
<span class="sd">        :type key: callable or str or None</span>
<span class="sd">        :param bool reverse: if ``True``, return the result in reverse order</span>

<span class="sd">        .. code-block:: python3</span>

<span class="sd">            # sort records by name</span>
<span class="sd">            records.sorted(key=lambda r: r.name)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">):</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span><span class="o">.</span><span class="n">_ids</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Don&#39;t support new ids because search() doesn&#39;t work on new records</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span> <span class="k">if</span> <span class="n">reverse</span> <span class="k">else</span> <span class="n">ids</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">itemgetter</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_ids</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseModel.update">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.update">[docs]</a>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Update the records in ``self`` with ``values``. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="BaseModel.flush_model">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.flush_model">[docs]</a>
    <span class="k">def</span> <span class="nf">flush_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Process the pending computations and database updates on ``self``&#39;s</span>
<span class="sd">        model.  When the parameter is given, the method guarantees that at least</span>
<span class="sd">        the given fields are flushed to the database.  More fields can be</span>
<span class="sd">        flushed, though.</span>

<span class="sd">        :param fnames: optional iterable of field names to flush</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_model</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_flush</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseModel.flush_recordset">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.flush_recordset">[docs]</a>
    <span class="k">def</span> <span class="nf">flush_recordset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Process the pending computations and database updates on the records</span>
<span class="sd">        ``self``.   When the parameter is given, the method guarantees that at</span>
<span class="sd">        least the given fields on records ``self`` are flushed to the database.</span>
<span class="sd">        More fields and records can be flushed, though.</span>

<span class="sd">        :param fnames: optional iterable of field names to flush</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_recordset</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span>
        <span class="n">fields_</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">fnames</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">has_dirty_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields_</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_flush</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">id_vals</span><span class="p">):</span>
            <span class="c1"># group record ids by vals, to update in batch when possible</span>
            <span class="n">updates</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">id_vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">updates</span><span class="p">[</span><span class="n">frozendict</span><span class="p">(</span><span class="n">vals</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">vals</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">updates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">model</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

        <span class="c1"># DLE P76: test_onchange_one2many_with_domain_on_related_field</span>
        <span class="c1"># ```</span>
        <span class="c1"># email.important = True</span>
        <span class="c1"># self.assertIn(email, discussion.important_emails)</span>
        <span class="c1"># ```</span>
        <span class="c1"># When a search on a field coming from a related occurs (the domain</span>
        <span class="c1"># on discussion.important_emails field), make sure the related field</span>
        <span class="c1"># is flushed</span>
        <span class="k">if</span> <span class="n">fnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">]</span>

        <span class="n">model_fields</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">model_fields</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">related_field</span><span class="p">:</span>
                <span class="n">model_fields</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">related_field</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">related_field</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">fields_</span> <span class="ow">in</span> <span class="n">model_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">dirty_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get_dirty_fields</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">field</span> <span class="ow">in</span> <span class="n">dirty_fields</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields_</span><span class="p">):</span>
                <span class="c1"># if any field is context-dependent, the values to flush should</span>
                <span class="c1"># be found with a context where the context keys are all None</span>
                <span class="n">context_none</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span>
                    <span class="n">key</span>
                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields_</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">field_depends_context</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context_none</span><span class="p">)[</span><span class="n">model_name</span><span class="p">]</span>
                <span class="n">id_vals</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">clear_dirty_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">records</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">),</span> \
                        <span class="sa">f</span><span class="s2">&quot;Could not find all values of </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> to flush them</span><span class="se">\n</span><span class="s2">&quot;</span> \
                        <span class="sa">f</span><span class="s2">&quot;    Context: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> \
                        <span class="sa">f</span><span class="s2">&quot;    Cache: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="si">!r}</span><span class="s2">&quot;</span>
                    <span class="k">for</span> <span class="n">record</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_write</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_column</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">_convert_from_cache_to_column</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="n">id_vals</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">][</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">process</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">id_vals</span><span class="p">)</span>

        <span class="c1"># flush the inverse of one2many fields, too</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;one2many&#39;</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">inverse_name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span><span class="o">.</span><span class="n">flush_model</span><span class="p">([</span><span class="n">field</span><span class="o">.</span><span class="n">inverse_name</span><span class="p">])</span>

    <span class="c1">#</span>
    <span class="c1"># New records - represent records that do not exist in the database yet;</span>
    <span class="c1"># they are used to perform onchanges.</span>
    <span class="c1">#</span>

<div class="viewcode-block" id="BaseModel.new">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.new">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; new([values], [origin], [ref]) -&gt; record</span>

<span class="sd">        Return a new record instance attached to the current environment and</span>
<span class="sd">        initialized with the provided ``value``. The record is *not* created</span>
<span class="sd">        in database, it only exists in memory.</span>

<span class="sd">        One can pass an ``origin`` record, which is the actual record behind the</span>
<span class="sd">        result. It is retrieved as ``record._origin``. Two new records with the</span>
<span class="sd">        same origin record are considered equal.</span>

<span class="sd">        One can also pass a ``ref`` value to identify the record among other new</span>
<span class="sd">        records. The reference is encapsulated in the ``id`` of the record.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">id</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">((</span><span class="n">NewId</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">ref</span><span class="p">),))</span>
        <span class="n">record</span><span class="o">.</span><span class="n">_update_cache</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">record</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the actual records corresponding to ``self``. &quot;&quot;&quot;</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">origin_ids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">))</span>
        <span class="n">prefetch_ids</span> <span class="o">=</span> <span class="n">OriginIds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_ids</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">prefetch_ids</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># &quot;Dunder&quot; methods</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Test whether ``self`` is nonempty. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span> <span class="k">else</span> <span class="kc">False</span>  <span class="c1"># fast version of bool(self._ids)</span>

    <span class="n">__nonzero__</span> <span class="o">=</span> <span class="fm">__bool__</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the size of ``self``. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return an iterator over ``self``. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">PREFETCH_MAX</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_ids</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ids</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">split_for_in_conditions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="p">(</span><span class="n">id_</span><span class="p">,),</span> <span class="n">ids</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="p">(</span><span class="n">id_</span><span class="p">,),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_ids</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__reversed__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return an reversed iterator over ``self``. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">PREFETCH_MAX</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_ids</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ids</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">split_for_in_conditions</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="p">(</span><span class="n">id_</span><span class="p">,),</span> <span class="n">ids</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">:</span>
            <span class="n">prefetch_ids</span> <span class="o">=</span> <span class="n">ReversedIterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_ids</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">):</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="p">(</span><span class="n">id_</span><span class="p">,),</span> <span class="n">prefetch_ids</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Test whether ``item`` (record or field name) is an element of ``self``.</span>
<span class="sd">            In the first case, the test is fully equivalent to::</span>

<span class="sd">                any(item == record for record in self)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inconsistent models in: </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unsupported operand types in: </span><span class="si">{</span><span class="n">item</span><span class="si">!r}</span><span class="s2"> in </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the concatenation of two recordsets. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

<div class="viewcode-block" id="BaseModel.concat">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.concat">[docs]</a>
    <span class="k">def</span> <span class="nf">concat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the concatenation of ``self`` with all the arguments (in</span>
<span class="sd">            linear time complexity).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">_name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inconsistent models in: </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> + </span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unsupported operand types in: </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> + </span><span class="si">{</span><span class="n">arg</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the recordset of all the records in ``self`` that are not in</span>
<span class="sd">            ``other``. Note that recordset order is preserved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inconsistent models in: </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">other</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">other_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">([</span><span class="nb">id</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span> <span class="k">if</span> <span class="nb">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other_ids</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unsupported operand types in: </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">other</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__and__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the intersection of two recordsets.</span>
<span class="sd">            Note that first occurrence order is preserved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inconsistent models in: </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> &amp; </span><span class="si">{</span><span class="n">other</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">other_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">OrderedSet</span><span class="p">(</span><span class="nb">id</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span> <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">other_ids</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unsupported operand types in: </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> &amp; </span><span class="si">{</span><span class="n">other</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__or__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the union of two recordsets.</span>
<span class="sd">            Note that first occurrence order is preserved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

<div class="viewcode-block" id="BaseModel.union">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.union">[docs]</a>
    <span class="k">def</span> <span class="nf">union</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the union of ``self`` with all the arguments (in linear time</span>
<span class="sd">            complexity, with first occurrence order preserved).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">_name</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inconsistent models in: </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unsupported operand types in: </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">arg</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">OrderedSet</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span></div>


    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Test whether two recordsets are equivalent (up to reordering). &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_name</span> <span class="ow">and</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">other</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unsupported operand type(s) for </span><span class="se">\&quot;</span><span class="s2">==</span><span class="se">\&quot;</span><span class="s2">: &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="si">}</span><span class="s2">()&#39; == &#39;</span><span class="si">{</span><span class="n">other</span><span class="si">!r}</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="fm">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
                <span class="c1"># these are much cheaper checks than a proper subset check, so</span>
                <span class="c1"># optimise for checking if a null or singleton are subsets of a</span>
                <span class="c1"># recordset</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span> <span class="ow">or</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">other</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="fm">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">other</span> <span class="ow">or</span> <span class="n">other</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="fm">__int__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">or</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="si">!r}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)))</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; If ``key`` is an integer or a slice, return the corresponding record</span>
<span class="sd">            selection as an instance (attached to ``self.env``).</span>
<span class="sd">            Otherwise read the field ``key`` of the first record in ``self``.</span>

<span class="sd">            Examples::</span>

<span class="sd">                inst = model.search(dom)    # inst is a recordset</span>
<span class="sd">                r4 = inst[3]                # fourth record in inst</span>
<span class="sd">                rs = inst[10:20]            # subset of inst</span>
<span class="sd">                nm = rs[&#39;name&#39;]             # name of first record in inst</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># important: one must call the field&#39;s getter</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">[</span><span class="n">key</span><span class="p">],))</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Assign the field ``key`` to ``value`` in record ``self``. &quot;&quot;&quot;</span>
        <span class="c1"># important: one must call the field&#39;s setter</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Cache and recomputation management</span>
    <span class="c1">#</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the cache of ``self``, mapping field names to values. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">RecordCache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_in_cache_without</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">PREFETCH_MAX</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return records to prefetch that have no value in cache for ``field``</span>
<span class="sd">            (:class:`Field` instance), including ``self``.</span>
<span class="sd">            Return at most ``limit`` records.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">expand_ids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_ids</span><span class="p">)</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get_missing_ids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">limit</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">islice</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
        <span class="c1"># Those records are aimed at being either fetched, or computed.  But the</span>
        <span class="c1"># method &#39;_fetch_field&#39; is not correct with new records: it considers</span>
        <span class="c1"># them as forbidden records, and clears their cache!  On the other hand,</span>
        <span class="c1"># compute methods are not invoked with a mix of real and new records for</span>
        <span class="c1"># the sake of code simplicity.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>

<div class="viewcode-block" id="BaseModel.invalidate_model">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.invalidate_model">[docs]</a>
    <span class="k">def</span> <span class="nf">invalidate_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Invalidate the cache of all records of ``self``&#39;s model, when the</span>
<span class="sd">        cached values no longer correspond to the database values.  If the</span>
<span class="sd">        parameter is given, only the given fields are invalidated from cache.</span>

<span class="sd">        :param fnames: optional iterable of field names to invalidate</span>
<span class="sd">        :param flush: whether pending updates should be flushed before invalidation.</span>
<span class="sd">            It is ``True`` by default, which ensures cache consistency.</span>
<span class="sd">            Do not use this parameter unless you know what you are doing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">flush</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush_model</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_invalidate_cache</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseModel.invalidate_recordset">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.invalidate_recordset">[docs]</a>
    <span class="k">def</span> <span class="nf">invalidate_recordset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Invalidate the cache of the records in ``self``, when the cached</span>
<span class="sd">        values no longer correspond to the database values.  If the parameter</span>
<span class="sd">        is given, only the given fields on ``self`` are invalidated from cache.</span>

<span class="sd">        :param fnames: optional iterable of field names to invalidate</span>
<span class="sd">        :param flush: whether pending updates should be flushed before invalidation.</span>
<span class="sd">            It is ``True`` by default, which ensures cache consistency.</span>
<span class="sd">            Do not use this parameter unless you know what you are doing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">flush</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush_recordset</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_invalidate_cache</span><span class="p">(</span><span class="n">fnames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_invalidate_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">]</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field</span><span class="p">,</span> <span class="n">ids</span><span class="p">))</span>
            <span class="c1"># TODO VSC: used to remove the inverse of many_to_one from the cache, though we might not need it anymore</span>
            <span class="k">for</span> <span class="n">invf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">field_inverses</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">invf</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">flush_model</span><span class="p">([</span><span class="n">invf</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">invf</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

<div class="viewcode-block" id="BaseModel.modified">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.modified">[docs]</a>
    <span class="k">def</span> <span class="nf">modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnames</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Notify that fields will be or have been modified on ``self``. This</span>
<span class="sd">        invalidates the cache where necessary, and prepares the recomputation of</span>
<span class="sd">        dependent stored fields.</span>

<span class="sd">        :param fnames: iterable of field names modified on records ``self``</span>
<span class="sd">        :param create: whether called in the context of record creation</span>
<span class="sd">        :param before: whether called before modifying records ``self``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">fnames</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># The triggers of a field F is a tree that contains the fields that</span>
        <span class="c1"># depend on F, together with the fields to inverse to find out which</span>
        <span class="c1"># records to recompute.</span>
        <span class="c1">#</span>
        <span class="c1"># For instance, assume that G depends on F, H depends on X.F, I depends</span>
        <span class="c1"># on W.X.F, and J depends on Y.F. The triggers of F will be the tree:</span>
        <span class="c1">#</span>
        <span class="c1">#                              [G]</span>
        <span class="c1">#                            X/   \Y</span>
        <span class="c1">#                          [H]     [J]</span>
        <span class="c1">#                        W/</span>
        <span class="c1">#                      [I]</span>
        <span class="c1">#</span>
        <span class="c1"># This tree provides perfect support for the trigger mechanism:</span>
        <span class="c1"># when F is # modified on records,</span>
        <span class="c1">#  - mark G to recompute on records,</span>
        <span class="c1">#  - mark H to recompute on inverse(X, records),</span>
        <span class="c1">#  - mark I to recompute on inverse(W, inverse(X, records)),</span>
        <span class="c1">#  - mark J to recompute on inverse(Y, records).</span>

        <span class="k">if</span> <span class="n">before</span><span class="p">:</span>
            <span class="c1"># When called before modification, we should determine what</span>
            <span class="c1"># currently depends on self, and it should not be recomputed before</span>
            <span class="c1"># the modification.  So we only collect what should be marked for</span>
            <span class="c1"># recomputation.</span>
            <span class="n">marked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">tocompute</span>     <span class="c1"># {field: ids}</span>
            <span class="n">tomark</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">OrderedSet</span><span class="p">)</span>    <span class="c1"># {field: ids}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># When called after modification, one should traverse backwards</span>
            <span class="c1"># dependencies by taking into account all fields already known to</span>
            <span class="c1"># be recomputed.  In that case, we mark fieds to compute as soon as</span>
            <span class="c1"># possible.</span>
            <span class="n">marked</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">tomark</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">tocompute</span>

        <span class="c1"># determine what to trigger (with iterators)</span>
        <span class="n">todo</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_modified</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">],</span> <span class="n">create</span><span class="p">)]</span>

        <span class="c1"># process what to trigger by lazily chaining todo</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">records</span><span class="p">,</span> <span class="n">create</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">todo</span><span class="p">):</span>
            <span class="n">records</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">protected</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">records</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">recursive</span><span class="p">:</span>
                <span class="c1"># discard already processed records, in order to avoid cycles</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">compute</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
                    <span class="n">ids</span> <span class="o">=</span> <span class="p">(</span><span class="n">marked</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">set</span><span class="p">())</span> <span class="o">|</span> <span class="p">(</span><span class="n">tomark</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">set</span><span class="p">())</span>
                    <span class="n">records</span> <span class="o">=</span> <span class="n">records</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">id_</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">records</span><span class="o">.</span><span class="n">_ids</span> <span class="k">if</span> <span class="n">id_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">records</span> <span class="o">=</span> <span class="n">records</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get_records</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">all_contexts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">records</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># recursively trigger recomputation of field&#39;s dependents</span>
                <span class="n">todo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">_modified</span><span class="p">([</span><span class="n">field</span><span class="p">],</span> <span class="n">create</span><span class="p">))</span>

            <span class="c1"># mark for recomputation (now or later, depending on &#39;before&#39;)</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">compute</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
                <span class="n">tomark</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Don&#39;t force the recomputation of compute fields which are</span>
                <span class="c1"># not stored as this is not really necessary.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">([(</span><span class="n">field</span><span class="p">,</span> <span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">)])</span>

        <span class="k">if</span> <span class="n">before</span><span class="p">:</span>
            <span class="c1"># effectively mark for recomputation now</span>
            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">tomark</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">add_to_compute</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">records</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">create</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return an iterator traversing a tree of field triggers on ``self``,</span>
<span class="sd">        traversing backwards field dependencies along the way, and yielding</span>
<span class="sd">        tuple ``(field, records, created)`` to recompute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span>

        <span class="c1"># The fields&#39; trigger trees are merged in order to evaluate all triggers</span>
        <span class="c1"># at once. For non-stored computed fields, `_modified_triggers` might</span>
        <span class="c1"># traverse the tree (at the cost of extra queries) only to know which</span>
        <span class="c1"># records to invalidate in cache. But in many cases, most of these</span>
        <span class="c1"># fields have no data in cache, so they can be ignored from the start.</span>
        <span class="c1"># This allows us to discard subtrees from the merged tree when they</span>
        <span class="c1"># only contain such fields.</span>
        <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">compute</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cache</span><span class="o">.</span><span class="n">contains_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get_trigger_tree</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="n">select</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tree</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">_modified_triggers</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">create</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_modified_triggers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return an iterator traversing a tree of field triggers on ``self``,</span>
<span class="sd">        traversing backwards field dependencies along the way, and yielding</span>
<span class="sd">        tuple ``(field, records, created)`` to recompute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># first yield what to compute</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">field</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">create</span>

        <span class="c1"># then traverse dependencies backwards, and proceed recursively</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">subtree</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">create</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;many2one&#39;</span><span class="p">,</span> <span class="s1">&#39;many2one_reference&#39;</span><span class="p">):</span>
                <span class="c1"># upon creation, no other record has a reference to self</span>
                <span class="k">continue</span>

            <span class="c1"># subtree is another tree of dependencies</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">invf</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">field_inverses</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                <span class="c1"># use an inverse of field without domain</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">invf</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;one2many&#39;</span><span class="p">,</span> <span class="s1">&#39;many2many&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">invf</span><span class="o">.</span><span class="n">domain</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">invf</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2one_reference&#39;</span><span class="p">:</span>
                        <span class="n">rec_ids</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">rec</span><span class="p">[</span><span class="n">invf</span><span class="o">.</span><span class="n">model_field</span><span class="p">]</span> <span class="o">==</span> <span class="n">field</span><span class="o">.</span><span class="n">model_name</span><span class="p">:</span>
                                    <span class="n">rec_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="n">invf</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
                            <span class="k">except</span> <span class="n">MissingError</span><span class="p">:</span>
                                <span class="k">continue</span>
                        <span class="n">records</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">rec_ids</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">invf</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                        <span class="k">except</span> <span class="n">MissingError</span><span class="p">:</span>
                            <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">()[</span><span class="n">invf</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

                    <span class="c1"># TODO: find a better fix</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="n">records</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">):</span>
                            <span class="c1"># if self are new, records should be new as well</span>
                            <span class="n">records</span> <span class="o">=</span> <span class="n">records</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">it</span> <span class="ow">and</span> <span class="n">NewId</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
                        <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">real_records</span> <span class="o">=</span> <span class="bp">self</span> <span class="o">-</span> <span class="n">new_records</span>
                <span class="n">records</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">browse</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">real_records</span><span class="p">:</span>
                    <span class="n">records</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">real_records</span><span class="o">.</span><span class="n">ids</span><span class="p">)],</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_records</span><span class="p">:</span>
                    <span class="n">cache_records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get_records</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                    <span class="n">records</span> <span class="o">|=</span> <span class="n">cache_records</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">))</span>

            <span class="k">yield from</span> <span class="n">records</span><span class="o">.</span><span class="n">_modified_triggers</span><span class="p">(</span><span class="n">subtree</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_recompute_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Process the pending computations of the fields of ``self``&#39;s model.</span>

<span class="sd">        :param fnames: optional iterable of field names to compute</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">compute</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_recompute_recordset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Process the pending computations of the fields of the records in ``self``.</span>

<span class="sd">        :param fnames: optional iterable of field names to compute</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">compute</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_field</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_recompute_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ids_to_compute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">tocompute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">())</span>
        <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">ids_to_compute</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">id_</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">ids</span> <span class="k">if</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">ids_to_compute</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># do not force recomputation on new records; those will be</span>
        <span class="c1"># recomputed by accessing the field on the records</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">id_</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">ids</span> <span class="k">if</span> <span class="n">id_</span><span class="p">))</span>
        <span class="n">field</span><span class="o">.</span><span class="n">recompute</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Generic onchange method</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_has_onchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">other_fields</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return whether ``field`` should trigger an onchange event in the</span>
<span class="sd">            presence of ``other_fields``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onchange_methods</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">dep</span> <span class="ow">in</span> <span class="n">other_fields</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get_dependent_fields</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">base_field</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_apply_onchange_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Apply onchange method(s) for field ``field_name`` on ``self``. Value</span>
<span class="sd">            assignments are applied on ``self``, while warning messages are put</span>
<span class="sd">            in dictionary ``result``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onchange_methods</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="p">()):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;warning&#39;</span><span class="p">):</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">((</span>
                    <span class="n">res</span><span class="p">[</span><span class="s1">&#39;warning&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Warning&quot;</span><span class="p">),</span>
                    <span class="n">res</span><span class="p">[</span><span class="s1">&#39;warning&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">res</span><span class="p">[</span><span class="s1">&#39;warning&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="p">))</span>

<div class="viewcode-block" id="BaseModel.onchange">
<a class="viewcode-back" href="../../odoo.html#odoo.models.BaseModel.onchange">[docs]</a>
    <span class="k">def</span> <span class="nf">onchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">field_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">fields_spec</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;onchange() is implemented in module &#39;web&#39;&quot;</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_get_placeholder_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Returns the filename of the placeholder to use,</span>
<span class="sd">            set on web/static/img by default, or the</span>
<span class="sd">            complete path to access it (eg: module/path/to/image.png).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_populate_factories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generates a factory for the different fields of the model.</span>

<span class="sd">        ``factory`` is a generator of values (dict of field values).</span>

<span class="sd">        Factory skeleton::</span>

<span class="sd">            def generator(iterator, field_name, model_name):</span>
<span class="sd">                for counter, values in enumerate(iterator):</span>
<span class="sd">                    # values.update(dict())</span>
<span class="sd">                    yield values</span>

<span class="sd">        See :mod:`odoo.tools.populate` for population tools and applications.</span>

<span class="sd">        :returns: list of pairs(field_name, factory) where `factory` is a generator function.</span>
<span class="sd">        :rtype: list(tuple(str, generator))</span>

<span class="sd">        .. note::</span>

<span class="sd">            It is the responsibility of the generator to handle the field_name correctly.</span>
<span class="sd">            The generator could generate values for multiple fields together. In this case,</span>
<span class="sd">            the field_name should be more a &quot;field_group&quot; (should be begin by a &quot;_&quot;), covering</span>
<span class="sd">            the different fields updated by the generator (e.g. &quot;_address&quot; for a generator</span>
<span class="sd">            updating multiple address fields).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_populate_sizes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return a dict mapping symbolic sizes (``&#39;small&#39;``, ``&#39;medium&#39;``, ``&#39;large&#39;``) to integers,</span>
<span class="sd">        giving the minimal number of records that :meth:`_populate` should create.</span>

<span class="sd">        The default population sizes are:</span>

<span class="sd">        * ``small`` : 10</span>
<span class="sd">        * ``medium`` : 100</span>
<span class="sd">        * ``large`` : 1000</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;small&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>  <span class="c1"># minimal representative set</span>
            <span class="s1">&#39;medium&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>  <span class="c1"># average database load</span>
            <span class="s1">&#39;large&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="c1"># maxi database load</span>
        <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_populate_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the list of models which have to be populated before the current one.</span>

<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_populate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Create records to populate this model.</span>

<span class="sd">        :param str size: symbolic size for the number of records: ``&#39;small&#39;``, ``&#39;medium&#39;`` or ``&#39;large&#39;``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="n">min_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_populate_sizes</span><span class="p">[</span><span class="n">size</span><span class="p">]</span>

        <span class="n">record_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">create_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">complete</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">field_generators</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_populate_factories</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field_generators</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">()</span> <span class="c1"># maybe create an automatic generator?</span>

        <span class="n">records_batches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">populate</span><span class="o">.</span><span class="n">chain_factories</span><span class="p">(</span><span class="n">field_generators</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">record_count</span> <span class="o">&lt;=</span> <span class="n">min_size</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">complete</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
            <span class="n">complete</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__complete&#39;</span><span class="p">)</span>
            <span class="n">create_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="n">record_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">create_values</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">batch_size</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Batch: </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">record_count</span><span class="p">,</span> <span class="n">min_size</span><span class="p">)</span>
                <span class="n">records_batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">create_values</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="n">create_values</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">create_values</span><span class="p">:</span>
            <span class="n">records_batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">create_values</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="o">*</span><span class="n">records_batches</span><span class="p">)</span></div>



<span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Set</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">)</span>
<span class="c1"># not exactly true as BaseModel doesn&#39;t have index or count</span>
<span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">)</span>

<div class="viewcode-block" id="RecordCache">
<a class="viewcode-back" href="../../odoo.html#odoo.models.RecordCache">[docs]</a>
<span class="k">class</span> <span class="nc">RecordCache</span><span class="p">(</span><span class="n">MutableMapping</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; A mapping from field names to values, to read and update the cache of a record. &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_record&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Unexpected RecordCache(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">record</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record</span> <span class="o">=</span> <span class="n">record</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return whether `record` has a cached value for field ``name``. &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the cached value of field ``name`` for `record`. &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Assign the cached value of field ``name`` for ``record``. &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Remove the cached value of field ``name`` for ``record``. &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Iterate over the field names with a cached value. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the number of fields with a cached value. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span></div>



<span class="n">AbstractModel</span> <span class="o">=</span> <span class="n">BaseModel</span>

<div class="viewcode-block" id="Model">
<a class="viewcode-back" href="../../odoo.html#odoo.models.Model">[docs]</a>
<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">AbstractModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Main super-class for regular database-persisted Odoo models.</span>

<span class="sd">    Odoo models are created by inheriting from this class::</span>

<span class="sd">        class user(Model):</span>
<span class="sd">            ...</span>

<span class="sd">    The system will later instantiate the class once per database (on</span>
<span class="sd">    which the class&#39; module is installed).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_auto</span> <span class="o">=</span> <span class="kc">True</span>                <span class="c1"># automatically create database backend</span>
    <span class="n">_register</span> <span class="o">=</span> <span class="kc">False</span>           <span class="c1"># not visible in ORM registry, meant to be python-inherited only</span>
    <span class="n">_abstract</span> <span class="o">=</span> <span class="kc">False</span>           <span class="c1"># not abstract</span>
    <span class="n">_transient</span> <span class="o">=</span> <span class="kc">False</span>          <span class="c1"># not transient</span></div>


<div class="viewcode-block" id="TransientModel">
<a class="viewcode-back" href="../../odoo.html#odoo.models.TransientModel">[docs]</a>
<span class="k">class</span> <span class="nc">TransientModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Model super-class for transient records, meant to be temporarily</span>
<span class="sd">    persistent, and regularly vacuum-cleaned.</span>

<span class="sd">    A TransientModel has a simplified access rights management, all users can</span>
<span class="sd">    create new records, and may only access the records they created. The</span>
<span class="sd">    superuser has unrestricted access to all TransientModel records.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_auto</span> <span class="o">=</span> <span class="kc">True</span>                <span class="c1"># automatically create database backend</span>
    <span class="n">_register</span> <span class="o">=</span> <span class="kc">False</span>           <span class="c1"># not visible in ORM registry, meant to be python-inherited only</span>
    <span class="n">_abstract</span> <span class="o">=</span> <span class="kc">False</span>           <span class="c1"># not abstract</span>
    <span class="n">_transient</span> <span class="o">=</span> <span class="kc">True</span>           <span class="c1"># transient</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">autovacuum</span>
    <span class="k">def</span> <span class="nf">_transient_vacuum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean the transient records.</span>

<span class="sd">        This unlinks old records from the transient model tables whenever the</span>
<span class="sd">        :attr:`_transient_max_count` or :attr:`_transient_max_hours` conditions</span>
<span class="sd">        (if any) are reached.</span>

<span class="sd">        Actual cleaning will happen only once every 5 minutes. This means this</span>
<span class="sd">        method can be called frequently (e.g. whenever a new record is created).</span>

<span class="sd">        Example with both max_hours and max_count active:</span>

<span class="sd">        Suppose max_hours = 0.2 (aka 12 minutes), max_count = 20, there are</span>
<span class="sd">        55 rows in the table, 10 created/changed in the last 5 minutes, an</span>
<span class="sd">        additional 12 created/changed between 5 and 10 minutes ago, the rest</span>
<span class="sd">        created/changed more than 12 minutes ago.</span>

<span class="sd">        - age based vacuum will leave the 22 rows created/changed in the last 12</span>
<span class="sd">          minutes</span>
<span class="sd">        - count based vacuum will wipe out another 12 rows. Not just 2,</span>
<span class="sd">          otherwise each addition would immediately cause the maximum to be</span>
<span class="sd">          reached again.</span>
<span class="sd">        - the 10 rows that have been created/changed the last 5 minutes will NOT</span>
<span class="sd">          be deleted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transient_max_hours</span><span class="p">:</span>
            <span class="c1"># Age-based expiration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transient_clean_rows_older_than</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transient_max_hours</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transient_max_count</span><span class="p">:</span>
            <span class="c1"># Count-based expiration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transient_clean_old_rows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transient_max_count</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_transient_clean_old_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_count</span><span class="p">):</span>
        <span class="c1"># Check how many rows we have in the table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;SELECT count(*) FROM </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)))</span>
        <span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">max_count</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transient_clean_rows_older_than</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_transient_clean_rows_older_than</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds</span><span class="p">):</span>
        <span class="c1"># Never delete rows used in last 5 minutes</span>
        <span class="n">seconds</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span>
            <span class="s2">&quot;SELECT id FROM </span><span class="si">%s</span><span class="s2"> WHERE </span><span class="si">%s</span><span class="s2"> &lt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">),</span>
            <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;COALESCE(write_date, create_date, (now() AT TIME ZONE &#39;UTC&#39;))::timestamp&quot;</span><span class="p">),</span>
            <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;(now() AT TIME ZONE &#39;UTC&#39;) - interval </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">seconds</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">),</span>
        <span class="p">))</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>



<div class="viewcode-block" id="itemgetter_tuple">
<a class="viewcode-back" href="../../odoo.html#odoo.models.itemgetter_tuple">[docs]</a>
<span class="k">def</span> <span class="nf">itemgetter_tuple</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Fixes itemgetter inconsistency (useful in some cases) of not returning</span>
<span class="sd">    a tuple if len(items) == 1: always returns an n-tuple where n = len(items)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">gettable</span><span class="p">:</span> <span class="p">(</span><span class="n">gettable</span><span class="p">[</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]],)</span>
    <span class="k">return</span> <span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="o">*</span><span class="n">items</span><span class="p">)</span></div>


<div class="viewcode-block" id="convert_pgerror_not_null">
<a class="viewcode-back" href="../../odoo.html#odoo.models.convert_pgerror_not_null">[docs]</a>
<span class="k">def</span> <span class="nf">convert_pgerror_not_null</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">table_name</span> <span class="o">!=</span> <span class="n">model</span><span class="o">.</span><span class="n">_table</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;Missing required value for the field &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">column_name</span><span class="p">)}</span>

    <span class="n">field_name</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">column_name</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;Missing required value for the field &#39;</span><span class="si">%s</span><span class="s2">&#39; (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;string&#39;</span><span class="p">],</span> <span class="n">field_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
        <span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="n">field_name</span><span class="p">,</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="convert_pgerror_unique">
<a class="viewcode-back" href="../../odoo.html#odoo.models.convert_pgerror_unique">[docs]</a>
<span class="k">def</span> <span class="nf">convert_pgerror_unique</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="c1"># new cursor since we&#39;re probably in an error handler in a blown</span>
    <span class="c1"># transaction which may not have been rollbacked/cleaned yet</span>
    <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">cursor</span><span class="p">())</span> <span class="k">as</span> <span class="n">cr_tmp</span><span class="p">:</span>
        <span class="n">cr_tmp</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT</span>
<span class="s2">                conname AS &quot;constraint name&quot;,</span>
<span class="s2">                t.relname AS &quot;table name&quot;,</span>
<span class="s2">                ARRAY(</span>
<span class="s2">                    SELECT attname FROM pg_attribute</span>
<span class="s2">                    WHERE attrelid = conrelid</span>
<span class="s2">                      AND attnum = ANY(conkey)</span>
<span class="s2">                ) as &quot;columns&quot;</span>
<span class="s2">            FROM pg_constraint</span>
<span class="s2">            JOIN pg_class t ON t.oid = conrelid</span>
<span class="s2">            WHERE conname = </span><span class="si">%s</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">constraint_name</span><span class="p">))</span>
        <span class="n">constraint</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">ufields</span> <span class="o">=</span> <span class="n">cr_tmp</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># if the unique constraint is on an expression or on an other table</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ufields</span> <span class="ow">or</span> <span class="n">model</span><span class="o">.</span><span class="n">_table</span> <span class="o">!=</span> <span class="n">table</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">tools</span><span class="o">.</span><span class="n">ustr</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="c1"># TODO: add stuff from e.diag.message_hint? provides details about the constraint &amp; duplication values but may be localized...</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ufields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">field_name</span> <span class="o">=</span> <span class="n">ufields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
            <span class="sa">u</span><span class="s2">&quot;The value for the field &#39;</span><span class="si">%s</span><span class="s2">&#39; already exists (this is probably &#39;</span><span class="si">%s</span><span class="s2">&#39; in the current model).&quot;</span><span class="p">,</span>
            <span class="n">field_name</span><span class="p">,</span>
            <span class="n">field</span><span class="p">[</span><span class="s1">&#39;string&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
            <span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="n">field_name</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="n">field_strings</span> <span class="o">=</span> <span class="p">[</span><span class="n">fields</span><span class="p">[</span><span class="n">fname</span><span class="p">][</span><span class="s1">&#39;string&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">ufields</span><span class="p">]</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;The values for the fields &#39;</span><span class="si">%s</span><span class="s2">&#39; already exist (they are probably &#39;</span><span class="si">%s</span><span class="s2">&#39; in the current model).&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ufields</span><span class="p">),</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">field_strings</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
        <span class="c1"># no field, unclear which one we should pick and they could be in any order</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="convert_pgerror_constraint">
<a class="viewcode-back" href="../../odoo.html#odoo.models.convert_pgerror_constraint">[docs]</a>
<span class="k">def</span> <span class="nf">convert_pgerror_constraint</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="n">sql_constraints</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([((</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_sql_constraints</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">constraint_name</span> <span class="ow">in</span> <span class="n">sql_constraints</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">sql_constraints</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">constraint_name</span><span class="p">][</span><span class="mi">2</span><span class="p">]}</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">tools</span><span class="o">.</span><span class="n">ustr</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span></div>


<span class="n">PGERROR_TO_OE</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span>
    <span class="c1"># shape of mapped converters</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">model</span><span class="p">,</span> <span class="n">fvg</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">pgerror</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">tools</span><span class="o">.</span><span class="n">ustr</span><span class="p">(</span><span class="n">pgerror</span><span class="p">)}),</span> <span class="p">{</span>
    <span class="s1">&#39;23502&#39;</span><span class="p">:</span> <span class="n">convert_pgerror_not_null</span><span class="p">,</span>
    <span class="s1">&#39;23505&#39;</span><span class="p">:</span> <span class="n">convert_pgerror_unique</span><span class="p">,</span>
    <span class="s1">&#39;23514&#39;</span><span class="p">:</span> <span class="n">convert_pgerror_constraint</span><span class="p">,</span>
<span class="p">})</span>

<span class="c1"># keep those imports here to avoid dependency cycle errors</span>
<span class="c1"># pylint: disable=wrong-import-position</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">fields</span>
<span class="kn">from</span> <span class="nn">.osv</span> <span class="kn">import</span> <span class="n">expression</span>
<span class="kn">from</span> <span class="nn">.fields</span> <span class="kn">import</span> <span class="n">Field</span><span class="p">,</span> <span class="n">Datetime</span><span class="p">,</span> <span class="n">Command</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Amr.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>