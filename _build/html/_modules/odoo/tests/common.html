<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>odoo.tests.common &mdash; Amr  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Amr
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">odoo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Amr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../odoo.html">odoo</a></li>
      <li class="breadcrumb-item active">odoo.tests.common</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for odoo.tests.common</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The module :mod:`odoo.tests.common` provides unittest test cases and a few</span>
<span class="sd">helpers and classes to write tests.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">concurrent.futures</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">difflib</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">Future</span><span class="p">,</span> <span class="n">CancelledError</span><span class="p">,</span> <span class="n">wait</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">InvalidStateError</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">InvalidStateError</span> <span class="o">=</span> <span class="ne">NotImplementedError</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span><span class="p">,</span> <span class="n">ExitStack</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">zip_longest</span> <span class="k">as</span> <span class="n">izip_longest</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span><span class="p">,</span> <span class="n">_patch</span>
<span class="kn">from</span> <span class="nn">xmlrpc</span> <span class="kn">import</span> <span class="n">client</span> <span class="k">as</span> <span class="n">xmlrpclib</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">werkzeug.urls</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span><span class="p">,</span> <span class="n">html</span>
<span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">PreparedRequest</span><span class="p">,</span> <span class="n">Session</span>

<span class="kn">import</span> <span class="nn">odoo</span>
<span class="kn">from</span> <span class="nn">odoo</span> <span class="kn">import</span> <span class="n">api</span>
<span class="kn">from</span> <span class="nn">odoo.models</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="nn">odoo.exceptions</span> <span class="kn">import</span> <span class="n">AccessError</span>
<span class="kn">from</span> <span class="nn">odoo.modules.registry</span> <span class="kn">import</span> <span class="n">Registry</span>
<span class="kn">from</span> <span class="nn">odoo.service</span> <span class="kn">import</span> <span class="n">security</span>
<span class="kn">from</span> <span class="nn">odoo.sql_db</span> <span class="kn">import</span> <span class="n">BaseCursor</span><span class="p">,</span> <span class="n">Cursor</span>
<span class="kn">from</span> <span class="nn">odoo.tools</span> <span class="kn">import</span> <span class="n">float_compare</span><span class="p">,</span> <span class="n">single_email_re</span><span class="p">,</span> <span class="n">profiler</span><span class="p">,</span> <span class="n">lower_logging</span><span class="p">,</span> <span class="n">SQL</span>
<span class="kn">from</span> <span class="nn">odoo.tools.misc</span> <span class="kn">import</span> <span class="n">find_in_path</span><span class="p">,</span> <span class="n">mute_logger</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">case</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># the behaviour of decorator changed in 5.0.5 changing the structure of the traceback when</span>
    <span class="c1"># an error is raised inside a method using a decorator.</span>
    <span class="c1"># this is not a hudge problem for test execution but this makes error message</span>
    <span class="c1"># more difficult to read and breaks test_with_decorators</span>
    <span class="c1"># This also changes the error format making runbot error matching fail</span>
    <span class="c1"># This also breaks the first frame meaning that the module detection will also fail on runbot</span>
    <span class="c1"># In 5.1 decoratorx was introduced and it looks like it has the same behaviour of old decorator</span>
    <span class="kn">from</span> <span class="nn">decorator</span> <span class="kn">import</span> <span class="n">decoratorx</span> <span class="k">as</span> <span class="n">decorator</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">decorator</span> <span class="kn">import</span> <span class="n">decorator</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">websocket</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># chrome headless tests will be skipped</span>
    <span class="n">websocket</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># backward compatibility: Form was defined in this file</span>
<span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="c1"># pylint: disable=import-outside-toplevel</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;Form&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">.form</span> <span class="kn">import</span> <span class="n">Form</span>

    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="s2">&quot;Since 17.0: odoo.tests.common.Form is deprecated, use odoo.tests.Form&quot;</span><span class="p">,</span>
        <span class="n">category</span><span class="o">=</span><span class="ne">PendingDeprecationWarning</span><span class="p">,</span>
        <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">Form</span>


<span class="c1"># The odoo library is supposed already configured.</span>
<span class="n">ADDONS_PATH</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;addons_path&#39;</span><span class="p">]</span>
<span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
<span class="c1"># Useless constant, tests are aware of the content of demo data</span>
<span class="n">ADMIN_USER_ID</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">SUPERUSER_ID</span>

<span class="n">CHECK_BROWSER_SLEEP</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># seconds</span>
<span class="n">CHECK_BROWSER_ITERATIONS</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">BROWSER_WAIT</span> <span class="o">=</span> <span class="n">CHECK_BROWSER_SLEEP</span> <span class="o">*</span> <span class="n">CHECK_BROWSER_ITERATIONS</span> <span class="c1"># seconds</span>

<div class="viewcode-block" id="get_db_name">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.get_db_name">[docs]</a>
<span class="k">def</span> <span class="nf">get_db_name</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;db_name&#39;</span><span class="p">]</span>
    <span class="c1"># If the database name is not provided on the command-line,</span>
    <span class="c1"># use the one on the thread (which means if it is provided on</span>
    <span class="c1"># the command-line, this will break when installing another</span>
    <span class="c1"># database from XML-RPC).</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">(),</span> <span class="s1">&#39;dbname&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">dbname</span>
    <span class="k">return</span> <span class="n">db</span></div>



<span class="n">standalone_tests</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>


<div class="viewcode-block" id="standalone">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.standalone">[docs]</a>
<span class="k">def</span> <span class="nf">standalone</span><span class="p">(</span><span class="o">*</span><span class="n">tags</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Decorator for standalone test functions.  This is somewhat dedicated to</span>
<span class="sd">    tests that install, upgrade or uninstall some modules, which is currently</span>
<span class="sd">    forbidden in regular test cases.  The function is registered under the given</span>
<span class="sd">    ``tags`` and the corresponding Odoo module name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="c1"># register func by odoo module name</span>
        <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;odoo.addons.&#39;</span><span class="p">):</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">standalone_tests</span><span class="p">[</span><span class="n">module</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="c1"># register func with aribitrary name, if any</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">standalone_tests</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">standalone_tests</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span>

    <span class="k">return</span> <span class="n">register</span></div>



<span class="c1"># For backwards-compatibility - get_db_name() should be used instead</span>
<span class="n">DB</span> <span class="o">=</span> <span class="n">get_db_name</span><span class="p">()</span>


<div class="viewcode-block" id="new_test_user">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.new_test_user">[docs]</a>
<span class="k">def</span> <span class="nf">new_test_user</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">login</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="s1">&#39;base.group_user&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Helper function to create a new test user. It allows to quickly create</span>
<span class="sd">    users given its login and groups (being a comma separated list of xml ids).</span>
<span class="sd">    Kwargs are directly propagated to the create to further customize the</span>
<span class="sd">    created user.</span>

<span class="sd">    User creation uses a potentially customized environment using the context</span>
<span class="sd">    parameter allowing to specify a custom context. It can be used to force a</span>
<span class="sd">    specific behavior and/or simplify record creation. An example is to use</span>
<span class="sd">    mail-related context keys in mail tests to speedup record creation.</span>

<span class="sd">    Some specific fields are automatically filled to avoid issues</span>

<span class="sd">     * groups_id: it is filled using groups function parameter;</span>
<span class="sd">     * name: &quot;login (groups)&quot; by default as it is required;</span>
<span class="sd">     * email: it is either the login (if it is a valid email) or a generated</span>
<span class="sd">       string &#39;x.x@example.com&#39; (x being the first login letter). This is due</span>
<span class="sd">       to email being required for most odoo operations;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">login</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;New users require at least a login&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">groups</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;New users require at least user groups&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">groups_id</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])]</span>
    <span class="n">create_values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">login</span><span class="o">=</span><span class="n">login</span><span class="p">,</span> <span class="n">groups_id</span><span class="o">=</span><span class="n">groups_id</span><span class="p">)</span>
    <span class="c1"># automatically generate a name as &quot;Login (groups)&quot; to ease user comprehension</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">create_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">):</span>
        <span class="n">create_values</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">login</span><span class="p">,</span> <span class="n">groups</span><span class="p">)</span>
    <span class="c1"># automatically give a password equal to login</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">create_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">):</span>
        <span class="n">create_values</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">login</span> <span class="o">+</span> <span class="s1">&#39;x&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">login</span><span class="p">))</span>
    <span class="c1"># generate email if not given as most test require an email</span>
    <span class="k">if</span> <span class="s1">&#39;email&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">create_values</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">single_email_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">login</span><span class="p">):</span>
            <span class="n">create_values</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">login</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">create_values</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">@example.com&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">login</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">login</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># ensure company_id + allowed company constraint works if not given at create</span>
    <span class="k">if</span> <span class="s1">&#39;company_id&#39;</span> <span class="ow">in</span> <span class="n">create_values</span> <span class="ow">and</span> <span class="s1">&#39;company_ids&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">create_values</span><span class="p">:</span>
        <span class="n">create_values</span><span class="p">[</span><span class="s1">&#39;company_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">4</span><span class="p">,</span> <span class="n">create_values</span><span class="p">[</span><span class="s1">&#39;company_id&#39;</span><span class="p">])]</span>

    <span class="k">return</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">**</span><span class="n">context</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">create_values</span><span class="p">)</span></div>


<div class="viewcode-block" id="loaded_demo_data">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.loaded_demo_data">[docs]</a>
<span class="k">def</span> <span class="nf">loaded_demo_data</span><span class="p">(</span><span class="n">env</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.user_demo&#39;</span><span class="p">,</span> <span class="n">raise_if_not_found</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span></div>


<div class="viewcode-block" id="RecordCapturer">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.RecordCapturer">[docs]</a>
<span class="k">class</span> <span class="nc">RecordCapturer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_domain</span> <span class="o">=</span> <span class="n">domain</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_domain</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_after</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_domain</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_before</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">records</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_after</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_domain</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_before</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_after</span></div>



<div class="viewcode-block" id="MetaCase">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.MetaCase">[docs]</a>
<span class="k">class</span> <span class="nc">MetaCase</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Metaclass of test case classes to assign default &#39;test_tags&#39;:</span>
<span class="sd">        &#39;standard&#39;, &#39;at_install&#39; and the name of the module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MetaCase</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="c1"># assign default test tags</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;odoo.addons.&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;test_tags&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">test_tags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span> <span class="s1">&#39;at_install&#39;</span><span class="p">}</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">test_module</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">test_class</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">test_sequence</span> <span class="o">=</span> <span class="mi">0</span></div>



<span class="k">def</span> <span class="nf">_normalize_arch_for_assert</span><span class="p">(</span><span class="n">arch_string</span><span class="p">,</span> <span class="n">parser_method</span><span class="o">=</span><span class="s2">&quot;xml&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Takes some xml and normalize it to make it comparable to other xml</span>
<span class="sd">    in particular, blank text is removed, and the output is pretty-printed</span>

<span class="sd">    :param str arch_string: the string representing an XML arch</span>
<span class="sd">    :param str parser_method: an string representing which lxml.Parser class to use</span>
<span class="sd">        when normalizing both archs. Takes either &quot;xml&quot; or &quot;html&quot;</span>
<span class="sd">    :return: the normalized arch</span>
<span class="sd">    :rtype str:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Parser</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">parser_method</span> <span class="o">==</span> <span class="s1">&#39;xml&#39;</span><span class="p">:</span>
        <span class="n">Parser</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">XMLParser</span>
    <span class="k">elif</span> <span class="n">parser_method</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span><span class="p">:</span>
        <span class="n">Parser</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">HTMLParser</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">Parser</span><span class="p">(</span><span class="n">remove_blank_text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">arch_string</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">arch_string</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="n">parser</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">arch_string</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;unicode&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="BlockedRequest">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.BlockedRequest">[docs]</a>
<span class="k">class</span> <span class="nc">BlockedRequest</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">):</span>
    <span class="k">pass</span></div>

<span class="n">_super_send</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">send</span>
<div class="viewcode-block" id="BaseCase">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.BaseCase">[docs]</a>
<span class="k">class</span> <span class="nc">BaseCase</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">TestCase</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">MetaCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Subclass of TestCase for Odoo-specific code. This class is abstract and</span>
<span class="sd">    expects self.registry, self.cr and self.uid to be initialized by subclasses.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">longMessage</span> <span class="o">=</span> <span class="kc">True</span>      <span class="c1"># more verbose error message by default: https://www.odoo.com/r/Vmh</span>
    <span class="n">warm</span> <span class="o">=</span> <span class="kc">True</span>             <span class="c1"># False during warm-up phase (see :func:`warmup`)</span>
    <span class="n">_python_version</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">methodName</span><span class="o">=</span><span class="s1">&#39;runTest&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">methodName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addTypeEqualityFunc</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">_Element</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertTreesEqual</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addTypeEqualityFunc</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">HtmlElement</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertTreesEqual</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_request_handler</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">PreparedRequest</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="c1"># allow localhost requests</span>
        <span class="c1"># TODO: also check port?</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">url_parse</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">host</span> <span class="ow">in</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_super_send</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_super_send</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

        <span class="n">_logger</span><span class="o">.</span><span class="n">getChild</span><span class="p">(</span><span class="s1">&#39;requests&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Blocking un-mocked external HTTP request </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">BlockedRequest</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;External requests verboten (was </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="BaseCase.run">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.BaseCase.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="n">testMethod</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_testMethodName</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">testMethod</span><span class="p">,</span> <span class="s1">&#39;_retry&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_retry&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">tests_run_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ODOO_TEST_FAILURE_RETRIES&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tests_run_count</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Auto retry disabled for </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="n">failure</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">retry</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tests_run_count</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">retry</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">runbot</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Retrying a failed test: </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">retry</span> <span class="o">&lt;</span> <span class="n">tests_run_count</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(),</span> \
                        <span class="n">result</span><span class="o">.</span><span class="n">soft_fail</span><span class="p">(),</span> \
                        <span class="n">lower_logging</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span> <span class="k">as</span> <span class="n">quiet_log</span><span class="p">:</span>
                    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="n">failure</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">had_failure</span> <span class="ow">or</span> <span class="n">quiet_log</span><span class="o">.</span><span class="n">had_error_log</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># last try</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">failure</span><span class="p">:</span>
                <span class="k">break</span></div>


<div class="viewcode-block" id="BaseCase.setUpClass">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.BaseCase.setUpClass">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">check_remaining_patchers</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">patcher</span> <span class="ow">in</span> <span class="n">_patch</span><span class="o">.</span><span class="n">_active_patches</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;A patcher (targeting </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">) was remaining active at the end of </span><span class="si">%s</span><span class="s2">, disabling it...&quot;</span><span class="p">,</span> <span class="n">patcher</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">patcher</span><span class="o">.</span><span class="n">attribute</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                <span class="n">patcher</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">addClassCleanup</span><span class="p">(</span><span class="n">check_remaining_patchers</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUpClass</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;standard&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">test_tags</span><span class="p">:</span>
            <span class="c1"># if the method is passed directly `patch` discards the session</span>
            <span class="c1"># object which we need</span>
            <span class="c1"># pylint: disable=unnecessary-lambda</span>
            <span class="n">patcher</span> <span class="o">=</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span>
                <span class="n">requests</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">Session</span><span class="p">,</span>
                <span class="s1">&#39;send&#39;</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_request_handler</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">patcher</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">addClassCleanup</span><span class="p">(</span><span class="n">patcher</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseCase.cursor">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.BaseCase.cursor">[docs]</a>
    <span class="k">def</span> <span class="nf">cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Get the current uid. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span>

    <span class="nd">@uid</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">uid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Set the uid by changing the test&#39;s environment. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>

<div class="viewcode-block" id="BaseCase.ref">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.BaseCase.ref">[docs]</a>
    <span class="k">def</span> <span class="nf">ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Returns database ID for the provided :term:`external identifier`,</span>
<span class="sd">        shortcut for ``_xmlid_lookup``</span>

<span class="sd">        :param xid: fully-qualified :term:`external identifier`, in the form</span>
<span class="sd">                    :samp:`{module}.{identifier}`</span>
<span class="sd">        :raise: ValueError if not found</span>
<span class="sd">        :returns: registered id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse_ref</span><span class="p">(</span><span class="n">xid</span><span class="p">)</span><span class="o">.</span><span class="n">id</span></div>


<div class="viewcode-block" id="BaseCase.browse_ref">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.BaseCase.browse_ref">[docs]</a>
    <span class="k">def</span> <span class="nf">browse_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Returns a record object for the provided</span>
<span class="sd">        :term:`external identifier`</span>

<span class="sd">        :param xid: fully-qualified :term:`external identifier`, in the form</span>
<span class="sd">                    :samp:`{module}.{identifier}`</span>
<span class="sd">        :raise: ValueError if not found</span>
<span class="sd">        :returns: :class:`~odoo.models.BaseModel`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">xid</span><span class="p">,</span> <span class="s2">&quot;this method requires a fully qualified parameter, in the following form: &#39;module.identifier&#39;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">xid</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseCase.patch">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.BaseCase.patch">[docs]</a>
    <span class="k">def</span> <span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Do the patch ``setattr(obj, key, val)``, and prepare cleanup. &quot;&quot;&quot;</span>
        <span class="n">patcher</span> <span class="o">=</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>   <span class="c1"># this is unittest.mock.patch</span>
        <span class="n">patcher</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">patcher</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseCase.classPatch">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.BaseCase.classPatch">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">classPatch</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Do the patch ``setattr(obj, key, val)``, and prepare cleanup. &quot;&quot;&quot;</span>
        <span class="n">patcher</span> <span class="o">=</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>   <span class="c1"># this is unittest.mock.patch</span>
        <span class="n">patcher</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">addClassCleanup</span><span class="p">(</span><span class="n">patcher</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseCase.startPatcher">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.BaseCase.startPatcher">[docs]</a>
    <span class="k">def</span> <span class="nf">startPatcher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patcher</span><span class="p">):</span>
        <span class="n">mock</span> <span class="o">=</span> <span class="n">patcher</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">patcher</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mock</span></div>


<div class="viewcode-block" id="BaseCase.startClassPatcher">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.BaseCase.startClassPatcher">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">startClassPatcher</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">patcher</span><span class="p">):</span>
        <span class="n">mock</span> <span class="o">=</span> <span class="n">patcher</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">addClassCleanup</span><span class="p">(</span><span class="n">patcher</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mock</span></div>


<div class="viewcode-block" id="BaseCase.with_user">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.BaseCase.with_user">[docs]</a>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">with_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Change user for a given test, like with self.with_user() ... &quot;&quot;&quot;</span>
        <span class="n">old_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">login</span><span class="p">)])</span>
            <span class="k">assert</span> <span class="n">user</span><span class="p">,</span> <span class="s2">&quot;Login </span><span class="si">%s</span><span class="s2"> not found&quot;</span> <span class="o">%</span> <span class="n">login</span>
            <span class="c1"># switch user</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># back</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">old_uid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseCase.debug_mode">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.BaseCase.debug_mode">[docs]</a>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">debug_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Enable the effects of group &#39;base.group_no_one&#39;; mainly useful with :class:`Form`. &quot;&quot;&quot;</span>
        <span class="n">origin_user_has_groups</span> <span class="o">=</span> <span class="n">BaseModel</span><span class="o">.</span><span class="n">user_has_groups</span>

        <span class="k">def</span> <span class="nf">user_has_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groups</span><span class="p">):</span>
            <span class="n">group_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;!base.group_no_one&#39;</span> <span class="ow">in</span> <span class="n">group_set</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="s1">&#39;base.group_no_one&#39;</span> <span class="ow">in</span> <span class="n">group_set</span><span class="p">:</span>
                <span class="n">group_set</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;base.group_no_one&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="ow">not</span> <span class="n">group_set</span> <span class="ow">or</span> <span class="n">origin_user_has_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">group_set</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">origin_user_has_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groups</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;odoo.models.BaseModel.user_has_groups&#39;</span><span class="p">,</span> <span class="n">user_has_groups</span><span class="p">):</span>
            <span class="k">yield</span></div>


    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">_assertRaises</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Context manager that clears the environment upon failure. &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">ExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">init</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;env&#39;</span><span class="p">):</span>
                <span class="n">init</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">savepoint</span><span class="p">())</span>
                <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">AccessError</span><span class="p">):</span>
                    <span class="c1"># The savepoint() above calls flush(), which leaves the</span>
                    <span class="c1"># record cache with lots of data.  This can prevent</span>
                    <span class="c1"># access errors to be detected. In order to avoid this</span>
                    <span class="c1"># issue, we clear the cache before proceeding.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="k">with</span> <span class="n">ExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">inner</span><span class="p">:</span>
                <span class="n">cm</span> <span class="o">=</span> <span class="n">inner</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">))</span>
                <span class="c1"># *moves* the cleanups from init to inner, this ensures the</span>
                <span class="c1"># savepoint gets rolled back when `yield` raises `exception`,</span>
                <span class="c1"># but still allows the initialisation to be protected *and* not</span>
                <span class="c1"># interfered with by `assertRaises`.</span>
                <span class="n">inner</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">init</span><span class="o">.</span><span class="n">pop_all</span><span class="p">())</span>

                <span class="k">yield</span> <span class="n">cm</span>

<div class="viewcode-block" id="BaseCase.assertRaises">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.BaseCase.assertRaises">[docs]</a>
    <span class="k">def</span> <span class="nf">assertRaises</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">func</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="p">):</span>
                <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assertRaises</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
        <span class="c1"># simplified backport of assertNoLogs()</span>
        <span class="nd">@contextmanager</span>
        <span class="k">def</span> <span class="nf">assertNoLogs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># assertLogs ensures there is at least one log record when</span>
            <span class="c1"># exiting the context manager. We insert one dummy record just</span>
            <span class="c1"># so we pass that silly test while still capturing the logs.</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertLogs</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span> <span class="k">as</span> <span class="n">capture</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">level</span><span class="p">),</span> <span class="s2">&quot;Dummy log record&quot;</span><span class="p">)</span>
                <span class="k">yield</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">capture</span><span class="o">.</span><span class="n">output</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">failureException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected logs found: </span><span class="si">{</span><span class="n">capture</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="BaseCase.assertQueries">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.BaseCase.assertQueries">[docs]</a>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">assertQueries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Check the queries made by the current cursor. ``expected`` is a list</span>
<span class="sd">        of strings representing the expected queries being made. Query strings</span>
<span class="sd">        are matched against each other, ignoring case and whitespaces.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Cursor_execute</span> <span class="o">=</span> <span class="n">Cursor</span><span class="o">.</span><span class="n">execute</span>
        <span class="n">actual_queries</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_exceptions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">actual_queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">code</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">SQL</span><span class="p">)</span> <span class="k">else</span> <span class="n">query</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Cursor_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">log_exceptions</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_unaccent_wrapper</span><span class="p">(</span><span class="n">cr</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>

        <span class="k">if</span> <span class="n">flush</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;odoo.sql_db.Cursor.execute&#39;</span><span class="p">,</span> <span class="n">execute</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;odoo.osv.expression.get_unaccent_wrapper&#39;</span><span class="p">,</span> <span class="n">get_unaccent_wrapper</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">actual_queries</span>
                <span class="k">if</span> <span class="n">flush</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">warm</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">actual_queries</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">expected</span><span class="p">),</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---- actual queries:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">---- expected queries:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">actual_queries</span><span class="p">),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">expected</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">actual_query</span><span class="p">,</span> <span class="n">expect_query</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">actual_queries</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">actual_query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()),</span>
                <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">expect_query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()),</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">---- actual query:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">---- not like:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">actual_query</span><span class="p">,</span> <span class="n">expect_query</span><span class="p">),</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="BaseCase.assertQueryCount">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.BaseCase.assertQueryCount">[docs]</a>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">assertQueryCount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">counters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Context manager that counts queries. It may be invoked either with</span>
<span class="sd">            one value, or with a set of named arguments like ``login=value``::</span>

<span class="sd">                with self.assertQueryCount(42):</span>
<span class="sd">                    ...</span>

<span class="sd">                with self.assertQueryCount(admin=3, demo=5):</span>
<span class="sd">                    ...</span>

<span class="sd">            The second form is convenient when used with :func:`users`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">warm</span><span class="p">:</span>
            <span class="c1"># mock random in order to avoid random bus gc</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;random.random&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">login</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">login</span>
                <span class="n">expected</span> <span class="o">=</span> <span class="n">counters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">login</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">flush</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">count0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">sql_log_count</span>
                <span class="k">yield</span>
                <span class="k">if</span> <span class="n">flush</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">sql_log_count</span> <span class="o">-</span> <span class="n">count0</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">:</span>
                    <span class="c1"># add some info on caller to allow semi-automatic update of query count</span>
                    <span class="n">frame</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">linenum</span><span class="p">,</span> <span class="n">funcname</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s2">&quot;/odoo/addons/&quot;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
                        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;/odoo/addons/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">expected</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Query count more than expected for user </span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2"> &gt; </span><span class="si">%d</span><span class="s2"> in </span><span class="si">%s</span><span class="s2"> at </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="c1"># add a subtest in order to continue the test_method in case of failures</span>
                        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="n">login</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">funcname</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">linenum</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__module__</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Query count less than expected for user </span><span class="si">%s</span><span class="s2">: </span><span class="si">%d</span><span class="s2"> &lt; </span><span class="si">%d</span><span class="s2"> in </span><span class="si">%s</span><span class="s2"> at </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">funcname</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">linenum</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># flush before and after during warmup, in order to reproduce the</span>
            <span class="c1"># same operations, otherwise the caches might not be ready!</span>
            <span class="k">if</span> <span class="n">flush</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">yield</span>
            <span class="k">if</span> <span class="n">flush</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>


<div class="viewcode-block" id="BaseCase.assertRecordValues">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.BaseCase.assertRecordValues">[docs]</a>
    <span class="k">def</span> <span class="nf">assertRecordValues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">records</span><span class="p">,</span> <span class="n">expected_values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Compare a recordset with a list of dictionaries representing the expected results.</span>
<span class="sd">        This method performs a comparison element by element based on their index.</span>
<span class="sd">        Then, the order of the expected values is extremely important.</span>

<span class="sd">        Note that:</span>
<span class="sd">          - Comparison between falsy values is supported: False match with None.</span>
<span class="sd">          - Comparison between monetary field is also treated according the currency&#39;s rounding.</span>
<span class="sd">          - Comparison between x2many field is done by ids. Then, empty expected ids must be [].</span>
<span class="sd">          - Comparison between many2one field id done by id. Empty comparison can be done using any falsy value.</span>

<span class="sd">        :param records:               The records to compare.</span>
<span class="sd">        :param expected_values:       List of dicts expected to be exactly matched in records</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">def</span> <span class="nf">_compare_candidate</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">candidate</span><span class="p">,</span> <span class="n">field_names</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; Compare all the values in `candidate` with a record.</span>
<span class="sd">            :param record:      record being compared</span>
<span class="sd">            :param candidate:   dict of values to compare</span>
<span class="sd">            :return:            A dictionary will encountered difference in values.</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
                <span class="n">record_value</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
                <span class="n">field_type</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span>
                <span class="k">if</span> <span class="n">field_type</span> <span class="o">==</span> <span class="s1">&#39;monetary&#39;</span><span class="p">:</span>
                    <span class="c1"># Compare monetary field.</span>
                    <span class="n">currency_field_name</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_currency_field</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                    <span class="n">record_currency</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">currency_field_name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">candidate</span><span class="p">:</span>
                        <span class="n">diff</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">record_value</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">record_currency</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">record_currency</span><span class="o">.</span><span class="n">compare_amounts</span><span class="p">(</span><span class="n">candidate</span><span class="p">[</span><span class="n">field_name</span><span class="p">],</span> <span class="n">record_value</span><span class="p">):</span>
                            <span class="n">diff</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">record_value</span><span class="p">,</span> <span class="n">record_currency</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">candidate</span><span class="p">[</span><span class="n">field_name</span><span class="p">]))</span>
                    <span class="k">elif</span> <span class="n">candidate</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">!=</span> <span class="n">record_value</span><span class="p">:</span>
                        <span class="n">diff</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">record_value</span><span class="p">,</span> <span class="n">candidate</span><span class="p">[</span><span class="n">field_name</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">field_type</span> <span class="o">==</span> <span class="s1">&#39;float&#39;</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">get_digits</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">env</span><span class="p">):</span>
                    <span class="n">prec</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_digits</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">env</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">float_compare</span><span class="p">(</span><span class="n">candidate</span><span class="p">[</span><span class="n">field_name</span><span class="p">],</span> <span class="n">record_value</span><span class="p">,</span> <span class="n">precision_digits</span><span class="o">=</span><span class="n">prec</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">diff</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">record_value</span><span class="p">,</span> <span class="n">candidate</span><span class="p">[</span><span class="n">field_name</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">field_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;one2many&#39;</span><span class="p">,</span> <span class="s1">&#39;many2many&#39;</span><span class="p">):</span>
                    <span class="c1"># Compare x2many relational fields.</span>
                    <span class="c1"># Empty comparison must be an empty list to be True.</span>
                    <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">candidate</span><span class="p">:</span>
                        <span class="n">diff</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">record_value</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">set</span><span class="p">(</span><span class="n">record_value</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">candidate</span><span class="p">[</span><span class="n">field_name</span><span class="p">]):</span>
                        <span class="n">diff</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">record_value</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">candidate</span><span class="p">[</span><span class="n">field_name</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">field_type</span> <span class="o">==</span> <span class="s1">&#39;many2one&#39;</span><span class="p">:</span>
                    <span class="c1"># Compare many2one relational fields.</span>
                    <span class="c1"># Every falsy value is allowed to compare with an empty record.</span>
                    <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">candidate</span><span class="p">:</span>
                        <span class="n">diff</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">record_value</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">record_value</span> <span class="ow">or</span> <span class="n">candidate</span><span class="p">[</span><span class="n">field_name</span><span class="p">])</span> <span class="ow">and</span> <span class="n">record_value</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">candidate</span><span class="p">[</span><span class="n">field_name</span><span class="p">]:</span>
                        <span class="n">diff</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">record_value</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">candidate</span><span class="p">[</span><span class="n">field_name</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Compare others fields if not both interpreted as falsy values.</span>
                    <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">candidate</span><span class="p">:</span>
                        <span class="n">diff</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">record_value</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">candidate</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="ow">or</span> <span class="n">record_value</span><span class="p">)</span> <span class="ow">and</span> <span class="n">record_value</span> <span class="o">!=</span> <span class="n">candidate</span><span class="p">[</span><span class="n">field_name</span><span class="p">]:</span>
                        <span class="n">diff</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">record_value</span><span class="p">,</span> <span class="n">candidate</span><span class="p">[</span><span class="n">field_name</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">diff</span>

        <span class="c1"># Compare records with candidates.</span>
        <span class="n">different_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">field_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">expected_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">records</span><span class="p">):</span>
            <span class="n">is_additional_record</span> <span class="o">=</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expected_values</span><span class="p">)</span>
            <span class="n">candidate</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">is_additional_record</span> <span class="k">else</span> <span class="n">expected_values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">_compare_candidate</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">candidate</span><span class="p">,</span> <span class="n">field_names</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
                <span class="n">different_values</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;additional_record&#39;</span> <span class="k">if</span> <span class="n">is_additional_record</span> <span class="k">else</span> <span class="s1">&#39;regular_diff&#39;</span><span class="p">,</span> <span class="n">diff</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">expected_values</span><span class="p">)):</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
                <span class="n">diff</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">expected_values</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">field_name</span><span class="p">])</span>
            <span class="n">different_values</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;missing_record&#39;</span><span class="p">,</span> <span class="n">diff</span><span class="p">))</span>

        <span class="c1"># Build error message.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">different_values</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">errors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;The records and expected_values do not match.&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expected_values</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Wrong number of records to compare: </span><span class="si">%d</span><span class="s1"> records versus </span><span class="si">%d</span><span class="s1"> expected values.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">expected_values</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">diff_type</span><span class="p">,</span> <span class="n">diff</span> <span class="ow">in</span> <span class="n">different_values</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">diff_type</span> <span class="o">==</span> <span class="s1">&#39;regular_diff&#39;</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">==== Differences at index </span><span class="si">%s</span><span class="s1"> ====&#39;</span> <span class="o">%</span> <span class="n">index</span><span class="p">)</span>
                <span class="n">record_diff</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">diff</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
                <span class="n">candidate_diff</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">diff</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">difflib</span><span class="o">.</span><span class="n">unified_diff</span><span class="p">(</span><span class="n">record_diff</span><span class="p">,</span> <span class="n">candidate_diff</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">diff_type</span> <span class="o">==</span> <span class="s1">&#39;additional_record&#39;</span><span class="p">:</span>
                <span class="n">errors</span> <span class="o">+=</span> <span class="p">[</span>
                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">==== Additional record ====&#39;</span><span class="p">,</span>
                    <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">diff</span><span class="o">.</span><span class="n">items</span><span class="p">())),</span>
                <span class="p">]</span>
            <span class="k">elif</span> <span class="n">diff_type</span> <span class="o">==</span> <span class="s1">&#39;missing_record&#39;</span><span class="p">:</span>
                <span class="n">errors</span> <span class="o">+=</span> <span class="p">[</span>
                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">==== Missing record ====&#39;</span><span class="p">,</span>
                    <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">diff</span><span class="o">.</span><span class="n">items</span><span class="p">())),</span>
                <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">))</span></div>


    <span class="c1"># turns out this thing may not be quite as useful as we thought...</span>
<div class="viewcode-block" id="BaseCase.assertItemsEqual">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.BaseCase.assertItemsEqual">[docs]</a>
    <span class="k">def</span> <span class="nf">assertItemsEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseCase.assertTreesEqual">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.BaseCase.assertTreesEqual">[docs]</a>
    <span class="k">def</span> <span class="nf">assertTreesEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">n1</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">n2</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="c1"># Because lxml.attrib is an ordereddict for which order is important</span>
        <span class="c1"># to equality, even though *we* don&#39;t care</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">n1</span><span class="o">.</span><span class="n">attrib</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">n2</span><span class="o">.</span><span class="n">attrib</span><span class="p">),</span> <span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="n">n1</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="p">(</span><span class="n">n2</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="n">n1</span><span class="o">.</span><span class="n">tail</span> <span class="ow">or</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="p">(</span><span class="n">n2</span><span class="o">.</span><span class="n">tail</span> <span class="ow">or</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">msg</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">izip_longest</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTreesEqual</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_assertXMLEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="s2">&quot;xml&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Asserts that two xmls archs are equal</span>

<span class="sd">        :param original: the xml arch to test</span>
<span class="sd">        :type original: str</span>
<span class="sd">        :param expected: the xml arch of reference</span>
<span class="sd">        :type expected: str</span>
<span class="sd">        :param parser: an string representing which lxml.Parser class to use</span>
<span class="sd">            when normalizing both archs. Takes either &quot;xml&quot; or &quot;html&quot;</span>
<span class="sd">        :type parser: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxDiff</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="k">if</span> <span class="n">original</span><span class="p">:</span>
            <span class="n">original</span> <span class="o">=</span> <span class="n">_normalize_arch_for_assert</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">parser</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">expected</span><span class="p">:</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">_normalize_arch_for_assert</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">parser</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>

<div class="viewcode-block" id="BaseCase.assertXMLEqual">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.BaseCase.assertXMLEqual">[docs]</a>
    <span class="k">def</span> <span class="nf">assertXMLEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assertXMLEqual</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseCase.assertHTMLEqual">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.BaseCase.assertHTMLEqual">[docs]</a>
    <span class="k">def</span> <span class="nf">assertHTMLEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assertXMLEqual</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseCase.profile">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.BaseCase.profile">[docs]</a>
    <span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">test_method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_testMethodName&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown test method&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;profile_session&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">profile_session</span> <span class="o">=</span> <span class="n">profiler</span><span class="o">.</span><span class="n">make_session</span><span class="p">(</span><span class="n">test_method</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">profiler</span><span class="o">.</span><span class="n">Profiler</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> uid:</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">test_method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;warm&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">warm</span> <span class="k">else</span> <span class="s1">&#39;cold&#39;</span><span class="p">,</span> <span class="n">description</span><span class="p">),</span>
            <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">dbname</span><span class="p">,</span>
            <span class="n">profile_session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_session</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</div>



<span class="n">savepoint_seq</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>


<div class="viewcode-block" id="TransactionCase">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.TransactionCase">[docs]</a>
<span class="k">class</span> <span class="nc">TransactionCase</span><span class="p">(</span><span class="n">BaseCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Test class in which all test methods are run in a single transaction,</span>
<span class="sd">    but each test method is run in a sub-transaction managed by a savepoint.</span>
<span class="sd">    The transaction&#39;s cursor is always closed without committing.</span>

<span class="sd">    The data setup common to all methods should be done in the class method</span>
<span class="sd">    `setUpClass`, so that it is done once for all test methods. This is useful</span>
<span class="sd">    for test cases containing fast tests but with significant database setup</span>
<span class="sd">    common to all cases (complex in-db test data).</span>

<span class="sd">    After being run, each test method cleans up the record cache and the</span>
<span class="sd">    registry cache. However, there is no cleanup of the registry models and</span>
<span class="sd">    fields. If a test modifies the registry (custom models and/or fields), it</span>
<span class="sd">    should prepare the necessary cleanup (`self.registry.reset_changes()`).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">registry</span><span class="p">:</span> <span class="n">Registry</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">api</span><span class="o">.</span><span class="n">Environment</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cr</span><span class="p">:</span> <span class="n">Cursor</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">muted_registry_logger</span> <span class="o">=</span> <span class="n">mute_logger</span><span class="p">(</span><span class="n">odoo</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_gc_filestore</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="c1"># attachment can be created or unlink during the tests.</span>
        <span class="c1"># they can addup during test and take some disc space.</span>
        <span class="c1"># since cron are not running during tests, we need to gc manually</span>
        <span class="c1"># We need to check the status of the file system outside of the test cursor</span>
        <span class="k">with</span> <span class="n">odoo</span><span class="o">.</span><span class="n">registry</span><span class="p">(</span><span class="n">get_db_name</span><span class="p">())</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cr</span><span class="p">:</span>
            <span class="n">gc_env</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">odoo</span><span class="o">.</span><span class="n">SUPERUSER_ID</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">gc_env</span><span class="p">[</span><span class="s1">&#39;ir.attachment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_gc_file_store_unsafe</span><span class="p">()</span>

<div class="viewcode-block" id="TransactionCase.setUpClass">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.TransactionCase.setUpClass">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUpClass</span><span class="p">()</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">addClassCleanup</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_gc_filestore</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">registry</span><span class="p">(</span><span class="n">get_db_name</span><span class="p">())</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">registry_start_sequence</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">registry_sequence</span>
        <span class="k">def</span> <span class="nf">reset_changes</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">registry_start_sequence</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">registry_sequence</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">cls</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">registry_invalidated</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">cls</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cr</span><span class="p">:</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="n">cr</span><span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">registry_invalidated</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">registry_sequence</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">registry_start_sequence</span>
            <span class="k">with</span> <span class="bp">cls</span><span class="o">.</span><span class="n">muted_registry_logger</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_all_caches</span><span class="p">()</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">cache_invalidated</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">addClassCleanup</span><span class="p">(</span><span class="n">reset_changes</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">cr</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">addClassCleanup</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">cr</span><span class="p">,</span> <span class="n">odoo</span><span class="o">.</span><span class="n">SUPERUSER_ID</span><span class="p">,</span> <span class="p">{})</span></div>


<div class="viewcode-block" id="TransactionCase.setUp">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.TransactionCase.setUp">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>

        <span class="c1"># restore environments after the test to avoid invoking flush() with an</span>
        <span class="c1"># invalid environment (inexistent user id) from another test</span>
        <span class="n">envs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">envs</span>
        <span class="k">for</span> <span class="n">env</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">envs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">clear</span><span class="p">)</span>
        <span class="c1"># restore the set of known environments as it was at setUp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">envs</span><span class="o">.</span><span class="n">update</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">envs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">envs</span><span class="o">.</span><span class="n">clear</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">muted_registry_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_all_caches</span><span class="p">))</span>

        <span class="c1"># This prevents precommit functions and data from piling up</span>
        <span class="c1"># until cr.flush is called in &#39;assertRaises&#39; clauses</span>
        <span class="c1"># (these are not cleared in self.env.clear or envs.clear)</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span>

        <span class="k">def</span> <span class="nf">_reset</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">funcs</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">_funcs</span> <span class="o">=</span> <span class="n">funcs</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="p">[</span><span class="n">cr</span><span class="o">.</span><span class="n">precommit</span><span class="p">,</span> <span class="n">cr</span><span class="o">.</span><span class="n">postcommit</span><span class="p">,</span> <span class="n">cr</span><span class="o">.</span><span class="n">prerollback</span><span class="p">,</span> <span class="n">cr</span><span class="o">.</span><span class="n">postrollback</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">_reset</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">deque</span><span class="p">(</span><span class="n">callback</span><span class="o">.</span><span class="n">_funcs</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">callback</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>

        <span class="c1"># flush everything in setUpClass before introducing a savepoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_savepoint_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">savepoint_seq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SAVEPOINT test_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_savepoint_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">,</span> <span class="s1">&#39;ROLLBACK TO SAVEPOINT test_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_savepoint_id</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SingleTransactionCase">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.SingleTransactionCase">[docs]</a>
<span class="k">class</span> <span class="nc">SingleTransactionCase</span><span class="p">(</span><span class="n">BaseCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; TestCase in which all test methods are run in the same transaction,</span>
<span class="sd">    the transaction is started with the first test method and rolled back at</span>
<span class="sd">    the end of the last.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">TransactionCase</span><span class="p">):</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> inherits from both TransactionCase and SingleTransactionCase&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SingleTransactionCase.setUpClass">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.SingleTransactionCase.setUpClass">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUpClass</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">registry</span><span class="p">(</span><span class="n">get_db_name</span><span class="p">())</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">addClassCleanup</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">reset_changes</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">addClassCleanup</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_all_caches</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">cr</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">addClassCleanup</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">cr</span><span class="p">,</span> <span class="n">odoo</span><span class="o">.</span><span class="n">SUPERUSER_ID</span><span class="p">,</span> <span class="p">{})</span></div>


<div class="viewcode-block" id="SingleTransactionCase.setUp">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.SingleTransactionCase.setUp">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SingleTransactionCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="ChromeBrowserException">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.ChromeBrowserException">[docs]</a>
<span class="k">class</span> <span class="nc">ChromeBrowserException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="fmap">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.fmap">[docs]</a>
<span class="k">def</span> <span class="nf">fmap</span><span class="p">(</span><span class="n">future</span><span class="p">,</span> <span class="n">map_fun</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Maps a future&#39;s result through a callback.</span>

<span class="sd">    Resolves to the application of ``map_fun`` to the result of ``future``.</span>

<span class="sd">    .. warning:: this does *not* recursively resolve futures, if that&#39;s what</span>
<span class="sd">                 you need see :func:`fchain`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fmap_future</span> <span class="o">=</span> <span class="n">Future</span><span class="p">()</span>
    <span class="nd">@future</span><span class="o">.</span><span class="n">add_done_callback</span>
    <span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fmap_future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">map_fun</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">fmap_future</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fmap_future</span></div>


<div class="viewcode-block" id="fchain">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.fchain">[docs]</a>
<span class="k">def</span> <span class="nf">fchain</span><span class="p">(</span><span class="n">future</span><span class="p">,</span> <span class="n">next_callback</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Chains a future&#39;s result to a new future through a callback.</span>

<span class="sd">    Corresponds to the ``bind`` monadic operation (aka flatmap aka then...</span>
<span class="sd">    kinda).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_future</span> <span class="o">=</span> <span class="n">Future</span><span class="p">()</span>
    <span class="nd">@future</span><span class="o">.</span><span class="n">add_done_callback</span>
    <span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">next_callback</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
            <span class="nd">@n</span><span class="o">.</span><span class="n">add_done_callback</span>
            <span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">new_future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">new_future</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">new_future</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_future</span></div>


<div class="viewcode-block" id="save_test_file">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.save_test_file">[docs]</a>
<span class="k">def</span> <span class="nf">save_test_file</span><span class="p">(</span><span class="n">test_name</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">_logger</span><span class="p">,</span> <span class="n">document_type</span><span class="o">=</span><span class="s1">&#39;Screenshot&#39;</span><span class="p">,</span> <span class="n">date_format</span><span class="o">=</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S_</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\w*_&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[a-z]+&#39;</span><span class="p">,</span> <span class="n">extension</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\w+&#39;</span><span class="p">,</span> <span class="n">test_name</span><span class="p">)</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">date_format</span><span class="p">)</span>
    <span class="n">screenshots_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">odoo</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;screenshots&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">get_db_name</span><span class="p">()</span> <span class="o">/</span> <span class="s1">&#39;screenshots&#39;</span>
    <span class="n">screenshots_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">now</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">test_name</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">full_path</span> <span class="o">=</span> <span class="n">screenshots_dir</span> <span class="o">/</span> <span class="n">fname</span>

    <span class="k">with</span> <span class="n">full_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">runbot</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">document_type</span><span class="si">}</span><span class="s1"> in: </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="ChromeBrowser">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.ChromeBrowser">[docs]</a>
<span class="k">class</span> <span class="nc">ChromeBrowser</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Helper object to control a Chrome headless process. &quot;&quot;&quot;</span>
    <span class="n">remote_debugging_port</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 9222, change it in a non-git-tracked file</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_class</span><span class="p">,</span> <span class="n">headless</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">test_class</span><span class="o">.</span><span class="n">_logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_class</span> <span class="o">=</span> <span class="n">test_class</span>
        <span class="k">if</span> <span class="n">websocket</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;websocket-client module is not installed&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;websocket-client module is not installed&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_data_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_chrome_odoo&#39;</span><span class="p">)</span>

        <span class="n">otc</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screencasts_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screencast_frames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">otc</span><span class="p">[</span><span class="s1">&#39;screencasts&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screencasts_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">otc</span><span class="p">[</span><span class="s1">&#39;screencasts&#39;</span><span class="p">],</span> <span class="n">get_db_name</span><span class="p">(),</span> <span class="s1">&#39;screencasts&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screencasts_frames_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;posix&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sigxcpu_handler</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">getsignal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGXCPU</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGXCPU</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal_handler</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sigxcpu_handler</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">chrome</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">devtools_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chrome_start</span><span class="p">(</span>
            <span class="n">user_data_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_data_dir</span><span class="p">,</span>
            <span class="n">window_size</span><span class="o">=</span><span class="n">test_class</span><span class="o">.</span><span class="n">browser_size</span><span class="p">,</span>
            <span class="n">touch_enabled</span><span class="o">=</span><span class="n">test_class</span><span class="o">.</span><span class="n">touch_enabled</span><span class="p">,</span>
            <span class="n">headless</span><span class="o">=</span><span class="n">headless</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_websocket</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request_id</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="n">Future</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_checker</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">had_failure</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># maps request_id to Futures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_responses</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># maps frame ids to callbacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frames</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Runtime.consoleAPICalled&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_console</span><span class="p">,</span>
            <span class="s1">&#39;Runtime.exceptionThrown&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_exception</span><span class="p">,</span>
            <span class="s1">&#39;Page.frameStoppedLoading&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_frame_stopped_loading</span><span class="p">,</span>
            <span class="s1">&#39;Page.screencastFrame&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_screencast_frame</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_receiver</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_receive</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;WebSocket events consumer&quot;</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">get_db_name</span><span class="p">(),)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_receiver</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Enable chrome headless console log notification&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_websocket_send</span><span class="p">(</span><span class="s1">&#39;Runtime.enable&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Chrome headless enable page notifications&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_websocket_send</span><span class="p">(</span><span class="s1">&#39;Page.enable&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">screencasts_frames_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screencasts_dir</span><span class="p">,</span> <span class="s1">&#39;frames&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="ChromeBrowser.signal_handler">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.ChromeBrowser.signal_handler">[docs]</a>
    <span class="k">def</span> <span class="nf">signal_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sig</span> <span class="o">==</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGXCPU</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CPU time limit reached, stopping Chrome and shutting down&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="ChromeBrowser.stop">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.ChromeBrowser.stop">[docs]</a>
    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ws&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_websocket_send</span><span class="p">(</span><span class="s1">&#39;Page.stopScreencast&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">screencasts_dir</span><span class="p">:</span>
                <span class="n">screencasts_frames_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">screencasts_frames_dir</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">screencasts_dir</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">screencasts_frames_dir</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">screencasts_frames_dir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_websocket_request</span><span class="p">(</span><span class="s1">&#39;Page.stopLoading&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_websocket_request</span><span class="p">(</span><span class="s1">&#39;Runtime.evaluate&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;expression&#39;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            (&#39;serviceWorker&#39; in navigator) &amp;&amp;</span>
<span class="s2">                navigator.serviceWorker.getRegistrations().then(</span>
<span class="s2">                    registrations =&gt; Promise.all(registrations.map(r =&gt; r.unregister()))</span>
<span class="s2">                )</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="s1">&#39;awaitPromise&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
            <span class="c1"># wait for the screenshot or whatever</span>
            <span class="n">wait</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_responses</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="mi">10</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Closing chrome headless with pid </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chrome</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_websocket_send</span><span class="p">(</span><span class="s1">&#39;Browser.close&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Closing websocket connection&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chrome</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Terminating chrome headless with pid </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chrome</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chrome</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_data_dir</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_data_dir</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_data_dir</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removing chrome user profile &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_data_dir</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_data_dir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Restore previous signal handler</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigxcpu_handler</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;posix&#39;</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGXCPU</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigxcpu_handler</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">executable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_find_executable</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_chrome_without_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;posix&#39;</span> <span class="ow">and</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;Darwin&#39;</span><span class="p">:</span>
            <span class="c1"># since the introduction of pointer compression in Chrome 80 (v8 v8.0),</span>
            <span class="c1"># the memory reservation algorithm requires more than 8GiB of</span>
            <span class="c1"># virtual mem for alignment this exceeds our default memory limits.</span>
            <span class="k">def</span> <span class="nf">preexec</span><span class="p">():</span>
                <span class="kn">import</span> <span class="nn">resource</span>
                <span class="n">resource</span><span class="o">.</span><span class="n">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_AS</span><span class="p">,</span> <span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIM_INFINITY</span><span class="p">,</span> <span class="n">resource</span><span class="o">.</span><span class="n">RLIM_INFINITY</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">preexec</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># pylint: disable=subprocess-popen-preexec-fn</span>
        <span class="k">return</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span> <span class="n">preexec_fn</span><span class="o">=</span><span class="n">preexec</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_spawn_chrome</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chrome_without_limit</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">port_file</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_data_dir</span><span class="p">,</span> <span class="s1">&#39;DevToolsActivePort&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">CHECK_BROWSER_ITERATIONS</span><span class="p">):</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">CHECK_BROWSER_SLEEP</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">port_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="n">port_file</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">port_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">proc</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
        <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed to detect chrome devtools port after </span><span class="si">{</span><span class="n">BROWSER_WAIT</span><span class="w"> </span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">s.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_chrome_start</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">user_data_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">window_size</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">touch_enabled</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="n">headless</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="n">headless_switches</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;--headless&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--disable-extensions&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--disable-background-networking&#39;</span> <span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--disable-background-timer-throttling&#39;</span> <span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--disable-backgrounding-occluded-windows&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--disable-renderer-backgrounding&#39;</span> <span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--disable-breakpad&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--disable-client-side-phishing-detection&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--disable-crash-reporter&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--disable-dev-shm-usage&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--disable-namespace-sandbox&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--disable-translate&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--no-sandbox&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--disable-gpu&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">switches</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># required for tours that use Youtube autoplay conditions (namely website_slides&#39; &quot;course_tour&quot;)</span>
            <span class="s1">&#39;--autoplay-policy&#39;</span><span class="p">:</span> <span class="s1">&#39;no-user-gesture-required&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--disable-default-apps&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--disable-device-discovery-notifications&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--no-default-browser-check&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--remote-debugging-address&#39;</span><span class="p">:</span> <span class="n">HOST</span><span class="p">,</span>
            <span class="s1">&#39;--remote-debugging-port&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_debugging_port</span><span class="p">),</span>
            <span class="s1">&#39;--user-data-dir&#39;</span><span class="p">:</span> <span class="n">user_data_dir</span><span class="p">,</span>
            <span class="s1">&#39;--window-size&#39;</span><span class="p">:</span> <span class="n">window_size</span><span class="p">,</span>
            <span class="s1">&#39;--no-first-run&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="c1"># &#39;--enable-precise-memory-info&#39;: &#39;&#39;, # uncomment to debug memory leaks in qunit suite</span>
            <span class="c1"># &#39;--js-flags&#39;: &#39;--expose-gc&#39;, # uncomment to debug memory leaks in qunit suite</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">headless</span><span class="p">:</span>
            <span class="n">switches</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">headless_switches</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">touch_enabled</span><span class="p">:</span>
            <span class="c1"># enable Chrome&#39;s Touch mode, useful to detect touch capabilities using</span>
            <span class="c1"># &quot;&#39;ontouchstart&#39; in window&quot;</span>
            <span class="n">switches</span><span class="p">[</span><span class="s1">&#39;--touch-events&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">executable</span><span class="p">]</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="k">else</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">switches</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;about:blank&#39;</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">proc</span><span class="p">,</span> <span class="n">devtools_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spawn_chrome</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not found&quot;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Chrome pid: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">proc</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Chrome headless temporary user profile dir: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_data_dir</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">proc</span><span class="p">,</span> <span class="n">devtools_port</span>

    <span class="k">def</span> <span class="nf">_json_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Queries browser state using JSON</span>

<span class="sd">        Available commands:</span>

<span class="sd">        ``&#39;&#39;``</span>
<span class="sd">            return list of tabs with their id</span>
<span class="sd">        ``list`` (or ``json/``)</span>
<span class="sd">            list tabs</span>
<span class="sd">        ``new``</span>
<span class="sd">            open a new tab</span>
<span class="sd">        :samp:`activate/{id}`</span>
<span class="sd">            activate a tab</span>
<span class="sd">        :samp:`close/{id}`</span>
<span class="sd">            close a tab</span>
<span class="sd">        ``version``</span>
<span class="sd">            get chrome and dev tools version</span>
<span class="sd">        ``protocol``</span>
<span class="sd">            get the full protocol</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="n">command</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">url_join</span><span class="p">(</span><span class="s1">&#39;http://</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">/&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">devtools_port</span><span class="p">),</span> <span class="n">command</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Issuing json command </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">failure_info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">message</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chrome</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ProcessLookupError</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Chrome crashed at startup&#39;</span>
                <span class="k">break</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">failure_info</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Connection Error while trying to connect to Chrome debugger&#39;</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ReadTimeout</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">failure_info</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Connection Timeout while trying to connect to Chrome debugger&#39;</span>
                <span class="k">break</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
            <span class="n">timeout</span> <span class="o">-=</span> <span class="n">delay</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="n">delay</span> <span class="o">*</span> <span class="mf">1.5</span>
            <span class="n">tries</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> after </span><span class="si">%s</span><span class="s2"> tries&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">tries</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">failure_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">failure_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;Error during Chrome headless connection&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_open_websocket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_command</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Browser version: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">version</span><span class="p">[</span><span class="s1">&#39;Browser&#39;</span><span class="p">])</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">5.0</span><span class="p">:</span>
            <span class="n">ws_url</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span>
                <span class="n">target</span><span class="p">[</span><span class="s1">&#39;webSocketDebuggerUrl&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_command</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">target</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;page&#39;</span>
                <span class="k">if</span> <span class="n">target</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;about:blank&#39;</span>
            <span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ws_url</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;Error during Chrome connection: never found &#39;page&#39; target&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Websocket url found: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ws_url</span><span class="p">)</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="n">websocket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">(</span><span class="n">ws_url</span><span class="p">,</span> <span class="n">enable_multithread</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">suppress_origin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ws</span><span class="o">.</span><span class="n">getstatus</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">101</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;Cannot connect to chrome dev tools&quot;</span><span class="p">)</span>
        <span class="n">ws</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ws</span>

    <span class="k">def</span> <span class="nf">_receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbname</span><span class="p">):</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">dbname</span> <span class="o">=</span> <span class="n">dbname</span>
        <span class="c1"># So CDT uses a streamed JSON-RPC structure, meaning a request is</span>
        <span class="c1"># {id, method, params} and eventually a {id, result | error} should</span>
        <span class="c1"># arrive the other way, however for events it uses &quot;notifications&quot;</span>
        <span class="c1"># meaning request objects without an ``id``, but *coming from the server</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span> <span class="c1"># or maybe until `self._result` is `done()`?</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&lt;- </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">websocket</span><span class="o">.</span><span class="n">WebSocketTimeoutException</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># if the socket is still connected something bad happened,</span>
                <span class="c1"># otherwise the client was just shut down</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">raise</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="n">res</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">request_id</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">request_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">handler</span><span class="p">:</span>
                        <span class="n">handler</span><span class="p">(</span><span class="o">**</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_responses</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">f</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;result&#39;</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">ChromeBrowserException</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">][</span><span class="s1">&#39;message&#39;</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">msg</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[:</span><span class="mi">500</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;While processing message </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_websocket_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">10.0</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">threading</span><span class="o">.</span><span class="n">get_ident</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receiver</span><span class="o">.</span><span class="n">ident</span><span class="p">,</span>\
            <span class="s2">&quot;_websocket_request must not be called from the consumer thread&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_websocket_send</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">with_future</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="n">params</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_websocket_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_future</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;send chrome devtools protocol commands through websocket</span>

<span class="sd">        If ``with_future`` is set, returns a ``Future`` for the operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">request_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_future</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_responses</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">Future</span><span class="p">()</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">request_id</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">-&gt; </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_handle_console</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stackTrace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span> <span class="c1"># pylint: disable=redefined-builtin</span>
        <span class="c1"># console formatting differs somewhat from Python&#39;s, if args[0] has</span>
        <span class="c1"># format modifiers that many of args[1:] get formatted in, missing</span>
        <span class="c1"># args are replaced by empty strings and extra args are concatenated</span>
        <span class="c1"># (space-separated)</span>
        <span class="c1">#</span>
        <span class="c1"># current version modifies the args in place which could and should</span>
        <span class="c1"># probably be improved</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">arg0</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_remoteobject</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arg0</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">[]</span>
        <span class="n">formatted</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;%[</span><span class="si">%s</span><span class="s1">dfoOc]&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">console_formatter</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">arg0</span><span class="p">)]</span>
        <span class="c1"># formatter consumes args it uses, leaves unformatted args untouched</span>
        <span class="n">formatted</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_remoteobject</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formatted</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_format_stack</span><span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span> <span class="s1">&#39;stackTrace&#39;</span><span class="p">:</span> <span class="n">stackTrace</span><span class="p">}))</span>
        <span class="k">if</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">stack</span>

        <span class="n">log_type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="n">_logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">getChild</span><span class="p">(</span><span class="s1">&#39;browser&#39;</span><span class="p">)</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_TO_LEVEL</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">log_type</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">),</span>
            <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Error received after termination: &quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">done</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">message</span> <span class="c1"># might still have %&lt;x&gt; characters</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">log_type</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">had_failure</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_checker</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_checker</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">take_screenshot</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_save_screencast</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">ChromeBrowserException</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                <span class="k">except</span> <span class="n">CancelledError</span><span class="p">:</span>
                    <span class="o">...</span>
                <span class="k">except</span> <span class="n">InvalidStateError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Trying to set result to failed (</span><span class="si">%s</span><span class="s2">) but found the future settled (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
                        <span class="n">message</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span>
                    <span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;test successful&#39;</span> <span class="ow">in</span> <span class="n">message</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_class</span><span class="o">.</span><span class="n">allow_end_on_form</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">qs</span> <span class="o">=</span> <span class="n">fchain</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_websocket_send</span><span class="p">(</span><span class="s1">&#39;DOM.getDocument&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="n">with_future</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_websocket_send</span><span class="p">(</span><span class="s2">&quot;DOM.querySelector&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;nodeId&#39;</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">][</span><span class="s1">&#39;nodeId&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;selector&#39;</span><span class="p">:</span> <span class="s1">&#39;.o_form_dirty&#39;</span><span class="p">,</span>
                <span class="p">},</span> <span class="n">with_future</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="nd">@qs</span><span class="o">.</span><span class="n">add_done_callback</span>
            <span class="k">def</span> <span class="nf">_qs_result</span><span class="p">(</span><span class="n">fut</span><span class="p">):</span>
                <span class="n">node_id</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                    <span class="n">node_id</span> <span class="o">=</span> <span class="n">fut</span><span class="o">.</span><span class="n">result</span><span class="p">()[</span><span class="s1">&#39;nodeId&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">node_id</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">take_screenshot</span><span class="p">(</span><span class="s2">&quot;unsaved_form_&quot;</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">Tour finished with an open form view in edition mode.</span>

<span class="s2">Form views in edition mode are automatically saved when the page is closed, </span><span class="se">\</span>
<span class="s2">which leads to stray network requests and inconsistencies.&quot;&quot;&quot;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                        <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">ChromeBrowserException</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
                    <span class="k">return</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">exception</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># if the future was already failed, we&#39;re happy,</span>
                    <span class="c1"># otherwise swap for a new failed</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Tried to make the tour successful twice.&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_handle_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exceptionDetails</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">exceptionDetails</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>
        <span class="n">exception</span> <span class="o">=</span> <span class="n">exceptionDetails</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exception&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exception</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_remoteobject</span><span class="p">(</span><span class="n">exception</span><span class="p">))</span>
        <span class="n">exceptionDetails</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;trace&#39;</span>  <span class="c1"># fake this so _format_stack works</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_format_stack</span><span class="p">(</span><span class="n">exceptionDetails</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">stack</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">getChild</span><span class="p">(</span><span class="s1">&#39;browser&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Exception received after termination: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">take_screenshot</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_screencast</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">ChromeBrowserException</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">CancelledError</span><span class="p">:</span>
            <span class="o">...</span>
        <span class="k">except</span> <span class="n">InvalidStateError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Trying to set result to failed (</span><span class="si">%s</span><span class="s2">) but found the future settled (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="n">message</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_handle_frame_stopped_loading</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frameId</span><span class="p">):</span>
        <span class="n">wait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frames</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">frameId</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="n">wait</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_handle_screencast_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sessionId</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">screencasts_frames_dir</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_websocket_send</span><span class="p">(</span><span class="s1">&#39;Page.screencastFrameAck&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sessionId&#39;</span><span class="p">:</span> <span class="n">sessionId</span><span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">screencasts_dir</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screencasts_frames_dir</span><span class="p">,</span> <span class="s1">&#39;frame_</span><span class="si">%05d</span><span class="s1">.b64&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screencast_frames</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">screencast_frames</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;file_path&#39;</span><span class="p">:</span> <span class="n">outfile</span><span class="p">,</span>
                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">)</span>
                <span class="p">})</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Useless screencast frame skipped: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>

    <span class="n">_TO_LEVEL</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
        <span class="s1">&#39;log&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
        <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
        <span class="s1">&#39;warning&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
        <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
        <span class="c1"># TODO: what do with</span>
        <span class="c1"># dir, dirxml, table, trace, clear, startGroup, startGroupCollapsed,</span>
        <span class="c1"># endGroup, assert, profile, profileEnd, count, timeEnd</span>
    <span class="p">}</span>

<div class="viewcode-block" id="ChromeBrowser.take_screenshot">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.ChromeBrowser.take_screenshot">[docs]</a>
    <span class="k">def</span> <span class="nf">take_screenshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;sc_&#39;</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">base_png</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">base_png</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t capture screenshot: expected image data, got ?? error ??&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">decoded</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">base_png</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">save_test_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">decoded</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Asking for screenshot&#39;</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_websocket_send</span><span class="p">(</span><span class="s1">&#39;Page.captureScreenshot&#39;</span><span class="p">,</span> <span class="n">with_future</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span></div>


    <span class="k">def</span> <span class="nf">_save_screencast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;failed&#39;</span><span class="p">):</span>
        <span class="c1"># could be encododed with something like that</span>
        <span class="c1">#  ffmpeg -framerate 3 -i frame_%05d.png  output.mp4</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">screencast_frames</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No screencast frames to encode&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stop_screencast</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screencast_frames</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;file_path&#39;</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">b64_file</span><span class="p">:</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">decodebytes</span><span class="p">(</span><span class="n">b64_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;file_path&#39;</span><span class="p">])</span>
            <span class="n">f</span><span class="p">[</span><span class="s1">&#39;file_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;file_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.b64&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;file_path&#39;</span><span class="p">],</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">png_file</span><span class="p">:</span>
                <span class="n">png_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S_</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_screencast_</span><span class="si">%s</span><span class="s1">.mp4&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screencasts_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ffmpeg_path</span> <span class="o">=</span> <span class="n">find_in_path</span><span class="p">(</span><span class="s1">&#39;ffmpeg&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">ffmpeg_path</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">ffmpeg_path</span><span class="p">:</span>
            <span class="n">nb_frames</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screencast_frames</span><span class="p">)</span>
            <span class="n">concat_script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screencasts_dir</span><span class="p">,</span> <span class="n">fname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.mp4&#39;</span><span class="p">,</span> <span class="s1">&#39;.txt&#39;</span><span class="p">))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">concat_script_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">concat_file</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_frames</span><span class="p">):</span>
                    <span class="n">frame_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screencasts_frames_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">screencast_frames</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;file_path&#39;</span><span class="p">])</span>
                    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">nb_frames</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">screencast_frames</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
                    <span class="n">duration</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">screencast_frames</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
                    <span class="n">concat_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;file &#39;</span><span class="si">%s</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">duration </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">frame_file_path</span><span class="p">,</span> <span class="n">duration</span><span class="p">))</span>
                <span class="n">concat_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;file &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">frame_file_path</span><span class="p">)</span>  <span class="c1"># needed by the concat plugin</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">ffmpeg_path</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;concat&#39;</span><span class="p">,</span> <span class="s1">&#39;-safe&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="n">concat_script_path</span><span class="p">,</span> <span class="s1">&#39;-pix_fmt&#39;</span><span class="p">,</span> <span class="s1">&#39;yuv420p&#39;</span><span class="p">,</span> <span class="s1">&#39;-g&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="n">outfile</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to encode screencast.&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="s1">&#39;Screencast in: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;.mp4&#39;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screencasts_frames_dir</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">runbot</span><span class="p">(</span><span class="s1">&#39;Screencast frames in: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>

<div class="viewcode-block" id="ChromeBrowser.start_screencast">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.ChromeBrowser.start_screencast">[docs]</a>
    <span class="k">def</span> <span class="nf">start_screencast</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">screencasts_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_websocket_send</span><span class="p">(</span><span class="s1">&#39;Page.startScreencast&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ChromeBrowser.stop_screencast">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.ChromeBrowser.stop_screencast">[docs]</a>
    <span class="k">def</span> <span class="nf">stop_screencast</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_websocket_send</span><span class="p">(</span><span class="s1">&#39;Page.stopScreencast&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ChromeBrowser.set_cookie">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.ChromeBrowser.set_cookie">[docs]</a>
    <span class="k">def</span> <span class="nf">set_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span> <span class="s1">&#39;domain&#39;</span><span class="p">:</span> <span class="n">domain</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_websocket_request</span><span class="p">(</span><span class="s1">&#39;Network.setCookie&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="ChromeBrowser.delete_cookie">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.ChromeBrowser.delete_cookie">[docs]</a>
    <span class="k">def</span> <span class="nf">delete_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;domain&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">]}</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_websocket_request</span><span class="p">(</span><span class="s1">&#39;Network.deleteCookies&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span></div>


    <span class="k">def</span> <span class="nf">_wait_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ready_code</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
        <span class="n">ready_code</span> <span class="o">=</span> <span class="n">ready_code</span> <span class="ow">or</span> <span class="s2">&quot;document.readyState === &#39;complete&#39;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Evaluate ready code &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="n">ready_code</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">taken</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="k">if</span> <span class="n">taken</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_websocket_request</span><span class="p">(</span><span class="s1">&#39;Runtime.evaluate&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;expression&#39;</span><span class="p">:</span> <span class="s2">&quot;try { </span><span class="si">%s</span><span class="s2"> } catch </span><span class="si">{}</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ready_code</span><span class="p">,</span>
                <span class="s1">&#39;awaitPromise&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="o">-</span><span class="n">taken</span><span class="p">)[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}:</span>
                <span class="n">time_to_ready</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
                <span class="k">if</span> <span class="n">taken</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;The ready code tooks too much time : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">time_to_ready</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">take_screenshot</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;sc_failed_ready_&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Ready code last try result: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_wait_code_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">error_checker</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_checker</span> <span class="o">=</span> <span class="n">error_checker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Evaluate test code &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_websocket_request</span><span class="p">(</span><span class="s1">&#39;Runtime.evaluate&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;expression&#39;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
            <span class="s1">&#39;awaitPromise&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subtype&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ChromeBrowserException</span><span class="p">(</span><span class="s2">&quot;Running code returned an error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">res</span><span class="p">)</span>

        <span class="n">err</span> <span class="o">=</span> <span class="n">ChromeBrowserException</span><span class="p">(</span><span class="s2">&quot;failed&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># if the runcode was a promise which took some time to execute,</span>
            <span class="c1"># discount that from the timeout</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">had_failure</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="n">CancelledError</span><span class="p">:</span>
            <span class="c1"># regular-ish shutdown</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">e</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">take_screenshot</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_screencast</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">ChromeBrowserException</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">err</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ChromeBrowserException</span><span class="p">(</span><span class="s1">&#39;Script timeout exceeded&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
        <span class="k">raise</span> <span class="n">ChromeBrowserException</span><span class="p">(</span><span class="s2">&quot;Unknown error&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>

<div class="viewcode-block" id="ChromeBrowser.navigate_to">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.ChromeBrowser.navigate_to">[docs]</a>
    <span class="k">def</span> <span class="nf">navigate_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">wait_stop</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Navigating to: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="n">nav_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_websocket_request</span><span class="p">(</span><span class="s1">&#39;Page.navigate&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">url</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">20.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Navigation result: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">nav_result</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wait_stop</span><span class="p">:</span>
            <span class="n">frame_id</span> <span class="o">=</span> <span class="n">nav_result</span><span class="p">[</span><span class="s1">&#39;frameId&#39;</span><span class="p">]</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_frames</span><span class="p">[</span><span class="n">frame_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">set</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Waiting for frame </span><span class="si">%r</span><span class="s1"> to stop loading&#39;</span><span class="p">,</span> <span class="n">frame_id</span><span class="p">)</span>
            <span class="n">e</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_from_remoteobject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; attempts to make a CDT RemoteObject comprehensible</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">objtype</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="n">subtype</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subtype&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">objtype</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">:</span>
            <span class="c1"># the undefined remoteobject is literally just {type: undefined}...</span>
            <span class="k">return</span> <span class="s1">&#39;undefined&#39;</span>
        <span class="k">elif</span> <span class="n">objtype</span> <span class="o">!=</span> <span class="s1">&#39;object&#39;</span> <span class="ow">or</span> <span class="n">subtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;array&#39;</span><span class="p">):</span>
            <span class="c1"># value is the json representation for json object</span>
            <span class="c1"># otherwise fallback on the description which is &quot;a string</span>
            <span class="c1"># representation of the object&quot; e.g. the traceback for errors, the</span>
            <span class="c1"># source for functions, ... finally fallback on the entire arg mess</span>
            <span class="k">return</span> <span class="n">arg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">subtype</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span><span class="p">:</span>
            <span class="c1"># apparently value is *not* the JSON representation for arrays</span>
            <span class="c1"># instead it&#39;s just Array(3) which is useless, however the preview</span>
            <span class="c1"># properties are the same as object which is useful (just ignore the</span>
            <span class="c1"># name which is the index)</span>
            <span class="k">return</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;preview&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="c1"># all that&#39;s left is type=object, subtype=None aka custom or</span>
        <span class="c1"># non-standard objects, print as TypeName(param=val, ...), sadly because</span>
        <span class="c1"># of the way Odoo widgets are created they all appear as Class(...)</span>
        <span class="c1"># nb: preview properties are *not* recursive, the value is *all* we get</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">arg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;className&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span>
            <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="nb">repr</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span> <span class="k">else</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;preview&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="n">LINE_PATTERN</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">at </span><span class="si">%(functionName)s</span><span class="s1"> (</span><span class="si">%(url)s</span><span class="s1">:</span><span class="si">%(lineNumber)d</span><span class="s1">:</span><span class="si">%(columnNumber)d</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">def</span> <span class="nf">_format_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logrecord</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">logrecord</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;trace&#39;</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="n">logrecord</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stackTrace&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">trace</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">trace</span><span class="p">[</span><span class="s1">&#39;callFrames&#39;</span><span class="p">]:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">LINE_PATTERN</span> <span class="o">%</span> <span class="n">f</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parent&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="ChromeBrowser.console_formatter">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.ChromeBrowser.console_formatter">[docs]</a>
    <span class="k">def</span> <span class="nf">console_formatter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Formats similarly to the console API:</span>

<span class="sd">        * if there are no args, don&#39;t format (return string as-is)</span>
<span class="sd">        * %% -&gt; %</span>
<span class="sd">        * %c -&gt; replace by styling directives (ignore for us)</span>
<span class="sd">        * other known formatters -&gt; replace by corresponding argument</span>
<span class="sd">        * leftover known formatters (args exhausted) -&gt; replace by empty string</span>
<span class="sd">        * unknown formatters -&gt; return as-is</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">replacer</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;%&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;%&#39;</span>
            <span class="k">if</span> <span class="n">fmt</span> <span class="ow">in</span> <span class="s1">&#39;sdfoOc&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;&#39;</span>
                <span class="n">repl</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;&#39;</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_remoteobject</span><span class="p">(</span><span class="n">repl</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">replacer</span></div>
</div>


<span class="nd">@lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_find_executable</span><span class="p">():</span>
    <span class="n">system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">system</span> <span class="o">==</span> <span class="s1">&#39;Linux&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">bin_</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;google-chrome&#39;</span><span class="p">,</span> <span class="s1">&#39;chromium&#39;</span><span class="p">,</span> <span class="s1">&#39;chromium-browser&#39;</span><span class="p">,</span> <span class="s1">&#39;google-chrome-stable&#39;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">find_in_path</span><span class="p">(</span><span class="n">bin_</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">continue</span>

    <span class="k">elif</span> <span class="n">system</span> <span class="o">==</span> <span class="s1">&#39;Darwin&#39;</span><span class="p">:</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;/Applications/Google Chrome.app/Contents/MacOS/Google Chrome&#39;</span><span class="p">,</span>
            <span class="s1">&#39;/Applications/Chromium.app/Contents/MacOS/Chromium&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">bin_</span> <span class="ow">in</span> <span class="n">bins</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bin_</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">bin_</span>

    <span class="k">elif</span> <span class="n">system</span> <span class="o">==</span> <span class="s1">&#39;Windows&#39;</span><span class="p">:</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;%ProgramFiles%</span><span class="se">\\</span><span class="s1">Google</span><span class="se">\\</span><span class="s1">Chrome</span><span class="se">\\</span><span class="s1">Application</span><span class="se">\\</span><span class="s1">chrome.exe&#39;</span><span class="p">,</span>
            <span class="s1">&#39;%ProgramFiles(x86)%</span><span class="se">\\</span><span class="s1">Google</span><span class="se">\\</span><span class="s1">Chrome</span><span class="se">\\</span><span class="s1">Application</span><span class="se">\\</span><span class="s1">chrome.exe&#39;</span><span class="p">,</span>
            <span class="s1">&#39;</span><span class="si">%Lo</span><span class="s1">calAppData%</span><span class="se">\\</span><span class="s1">Google</span><span class="se">\\</span><span class="s1">Chrome</span><span class="se">\\</span><span class="s1">Application</span><span class="se">\\</span><span class="s1">chrome.exe&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">bin_</span> <span class="ow">in</span> <span class="n">bins</span><span class="p">:</span>
            <span class="n">bin_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">bin_</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bin_</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">bin_</span>

    <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;Chrome executable not found&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Opener">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.Opener">[docs]</a>
<span class="k">class</span> <span class="nc">Opener</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flushes and clears the current transaction when starting a request.</span>

<span class="sd">    This is likely necessary when we make a request to the server, as the</span>
<span class="sd">    request is made with a test cursor, which uses a different cache than this</span>
<span class="sd">    transaction.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">:</span> <span class="n">BaseCursor</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cr</span> <span class="o">=</span> <span class="n">cr</span>

<div class="viewcode-block" id="Opener.request">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.Opener.request">[docs]</a>
    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Transport">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.Transport">[docs]</a>
<span class="k">class</span> <span class="nc">Transport</span><span class="p">(</span><span class="n">xmlrpclib</span><span class="o">.</span><span class="n">Transport</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; see :class:`Opener` &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="p">:</span> <span class="n">BaseCursor</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cr</span> <span class="o">=</span> <span class="n">cr</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

<div class="viewcode-block" id="Transport.request">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.Transport.request">[docs]</a>
    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="JsonRpcException">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.JsonRpcException">[docs]</a>
<span class="k">class</span> <span class="nc">JsonRpcException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span></div>



<div class="viewcode-block" id="HttpCase">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.HttpCase">[docs]</a>
<span class="k">class</span> <span class="nc">HttpCase</span><span class="p">(</span><span class="n">TransactionCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Transactional HTTP TestCase with url_open and Chrome headless helpers. &quot;&quot;&quot;</span>
    <span class="n">registry_test_mode</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">browser</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">browser_size</span> <span class="o">=</span> <span class="s1">&#39;1366x768&#39;</span>
    <span class="n">touch_enabled</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">allow_end_on_form</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">_logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="HttpCase.setUpClass">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.HttpCase.setUpClass">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUpClass</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">registry_test_mode</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">enter_test_mode</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">addClassCleanup</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">leave_test_mode</span><span class="p">)</span>

        <span class="n">ICP</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.config_parameter&#39;</span><span class="p">]</span>
        <span class="n">ICP</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="s1">&#39;web.base.url&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">base_url</span><span class="p">())</span>
        <span class="n">ICP</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
        <span class="c1"># v8 api with correct xmlrpc exception handling.</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">xmlrpc_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;http://</span><span class="si">{</span><span class="n">HOST</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">odoo</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;http_port&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">d</span><span class="si">}</span><span class="s1">/xmlrpc/2/&#39;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span></div>


<div class="viewcode-block" id="HttpCase.setUp">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.HttpCase.setUp">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xmlrpc_common</span> <span class="o">=</span> <span class="n">xmlrpclib</span><span class="o">.</span><span class="n">ServerProxy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xmlrpc_url</span> <span class="o">+</span> <span class="s1">&#39;common&#39;</span><span class="p">,</span> <span class="n">transport</span><span class="o">=</span><span class="n">Transport</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xmlrpc_db</span> <span class="o">=</span> <span class="n">xmlrpclib</span><span class="o">.</span><span class="n">ServerProxy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xmlrpc_url</span> <span class="o">+</span> <span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="n">transport</span><span class="o">=</span><span class="n">Transport</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xmlrpc_object</span> <span class="o">=</span> <span class="n">xmlrpclib</span><span class="o">.</span><span class="n">ServerProxy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xmlrpc_url</span> <span class="o">+</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span> <span class="n">transport</span><span class="o">=</span><span class="n">Transport</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="p">))</span>
        <span class="c1"># setup an url opener helper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opener</span> <span class="o">=</span> <span class="n">Opener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span></div>


<div class="viewcode-block" id="HttpCase.url_open">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.HttpCase.url_open">[docs]</a>
    <span class="k">def</span> <span class="nf">url_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">head</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">()</span> <span class="o">+</span> <span class="n">url</span>
        <span class="k">if</span> <span class="n">head</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">opener</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">or</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">opener</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="n">allow_redirects</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">opener</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="n">allow_redirects</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_wait_remaining_requests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">get_http_request_threads</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threading</span><span class="o">.</span><span class="n">enumerate</span><span class="p">()</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;odoo.service.http.request.&#39;</span><span class="p">)]</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">request_threads</span> <span class="o">=</span> <span class="n">get_http_request_threads</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;waiting for threads: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">request_threads</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">request_threads</span><span class="p">:</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span> <span class="o">-</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>

        <span class="n">request_threads</span> <span class="o">=</span> <span class="n">get_http_request_threads</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">request_threads</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stop waiting for thread </span><span class="si">%s</span><span class="s2"> handling request for url </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="n">thread</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;UNKNOWN&gt;&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">request_threads</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;remaining requests&#39;</span><span class="p">)</span>
            <span class="n">odoo</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">dumpstacks</span><span class="p">()</span>

<div class="viewcode-block" id="HttpCase.logout">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.HttpCase.logout">[docs]</a>
    <span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep_db</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">logout</span><span class="p">(</span><span class="n">keep_db</span><span class="o">=</span><span class="n">keep_db</span><span class="p">)</span>
        <span class="n">odoo</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">session_store</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span></div>


<div class="viewcode-block" id="HttpCase.authenticate">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.HttpCase.authenticate">[docs]</a>
    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">browser</span><span class="p">:</span> <span class="n">ChromeBrowser</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;session&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">odoo</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">session_store</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">session_store</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">odoo</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">get_default_session</span><span class="p">(),</span> <span class="n">db</span><span class="o">=</span><span class="n">get_db_name</span><span class="p">())</span>
        <span class="n">session</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;lang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">DEFAULT_LANG</span>

        <span class="k">if</span> <span class="n">user</span><span class="p">:</span> <span class="c1"># if authenticated</span>
            <span class="c1"># Flush and clear the current transaction.  This is useful, because</span>
            <span class="c1"># the call below opens a test cursor, which uses a different cache</span>
            <span class="c1"># than this transaction.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;interactive&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
            <span class="n">env</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">session</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">uid</span>
            <span class="n">session</span><span class="o">.</span><span class="n">login</span> <span class="o">=</span> <span class="n">user</span>
            <span class="n">session</span><span class="o">.</span><span class="n">session_token</span> <span class="o">=</span> <span class="n">uid</span> <span class="ow">and</span> <span class="n">security</span><span class="o">.</span><span class="n">compute_session_token</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">context_get</span><span class="p">())</span>

        <span class="n">odoo</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">session_store</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="c1"># Reset the opener: turns out when we set cookies[&#39;foo&#39;] we&#39;re really</span>
        <span class="c1"># setting a cookie on domain=&#39;&#39; path=&#39;/&#39;.</span>
        <span class="c1">#</span>
        <span class="c1"># But then our friendly neighborhood server might set a cookie for</span>
        <span class="c1"># domain=&#39;localhost&#39; path=&#39;/&#39; (with the same value) which is considered</span>
        <span class="c1"># a *different* cookie following ours rather than the same.</span>
        <span class="c1">#</span>
        <span class="c1"># When we update our cookie, it&#39;s done in-place, so the server-set</span>
        <span class="c1"># cookie is still present and (as it follows ours and is more precise)</span>
        <span class="c1"># very likely to still be used, therefore our session change is ignored.</span>
        <span class="c1">#</span>
        <span class="c1"># An alternative would be to set the cookie to None (unsetting it</span>
        <span class="c1"># completely) or clear-ing session.cookies.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opener</span> <span class="o">=</span> <span class="n">Opener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opener</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="s1">&#39;session_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">sid</span>
        <span class="k">if</span> <span class="n">browser</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting session cookie in browser&#39;</span><span class="p">)</span>
            <span class="n">browser</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">HOST</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">session</span></div>


<div class="viewcode-block" id="HttpCase.browser_js">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.HttpCase.browser_js">[docs]</a>
    <span class="k">def</span> <span class="nf">browser_js</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url_path</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">ready</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">login</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">error_checker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">watch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Test js code running in the browser</span>
<span class="sd">        - optionnally log as &#39;login&#39;</span>
<span class="sd">        - load page given by url_path</span>
<span class="sd">        - wait for ready object to be available</span>
<span class="sd">        - eval(code) inside the page</span>

<span class="sd">        To signal success test do: console.log(&#39;test successful&#39;)</span>
<span class="sd">        To signal test failure raise an exception or call console.error with a message.</span>
<span class="sd">        Test will stop when a failure occurs if error_checker is not defined or returns True for this message</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">loaded</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;HttpCase test should be in post_install only&#39;</span><span class="p">)</span>

        <span class="c1"># increase timeout if coverage is running</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/coverage/execfile.py&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>  <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="o">*</span> <span class="mf">1.5</span>

        <span class="k">if</span> <span class="n">watch</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;watch mode is only suitable for local testing&#39;</span><span class="p">)</span>

        <span class="n">browser</span> <span class="o">=</span> <span class="n">ChromeBrowser</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">headless</span><span class="o">=</span><span class="ow">not</span> <span class="n">watch</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">login</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">browser</span><span class="o">=</span><span class="n">browser</span><span class="p">)</span>
            <span class="c1"># Flush and clear the current transaction.  This is useful in case</span>
            <span class="c1"># we make requests to the server, as these requests are made with</span>
            <span class="c1"># test cursors, which uses different caches than this transaction.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">url_join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">(),</span> <span class="n">url_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">watch</span><span class="p">:</span>
                <span class="n">parsed</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">url_parse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="n">qs</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">decode_query</span><span class="p">()</span>
                <span class="n">qs</span><span class="p">[</span><span class="s1">&#39;watch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">werkzeug</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">url_encode</span><span class="p">(</span><span class="n">qs</span><span class="p">))</span><span class="o">.</span><span class="n">to_url</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Open &quot;</span><span class="si">%s</span><span class="s1">&quot; in browser&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">browser</span><span class="o">.</span><span class="n">screencasts_dir</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting screencast&#39;</span><span class="p">)</span>
                <span class="n">browser</span><span class="o">.</span><span class="n">start_screencast</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cookies</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cookies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">browser</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">HOST</span><span class="p">)</span>

            <span class="n">browser</span><span class="o">.</span><span class="n">navigate_to</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">wait_stop</span><span class="o">=</span><span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ready</span><span class="p">))</span>

            <span class="c1"># Needed because tests like test01.js (qunit tests) are passing a ready</span>
            <span class="c1"># code = &quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">browser</span><span class="o">.</span><span class="n">_wait_ready</span><span class="p">(</span><span class="n">ready</span><span class="p">),</span> <span class="s1">&#39;The ready &quot;</span><span class="si">%s</span><span class="s1">&quot; code was always falsy&#39;</span> <span class="o">%</span> <span class="n">ready</span><span class="p">)</span>

            <span class="n">error</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">browser</span><span class="o">.</span><span class="n">_wait_code_ok</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">error_checker</span><span class="o">=</span><span class="n">error_checker</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ChromeBrowserException</span> <span class="k">as</span> <span class="n">chrome_browser_exception</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">chrome_browser_exception</span>
            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>  <span class="c1"># dont keep initial traceback, keep that outside of except</span>
                <span class="k">if</span> <span class="n">code</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;The test code &quot;</span><span class="si">%s</span><span class="s1">&quot; failed&#39;</span> <span class="o">%</span> <span class="n">code</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Some js test failed&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">browser</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wait_remaining_requests</span><span class="p">()</span></div>


<div class="viewcode-block" id="HttpCase.base_url">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.HttpCase.base_url">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">base_url</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;http://</span><span class="si">{</span><span class="n">HOST</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">odoo</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;http_port&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="HttpCase.start_tour">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.HttpCase.start_tour">[docs]</a>
    <span class="k">def</span> <span class="nf">start_tour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url_path</span><span class="p">,</span> <span class="n">tour_name</span><span class="p">,</span> <span class="n">step_delay</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrapper for `browser_js` to start the given `tour_name` with the</span>
<span class="sd">        optional delay between steps `step_delay`. Other arguments from</span>
<span class="sd">        `browser_js` can be passed as keyword arguments.&quot;&quot;&quot;</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;stepDelay&#39;</span><span class="p">:</span> <span class="n">step_delay</span> <span class="k">if</span> <span class="n">step_delay</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;keepWatchBrowser&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;watch&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;startUrl&#39;</span><span class="p">:</span> <span class="n">url_path</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s2">&quot;odoo.startTour(&#39;</span><span class="si">%s</span><span class="s2">&#39;, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tour_name</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">options</span><span class="p">)))</span>
        <span class="n">ready</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="s2">&quot;odoo.isTourReady(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="n">tour_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser_js</span><span class="p">(</span><span class="n">url_path</span><span class="o">=</span><span class="n">url_path</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span> <span class="n">ready</span><span class="o">=</span><span class="n">ready</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="HttpCase.profile">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.HttpCase.profile">[docs]</a>
    <span class="k">def</span> <span class="nf">profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        for http_case, also patch _get_profiler_context_manager in order to profile all requests</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sup</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span>
        <span class="n">_profiler</span> <span class="o">=</span> <span class="n">sup</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">route_profiler</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">sup</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">full_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">profiler</span><span class="o">.</span><span class="n">Nested</span><span class="p">(</span><span class="n">_profiler</span><span class="p">,</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;odoo.http.Request._get_profiler_context_manager&#39;</span><span class="p">,</span> <span class="n">route_profiler</span><span class="p">))</span></div>


<div class="viewcode-block" id="HttpCase.make_jsonrpc_request">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.HttpCase.make_jsonrpc_request">[docs]</a>
    <span class="k">def</span> <span class="nf">make_jsonrpc_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make a JSON-RPC request to the server.</span>

<span class="sd">        :param str route: the route to request</span>
<span class="sd">        :param dict params: the parameters to send</span>
<span class="sd">        :raises requests.HTTPError: if one occurred</span>
<span class="sd">        :raises JsonRpcException: if the response contains an error</span>
<span class="sd">        :return: The &#39;result&#39; key from the response if any.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span>
            <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
        <span class="p">})</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;application/json&#39;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_open</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">decoded_response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;result&#39;</span> <span class="ow">in</span> <span class="n">decoded_response</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">decoded_response</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">decoded_response</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">JsonRpcException</span><span class="p">(</span>
                <span class="n">code</span><span class="o">=</span><span class="n">decoded_response</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">][</span><span class="s1">&#39;code&#39;</span><span class="p">],</span>
                <span class="n">message</span><span class="o">=</span><span class="n">decoded_response</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="no_retry">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.no_retry">[docs]</a>
<span class="k">def</span> <span class="nf">no_retry</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Disable auto retry on decorated test method or test class&quot;&quot;&quot;</span>
    <span class="n">arg</span><span class="o">.</span><span class="n">_retry</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">arg</span></div>



<div class="viewcode-block" id="users">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.users">[docs]</a>
<span class="k">def</span> <span class="nf">users</span><span class="p">(</span><span class="o">*</span><span class="n">logins</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Decorate a method to execute it once for each given user. &quot;&quot;&quot;</span>
    <span class="nd">@decorator</span>
    <span class="k">def</span> <span class="nf">_users</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">old_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># retrieve users</span>
            <span class="n">Users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">user</span><span class="o">.</span><span class="n">login</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
                <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">Users</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">logins</span><span class="p">))])</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">login</span> <span class="ow">in</span> <span class="n">logins</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="n">login</span><span class="o">=</span><span class="n">login</span><span class="p">):</span>
                    <span class="c1"># switch user and execute func</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">[</span><span class="n">login</span><span class="p">]</span>
                    <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c1"># Invalidate the cache between subtests, in order to not reuse</span>
                <span class="c1"># the former user&#39;s cache (`test_read_mail`, `test_write_mail`)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">old_uid</span>

    <span class="k">return</span> <span class="n">_users</span></div>



<div class="viewcode-block" id="warmup">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.warmup">[docs]</a>
<span class="nd">@decorator</span>
<span class="k">def</span> <span class="nf">warmup</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Decorate a test method to run it twice: once for a warming up phase, and</span>
<span class="sd">        a second time for real.  The test attribute ``warm`` is set to ``False``</span>
<span class="sd">        during warm up, and ``True`` once the test is warmed up.  Note that the</span>
<span class="sd">        effects of the warmup phase are rolled back thanks to a savepoint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>
    <span class="c1"># run once to warm up the caches</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">warm</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SAVEPOINT test_warmup&#39;</span><span class="p">)</span>
    <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
    <span class="c1"># run once for real</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;ROLLBACK TO SAVEPOINT test_warmup&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">warm</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="can_import">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.can_import">[docs]</a>
<span class="k">def</span> <span class="nf">can_import</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Checks if &lt;module&gt; can be imported, returns ``True`` if it can be,</span>
<span class="sd">    ``False`` otherwise.</span>

<span class="sd">    To use with ``unittest.skipUnless`` for tests conditional on *optional*</span>
<span class="sd">    dependencies, which may or may be present but must still be tested if</span>
<span class="sd">    possible.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="tagged">
<a class="viewcode-back" href="../../../odoo.tests.html#odoo.tests.common.tagged">[docs]</a>
<span class="k">def</span> <span class="nf">tagged</span><span class="p">(</span><span class="o">*</span><span class="n">tags</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A decorator to tag BaseCase objects.</span>

<span class="sd">    Tags are stored in a set that can be accessed from a &#39;test_tags&#39; attribute.</span>

<span class="sd">    A tag prefixed by &#39;-&#39; will remove the tag e.g. to remove the &#39;standard&#39; tag.</span>

<span class="sd">    By default, all Test classes from odoo.tests.common have a test_tags</span>
<span class="sd">    attribute that defaults to &#39;standard&#39; and &#39;at_install&#39;.</span>

<span class="sd">    When using class inheritance, the tags ARE inherited.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">include</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)}</span>
    <span class="n">exclude</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)}</span>

    <span class="k">def</span> <span class="nf">tags_decorator</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">test_tags</span> <span class="o">=</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;test_tags&#39;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span> <span class="o">|</span> <span class="n">include</span><span class="p">)</span> <span class="o">-</span> <span class="n">exclude</span>
        <span class="n">at_install</span> <span class="o">=</span> <span class="s1">&#39;at_install&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">test_tags</span>
        <span class="n">post_install</span> <span class="o">=</span> <span class="s1">&#39;post_install&#39;</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">test_tags</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">at_install</span> <span class="o">^</span> <span class="n">post_install</span><span class="p">):</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;A tests should be either at_install or post_install, which is not the case of </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="k">return</span> <span class="n">tags_decorator</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Amr.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>