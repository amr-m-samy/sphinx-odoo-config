<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>odoo.addons.base.models.res_currency &mdash; Amr  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Amr
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modules.html">odoo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Amr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../../odoo.html">odoo</a></li>
          <li class="breadcrumb-item"><a href="../../base.html">odoo.addons.base</a></li>
      <li class="breadcrumb-item active">odoo.addons.base.models.res_currency</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for odoo.addons.base.models.res_currency</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># Part of Odoo. See LICENSE file for full copyright and licensing details.</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>

<span class="kn">from</span> <span class="nn">odoo</span> <span class="kn">import</span> <span class="n">api</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">tools</span><span class="p">,</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">odoo.exceptions</span> <span class="kn">import</span> <span class="n">UserError</span><span class="p">,</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">odoo.tools</span> <span class="kn">import</span> <span class="n">parse_date</span>

<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">num2words</span> <span class="kn">import</span> <span class="n">num2words</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The num2words python library is not installed, amount-to-text features won&#39;t be fully available.&quot;</span><span class="p">)</span>
    <span class="n">num2words</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="Currency">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_currency.Currency">[docs]</a>
<span class="k">class</span> <span class="nc">Currency</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s2">&quot;res.currency&quot;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s2">&quot;Currency&quot;</span>
    <span class="n">_rec_names_search</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;full_name&#39;</span><span class="p">]</span>
    <span class="n">_order</span> <span class="o">=</span> <span class="s1">&#39;active desc, name&#39;</span>

    <span class="c1"># Note: &#39;code&#39; column was removed as of v6.0, the &#39;name&#39; should now hold the ISO code.</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Currency&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Currency Code (ISO 4217)&quot;</span><span class="p">)</span>
    <span class="n">full_name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
    <span class="n">symbol</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;Currency sign, to be used when printing amounts.&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">rate</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_current_rate&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Current Rate&#39;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The rate of the currency to the currency of rate 1.&#39;</span><span class="p">)</span>
    <span class="n">inverse_rate</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_current_rate&#39;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The currency of rate 1 to the rate of the currency.&#39;</span><span class="p">)</span>
    <span class="n">rate_string</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_current_rate&#39;</span><span class="p">)</span>
    <span class="n">rate_ids</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">One2many</span><span class="p">(</span><span class="s1">&#39;res.currency.rate&#39;</span><span class="p">,</span> <span class="s1">&#39;currency_id&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Rates&#39;</span><span class="p">)</span>
    <span class="n">rounding</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Rounding Factor&#39;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Amounts in this currency are rounded off to the nearest multiple of the rounding factor.&#39;</span><span class="p">)</span>
    <span class="n">decimal_places</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Integer</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_decimal_places&#39;</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Decimal places taken into account for operations on amounts in this currency. It is determined by the rounding factor.&#39;</span><span class="p">)</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">position</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Selection</span><span class="p">([(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="s1">&#39;After Amount&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;Before Amount&#39;</span><span class="p">)],</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;after&#39;</span><span class="p">,</span>
        <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Symbol Position&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Determines where the currency symbol should be placed after or before the amount.&quot;</span><span class="p">)</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_date&#39;</span><span class="p">)</span>
    <span class="n">currency_unit_label</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s2">&quot;Currency Unit&quot;</span><span class="p">)</span>
    <span class="n">currency_subunit_label</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s2">&quot;Currency Subunit&quot;</span><span class="p">)</span>
    <span class="n">is_current_company_currency</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_is_current_company_currency&#39;</span><span class="p">)</span>

    <span class="n">_sql_constraints</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;unique_name&#39;</span><span class="p">,</span> <span class="s1">&#39;unique (name)&#39;</span><span class="p">,</span> <span class="s1">&#39;The currency code must be unique!&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;rounding_gt_zero&#39;</span><span class="p">,</span> <span class="s1">&#39;CHECK (rounding&gt;0)&#39;</span><span class="p">,</span> <span class="s1">&#39;The rounding factor must be greater than 0!&#39;</span><span class="p">)</span>
    <span class="p">]</span>

<div class="viewcode-block" id="Currency.create">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_currency.Currency.create">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model_create_multi</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">vals_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_toggle_group_multi_currency</span><span class="p">()</span>
        <span class="c1"># Currency info is cached to reduce the number of SQL queries when building the session</span>
        <span class="c1"># info. See `ir_http.get_currencies`.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="Currency.unlink">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_currency.Currency.unlink">[docs]</a>
    <span class="k">def</span> <span class="nf">unlink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_toggle_group_multi_currency</span><span class="p">()</span>
        <span class="c1"># Currency info is cached to reduce the number of SQL queries when building the session</span>
        <span class="c1"># info. See `ir_http.get_currencies`.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="Currency.write">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_currency.Currency.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">{</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="s1">&#39;digits&#39;</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="s1">&#39;symbol&#39;</span><span class="p">}:</span>
            <span class="c1"># Currency info is cached to reduce the number of SQL queries when building the session</span>
            <span class="c1"># info. See `ir_http.get_currencies`.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;active&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_toggle_group_multi_currency</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_toggle_group_multi_currency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Automatically activate group_multi_currency if there is more than 1 active currency; deactivate it otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">active_currency_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_count</span><span class="p">([(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">active_currency_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_activate_group_multi_currency</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">active_currency_count</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_deactivate_group_multi_currency</span><span class="p">()</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_activate_group_multi_currency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">group_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.group_user&#39;</span><span class="p">,</span> <span class="n">raise_if_not_found</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">group_mc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.group_multi_currency&#39;</span><span class="p">,</span> <span class="n">raise_if_not_found</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group_user</span> <span class="ow">and</span> <span class="n">group_mc</span><span class="p">:</span>
            <span class="n">group_user</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">_apply_group</span><span class="p">(</span><span class="n">group_mc</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_deactivate_group_multi_currency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">group_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.group_user&#39;</span><span class="p">,</span> <span class="n">raise_if_not_found</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">group_mc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.group_multi_currency&#39;</span><span class="p">,</span> <span class="n">raise_if_not_found</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group_user</span> <span class="ow">and</span> <span class="n">group_mc</span><span class="p">:</span>
            <span class="n">group_user</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">_remove_group</span><span class="p">(</span><span class="n">group_mc</span><span class="o">.</span><span class="n">sudo</span><span class="p">())</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_company_currency_stays_active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;install_mode&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;force_deactivate&#39;</span><span class="p">):</span>
            <span class="c1"># install_mode : At install, when this check is run, the &quot;active&quot; field of a currency added to a company will</span>
            <span class="c1">#                still be evaluated as False, despite it&#39;s automatically set at True when added to the company.</span>
            <span class="c1"># force_deactivate : Allows deactivation of a currency in tests to enable non multi_currency behaviors</span>
            <span class="k">return</span>

        <span class="n">currencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;currency_id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">currencies</span><span class="o">.</span><span class="n">ids</span><span class="p">)]):</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;This currency is set on a company and therefore cannot be deactivated.&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">company</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.currency.rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flush_model</span><span class="p">([</span><span class="s1">&#39;rate&#39;</span><span class="p">,</span> <span class="s1">&#39;currency_id&#39;</span><span class="p">,</span> <span class="s1">&#39;company_id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT c.id,</span>
<span class="s2">                          COALESCE((SELECT r.rate FROM res_currency_rate r</span>
<span class="s2">                                  WHERE r.currency_id = c.id AND r.name &lt;= </span><span class="si">%s</span>
<span class="s2">                                    AND (r.company_id IS NULL OR r.company_id = </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                               ORDER BY r.company_id, r.name DESC</span>
<span class="s2">                                  LIMIT 1), 1.0) AS rate</span>
<span class="s2">                   FROM res_currency c</span>
<span class="s2">                   WHERE c.id IN </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">company</span><span class="o">.</span><span class="n">root_id</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)))</span>
        <span class="n">currency_rates</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">currency_rates</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends_context</span><span class="p">(</span><span class="s1">&#39;company&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_is_current_company_currency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">currency</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">currency</span><span class="o">.</span><span class="n">is_current_company_currency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">root_id</span><span class="o">.</span><span class="n">currency_id</span> <span class="o">==</span> <span class="n">currency</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;rate_ids.rate&#39;</span><span class="p">)</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">depends_context</span><span class="p">(</span><span class="s1">&#39;to_currency&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;company&#39;</span><span class="p">,</span> <span class="s1">&#39;company_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_current_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fields</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">context_today</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">company</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;company_id&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span>
        <span class="n">company</span> <span class="o">=</span> <span class="n">company</span><span class="o">.</span><span class="n">root_id</span>
        <span class="n">to_currency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;to_currency&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="n">company</span><span class="o">.</span><span class="n">currency_id</span>
        <span class="c1"># the subquery selects the last rate before &#39;date&#39; for the given currency/company</span>
        <span class="n">currency_rates</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span> <span class="o">+</span> <span class="n">to_currency</span><span class="p">)</span><span class="o">.</span><span class="n">_get_rates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">currency</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">currency</span><span class="o">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">currency_rates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">currency</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">/</span> <span class="n">currency_rates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">to_currency</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">currency</span><span class="o">.</span><span class="n">inverse_rate</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">currency</span><span class="o">.</span><span class="n">rate</span>
            <span class="k">if</span> <span class="n">currency</span> <span class="o">!=</span> <span class="n">company</span><span class="o">.</span><span class="n">currency_id</span><span class="p">:</span>
                <span class="n">currency</span><span class="o">.</span><span class="n">rate_string</span> <span class="o">=</span> <span class="s1">&#39;1 </span><span class="si">%s</span><span class="s1"> = </span><span class="si">%.6f</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">to_currency</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">currency</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="n">currency</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">currency</span><span class="o">.</span><span class="n">rate_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;rounding&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_decimal_places</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">currency</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">currency</span><span class="o">.</span><span class="n">rounding</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">currency</span><span class="o">.</span><span class="n">decimal_places</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">currency</span><span class="o">.</span><span class="n">rounding</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">currency</span><span class="o">.</span><span class="n">decimal_places</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;rate_ids.name&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">currency</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">currency</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">currency</span><span class="o">.</span><span class="n">rate_ids</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>

<div class="viewcode-block" id="Currency.amount_to_text">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_currency.Currency.amount_to_text">[docs]</a>
    <span class="k">def</span> <span class="nf">amount_to_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">_num2words</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">lang</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">num2words</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="n">lang</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">num2words</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="s1">&#39;en&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">num2words</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The library &#39;num2words&#39; is missing, cannot render textual amounts.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="n">formatted</span> <span class="o">=</span> <span class="s2">&quot;%.</span><span class="si">{0}</span><span class="s2">f&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decimal_places</span><span class="p">)</span> <span class="o">%</span> <span class="n">amount</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">formatted</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">integer_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">fractional_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">lang</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">get_lang</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
        <span class="n">amount_words</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">ustr</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{amt_value}</span><span class="s1"> </span><span class="si">{amt_word}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">amt_value</span><span class="o">=</span><span class="n">_num2words</span><span class="p">(</span><span class="n">integer_value</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="n">lang</span><span class="o">.</span><span class="n">iso_code</span><span class="p">),</span>
                        <span class="n">amt_word</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">currency_unit_label</span><span class="p">,</span>
                        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_zero</span><span class="p">(</span><span class="n">amount</span> <span class="o">-</span> <span class="n">integer_value</span><span class="p">):</span>
            <span class="n">amount_words</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;and&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">tools</span><span class="o">.</span><span class="n">ustr</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{amt_value}</span><span class="s1"> </span><span class="si">{amt_word}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">amt_value</span><span class="o">=</span><span class="n">_num2words</span><span class="p">(</span><span class="n">fractional_value</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="n">lang</span><span class="o">.</span><span class="n">iso_code</span><span class="p">),</span>
                        <span class="n">amt_word</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">currency_subunit_label</span><span class="p">,</span>
                        <span class="p">)</span>
        <span class="k">return</span> <span class="n">amount_words</span></div>


<div class="viewcode-block" id="Currency.format">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_currency.Currency.format">[docs]</a>
    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return ``amount`` formatted according to ``self``&#39;s rounding rules, symbols and positions.</span>

<span class="sd">           Also take care of removing the minus sign when 0.0 is negative</span>

<span class="sd">           :param float amount: the amount to round</span>
<span class="sd">           :return: formatted str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">tools</span><span class="o">.</span><span class="n">format_amount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">amount</span> <span class="o">+</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="Currency.round">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_currency.Currency.round">[docs]</a>
    <span class="k">def</span> <span class="nf">round</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return ``amount`` rounded  according to ``self``&#39;s rounding rules.</span>

<span class="sd">           :param float amount: the amount to round</span>
<span class="sd">           :return: rounded float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">tools</span><span class="o">.</span><span class="n">float_round</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">precision_rounding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rounding</span><span class="p">)</span></div>


<div class="viewcode-block" id="Currency.compare_amounts">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_currency.Currency.compare_amounts">[docs]</a>
    <span class="k">def</span> <span class="nf">compare_amounts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount1</span><span class="p">,</span> <span class="n">amount2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compare ``amount1`` and ``amount2`` after rounding them according to the</span>
<span class="sd">           given currency&#39;s precision..</span>
<span class="sd">           An amount is considered lower/greater than another amount if their rounded</span>
<span class="sd">           value is different. This is not the same as having a non-zero difference!</span>

<span class="sd">           For example 1.432 and 1.431 are equal at 2 digits precision,</span>
<span class="sd">           so this method would return 0.</span>
<span class="sd">           However 0.006 and 0.002 are considered different (returns 1) because</span>
<span class="sd">           they respectively round to 0.01 and 0.0, even though</span>
<span class="sd">           0.006-0.002 = 0.004 which would be considered zero at 2 digits precision.</span>

<span class="sd">           :param float amount1: first amount to compare</span>
<span class="sd">           :param float amount2: second amount to compare</span>
<span class="sd">           :return: (resp.) -1, 0 or 1, if ``amount1`` is (resp.) lower than,</span>
<span class="sd">                    equal to, or greater than ``amount2``, according to</span>
<span class="sd">                    ``currency``&#39;s rounding.</span>

<span class="sd">           With the new API, call it like: ``currency.compare_amounts(amount1, amount2)``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">tools</span><span class="o">.</span><span class="n">float_compare</span><span class="p">(</span><span class="n">amount1</span><span class="p">,</span> <span class="n">amount2</span><span class="p">,</span> <span class="n">precision_rounding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rounding</span><span class="p">)</span></div>


<div class="viewcode-block" id="Currency.is_zero">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_currency.Currency.is_zero">[docs]</a>
    <span class="k">def</span> <span class="nf">is_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns true if ``amount`` is small enough to be treated as</span>
<span class="sd">           zero according to current currency&#39;s rounding rules.</span>
<span class="sd">           Warning: ``is_zero(amount1-amount2)`` is not always equivalent to</span>
<span class="sd">           ``compare_amounts(amount1,amount2) == 0``, as the former will round after</span>
<span class="sd">           computing the difference, while the latter will round before, giving</span>
<span class="sd">           different results for e.g. 0.006 and 0.002 at 2 digits precision.</span>

<span class="sd">           :param float amount: amount to compare with currency&#39;s zero</span>

<span class="sd">           With the new API, call it like: ``currency.is_zero(amount)``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">tools</span><span class="o">.</span><span class="n">float_is_zero</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">precision_rounding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rounding</span><span class="p">)</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_conversion_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_currency</span><span class="p">,</span> <span class="n">to_currency</span><span class="p">,</span> <span class="n">company</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">from_currency</span> <span class="o">==</span> <span class="n">to_currency</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="n">company</span> <span class="o">=</span> <span class="n">company</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">date</span> <span class="ow">or</span> <span class="n">fields</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">context_today</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">from_currency</span><span class="o">.</span><span class="n">with_company</span><span class="p">(</span><span class="n">company</span><span class="p">)</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">to_currency</span><span class="o">=</span><span class="n">to_currency</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="p">))</span><span class="o">.</span><span class="n">inverse_rate</span>

    <span class="k">def</span> <span class="nf">_convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_amount</span><span class="p">,</span> <span class="n">to_currency</span><span class="p">,</span> <span class="n">company</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">round</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>  <span class="c1"># noqa: A002 builtin-argument-shadowing</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the converted amount of ``from_amount``` from the currency</span>
<span class="sd">           ``self`` to the currency ``to_currency`` for the given ``date`` and</span>
<span class="sd">           company.</span>

<span class="sd">           :param company: The company from which we retrieve the convertion rate</span>
<span class="sd">           :param date: The nearest date from which we retriev the conversion rate.</span>
<span class="sd">           :param round: Round the result or not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">to_currency</span> <span class="o">=</span> <span class="bp">self</span> <span class="ow">or</span> <span class="n">to_currency</span><span class="p">,</span> <span class="n">to_currency</span> <span class="ow">or</span> <span class="bp">self</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;convert amount from unknown currency&quot;</span>
        <span class="k">assert</span> <span class="n">to_currency</span><span class="p">,</span> <span class="s2">&quot;convert amount to unknown currency&quot;</span>
        <span class="c1"># apply conversion rate</span>
        <span class="k">if</span> <span class="n">from_amount</span><span class="p">:</span>
            <span class="n">to_amount</span> <span class="o">=</span> <span class="n">from_amount</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_conversion_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_currency</span><span class="p">,</span> <span class="n">company</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>

        <span class="c1"># apply rounding</span>
        <span class="k">return</span> <span class="n">to_currency</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">to_amount</span><span class="p">)</span> <span class="k">if</span> <span class="nb">round</span> <span class="k">else</span> <span class="n">to_amount</span>

    <span class="k">def</span> <span class="nf">_select_companies_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT</span>
<span class="s2">                r.currency_id,</span>
<span class="s2">                COALESCE(r.company_id, c.id) as company_id,</span>
<span class="s2">                r.rate,</span>
<span class="s2">                r.name AS date_start,</span>
<span class="s2">                (SELECT name FROM res_currency_rate r2</span>
<span class="s2">                 WHERE r2.name &gt; r.name AND</span>
<span class="s2">                       r2.currency_id = r.currency_id AND</span>
<span class="s2">                       (r2.company_id is null or r2.company_id = c.id)</span>
<span class="s2">                 ORDER BY r2.name ASC</span>
<span class="s2">                 LIMIT 1) AS date_end</span>
<span class="s2">            FROM res_currency_rate r</span>
<span class="s2">            JOIN res_company c ON (r.company_id is null or r.company_id = c.id)</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_view_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">view_type</span><span class="o">=</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The override of _get_view changing the rate field labels according to the company currency</span>
<span class="sd">        makes the view cache dependent on the company currency&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_view_cache_key</span><span class="p">(</span><span class="n">view_id</span><span class="p">,</span> <span class="n">view_type</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">key</span> <span class="o">+</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;company_id&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">root_id</span><span class="p">)</span><span class="o">.</span><span class="n">currency_id</span><span class="o">.</span><span class="n">name</span><span class="p">,)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">view_type</span><span class="o">=</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">arch</span><span class="p">,</span> <span class="n">view</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_view</span><span class="p">(</span><span class="n">view_id</span><span class="p">,</span> <span class="n">view_type</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">view_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;tree&#39;</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">):</span>
            <span class="n">currency_name</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;company_id&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">root_id</span><span class="p">)</span><span class="o">.</span><span class="n">currency_id</span><span class="o">.</span><span class="n">name</span>
            <span class="n">fields_maps</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[[</span><span class="s1">&#39;company_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;rate&#39;</span><span class="p">],</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Unit per </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">currency_name</span><span class="p">)],</span>
                <span class="p">[[</span><span class="s1">&#39;inverse_company_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;inverse_rate&#39;</span><span class="p">],</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> per Unit&#39;</span><span class="p">,</span> <span class="n">currency_name</span><span class="p">)],</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">fnames</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">fields_maps</span><span class="p">:</span>
                <span class="n">xpath_expression</span> <span class="o">=</span> <span class="s1">&#39;//tree//field[&#39;</span> <span class="o">+</span> <span class="s2">&quot; or &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;@name=&#39;</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;][1]&quot;</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">arch</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">xpath_expression</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">node</span><span class="p">:</span>
                    <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arch</span><span class="p">,</span> <span class="n">view</span></div>



<div class="viewcode-block" id="CurrencyRate">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_currency.CurrencyRate">[docs]</a>
<span class="k">class</span> <span class="nc">CurrencyRate</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s2">&quot;res.currency.rate&quot;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s2">&quot;Currency Rate&quot;</span>
    <span class="n">_rec_names_search</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;rate&#39;</span><span class="p">]</span>
    <span class="n">_order</span> <span class="o">=</span> <span class="s2">&quot;name desc&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">default</span><span class="o">=</span><span class="n">fields</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">context_today</span><span class="p">)</span>
    <span class="n">rate</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span>
        <span class="n">digits</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">group_operator</span><span class="o">=</span><span class="s2">&quot;avg&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The rate of the currency to the currency of rate 1&#39;</span><span class="p">,</span>
        <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Technical Rate&#39;</span>
    <span class="p">)</span>
    <span class="n">company_rate</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span>
        <span class="n">digits</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">compute</span><span class="o">=</span><span class="s2">&quot;_compute_company_rate&quot;</span><span class="p">,</span>
        <span class="n">inverse</span><span class="o">=</span><span class="s2">&quot;_inverse_company_rate&quot;</span><span class="p">,</span>
        <span class="n">group_operator</span><span class="o">=</span><span class="s2">&quot;avg&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The currency of rate 1 to the rate of the currency.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">inverse_company_rate</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span>
        <span class="n">digits</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">compute</span><span class="o">=</span><span class="s2">&quot;_compute_inverse_company_rate&quot;</span><span class="p">,</span>
        <span class="n">inverse</span><span class="o">=</span><span class="s2">&quot;_inverse_inverse_company_rate&quot;</span><span class="p">,</span>
        <span class="n">group_operator</span><span class="o">=</span><span class="s2">&quot;avg&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The rate of the currency to the currency of rate 1 &quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">currency_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;res.currency&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Currency&#39;</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s2">&quot;cascade&quot;</span><span class="p">)</span>
    <span class="n">company_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;res.company&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Company&#39;</span><span class="p">,</span>
                                 <span class="n">default</span><span class="o">=</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">root_id</span><span class="p">)</span>

    <span class="n">_sql_constraints</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;unique_name_per_day&#39;</span><span class="p">,</span> <span class="s1">&#39;unique (name,currency_id,company_id)&#39;</span><span class="p">,</span> <span class="s1">&#39;Only one currency rate per day allowed!&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;currency_rate_check&#39;</span><span class="p">,</span> <span class="s1">&#39;CHECK (rate&gt;0)&#39;</span><span class="p">,</span> <span class="s1">&#39;The currency rate must be strictly positive.&#39;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_sanitize_vals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;inverse_company_rate&#39;</span> <span class="ow">in</span> <span class="n">vals</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;company_rate&#39;</span> <span class="ow">in</span> <span class="n">vals</span> <span class="ow">or</span> <span class="s1">&#39;rate&#39;</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;inverse_company_rate&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;company_rate&#39;</span> <span class="ow">in</span> <span class="n">vals</span> <span class="ow">and</span> <span class="s1">&#39;rate&#39;</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;company_rate&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">vals</span>

<div class="viewcode-block" id="CurrencyRate.write">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_currency.CurrencyRate.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.currency&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">invalidate_model</span><span class="p">([</span><span class="s1">&#39;inverse_rate&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sanitize_vals</span><span class="p">(</span><span class="n">vals</span><span class="p">))</span></div>


<div class="viewcode-block" id="CurrencyRate.create">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_currency.CurrencyRate.create">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model_create_multi</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.currency&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">invalidate_model</span><span class="p">([</span><span class="s1">&#39;inverse_rate&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_sanitize_vals</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">vals_list</span><span class="p">])</span></div>


    <span class="k">def</span> <span class="nf">_get_latest_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Make sure &#39;name&#39; is defined when creating a new rate.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;The name for the current rate is empty.</span><span class="se">\n</span><span class="s2">Please set it.&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency_id</span><span class="o">.</span><span class="n">rate_ids</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">rate</span>
            <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">company_id</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">company_id</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">root_id</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="o">&lt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">fields</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">today</span><span class="p">())</span>
        <span class="p">))</span><span class="o">.</span><span class="n">sorted</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>

    <span class="k">def</span> <span class="nf">_get_last_rates_for_companies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">companies</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">company</span><span class="p">:</span> <span class="n">company</span><span class="o">.</span><span class="n">currency_id</span><span class="o">.</span><span class="n">rate_ids</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">x</span><span class="o">.</span><span class="n">rate</span>
                <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">company_id</span> <span class="o">==</span> <span class="n">company</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">company_id</span>
            <span class="p">))</span><span class="o">.</span><span class="n">sorted</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">rate</span> <span class="ow">or</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">company</span> <span class="ow">in</span> <span class="n">companies</span>
        <span class="p">}</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;currency_id&#39;</span><span class="p">,</span> <span class="s1">&#39;company_id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">currency_rate</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">currency_rate</span><span class="o">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">currency_rate</span><span class="o">.</span><span class="n">rate</span> <span class="ow">or</span> <span class="n">currency_rate</span><span class="o">.</span><span class="n">_get_latest_rate</span><span class="p">()</span><span class="o">.</span><span class="n">rate</span> <span class="ow">or</span> <span class="mf">1.0</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;rate&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;currency_id&#39;</span><span class="p">,</span> <span class="s1">&#39;company_id&#39;</span><span class="p">,</span> <span class="s1">&#39;currency_id.rate_ids.rate&#39;</span><span class="p">)</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">depends_context</span><span class="p">(</span><span class="s1">&#39;company&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_company_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">last_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.currency.rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_last_rates_for_companies</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">company_id</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">root_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">currency_rate</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">company</span> <span class="o">=</span> <span class="n">currency_rate</span><span class="o">.</span><span class="n">company_id</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">root_id</span>
            <span class="n">currency_rate</span><span class="o">.</span><span class="n">company_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">currency_rate</span><span class="o">.</span><span class="n">rate</span> <span class="ow">or</span> <span class="n">currency_rate</span><span class="o">.</span><span class="n">_get_latest_rate</span><span class="p">()</span><span class="o">.</span><span class="n">rate</span> <span class="ow">or</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">last_rate</span><span class="p">[</span><span class="n">company</span><span class="p">]</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">onchange</span><span class="p">(</span><span class="s1">&#39;company_rate&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_inverse_company_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">last_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.currency.rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_last_rates_for_companies</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">company_id</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">root_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">currency_rate</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">company</span> <span class="o">=</span> <span class="n">currency_rate</span><span class="o">.</span><span class="n">company_id</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">root_id</span>
            <span class="n">currency_rate</span><span class="o">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">currency_rate</span><span class="o">.</span><span class="n">company_rate</span> <span class="o">*</span> <span class="n">last_rate</span><span class="p">[</span><span class="n">company</span><span class="p">]</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;company_rate&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_inverse_company_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">currency_rate</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">currency_rate</span><span class="o">.</span><span class="n">company_rate</span><span class="p">:</span>
                <span class="n">currency_rate</span><span class="o">.</span><span class="n">company_rate</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">currency_rate</span><span class="o">.</span><span class="n">inverse_company_rate</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">currency_rate</span><span class="o">.</span><span class="n">company_rate</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">onchange</span><span class="p">(</span><span class="s1">&#39;inverse_company_rate&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_inverse_inverse_company_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">currency_rate</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">currency_rate</span><span class="o">.</span><span class="n">inverse_company_rate</span><span class="p">:</span>
                <span class="n">currency_rate</span><span class="o">.</span><span class="n">inverse_company_rate</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">currency_rate</span><span class="o">.</span><span class="n">company_rate</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">currency_rate</span><span class="o">.</span><span class="n">inverse_company_rate</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">onchange</span><span class="p">(</span><span class="s1">&#39;company_rate&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_onchange_rate_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">latest_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_latest_rate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">latest_rate</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">latest_rate</span><span class="o">.</span><span class="n">rate</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span> <span class="o">/</span> <span class="n">latest_rate</span><span class="o">.</span><span class="n">rate</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;warning&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Warning for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">currency_id</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span>
                            <span class="s2">&quot;The new rate is quite far from the previous rate.</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="s2">&quot;Incorrect currency rates may cause critical problems, make sure the rate is correct!&quot;</span>
                        <span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">}</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="s1">&#39;company_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_company_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">rate</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rate</span><span class="o">.</span><span class="n">company_id</span><span class="o">.</span><span class="n">parent_id</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Currency rates should only be created for main companies&quot;</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_name_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="s1">&#39;ilike&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_name_search</span><span class="p">(</span><span class="n">parse_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">domain</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_view_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">view_type</span><span class="o">=</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The override of _get_view changing the rate field labels according to the company currency</span>
<span class="sd">        makes the view cache dependent on the company currency&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_view_cache_key</span><span class="p">(</span><span class="n">view_id</span><span class="p">,</span> <span class="n">view_type</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">key</span> <span class="o">+</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;company_id&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">root_id</span><span class="p">)</span><span class="o">.</span><span class="n">currency_id</span><span class="o">.</span><span class="n">name</span><span class="p">,)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">view_type</span><span class="o">=</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">arch</span><span class="p">,</span> <span class="n">view</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_view</span><span class="p">(</span><span class="n">view_id</span><span class="p">,</span> <span class="n">view_type</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">view_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;tree&#39;</span><span class="p">):</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;company_currency_name&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;company_id&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">root_id</span><span class="p">)</span><span class="o">.</span><span class="n">currency_id</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;rate_currency_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.currency&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active_id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s1">&#39;Unit&#39;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[[</span><span class="s1">&#39;company_rate&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(rate_currency_name)s</span><span class="s1"> per </span><span class="si">%(company_currency_name)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">names</span><span class="p">)],</span>
                          <span class="p">[</span><span class="s1">&#39;inverse_company_rate&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(company_currency_name)s</span><span class="s1"> per </span><span class="si">%(rate_currency_name)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">names</span><span class="p">)]]:</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">arch</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&quot;//tree//field[@name=&#39;</span><span class="si">%s</span><span class="s2">&#39;]&quot;</span> <span class="o">%</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">node</span><span class="p">:</span>
                    <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">arch</span><span class="p">,</span> <span class="n">view</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Amr.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>