<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>odoo.addons.base.models.ir_model &mdash; Amr  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Amr
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modules.html">odoo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Amr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../../odoo.html">odoo</a></li>
          <li class="breadcrumb-item"><a href="../../base.html">odoo.addons.base</a></li>
      <li class="breadcrumb-item active">odoo.addons.base.models.ir_model</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for odoo.addons.base.models.ir_model</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># Part of Odoo. See LICENSE file for full copyright and licensing details.</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Mapping</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span>

<span class="kn">from</span> <span class="nn">psycopg2</span> <span class="kn">import</span> <span class="n">sql</span>
<span class="kn">from</span> <span class="nn">psycopg2.extras</span> <span class="kn">import</span> <span class="n">Json</span>
<span class="kn">from</span> <span class="nn">psycopg2.sql</span> <span class="kn">import</span> <span class="n">Identifier</span><span class="p">,</span> <span class="n">SQL</span><span class="p">,</span> <span class="n">Placeholder</span>

<span class="kn">from</span> <span class="nn">odoo</span> <span class="kn">import</span> <span class="n">api</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">tools</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_lt</span><span class="p">,</span> <span class="n">Command</span>
<span class="kn">from</span> <span class="nn">odoo.exceptions</span> <span class="kn">import</span> <span class="n">AccessError</span><span class="p">,</span> <span class="n">UserError</span><span class="p">,</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">odoo.osv</span> <span class="kn">import</span> <span class="n">expression</span>
<span class="kn">from</span> <span class="nn">odoo.tools</span> <span class="kn">import</span> <span class="n">pycompat</span><span class="p">,</span> <span class="n">unique</span><span class="p">,</span> <span class="n">OrderedSet</span>
<span class="kn">from</span> <span class="nn">odoo.tools.safe_eval</span> <span class="kn">import</span> <span class="n">safe_eval</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">dateutil</span><span class="p">,</span> <span class="n">time</span>

<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">MODULE_UNINSTALL_FLAG</span> <span class="o">=</span> <span class="s1">&#39;_force_unlink&#39;</span>
<span class="n">RE_ORDER_FIELDS</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&quot;?(\w+)&quot;?\s*(?:asc|desc)?&#39;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>

<span class="c1"># base environment for doing a safe_eval</span>
<span class="n">SAFE_EVAL_BASE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;datetime&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
    <span class="s1">&#39;dateutil&#39;</span><span class="p">:</span> <span class="n">dateutil</span><span class="p">,</span>
    <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="make_compute">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.make_compute">[docs]</a>
<span class="k">def</span> <span class="nf">make_compute</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">deps</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return a compute function from its code body and dependencies. &quot;&quot;&quot;</span>
    <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="n">safe_eval</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">SAFE_EVAL_BASE</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;self&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="p">},</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;exec&quot;</span><span class="p">)</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span> <span class="k">if</span> <span class="n">deps</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="n">api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="o">*</span><span class="n">deps</span><span class="p">)(</span><span class="n">func</span><span class="p">)</span></div>



<div class="viewcode-block" id="mark_modified">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.mark_modified">[docs]</a>
<span class="k">def</span> <span class="nf">mark_modified</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">fnames</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Mark the given fields as modified on records. &quot;&quot;&quot;</span>
    <span class="c1"># protect all modified fields, to avoid them being recomputed</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">records</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">records</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">protecting</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">records</span><span class="p">):</span>
        <span class="n">records</span><span class="o">.</span><span class="n">modified</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span></div>



<div class="viewcode-block" id="model_xmlid">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.model_xmlid">[docs]</a>
<span class="k">def</span> <span class="nf">model_xmlid</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">model_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return the XML id of the given model. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.model_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">model_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">))</span></div>



<div class="viewcode-block" id="field_xmlid">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.field_xmlid">[docs]</a>
<span class="k">def</span> <span class="nf">field_xmlid</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return the XML id of the given field. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.field_</span><span class="si">%s</span><span class="s1">__</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">model_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">),</span> <span class="n">field_name</span><span class="p">)</span></div>



<div class="viewcode-block" id="selection_xmlid">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.selection_xmlid">[docs]</a>
<span class="k">def</span> <span class="nf">selection_xmlid</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return the XML id of the given selection. &quot;&quot;&quot;</span>
    <span class="n">xmodel</span> <span class="o">=</span> <span class="n">model_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="n">xvalue</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.selection__</span><span class="si">%s</span><span class="s1">__</span><span class="si">%s</span><span class="s1">__</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">xmodel</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">xvalue</span><span class="p">)</span></div>



<span class="c1"># generic INSERT and UPDATE queries</span>
<span class="n">INSERT_QUERY</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;INSERT INTO </span><span class="si">{table}</span><span class="s2"> (</span><span class="si">{cols}</span><span class="s2">) VALUES </span><span class="si">%s</span><span class="s2"> RETURNING id&quot;</span><span class="p">)</span>
<span class="n">UPDATE_QUERY</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;UPDATE </span><span class="si">{table}</span><span class="s2"> SET </span><span class="si">{assignment}</span><span class="s2"> WHERE </span><span class="si">{condition}</span><span class="s2"> RETURNING id&quot;</span><span class="p">)</span>

<span class="n">quote</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span>


<div class="viewcode-block" id="query_insert">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.query_insert">[docs]</a>
<span class="k">def</span> <span class="nf">query_insert</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Insert rows in a table. ``rows`` is a list of dicts, all with the same</span>
<span class="sd">        set of keys. Return the ids of the new rows.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">rows</span><span class="p">]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">INSERT_QUERY</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">table</span><span class="o">=</span><span class="n">Identifier</span><span class="p">(</span><span class="n">table</span><span class="p">),</span>
        <span class="n">cols</span><span class="o">=</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">Identifier</span><span class="p">,</span> <span class="n">cols</span><span class="p">)),</span>
    <span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
    <span class="n">cr</span><span class="o">.</span><span class="n">execute_values</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span></div>



<div class="viewcode-block" id="query_update">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.query_update">[docs]</a>
<span class="k">def</span> <span class="nf">query_update</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">selectors</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Update the table with the given values (dict), and use the columns in</span>
<span class="sd">        ``selectors`` to select the rows to update.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">setters</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">selectors</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">UPDATE_QUERY</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">table</span><span class="o">=</span><span class="n">Identifier</span><span class="p">(</span><span class="n">table</span><span class="p">),</span>
        <span class="n">assignment</span><span class="o">=</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Identifier</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">Placeholder</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">setters</span>
        <span class="p">),</span>
        <span class="n">condition</span><span class="o">=</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot; AND &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Identifier</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">Placeholder</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">selectors</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span></div>



<div class="viewcode-block" id="select_en">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.select_en">[docs]</a>
<span class="k">def</span> <span class="nf">select_en</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fnames</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Select the given columns from the given model&#39;s table, with the given WHERE clause.</span>
<span class="sd">    Translated fields are returned in &#39;en_US&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">quote</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">-&gt;&gt;&#39;en_US&#39;&quot;</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span><span class="o">.</span><span class="n">translate</span> <span class="k">else</span> <span class="n">quote</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span>
    <span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT </span><span class="si">{</span><span class="n">cols</span><span class="si">}</span><span class="s2"> FROM </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2"> WHERE </span><span class="si">{</span><span class="n">where</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">model</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span></div>



<div class="viewcode-block" id="upsert_en">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.upsert_en">[docs]</a>
<span class="k">def</span> <span class="nf">upsert_en</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fnames</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">conflict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Insert or update the table with the given rows.</span>

<span class="sd">    :param model: recordset of the model to query</span>
<span class="sd">    :param fnames: list of column names</span>
<span class="sd">    :param rows: list of tuples, where each tuple value corresponds to a column name</span>
<span class="sd">    :param conflict: list of column names to put into the ON CONFLICT clause</span>
<span class="sd">    :return: the ids of the inserted or updated rows</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">quote</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">)</span>
    <span class="n">conf</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conflict</span><span class="p">)</span>
    <span class="n">excluded</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;EXCLUDED.</span><span class="si">{</span><span class="n">quote</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        INSERT INTO </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">cols</span><span class="si">}</span><span class="s2">) VALUES </span><span class="si">{</span><span class="n">values</span><span class="si">}</span>
<span class="s2">        ON CONFLICT (</span><span class="si">{</span><span class="n">conf</span><span class="si">}</span><span class="s2">) DO UPDATE SET (</span><span class="si">{</span><span class="n">cols</span><span class="si">}</span><span class="s2">) = (</span><span class="si">{</span><span class="n">excluded</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">        RETURNING id</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># for translated fields, we can actually erase the json value, as</span>
    <span class="c1"># translations will be reloaded after this</span>
    <span class="k">def</span> <span class="nf">identity</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">jsonify</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Json</span><span class="p">({</span><span class="s1">&#39;en_US&#39;</span><span class="p">:</span> <span class="n">val</span><span class="p">})</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">val</span>

    <span class="n">wrappers</span> <span class="o">=</span> <span class="p">[(</span><span class="n">jsonify</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span><span class="o">.</span><span class="n">translate</span> <span class="k">else</span> <span class="n">identity</span><span class="p">)</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">]</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">tuple</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">wrappers</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span>
    <span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span></div>



<span class="c1">#</span>
<span class="c1"># IMPORTANT: this must be the first model declared in the module</span>
<span class="c1">#</span>
<div class="viewcode-block" id="Base">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.Base">[docs]</a>
<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">AbstractModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; The base model, which is implicitly inherited by all models. &quot;&quot;&quot;</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;base&#39;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s1">&#39;Base&#39;</span></div>



<div class="viewcode-block" id="Unknown">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.Unknown">[docs]</a>
<span class="k">class</span> <span class="nc">Unknown</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">AbstractModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract model used as a substitute for relational fields with an unknown</span>
<span class="sd">    comodel.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;_unknown&#39;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s1">&#39;Unknown&#39;</span></div>



<div class="viewcode-block" id="IrModel">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModel">[docs]</a>
<span class="k">class</span> <span class="nc">IrModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;ir.model&#39;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s2">&quot;Models&quot;</span>
    <span class="n">_order</span> <span class="o">=</span> <span class="s1">&#39;model&#39;</span>
    <span class="n">_rec_names_search</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">]</span>
    <span class="n">_allow_sudo_commands</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_default_field_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;install_mode&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>                   <span class="c1"># no default field when importing</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;x_name&#39;</span><span class="p">,</span> <span class="s1">&#39;field_description&#39;</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;ttype&#39;</span><span class="p">:</span> <span class="s1">&#39;char&#39;</span><span class="p">,</span> <span class="s1">&#39;copied&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})]</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Model Description&#39;</span><span class="p">,</span> <span class="n">translate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;x_&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Order&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;SQL expression for ordering records in the model; e.g. &quot;x_sequence asc, id desc&quot;&#39;</span><span class="p">)</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Information&#39;</span><span class="p">)</span>
    <span class="n">field_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">One2many</span><span class="p">(</span><span class="s1">&#39;ir.model.fields&#39;</span><span class="p">,</span> <span class="s1">&#39;model_id&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Fields&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">default</span><span class="o">=</span><span class="n">_default_field_id</span><span class="p">)</span>
    <span class="n">inherited_model_ids</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2many</span><span class="p">(</span><span class="s1">&#39;ir.model&#39;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_inherited_models&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s2">&quot;Inherited models&quot;</span><span class="p">,</span>
                                           <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The list of models that extends the current model.&quot;</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Selection</span><span class="p">([(</span><span class="s1">&#39;manual&#39;</span><span class="p">,</span> <span class="s1">&#39;Custom Object&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="s1">&#39;Base Object&#39;</span><span class="p">)],</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Type&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;manual&#39;</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">access_ids</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">One2many</span><span class="p">(</span><span class="s1">&#39;ir.model.access&#39;</span><span class="p">,</span> <span class="s1">&#39;model_id&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Access&#39;</span><span class="p">)</span>
    <span class="n">rule_ids</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">One2many</span><span class="p">(</span><span class="s1">&#39;ir.rule&#39;</span><span class="p">,</span> <span class="s1">&#39;model_id&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Record Rules&#39;</span><span class="p">)</span>
    <span class="n">transient</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s2">&quot;Transient Model&quot;</span><span class="p">)</span>
    <span class="n">modules</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_in_modules&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;In Apps&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;List of modules in which the object is defined or inherited&#39;</span><span class="p">)</span>
    <span class="n">view_ids</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">One2many</span><span class="p">(</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_view_ids&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Views&#39;</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Integer</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_count&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s2">&quot;Count (Incl. Archived)&quot;</span><span class="p">,</span>
                           <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Total number of records in this model&quot;</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_inherited_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inherited_model_ids</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">parent_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">_inherits</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parent_names</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">inherited_model_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">parent_names</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">inherited_model_ids</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_in_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">installed_modules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.module.module&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;installed&#39;</span><span class="p">)])</span>
        <span class="n">installed_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">installed_modules</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
        <span class="n">xml_ids</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">_get_external_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">module_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">xml_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">xml_id</span> <span class="ow">in</span> <span class="n">xml_ids</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
            <span class="n">model</span><span class="o">.</span><span class="n">modules</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">installed_names</span> <span class="o">&amp;</span> <span class="n">module_names</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_view_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">view_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">)])</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_compute_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">records</span><span class="o">.</span><span class="n">_abstract</span> <span class="ow">and</span> <span class="n">records</span><span class="o">.</span><span class="n">_auto</span><span class="p">:</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;SELECT COUNT(*) FROM </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">_table</span><span class="p">)))</span>
                <span class="n">model</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_model_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_manual_name</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">models</span><span class="o">.</span><span class="n">check_object_name</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;The model name can only contain lowercase characters, digits, underscores and dots.&quot;</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="s1">&#39;field_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">_check_qorder</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>  <span class="c1"># regex check for the whole clause (&#39;is it valid sql?&#39;)</span>
            <span class="k">except</span> <span class="n">UserError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="c1"># add MAGIC_COLUMNS to &#39;stored_fields&#39; in case &#39;model&#39; has not been</span>
            <span class="c1"># initialized yet, or &#39;field_id&#39; is not up-to-date in cache</span>
            <span class="n">stored_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="n">model</span><span class="o">.</span><span class="n">field_id</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">models</span><span class="o">.</span><span class="n">MAGIC_COLUMNS</span>
            <span class="p">)</span>
            <span class="n">order_fields</span> <span class="o">=</span> <span class="n">RE_ORDER_FIELDS</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">order_fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stored_fields</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Unable to order by </span><span class="si">%s</span><span class="s2">: fields used for ordering must be present on the model and stored.&quot;</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span>

    <span class="n">_sql_constraints</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;obj_name_uniq&#39;</span><span class="p">,</span> <span class="s1">&#39;unique (model)&#39;</span><span class="p">,</span> <span class="s1">&#39;Each model must have a unique name.&#39;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the (sudoed) `ir.model` record with the given name.</span>
<span class="sd">        The result may be an empty recordset if the model is not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_id</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">name</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>

    <span class="nd">@tools</span><span class="o">.</span><span class="n">ormcache</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id FROM ir_model WHERE model=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_drop_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">current_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">current_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">current_model</span><span class="o">.</span><span class="n">_abstract</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">table</span> <span class="o">=</span> <span class="n">current_model</span><span class="o">.</span><span class="n">_table</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">table_kind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">tools</span><span class="o">.</span><span class="n">TableKind</span><span class="o">.</span><span class="n">View</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;DROP VIEW </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">table</span><span class="p">)))</span>
                <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">tools</span><span class="o">.</span><span class="n">TableKind</span><span class="o">.</span><span class="n">Regular</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;DROP TABLE </span><span class="si">{}</span><span class="s1"> CASCADE&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">table</span><span class="p">)))</span>
                <span class="k">elif</span> <span class="n">kind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Unable to drop table </span><span class="si">%r</span><span class="s2"> of model </span><span class="si">%r</span><span class="s2">: unmanaged or unknown tabe type </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">table</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">kind</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">runbot</span><span class="p">(</span><span class="s1">&#39;The model </span><span class="si">%s</span><span class="s1"> could not be dropped because it did not exist in the registry.&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">ondelete</span><span class="p">(</span><span class="n">at_uninstall</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_unlink_if_manual</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Prevent manual deletion of module tables</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="s1">&#39;manual&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Model </span><span class="si">%r</span><span class="s2"> contains module data and cannot be removed.&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

<div class="viewcode-block" id="IrModel.unlink">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModel.unlink">[docs]</a>
    <span class="k">def</span> <span class="nf">unlink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># prevent screwing up fields that depend on these models&#39; fields</span>
        <span class="n">manual_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">model</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span><span class="p">)</span>
        <span class="n">manual_models</span><span class="o">.</span><span class="n">field_id</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_prepare_update</span><span class="p">()</span>
        <span class="p">(</span><span class="bp">self</span> <span class="o">-</span> <span class="n">manual_models</span><span class="p">)</span><span class="o">.</span><span class="n">field_id</span><span class="o">.</span><span class="n">_prepare_update</span><span class="p">()</span>

        <span class="c1"># delete fields whose comodel is being removed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;relation&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">))])</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="c1"># delete ir_crons created by user</span>
        <span class="n">crons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.cron&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;model_id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">crons</span><span class="p">:</span>
            <span class="n">crons</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_drop_table</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">IrModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="c1"># Reload registry for normal unlink only. For module uninstall, the</span>
        <span class="c1"># reload is done independently in odoo.modules.loading.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">MODULE_UNINSTALL_FLAG</span><span class="p">):</span>
            <span class="c1"># setup models; this automatically removes model from registry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="IrModel.write">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModel.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;model&#39;</span> <span class="ow">in</span> <span class="n">vals</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">model</span> <span class="o">!=</span> <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Field &quot;Model&quot; cannot be modified on models.&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;state&#39;</span> <span class="ow">in</span> <span class="n">vals</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Field &quot;Type&quot; cannot be modified on models.&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;transient&#39;</span> <span class="ow">in</span> <span class="n">vals</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">transient</span> <span class="o">!=</span> <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;transient&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Field &quot;Transient Model&quot; cannot be modified on models.&#39;</span><span class="p">))</span>
        <span class="c1"># Filter out operations 4 from field id, because the web client always</span>
        <span class="c1"># writes (4,id,False) even for non dirty items.</span>
        <span class="k">if</span> <span class="s1">&#39;field_id&#39;</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
            <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;field_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">op</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;field_id&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">IrModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
        <span class="c1"># ordering has been changed, reload registry to reflect update + signaling</span>
        <span class="k">if</span> <span class="s1">&#39;order&#39;</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>  <span class="c1"># setup_models need to fetch the updated values from the db</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="IrModel.create">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModel.create">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model_create_multi</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">IrModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">vals_list</span><span class="p">)</span>
        <span class="n">manual_models</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">vals_list</span> <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="s1">&#39;manual&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">manual_models</span><span class="p">:</span>
            <span class="c1"># setup models; this automatically adds model in registry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">)</span>
            <span class="c1"># update database schema</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">init_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span> <span class="n">manual_models</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">,</span> <span class="n">update_custom_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="IrModel.name_create">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModel.name_create">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">name_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Infer the model from the name. E.g.: &#39;My New Model&#39; should become &#39;x_my_new_model&#39;. &quot;&quot;&quot;</span>
        <span class="n">ir_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="s1">&#39;x_&#39;</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)),</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="n">ir_model</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">ir_model</span><span class="o">.</span><span class="n">display_name</span></div>


    <span class="k">def</span> <span class="nf">_reflect_model_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the values to write to the database for the given model. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">_description</span><span class="p">,</span>
            <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">_order</span><span class="p">,</span>
            <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="nb">next</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__doc__</span> <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">mro</span><span class="p">()</span> <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">),</span>
            <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="s1">&#39;manual&#39;</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_custom</span> <span class="k">else</span> <span class="s1">&#39;base&#39;</span><span class="p">,</span>
            <span class="s1">&#39;transient&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">_transient</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_reflect_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Reflect the given models. &quot;&quot;&quot;</span>
        <span class="c1"># determine expected and existing rows</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reflect_model_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model_name</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">model_names</span>
        <span class="p">]</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unique</span><span class="p">([</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>

        <span class="n">model_ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">select_en</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols</span><span class="p">,</span> <span class="s2">&quot;model IN </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">model_names</span><span class="p">)]):</span>
            <span class="n">model_ids</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">existing</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># create or update rows</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">expected</span> <span class="k">if</span> <span class="n">existing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">row</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">upsert_en</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">id_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">ids</span><span class="p">):</span>
                <span class="n">model_ids</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">id_</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">post_init</span><span class="p">(</span><span class="n">mark_modified</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="n">cols</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="c1"># update their XML id</span>
        <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;module&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">module</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">model_ids</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_module</span> <span class="o">==</span> <span class="n">module</span><span class="p">:</span>
                <span class="c1"># model._module is the name of the module that last extended model</span>
                <span class="n">xml_id</span> <span class="o">=</span> <span class="n">model_xmlid</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>
                <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
                <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;xml_id&#39;</span><span class="p">:</span> <span class="n">xml_id</span><span class="p">,</span> <span class="s1">&#39;record&#39;</span><span class="p">:</span> <span class="n">record</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_update_xmlids</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_instanciate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return a class for the custom model given by parameters ``model_data``. &quot;&quot;&quot;</span>
        <span class="k">class</span> <span class="nc">CustomModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="n">_name</span> <span class="o">=</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">to_text</span><span class="p">(</span><span class="n">model_data</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">])</span>
            <span class="n">_description</span> <span class="o">=</span> <span class="n">model_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">_module</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">_custom</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">_transient</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">model_data</span><span class="p">[</span><span class="s1">&#39;transient&#39;</span><span class="p">])</span>
            <span class="n">_order</span> <span class="o">=</span> <span class="n">model_data</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span>
            <span class="vm">__doc__</span> <span class="o">=</span> <span class="n">model_data</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">CustomModel</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_is_manual_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;x_&#39;</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_check_manual_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_manual_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;The model name must start with &#39;x_&#39;.&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_add_manual_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Add extra models to the registry. &quot;&quot;&quot;</span>
        <span class="c1"># clean up registry first</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">Model</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">Model</span><span class="o">.</span><span class="n">_custom</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="c1"># remove the model&#39;s name from its parents&#39; _inherit_children</span>
                <span class="k">for</span> <span class="n">Parent</span> <span class="ow">in</span> <span class="n">Model</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Parent</span><span class="p">,</span> <span class="s1">&#39;pool&#39;</span><span class="p">):</span>
                        <span class="n">Parent</span><span class="o">.</span><span class="n">_inherit_children</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># add manual models</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span>
        <span class="c1"># we cannot use self._fields to determine translated fields, as it has not been set up yet</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT *, name-&gt;&gt;&#39;en_US&#39; AS name FROM ir_model WHERE state = &#39;manual&#39;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">model_data</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">():</span>
            <span class="n">model_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instanciate</span><span class="p">(</span><span class="n">model_data</span><span class="p">)</span>
            <span class="n">Model</span> <span class="o">=</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_build_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">,</span> <span class="n">cr</span><span class="p">)</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">table_kind</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">Model</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">tools</span><span class="o">.</span><span class="n">TableKind</span><span class="o">.</span><span class="n">Regular</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Model </span><span class="si">%r</span><span class="s2"> is backed by table </span><span class="si">%r</span><span class="s2"> which is not a regular table (</span><span class="si">%r</span><span class="s2">), disabling automatic schema management&quot;</span><span class="p">,</span>
                    <span class="n">Model</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">Model</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">Model</span><span class="o">.</span><span class="n">_auto</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                    SELECT a.attname</span>
<span class="sd">                      FROM pg_attribute a</span>
<span class="sd">                      JOIN pg_class t</span>
<span class="sd">                        ON a.attrelid = t.oid</span>
<span class="sd">                       AND t.relname = %s</span>
<span class="sd">                     WHERE a.attnum &gt; 0 -- skip system columns</span>
<span class="sd">                    &#39;&#39;&#39;</span><span class="p">,</span>
                    <span class="p">[</span><span class="n">Model</span><span class="o">.</span><span class="n">_table</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="n">colinfo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">colinfo</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()}</span>
                <span class="n">Model</span><span class="o">.</span><span class="n">_log_access</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">LOG_ACCESS_COLUMNS</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">columns</span></div>



<span class="c1"># retrieve field types defined by the framework only (not extensions)</span>
<span class="n">FIELD_TYPES</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fields</span><span class="o">.</span><span class="n">Field</span><span class="o">.</span><span class="n">by_type</span><span class="p">)]</span>


<div class="viewcode-block" id="IrModelFields">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelFields">[docs]</a>
<span class="k">class</span> <span class="nc">IrModelFields</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;ir.model.fields&#39;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s2">&quot;Fields&quot;</span>
    <span class="n">_order</span> <span class="o">=</span> <span class="s2">&quot;name&quot;</span>
    <span class="n">_rec_name</span> <span class="o">=</span> <span class="s1">&#39;field_description&#39;</span>
    <span class="n">_allow_sudo_commands</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Field Name&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;x_&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">complete_name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Model Name&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The technical name of the model this field belongs to&quot;</span><span class="p">)</span>
    <span class="n">relation</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Related Model&#39;</span><span class="p">,</span>
                           <span class="n">help</span><span class="o">=</span><span class="s2">&quot;For relationship fields, the technical name of the target model&quot;</span><span class="p">)</span>
    <span class="n">relation_field</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;For one2many fields, the field on the target model that implement the opposite many2one relationship&quot;</span><span class="p">)</span>
    <span class="n">relation_field_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;ir.model.fields&#39;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_relation_field_id&#39;</span><span class="p">,</span>
                                        <span class="n">store</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;cascade&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Relation field&#39;</span><span class="p">)</span>
    <span class="n">model_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;ir.model&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Model&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;cascade&#39;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The model this field belongs to&quot;</span><span class="p">)</span>
    <span class="n">field_description</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Field Label&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">translate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">help</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Field Help&#39;</span><span class="p">,</span> <span class="n">translate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ttype</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Selection</span><span class="p">(</span><span class="n">selection</span><span class="o">=</span><span class="n">FIELD_TYPES</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Field Type&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">selection</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s2">&quot;Selection Options (Deprecated)&quot;</span><span class="p">,</span>
                            <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_selection&#39;</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="s1">&#39;_inverse_selection&#39;</span><span class="p">)</span>
    <span class="n">selection_ids</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">One2many</span><span class="p">(</span><span class="s2">&quot;ir.model.fields.selection&quot;</span><span class="p">,</span> <span class="s2">&quot;field_id&quot;</span><span class="p">,</span>
                                    <span class="n">string</span><span class="o">=</span><span class="s2">&quot;Selection Options&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">copied</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Copied&#39;</span><span class="p">,</span>
                            <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_copied&#39;</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether the value is copied when duplicating a record.&quot;</span><span class="p">)</span>
    <span class="n">related</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Related Field&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The corresponding related field, if any. This must be a dot-separated list of field names.&quot;</span><span class="p">)</span>
    <span class="n">related_field_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;ir.model.fields&#39;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_related_field_id&#39;</span><span class="p">,</span>
                                       <span class="n">store</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s2">&quot;Related field&quot;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;cascade&#39;</span><span class="p">)</span>
    <span class="n">required</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">()</span>
    <span class="n">readonly</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">()</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Indexed&#39;</span><span class="p">)</span>
    <span class="n">translate</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Translatable&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether values for this field can be translated (enables the translation mechanism for that field)&quot;</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Integer</span><span class="p">()</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Selection</span><span class="p">([(</span><span class="s1">&#39;manual&#39;</span><span class="p">,</span> <span class="s1">&#39;Custom Field&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="s1">&#39;Base Field&#39;</span><span class="p">)],</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Type&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;manual&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">on_delete</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Selection</span><span class="p">([(</span><span class="s1">&#39;cascade&#39;</span><span class="p">,</span> <span class="s1">&#39;Cascade&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;set null&#39;</span><span class="p">,</span> <span class="s1">&#39;Set NULL&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;restrict&#39;</span><span class="p">,</span> <span class="s1">&#39;Restrict&#39;</span><span class="p">)],</span>
                                 <span class="n">string</span><span class="o">=</span><span class="s1">&#39;On Delete&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;set null&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;On delete property for many2one fields&#39;</span><span class="p">)</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;[]&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The optional domain to restrict possible values for relationship fields, &quot;</span>
                                            <span class="s2">&quot;specified as a Python expression defining a list of triplets. &quot;</span>
                                            <span class="s2">&quot;For example: [(&#39;color&#39;,&#39;=&#39;,&#39;red&#39;)]&quot;</span><span class="p">)</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2many</span><span class="p">(</span><span class="s1">&#39;res.groups&#39;</span><span class="p">,</span> <span class="s1">&#39;ir_model_fields_group_rel&#39;</span><span class="p">,</span> <span class="s1">&#39;field_id&#39;</span><span class="p">,</span> <span class="s1">&#39;group_id&#39;</span><span class="p">)</span> <span class="c1"># CLEANME unimplemented field (empty table)</span>
    <span class="n">group_expand</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s2">&quot;Expand Groups&quot;</span><span class="p">,</span>
                                  <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If checked, all the records of the target model will be included</span><span class="se">\n</span><span class="s2">&quot;</span>
                                        <span class="s2">&quot;in a grouped result (e.g. &#39;Group By&#39; filters, Kanban columns, etc.).</span><span class="se">\n</span><span class="s2">&quot;</span>
                                        <span class="s2">&quot;Note that it can significantly reduce performance if the target model</span><span class="se">\n</span><span class="s2">&quot;</span>
                                        <span class="s2">&quot;of the field contains a lot of records; usually used on models with</span><span class="se">\n</span><span class="s2">&quot;</span>
                                        <span class="s2">&quot;few records (e.g. Stages, Job Positions, Event Types, etc.).&quot;</span><span class="p">)</span>
    <span class="n">selectable</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">modules</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_in_modules&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;In Apps&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;List of modules in which the field is defined&#39;</span><span class="p">)</span>
    <span class="n">relation_table</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;Used for custom many2many fields to define a custom relation table name&quot;</span><span class="p">)</span>
    <span class="n">column1</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Column 1&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Column referring to the record in the model table&quot;</span><span class="p">)</span>
    <span class="n">column2</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s2">&quot;Column 2&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Column referring to the record in the comodel table&quot;</span><span class="p">)</span>
    <span class="n">compute</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;Code to compute the value of the field.</span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="s2">&quot;Iterate on the recordset &#39;self&#39; and assign the field&#39;s value:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                               <span class="s2">&quot;    for record in self:</span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="s2">&quot;        record[&#39;size&#39;] = len(record.name)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                               <span class="s2">&quot;Modules time, datetime, dateutil are available.&quot;</span><span class="p">)</span>
    <span class="n">depends</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Dependencies&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Dependencies of compute method; &quot;</span>
                                                      <span class="s2">&quot;a list of comma-separated field names, like</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                                                      <span class="s2">&quot;    name, partner_id.name&quot;</span><span class="p">)</span>
    <span class="n">store</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Stored&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether the value is stored in the database.&quot;</span><span class="p">)</span>
    <span class="n">currency_field</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s2">&quot;Currency field&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name of the Many2one field holding the res.currency&quot;</span><span class="p">)</span>
    <span class="c1"># HTML sanitization reflection, useless for other kinds of fields</span>
    <span class="n">sanitize</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Sanitize HTML&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sanitize_overridable</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Sanitize HTML overridable&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sanitize_tags</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Sanitize HTML Tags&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sanitize_attributes</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Sanitize HTML Attributes&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sanitize_style</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Sanitize HTML Style&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sanitize_form</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Sanitize HTML Form&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">strip_style</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Strip Style Attribute&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">strip_classes</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Strip Class Attribute&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;relation&#39;</span><span class="p">,</span> <span class="s1">&#39;relation_field&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_relation_field_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span> <span class="ow">and</span> <span class="n">rec</span><span class="o">.</span><span class="n">relation_field</span><span class="p">:</span>
                <span class="n">rec</span><span class="o">.</span><span class="n">relation_field_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">relation</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">relation_field</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rec</span><span class="o">.</span><span class="n">relation_field_id</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;related&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_related_field_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span> <span class="ow">and</span> <span class="n">rec</span><span class="o">.</span><span class="n">related</span><span class="p">:</span>
                <span class="n">rec</span><span class="o">.</span><span class="n">related_field_id</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">_related_field</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rec</span><span class="o">.</span><span class="n">related_field_id</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;selection_ids&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;selection&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">):</span>
                <span class="n">rec</span><span class="o">.</span><span class="n">selection</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.fields.selection&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_selection</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rec</span><span class="o">.</span><span class="n">selection</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_inverse_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">selection</span> <span class="ow">or</span> <span class="s2">&quot;[]&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.fields.selection&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_update_selection</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;ttype&#39;</span><span class="p">,</span> <span class="s1">&#39;related&#39;</span><span class="p">,</span> <span class="s1">&#39;compute&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_copied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">rec</span><span class="o">.</span><span class="n">copied</span> <span class="o">=</span> <span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">ttype</span> <span class="o">!=</span> <span class="s1">&#39;one2many&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">related</span> <span class="ow">or</span> <span class="n">rec</span><span class="o">.</span><span class="n">compute</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_in_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">installed_modules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.module.module&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;installed&#39;</span><span class="p">)])</span>
        <span class="n">installed_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">installed_modules</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
        <span class="n">xml_ids</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">_get_external_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">module_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">xml_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">xml_id</span> <span class="ow">in</span> <span class="n">xml_ids</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
            <span class="n">field</span><span class="o">.</span><span class="n">modules</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">installed_names</span> <span class="o">&amp;</span> <span class="n">module_names</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="s1">&#39;domain&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">safe_eval</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">domain</span> <span class="ow">or</span> <span class="s1">&#39;[]&#39;</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">models</span><span class="o">.</span><span class="n">check_pg_name</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ValidationError</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Field names can only contain characters, digits and underscores (up to 63).&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">_sql_constraints</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;name_unique&#39;</span><span class="p">,</span> <span class="s1">&#39;UNIQUE(model, name)&#39;</span><span class="p">,</span> <span class="s2">&quot;Field names must be unique per model.&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;size_gt_zero&#39;</span><span class="p">,</span> <span class="s1">&#39;CHECK (size&gt;=0)&#39;</span><span class="p">,</span> <span class="s1">&#39;Size of the field cannot be negative.&#39;</span><span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;name_manual_field&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CHECK (state != &#39;manual&#39; OR name LIKE &#39;x</span><span class="se">\\</span><span class="s2">_%&#39;)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Custom fields must have a name that starts with &#39;x_&#39;!&quot;</span>
        <span class="p">),</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_related_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the ``ir.model.fields`` record corresponding to ``self.related``. &quot;&quot;&quot;</span>
        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">last</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span><span class="o">.</span><span class="n">model</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Unknown field name </span><span class="si">%r</span><span class="s2"> in related field </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="p">))</span>
            <span class="n">model_name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">relation</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">last</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">relation</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Non-relational field name </span><span class="si">%r</span><span class="s2"> in related field </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">field</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="s1">&#39;related&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_related</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span> <span class="ow">and</span> <span class="n">rec</span><span class="o">.</span><span class="n">related</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">_related_field</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">ttype</span> <span class="o">!=</span> <span class="n">rec</span><span class="o">.</span><span class="n">ttype</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Related field </span><span class="si">%r</span><span class="s2"> does not have type </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">related</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">ttype</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">relation</span> <span class="o">!=</span> <span class="n">rec</span><span class="o">.</span><span class="n">relation</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Related field </span><span class="si">%r</span><span class="s2"> does not have comodel </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">related</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">relation</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">onchange</span><span class="p">(</span><span class="s1">&#39;related&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_onchange_related</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_related_field</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">UserError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;warning&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Warning&quot;</span><span class="p">),</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">e</span><span class="p">}}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ttype</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">ttype</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">relation</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">relation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">onchange</span><span class="p">(</span><span class="s1">&#39;relation&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_onchange_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_relation</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;warning&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Model </span><span class="si">%s</span><span class="s2"> does not exist&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation</span><span class="p">),</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">e</span><span class="p">}}</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="s1">&#39;relation&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span> <span class="ow">and</span> <span class="n">rec</span><span class="o">.</span><span class="n">relation</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rec</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_id</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">relation</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Unknown model name &#39;</span><span class="si">%s</span><span class="s2">&#39; in Related Model&quot;</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">relation</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="s1">&#39;depends&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_depends</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Check whether all fields in dependencies are valid. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">record</span><span class="o">.</span><span class="n">depends</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">depends</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">seq</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Empty dependency in </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">depends</span><span class="p">))</span>
                <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">model</span><span class="p">]</span>
                <span class="n">names</span> <span class="o">=</span> <span class="n">seq</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                <span class="n">last</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Compute method cannot depend on field &#39;id&#39;&quot;</span><span class="p">))</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Unknown field </span><span class="si">%r</span><span class="s2"> in dependency </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">seq</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
                    <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">last</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">relational</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Non-relational field </span><span class="si">%r</span><span class="s2"> in dependency </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">seq</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">onchange</span><span class="p">(</span><span class="s1">&#39;compute&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_onchange_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="s1">&#39;relation_table&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_relation_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">relation_table</span><span class="p">:</span>
                <span class="n">models</span><span class="o">.</span><span class="n">check_pg_name</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">relation_table</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="s1">&#39;currency_field&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_currency_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span> <span class="ow">and</span> <span class="n">rec</span><span class="o">.</span><span class="n">ttype</span> <span class="o">==</span> <span class="s1">&#39;monetary&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">rec</span><span class="o">.</span><span class="n">currency_field</span><span class="p">:</span>
                    <span class="n">currency_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;currency_id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;x_currency_id&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">currency_field</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Currency field is empty and there is no fallback field in the model&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">currency_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">currency_field</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">currency_field</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Unknown field name </span><span class="si">%r</span><span class="s2"> in currency_field&quot;</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">currency_field</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">currency_field</span><span class="o">.</span><span class="n">ttype</span> <span class="o">!=</span> <span class="s1">&#39;many2one&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Currency field does not have type many2one&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">currency_field</span><span class="o">.</span><span class="n">relation</span> <span class="o">!=</span> <span class="s1">&#39;res.currency&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Currency field should have a res.currency relation&quot;</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_custom_many2many_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">comodel_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return default names for the table and columns of a custom many2many field. &quot;&quot;&quot;</span>
        <span class="n">rel1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">_table</span>
        <span class="n">rel2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">comodel_name</span><span class="p">]</span><span class="o">.</span><span class="n">_table</span>
        <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;x_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_rel&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">rel1</span><span class="p">,</span> <span class="n">rel2</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">rel1</span> <span class="o">==</span> <span class="n">rel2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s1">&#39;id1&#39;</span><span class="p">,</span> <span class="s1">&#39;id2&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_id&#39;</span> <span class="o">%</span> <span class="n">rel1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_id&#39;</span> <span class="o">%</span> <span class="n">rel2</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">onchange</span><span class="p">(</span><span class="s1">&#39;ttype&#39;</span><span class="p">,</span> <span class="s1">&#39;model_id&#39;</span><span class="p">,</span> <span class="s1">&#39;relation&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_onchange_ttype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttype</span> <span class="o">==</span> <span class="s1">&#39;many2many&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_custom_many2many_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_id</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">relation_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column2</span> <span class="o">=</span> <span class="n">names</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">relation_table</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column1</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column2</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">onchange</span><span class="p">(</span><span class="s1">&#39;relation_table&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_onchange_relation_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation_table</span><span class="p">:</span>
            <span class="c1"># check whether other fields use the same table</span>
            <span class="n">others</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;ttype&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;many2many&#39;</span><span class="p">),</span>
                                  <span class="p">(</span><span class="s1">&#39;relation_table&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation_table</span><span class="p">),</span>
                                  <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">others</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">other</span> <span class="ow">in</span> <span class="n">others</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">relation</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">):</span>
                        <span class="c1"># other is a candidate inverse field</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">column1</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">column2</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">column2</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">column1</span>
                        <span class="k">return</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;warning&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Warning&quot;</span><span class="p">),</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;The table </span><span class="si">%r</span><span class="s2"> if used for other, possibly incompatible fields.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relation_table</span><span class="p">),</span>
                <span class="p">}}</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="s1">&#39;required&#39;</span><span class="p">,</span> <span class="s1">&#39;ttype&#39;</span><span class="p">,</span> <span class="s1">&#39;on_delete&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_on_delete_required_m2o</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">ttype</span> <span class="o">==</span> <span class="s1">&#39;many2one&#39;</span> <span class="ow">and</span> <span class="n">rec</span><span class="o">.</span><span class="n">required</span> <span class="ow">and</span> <span class="n">rec</span><span class="o">.</span><span class="n">on_delete</span> <span class="o">==</span> <span class="s1">&#39;set null&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;The m2o field </span><span class="si">%s</span><span class="s2"> is required but declares its ondelete policy &quot;</span>
                    <span class="s2">&quot;as being &#39;set null&#39;. Only &#39;restrict&#39; and &#39;cascade&#39; make sense.&quot;</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the (sudoed) `ir.model.fields` record with the given model and name.</span>
<span class="sd">        The result may be an empty recordset if the model is not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_id</span> <span class="o">=</span> <span class="n">model_name</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ids</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">field_id</span><span class="p">)</span>

    <span class="nd">@tools</span><span class="o">.</span><span class="n">ormcache</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">):</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name, id FROM ir_model_fields WHERE model=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">model_name</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_drop_column</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tables_to_drop</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">MAGIC_COLUMNS</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="n">is_model</span> <span class="o">=</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
                <span class="c1"># TODO: Refactor this brol in master</span>
                <span class="k">if</span> <span class="n">is_model</span> <span class="ow">and</span> <span class="n">tools</span><span class="o">.</span><span class="n">column_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> \
                        <span class="n">tools</span><span class="o">.</span><span class="n">table_kind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span> <span class="o">==</span> <span class="n">tools</span><span class="o">.</span><span class="n">TableKind</span><span class="o">.</span><span class="n">Regular</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ALTER TABLE </span><span class="si">{}</span><span class="s1"> DROP COLUMN </span><span class="si">{}</span><span class="s1"> CASCADE&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">sql</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_table</span><span class="p">),</span> <span class="n">sql</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                    <span class="p">))</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">ttype</span> <span class="o">==</span> <span class="s1">&#39;many2many&#39;</span><span class="p">:</span>
                    <span class="n">rel_name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">relation_table</span> <span class="ow">or</span> <span class="p">(</span><span class="n">is_model</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">relation</span><span class="p">)</span>
                    <span class="n">tables_to_drop</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rel_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span> <span class="ow">and</span> <span class="n">is_model</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">_pop_field</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tables_to_drop</span><span class="p">:</span>
            <span class="c1"># drop the relation tables that are not used by other fields</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT relation_table FROM ir_model_fields</span>
<span class="s2">                                WHERE relation_table IN </span><span class="si">%s</span><span class="s2"> AND id NOT IN </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
                             <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">tables_to_drop</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)))</span>
            <span class="n">tables_to_keep</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">rel_name</span> <span class="ow">in</span> <span class="n">tables_to_drop</span> <span class="o">-</span> <span class="n">tables_to_keep</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;DROP TABLE </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">rel_name</span><span class="p">)))</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_prepare_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Check whether the fields in ``self`` may be modified or removed.</span>
<span class="sd">            This method prevents the modification/deletion of many2one fields</span>
<span class="sd">            that have an inverse one2many, for instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uninstalling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">MODULE_UNINSTALL_FLAG</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">uninstalling</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="s1">&#39;manual&#39;</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;This column contains module data and cannot be removed!&quot;</span><span class="p">))</span>

        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span>              <span class="c1"># all the records to delete</span>
        <span class="n">fields_</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">()</span>      <span class="c1"># all the fields corresponding to &#39;records&#39;</span>
        <span class="n">failed_dependencies</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c1"># list of broken (field, dependent_field)</span>

        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">fields_</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get_dependent_fields</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">dep</span><span class="o">.</span><span class="n">manual</span><span class="p">:</span>
                    <span class="n">failed_dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field</span><span class="p">,</span> <span class="n">dep</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">dep</span><span class="o">.</span><span class="n">inherited</span><span class="p">:</span>
                    <span class="n">fields_</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
                    <span class="n">records</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="n">dep</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields_</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">inverse</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">field_inverses</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">inverse</span><span class="o">.</span><span class="n">manual</span> <span class="ow">and</span> <span class="n">inverse</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;one2many&#39;</span><span class="p">:</span>
                    <span class="n">failed_dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field</span><span class="p">,</span> <span class="n">inverse</span><span class="p">))</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="n">records</span>

        <span class="k">if</span> <span class="n">failed_dependencies</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">uninstalling</span><span class="p">:</span>
                <span class="n">field</span><span class="p">,</span> <span class="n">dep</span> <span class="o">=</span> <span class="n">failed_dependencies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;The field &#39;</span><span class="si">%s</span><span class="s2">&#39; cannot be removed because the field &#39;</span><span class="si">%s</span><span class="s2">&#39; depends on it.&quot;</span><span class="p">,</span>
                    <span class="n">field</span><span class="p">,</span> <span class="n">dep</span><span class="p">,</span>
                <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="n">dep</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">failed_dependencies</span>
                <span class="p">])</span>

        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">record</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">records</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># remove pending write of this field</span>
        <span class="c1"># DLE P16: if there are pending updates of the field we currently try to unlink, pop them out from the cache</span>
        <span class="c1"># test `test_unlink_with_dependant`</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">model</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">clear_dirty_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="c1"># remove fields from registry, and check that views are not broken</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">_pop_field</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">]</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">OR</span><span class="p">([(</span><span class="s1">&#39;arch_db&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">)</span>
        <span class="n">views</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="n">views</span><span class="p">:</span>
                <span class="n">view</span><span class="o">.</span><span class="n">_check_xml</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">uninstalling</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot rename/delete fields that are still present in views:</span><span class="se">\n</span><span class="s2">Fields: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">View: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">),</span>
                    <span class="n">view</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># uninstall mode</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;The following fields were force-deleted to prevent a registry crash </span><span class="si">%s</span><span class="s2"> the following view might be broken </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">),</span>
                    <span class="n">view</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">uninstalling</span><span class="p">:</span>
                <span class="c1"># the registry has been modified, restore it</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="IrModelFields.unlink">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelFields.unlink">[docs]</a>
    <span class="k">def</span> <span class="nf">unlink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># prevent screwing up fields that depend on these fields</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_update</span><span class="p">()</span>

        <span class="c1"># determine registry fields corresponding to self</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># clean the registry from the fields to remove</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">registry_invalidated</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_discard_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>

        <span class="c1"># discard the removed fields from fields to compute</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">tocompute</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">model_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drop_column</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">IrModelFields</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="c1"># The field we just deleted might be inherited, and the registry is</span>
        <span class="c1"># inconsistent in this case; therefore we reload the registry.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">MODULE_UNINSTALL_FLAG</span><span class="p">):</span>
            <span class="c1"># setup models; this re-initializes models in registry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">)</span>
            <span class="c1"># update database schema of model and its descendant models</span>
            <span class="n">models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">descendants</span><span class="p">(</span><span class="n">model_names</span><span class="p">,</span> <span class="s1">&#39;_inherits&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">init_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">,</span> <span class="n">update_custom_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="IrModelFields.create">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelFields.create">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model_create_multi</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
        <span class="n">IrModel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model&#39;</span><span class="p">]</span>
        <span class="n">models</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">vals_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;model_id&#39;</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
                <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">IrModel</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s1">&#39;model_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">model</span>
            <span class="k">assert</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;missing model name for </span><span class="si">{</span><span class="n">vals</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">models</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">])</span>

        <span class="c1"># for self._get_ids() in _update_selection()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>

        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">IrModelFields</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">vals_list</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">vals_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="s1">&#39;manual&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span><span class="p">:</span>
                <span class="n">relation</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;relation&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">relation</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">IrModel</span><span class="o">.</span><span class="n">_get_id</span><span class="p">(</span><span class="n">relation</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Model </span><span class="si">%s</span><span class="s2"> does not exist!&quot;</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;relation&#39;</span><span class="p">]))</span>

                <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ttype&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;one2many&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_count</span><span class="p">([</span>
                    <span class="p">(</span><span class="s1">&#39;ttype&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;many2one&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;relation&#39;</span><span class="p">]),</span>
                    <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;relation_field&#39;</span><span class="p">]),</span>
                <span class="p">]):</span>
                    <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Many2one </span><span class="si">%s</span><span class="s2"> on model </span><span class="si">%s</span><span class="s2"> does not exist!&quot;</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;relation_field&#39;</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;relation&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">):</span>
            <span class="c1"># setup models; this re-initializes model in registry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">)</span>
            <span class="c1"># update database schema of models and their descendants</span>
            <span class="n">models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">descendants</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="s1">&#39;_inherits&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">init_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">,</span> <span class="n">update_custom_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="IrModelFields.write">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelFields.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># if set, *one* column can be renamed here</span>
        <span class="n">column_rename</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># names of the models to patch</span>
        <span class="n">patched_models</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">translate_only</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">translate</span> <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vals</span> <span class="ow">and</span> <span class="bp">self</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">translate_only</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="s1">&#39;manual&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Properties of base fields cannot be altered in this manner! &#39;</span>
                                      <span class="s1">&#39;Please modify them through Python code, &#39;</span>
                                      <span class="s1">&#39;preferably through a custom addon!&#39;</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_id&#39;</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">model_id</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">item</span><span class="o">.</span><span class="n">model_id</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Changing the model of a field is forbidden!&quot;</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ttype&#39;</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">ttype</span><span class="p">)</span> <span class="o">!=</span> <span class="n">item</span><span class="o">.</span><span class="n">ttype</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Changing the type of a field is not yet supported. &quot;</span>
                                      <span class="s2">&quot;Please drop it and create it again!&quot;</span><span class="p">))</span>

                <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
                <span class="n">field</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;_fields&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">!=</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="c1"># We need to rename the field</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">_prepare_update</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">ttype</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;one2many&#39;</span><span class="p">,</span> <span class="s1">&#39;many2many&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">):</span>
                        <span class="c1"># those field names are not explicit in the database!</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">column_rename</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Can only rename one field at a time!&#39;</span><span class="p">))</span>
                        <span class="n">column_rename</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">item</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">store</span><span class="p">)</span>

                <span class="c1"># We don&#39;t check the &#39;state&#39;, because it might come from the context</span>
                <span class="c1"># (thus be set for multiple fields) and will be ignored anyway.</span>
                <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">patched_models</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

        <span class="c1"># These shall never be written (modified)</span>
        <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;model_id&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">vals</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span>

        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">IrModelFields</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">column_rename</span><span class="p">:</span>
            <span class="c1"># rename column in database, and its corresponding index if present</span>
            <span class="n">table</span><span class="p">,</span> <span class="n">oldname</span><span class="p">,</span> <span class="n">newname</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">stored</span> <span class="o">=</span> <span class="n">column_rename</span>
            <span class="k">if</span> <span class="n">stored</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">sql</span><span class="o">.</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ALTER TABLE </span><span class="si">{}</span><span class="s1"> RENAME COLUMN </span><span class="si">{}</span><span class="s1"> TO </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">sql</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">table</span><span class="p">),</span>
                        <span class="n">sql</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">oldname</span><span class="p">),</span>
                        <span class="n">sql</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">newname</span><span class="p">)</span>
                    <span class="p">))</span>
                <span class="k">if</span> <span class="n">index</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="n">sql</span><span class="o">.</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ALTER INDEX </span><span class="si">{}</span><span class="s1"> RENAME TO </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">sql</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">oldname</span><span class="si">}</span><span class="s1">_index&#39;</span><span class="p">),</span>
                            <span class="n">sql</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">newname</span><span class="si">}</span><span class="s1">_index&#39;</span><span class="p">),</span>
                        <span class="p">))</span>

        <span class="k">if</span> <span class="n">column_rename</span> <span class="ow">or</span> <span class="n">patched_models</span> <span class="ow">or</span> <span class="n">translate_only</span><span class="p">:</span>
            <span class="c1"># setup models, this will reload all manual fields in registry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">patched_models</span><span class="p">:</span>
            <span class="c1"># update the database schema of the models to patch</span>
            <span class="n">models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">descendants</span><span class="p">(</span><span class="n">patched_models</span><span class="p">,</span> <span class="s1">&#39;_inherits&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">init_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">,</span> <span class="n">update_custom_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">res</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;field_description&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_display_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">IrModel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;ir.model&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hide_model&#39;</span><span class="p">):</span>
                <span class="n">field</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">field_description</span>
                <span class="k">continue</span>
            <span class="n">model_string</span> <span class="o">=</span> <span class="n">IrModel</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
            <span class="n">field</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">field_description</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">model_string</span><span class="si">}</span><span class="s1">)&#39;</span>

    <span class="k">def</span> <span class="nf">_reflect_field_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">model_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the values to write to the database for the given field. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;model_id&#39;</span><span class="p">:</span> <span class="n">model_id</span><span class="p">,</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;field_description&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
            <span class="s1">&#39;help&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">help</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;ttype&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="s1">&#39;manual&#39;</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">manual</span> <span class="k">else</span> <span class="s1">&#39;base&#39;</span><span class="p">,</span>
            <span class="s1">&#39;relation&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
            <span class="s1">&#39;store&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">),</span>
            <span class="s1">&#39;copied&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">copy</span><span class="p">),</span>
            <span class="s1">&#39;on_delete&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">ondelete</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2one&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;related&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">related</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;readonly&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">readonly</span><span class="p">),</span>
            <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">required</span><span class="p">),</span>
            <span class="s1">&#39;selectable&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">search</span> <span class="ow">or</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">),</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s1">&#39;translate&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">),</span>
            <span class="s1">&#39;relation_field&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">inverse_name</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;one2many&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;relation_table&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">relation</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2many&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;column1&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">column1</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2many&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;column2&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">column2</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2many&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;currency_field&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">currency_field</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;monetary&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="c1"># html sanitization attributes (useless for other fields)</span>
            <span class="s1">&#39;sanitize&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">sanitize</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;sanitize_overridable&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">sanitize_overridable</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;sanitize_tags&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">sanitize_tags</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;sanitize_attributes&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">sanitize_attributes</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;sanitize_style&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">sanitize_style</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;sanitize_form&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">sanitize_form</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;strip_style&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">strip_style</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;strip_classes&#39;</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">strip_classes</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_reflect_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Reflect the fields of the given models. &quot;&quot;&quot;</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span>

        <span class="k">for</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">model_names</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>
            <span class="n">by_label</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">string</span> <span class="ow">in</span> <span class="n">by_label</span><span class="p">:</span>
                    <span class="n">other</span> <span class="o">=</span> <span class="n">by_label</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">string</span><span class="p">]</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Two fields (</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">) of </span><span class="si">%s</span><span class="s1"> have the same label: </span><span class="si">%s</span><span class="s1">. [Modules: </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span>
                                    <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">_module</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_module</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">by_label</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">string</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>

        <span class="c1"># determine expected and existing rows</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">model_names</span><span class="p">:</span>
            <span class="n">model_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_id</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reflect_field_params</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">model_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unique</span><span class="p">([</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>

        <span class="n">field_ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">select_en</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cols</span><span class="p">,</span> <span class="s2">&quot;model IN </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">model_names</span><span class="p">)]):</span>
            <span class="n">field_ids</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">existing</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># create or update rows</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">expected</span> <span class="k">if</span> <span class="n">existing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">!=</span> <span class="n">row</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">upsert_en</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">id_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">ids</span><span class="p">):</span>
                <span class="n">field_ids</span><span class="p">[</span><span class="n">row</span><span class="p">[:</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">id_</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">post_init</span><span class="p">(</span><span class="n">mark_modified</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="n">cols</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>

        <span class="c1"># update their XML id</span>
        <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;module&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">module</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">field_model</span><span class="p">,</span> <span class="n">field_name</span><span class="p">),</span> <span class="n">field_id</span> <span class="ow">in</span> <span class="n">field_ids</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field_model</span><span class="p">]</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">module</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">_original_module</span>
                <span class="ow">or</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">_modules</span>
                <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
                    <span class="c1"># module introduced field on model by inheritance</span>
                    <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span>
                    <span class="k">for</span> <span class="n">parent</span><span class="p">,</span> <span class="n">parent_module</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_inherit_module</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">module</span> <span class="o">==</span> <span class="n">parent_module</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="n">xml_id</span> <span class="o">=</span> <span class="n">field_xmlid</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">field_model</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
                <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">field_id</span><span class="p">)</span>
                <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;xml_id&#39;</span><span class="p">:</span> <span class="n">xml_id</span><span class="p">,</span> <span class="s1">&#39;record&#39;</span><span class="p">:</span> <span class="n">record</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_update_xmlids</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span>

    <span class="nd">@tools</span><span class="o">.</span><span class="n">ormcache</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_all_manual_field_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span>
        <span class="c1"># we cannot use self._fields to determine translated fields, as it has not been set up yet</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT *, field_description-&gt;&gt;&#39;en_US&#39; AS field_description, help-&gt;&gt;&#39;en_US&#39; AS help</span>
<span class="s2">            FROM ir_model_fields</span>
<span class="s2">            WHERE state = &#39;manual&#39;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">():</span>
            <span class="n">result</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]][</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_get_manual_field_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the given model&#39;s manual field data. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_manual_field_data</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">def</span> <span class="nf">_instanciate_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the parameters for a field instance for ``field_data``. &quot;&quot;&quot;</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;manual&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;string&#39;</span><span class="p">:</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;field_description&#39;</span><span class="p">],</span>
            <span class="s1">&#39;help&#39;</span><span class="p">:</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">],</span>
            <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;copy&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;copied&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;related&#39;</span><span class="p">:</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;related&#39;</span><span class="p">],</span>
            <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;required&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;readonly&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;readonly&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;store&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;store&#39;</span><span class="p">]),</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;ttype&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;char&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">):</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;translate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;translate&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;ttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;char&#39;</span><span class="p">:</span>
                <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;ttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span><span class="p">:</span>
                <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;sanitize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;sanitize&#39;</span><span class="p">]</span>
                <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;sanitize_overridable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;sanitize_overridable&#39;</span><span class="p">]</span>
                <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;sanitize_tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;sanitize_tags&#39;</span><span class="p">]</span>
                <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;sanitize_attributes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;sanitize_attributes&#39;</span><span class="p">]</span>
                <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;sanitize_style&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;sanitize_style&#39;</span><span class="p">]</span>
                <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;sanitize_form&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;sanitize_form&#39;</span><span class="p">]</span>
                <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;strip_style&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;strip_style&#39;</span><span class="p">]</span>
                <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;strip_classes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;strip_classes&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;ttype&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;selection&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">):</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.fields.selection&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_selection_data</span><span class="p">(</span><span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;ttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;selection&#39;</span><span class="p">:</span>
                <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;group_expand&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;group_expand&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;ttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;many2one&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">loaded</span> <span class="ow">and</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;relation&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;comodel_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;relation&#39;</span><span class="p">]</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ondelete&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;on_delete&#39;</span><span class="p">]</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">safe_eval</span><span class="p">(</span><span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;[]&#39;</span><span class="p">)</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;group_expand&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;_read_group_expand_full&#39;</span> <span class="k">if</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;group_expand&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;ttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;one2many&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">loaded</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;relation&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;relation_field&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;relation&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">_fields</span> <span class="ow">or</span>
                    <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;relation_field&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_manual_field_data</span><span class="p">(</span><span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;relation&#39;</span><span class="p">])</span>
            <span class="p">)):</span>
                <span class="k">return</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;comodel_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;relation&#39;</span><span class="p">]</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;inverse_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;relation_field&#39;</span><span class="p">]</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">safe_eval</span><span class="p">(</span><span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;[]&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;ttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;many2many&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">loaded</span> <span class="ow">and</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;relation&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;comodel_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;relation&#39;</span><span class="p">]</span>
            <span class="n">rel</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_custom_many2many_names</span><span class="p">(</span><span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;relation&#39;</span><span class="p">])</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;relation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;relation_table&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">rel</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;column1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;column1&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">col1</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;column2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;column2&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">col2</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">safe_eval</span><span class="p">(</span><span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;[]&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;ttype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;monetary&#39;</span><span class="p">:</span>
            <span class="c1"># be sure that custom monetary field are always instanciated</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">loaded</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="p">(</span><span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;currency_field&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_manual_name</span><span class="p">(</span><span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;currency_field&#39;</span><span class="p">])):</span>
                <span class="k">return</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;currency_field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;currency_field&#39;</span><span class="p">]</span>
        <span class="c1"># add compute function if given</span>
        <span class="k">if</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;compute&#39;</span><span class="p">]:</span>
            <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;compute&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_compute</span><span class="p">(</span><span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;compute&#39;</span><span class="p">],</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;depends&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">attrs</span>

    <span class="k">def</span> <span class="nf">_instanciate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return a field instance corresponding to parameters ``field_data``. &quot;&quot;&quot;</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instanciate_attrs</span><span class="p">(</span><span class="n">field_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fields</span><span class="o">.</span><span class="n">Field</span><span class="o">.</span><span class="n">by_type</span><span class="p">[</span><span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;ttype&#39;</span><span class="p">]](</span><span class="o">**</span><span class="n">attrs</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_is_manual_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;x_&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_manual_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Add extra fields on model. &quot;&quot;&quot;</span>
        <span class="n">fields_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_manual_field_data</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field_data</span> <span class="ow">in</span> <span class="n">fields_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_fields</span> <span class="ow">and</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instanciate</span><span class="p">(</span><span class="n">field_data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">_add_field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to load field </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">: skipped&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="IrModelFields.get_field_string">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelFields.get_field_string">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="nd">@tools</span><span class="o">.</span><span class="n">ormcache_context</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">get_field_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the translation of fields strings in the context&#39;s language.</span>
<span class="sd">        Note that the result contains the available translations only.</span>

<span class="sd">        :param model_name: the name of a model</span>
<span class="sd">        :return: the model&#39;s fields&#39; strings as a dictionary `{field_name: field_string}`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)])</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">field_description</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">}</span></div>


<div class="viewcode-block" id="IrModelFields.get_field_help">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelFields.get_field_help">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="nd">@tools</span><span class="o">.</span><span class="n">ormcache_context</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">get_field_help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the translation of fields help in the context&#39;s language.</span>
<span class="sd">        Note that the result contains the available translations only.</span>

<span class="sd">        :param model_name: the name of a model</span>
<span class="sd">        :return: the model&#39;s fields&#39; help as a dictionary `{field_name: field_help}`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)])</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">help</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">}</span></div>


<div class="viewcode-block" id="IrModelFields.get_field_selection">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelFields.get_field_selection">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="nd">@tools</span><span class="o">.</span><span class="n">ormcache_context</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">,</span> <span class="s1">&#39;field_name&#39;</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">get_field_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the translation of a field&#39;s selection in the context&#39;s language.</span>
<span class="sd">        Note that the result contains the available translations only.</span>

<span class="sd">        :param model_name: the name of the field&#39;s model</span>
<span class="sd">        :param field_name: the name of the field</span>
<span class="sd">        :return: the fields&#39; selection as a list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">sel</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">sel</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">sel</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">selection_ids</span><span class="p">]</span></div>
</div>



<div class="viewcode-block" id="ModelInherit">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.ModelInherit">[docs]</a>
<span class="k">class</span> <span class="nc">ModelInherit</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s2">&quot;ir.model.inherit&quot;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s2">&quot;Model Inheritance Tree&quot;</span>
    <span class="n">_log_access</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">model_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s2">&quot;ir.model&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s2">&quot;cascade&quot;</span><span class="p">)</span>
    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s2">&quot;ir.model&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s2">&quot;cascade&quot;</span><span class="p">)</span>
    <span class="n">parent_field_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s2">&quot;ir.model.fields&quot;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s2">&quot;cascade&quot;</span><span class="p">)</span>  <span class="c1"># in case of inherits</span>

    <span class="n">_sql_constraints</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;uniq&quot;</span><span class="p">,</span> <span class="s2">&quot;UNIQUE(model_id, parent_id)&quot;</span><span class="p">,</span> <span class="s2">&quot;Models inherits from another only once&quot;</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_reflect_inherits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Reflect the given models&#39; inherits (_inherit and _inherits). &quot;&quot;&quot;</span>
        <span class="n">IrModel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;ir.model&quot;</span><span class="p">]</span>
        <span class="n">get_model_id</span> <span class="o">=</span> <span class="n">IrModel</span><span class="o">.</span><span class="n">_get_id</span>

        <span class="n">module_mapping</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">model_names</span><span class="p">:</span>
            <span class="n">get_field_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;ir.model.fields&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_ids</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span><span class="o">.</span><span class="n">get</span>
            <span class="n">model_id</span> <span class="o">=</span> <span class="n">get_model_id</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>

            <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">mro</span><span class="p">()):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">models</span><span class="o">.</span><span class="n">is_definition_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">items</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">get_model_id</span><span class="p">(</span><span class="n">parent_name</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">parent_name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_inherit</span>
                    <span class="k">if</span> <span class="n">parent_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;base&quot;</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>
                <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">get_model_id</span><span class="p">(</span><span class="n">parent_name</span><span class="p">),</span> <span class="n">get_field_id</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">parent_name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_inherits</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">]</span>

                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                    <span class="n">module_mapping</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_module</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">module_mapping</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                SELECT i.id, i.model_id, i.parent_id, i.parent_field_id</span>
<span class="sd">                  FROM ir_model_inherit i</span>
<span class="sd">                  JOIN ir_model m</span>
<span class="sd">                    ON m.id = i.model_id</span>
<span class="sd">                 WHERE m.model IN %s</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">model_names</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">inh_ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">iid</span><span class="p">,</span> <span class="n">model_id</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">,</span> <span class="n">parent_field_id</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="n">inh_ids</span><span class="p">[(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">,</span> <span class="n">parent_field_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">iid</span>
            <span class="n">existing</span><span class="p">[(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">)]</span> <span class="o">=</span> <span class="n">parent_field_id</span>

        <span class="n">sentinel</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;model_id&quot;</span><span class="p">,</span> <span class="s2">&quot;parent_id&quot;</span><span class="p">,</span> <span class="s2">&quot;parent_field_id&quot;</span><span class="p">]</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">module_mapping</span> <span class="k">if</span> <span class="n">existing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">sentinel</span><span class="p">)</span> <span class="o">!=</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">upsert_en</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;model_id&quot;</span><span class="p">,</span> <span class="s2">&quot;parent_id&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">id_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">ids</span><span class="p">):</span>
                <span class="n">inh_ids</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">post_init</span><span class="p">(</span><span class="n">mark_modified</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="n">cols</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="c1"># update their XML id</span>
        <span class="n">IrModel</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">id_</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">module_mapping</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">fetch</span><span class="p">([</span><span class="s1">&#39;model&#39;</span><span class="p">])</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">,</span> <span class="n">parent_field_id</span><span class="p">),</span> <span class="n">modules</span> <span class="ow">in</span> <span class="n">module_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">model_name</span> <span class="o">=</span> <span class="n">IrModel</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">parent_name</span> <span class="o">=</span> <span class="n">IrModel</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">parent_id</span><span class="p">)</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">record_id</span> <span class="o">=</span> <span class="n">inh_ids</span><span class="p">[(</span><span class="n">model_id</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">,</span> <span class="n">parent_field_id</span><span class="p">)]</span>
            <span class="n">data_list</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;xml_id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2">.model_inherit__</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">__</span><span class="si">{</span><span class="n">parent_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;record&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">record_id</span><span class="p">),</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span>
            <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;ir.model.data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">_update_xmlids</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span></div>



<div class="viewcode-block" id="IrModelSelection">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelSelection">[docs]</a>
<span class="k">class</span> <span class="nc">IrModelSelection</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;ir.model.fields.selection&#39;</span>
    <span class="n">_order</span> <span class="o">=</span> <span class="s1">&#39;sequence, id&#39;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s2">&quot;Fields Selection&quot;</span>
    <span class="n">_allow_sudo_commands</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">field_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s2">&quot;ir.model.fields&quot;</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s2">&quot;cascade&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">domain</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;ttype&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">])])</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">translate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sequence</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Integer</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

    <span class="n">_sql_constraints</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;selection_field_uniq&#39;</span><span class="p">,</span> <span class="s1">&#39;unique(field_id, value)&#39;</span><span class="p">,</span>
         <span class="s1">&#39;Selections values must be unique per field&#39;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the given field&#39;s selection as a list of pairs (value, string). &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush_model</span><span class="p">([</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;field_id&#39;</span><span class="p">,</span> <span class="s1">&#39;sequence&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_selection_data</span><span class="p">(</span><span class="n">field_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_selection_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_id</span><span class="p">):</span>
        <span class="c1"># return selection as expected on registry (no translations)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT value, name-&gt;&gt;&#39;en_US&#39;</span>
<span class="s2">            FROM ir_model_fields_selection</span>
<span class="s2">            WHERE field_id=</span><span class="si">%s</span>
<span class="s2">            ORDER BY sequence, id</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">field_id</span><span class="p">,))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_reflect_selections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Reflect the selections of the fields of the given models. &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">field</span>
            <span class="k">for</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">model_names</span>
            <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;selection&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># determine expected and existing rows</span>
        <span class="n">IMF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.fields&#39;</span><span class="p">]</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="n">field_id</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span>
            <span class="k">for</span> <span class="n">field_id</span> <span class="ow">in</span> <span class="p">[</span><span class="n">IMF</span><span class="o">.</span><span class="n">_get_ids</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">model_name</span><span class="p">)[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">selection</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT s.field_id, s.value, s.name-&gt;&gt;&#39;en_US&#39;, s.sequence</span>
<span class="s2">            FROM ir_model_fields_selection s, ir_model_fields f</span>
<span class="s2">            WHERE s.field_id = f.id AND f.model IN </span><span class="si">%s</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">model_names</span><span class="p">)])</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="p">{</span><span class="n">row</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()}</span>

        <span class="c1"># create or update rows</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;field_id&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;sequence&#39;</span><span class="p">]</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="o">+</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">expected</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">existing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">upsert_en</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;field_id&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">post_init</span><span class="p">(</span><span class="n">mark_modified</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="n">cols</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>

        <span class="c1"># update their XML ids</span>
        <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;module&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">module</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT f.model, f.name, s.value, s.id</span>
<span class="s2">            FROM ir_model_fields_selection s, ir_model_fields f</span>
<span class="s2">            WHERE s.field_id = f.id AND f.model IN </span><span class="si">%s</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">model_names</span><span class="p">)])</span>
        <span class="n">selection_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">row</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()}</span>

        <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">modules</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">_selection_modules</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
                    <span class="n">xml_id</span> <span class="o">=</span> <span class="n">selection_xmlid</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">selection_ids</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">])</span>
                    <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;xml_id&#39;</span><span class="p">:</span> <span class="n">xml_id</span><span class="p">,</span> <span class="s1">&#39;record&#39;</span><span class="p">:</span> <span class="n">record</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_update_xmlids</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">selection</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Set the selection of a field to the given list, and return the row</span>
<span class="sd">            values of the given selection records.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_ids</span><span class="p">(</span><span class="n">model_name</span><span class="p">)[</span><span class="n">field_name</span><span class="p">]</span>

        <span class="c1"># selection rows {value: row}</span>
        <span class="n">cur_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_existing_selection_data</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
        <span class="n">new_rows</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">value</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">sequence</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">rows_to_insert</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rows_to_update</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rows_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">new_rows</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">|</span> <span class="n">cur_rows</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">new_row</span><span class="p">,</span> <span class="n">cur_row</span> <span class="o">=</span> <span class="n">new_rows</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">cur_rows</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">ready</span><span class="p">:</span>
                    <span class="c1"># removing a selection in the new list, at your own risks</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Removing selection value </span><span class="si">%s</span><span class="s2"> on </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="n">cur_row</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
                    <span class="n">rows_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">cur_row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Json</span><span class="p">({</span><span class="s1">&#39;en_US&#39;</span><span class="p">:</span> <span class="n">new_row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]})</span>
                <span class="n">rows_to_insert</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">new_row</span><span class="p">,</span> <span class="n">field_id</span><span class="o">=</span><span class="n">field_id</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">new_row</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cur_row</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_row</span><span class="p">):</span>
                <span class="n">new_row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Json</span><span class="p">({</span><span class="s1">&#39;en_US&#39;</span><span class="p">:</span> <span class="n">new_row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]})</span>
                <span class="n">rows_to_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">new_row</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">cur_row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">rows_to_insert</span><span class="p">:</span>
            <span class="n">row_ids</span> <span class="o">=</span> <span class="n">query_insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">rows_to_insert</span><span class="p">)</span>
            <span class="c1"># update cur_rows for output</span>
            <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">row_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rows_to_insert</span><span class="p">,</span> <span class="n">row_ids</span><span class="p">):</span>
                <span class="n">cur_rows</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">row_id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows_to_update</span><span class="p">:</span>
            <span class="n">query_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">rows_to_remove</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">rows_to_remove</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">cur_rows</span>

    <span class="k">def</span> <span class="nf">_existing_selection_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the selection data of the given model, by field and value, as</span>
<span class="sd">            a dict {field_name: {value: row_values}}.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT s.*, s.name-&gt;&gt;&#39;en_US&#39; AS name</span>
<span class="s2">            FROM ir_model_fields_selection s</span>
<span class="s2">            JOIN ir_model_fields f ON s.field_id=f.id</span>
<span class="s2">            WHERE f.model=</span><span class="si">%s</span><span class="s2"> and f.name=</span><span class="si">%s</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]:</span> <span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">()}</span>

<div class="viewcode-block" id="IrModelSelection.create">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelSelection.create">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model_create_multi</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
        <span class="n">field_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">vals</span><span class="p">[</span><span class="s1">&#39;field_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">vals_list</span><span class="p">}</span>
        <span class="n">field_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">field_ids</span><span class="p">):</span>
            <span class="n">field_names</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="s1">&#39;manual&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Properties of base fields cannot be altered in this manner! &#39;</span>
                                  <span class="s1">&#39;Please modify them through Python code, &#39;</span>
                                  <span class="s1">&#39;preferably through a custom addon!&#39;</span><span class="p">))</span>
        <span class="n">recs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">vals_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span>
            <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">field_names</span>
        <span class="p">):</span>
            <span class="c1"># setup models; this re-initializes model in registry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">recs</span></div>


<div class="viewcode-block" id="IrModelSelection.write">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelSelection.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">()</span> <span class="ow">and</span>
            <span class="nb">any</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">field_id</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="s1">&#39;manual&#39;</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Properties of base fields cannot be altered in this manner! &#39;</span>
                              <span class="s1">&#39;Please modify them through Python code, &#39;</span>
                              <span class="s1">&#39;preferably through a custom addon!&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;value&#39;</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">selection</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">field_id</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
                    <span class="c1"># in order to keep the cache consistent, flush the</span>
                    <span class="c1"># corresponding field, and invalidate it from cache</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">selection</span><span class="o">.</span><span class="n">field_id</span><span class="o">.</span><span class="n">model</span><span class="p">]</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">field_id</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">invalidate_model</span><span class="p">([</span><span class="n">fname</span><span class="p">])</span>
                    <span class="c1"># replace the value by the new one in the field&#39;s corresponding column</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;UPDATE &quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">_table</span><span class="si">}</span><span class="s1">&quot; SET &quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s1">&quot;=%s WHERE &quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s1">&quot;=%s&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">selection</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>

        <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

        <span class="c1"># setup models; this re-initializes model in registry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">ondelete</span><span class="p">(</span><span class="n">at_uninstall</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_unlink_if_manual</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Prevent manual deletion of module columns</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">ready</span>
            <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">field_id</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="s1">&#39;manual&#39;</span> <span class="k">for</span> <span class="n">selection</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Properties of base fields cannot be altered in this manner! &#39;</span>
                              <span class="s1">&#39;Please modify them through Python code, &#39;</span>
                              <span class="s1">&#39;preferably through a custom addon!&#39;</span><span class="p">))</span>

<div class="viewcode-block" id="IrModelSelection.unlink">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelSelection.unlink">[docs]</a>
    <span class="k">def</span> <span class="nf">unlink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_ondelete</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="c1"># Reload registry for normal unlink only. For module uninstall, the</span>
        <span class="c1"># reload is done independently in odoo.modules.loading.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">MODULE_UNINSTALL_FLAG</span><span class="p">):</span>
            <span class="c1"># setup models; this re-initializes model in registry</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>


    <span class="k">def</span> <span class="nf">_process_ondelete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Process the &#39;ondelete&#39; of the given selection values. &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">safe_write</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">records</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">savepoint</span><span class="p">():</span>
                    <span class="n">records</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="n">fname</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># going through the ORM failed, probably because of an exception</span>
                <span class="c1"># in an override or possibly a constraint.</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">runbot</span><span class="p">(</span>
                    <span class="s2">&quot;Could not fulfill ondelete action for field </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">, &quot;</span>
                    <span class="s2">&quot;attempting ORM bypass...&quot;</span><span class="p">,</span> <span class="n">records</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;UPDATE </span><span class="si">{}</span><span class="s2"> SET </span><span class="si">{}</span><span class="s2">=</span><span class="si">%s</span><span class="s2"> WHERE id IN </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">sql</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">_table</span><span class="p">),</span>
                    <span class="n">sql</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">fname</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="c1"># if this fails then we&#39;re shit out of luck and there&#39;s nothing</span>
                <span class="c1"># we can do except fix on a case-by-case basis</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_column</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">records</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="n">value</span><span class="p">,</span> <span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">])</span>
                <span class="n">records</span><span class="o">.</span><span class="n">invalidate_recordset</span><span class="p">([</span><span class="n">fname</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">selection</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">selection</span><span class="o">.</span><span class="n">field_id</span><span class="o">.</span><span class="n">model</span><span class="p">]</span>
            <span class="c1"># The field may exist in database but not in registry. In this case</span>
            <span class="c1"># we allow the field to be skipped, but for production this should</span>
            <span class="c1"># be handled through a migration script. The ORM will take care of</span>
            <span class="c1"># the orphaned &#39;ir.model.fields&#39; down the stack, and will log a</span>
            <span class="c1"># warning prompting the developer to write a migration script.</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">field_id</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">Model</span><span class="o">.</span><span class="n">_auto</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">ondelete</span> <span class="o">=</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">ondelete</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="c1"># special case for custom fields</span>
            <span class="k">if</span> <span class="n">ondelete</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">manual</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">required</span><span class="p">:</span>
                <span class="n">ondelete</span> <span class="o">=</span> <span class="s1">&#39;set null&#39;</span>

            <span class="k">if</span> <span class="n">ondelete</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># nothing to do, the selection does not come from a field extension</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">ondelete</span><span class="p">):</span>
                <span class="n">ondelete</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">_get_records</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">ondelete</span> <span class="o">==</span> <span class="s1">&#39;set null&#39;</span><span class="p">:</span>
                <span class="n">safe_write</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">_get_records</span><span class="p">(),</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ondelete</span> <span class="o">==</span> <span class="s1">&#39;set default&#39;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_write</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">Model</span><span class="p">),</span> <span class="n">Model</span><span class="p">)</span>
                <span class="n">safe_write</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">_get_records</span><span class="p">(),</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ondelete</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;set &#39;</span><span class="p">):</span>
                <span class="n">safe_write</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">_get_records</span><span class="p">(),</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ondelete</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>
            <span class="k">elif</span> <span class="n">ondelete</span> <span class="o">==</span> <span class="s1">&#39;cascade&#39;</span><span class="p">:</span>
                <span class="n">selection</span><span class="o">.</span><span class="n">_get_records</span><span class="p">()</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># this shouldn&#39;t happen... simply a sanity check</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;The ondelete policy </span><span class="si">%r</span><span class="s2"> is not valid for field </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">ondelete</span><span class="p">,</span> <span class="n">selection</span>
                <span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_records</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the records having &#39;self&#39; as a value. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="o">.</span><span class="n">model</span><span class="p">]</span>
        <span class="n">Model</span><span class="o">.</span><span class="n">flush_model</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT id FROM &quot;</span><span class="si">{table}</span><span class="s1">&quot; WHERE &quot;</span><span class="si">{field}</span><span class="s1">&quot;=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">table</span><span class="o">=</span><span class="n">Model</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">Model</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span></div>



<div class="viewcode-block" id="IrModelConstraint">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelConstraint">[docs]</a>
<span class="k">class</span> <span class="nc">IrModelConstraint</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This model tracks PostgreSQL foreign keys and constraints used by Odoo</span>
<span class="sd">    models.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;ir.model.constraint&#39;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s1">&#39;Model Constraint&#39;</span>
    <span class="n">_allow_sudo_commands</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Constraint&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;PostgreSQL constraint or foreign key name.&quot;</span><span class="p">)</span>
    <span class="n">definition</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;PostgreSQL constraint definition&quot;</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;Error message returned when the constraint is violated.&quot;</span><span class="p">,</span> <span class="n">translate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;ir.model&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s2">&quot;cascade&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;ir.module.module&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;cascade&#39;</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Constraint Type&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Type of the constraint: `f` for a foreign key, &quot;</span>
                            <span class="s2">&quot;`u` for other constraints.&quot;</span><span class="p">)</span>
    <span class="n">write_date</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Datetime</span><span class="p">()</span>
    <span class="n">create_date</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Datetime</span><span class="p">()</span>

    <span class="n">_sql_constraints</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;module_name_uniq&#39;</span><span class="p">,</span> <span class="s1">&#39;unique(name, module)&#39;</span><span class="p">,</span>
         <span class="s1">&#39;Constraints with the same name are unique per module.&#39;</span><span class="p">),</span>
    <span class="p">]</span>

<div class="viewcode-block" id="IrModelConstraint.unlink">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelConstraint.unlink">[docs]</a>
    <span class="k">def</span> <span class="nf">unlink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;unlink&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rule</span><span class="p">(</span><span class="s1">&#39;unlink&#39;</span><span class="p">)</span>
        <span class="n">ids_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">ustr</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">:</span>
                <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">_table</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">table</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">type</span>

            <span class="c1"># double-check we are really going to delete all the owners of this schema element</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT id from ir_model_constraint where name=</span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">,))</span>
            <span class="n">external_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">external_ids</span> <span class="o">-</span> <span class="n">ids_set</span><span class="p">:</span>
                <span class="c1"># as installed modules have defined this element we must not delete it!</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span>
                <span class="c1"># test if FK exists on this table (it could be on a related m2m table, in which case we ignore it)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT 1 from pg_constraint cs JOIN pg_class cl ON (cs.conrelid = cl.oid)</span>
<span class="s2">                                    WHERE cs.contype=</span><span class="si">%s</span><span class="s2"> and cs.conname=</span><span class="si">%s</span><span class="s2"> and cl.relname=</span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
                                 <span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="n">sql</span><span class="o">.</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ALTER TABLE </span><span class="si">{}</span><span class="s1"> DROP CONSTRAINT </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">sql</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">table</span><span class="p">),</span>
                            <span class="n">sql</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">name</span><span class="p">[:</span><span class="mi">63</span><span class="p">])</span>
                        <span class="p">))</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Dropped FK CONSTRAINT </span><span class="si">%s</span><span class="s1">@</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;u&#39;</span><span class="p">:</span>
                <span class="n">hname</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">make_identifier</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="c1"># test if constraint exists</span>
                <span class="c1"># Since type=&#39;u&#39; means any &quot;other&quot; constraint, to avoid issues we limit to</span>
                <span class="c1"># &#39;c&#39; -&gt; check, &#39;u&#39; -&gt; unique, &#39;x&#39; -&gt; exclude constraints, effective leaving</span>
                <span class="c1"># out &#39;p&#39; -&gt; primary key and &#39;f&#39; -&gt; foreign key, constraints.</span>
                <span class="c1"># See: https://www.postgresql.org/docs/9.5/catalog-pg-constraint.html</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT 1 from pg_constraint cs JOIN pg_class cl ON (cs.conrelid = cl.oid)</span>
<span class="s2">                                    WHERE cs.contype in (&#39;c&#39;, &#39;u&#39;, &#39;x&#39;) and cs.conname=</span><span class="si">%s</span><span class="s2"> and cl.relname=</span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
                                 <span class="p">(</span><span class="n">hname</span><span class="p">,</span> <span class="n">table</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;ALTER TABLE </span><span class="si">{}</span><span class="s1"> DROP CONSTRAINT </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">sql</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">table</span><span class="p">),</span> <span class="n">sql</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">hname</span><span class="p">)))</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Dropped CONSTRAINT </span><span class="si">%s</span><span class="s1">@</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>


<div class="viewcode-block" id="IrModelConstraint.copy">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelConstraint.copy">[docs]</a>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">default</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">default</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="n">default</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_copy&#39;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">IrModelConstraint</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">default</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_reflect_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">conname</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">definition</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Reflect the given constraint, and return its corresponding record</span>
<span class="sd">            if a record is created or modified; returns ``None`` otherwise.</span>
<span class="sd">            The reflection makes it possible to remove a constraint when its</span>
<span class="sd">            corresponding module is uninstalled. ``type`` is either &#39;f&#39; or &#39;u&#39;</span>
<span class="sd">            depending on the constraint being a foreign key or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">module</span><span class="p">:</span>
            <span class="c1"># no need to save constraints for custom models as they&#39;re not part</span>
            <span class="c1"># of any module</span>
            <span class="k">return</span>
        <span class="k">assert</span> <span class="nb">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">)</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT c.id, type, definition, message-&gt;&gt;&#39;en_US&#39; as message</span>
<span class="s2">                    FROM ir_model_constraint c, ir_module_module m</span>
<span class="s2">                    WHERE c.module=m.id AND c.name=</span><span class="si">%s</span><span class="s2"> AND m.name=</span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">conname</span><span class="p">,</span> <span class="n">module</span><span class="p">))</span>
        <span class="n">cons</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">dictfetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cons</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; INSERT INTO ir_model_constraint</span>
<span class="s2">                            (name, create_date, write_date, create_uid, write_uid, module, model, type, definition, message)</span>
<span class="s2">                        VALUES (</span><span class="si">%s</span><span class="s2">,</span>
<span class="s2">                                now() AT TIME ZONE &#39;UTC&#39;,</span>
<span class="s2">                                now() AT TIME ZONE &#39;UTC&#39;,</span>
<span class="s2">                                </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">,</span>
<span class="s2">                                (SELECT id FROM ir_module_module WHERE name=</span><span class="si">%s</span><span class="s2">),</span>
<span class="s2">                                (SELECT id FROM ir_model WHERE model=</span><span class="si">%s</span><span class="s2">),</span>
<span class="s2">                                </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                        RETURNING id&quot;&quot;&quot;</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">conname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">definition</span><span class="p">,</span> <span class="n">Json</span><span class="p">({</span><span class="s1">&#39;en_US&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">})))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">cons_id</span> <span class="o">=</span> <span class="n">cons</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cons</span> <span class="o">!=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span> <span class="n">definition</span><span class="o">=</span><span class="n">definition</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">):</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; UPDATE ir_model_constraint</span>
<span class="s2">                        SET write_date=now() AT TIME ZONE &#39;UTC&#39;,</span>
<span class="s2">                            write_uid=</span><span class="si">%s</span><span class="s2">, type=</span><span class="si">%s</span><span class="s2">, definition=</span><span class="si">%s</span><span class="s2">, message=</span><span class="si">%s</span>
<span class="s2">                        WHERE id=</span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">definition</span><span class="p">,</span> <span class="n">Json</span><span class="p">({</span><span class="s1">&#39;en_US&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">}),</span> <span class="n">cons_id</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cons_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reflect_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Reflect the SQL constraints of the given models. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">model_names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reflect_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model_name</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_reflect_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Reflect the _sql_constraints of the given model. &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">cons_text</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">txt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; (&#39;</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="p">)</span>

        <span class="c1"># map each constraint on the name of the module where it is defined</span>
        <span class="n">constraint_module</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_module</span>
            <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">mro</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">models</span><span class="o">.</span><span class="n">is_definition_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;_local_sql_constraints&#39;</span><span class="p">,</span> <span class="p">())</span>
        <span class="p">}</span>

        <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">definition</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_sql_constraints</span><span class="p">:</span>
            <span class="n">conname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">constraint_module</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reflect_constraint</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">conname</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="n">cons_text</span><span class="p">(</span><span class="n">definition</span><span class="p">),</span> <span class="n">module</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="n">xml_id</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.constraint_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">conname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">record</span><span class="p">:</span>
                <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">xml_id</span><span class="o">=</span><span class="n">xml_id</span><span class="p">,</span> <span class="n">record</span><span class="o">=</span><span class="n">record</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_load_xmlid</span><span class="p">(</span><span class="n">xml_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_update_xmlids</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span></div>



<div class="viewcode-block" id="IrModelRelation">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelRelation">[docs]</a>
<span class="k">class</span> <span class="nc">IrModelRelation</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This model tracks PostgreSQL tables used to implement Odoo many2many</span>
<span class="sd">    relations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;ir.model.relation&#39;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s1">&#39;Relation Model&#39;</span>
    <span class="n">_allow_sudo_commands</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Relation Name&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;PostgreSQL table name implementing a many2many relation.&quot;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;ir.model&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;cascade&#39;</span><span class="p">)</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;ir.module.module&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;cascade&#39;</span><span class="p">)</span>
    <span class="n">write_date</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Datetime</span><span class="p">()</span>
    <span class="n">create_date</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Datetime</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_module_data_uninstall</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete PostgreSQL many2many relations tracked by this model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">is_system</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">AccessError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Administrator access is required to uninstall a module&#39;</span><span class="p">))</span>

        <span class="n">ids_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
        <span class="n">to_drop</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">OrderedSet</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">ustr</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># double-check we are really going to delete all the owners of this schema element</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT id from ir_model_relation where name = </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">,))</span>
            <span class="n">external_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">external_ids</span> <span class="o">-</span> <span class="n">ids_set</span><span class="p">:</span>
                <span class="c1"># as installed modules have defined this element we must not delete it!</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">tools</span><span class="o">.</span><span class="n">table_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="n">to_drop</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="c1"># drop m2m relation tables</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">to_drop</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;DROP TABLE </span><span class="si">{}</span><span class="s1"> CASCADE&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">table</span><span class="p">)))</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Dropped table </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reflect_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Reflect the table of a many2many field for the given model, to make</span>
<span class="sd">            it possible to delete it later when the module is uninstalled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT 1 FROM ir_model_relation r, ir_module_module m</span>
<span class="s2">                    WHERE r.module=m.id AND r.name=</span><span class="si">%s</span><span class="s2"> AND m.name=</span><span class="si">%s</span><span class="s2"> &quot;&quot;&quot;</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">module</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cr</span><span class="o">.</span><span class="n">rowcount</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; INSERT INTO ir_model_relation</span>
<span class="s2">                            (name, create_date, write_date, create_uid, write_uid, module, model)</span>
<span class="s2">                        VALUES (</span><span class="si">%s</span><span class="s2">,</span>
<span class="s2">                                now() AT TIME ZONE &#39;UTC&#39;,</span>
<span class="s2">                                now() AT TIME ZONE &#39;UTC&#39;,</span>
<span class="s2">                                </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">,</span>
<span class="s2">                                (SELECT id FROM ir_module_module WHERE name=</span><span class="si">%s</span><span class="s2">),</span>
<span class="s2">                                (SELECT id FROM ir_model WHERE model=</span><span class="si">%s</span><span class="s2">)) &quot;&quot;&quot;</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span></div>



<div class="viewcode-block" id="IrModelAccess">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelAccess">[docs]</a>
<span class="k">class</span> <span class="nc">IrModelAccess</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;ir.model.access&#39;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s1">&#39;Model Access&#39;</span>
    <span class="n">_order</span> <span class="o">=</span> <span class="s1">&#39;model_id,group_id,name,id&#39;</span>
    <span class="n">_allow_sudo_commands</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If you uncheck the active field, it will disable the ACL without deleting it (if you delete a native ACL, it will be re-created when you reload the module).&#39;</span><span class="p">)</span>
    <span class="n">model_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;ir.model&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Model&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;cascade&#39;</span><span class="p">)</span>
    <span class="n">group_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;res.groups&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;restrict&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">perm_read</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Read Access&#39;</span><span class="p">)</span>
    <span class="n">perm_write</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Write Access&#39;</span><span class="p">)</span>
    <span class="n">perm_create</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Create Access&#39;</span><span class="p">)</span>
    <span class="n">perm_unlink</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Delete Access&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="IrModelAccess.group_names_with_access">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelAccess.group_names_with_access">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">group_names_with_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">access_mode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the names of visible groups which have been granted</span>
<span class="sd">            ``access_mode`` on the model ``model_name``.</span>
<span class="sd">           :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">access_mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;unlink&#39;</span><span class="p">),</span> <span class="s1">&#39;Invalid access mode&#39;</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span> <span class="ow">or</span> <span class="s1">&#39;en_US&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT COALESCE(c.name-&gt;&gt;%s, c.name-&gt;&gt;&#39;en_US&#39;), COALESCE(g.name-&gt;&gt;%s, g.name-&gt;&gt;&#39;en_US&#39;)</span>
<span class="s2">              FROM ir_model_access a</span>
<span class="s2">              JOIN ir_model m ON (a.model_id = m.id)</span>
<span class="s2">              JOIN res_groups g ON (a.group_id = g.id)</span>
<span class="s2">         LEFT JOIN ir_module_category c ON (c.id = g.category_id)</span>
<span class="s2">             WHERE m.model = %s</span>
<span class="s2">               AND a.active = TRUE</span>
<span class="s2">               AND a.perm_</span><span class="si">{</span><span class="n">access_mode</span><span class="si">}</span><span class="s2"> = TRUE</span>
<span class="s2">          ORDER BY c.name, g.name NULLS LAST</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">lang</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">model_name</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span></div>


    <span class="c1"># The context parameter is useful when the method translates error messages.</span>
    <span class="c1"># But as the method raises an exception in that case,  the key &#39;lang&#39; might</span>
    <span class="c1"># not be really necessary as a cache key, unless the `ormcache_context`</span>
    <span class="c1"># decorator catches the exception (it does not at the moment.)</span>

    <span class="nd">@tools</span><span class="o">.</span><span class="n">ormcache</span><span class="p">(</span><span class="s1">&#39;self.env.uid&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_allowed_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;read&#39;</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;unlink&#39;</span><span class="p">),</span> <span class="s1">&#39;Invalid access mode&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">flush_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT m.model</span>
<span class="s2">              FROM ir_model_access a</span>
<span class="s2">              JOIN ir_model m ON (m.id = a.model_id)</span>
<span class="s2">             WHERE a.perm_</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span>
<span class="s2">               AND a.active</span>
<span class="s2">               AND (</span>
<span class="s2">                    a.group_id IS NULL OR</span>
<span class="s2">                    -- use subselect fo force a better query plan. See #99695 --</span>
<span class="s2">                    a.group_id IN (</span>
<span class="s2">                        SELECT gu.gid</span>
<span class="s2">                            FROM res_groups_users_rel gu</span>
<span class="s2">                            WHERE gu.uid = %s</span>
<span class="s2">                    )</span>
<span class="s2">                )</span>
<span class="s2">            GROUP BY m.model</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span><span class="p">,))</span>

        <span class="k">return</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>

<div class="viewcode-block" id="IrModelAccess.check">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelAccess.check">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">su</span><span class="p">:</span>
            <span class="c1"># User root have all accesses</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="s1">&#39;Not a model name: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="p">,)</span>

        <span class="c1"># TransientModel records have no access rights, only an implicit access rule</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Missing model </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

        <span class="n">has_access</span> <span class="o">=</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_allowed_models</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_access</span> <span class="ow">and</span> <span class="n">raise_exception</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">- </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_names_with_access</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>
            <span class="n">document_kind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">model</span>
            <span class="n">msg_heads</span> <span class="o">=</span> <span class="p">{</span>
                <span class="c1"># Messages are declared in extenso so they are properly exported in translation terms</span>
                <span class="s1">&#39;read&#39;</span><span class="p">:</span> <span class="n">_lt</span><span class="p">(</span>
                    <span class="s2">&quot;You are not allowed to access &#39;</span><span class="si">%(document_kind)s</span><span class="s2">&#39; (</span><span class="si">%(document_model)s</span><span class="s2">) records.&quot;</span><span class="p">,</span>
                    <span class="n">document_kind</span><span class="o">=</span><span class="n">document_kind</span><span class="p">,</span>
                    <span class="n">document_model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="s1">&#39;write&#39;</span><span class="p">:</span>  <span class="n">_lt</span><span class="p">(</span>
                    <span class="s2">&quot;You are not allowed to modify &#39;</span><span class="si">%(document_kind)s</span><span class="s2">&#39; (</span><span class="si">%(document_model)s</span><span class="s2">) records.&quot;</span><span class="p">,</span>
                    <span class="n">document_kind</span><span class="o">=</span><span class="n">document_kind</span><span class="p">,</span>
                    <span class="n">document_model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="s1">&#39;create&#39;</span><span class="p">:</span> <span class="n">_lt</span><span class="p">(</span>
                    <span class="s2">&quot;You are not allowed to create &#39;</span><span class="si">%(document_kind)s</span><span class="s2">&#39; (</span><span class="si">%(document_model)s</span><span class="s2">) records.&quot;</span><span class="p">,</span>
                    <span class="n">document_kind</span><span class="o">=</span><span class="n">document_kind</span><span class="p">,</span>
                    <span class="n">document_model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="s1">&#39;unlink&#39;</span><span class="p">:</span> <span class="n">_lt</span><span class="p">(</span>
                    <span class="s2">&quot;You are not allowed to delete &#39;</span><span class="si">%(document_kind)s</span><span class="s2">&#39; (</span><span class="si">%(document_model)s</span><span class="s2">) records.&quot;</span><span class="p">,</span>
                    <span class="n">document_kind</span><span class="o">=</span><span class="n">document_kind</span><span class="p">,</span>
                    <span class="n">document_model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">}</span>
            <span class="n">operation_error</span> <span class="o">=</span> <span class="n">msg_heads</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">groups</span><span class="p">:</span>
                <span class="n">group_info</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;This operation is allowed for the following groups:</span><span class="se">\n</span><span class="si">%(groups_list)s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">groups_list</span><span class="o">=</span><span class="n">groups</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group_info</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;No group currently allows this operation.&quot;</span><span class="p">)</span>

            <span class="n">resolution_info</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Contact your administrator to request access if necessary.&quot;</span><span class="p">)</span>

            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Access Denied by ACLs for operation: </span><span class="si">%s</span><span class="s1">, uid: </span><span class="si">%s</span><span class="s1">, model: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="si">{operation_error}</span>

<span class="si">{group_info}</span>

<span class="si">{resolution_info}</span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">operation_error</span><span class="o">=</span><span class="n">operation_error</span><span class="p">,</span>
                <span class="n">group_info</span><span class="o">=</span><span class="n">group_info</span><span class="p">,</span>
                <span class="n">resolution_info</span><span class="o">=</span><span class="n">resolution_info</span><span class="p">)</span>

            <span class="k">raise</span> <span class="n">AccessError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">has_access</span></div>



<div class="viewcode-block" id="IrModelAccess.call_cache_clearing_methods">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelAccess.call_cache_clearing_methods">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">call_cache_clearing_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>  <span class="c1"># mainly _get_allowed_models</span></div>


    <span class="c1">#</span>
    <span class="c1"># Check rights on actions</span>
    <span class="c1">#</span>
<div class="viewcode-block" id="IrModelAccess.create">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelAccess.create">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model_create_multi</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_cache_clearing_methods</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ima</span> <span class="ow">in</span> <span class="n">vals_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;group_id&quot;</span> <span class="ow">in</span> <span class="n">ima</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ima</span><span class="p">[</span><span class="s2">&quot;group_id&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span>
                    <span class="n">ima</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;perm_read&quot;</span><span class="p">),</span>
                    <span class="n">ima</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;perm_write&quot;</span><span class="p">),</span>
                    <span class="n">ima</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;perm_create&quot;</span><span class="p">),</span>
                    <span class="n">ima</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;perm_unlink&quot;</span><span class="p">)]):</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Rule </span><span class="si">%s</span><span class="s2"> has no group, this is a deprecated feature. Every access-granting rule should specify a group.&quot;</span><span class="p">,</span> <span class="n">ima</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">IrModelAccess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">vals_list</span><span class="p">)</span></div>


<div class="viewcode-block" id="IrModelAccess.write">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelAccess.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_cache_clearing_methods</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">IrModelAccess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">values</span><span class="p">)</span></div>


<div class="viewcode-block" id="IrModelAccess.unlink">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelAccess.unlink">[docs]</a>
    <span class="k">def</span> <span class="nf">unlink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_cache_clearing_methods</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">IrModelAccess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="IrModelData">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelData">[docs]</a>
<span class="k">class</span> <span class="nc">IrModelData</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Holds external identifier keys for records in the database.</span>
<span class="sd">       This has two main uses:</span>

<span class="sd">           * allows easy data integration with third-party systems,</span>
<span class="sd">             making import/export/sync of data possible, as records</span>
<span class="sd">             can be uniquely identified across multiple systems</span>
<span class="sd">           * allows tracking the origin of data installed by Odoo</span>
<span class="sd">             modules themselves, thus making it possible to later</span>
<span class="sd">             update them seamlessly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;ir.model.data&#39;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s1">&#39;Model Data&#39;</span>
    <span class="n">_order</span> <span class="o">=</span> <span class="s1">&#39;module, model, name&#39;</span>
    <span class="n">_allow_sudo_commands</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;External Identifier&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;External Key/Identifier that can be used for &quot;</span>
                            <span class="s2">&quot;data integration with third-party systems&quot;</span><span class="p">)</span>
    <span class="n">complete_name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_complete_name&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Complete ID&#39;</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Model Name&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">res_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2oneReference</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Record ID&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;ID of the target record in the database&quot;</span><span class="p">,</span> <span class="n">model_field</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>
    <span class="n">noupdate</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Non Updatable&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Reference&#39;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_reference&#39;</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">_sql_constraints</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;name_nospaces&#39;</span><span class="p">,</span> <span class="s2">&quot;CHECK(name NOT LIKE &#39;</span><span class="si">% %</span><span class="s2">&#39;)&quot;</span><span class="p">,</span>
         <span class="s2">&quot;External IDs cannot contain spaces&quot;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_complete_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">complete_name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">[</span><span class="n">res</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="k">if</span> <span class="n">n</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;res_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">res_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_auto_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">IrModelData</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_auto_init</span><span class="p">()</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">create_unique_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span> <span class="s1">&#39;ir_model_data_module_name_uniq_index&#39;</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span> <span class="s1">&#39;ir_model_data_model_res_id_index&#39;</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;res_id&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;complete_name&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_display_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">invalid_records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">res_id</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">invalid_record</span> <span class="ow">in</span> <span class="n">invalid_records</span><span class="p">:</span>
            <span class="n">invalid_record</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">invalid_record</span><span class="o">.</span><span class="n">complete_name</span>
        <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">model_data_records</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span> <span class="o">-</span> <span class="n">invalid_records</span><span class="p">)</span><span class="o">.</span><span class="n">grouped</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">model_data_records</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;res_id&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">xid</span><span class="p">,</span> <span class="n">target_record</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">model_data_records</span><span class="p">,</span> <span class="n">records</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">xid</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">target_record</span><span class="o">.</span><span class="n">display_name</span> <span class="ow">or</span> <span class="n">xid</span><span class="o">.</span><span class="n">complete_name</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
                    <span class="n">xid</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">xid</span><span class="o">.</span><span class="n">complete_name</span>

    <span class="c1"># NEW V8 API</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="nd">@tools</span><span class="o">.</span><span class="n">ormcache</span><span class="p">(</span><span class="s1">&#39;xmlid&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_xmlid_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xmlid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Low level xmlid lookup</span>
<span class="sd">        Return (id, res_model, res_id) or raise ValueError if not found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">module</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">xmlid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT model, res_id FROM ir_model_data WHERE module=</span><span class="si">%s</span><span class="s2"> AND name=</span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">result</span> <span class="ow">and</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;External ID not found in the system: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">xmlid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_xmlid_to_res_model_res_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xmlid</span><span class="p">,</span> <span class="n">raise_if_not_found</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return (res_model, res_id)&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmlid_lookup</span><span class="p">(</span><span class="n">xmlid</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">raise_if_not_found</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_xmlid_to_res_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xmlid</span><span class="p">,</span> <span class="n">raise_if_not_found</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Returns res_id &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmlid_to_res_model_res_id</span><span class="p">(</span><span class="n">xmlid</span><span class="p">,</span> <span class="n">raise_if_not_found</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

<div class="viewcode-block" id="IrModelData.check_object_reference">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelData.check_object_reference">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">check_object_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">xml_id</span><span class="p">,</span> <span class="n">raise_on_access_error</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns (model, res_id) corresponding to a given module and xml_id (cached), if and only if the user has the necessary access rights</span>
<span class="sd">        to see that object, otherwise raise a ValueError if raise_on_access_error is True or returns a tuple (model found, False)&quot;&quot;&quot;</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">res_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmlid_lookup</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">xml_id</span><span class="p">))</span>
        <span class="c1">#search on id found in result to check if current user has read access right</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">res_id</span><span class="p">)]):</span>
            <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">res_id</span>
        <span class="k">if</span> <span class="n">raise_on_access_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AccessError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Not enough access rights on the external ID </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">xml_id</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="IrModelData.copy">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelData.copy">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">returns</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="n">rand</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%04x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">random</span><span class="o">.</span><span class="n">getrandbits</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">default</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">default</span> <span class="ow">or</span> <span class="p">{},</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rand</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">default</span><span class="p">)</span></div>


<div class="viewcode-block" id="IrModelData.write">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelData.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>  <span class="c1"># _xmlid_lookup</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">values</span><span class="p">)</span></div>


<div class="viewcode-block" id="IrModelData.unlink">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelData.unlink">[docs]</a>
    <span class="k">def</span> <span class="nf">unlink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Regular unlink method, but make sure to clear the caches. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>  <span class="c1"># _xmlid_lookup</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">IrModelData</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_lookup_xmlids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_ids</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Look up the given XML ids of the given model. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">xml_ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># group xml_ids by prefix</span>
        <span class="n">bymodule</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">xml_id</span> <span class="ow">in</span> <span class="n">xml_ids</span><span class="p">:</span>
            <span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">xml_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">bymodule</span><span class="p">[</span><span class="n">prefix</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>

        <span class="c1"># query xml_ids by prefix</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span>
        <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">suffixes</span> <span class="ow">in</span> <span class="n">bymodule</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT d.id, d.module, d.name, d.model, d.res_id, d.noupdate, r.id</span>
<span class="s2">                FROM ir_model_data d LEFT JOIN &quot;</span><span class="si">{}</span><span class="s2">&quot; r on d.res_id=r.id</span>
<span class="s2">                WHERE d.module=</span><span class="si">%s</span><span class="s2"> AND d.name IN </span><span class="si">%s</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">subsuffixes</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">split_for_in_conditions</span><span class="p">(</span><span class="n">suffixes</span><span class="p">):</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">subsuffixes</span><span class="p">))</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_update_xmlids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_list</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Create or update the given XML ids.</span>

<span class="sd">            :param data_list: list of dicts with keys `xml_id` (XMLID to</span>
<span class="sd">                assign), `noupdate` (flag on XMLID), `record` (target record).</span>
<span class="sd">            :param update: should be ``True`` when upgrading a module</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data_list</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">OrderedSet</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
            <span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;xml_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;record&#39;</span><span class="p">]</span>
            <span class="n">noupdate</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;noupdate&#39;</span><span class="p">))</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">noupdate</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">sub_rows</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">split_for_in_conditions</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
            <span class="c1"># insert rows or update them</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_update_xmlids_query</span><span class="p">(</span><span class="n">sub_rows</span><span class="p">,</span> <span class="n">update</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="n">arg</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">sub_rows</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">row</span><span class="p">])</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">res_id</span><span class="p">,</span> <span class="n">create_date</span><span class="p">,</span> <span class="n">write_date</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                        <span class="c1"># small optimisation: during install a lot of xmlid are created/updated.</span>
                        <span class="c1"># Instead of clearing the cache, set the correct value in the cache to avoid a bunch of query</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_xmlid_lookup</span><span class="o">.</span><span class="n">__cache__</span><span class="o">.</span><span class="n">add_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cache_value</span><span class="o">=</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">res_id</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">create_date</span> <span class="o">!=</span> <span class="n">write_date</span><span class="p">:</span>
                            <span class="c1"># something was updated, notify other workers</span>
                            <span class="c1"># it is possible that create_date and write_date</span>
                            <span class="c1"># have the same value after an update if it was</span>
                            <span class="c1"># created in the same transaction, no need to invalidate other worker cache</span>
                            <span class="c1"># cache in this case.</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">cache_invalidated</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to insert ir_model_data</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">sub_rows</span><span class="p">))</span>
                <span class="k">raise</span>

        <span class="c1"># update loaded_xmlids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">loaded_xmlids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">row</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">)</span>

    <span class="c1"># NOTE: this method is overriden in web_studio; if you need to make another</span>
    <span class="c1">#  override, make sure it is compatible with the one that is there.</span>
    <span class="k">def</span> <span class="nf">_build_insert_xmlids_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;module&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;res_id&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="s1">&#39;noupdate&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_build_update_xmlids_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sub_rows</span><span class="p">,</span> <span class="n">update</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_insert_xmlids_values</span><span class="p">()</span>
        <span class="n">row_names</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rows</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">row_placeholders</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rows</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">row_placeholders</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">row_placeholders</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_rows</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            INSERT INTO ir_model_data </span><span class="si">{row_names}</span>
<span class="s2">            VALUES </span><span class="si">{row_placeholder}</span>
<span class="s2">            ON CONFLICT (module, name)</span>
<span class="s2">            DO UPDATE SET (model, res_id, write_date) =</span>
<span class="s2">                (EXCLUDED.model, EXCLUDED.res_id, now() at time zone &#39;UTC&#39;)</span>
<span class="s2">                WHERE (ir_model_data.res_id != EXCLUDED.res_id OR ir_model_data.model != EXCLUDED.model) </span><span class="si">{and_where}</span>
<span class="s2">            RETURNING module, name, model, res_id, create_date, write_date</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">row_names</span><span class="o">=</span><span class="n">row_names</span><span class="p">,</span>
            <span class="n">row_placeholder</span><span class="o">=</span><span class="n">row_placeholders</span><span class="p">,</span>
            <span class="n">and_where</span><span class="o">=</span><span class="s2">&quot;AND NOT ir_model_data.noupdate&quot;</span> <span class="k">if</span> <span class="n">update</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_load_xmlid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Simply mark the given XML id as being loaded, and return the</span>
<span class="sd">            corresponding record.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">xml_id</span><span class="p">,</span> <span class="n">raise_if_not_found</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">record</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">loaded_xmlids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">xml_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">record</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_module_data_uninstall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modules_to_remove</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deletes all the records referenced by the ir.model.data entries</span>
<span class="sd">        ``ids`` along with their corresponding database backed (including</span>
<span class="sd">        dropping tables, columns, FKs, etc, as long as there is no other</span>
<span class="sd">        ir.model.data entry holding a reference to them (which indicates that</span>
<span class="sd">        they are still owned by another module).</span>
<span class="sd">        Attempts to perform the deletion in an appropriate order to maximize</span>
<span class="sd">        the chance of gracefully deleting all records.</span>
<span class="sd">        This step is performed as part of the full uninstallation of a module.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">is_system</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">AccessError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Administrator access is required to uninstall a module&#39;</span><span class="p">))</span>

        <span class="c1"># enable model/field deletion</span>
        <span class="c1"># we deactivate prefetching to not try to read a column that has been deleted</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">MODULE_UNINSTALL_FLAG</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;prefetch_fields&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>

        <span class="c1"># determine records to unlink</span>
        <span class="n">records_items</span> <span class="o">=</span> <span class="p">[]</span>              <span class="c1"># [(model, id)]</span>
        <span class="n">model_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">field_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">selection_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">constraint_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">module_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">modules_to_remove</span><span class="p">)],</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;id DESC&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">module_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;ir.model&#39;</span><span class="p">:</span>
                <span class="n">model_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">res_id</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;ir.model.fields&#39;</span><span class="p">:</span>
                <span class="n">field_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">res_id</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;ir.model.fields.selection&#39;</span><span class="p">:</span>
                <span class="n">selection_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">res_id</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;ir.model.constraint&#39;</span><span class="p">:</span>
                <span class="n">constraint_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">res_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">records_items</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">res_id</span><span class="p">))</span>

        <span class="c1"># avoid prefetching fields that are going to be deleted: during uninstall, it is</span>
        <span class="c1"># possible to perform a recompute (via flush) after the database columns have been</span>
        <span class="c1"># deleted but before the new registry has been created, meaning the recompute will</span>
        <span class="c1"># be executed on a stale registry, and if some of the data for executing the compute</span>
        <span class="c1"># methods is not in cache it will be fetched, and fields that exist in the registry but not</span>
        <span class="c1"># in the database will be prefetched, this will of course fail and prevent the uninstall.</span>
        <span class="k">for</span> <span class="n">ir_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">field_ids</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ir_field</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ir_field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">field</span><span class="o">.</span><span class="n">prefetch</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># to collect external ids of records that cannot be deleted</span>
        <span class="n">undeletable_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">records</span><span class="p">):</span>
            <span class="c1"># do not delete records that have other external ids (and thus do</span>
            <span class="c1"># not belong to the modules being installed)</span>
            <span class="n">ref_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
                <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">records</span><span class="o">.</span><span class="n">_name</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">records</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span>
            <span class="p">])</span>
            <span class="n">records</span> <span class="o">-=</span> <span class="n">records</span><span class="o">.</span><span class="n">browse</span><span class="p">((</span><span class="n">ref_data</span> <span class="o">-</span> <span class="n">module_data</span><span class="p">)</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;res_id&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">records</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="c1"># special case for ir.model.fields</span>
            <span class="k">if</span> <span class="n">records</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="s1">&#39;ir.model.fields&#39;</span><span class="p">:</span>
                <span class="n">missing</span> <span class="o">=</span> <span class="n">records</span> <span class="o">-</span> <span class="n">records</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                    <span class="c1"># delete orphan external ids right now;</span>
                    <span class="c1"># an orphan ir.model.data can happen if the ir.model.field is deleted via</span>
                    <span class="c1"># an ONDELETE CASCADE, in which case we must verify that the records we&#39;re</span>
                    <span class="c1"># processing exist in the database otherwise a MissingError will be raised</span>
                    <span class="n">orphans</span> <span class="o">=</span> <span class="n">ref_data</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">res_id</span> <span class="ow">in</span> <span class="n">missing</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleting orphan ir_model_data </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">orphans</span><span class="p">)</span>
                    <span class="n">orphans</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                    <span class="c1"># /!\ this must go before any field accesses on `records`</span>
                    <span class="n">records</span> <span class="o">-=</span> <span class="n">missing</span>
                <span class="c1"># do not remove LOG_ACCESS_COLUMNS unless _log_access is False</span>
                <span class="c1"># on the model</span>
                <span class="n">records</span> <span class="o">-=</span> <span class="n">records</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span> <span class="ow">or</span> <span class="p">(</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">LOG_ACCESS_COLUMNS</span> <span class="ow">and</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">_log_access</span>
                <span class="p">))</span>

            <span class="c1"># now delete the records</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleting </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">records</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">savepoint</span><span class="p">():</span>
                    <span class="n">records</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">undeletable_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ref_data</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># divide the batch in two, and recursively delete them</span>
                    <span class="n">half_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
                    <span class="n">delete</span><span class="p">(</span><span class="n">records</span><span class="p">[:</span><span class="n">half_size</span><span class="p">])</span>
                    <span class="n">delete</span><span class="p">(</span><span class="n">records</span><span class="p">[</span><span class="n">half_size</span><span class="p">:])</span>

        <span class="c1"># remove non-model records first, grouped by batches of the same model</span>
        <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">records_items</span><span class="p">),</span> <span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
            <span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">))</span>

        <span class="c1"># Remove copied views. This must happen after removing all records from</span>
        <span class="c1"># the modules to remove, otherwise ondelete=&#39;restrict&#39; may prevent the</span>
        <span class="c1"># deletion of some view. This must also happen before cleaning up the</span>
        <span class="c1"># database schema, otherwise some dependent fields may no longer exist</span>
        <span class="c1"># in database.</span>
        <span class="n">modules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.module.module&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">modules_to_remove</span><span class="p">)])</span>
        <span class="n">modules</span><span class="o">.</span><span class="n">_remove_copied_views</span><span class="p">()</span>

        <span class="c1"># remove constraints</span>
        <span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.constraint&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">constraint_ids</span><span class="p">)))</span>

        <span class="c1"># If we delete a selection field, and some of its values have ondelete=&#39;cascade&#39;,</span>
        <span class="c1"># we expect the records with that value to be deleted. If we delete the field first,</span>
        <span class="c1"># the column is dropped and the selection is gone, and thus the records above will not</span>
        <span class="c1"># be deleted.</span>
        <span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.fields.selection&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">selection_ids</span><span class="p">))</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>
        <span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">field_ids</span><span class="p">)))</span>
        <span class="n">relations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.relation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">modules</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="n">relations</span><span class="o">.</span><span class="n">_module_data_uninstall</span><span class="p">()</span>

        <span class="c1"># remove models</span>
        <span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">model_ids</span><span class="p">)))</span>

        <span class="c1"># log undeletable ids</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ir.model.data could not be deleted (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">undeletable_ids</span><span class="p">)</span>

        <span class="c1"># sort out which undeletable model data may have become deletable again because</span>
        <span class="c1"># of records being cascade-deleted or tables being dropped just above</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">undeletable_ids</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">res_id</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">savepoint</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="c1"># record exists therefore the data is still undeletable,</span>
                        <span class="c1"># remove it from module_data</span>
                        <span class="n">module_data</span> <span class="o">-=</span> <span class="n">data</span>
                        <span class="k">continue</span>
            <span class="k">except</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">:</span>
                <span class="c1"># This most likely means that the record does not exist, since record.exists()</span>
                <span class="c1"># is rougly equivalent to `SELECT id FROM table WHERE id=record.id` and it may raise</span>
                <span class="c1"># a ProgrammingError because the table no longer exists (and so does the</span>
                <span class="c1"># record), also applies to ir.model.fields, constraints, etc.</span>
                <span class="k">pass</span>
        <span class="c1"># remove remaining module data records</span>
        <span class="n">module_data</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_process_end_unlink_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="n">record</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_process_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modules</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Clear records removed from updated module data.</span>
<span class="sd">        This method is called at the end of the module loading process.</span>
<span class="sd">        It is meant to removed records that are no longer present in the</span>
<span class="sd">        updated data. Such records are recognised as the one with an xml id</span>
<span class="sd">        and a module in ir_model_data and noupdate set to false, but not</span>
<span class="sd">        present in self.pool.loaded_xmlids.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">modules</span> <span class="ow">or</span> <span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;import_partial&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">bad_imd_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">({</span><span class="n">MODULE_UNINSTALL_FLAG</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
        <span class="n">loaded_xmlids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">loaded_xmlids</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; SELECT id, module || &#39;.&#39; || name, model, res_id FROM ir_model_data</span>
<span class="s2">                    WHERE module IN </span><span class="si">%s</span><span class="s2"> AND res_id IS NOT NULL AND COALESCE(noupdate, false) != </span><span class="si">%s</span><span class="s2"> ORDER BY id DESC</span>
<span class="s2">                &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">modules</span><span class="p">),</span> <span class="kc">True</span><span class="p">))</span>
        <span class="k">for</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">xmlid</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">res_id</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">xmlid</span> <span class="ow">in</span> <span class="n">loaded_xmlids</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># when _inherits parents are implicitly created we give them an</span>
            <span class="c1"># external id (if their descendant has one) in order to e.g.</span>
            <span class="c1"># properly remove them when the module is deleted, however this</span>
            <span class="c1"># generated id is *not* provided during update yet we don&#39;t want to</span>
            <span class="c1"># try and remove either the xid or the record, so check if the</span>
            <span class="c1"># record has a child we&#39;ve just updated</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">inheriting</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">Model</span><span class="o">.</span><span class="n">_inherits_children</span><span class="p">):</span>
                <span class="c1"># ignore mixins</span>
                <span class="k">if</span> <span class="n">inheriting</span><span class="o">.</span><span class="n">_abstract</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">parent_field</span> <span class="o">=</span> <span class="n">inheriting</span><span class="o">.</span><span class="n">_inherits</span><span class="p">[</span><span class="n">model</span><span class="p">]</span>
                <span class="n">children</span> <span class="o">=</span> <span class="n">inheriting</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="n">parent_field</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">res_id</span><span class="p">)])</span>
                <span class="n">children_xids</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">xid</span>
                    <span class="k">for</span> <span class="n">xids</span> <span class="ow">in</span> <span class="p">(</span><span class="n">children</span> <span class="ow">and</span> <span class="n">children</span><span class="o">.</span><span class="n">_get_external_ids</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">xid</span> <span class="ow">in</span> <span class="n">xids</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="n">children_xids</span> <span class="o">&amp;</span> <span class="n">loaded_xmlids</span><span class="p">:</span>
                    <span class="c1"># at least one child was loaded</span>
                    <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">keep</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># if the record has other associated xids, only remove the xid</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_count</span><span class="p">([</span>
                <span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;res_id&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="n">res_id</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;!=&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;not in&quot;</span><span class="p">,</span> <span class="n">bad_imd_ids</span><span class="p">),</span>
            <span class="p">]):</span>
                <span class="n">bad_imd_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleting </span><span class="si">%s</span><span class="s1">@</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">res_id</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">xmlid</span><span class="p">)</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">res_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">xmlid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">record</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="n">module</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_end_unlink_record</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bad_imd_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bad_imd_ids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">bad_imd_ids</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="c1"># Once all views are created create specific ones</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_create_all_specific_views</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span>

        <span class="n">loaded_xmlids</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<div class="viewcode-block" id="IrModelData.toggle_noupdate">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.IrModelData.toggle_noupdate">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">toggle_noupdate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">res_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Toggle the noupdate flag on the external id of the record &quot;&quot;&quot;</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">res_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;write&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">xid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">model</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">res_id</span><span class="p">)]):</span>
                <span class="n">xid</span><span class="o">.</span><span class="n">noupdate</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">xid</span><span class="o">.</span><span class="n">noupdate</span></div>
</div>



<div class="viewcode-block" id="WizardModelMenu">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.WizardModelMenu">[docs]</a>
<span class="k">class</span> <span class="nc">WizardModelMenu</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">TransientModel</span><span class="p">):</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;wizard.ir.model.menu.create&#39;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s1">&#39;Create Menu Wizard&#39;</span>

    <span class="n">menu_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;ir.ui.menu&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Parent Menu&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;cascade&#39;</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Menu Name&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="WizardModelMenu.menu_create">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_model.WizardModelMenu.menu_create">[docs]</a>
    <span class="k">def</span> <span class="nf">menu_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">menu</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_id&#39;</span><span class="p">))</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">menu</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;res_model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="s1">&#39;view_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;tree,form&#39;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">action_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.actions.act_window&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.ui.menu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">menu</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="n">menu</span><span class="o">.</span><span class="n">menu_id</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.act_window,</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">action_id</span><span class="p">,)</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.act_window_close&#39;</span><span class="p">}</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Amr.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>