<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>odoo.addons.base.models.ir_qweb &mdash; Amr  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Amr
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modules.html">odoo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Amr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../../odoo.html">odoo</a></li>
          <li class="breadcrumb-item"><a href="../../base.html">odoo.addons.base</a></li>
      <li class="breadcrumb-item active">odoo.addons.base.models.ir_qweb</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for odoo.addons.base.models.ir_qweb</h1><div class="highlight"><pre>
<span></span><span class="c1"># Part of Odoo. See LICENSE file for full copyright and licensing details.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">================</span>
<span class="sd">IrQWeb / ir.qweb</span>
<span class="sd">================</span>

<span class="sd">Preamble</span>
<span class="sd">========</span>

<span class="sd">Technical documentation of the python operation of the rendering QWeb engine.</span>

<span class="sd">Templating</span>
<span class="sd">==========</span>

<span class="sd">QWeb is the primary templating engine used by Odoo. It is an XML templating</span>
<span class="sd">engine and used mostly to generate XML, HTML fragments and pages.</span>

<span class="sd">Template directives are specified as XML attributes prefixed with ``t-``,</span>
<span class="sd">for instance ``t-if`` for :ref:`reference/qweb/conditionals`, with elements</span>
<span class="sd">and other attributes being rendered directly.</span>

<span class="sd">To avoid element rendering, a placeholder element ``&lt;t&gt;`` is also available,</span>
<span class="sd">which executes its directive but doesn&#39;t generate any output in and of</span>
<span class="sd">itself.</span>

<span class="sd">To create new XML template, please see :doc:`QWeb Templates documentation</span>
<span class="sd">&lt;https://www.odoo.com/documentation/17.0/developer/reference/frontend/qweb.html&gt;`</span>

<span class="sd">Rendering process</span>
<span class="sd">=================</span>

<span class="sd">In **input** you have an XML template giving the corresponding input etree.</span>
<span class="sd">Each etree input nodes are used to generate a python function. This fonction is</span>
<span class="sd">called and will give the XML **output**.</span>
<span class="sd">The ``_compile`` method is responsible to generate the function from the</span>
<span class="sd">etree, that function is a python generator that yield one output line at a</span>
<span class="sd">time. This generator is consumed by ``_render``. The generated function is orm</span>
<span class="sd">cached.</span>

<span class="sd">For performance, the **compile time** (when input, XML template or template</span>
<span class="sd">id, is compiled into a function) is less important than the **rendering time**</span>
<span class="sd">(when the function is called with the different values). The generation of the</span>
<span class="sd">function is only done once (for a set of options, language, branding ...)</span>
<span class="sd">because it is cached orm</span>

<span class="sd">The output is in ``MarkupSafe`` format. ``MarkupSafe`` escapes characters so</span>
<span class="sd">text is safe to use in HTML and XML. Characters that have special meanings</span>
<span class="sd">are replaced so that they display as the actual characters. This mitigates</span>
<span class="sd">injection attacks, meaning untrusted user input can safely be displayed on a</span>
<span class="sd">page.</span>

<span class="sd">At **compile time**, each dynamic attribute ``t-*`` will be compiled into</span>
<span class="sd">specific python code. (For example ``&lt;t t-out=&quot;5 + 5&quot;/&gt;`` will insert the</span>
<span class="sd">template &quot;10&quot; inside the output)</span>

<span class="sd">At **compile time**, each directive removes the dynamic attribute it uses from</span>
<span class="sd">the input node attributes. At the end of the compilation each input node, no</span>
<span class="sd">dynamic attributes must remain.</span>

<span class="sd">How the code works</span>
<span class="sd">==================</span>

<span class="sd">In the graphic below you can see theresume of the call of the methods performed</span>
<span class="sd">in the IrQweb class.</span>

<span class="sd">.. code-block:: rst</span>

<span class="sd">    Odoo</span>
<span class="sd">     ┗━► _render (returns MarkupSafe)</span>
<span class="sd">        ┗━► _compile (returns function)                                        ◄━━━━━━━━━━┓</span>
<span class="sd">           ┗━► _compile_node (returns code string array)                       ◄━━━━━━━━┓ ┃</span>
<span class="sd">              ┃  (skip the current node if found t-qweb-skip)                           ┃ ┃</span>
<span class="sd">              ┃  (add technical directives: t-tag-open, t-tag-close, t-inner-content)   ┃ ┃</span>
<span class="sd">              ┃                                                                         ┃ ┃</span>
<span class="sd">              ┣━► _directives_eval_order (defined directive order)                      ┃ ┃</span>
<span class="sd">              ┣━► _compile_directives (loop)    Consume all remaining directives ◄━━━┓  ┃ ┃</span>
<span class="sd">              ┃  ┃                              (e.g.: to change the indentation)    ┃  ┃ ┃</span>
<span class="sd">              ┃  ┣━► _compile_directive                                              ┃  ┃ ┃</span>
<span class="sd">              ┃  ┃    ┗━► t-nocache       ━━► _compile_directive_nocache            ━┫  ┃ ┃</span>
<span class="sd">              ┃  ┃    ┗━► t-cache         ━━► _compile_directive_cache              ━┫  ┃ ┃</span>
<span class="sd">              ┃  ┃    ┗━► t-groups        ━━► _compile_directive_groups             ━┫  ┃ ┃</span>
<span class="sd">              ┃  ┃    ┗━► t-foreach       ━━► _compile_directive_foreach            ━┫  ┃ ┃</span>
<span class="sd">              ┃  ┃    ┗━► t-if            ━━► _compile_directive_if                 ━┛  ┃ ┃</span>
<span class="sd">              ┃  ┃    ┗━► t-inner-content ━━► _compile_directive_inner_content ◄━━━━━┓ ━┛ ┃</span>
<span class="sd">              ┃  ┃    ┗━► t-options       ━━► _compile_directive_options             ┃    ┃</span>
<span class="sd">              ┃  ┃    ┗━► t-set           ━━► _compile_directive_set           ◄━━┓  ┃    ┃</span>
<span class="sd">              ┃  ┃    ┗━► t-call          ━━► _compile_directive_call            ━┛ ━┫ ━━━┛</span>
<span class="sd">              ┃  ┃    ┗━► t-att           ━━► _compile_directive_att                 ┃</span>
<span class="sd">              ┃  ┃    ┗━► t-tag-open      ━━► _compile_directive_open          ◄━━┓  ┃</span>
<span class="sd">              ┃  ┃    ┗━► t-tag-close     ━━► _compile_directive_close         ◄━━┫  ┃</span>
<span class="sd">              ┃  ┃    ┗━► t-out           ━━► _compile_directive_out             ━┛ ━┫ ◄━━┓</span>
<span class="sd">              ┃  ┃    ┗━► t-field         ━━► _compile_directive_field               ┃   ━┫</span>
<span class="sd">              ┃  ┃    ┗━► t-esc           ━━► _compile_directive_esc                 ┃   ━┛</span>
<span class="sd">              ┃  ┃    ┗━► t-*             ━━► ...                                    ┃</span>
<span class="sd">              ┃  ┃                                                                   ┃</span>
<span class="sd">              ┗━━┻━► _compile_static_node                                           ━┛</span>


<span class="sd">The QWeb ``_render`` uses the function generated by the ``_compile`` method.</span>
<span class="sd">Each XML node will go through the ``_compile_node`` method. If the</span>
<span class="sd">node does not have dynamic directives or attributes (``_is_static_node``).</span>
<span class="sd">A ``static`` is a node without ``t-*`` attributes, does not require dynamic</span>
<span class="sd">rendering for its attributes.</span>
<span class="sd">If it&#39;s a ``static`` node, the ``_compile_static_node`` method is called,</span>
<span class="sd">otherwise it is the ``_compile_directives`` method after having prepared the</span>
<span class="sd">order for calling the directives using the ``_directives_eval_order`` method.</span>
<span class="sd">In the defined order, for each directive the method ``_compile_directive`` is</span>
<span class="sd">called which itself dispatches to the methods corresponding to the directives</span>
<span class="sd">``_compile_directive_[name of the directive]`` (for example: ``t-if`` =&gt;</span>
<span class="sd">``_compile_directive_if``). After all ordered directives, the directives</span>
<span class="sd">attributes still present on the element are compiled.</span>

<span class="sd">The ``_post_processing_att`` method is used for the generation of rendering</span>
<span class="sd">attributes. If the attributes come from static XML template nodes then the</span>
<span class="sd">method is called only once when generating the render function. Otherwise the</span>
<span class="sd">method is called during each rendering.</span>

<span class="sd">Each expression is compiled by the method ``_compile_expr`` into a python</span>
<span class="sd">expression whose values are namespaced.</span>

<span class="sd">Directives</span>
<span class="sd">----------</span>

<span class="sd">``t-debug``</span>
<span class="sd">~~~~~~~~~~~</span>
<span class="sd">**Values**: `&#39;&#39;` (empty string), ``pdb``, ``ipdb``, ``pudb``, ``wdb``</span>

<span class="sd">Triggers a debugger breakpoint at that location. With an empty value, calls the</span>
<span class="sd">``breakpoint`` builtin invoking whichever breakpoint hook has been set up,</span>
<span class="sd">otherwise triggers a breakpoint uses the corresponding debugger.</span>

<span class="sd">When dev mode is enabled this allows python developers to have access to the</span>
<span class="sd">state of variables being rendered. The code generated by the QWeb engine is</span>
<span class="sd">not accessible, only the variables (values, self) can be analyzed or the</span>
<span class="sd">methods that called the QWeb rendering.</span>

<span class="sd">.. warning:: using a non-empty string is deprecated since 17.0, configure your</span>
<span class="sd">             preferred debugger via ``PYTHONBREAKPOINT`` or</span>
<span class="sd">             ``sys.setbreakpointhook``.</span>

<span class="sd">``t-if``</span>
<span class="sd">~~~~~~~~</span>
<span class="sd">**Values**: python expression</span>


<span class="sd">Add an python ``if`` condition to the code string array, and call</span>
<span class="sd">``_compile_directives`` to level and add the code string array corresponding</span>
<span class="sd">to the other directives and content.</span>

<span class="sd">The structure of the dom is checked to possibly find a ``t-else`` or</span>
<span class="sd">``t-elif``. If these directives exist then the compilation is performed and</span>
<span class="sd">the nodes are marked not to be rendered twice.</span>

<span class="sd">At **rendering time** the other directives code and content will used only if</span>
<span class="sd">the expression is evaluated as truely.</span>

<span class="sd">The ``t-else``, ``t-elif`` and ``t-if`` are not compiled at the same time like</span>
<span class="sd">defined in ``_directives_eval_order`` method.</span>
<span class="sd">```</span>
<span class="sd">&lt;t t-set=&quot;check&quot; t-value=&quot;1&quot;/&gt;</span>
<span class="sd">&lt;section t-if=&quot;False&quot;&gt;10&lt;/section&gt;</span>
<span class="sd">&lt;span t-elif=&quot;check == 1&quot; t-foreach=&quot;range(3)&quot; t-as=&quot;check&quot; t-esc=&quot;check&quot;/&gt;</span>

<span class="sd">&lt;section t-if=&quot;False&quot;&gt;10&lt;/section&gt;</span>
<span class="sd">&lt;div t-else=&quot;&quot; t-if=&quot;check == 1&quot; t-foreach=&quot;range(3)&quot; t-as=&quot;check&quot; t-esc=&quot;check&quot;/&gt;</span>

<span class="sd">Result:</span>

<span class="sd">&lt;span&gt;0&lt;/span&gt;</span>
<span class="sd">&lt;span&gt;1&lt;/span&gt;</span>
<span class="sd">&lt;span&gt;2&lt;/span&gt;</span>

<span class="sd">&lt;div&gt;1&lt;/div&gt;</span>
<span class="sd">```</span>

<span class="sd">``t-else``</span>
<span class="sd">~~~~~~~~~~</span>
<span class="sd">**Values**: nothing</span>

<span class="sd">Only validate the **input**, the compilation if inside the ``t-if`` directive.</span>

<span class="sd">``t-elif``</span>
<span class="sd">~~~~~~~~~~</span>
<span class="sd">**Values**: python expression</span>

<span class="sd">Only validate the **input**, the compilation if inside the ``t-if`` directive.</span>

<span class="sd">``t-groups`` (``groups`` is an alias)</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="sd">**Values**: name of the allowed odoo user group, or preceded by ``!`` for</span>
<span class="sd">prohibited groups</span>

<span class="sd">The generated code uses ``user_has_groups`` Odoo method.</span>

<span class="sd">``t-foreach``</span>
<span class="sd">~~~~~~~~~~~~~</span>
<span class="sd">**Values**: an expression returning the collection to iterate on</span>

<span class="sd">This directive is used with ``t-as`` directive to defined the key name. The</span>
<span class="sd">directive will be converted into a ``for`` loop. In this loop, different values</span>
<span class="sd">are added to the dict (``values`` in the generated method) in addition to the</span>
<span class="sd">key defined by ``t-name``, these are (``*_value``, ``*_index``, ``*_size``,</span>
<span class="sd">``*_first``, ``*_last``).</span>

<span class="sd">``t-as``</span>
<span class="sd">~~~~~~~~</span>
<span class="sd">**Values**: key name</span>

<span class="sd">The compilation method only validates if ``t-as`` and ``t-foreach`` are on the</span>
<span class="sd">same node.</span>

<span class="sd">``t-options`` and ``t-options-*``</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="sd">**Values**: python expression</span>

<span class="sd">It&#39;s use on the same node of another directive, it&#39;s used to configure the</span>
<span class="sd">other directive. Used on the same ``input node`` of the directives ``t-call``,</span>
<span class="sd">``t-field`` or ``t-out``.</span>

<span class="sd">Create a ``values[&#39;__qweb_options__&#39;]`` dict from the optional ``t-options``</span>
<span class="sd">expression and add each key-value ``t-options-key=&quot;expression value&quot;`` to this</span>
<span class="sd">dict. (for example: ``t-options=&quot;{&#39;widget&#39;: &#39;float&#39;}&quot;`` is equal to</span>
<span class="sd">``t-options-widget=&quot;&#39;float&#39;&quot;``)</span>

<span class="sd">``t-att``, ``t-att-*`` and ``t-attf-*``</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="sd">**Values**: python expression (or format string expression for ``t-attf-``)</span>

<span class="sd">Compile the attributes to create ``values[&#39;__qweb_attrs__&#39;]`` dictionary code</span>
<span class="sd">in the compiled function. Use the ``t-att`` expression and add each key-value</span>
<span class="sd">``t-att-key=&quot;expression value&quot;`` to this dict. (for example:</span>
<span class="sd">``t-att=&quot;{&#39;class&#39;: f&#39;float_{1}&#39;}&quot;`` is equal to ``t-att-class=&quot;f&#39;float_{1}&#39;&quot;``</span>
<span class="sd">and is equal to ``t-attf-class=&quot;float_{{1}}&quot;)</span>

<span class="sd">The attributes come from new namespaces, static elements (not preceded</span>
<span class="sd">by ``t-``) and dynamic attributes ``t-att``, attributes prefixed by ``t-att-``</span>
<span class="sd">(python expression) or ``t-attf`` (format string expression).</span>

<span class="sd">``t-call``</span>
<span class="sd">~~~~~~~~~~</span>
<span class="sd">**Values**: format string expression for template name</span>

<span class="sd">Serves the called template in place of the current ``t-call`` node.</span>

<span class="sd">Here are the different steps performed by the generated python code:</span>

<span class="sd">#. copy the ``values`` dictionary;</span>
<span class="sd">#. render the content (``_compile_directive_inner_content``) of the tag in a</span>
<span class="sd">   separate method called with the previous copied values. This values can be</span>
<span class="sd">   updated via t-set. The visible content of the rendering of the sub-content</span>
<span class="sd">   is added as a magical value ``0`` (can be rendered with ``t-out=&quot;0&quot;``);</span>
<span class="sd">#. copy the ``compile_context`` dictionary;</span>
<span class="sd">#. compile the directive ``t-options`` and update the ``compile_context``</span>
<span class="sd">    are, in added to the calling template and the ``nsmap`` values;</span>
<span class="sd">#. get the compiled function from the ``_compile`` method;</span>
<span class="sd">#. use the compiled function to serves the called template.</span>

<span class="sd">``t-lang``</span>
<span class="sd">~~~~~~~~~~</span>
<span class="sd">**Values**: python expression</span>

<span class="sd">Used to serve the called template (``t-call``) in another language. Used</span>
<span class="sd">together with ``t-call``.</span>

<span class="sd">This directive will be evaluate like ``t-options-lang``. Allows you to change</span>
<span class="sd">the language in which the called template is rendered. It&#39;s in the ``t-call``</span>
<span class="sd">directive that the language of the context of the ``ir.qweb`` recordset on</span>
<span class="sd">which the ``_compile`` function is called is updated.</span>

<span class="sd">``t-call-assets``</span>
<span class="sd">~~~~~~~~~~~~~~~~~</span>
<span class="sd">**Values**: format string for template name</span>

<span class="sd">The generated code call the ``_get_asset_nodes`` method to get the list of</span>
<span class="sd">(tagName, attrs and content). From each tuple a tag is created into the</span>
<span class="sd">rendering.</span>

<span class="sd">``t-out``</span>
<span class="sd">~~~~~~~~~</span>
<span class="sd">**Values**: python expression</span>

<span class="sd">Output the given value or if falsy, display the content as default value.</span>
<span class="sd">(for example: ``&lt;t t-out=&quot;given_value&quot;&gt;Default content&lt;/t&gt;``)</span>

<span class="sd">The generated code add the value into the ``MarkupSafe`` rendering.</span>
<span class="sd">If a widget is defined (``t-options-widget``), the generated code call the</span>
<span class="sd">``_get_widget`` method to have the formatted field value and attributes. It&#39;s</span>
<span class="sd">the ``ir.qweb.field.*`` models that format the value.</span>

<span class="sd">``t-field``</span>
<span class="sd">~~~~~~~~~~~</span>
<span class="sd">**Values**: String representing the path to the field. (for example:</span>
<span class="sd">``t-field=&quot;record.name&quot;``)</span>

<span class="sd">Output the field value or if falsy, display the content as default value.</span>
<span class="sd">(for example: ``&lt;span t-field=&quot;record.name&quot;&gt;Default content&lt;/span&gt;``)</span>

<span class="sd">Use ``t-out`` compile method but the generated code call ``_get_field``</span>
<span class="sd">instead of ``_get_widget``. It&#39;s the ``ir.qweb.field.*`` models that format</span>
<span class="sd">the value. The rendering model is chosen according to the type of field. The</span>
<span class="sd">rendering model can be modified via the ``t-options-widget``.</span>

<span class="sd">``t-esc``</span>
<span class="sd">~~~~~~~~~</span>
<span class="sd">Deprecated, please use ``t-out``</span>

<span class="sd">``t-raw``</span>
<span class="sd">~~~~~~~~~</span>
<span class="sd">Deprecated, please use ``t-out``</span>

<span class="sd">``t-set``</span>
<span class="sd">~~~~~~~~~</span>
<span class="sd">**Values**: key name</span>

<span class="sd">The generated code update the key ``values`` dictionary equal to the value</span>
<span class="sd">defined by ``t-value`` expression, ``t-valuef`` format string expression or</span>
<span class="sd">to the ``MarkupSafe`` rendering come from the content of the node.</span>

<span class="sd">``t-value``</span>
<span class="sd">~~~~~~~~~~~</span>
<span class="sd">**Values**: python expression</span>

<span class="sd">The compilation method only validates if ``t-value`` and ``t-set`` are on the</span>
<span class="sd">same node.</span>

<span class="sd">``t-valuef``</span>
<span class="sd">~~~~~~~~~~~~</span>
<span class="sd">**Values**: format string expression</span>

<span class="sd">The compilation method only validates if ``t-valuef`` and ``t-set`` are on the</span>
<span class="sd">same node.</span>

<span class="sd">Technical directives</span>
<span class="sd">--------------------</span>

<span class="sd">Directive added automatically by IrQweb in order to go through the compilation</span>
<span class="sd">methods.</span>

<span class="sd">``t-tag-open``</span>
<span class="sd">~~~~~~~~~~~~~~</span>
<span class="sd">Used to generate the opening HTML/XML tags.</span>

<span class="sd">``t-tag-close``</span>
<span class="sd">~~~~~~~~~~~~~~</span>
<span class="sd">Used to generate the closing HTML/XML tags.</span>

<span class="sd">``t-inner-content``</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~</span>
<span class="sd">Used to add the content of the node (text, tail and children nodes).</span>
<span class="sd">If namespaces are declared on the current element then a copy of the options</span>
<span class="sd">is made.</span>

<span class="sd">``t-consumed-options``</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="sd">Raise an exception if the ``t-options`` is not consumed.</span>

<span class="sd">``t-qweb-skip``</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="sd">Ignore rendering and directives for the curent **input** node.</span>

<span class="sd">``t-else-valid``</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="sd">Mark a node with ``t-else`` or ``t-elif`` having a valid **input** dom</span>
<span class="sd">structure.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">token</span>
<span class="kn">import</span> <span class="nn">tokenize</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">werkzeug</span>

<span class="kn">from</span> <span class="nn">markupsafe</span> <span class="kn">import</span> <span class="n">Markup</span><span class="p">,</span> <span class="n">escape</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Sized</span><span class="p">,</span> <span class="n">Mapping</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">count</span><span class="p">,</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
<span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="kn">import</span> <span class="n">relativedelta</span>
<span class="kn">from</span> <span class="nn">psycopg2.extensions</span> <span class="kn">import</span> <span class="n">TransactionRollbackError</span>

<span class="kn">from</span> <span class="nn">odoo</span> <span class="kn">import</span> <span class="n">api</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">tools</span>
<span class="kn">from</span> <span class="nn">odoo.modules</span> <span class="kn">import</span> <span class="n">registry</span>
<span class="kn">from</span> <span class="nn">odoo.tools</span> <span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">safe_eval</span><span class="p">,</span> <span class="n">pycompat</span>
<span class="kn">from</span> <span class="nn">odoo.tools.constants</span> <span class="kn">import</span> <span class="n">SUPPORTED_DEBUGGER</span><span class="p">,</span> <span class="n">EXTERNAL_ASSET</span>
<span class="kn">from</span> <span class="nn">odoo.tools.safe_eval</span> <span class="kn">import</span> <span class="n">assert_valid_codeobj</span><span class="p">,</span> <span class="n">_BUILTINS</span><span class="p">,</span> <span class="n">to_opcodes</span><span class="p">,</span> <span class="n">_EXPR_OPCODES</span><span class="p">,</span> <span class="n">_BLACKLIST</span>
<span class="kn">from</span> <span class="nn">odoo.tools.json</span> <span class="kn">import</span> <span class="n">scriptsafe</span>
<span class="kn">from</span> <span class="nn">odoo.tools.lru</span> <span class="kn">import</span> <span class="n">LRU</span>
<span class="kn">from</span> <span class="nn">odoo.tools.misc</span> <span class="kn">import</span> <span class="n">str2bool</span>
<span class="kn">from</span> <span class="nn">odoo.tools.image</span> <span class="kn">import</span> <span class="n">image_data_uri</span><span class="p">,</span> <span class="n">FILETYPE_BASE64_MAGICWORD</span>
<span class="kn">from</span> <span class="nn">odoo.http</span> <span class="kn">import</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">odoo.tools.profiler</span> <span class="kn">import</span> <span class="n">QwebTracker</span>
<span class="kn">from</span> <span class="nn">odoo.exceptions</span> <span class="kn">import</span> <span class="n">UserError</span><span class="p">,</span> <span class="n">AccessDenied</span><span class="p">,</span> <span class="n">AccessError</span><span class="p">,</span> <span class="n">MissingError</span><span class="p">,</span> <span class="n">ValidationError</span>

<span class="kn">from</span> <span class="nn">odoo.addons.base.models.assetsbundle</span> <span class="kn">import</span> <span class="n">AssetsBundle</span>
<span class="kn">from</span> <span class="nn">odoo.tools.constants</span> <span class="kn">import</span> <span class="n">SCRIPT_EXTENSIONS</span><span class="p">,</span> <span class="n">STYLE_EXTENSIONS</span><span class="p">,</span> <span class="n">TEMPLATE_EXTENSIONS</span>

<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># QWeb token usefull for generate expression used in `_compile_expr_tokens` method</span>
<span class="n">token</span><span class="o">.</span><span class="n">QWEB</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">NT_OFFSET</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">token</span><span class="o">.</span><span class="n">tok_name</span><span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">QWEB</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;QWEB&#39;</span>


<span class="c1"># security safe eval opcodes for generated expression validation, used in `_compile_expr`</span>
<span class="n">_SAFE_QWEB_OPCODES</span> <span class="o">=</span> <span class="n">_EXPR_OPCODES</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">to_opcodes</span><span class="p">([</span>
    <span class="s1">&#39;MAKE_FUNCTION&#39;</span><span class="p">,</span> <span class="s1">&#39;CALL_FUNCTION&#39;</span><span class="p">,</span> <span class="s1">&#39;CALL_FUNCTION_KW&#39;</span><span class="p">,</span> <span class="s1">&#39;CALL_FUNCTION_EX&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CALL_METHOD&#39;</span><span class="p">,</span> <span class="s1">&#39;LOAD_METHOD&#39;</span><span class="p">,</span>

    <span class="s1">&#39;GET_ITER&#39;</span><span class="p">,</span> <span class="s1">&#39;FOR_ITER&#39;</span><span class="p">,</span> <span class="s1">&#39;YIELD_VALUE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;JUMP_FORWARD&#39;</span><span class="p">,</span> <span class="s1">&#39;JUMP_ABSOLUTE&#39;</span><span class="p">,</span> <span class="s1">&#39;JUMP_BACKWARD&#39;</span><span class="p">,</span>
    <span class="s1">&#39;JUMP_IF_FALSE_OR_POP&#39;</span><span class="p">,</span> <span class="s1">&#39;JUMP_IF_TRUE_OR_POP&#39;</span><span class="p">,</span> <span class="s1">&#39;POP_JUMP_IF_FALSE&#39;</span><span class="p">,</span> <span class="s1">&#39;POP_JUMP_IF_TRUE&#39;</span><span class="p">,</span>

    <span class="s1">&#39;LOAD_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;LOAD_ATTR&#39;</span><span class="p">,</span>
    <span class="s1">&#39;LOAD_FAST&#39;</span><span class="p">,</span> <span class="s1">&#39;STORE_FAST&#39;</span><span class="p">,</span> <span class="s1">&#39;UNPACK_SEQUENCE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;STORE_SUBSCR&#39;</span><span class="p">,</span>
    <span class="s1">&#39;LOAD_GLOBAL&#39;</span><span class="p">,</span>
    <span class="c1"># Following opcodes were added in 3.11 https://docs.python.org/3/whatsnew/3.11.html#new-opcodes</span>
    <span class="s1">&#39;RESUME&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CALL&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PRECALL&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PUSH_NULL&#39;</span><span class="p">,</span>
    <span class="s1">&#39;KW_NAMES&#39;</span><span class="p">,</span>
    <span class="s1">&#39;FORMAT_VALUE&#39;</span><span class="p">,</span> <span class="s1">&#39;BUILD_STRING&#39;</span><span class="p">,</span>
    <span class="s1">&#39;RETURN_GENERATOR&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SWAP&#39;</span><span class="p">,</span>
    <span class="s1">&#39;POP_JUMP_FORWARD_IF_FALSE&#39;</span><span class="p">,</span> <span class="s1">&#39;POP_JUMP_FORWARD_IF_TRUE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;POP_JUMP_BACKWARD_IF_FALSE&#39;</span><span class="p">,</span> <span class="s1">&#39;POP_JUMP_BACKWARD_IF_TRUE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;POP_JUMP_FORWARD_IF_NONE&#39;</span><span class="p">,</span> <span class="s1">&#39;POP_JUMP_FORWARD_IF_NOT_NONE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;POP_JUMP_BACKWARD_IF_NONE&#39;</span><span class="p">,</span> <span class="s1">&#39;POP_JUMP_BACKWARD_IF_NOT_NONE&#39;</span><span class="p">,</span>
<span class="p">]))</span> <span class="o">-</span> <span class="n">_BLACKLIST</span>


<span class="c1"># eval to compile generated string python code into binary code, used in `_compile`</span>
<span class="n">unsafe_eval</span> <span class="o">=</span> <span class="nb">eval</span>


<span class="n">VOID_ELEMENTS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span>
    <span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="s1">&#39;br&#39;</span><span class="p">,</span> <span class="s1">&#39;col&#39;</span><span class="p">,</span> <span class="s1">&#39;embed&#39;</span><span class="p">,</span> <span class="s1">&#39;hr&#39;</span><span class="p">,</span> <span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;keygen&#39;</span><span class="p">,</span>
    <span class="s1">&#39;link&#39;</span><span class="p">,</span> <span class="s1">&#39;menuitem&#39;</span><span class="p">,</span> <span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;track&#39;</span><span class="p">,</span> <span class="s1">&#39;wbr&#39;</span><span class="p">])</span>
<span class="c1"># Terms allowed in addition to AVAILABLE_OBJECTS when compiling python expressions</span>
<span class="n">ALLOWED_KEYWORD</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s1">&#39;False&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">,</span> <span class="s1">&#39;and&#39;</span><span class="p">,</span> <span class="s1">&#39;as&#39;</span><span class="p">,</span> <span class="s1">&#39;elif&#39;</span><span class="p">,</span> <span class="s1">&#39;else&#39;</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="s1">&#39;if&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="s1">&#39;not&#39;</span><span class="p">,</span> <span class="s1">&#39;or&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">_BUILTINS</span><span class="p">))</span>
<span class="c1"># regexpr for string formatting and extract ( ruby-style )|( jinja-style  ) used in `_compile_format`</span>
<span class="n">FORMAT_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?:#\{(.+?)\})|(?:\{\{(.+?)\}\})&#39;</span><span class="p">)</span>
<span class="n">RSTRIP_REGEXP</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\n[ \t]*$&#39;</span><span class="p">)</span>
<span class="n">LSTRIP_REGEXP</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[ \t]*\n&#39;</span><span class="p">)</span>
<span class="n">FIRST_RSTRIP_REGEXP</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(\n[ \t]*)+(\n[ \t])&#39;</span><span class="p">)</span>
<span class="n">VARNAME_REGEXP</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[A-Za-z_][A-Za-z0-9_]*$&#39;</span><span class="p">)</span>
<span class="n">TO_VARNAME_REGEXP</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^A-Za-z0-9_]+&#39;</span><span class="p">)</span>
<span class="c1"># Attribute name used outside the context of the QWeb.</span>
<span class="n">SPECIAL_DIRECTIVES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;t-translation&#39;</span><span class="p">,</span> <span class="s1">&#39;t-ignore&#39;</span><span class="p">,</span> <span class="s1">&#39;t-title&#39;</span><span class="p">}</span>
<span class="c1"># Name of the variable to insert the content in t-call in the template.</span>
<span class="c1"># The slot will be replaced by the `t-call` tag content of the caller.</span>
<span class="n">T_CALL_SLOT</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>


<div class="viewcode-block" id="indent_code">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_qweb.indent_code">[docs]</a>
<span class="k">def</span> <span class="nf">indent_code</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Indent the code to respect the python syntax.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">level</span><span class="p">)</span></div>



<div class="viewcode-block" id="keep_query">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_qweb.keep_query">[docs]</a>
<span class="k">def</span> <span class="nf">keep_query</span><span class="p">(</span><span class="o">*</span><span class="n">keep_params</span><span class="p">,</span> <span class="o">**</span><span class="n">additional_params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a query string keeping the current request querystring&#39;s parameters specified</span>
<span class="sd">    in ``keep_params`` and also adds the parameters specified in ``additional_params``.</span>

<span class="sd">    Multiple values query string params will be merged into a single one with comma seperated</span>
<span class="sd">    values.</span>

<span class="sd">    The ``keep_params`` arguments can use wildcards too, eg:</span>

<span class="sd">        keep_query(&#39;search&#39;, &#39;shop_*&#39;, page=4)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_params</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">additional_params</span><span class="p">:</span>
        <span class="n">keep_params</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">additional_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">qs_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="n">request</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">keep_param</span> <span class="ow">in</span> <span class="n">keep_params</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">qs_keys</span><span class="p">,</span> <span class="n">keep_param</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">additional_params</span> <span class="ow">and</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">qs_keys</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">url_encode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span></div>


<span class="c1">####################################</span>
<span class="c1">###        QWebException         ###</span>
<span class="c1">####################################</span>

<div class="viewcode-block" id="QWebException">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_qweb.QWebException">[docs]</a>
<span class="k">class</span> <span class="nc">QWebException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Management of errors that raised when rendering a QWeb template.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">qweb</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path_xml</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">html</span> <span class="o">=</span> <span class="n">path_xml</span> <span class="ow">or</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">code</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="n">qweb</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dev_mode&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">line_nb</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">error_line</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)):</span>
                <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;File &quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="si">}</span><span class="s1">&gt;&quot;&#39;</span> <span class="ow">in</span> <span class="n">error_line</span><span class="p">:</span>
                    <span class="n">line_function</span> <span class="o">=</span> <span class="n">error_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, line &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">line_nb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line_function</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">break</span>
            <span class="k">for</span> <span class="n">code_line</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[:</span><span class="n">line_nb</span><span class="p">]):</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s*# element: (.*) , (.*)&#39;</span><span class="p">,</span> <span class="n">code_line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">match</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">html</span> <span class="o">=</span> <span class="n">match</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">message</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cause__</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__cause__</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__cause__</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__cause__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__context__</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__context__</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__context__</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__context__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Template: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Path: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">html</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Node: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">html</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Compiled code:</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;QWebException(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="si">!r}</span><span class="s2">)&quot;</span></div>


<span class="c1">####################################</span>
<span class="c1">###             QWeb             ###</span>
<span class="c1">####################################</span>


<div class="viewcode-block" id="IrQWeb">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_qweb.IrQWeb">[docs]</a>
<span class="k">class</span> <span class="nc">IrQWeb</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">AbstractModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Base QWeb rendering engine</span>
<span class="sd">    * to customize ``t-field`` rendering, subclass ``ir.qweb.field`` and</span>
<span class="sd">      create new models called :samp:`ir.qweb.field.{widget}`</span>
<span class="sd">    Beware that if you need extensions or alterations which could be</span>
<span class="sd">    incompatible with other subsystems, you should create a local object</span>
<span class="sd">    inheriting from ``ir.qweb`` and customize that.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;ir.qweb&#39;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s1">&#39;Qweb&#39;</span>

    <span class="nd">@QwebTracker</span><span class="o">.</span><span class="n">wrap_render</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; render(template, values, **options)</span>

<span class="sd">        Render the template specified by the given name.</span>

<span class="sd">        :param template: etree, xml_id, template name (see _get_template)</span>
<span class="sd">            * Call the method ``load`` is not an etree.</span>
<span class="sd">        :param dict values: template values to be used for rendering</span>
<span class="sd">        :param options: used to compile the template</span>
<span class="sd">            Options will be add into the IrQweb.env.context for the rendering.</span>
<span class="sd">            * ``lang`` (str) used language to render the template</span>
<span class="sd">            * ``inherit_branding`` (bool) add the tag node branding</span>
<span class="sd">            * ``inherit_branding_auto`` (bool) add the branding on fields</span>
<span class="sd">            * ``minimal_qcontext``(bool) To use the minimum context and options</span>
<span class="sd">                from ``_prepare_environment``</span>

<span class="sd">        :returns: bytes marked as markup-safe (decode to :class:`markupsafe.Markup`</span>
<span class="sd">                  instead of `str`)</span>
<span class="sd">        :rtype: MarkupSafe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">values</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">T_CALL_SLOT</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;values[</span><span class="si">{</span><span class="n">T_CALL_SLOT</span><span class="si">}</span><span class="s1">] should be unset when call the _render method and only set into the template.&#39;</span><span class="p">)</span>

        <span class="n">irQweb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span><span class="o">.</span><span class="n">_prepare_environment</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

        <span class="n">safe_eval</span><span class="o">.</span><span class="n">check_values</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

        <span class="n">template_functions</span><span class="p">,</span> <span class="n">def_name</span> <span class="o">=</span> <span class="n">irQweb</span><span class="o">.</span><span class="n">_compile</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
        <span class="n">render_template</span> <span class="o">=</span> <span class="n">template_functions</span><span class="p">[</span><span class="n">def_name</span><span class="p">]</span>
        <span class="n">rendering</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">irQweb</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rendering</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Markup</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="c1"># assume cache will be invalidated by third party on write to ir.ui.view</span>
    <span class="k">def</span> <span class="nf">_get_template_cache_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the list of context keys to use for caching ``_compile``. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;lang&#39;</span><span class="p">,</span> <span class="s1">&#39;inherit_branding&#39;</span><span class="p">,</span> <span class="s1">&#39;inherit_branding_auto&#39;</span><span class="p">,</span> <span class="s1">&#39;edit_translations&#39;</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">]</span>

    <span class="nd">@tools</span><span class="o">.</span><span class="n">conditional</span><span class="p">(</span>
        <span class="s1">&#39;xml&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dev_mode&#39;</span><span class="p">],</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">ormcache</span><span class="p">(</span><span class="s1">&#39;template&#39;</span><span class="p">,</span> <span class="s1">&#39;tuple(self.env.context.get(k) for k in self._get_template_cache_keys())&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="s1">&#39;templates&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_view_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">load_all_views</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">_get_view_id</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@QwebTracker</span><span class="o">.</span><span class="n">wrap_compile</span>
    <span class="k">def</span> <span class="nf">_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">etree</span><span class="o">.</span><span class="n">_Element</span><span class="p">):</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">is_t_cache_disabled</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_view_id</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>

        <span class="c1"># define the base key cache for code in cache and t-cache feature</span>
        <span class="n">base_key_cache</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">ref</span><span class="p">:</span>
            <span class="n">base_key_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cache_key</span><span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="n">ref</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_template_cache_keys</span><span class="p">()]))</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">__qweb_base_key_cache</span><span class="o">=</span><span class="n">base_key_cache</span><span class="p">)</span>

        <span class="c1"># generate the template functions and the root function name</span>
        <span class="k">def</span> <span class="nf">generate_functions</span><span class="p">():</span>
            <span class="n">code</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">def_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_code</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">):</span>
                <span class="n">ref_value</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="n">ref_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ref&#39;</span><span class="p">))</span>
                <span class="n">profile_options</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;ref&#39;</span><span class="p">:</span> <span class="n">ref_value</span><span class="p">,</span>
                    <span class="s1">&#39;ref_xml&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ref_xml&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;ref_xml&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">profile_options</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="s2">&quot;def generate_functions():&quot;</span><span class="p">,</span>
                <span class="s2">&quot;    template_functions = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">indent_code</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="sa">f</span><span class="s2">&quot;    template_functions[&#39;options&#39;] = </span><span class="si">{</span><span class="n">profile_options</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;    return template_functions&quot;</span><span class="p">,</span>
            <span class="p">])</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">compiled</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
                <span class="n">globals_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__prepare_globals</span><span class="p">()</span>
                <span class="n">globals_dict</span><span class="p">[</span><span class="s1">&#39;__builtins__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">globals_dict</span> <span class="c1"># So that unknown/unsafe builtins are never added.</span>
                <span class="n">unsafe_eval</span><span class="p">(</span><span class="n">compiled</span><span class="p">,</span> <span class="n">globals_dict</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">globals_dict</span><span class="p">[</span><span class="s1">&#39;generate_functions&#39;</span><span class="p">](),</span> <span class="n">def_name</span>
            <span class="k">except</span> <span class="n">QWebException</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">QWebException</span><span class="p">(</span><span class="s2">&quot;Error when compiling xml template&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_values</span><span class="p">(</span><span class="n">base_key_cache</span><span class="p">,</span> <span class="n">generate_functions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_generate_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Compile the given template into a rendering function (generator)::</span>

<span class="sd">            render_template(qweb, values)</span>
<span class="sd">            This method can be called only by the IrQweb `_render` method or by</span>
<span class="sd">            the compiled code of t-call from an other template.</span>

<span class="sd">            An `options` dictionary is created and attached to the function. It</span>
<span class="sd">            contains rendering options that are part of the cache key in</span>
<span class="sd">            addition to template references.</span>

<span class="sd">            where ``qweb`` is a QWeb instance and ``values`` are the values to</span>
<span class="sd">            render.</span>

<span class="sd">            :returns: tuple containing code, options and main method name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The `compile_context`` dictionary includes the elements used for the</span>
        <span class="c1"># cache key to which are added the template references as well as</span>
        <span class="c1"># technical information useful for generating the function. This</span>
        <span class="c1"># dictionary is only used when compiling the template.</span>
        <span class="n">compile_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">element</span><span class="p">,</span> <span class="n">document</span><span class="p">,</span> <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_template</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">UserError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># return the error function if the template is not found or fail</span>
            <span class="n">message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                def not_found_template(self, values):</span>
<span class="s2">                    if self.env.context.get(&#39;raise_if_not_found&#39;, True):</span>
<span class="s2">                        raise </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">message</span><span class="si">!r}</span><span class="s2">)</span>
<span class="s2">                    warning(&#39;Cannot load template %s: %s&#39;, </span><span class="si">{</span><span class="n">template</span><span class="si">!r}</span><span class="s2">, </span><span class="si">{</span><span class="n">message</span><span class="si">!r}</span><span class="s2">)</span>
<span class="s2">                    return &#39;&#39;</span>
<span class="s2">                template_functions = </span><span class="se">{{</span><span class="s2">&#39;not_found_template&#39;: not_found_template</span><span class="se">}}</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="p">{},</span> <span class="s1">&#39;not_found_template&#39;</span><span class="p">)</span>

        <span class="n">compile_context</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;raise_if_not_found&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># reference to get xml and etree (usually the template ID)</span>
        <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span>
        <span class="c1"># reference name or key to get xml and etree (usually the template XML ID)</span>
        <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;ref_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-name&#39;</span><span class="p">,</span> <span class="n">template</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;&lt;&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">template</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># str xml of the reference template used for compilation. Useful for debugging, dev mode and profiling.</span>
        <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;ref_xml&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">document</span>
        <span class="c1"># Identifier used to call `_compile`</span>
        <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">template</span>
        <span class="c1"># Root of the etree which will be processed during compilation.</span>
        <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">getroottree</span><span class="p">()</span>
        <span class="c1"># Reference to the last node being compiled. It is mainly used for debugging and displaying error messages.</span>
        <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;_qweb_error_path_xml&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;nsmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">ns_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">ns_definition</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ns_prefix</span><span class="p">,</span> <span class="n">ns_definition</span> <span class="ow">in</span> <span class="n">compile_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nsmap&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># The options dictionary includes cache key elements and template</span>
        <span class="c1"># references. It will be attached to the generated function. This</span>
        <span class="c1"># dictionary is only there for logs, performance or test information.</span>
        <span class="c1"># The values of these `options` cannot be changed and must always be</span>
        <span class="c1"># identical in `context` and `self.env.context`.</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">compile_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_template_cache_keys</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">,</span> <span class="s1">&#39;ref_name&#39;</span><span class="p">,</span> <span class="s1">&#39;ref_xml&#39;</span><span class="p">]}</span>

        <span class="c1"># generate code</span>

        <span class="n">def_name</span> <span class="o">=</span> <span class="n">TO_VARNAME_REGEXP</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;template_</span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">name_gen</span> <span class="o">=</span> <span class="n">count</span><span class="p">()</span>
        <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;make_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">prefix</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">def_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">next</span><span class="p">(</span><span class="n">name_gen</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="n">element</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">FIRST_RSTRIP_REGEXP</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\2&#39;</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

            <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;template_functions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;_text_concat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_append_text</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">)</span> <span class="c1"># To ensure the template function is a generator and doesn&#39;t become a regular function</span>
            <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;template_functions&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">def_name</span><span class="si">}</span><span class="s1">_content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;def </span><span class="si">{</span><span class="n">def_name</span><span class="si">}</span><span class="s2">_content(self, values):&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_node</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">rstrip</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

            <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;template_functions&#39;</span><span class="p">][</span><span class="n">def_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                def </span><span class="si">{</span><span class="n">def_name</span><span class="si">}</span><span class="s2">(self, values):</span>
<span class="s2">                    try:</span>
<span class="s2">                        if &#39;__qweb_loaded_values&#39; not in values:</span>
<span class="s2">                            values[&#39;__qweb_loaded_values&#39;] = </span><span class="se">{{}}</span>
<span class="s2">                            values[&#39;__qweb_root_values&#39;] = values.copy()</span>
<span class="s2">                            values[&#39;xmlid&#39;] = </span><span class="si">{</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;ref_name&#39;</span><span class="p">]</span><span class="si">!r}</span>
<span class="s2">                            values[&#39;viewid&#39;] = </span><span class="si">{</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span><span class="si">!r}</span>
<span class="s2">                        values[&#39;__qweb_loaded_values&#39;].update(template_functions)</span>

<span class="s2">                        yield from </span><span class="si">{</span><span class="n">def_name</span><span class="si">}</span><span class="s2">_content(self, values)</span>
<span class="s2">                    except QWebException:</span>
<span class="s2">                        raise</span>
<span class="s2">                    except Exception as e:</span>
<span class="s2">                        if isinstance(e, TransactionRollbackError):</span>
<span class="s2">                            raise</span>
<span class="s2">                        raise QWebException(&quot;Error while render the template&quot;,</span>
<span class="s2">                            self, template, ref=</span><span class="si">{</span><span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span><span class="si">!r}</span><span class="s2">, code=code) from e</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
        <span class="k">except</span> <span class="n">QWebException</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">QWebException</span><span class="p">(</span><span class="s2">&quot;Error when compiling xml template&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">],</span> <span class="n">path_xml</span><span class="o">=</span><span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;_qweb_error_path_xml&#39;</span><span class="p">])</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="n">code_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;code = None&#39;</span><span class="p">]</span>
        <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;template = </span><span class="si">{</span><span class="p">(</span><span class="n">document</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">isinstance</span><span class="p">(</span><span class="n">template</span><span class="p">,</span><span class="w"> </span><span class="n">etree</span><span class="o">.</span><span class="n">_Element</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">template</span><span class="p">)</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;template_functions = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">lines</span> <span class="ow">in</span> <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;template_functions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">code_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;template_functions&#39;</span><span class="p">]:</span>
            <span class="n">code_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;template_functions[</span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s1">] = </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code_lines</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">code = </span><span class="si">{</span><span class="n">code</span><span class="si">!r}</span><span class="s1">&#39;</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">def_name</span><span class="p">)</span>

    <span class="c1"># read and load input template</span>

    <span class="k">def</span> <span class="nf">_get_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Retrieve the given template, and return it as a tuple ``(etree,</span>
<span class="sd">        xml, ref)``, where ``element`` is an etree, ``document`` is the</span>
<span class="sd">        string document that contains ``element``, and ``ref`` if the uniq</span>
<span class="sd">        reference of the template (id, t-name or template).</span>

<span class="sd">        :param template: template identifier or etree</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">template</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="s2">&quot;template is required&quot;</span>

        <span class="c1"># template is an xml etree already</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">etree</span><span class="o">.</span><span class="n">_Element</span><span class="p">):</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">template</span>
            <span class="n">document</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;unicode&#39;</span><span class="p">)</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># template is xml as string</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;&lt;&#39;</span> <span class="ow">in</span> <span class="n">template</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Inline templates must be passed as `etree` documents&#39;</span><span class="p">)</span>

        <span class="c1"># template is (id or ref) to a database stored template</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ref_alias</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>  <span class="c1"># e.g. &lt;t t-call=&quot;33&quot;/&gt;</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">ref_alias</span> <span class="o">=</span> <span class="n">template</span>  <span class="c1"># e.g. web.layout</span>

            <span class="n">doc_or_elem</span><span class="p">,</span> <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span><span class="n">ref_alias</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">doc_or_elem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can not load template: </span><span class="si">{</span><span class="n">ref_alias</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doc_or_elem</span><span class="p">,</span> <span class="n">etree</span><span class="o">.</span><span class="n">_Element</span><span class="p">):</span>
                <span class="n">element</span> <span class="o">=</span> <span class="n">doc_or_elem</span>
                <span class="n">document</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">doc_or_elem</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;unicode&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doc_or_elem</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">element</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">doc_or_elem</span><span class="p">)</span>
                <span class="n">document</span> <span class="o">=</span> <span class="n">doc_or_elem</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded template </span><span class="si">{</span><span class="n">ref</span><span class="si">!r}</span><span class="s2"> should be a string.&quot;</span><span class="p">)</span>

        <span class="c1"># return etree, document and ref, or try to find the ref</span>
        <span class="k">if</span> <span class="n">ref</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">document</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span>

        <span class="c1"># &lt;templates&gt;</span>
        <span class="c1">#   &lt;template t-name=... /&gt; &lt;!-- return ONLY this element --&gt;</span>
        <span class="c1">#   &lt;template t-name=... /&gt;</span>
        <span class="c1"># &lt;/templates&gt;</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">iter</span><span class="p">():</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t-name&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ref</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">document</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span>

        <span class="c1"># use the document itself as ref when no t-name was found</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">document</span><span class="p">,</span> <span class="n">document</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the template referenced by ``ref``.</span>

<span class="sd">        :returns: The loaded template (as string or etree) and its</span>
<span class="sd">            identifier</span>
<span class="sd">        :rtype: Tuple[Union[etree, str], Optional[str, int]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">IrUIView</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">IrUIView</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">IrUIView</span><span class="o">.</span><span class="n">_read_template</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">etree_view</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>

        <span class="n">xmlid</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">key</span> <span class="ow">or</span> <span class="n">ref</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;ir.ui.view&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">view</span><span class="o">.</span><span class="n">id</span><span class="p">)]</span>
            <span class="n">model_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">search_read</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model_data</span><span class="p">:</span>
                <span class="n">xmlid</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;module&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">model_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># QWeb&#39;s ``_read_template`` will check if one of the first children of</span>
        <span class="c1"># what we send to it has a &quot;t-name&quot; attribute having ``ref`` as value</span>
        <span class="c1"># to consider it has found it. As it&#39;ll never be the case when working</span>
        <span class="c1"># with view ids or children view or children primary views, force it here.</span>
        <span class="k">if</span> <span class="n">view</span><span class="o">.</span><span class="n">inherit_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">etree_view</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t-name&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t-name&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">key</span><span class="p">):</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">etree_view</span> <span class="o">=</span> <span class="n">node</span>
                    <span class="k">break</span>
        <span class="n">etree_view</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;t-name&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">xmlid</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">etree_view</span><span class="p">,</span> <span class="n">view</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="c1"># values for running time</span>

    <span class="k">def</span> <span class="nf">_get_converted_image_data_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base64_source</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;webp_as_jpg&#39;</span><span class="p">):</span>
            <span class="n">mimetype</span> <span class="o">=</span> <span class="n">FILETYPE_BASE64_MAGICWORD</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base64_source</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;png&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;webp&#39;</span> <span class="ow">in</span> <span class="n">mimetype</span><span class="p">:</span>
                <span class="c1"># Use converted image so that is recognized by wkhtmltopdf.</span>
                <span class="n">bin_source</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">base64_source</span><span class="p">)</span>
                <span class="n">Attachment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.attachment&#39;</span><span class="p">]</span>
                <span class="n">checksum</span> <span class="o">=</span> <span class="n">Attachment</span><span class="o">.</span><span class="n">_compute_checksum</span><span class="p">(</span><span class="n">bin_source</span><span class="p">)</span>
                <span class="n">origins</span> <span class="o">=</span> <span class="n">Attachment</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
                    <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;!=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>  <span class="c1"># No implicit condition on res_field.</span>
                    <span class="p">[</span><span class="s1">&#39;checksum&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">checksum</span><span class="p">],</span>
                <span class="p">])</span>
                <span class="k">if</span> <span class="n">origins</span><span class="p">:</span>
                    <span class="n">converted_domain</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;!=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>  <span class="c1"># No implicit condition on res_field.</span>
                        <span class="p">[</span><span class="s1">&#39;res_model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;ir.attachment&#39;</span><span class="p">],</span>
                        <span class="p">[</span><span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">origins</span><span class="o">.</span><span class="n">ids</span><span class="p">],</span>
                        <span class="p">[</span><span class="s1">&#39;mimetype&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;image/jpeg&#39;</span><span class="p">],</span>
                    <span class="p">]</span>
                    <span class="n">converted</span> <span class="o">=</span> <span class="n">Attachment</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">converted_domain</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">converted</span><span class="p">:</span>
                        <span class="n">base64_source</span> <span class="o">=</span> <span class="n">converted</span><span class="o">.</span><span class="n">datas</span>
        <span class="k">return</span> <span class="n">image_data_uri</span><span class="p">(</span><span class="n">base64_source</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Prepare the values and context that will sent to the</span>
<span class="sd">        compiled and evaluated function.</span>

<span class="sd">        :param values: template values to be used for rendering</span>

<span class="sd">        :returns self (with new context)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="n">request</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">debug</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="n">values</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">true</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">false</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;minimal_qcontext&#39;</span><span class="p">):</span>
            <span class="n">values</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>
            <span class="n">values</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">with_env</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">))</span>
            <span class="n">values</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;res_company&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">sudo</span><span class="p">())</span>
            <span class="n">values</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span>  <span class="c1"># might be unbound if we&#39;re not in an httprequest context</span>
                <span class="n">test_mode_enabled</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;test_enable&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;test_file&#39;</span><span class="p">]),</span>
                <span class="n">json</span><span class="o">=</span><span class="n">scriptsafe</span><span class="p">,</span>
                <span class="n">quote_plus</span><span class="o">=</span><span class="n">werkzeug</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">url_quote_plus</span><span class="p">,</span>
                <span class="n">time</span><span class="o">=</span><span class="n">safe_eval</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                <span class="n">datetime</span><span class="o">=</span><span class="n">safe_eval</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
                <span class="n">relativedelta</span><span class="o">=</span><span class="n">relativedelta</span><span class="p">,</span>
                <span class="n">image_data_uri</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_converted_image_data_uri</span><span class="p">,</span>
                <span class="c1"># specific &#39;math&#39; functions to ease rounding in templates and lessen controller marshmalling</span>
                <span class="n">floor</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">,</span>
                <span class="n">ceil</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">,</span>
                <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
                <span class="n">lang</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">),</span>
                <span class="n">keep_query</span><span class="o">=</span><span class="n">keep_query</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dev_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;qweb&#39;</span> <span class="ow">in</span> <span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dev_mode&#39;</span><span class="p">]}</span>
        <span class="k">if</span> <span class="s1">&#39;xml&#39;</span> <span class="ow">in</span> <span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dev_mode&#39;</span><span class="p">]:</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;is_t_cache_disabled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="s1">&#39;disable-t-cache&#39;</span> <span class="ow">in</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;is_t_cache_disabled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">**</span><span class="n">context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__prepare_globals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Prepare the global context that will sent to eval the qweb</span>
<span class="sd">        generated code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;Sized&#39;</span><span class="p">:</span> <span class="n">Sized</span><span class="p">,</span>
            <span class="s1">&#39;Mapping&#39;</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">,</span>
            <span class="s1">&#39;Markup&#39;</span><span class="p">:</span> <span class="n">Markup</span><span class="p">,</span>
            <span class="s1">&#39;escape&#39;</span><span class="p">:</span> <span class="n">escape</span><span class="p">,</span>
            <span class="s1">&#39;VOID_ELEMENTS&#39;</span><span class="p">:</span> <span class="n">VOID_ELEMENTS</span><span class="p">,</span>
            <span class="s1">&#39;QWebException&#39;</span><span class="p">:</span> <span class="n">QWebException</span><span class="p">,</span>
            <span class="s1">&#39;Exception&#39;</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">,</span>
            <span class="s1">&#39;TransactionRollbackError&#39;</span><span class="p">:</span> <span class="n">TransactionRollbackError</span><span class="p">,</span> <span class="c1"># for SerializationFailure in assets</span>
            <span class="s1">&#39;ValueError&#39;</span><span class="p">:</span> <span class="ne">ValueError</span><span class="p">,</span>
            <span class="s1">&#39;UserError&#39;</span><span class="p">:</span> <span class="n">UserError</span><span class="p">,</span>
            <span class="s1">&#39;AccessDenied&#39;</span><span class="p">:</span> <span class="n">AccessDenied</span><span class="p">,</span>
            <span class="s1">&#39;AccessError&#39;</span><span class="p">:</span> <span class="n">AccessError</span><span class="p">,</span>
            <span class="s1">&#39;MissingError&#39;</span><span class="p">:</span> <span class="n">MissingError</span><span class="p">,</span>
            <span class="s1">&#39;ValidationError&#39;</span><span class="p">:</span> <span class="n">ValidationError</span><span class="p">,</span>
            <span class="s1">&#39;warning&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">),</span>
            <span class="o">**</span><span class="n">_BUILTINS</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="c1"># helpers for compilation</span>

    <span class="k">def</span> <span class="nf">_append_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Add an item (converts to a string) to the list.</span>
<span class="sd">            This will be concatenated and added during a call to the</span>
<span class="sd">            `_flush_text` method. This makes it possible to return only one</span>
<span class="sd">            yield containing all the parts.&quot;&quot;&quot;</span>
        <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;_text_concat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_to_str</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_rstrip_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; The text to flush is right stripped, and the stripped content are</span>
<span class="sd">        returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text_concat</span> <span class="o">=</span> <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;_text_concat&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text_concat</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">RSTRIP_REGEXP</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">text_concat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">strip</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">text_concat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">RSTRIP_REGEXP</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">text_concat</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">strip</span>

    <span class="k">def</span> <span class="nf">_flush_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">rstrip</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Concatenate all the textual chunks added by the `_append_text`</span>
<span class="sd">            method into a single yield.</span>
<span class="sd">            If no text to flush, return an empty list</span>

<span class="sd">            If rstrip the text is right stripped.</span>

<span class="sd">            @returns list(str)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text_concat</span> <span class="o">=</span> <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;_text_concat&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text_concat</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">rstrip</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rstrip_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text_concat</span><span class="p">)</span>
        <span class="n">text_concat</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;    &#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">level</span><span class="si">}</span><span class="s2">yield </span><span class="si">{</span><span class="n">text</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_is_static_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Test whether the given element is purely static, i.e. (there</span>
<span class="sd">        are no t-* attributes), does not require dynamic rendering for its</span>
<span class="sd">        attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">el</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s1">&#39;t&#39;</span> <span class="ow">and</span> <span class="s1">&#39;groups&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">att</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;t-&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">att</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;t-tag-open&#39;</span><span class="p">,</span> <span class="s1">&#39;t-inner-content&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span>
        <span class="p">)</span>

    <span class="c1"># compile python expression and format string</span>

    <span class="k">def</span> <span class="nf">_compile_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Parses the provided format string and compiles it to a single</span>
<span class="sd">        expression python, uses string with format method.</span>
<span class="sd">        Use format is faster to concat string and values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># &lt;t t-setf-name=&quot;Hello #{world} %s !&quot;/&gt;</span>
        <span class="c1"># =&gt;</span>
        <span class="c1"># values[&#39;name&#39;] = &#39;Hello %s %%s !&#39; % (values[&#39;world&#39;],)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s1">&#39;self._compile_to_str(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_expr</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="si">}</span><span class="s1">)&#39;</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">FORMAT_REGEX</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">code</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">FORMAT_REGEX</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; % (</span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s1">,)&#39;</span>
        <span class="k">return</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">_compile_expr_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">allowed_keys</span><span class="p">,</span> <span class="n">argument_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">raise_on_missing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Transform the list of token coming into a python instruction in</span>
<span class="sd">            textual form by adding the namepaces for the dynamic values.</span>

<span class="sd">            Example: `5 + a + b.c` to be `5 + values.get(&#39;a&#39;) + values[&#39;b&#39;].c`</span>
<span class="sd">            Unknown values are considered to be None, but using `values[&#39;b&#39;]`</span>
<span class="sd">            gives a clear error message in cases where there is an attribute for</span>
<span class="sd">            example (have a `KeyError: &#39;b&#39;`, instead of `AttributeError: &#39;NoneType&#39;</span>
<span class="sd">            object has no attribute &#39;c&#39;`).</span>

<span class="sd">            @returns str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Finds and extracts the current &quot;scope&quot;&#39;s &quot;allowed values&quot;: values</span>
        <span class="c1"># which should not be accessed through the environment&#39;s namespace:</span>
        <span class="c1"># * the local variables of a lambda should be accessed directly e.g.</span>
        <span class="c1">#     lambda a: a + b should be compiled to lambda a: a + values[&#39;b&#39;],</span>
        <span class="c1">#     since a is local to the lambda it has to be accessed directly</span>
        <span class="c1">#     but b needs to be accessed through the rendering environment</span>
        <span class="c1"># * similarly for a comprehensions [a + b for a in c] should be</span>
        <span class="c1">#     compiledto [a + values.get(&#39;b&#39;) for a in values.get(&#39;c&#39;)]</span>
        <span class="c1"># to avoid the risk of confusion between nested lambdas / comprehensions,</span>
        <span class="c1"># this is currently performed independently at each level of brackets</span>
        <span class="c1"># nesting (hence the function being recursive).</span>
        <span class="n">open_bracket_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">bracket_depth</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">argument_name</span> <span class="o">=</span> <span class="s1">&#39;_arg_</span><span class="si">%s</span><span class="s1">__&#39;</span>
        <span class="n">argument_names</span> <span class="o">=</span> <span class="n">argument_names</span> <span class="ow">or</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">exact_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">LPAR</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">LSQB</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">LBRACE</span><span class="p">]:</span>
                <span class="n">bracket_depth</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">exact_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">RPAR</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">RSQB</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">RBRACE</span><span class="p">]:</span>
                <span class="n">bracket_depth</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">bracket_depth</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">exact_type</span> <span class="o">==</span> <span class="n">token</span><span class="o">.</span><span class="n">NAME</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">string</span>
                <span class="k">if</span> <span class="n">string</span> <span class="o">==</span> <span class="s1">&#39;lambda&#39;</span><span class="p">:</span> <span class="c1"># lambda =&gt; allowed values for the current bracket depth</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)):</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">exact_type</span> <span class="o">==</span> <span class="n">token</span><span class="o">.</span><span class="n">NAME</span><span class="p">:</span>
                            <span class="n">argument_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">exact_type</span> <span class="o">==</span> <span class="n">token</span><span class="o">.</span><span class="n">COMMA</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">exact_type</span> <span class="o">==</span> <span class="n">token</span><span class="o">.</span><span class="n">COLON</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">exact_type</span> <span class="o">==</span> <span class="n">token</span><span class="o">.</span><span class="n">EQUAL</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Lambda default values are not supported&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;This lambda code style is not implemented.&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">string</span> <span class="o">==</span> <span class="s1">&#39;for&#39;</span><span class="p">:</span> <span class="c1"># list comprehensions =&gt; allowed values for the current bracket depth</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)):</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">exact_type</span> <span class="o">==</span> <span class="n">token</span><span class="o">.</span><span class="n">NAME</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="o">==</span> <span class="s1">&#39;in&#39;</span><span class="p">:</span>
                                <span class="k">break</span>
                            <span class="n">argument_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">exact_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">COMMA</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">LPAR</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">RPAR</span><span class="p">]:</span>
                            <span class="k">pass</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;This loop code style is not implemented.&#39;</span><span class="p">)</span>

        <span class="c1"># Use bracket to nest structures.</span>
        <span class="c1"># Recursively processes the &quot;sub-scopes&quot;, and replace their content with</span>
        <span class="c1"># a compiled node. During this recursive call we add to the allowed</span>
        <span class="c1"># values the values provided by the list comprehension, lambda, etc.,</span>
        <span class="c1"># previously extracted.</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">open_bracket_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">bracket_depth</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">string</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">string</span>

            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">exact_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">LPAR</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">LSQB</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">LBRACE</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">bracket_depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">open_bracket_index</span> <span class="o">=</span> <span class="n">index</span>
                <span class="n">bracket_depth</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">exact_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">RPAR</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">RSQB</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">RBRACE</span><span class="p">]:</span>
                <span class="n">bracket_depth</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">bracket_depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_expr_tokens</span><span class="p">(</span>
                        <span class="n">tokens</span><span class="p">[</span><span class="n">open_bracket_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">index</span><span class="p">],</span>
                        <span class="nb">list</span><span class="p">(</span><span class="n">allowed_keys</span><span class="p">),</span>
                        <span class="nb">list</span><span class="p">(</span><span class="n">argument_names</span><span class="p">),</span>
                        <span class="n">raise_on_missing</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">open_bracket_index</span><span class="p">]</span><span class="o">.</span><span class="n">string</span> <span class="o">+</span> <span class="n">code</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="n">string</span>
                    <span class="n">tokens</span><span class="p">[</span><span class="n">open_bracket_index</span><span class="p">:</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">tokenize</span><span class="o">.</span><span class="n">TokenInfo</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">QWEB</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">tokens</span><span class="p">[</span><span class="n">open_bracket_index</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">end</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">open_bracket_index</span>

            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># The keys will be namespaced by values if they are not allowed. In</span>
        <span class="c1"># order to have a clear keyError message, this will be replaced by</span>
        <span class="c1"># values[&#39;key&#39;] for certain cases (for example if an attribute is called</span>
        <span class="c1"># key.attrib, or an index key[0] ...)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">tokens</span> <span class="ow">and</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start</span> <span class="c1"># to keep level when use expr on multi line</span>
        <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">string</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">string</span>

            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">space</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">space</span><span class="p">:</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">space</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">start</span>

            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">exact_type</span> <span class="o">==</span> <span class="n">token</span><span class="o">.</span><span class="n">NAME</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">string</span> <span class="o">==</span> <span class="s1">&#39;lambda&#39;</span><span class="p">:</span> <span class="c1"># lambda =&gt; allowed values</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;lambda &#39;</span><span class="p">)</span>
                    <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">exact_type</span> <span class="o">==</span> <span class="n">token</span><span class="o">.</span><span class="n">NAME</span> <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ow">in</span> <span class="n">argument_names</span><span class="p">:</span>
                            <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">argument_name</span> <span class="o">%</span> <span class="n">t</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">exact_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">COMMA</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">COLON</span><span class="p">]:</span>
                            <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">exact_type</span> <span class="o">==</span> <span class="n">token</span><span class="o">.</span><span class="n">COLON</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">end</span>
                <span class="k">elif</span> <span class="n">string</span> <span class="ow">in</span> <span class="n">argument_names</span><span class="p">:</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">argument_name</span> <span class="o">%</span> <span class="n">t</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">string</span> <span class="ow">in</span> <span class="n">allowed_keys</span><span class="p">:</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tokens</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">exact_type</span> <span class="o">==</span> <span class="n">token</span><span class="o">.</span><span class="n">EQUAL</span><span class="p">:</span> <span class="c1"># function kw</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">tokens</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">tokens</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">exact_type</span> <span class="o">==</span> <span class="n">token</span><span class="o">.</span><span class="n">DOT</span><span class="p">:</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">raise_on_missing</span> <span class="ow">or</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tokens</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">exact_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">DOT</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">LPAR</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">LSQB</span><span class="p">,</span> <span class="s1">&#39;qweb&#39;</span><span class="p">]:</span>
                    <span class="c1"># Should have values[&#39;product&#39;].price to raise an error when get</span>
                    <span class="c1"># the &#39;product&#39; value and not an &#39;NoneType&#39; object has no</span>
                    <span class="c1"># attribute &#39;price&#39; error.</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;values[</span><span class="si">{</span><span class="n">string</span><span class="si">!r}</span><span class="s1">]&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># not assignation allowed, only getter</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;values.get(</span><span class="si">{</span><span class="n">string</span><span class="si">!r}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">tokenize</span><span class="o">.</span><span class="n">ENCODING</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">ENDMARKER</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">DEDENT</span><span class="p">]:</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">end</span>

            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">raise_on_missing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform string coming into a python instruction in textual form by</span>
<span class="sd">        adding the namepaces for the dynamic values.</span>
<span class="sd">        This method tokenize the string and call ``_compile_expr_tokens``</span>
<span class="sd">        method.</span>

<span class="sd">        :param expr: string: python expression</span>
<span class="sd">        :param [raise_on_missing]: boolean:</span>
<span class="sd">            Compile has `values[&#39;product&#39;].price` instead of</span>
<span class="sd">            `values.get(&#39;product&#39;).price` to raise an error when get the</span>
<span class="sd">            &#39;product&#39; value and not an &#39;NoneType&#39; object has no attribute</span>
<span class="sd">            &#39;price&#39; error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Parentheses are useful for compiling multi-line expressions such as</span>
        <span class="c1"># conditions existing in some templates. (see test_compile_expr tests)</span>
        <span class="n">readable</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">expr</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tokenize</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">readable</span><span class="o">.</span><span class="n">readline</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">tokenize</span><span class="o">.</span><span class="n">TokenError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can not compile expression: </span><span class="si">{</span><span class="n">expr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_expr_tokens</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">ALLOWED_KEYWORD</span><span class="p">,</span> <span class="n">raise_on_missing</span><span class="o">=</span><span class="n">raise_on_missing</span><span class="p">)</span>

        <span class="n">assert_valid_codeobj</span><span class="p">(</span><span class="n">_SAFE_QWEB_OPCODES</span><span class="p">,</span> <span class="nb">compile</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="s1">&#39;&lt;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;eval&#39;</span><span class="p">),</span> <span class="n">expr</span><span class="p">)</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">expression</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span> <span class="nf">_compile_bool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert the statements as a boolean.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">attr</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_to_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generates a text value (an instance of text_type) from an arbitrary</span>
<span class="sd">            source.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">to_text</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>

    <span class="c1"># order</span>

    <span class="k">def</span> <span class="nf">_directives_eval_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; List all supported directives in the order in which they should be</span>
<span class="sd">        evaluated on a given element. For instance, a node bearing both</span>
<span class="sd">        ``foreach`` and ``if`` should see ``foreach`` executed before ``if`` aka</span>
<span class="sd">        .. code-block:: xml</span>
<span class="sd">            &lt;el t-foreach=&quot;foo&quot; t-as=&quot;bar&quot; t-if=&quot;bar&quot;&gt;</span>
<span class="sd">        should be equivalent to</span>
<span class="sd">        .. code-block:: xml</span>
<span class="sd">            &lt;t t-foreach=&quot;foo&quot; t-as=&quot;bar&quot;&gt;</span>
<span class="sd">                &lt;t t-if=&quot;bar&quot;&gt;</span>
<span class="sd">                    &lt;el&gt;</span>
<span class="sd">        then this method should return ``[&#39;foreach&#39;, &#39;if&#39;]``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s1">&#39;elif&#39;</span><span class="p">,</span> <span class="c1"># Must be the first because compiled by the previous if.</span>
            <span class="s1">&#39;else&#39;</span><span class="p">,</span> <span class="c1"># Must be the first because compiled by the previous if.</span>
            <span class="s1">&#39;debug&#39;</span><span class="p">,</span>
            <span class="s1">&#39;nocache&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cache&#39;</span><span class="p">,</span>
            <span class="s1">&#39;groups&#39;</span><span class="p">,</span>
            <span class="s1">&#39;as&#39;</span><span class="p">,</span> <span class="s1">&#39;foreach&#39;</span><span class="p">,</span>
            <span class="s1">&#39;if&#39;</span><span class="p">,</span>
            <span class="s1">&#39;call-assets&#39;</span><span class="p">,</span>
            <span class="s1">&#39;lang&#39;</span><span class="p">,</span>
            <span class="s1">&#39;options&#39;</span><span class="p">,</span>
            <span class="s1">&#39;att&#39;</span><span class="p">,</span>
            <span class="s1">&#39;field&#39;</span><span class="p">,</span> <span class="s1">&#39;esc&#39;</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">,</span> <span class="s1">&#39;out&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tag-open&#39;</span><span class="p">,</span>
            <span class="s1">&#39;call&#39;</span><span class="p">,</span>
            <span class="s1">&#39;set&#39;</span><span class="p">,</span>
            <span class="s1">&#39;inner-content&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tag-close&#39;</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="c1"># compile</span>

    <span class="k">def</span> <span class="nf">_compile_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Compile the given element into python code.</span>

<span class="sd">            The t-* attributes (directives) will be converted to a python instruction. If there</span>
<span class="sd">            are no t-* attributes, the element will be considered static.</span>

<span class="sd">            Directives are compiled using the order provided by the</span>
<span class="sd">            ``_directives_eval_order`` method (an create the</span>
<span class="sd">            ``compile_context[&#39;iter_directives&#39;]`` iterator).</span>
<span class="sd">            For compilation, the directives supported are those with a</span>
<span class="sd">            compilation method ``_compile_directive_*``</span>

<span class="sd">        :return: list of string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Internal directive used to skip a rendering.</span>
        <span class="k">if</span> <span class="s1">&#39;t-qweb-skip&#39;</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># if tag don&#39;t have qweb attributes don&#39;t use directives</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_static_node</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_static_node</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getpath</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;unicode&#39;</span><span class="p">)</span>
        <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;_qweb_error_path_xml&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">xml</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;# element: </span><span class="si">{</span><span class="n">path</span><span class="si">!r}</span><span class="s1"> , </span><span class="si">{</span><span class="n">xml</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">level</span><span class="p">)]</span>

        <span class="c1"># create an iterator on directives to compile in order</span>
        <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;iter_directives&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_directives_eval_order</span><span class="p">())</span>

        <span class="c1"># add technical directive tag-open, tag-close, inner-content and take</span>
        <span class="c1"># care of the namspace</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">el</span><span class="o">.</span><span class="n">nsmap</span><span class="p">:</span>
            <span class="n">unqualified_el_tag</span> <span class="o">=</span> <span class="n">el_tag</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">tag</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Etree will remove the ns prefixes indirection by inlining the corresponding</span>
            <span class="c1"># nsmap definition into the tag attribute. Restore the tag and prefix here.</span>
            <span class="c1"># Note: we do not support namespace dynamic attributes, we need a default URI</span>
            <span class="c1"># on the root and use attribute directive t-att=&quot;{&#39;xmlns:example&#39;: value}&quot;.</span>
            <span class="n">unqualified_el_tag</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span><span class="o">.</span><span class="n">localname</span>
            <span class="n">el_tag</span> <span class="o">=</span> <span class="n">unqualified_el_tag</span>
            <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">prefix</span><span class="p">:</span>
                <span class="n">el_tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">el</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">el_tag</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="n">unqualified_el_tag</span> <span class="o">!=</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span>
            <span class="n">el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;t-tag-open&#39;</span><span class="p">,</span> <span class="n">el_tag</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">el_tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">VOID_ELEMENTS</span><span class="p">:</span>
                <span class="n">el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;t-tag-close&#39;</span><span class="p">,</span> <span class="n">el_tag</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">({</span><span class="s1">&#39;t-out&#39;</span><span class="p">,</span> <span class="s1">&#39;t-esc&#39;</span><span class="p">,</span> <span class="s1">&#39;t-raw&#39;</span><span class="p">,</span> <span class="s1">&#39;t-field&#39;</span><span class="p">}</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">)):</span>
            <span class="n">el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;t-inner-content&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">body</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_directives</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_static_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Compile a purely static element into a list of string. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">el</span><span class="o">.</span><span class="n">nsmap</span><span class="p">:</span>
            <span class="n">unqualified_el_tag</span> <span class="o">=</span> <span class="n">el_tag</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">tag</span>
            <span class="n">attrib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_processing_att</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Etree will remove the ns prefixes indirection by inlining the corresponding</span>
            <span class="c1"># nsmap definition into the tag attribute. Restore the tag and prefix here.</span>
            <span class="n">unqualified_el_tag</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span><span class="o">.</span><span class="n">localname</span>
            <span class="n">el_tag</span> <span class="o">=</span> <span class="n">unqualified_el_tag</span>
            <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">prefix</span><span class="p">:</span>
                <span class="n">el_tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">el</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">el_tag</span><span class="si">}</span><span class="s1">&#39;</span>

            <span class="n">attrib</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># If `el` introduced new namespaces, write them as attribute by using the</span>
            <span class="c1"># `attrib` dict.</span>
            <span class="k">for</span> <span class="n">ns_prefix</span><span class="p">,</span> <span class="n">ns_definition</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">nsmap</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;nsmap&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">ns_prefix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;xmlns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ns_definition</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">attrib</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;xmlns:</span><span class="si">{</span><span class="n">ns_prefix</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ns_definition</span>

            <span class="c1"># Etree will also remove the ns prefixes indirection in the attributes. As we only have</span>
            <span class="c1"># the namespace definition, we&#39;ll use an nsmap where the keys are the definitions and</span>
            <span class="c1"># the values the prefixes in order to get back the right prefix and restore it.</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;nsmap&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">el</span><span class="o">.</span><span class="n">nsmap</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">nsprefixmap</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ns</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">attrib_qname</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">attrib_qname</span><span class="o">.</span><span class="n">namespace</span><span class="p">:</span>
                    <span class="n">attrib</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nsprefixmap</span><span class="p">[</span><span class="n">attrib_qname</span><span class="o">.</span><span class="n">namespace</span><span class="p">]</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">attrib_qname</span><span class="o">.</span><span class="n">localname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">attrib</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="n">attrib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_processing_att</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">attrib</span><span class="p">)</span>

            <span class="c1"># Update the dict of inherited namespaces before continuing the recursion. Note:</span>
            <span class="c1"># since `compile_context[&#39;nsmap&#39;]` is a dict (and therefore mutable) and we do **not**</span>
            <span class="c1"># want changes done in deeper recursion to bevisible in earlier ones, we&#39;ll pass</span>
            <span class="c1"># a copy before continuing the recursion and restore the original afterwards.</span>
            <span class="n">original_nsmap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;nsmap&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">unqualified_el_tag</span> <span class="o">!=</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">=&quot;</span><span class="si">{</span><span class="n">escape</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
                                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attrib</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_append_text</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&lt;</span><span class="si">{</span><span class="n">el_tag</span><span class="si">}{</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">el_tag</span> <span class="ow">in</span> <span class="n">VOID_ELEMENTS</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_append_text</span><span class="p">(</span><span class="s1">&#39;/&gt;&#39;</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_append_text</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">)</span>

        <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">nsmap</span><span class="p">:</span>
            <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;nsmap&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">nsmap</span><span class="p">)</span>
            <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_directive</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="s1">&#39;inner-content&#39;</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
            <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;nsmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_nsmap</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_directive</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="s1">&#39;inner-content&#39;</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">unqualified_el_tag</span> <span class="o">!=</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">el_tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">VOID_ELEMENTS</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_append_text</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&lt;/</span><span class="si">{</span><span class="n">el_tag</span><span class="si">}</span><span class="s1">&gt;&#39;</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">body</span>

    <span class="k">def</span> <span class="nf">_compile_directives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Compile the given element, following the directives given in the</span>
<span class="sd">        iterator ``compile_context[&#39;iter_directives&#39;]`` create by</span>
<span class="sd">        `_compile_node`` method.</span>

<span class="sd">        :return: list of code lines</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_static_node</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">):</span>
            <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-tag-open&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-inner-content&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-tag-close&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_static_node</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># compile the directives still present on the element</span>
        <span class="k">for</span> <span class="n">directive</span> <span class="ow">in</span> <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;iter_directives&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;t-&#39;</span> <span class="o">+</span> <span class="n">directive</span><span class="p">)</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_directive</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">directive</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">directive</span> <span class="o">==</span> <span class="s1">&#39;groups&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">directive</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_directive</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">directive</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">directive</span> <span class="o">==</span> <span class="s1">&#39;att&#39;</span><span class="p">:</span>
                <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_directive</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">directive</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">directive</span> <span class="o">==</span> <span class="s1">&#39;options&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;t-options-&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">):</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_directive</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">directive</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">directive</span> <span class="o">==</span> <span class="s1">&#39;nocache&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;t-nocache-&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">):</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_directive</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">directive</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>

        <span class="c1"># compile unordered directives still present on the element</span>
        <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">att</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SPECIAL_DIRECTIVES</span> <span class="ow">and</span> <span class="n">att</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;t-&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_compile_directive_</span><span class="si">{</span><span class="n">att</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_directive</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">directive</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>

        <span class="n">remaining</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">)</span> <span class="o">-</span> <span class="n">SPECIAL_DIRECTIVES</span>
        <span class="k">if</span> <span class="n">remaining</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unknown directives or unused attributes: </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">remaining</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">code</span>

    <span class="nd">@QwebTracker</span><span class="o">.</span><span class="n">wrap_compile_directive</span>
    <span class="k">def</span> <span class="nf">_compile_directive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">directive</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="n">compile_handler</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_compile_directive_</span><span class="si">{</span><span class="n">directive</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">compile_handler</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

    <span class="c1"># compile directives</span>

    <span class="k">def</span> <span class="nf">_compile_directive_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile `t-debug` expressions into a python code as a list of</span>
<span class="sd">        strings.</span>

<span class="sd">        The code will contains the call to the debugger chosen from the valid</span>
<span class="sd">        list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">debugger</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-debug&#39;</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">compile_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dev_mode&#39;</span><span class="p">):</span>
            <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;self._debug_trace(</span><span class="si">{</span><span class="n">debugger</span><span class="si">!r}</span><span class="s2">, values)&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;@t-debug in template is only available in qweb dev mode&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">_compile_directive_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        compile t-options and add to the dict the t-options-xxx. Will create</span>
<span class="sd">        the dictionary ``values[&#39;__qweb_options__&#39;]`` in compiled code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dict_options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;t-options-&#39;</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">option_name</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">10</span><span class="p">:]</span>
                <span class="n">dict_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">option_name</span><span class="si">!r}</span><span class="s1">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_expr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">t_options</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-options&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t_options</span> <span class="ow">and</span> <span class="n">dict_options</span><span class="p">:</span>
            <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;values[&#39;__qweb_options__&#39;] = </span><span class="se">{{</span><span class="s2">**</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_expr</span><span class="p">(</span><span class="n">t_options</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dict_options</span><span class="p">)</span><span class="si">}</span><span class="se">}}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">dict_options</span><span class="p">:</span>
            <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;values[&#39;__qweb_options__&#39;] = </span><span class="se">{{</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dict_options</span><span class="p">)</span><span class="si">}</span><span class="se">}}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">t_options</span><span class="p">:</span>
            <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;values[&#39;__qweb_options__&#39;] = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_expr</span><span class="p">(</span><span class="n">t_options</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="s2">&quot;values[&#39;__qweb_options__&#39;] = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>

        <span class="n">el</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;t-consumed-options&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">code</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">_compile_directive_consumed_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s1">&#39;the t-options must be on the same tag as a directive that consumes it (for example: t-out, t-field, t-call)&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_directive_att</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Compile the attributes of the given elements.</span>

<span class="sd">        The compiled function will create the ``values[&#39;__qweb_attrs__&#39;]``</span>
<span class="sd">        dictionary. Then the dictionary will be output.</span>


<span class="sd">        The new namespaces of the current element.</span>

<span class="sd">        The static attributes (not prefixed by ``t-``) are add to the</span>
<span class="sd">        dictionary in first.</span>

<span class="sd">        The dynamic attributes values will be add after. The dynamic</span>
<span class="sd">        attributes has different origins.</span>
<span class="sd">        - value from key equal to ``t-att``: python dictionary expression;</span>
<span class="sd">        - value from keys that start with ``t-att-``: python expression;</span>
<span class="sd">        - value from keys that start with ``t-attf-``: format string</span>
<span class="sd">            expression.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="p">[</span><span class="n">indent_code</span><span class="p">(</span><span class="s2">&quot;attrs = values[&#39;__qweb_attrs__&#39;] = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">)]</span>

        <span class="c1"># Compile the introduced new namespaces of the given element.</span>
        <span class="c1">#</span>
        <span class="c1"># Add the found new attributes into the `attrs` dictionary like</span>
        <span class="c1"># the static attributes.</span>
        <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">nsmap</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ns_prefix</span><span class="p">,</span> <span class="n">ns_definition</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">nsmap</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;nsmap&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;xmlns&#39;</span>
                <span class="k">if</span> <span class="n">ns_prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;xmlns:</span><span class="si">{</span><span class="n">ns_prefix</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;attrs[</span><span class="si">{</span><span class="n">key</span><span class="si">!r}</span><span class="s1">] = </span><span class="si">{</span><span class="n">ns_definition</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>

        <span class="c1"># Compile the static attributes of the given element.</span>
        <span class="c1">#</span>
        <span class="c1"># Etree will also remove the ns prefixes indirection in the</span>
        <span class="c1"># attributes. As we only have the namespace definition, we&#39;ll use</span>
        <span class="c1"># an nsmap where the keys are the definitions and the values the</span>
        <span class="c1"># prefixes in order to get back the right prefix and restore it.</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;t-&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">):</span>
            <span class="n">nsprefixmap</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;nsmap&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">el</span><span class="o">.</span><span class="n">nsmap</span><span class="o">.</span><span class="n">items</span><span class="p">())}</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;t-&#39;</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">attrib_qname</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">QName</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">attrib_qname</span><span class="o">.</span><span class="n">namespace</span><span class="p">:</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nsprefixmap</span><span class="p">[</span><span class="n">attrib_qname</span><span class="o">.</span><span class="n">namespace</span><span class="p">]</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">attrib_qname</span><span class="o">.</span><span class="n">localname</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;attrs[</span><span class="si">{</span><span class="n">key</span><span class="si">!r}</span><span class="s1">] = </span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>

        <span class="c1"># Compile the dynamic attributes of the given element. All</span>
        <span class="c1"># attributes will be add to the ``attrs`` dictionary in the</span>
        <span class="c1"># compiled function.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;t-attf-&#39;</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;attrs[</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span><span class="si">!r}</span><span class="s2">] = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;t-att-&#39;</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;attrs[</span><span class="si">{</span><span class="n">key</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span><span class="si">!r}</span><span class="s2">] = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_expr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;t-att&#39;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    atts_value = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_expr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span>
<span class="s2">                    if isinstance(atts_value, dict):</span>
<span class="s2">                        attrs.update(atts_value)</span>
<span class="s2">                    elif isinstance(atts_value, (list, tuple)) and not isinstance(atts_value[0], (list, tuple)):</span>
<span class="s2">                        attrs.update([atts_value])</span>
<span class="s2">                    elif isinstance(atts_value, (list, tuple)):</span>
<span class="s2">                        attrs.update(dict(atts_value))</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">_compile_directive_tag_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Compile the opening tag with attributes of the given element into</span>
<span class="sd">        a list of python code line.</span>

<span class="sd">        The compiled function will fill the ``attrs`` dictionary. Then the</span>
<span class="sd">        ``attrs`` dictionary will be output and reset the value of ``attrs``.</span>

<span class="sd">        The static attributes (not prefixed by ``t-``) are add to the</span>
<span class="sd">        ``attrs`` dictionary in first.</span>

<span class="sd">        The dynamic attributes values will be add after. The dynamic</span>
<span class="sd">        attributes has different origins.</span>
<span class="sd">        - value from key equal to ``t-att``: python dictionary expression;</span>
<span class="sd">        - value from keys that start with ``t-att-``: python expression;</span>
<span class="sd">        - value from keys that start with ``t-attf-``: format string</span>
<span class="sd">            expression.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">el_tag</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-tag-open&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">el_tag</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># open the open tag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_append_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">el_tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">)</span>

        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="c1"># Generates the part of the code that prost process and output the</span>
        <span class="c1"># attributes from ``attrs`` dictionary. Consumes `attrs` dictionary</span>
        <span class="c1"># and reset it.</span>
        <span class="c1">#</span>
        <span class="c1"># Use str(value) to change Markup into str and escape it, then use str</span>
        <span class="c1"># to avoid the escaping of the other html content.</span>
        <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            attrs = values.pop(&#39;__qweb_attrs__&#39;, None)</span>
<span class="s2">            if attrs:</span>
<span class="s2">                tagName = </span><span class="si">{</span><span class="n">el</span><span class="o">.</span><span class="n">tag</span><span class="si">!r}</span>
<span class="s2">                attrs = self._post_processing_att(tagName, attrs)</span>
<span class="s2">                for name, value in attrs.items():</span>
<span class="s2">                    if value or isinstance(value, str):</span>
<span class="s2">                        yield f&#39; </span><span class="se">{{</span><span class="s2">escape(str(name))</span><span class="se">}}</span><span class="s2">=&quot;</span><span class="se">{{</span><span class="s2">escape(str(value))</span><span class="se">}}</span><span class="s2">&quot;&#39;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>

        <span class="c1"># close the open tag</span>
        <span class="k">if</span> <span class="s1">&#39;t-tag-close&#39;</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_append_text</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_append_text</span><span class="p">(</span><span class="s1">&#39;/&gt;&#39;</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">_compile_directive_tag_close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Compile the closing tag of the given element into string.</span>
<span class="sd">        Returns an empty list because it&#39;s use only `_append_text`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">el_tag</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;t-tag-close&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">el_tag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_append_text</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&lt;/</span><span class="si">{</span><span class="n">el_tag</span><span class="si">}</span><span class="s1">&gt;&#39;</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_compile_directive_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile `t-set` expressions into a python code as a list of</span>
<span class="sd">        strings.</span>

<span class="sd">        There are 3 kinds of `t-set`:</span>
<span class="sd">        * `t-value` containing python code;</span>
<span class="sd">        * `t-valuef` containing strings to format;</span>
<span class="sd">        * whose value is the content of the tag (being Markup safe).</span>

<span class="sd">        The code will contain the assignment of the dynamically generated value.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">rstrip</span><span class="o">=</span><span class="n">el</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;t-set&#39;</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="n">varname</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-set&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">varname</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;t-set&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">varname</span> <span class="o">!=</span> <span class="n">T_CALL_SLOT</span> <span class="ow">and</span> <span class="n">varname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;{&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">VARNAME_REGEXP</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">varname</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The varname can only contain alphanumeric characters and underscores.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;t-value&#39;</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span> <span class="ow">or</span> <span class="s1">&#39;t-valuef&#39;</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span> <span class="ow">or</span> <span class="n">varname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;{&#39;</span><span class="p">:</span>
                <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-inner-content&#39;</span><span class="p">)</span> <span class="c1"># The content is considered empty.</span>
                <span class="k">if</span> <span class="n">varname</span> <span class="o">==</span> <span class="n">T_CALL_SLOT</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s1">&#39;t-set=&quot;0&quot; should not be set from t-value or t-valuef&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;t-value&#39;</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-value&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;None&#39;</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;values[</span><span class="si">{</span><span class="n">varname</span><span class="si">!r}</span><span class="s2">] = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_expr</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
            <span class="k">elif</span> <span class="s1">&#39;t-valuef&#39;</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                <span class="n">exprf</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-valuef&#39;</span><span class="p">)</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;values[</span><span class="si">{</span><span class="n">varname</span><span class="si">!r}</span><span class="s2">] = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_format</span><span class="p">(</span><span class="n">exprf</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">varname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;{&#39;</span><span class="p">:</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;values.update(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_expr</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># set the content as value</span>
                <span class="n">content</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_compile_directive</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="s1">&#39;inner-content&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_flush_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
                    <span class="n">def_name</span> <span class="o">=</span> <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;make_name&#39;</span><span class="p">](</span><span class="s1">&#39;t_set&#39;</span><span class="p">)</span>
                    <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;template_functions&#39;</span><span class="p">][</span><span class="n">def_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;def </span><span class="si">{</span><span class="n">def_name</span><span class="si">}</span><span class="s2">(self, values):&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">content</span>
                    <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                            t_set = []</span>
<span class="s2">                            for item in </span><span class="si">{</span><span class="n">def_name</span><span class="si">}</span><span class="s2">(self, values):</span>
<span class="s2">                                if isinstance(item, str):</span>
<span class="s2">                                    t_set.append(item)</span>
<span class="s2">                                else:</span>
<span class="s2">                                    ref, function_name, cached_values = item</span>
<span class="s2">                                    t_nocache_function = values[&#39;__qweb_loaded_values&#39;].get(function_name)</span>
<span class="s2">                                    if not t_nocache_function:</span>
<span class="s2">                                        t_call_template_functions, def_name = self._compile(ref)</span>
<span class="s2">                                        t_nocache_function = t_call_template_functions[function_name]</span>

<span class="s2">                                    nocache_values = values[&#39;__qweb_root_values&#39;].copy()</span>
<span class="s2">                                    nocache_values.update(cached_values)</span>
<span class="s2">                                    t_set.extend(t_nocache_function(self, nocache_values))</span>
<span class="s2">                        &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
                    <span class="n">expr</span> <span class="o">=</span> <span class="s2">&quot;Markup(&#39;&#39;.join(t_set))&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">expr</span> <span class="o">=</span> <span class="s2">&quot;&#39;&#39;&quot;</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;values[</span><span class="si">{</span><span class="n">varname</span><span class="si">!r}</span><span class="s2">] = </span><span class="si">{</span><span class="n">expr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">_compile_directive_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile `t-value` expressions into a python code as a list of strings.</span>

<span class="sd">        This method only check if this attributes is on the same node of a</span>
<span class="sd">         `t-set` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;t-value must be on the same node of t-set&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_directive_valuef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile `t-valuef` expressions into a python code as a list of strings.</span>

<span class="sd">        This method only check if this attributes is on the same node of a</span>
<span class="sd">         `t-set` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;t-valuef must be on the same node of t-set&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_directive_inner_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compiles the content of the element (is the technical `t-inner-content`</span>
<span class="sd">        directive created by QWeb) into a python code as a list of</span>
<span class="sd">        strings.</span>

<span class="sd">        The code will contains the text content of the node or the compliled</span>
<span class="sd">        code from the recursive call of ``_compile_node``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-inner-content&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">nsmap</span><span class="p">:</span>
            <span class="c1"># Update the dict of inherited namespaces before continuing the recursion. Note:</span>
            <span class="c1"># since `compile_context[&#39;nsmap&#39;]` is a dict (and therefore mutable) and we do **not**</span>
            <span class="c1"># want changes done in deeper recursion to bevisible in earlier ones, we&#39;ll pass</span>
            <span class="c1"># a copy before continuing the recursion and restore the original afterwards.</span>
            <span class="n">compile_context</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">compile_context</span><span class="p">,</span> <span class="n">nsmap</span><span class="o">=</span><span class="n">el</span><span class="o">.</span><span class="n">nsmap</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_append_text</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">el</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">etree</span><span class="o">.</span><span class="n">_Comment</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">compile_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;preserve_comments&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_append_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;!--</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">--&gt;&quot;</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">etree</span><span class="o">.</span><span class="n">_ProcessingInstruction</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">compile_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;preserve_comments&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_append_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;?</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">target</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">?&gt;&quot;</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">body</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_node</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
            <span class="c1"># comments can also contains tail text</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">tail</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_append_text</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">tail</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">body</span>

    <span class="k">def</span> <span class="nf">_compile_directive_if</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile `t-if` expressions into a python code as a list of strings.</span>

<span class="sd">        The code will contain the condition `if`, `else` and `elif` part that</span>
<span class="sd">        wrap the rest of the compiled code of this element.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-if&#39;</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-elif&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="n">expr</span><span class="o">.</span><span class="n">isspace</span><span class="p">(),</span> <span class="s1">&#39;t-if or t-elif expression should not be empty.&#39;</span>

        <span class="n">strip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rstrip_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">)</span>  <span class="c1"># the withspaces is visible only when display a content</span>
        <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span> <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">text</span> <span class="ow">and</span> <span class="n">LSTRIP_REGEXP</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">text</span><span class="p">):</span>
            <span class="n">strip</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># remove technical spaces</span>
        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_expr</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">strip</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_append_text</span><span class="p">(</span><span class="n">strip</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">)</span>
        <span class="n">body</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compile_directives</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_flush_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rstrip</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">body</span> <span class="ow">or</span> <span class="p">[</span><span class="n">indent_code</span><span class="p">(</span><span class="s1">&#39;pass&#39;</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>

        <span class="c1"># Look for the else or elif conditions</span>
        <span class="n">next_el</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">getnext</span><span class="p">()</span>
        <span class="n">comments_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">next_el</span><span class="p">,</span> <span class="n">etree</span><span class="o">.</span><span class="n">_Comment</span><span class="p">):</span>
            <span class="n">comments_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_el</span><span class="p">)</span>
            <span class="n">next_el</span> <span class="o">=</span> <span class="n">next_el</span><span class="o">.</span><span class="n">getnext</span><span class="p">()</span>

        <span class="c1"># If there is a t-else directive, the comment nodes are deleted</span>
        <span class="c1"># and the t-else or t-elif is validated.</span>
        <span class="k">if</span> <span class="n">next_el</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">{</span><span class="s1">&#39;t-else&#39;</span><span class="p">,</span> <span class="s1">&#39;t-elif&#39;</span><span class="p">}</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">next_el</span><span class="o">.</span><span class="n">attrib</span><span class="p">):</span>
            <span class="c1"># Insert a flag to allow t-else or t-elif rendering.</span>
            <span class="n">next_el</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;t-else-valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>

            <span class="c1"># remove comment node</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">getparent</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">comments_to_remove</span><span class="p">:</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">tail</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">el</span><span class="o">.</span><span class="n">tail</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;Unexpected non-whitespace characters between t-if and t-else directives&quot;</span><span class="p">)</span>
            <span class="n">el</span><span class="o">.</span><span class="n">tail</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># You have to render the `t-else` and `t-elif` here in order</span>
            <span class="c1"># to be able to put the log. Otherwise, the parent&#39;s</span>
            <span class="c1"># `t-inner-content`` directive will render the different</span>
            <span class="c1"># nodes without taking indentation into account such as:</span>
            <span class="c1">#    if (if_expression):</span>
            <span class="c1">#         content_if</span>
            <span class="c1">#    log [&#39;last_path_node&#39;] = path</span>
            <span class="c1">#    else:</span>
            <span class="c1">#       content_else</span>

            <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="s2">&quot;else:&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
            <span class="n">body</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">strip</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_append_text</span><span class="p">(</span><span class="n">strip</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">)</span>
            <span class="n">body</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compile_node</span><span class="p">(</span><span class="n">next_el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_flush_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rstrip</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">body</span> <span class="ow">or</span> <span class="p">[</span><span class="n">indent_code</span><span class="p">(</span><span class="s1">&#39;pass&#39;</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>

            <span class="c1"># Insert a flag to avoid the t-else or t-elif rendering when</span>
            <span class="c1"># the parent t-inner-content dirrective compile his</span>
            <span class="c1"># children.</span>
            <span class="n">next_el</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;t-qweb-skip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>

        <span class="k">return</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">_compile_directive_elif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile `t-elif` expressions into a python code as a list of</span>
<span class="sd">        strings. This method is linked with the `t-if` directive.</span>

<span class="sd">        Check if this directive is valide, the t-qweb-skip flag and call</span>
<span class="sd">        `t-if` directive</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-else-valid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;t-elif directive must be preceded by t-if or t-elif directive&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_directive_if</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_directive_else</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile `t-else` expressions into a python code as a list of strings.</span>
<span class="sd">        This method is linked with the `t-if` directive.</span>

<span class="sd">        Check if this directive is valide and add the t-qweb-skip flag.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-else-valid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;t-elif directive must be preceded by t-if or t-elif directive&quot;</span><span class="p">)</span>
        <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-else&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_compile_directive_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile `t-groups` expressions into a python code as a list of</span>
<span class="sd">        strings.</span>

<span class="sd">        The code will contain the condition `if self.user_has_groups(groups)`</span>
<span class="sd">        part that wrap the rest of the compiled code of this element.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-groups&#39;</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="n">strip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rstrip_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
        <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if self.user_has_groups(</span><span class="si">{</span><span class="n">groups</span><span class="si">!r}</span><span class="s2">):&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">strip</span> <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_append_text</span><span class="p">(</span><span class="n">strip</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">)</span>
        <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_directives</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
            <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_flush_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rstrip</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="p">]</span> <span class="ow">or</span> <span class="p">[</span><span class="n">indent_code</span><span class="p">(</span><span class="s1">&#39;pass&#39;</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">_compile_directive_foreach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile `t-foreach` expressions into a python code as a list of</span>
<span class="sd">        strings.</span>

<span class="sd">        `t-as` is used to define the key name.</span>
<span class="sd">        `t-foreach` compiled value can be an iterable, an dictionary or a</span>
<span class="sd">        number.</span>

<span class="sd">        The code will contain loop `for` that wrap the rest of the compiled</span>
<span class="sd">        code of this element.</span>
<span class="sd">        Some key into values dictionary are create automatically:</span>
<span class="sd">            *_size, *_index, *_value, *_first, *_last, *_odd, *_even, *_parity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expr_foreach</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-foreach&#39;</span><span class="p">)</span>
        <span class="n">expr_as</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-as&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr_as</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;t-as&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">VARNAME_REGEXP</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">expr_as</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The varname </span><span class="si">{</span><span class="n">expr_as</span><span class="si">!r}</span><span class="s1"> can only contain alphanumeric characters and underscores.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rstrip_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">)</span>

        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="n">content_foreach</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compile_directives</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_flush_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rstrip</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="n">t_foreach</span> <span class="o">=</span> <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;make_name&#39;</span><span class="p">](</span><span class="s1">&#39;t_foreach&#39;</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;make_name&#39;</span><span class="p">](</span><span class="s1">&#39;size&#39;</span><span class="p">)</span>
        <span class="n">has_value</span> <span class="o">=</span> <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;make_name&#39;</span><span class="p">](</span><span class="s1">&#39;has_value&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">expr_foreach</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                values[</span><span class="si">{</span><span class="n">expr_as</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;_size&#39;</span><span class="si">!r}</span><span class="s2">] = </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">expr_foreach</span><span class="p">)</span><span class="si">}</span>
<span class="s2">                </span><span class="si">{</span><span class="n">t_foreach</span><span class="si">}</span><span class="s2"> = range(</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">                </span><span class="si">{</span><span class="n">has_value</span><span class="si">}</span><span class="s2"> = False</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                </span><span class="si">{</span><span class="n">t_foreach</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_expr</span><span class="p">(</span><span class="n">expr_foreach</span><span class="p">)</span><span class="si">}</span><span class="s2"> or []</span>
<span class="s2">                if isinstance(</span><span class="si">{</span><span class="n">t_foreach</span><span class="si">}</span><span class="s2">, Sized):</span>
<span class="s2">                    values[</span><span class="si">{</span><span class="n">expr_as</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;_size&#39;</span><span class="si">!r}</span><span class="s2">] = </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> = len(</span><span class="si">{</span><span class="n">t_foreach</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">                elif (</span><span class="si">{</span><span class="n">t_foreach</span><span class="si">}</span><span class="s2">).__class__ == int:</span>
<span class="s2">                    values[</span><span class="si">{</span><span class="n">expr_as</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;_size&#39;</span><span class="si">!r}</span><span class="s2">] = </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">t_foreach</span><span class="si">}</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">t_foreach</span><span class="si">}</span><span class="s2"> = range(</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">                else:</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> = None</span>
<span class="s2">                </span><span class="si">{</span><span class="n">has_value</span><span class="si">}</span><span class="s2"> = False</span>
<span class="s2">                if isinstance(</span><span class="si">{</span><span class="n">t_foreach</span><span class="si">}</span><span class="s2">, Mapping):</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">t_foreach</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">t_foreach</span><span class="si">}</span><span class="s2">.items()</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">has_value</span><span class="si">}</span><span class="s2"> = True</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>

        <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                for index, item in enumerate(</span><span class="si">{</span><span class="n">t_foreach</span><span class="si">}</span><span class="s2">):</span>
<span class="s2">                    values[</span><span class="si">{</span><span class="n">expr_as</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;_index&#39;</span><span class="si">!r}</span><span class="s2">] = index</span>
<span class="s2">                    if </span><span class="si">{</span><span class="n">has_value</span><span class="si">}</span><span class="s2">:</span>
<span class="s2">                        values[</span><span class="si">{</span><span class="n">expr_as</span><span class="si">!r}</span><span class="s2">], values[</span><span class="si">{</span><span class="n">expr_as</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;_value&#39;</span><span class="si">!r}</span><span class="s2">] = item</span>
<span class="s2">                    else:</span>
<span class="s2">                        values[</span><span class="si">{</span><span class="n">expr_as</span><span class="si">!r}</span><span class="s2">] = values[</span><span class="si">{</span><span class="n">expr_as</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;_value&#39;</span><span class="si">!r}</span><span class="s2">] = item</span>
<span class="s2">                    values[</span><span class="si">{</span><span class="n">expr_as</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;_first&#39;</span><span class="si">!r}</span><span class="s2">] = values[</span><span class="si">{</span><span class="n">expr_as</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;_index&#39;</span><span class="si">!r}</span><span class="s2">] == 0</span>
<span class="s2">                    if </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> is not None:</span>
<span class="s2">                        values[</span><span class="si">{</span><span class="n">expr_as</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;_last&#39;</span><span class="si">!r}</span><span class="s2">] = index + 1 == </span><span class="si">{</span><span class="n">size</span><span class="si">}</span>
<span class="s2">                    values[</span><span class="si">{</span><span class="n">expr_as</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;_odd&#39;</span><span class="si">!r}</span><span class="s2">] = index % 2</span>
<span class="s2">                    values[</span><span class="si">{</span><span class="n">expr_as</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;_even&#39;</span><span class="si">!r}</span><span class="s2">] = not values[</span><span class="si">{</span><span class="n">expr_as</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;_odd&#39;</span><span class="si">!r}</span><span class="s2">]</span>
<span class="s2">                    values[</span><span class="si">{</span><span class="n">expr_as</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;_parity&#39;</span><span class="si">!r}</span><span class="s2">] = &#39;odd&#39; if values[</span><span class="si">{</span><span class="n">expr_as</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;_odd&#39;</span><span class="si">!r}</span><span class="s2">] else &#39;even&#39;</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>

        <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">content_foreach</span> <span class="ow">or</span> <span class="n">indent_code</span><span class="p">(</span><span class="s1">&#39;continue&#39;</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">_compile_directive_as</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile `t-as` expressions into a python code as a list of strings.</span>

<span class="sd">        This method only check if this attributes is on the same node of a</span>
<span class="sd">         `t-foreach` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;t-foreach&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;t-as must be on the same node of t-foreach&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_compile_directive_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile `t-out` expressions into a python code as a list of</span>
<span class="sd">        strings.</span>

<span class="sd">        The code will contain evalution and rendering of the compiled value. If</span>
<span class="sd">        the compiled value is None or False, the tag is not added to the render</span>
<span class="sd">        (Except if the widget forces rendering or there is default content).</span>
<span class="sd">        (eg: `&lt;t t-out=&quot;my_value&quot;&gt;Default content if falsy&lt;/t&gt;`)</span>

<span class="sd">        The output can have some rendering option with `t-options-widget` or</span>
<span class="sd">        `t-options={&#39;widget&#39;: ...}. At rendering time, The compiled code will</span>
<span class="sd">        call ``_get_widget`` method or ``_get_field`` method for `t-field`.</span>

<span class="sd">        A `t-field` will necessarily be linked to the value of a record field</span>
<span class="sd">        (eg: `&lt;span t-field=&quot;record.field_name&quot;/&gt;`), a t-out` can be applied</span>
<span class="sd">        to any value (eg: `&lt;span t-out=&quot;10&quot; t-options-widget=&quot;&#39;float&#39;&quot;/&gt;`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ttype</span> <span class="o">=</span> <span class="s1">&#39;t-out&#39;</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-out&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">expr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ttype</span> <span class="o">=</span> <span class="s1">&#39;t-field&#39;</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-field&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">expr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># deprecated use.</span>
                <span class="n">ttype</span> <span class="o">=</span> <span class="s1">&#39;t-esc&#39;</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-esc&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">expr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ttype</span> <span class="o">=</span> <span class="s1">&#39;t-raw&#39;</span>
                    <span class="n">expr</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-raw&#39;</span><span class="p">)</span>

        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="n">code_options</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-consumed-options&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">)</span>
        <span class="n">tag_open</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compile_directive</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="s1">&#39;tag-open&#39;</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_flush_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">tag_close</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compile_directive</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="s1">&#39;tag-close&#39;</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_flush_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">default_body</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compile_directive</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="s1">&#39;inner-content&#39;</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_flush_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># The generated code will set the values of the content, attrs (used to</span>
        <span class="c1"># output attributes) and the force_display (if the widget or field</span>
        <span class="c1"># mark force_display as True, the tag will be inserted in the output</span>
        <span class="c1"># even the value of content is None and without default value)</span>

        <span class="k">if</span> <span class="n">expr</span> <span class="o">==</span> <span class="n">T_CALL_SLOT</span> <span class="ow">and</span> <span class="n">code_options</span> <span class="o">!=</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
            <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="s2">&quot;if True:&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
            <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tag_open</span><span class="p">)</span>
            <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;yield from values.get(</span><span class="si">{</span><span class="n">T_CALL_SLOT</span><span class="si">}</span><span class="s2">, [])&quot;</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tag_close</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">code</span>
        <span class="k">elif</span> <span class="n">ttype</span> <span class="o">==</span> <span class="s1">&#39;t-field&#39;</span><span class="p">:</span>
            <span class="n">record</span><span class="p">,</span> <span class="n">field_name</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                field_attrs, content, force_display = self._get_field(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_expr</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="w"> </span><span class="n">raise_on_missing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">field_name</span><span class="si">!r}</span><span class="s2">, </span><span class="si">{</span><span class="n">expr</span><span class="si">!r}</span><span class="s2">, </span><span class="si">{</span><span class="n">el</span><span class="o">.</span><span class="n">tag</span><span class="si">!r}</span><span class="s2">, values.pop(&#39;__qweb_options__&#39;, </span><span class="se">{{}}</span><span class="s2">), values)</span>
<span class="s2">                if values.get(&#39;__qweb_attrs__&#39;) is None:</span>
<span class="s2">                    values[&#39;__qweb_attrs__&#39;] = field_attrs</span>
<span class="s2">                else:</span>
<span class="s2">                    values[&#39;__qweb_attrs__&#39;].update(field_attrs)</span>
<span class="s2">                if content is not None and content is not False:</span>
<span class="s2">                    content = self._compile_to_str(content)</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
            <span class="n">force_display_dependent</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">expr</span> <span class="o">==</span> <span class="n">T_CALL_SLOT</span><span class="p">:</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;content = Markup(&#39;&#39;.join(values.get(</span><span class="si">{</span><span class="n">T_CALL_SLOT</span><span class="si">}</span><span class="s2">, [])))&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;content = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_expr</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">code_options</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    widget_attrs, content, force_display = self._get_widget(content, </span><span class="si">{</span><span class="n">expr</span><span class="si">!r}</span><span class="s2">, </span><span class="si">{</span><span class="n">el</span><span class="o">.</span><span class="n">tag</span><span class="si">!r}</span><span class="s2">, values.pop(&#39;__qweb_options__&#39;, </span><span class="se">{{}}</span><span class="s2">), values)</span>
<span class="s2">                    if values.get(&#39;__qweb_attrs__&#39;) is None:</span>
<span class="s2">                        values[&#39;__qweb_attrs__&#39;] = widget_attrs</span>
<span class="s2">                    else:</span>
<span class="s2">                        values[&#39;__qweb_attrs__&#39;].update(widget_attrs)</span>
<span class="s2">                    content = self._compile_to_str(content)</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
                <span class="n">force_display_dependent</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">force_display_dependent</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">ttype</span> <span class="o">==</span> <span class="s1">&#39;t-raw&#39;</span><span class="p">:</span>
                <span class="c1"># deprecated use.</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    if content is not None and content is not False:</span>
<span class="s2">                        content = Markup(content)</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>

        <span class="c1"># The generated code will create the output tag with all attribute.</span>
        <span class="c1"># If the value is not falsy or if there is default content or if it&#39;s</span>
        <span class="c1"># in force_display mode, the tag is add into the output.</span>

        <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-tag&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># code generating the output is done here</span>

        <span class="c1"># generate code to display the tag if the value is not Falsy</span>

        <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="s2">&quot;if content is not None and content is not False:&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
        <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tag_open</span><span class="p">)</span>
        <span class="c1"># Use str to avoid the escaping of the other html content because the</span>
        <span class="c1"># yield generator MarkupSafe values will be join into an string in</span>
        <span class="c1"># `_render`.</span>
        <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="s2">&quot;yield str(escape(content))&quot;</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tag_close</span><span class="p">)</span>

        <span class="c1"># generate code to display the tag with default content if the value is</span>
        <span class="c1"># Falsy</span>

        <span class="k">if</span> <span class="n">default_body</span> <span class="ow">or</span> <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;_text_concat&#39;</span><span class="p">]:</span>
            <span class="n">_text_concat</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;_text_concat&#39;</span><span class="p">])</span>
            <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;_text_concat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="s2">&quot;else:&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
            <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tag_open</span><span class="p">)</span>
            <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">default_body</span><span class="p">)</span>
            <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;_text_concat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_text_concat</span><span class="p">)</span>
            <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tag_close</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">force_display_dependent</span><span class="p">:</span>

            <span class="c1"># generate code to display the tag if it&#39;s the force_diplay mode.</span>

            <span class="k">if</span> <span class="n">tag_open</span> <span class="o">+</span> <span class="n">tag_close</span><span class="p">:</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="s2">&quot;elif force_display:&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
                <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tag_open</span> <span class="o">+</span> <span class="n">tag_close</span><span class="p">)</span>

            <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;else: values.pop(&#39;__qweb_attrs__&#39;, None)&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">_compile_directive_esc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="c1"># deprecated use.</span>
        <span class="k">if</span> <span class="n">compile_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dev_mode&#39;</span><span class="p">):</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Found deprecated directive @t-esc=</span><span class="si">%r</span><span class="s2"> in template </span><span class="si">%r</span><span class="s2">. Replace by @t-out&quot;</span><span class="p">,</span>
                <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t-esc&#39;</span><span class="p">),</span>
                <span class="n">compile_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ref&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;unknown&gt;&#39;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_directive_out</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_directive_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="c1"># deprecated use.</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Found deprecated directive @t-raw=</span><span class="si">%r</span><span class="s2"> in template </span><span class="si">%r</span><span class="s2">. Replace by &quot;</span>
            <span class="s2">&quot;@t-out, and explicitely wrap content in `Markup` if &quot;</span>
            <span class="s2">&quot;necessary (which likely is not the case)&quot;</span><span class="p">,</span>
            <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t-raw&#39;</span><span class="p">),</span>
            <span class="n">compile_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ref&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;unknown&gt;&#39;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_directive_out</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_directive_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile `t-field` expressions into a python code as a list of</span>
<span class="sd">        strings.</span>

<span class="sd">        The compiled code will call ``_get_field`` method at rendering time</span>
<span class="sd">        using the type of value supplied by the field. This behavior can be</span>
<span class="sd">        changed with `t-options-widget` or `t-options={&#39;widget&#39;: ...}.</span>

<span class="sd">        The code will contain evalution and rendering of the compiled value</span>
<span class="sd">        value from the record field. If the compiled value is None or False,</span>
<span class="sd">        the tag is not added to the render</span>
<span class="sd">        (Except if the widget forces rendering or there is default content.).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tagName</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">tag</span>
        <span class="k">assert</span> <span class="n">tagName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">,</span> <span class="s2">&quot;tbody&quot;</span><span class="p">,</span> <span class="s2">&quot;thead&quot;</span><span class="p">,</span> <span class="s2">&quot;tfoot&quot;</span><span class="p">,</span> <span class="s2">&quot;tr&quot;</span><span class="p">,</span> <span class="s2">&quot;td&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;li&quot;</span><span class="p">,</span> <span class="s2">&quot;ul&quot;</span><span class="p">,</span> <span class="s2">&quot;ol&quot;</span><span class="p">,</span> <span class="s2">&quot;dl&quot;</span><span class="p">,</span> <span class="s2">&quot;dt&quot;</span><span class="p">,</span> <span class="s2">&quot;dd&quot;</span><span class="p">),</span>\
            <span class="s2">&quot;QWeb widgets do not work correctly on </span><span class="si">%r</span><span class="s2"> elements&quot;</span> <span class="o">%</span> <span class="n">tagName</span>
        <span class="k">assert</span> <span class="n">tagName</span> <span class="o">!=</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span>\
            <span class="s2">&quot;t-field can not be used on a t element, provide an actual HTML node&quot;</span>
        <span class="k">assert</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t-field&#39;</span><span class="p">),</span>\
            <span class="s2">&quot;t-field must have at least a dot like &#39;record.field_name&#39;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_directive_out</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_directive_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile `t-call` expressions into a python code as a list of</span>
<span class="sd">        strings.</span>

<span class="sd">        `t-call` allow formating string dynamic at rendering time.</span>
<span class="sd">        Can use `t-options` used to call and render the sub-template at</span>
<span class="sd">        rendering time.</span>
<span class="sd">        The sub-template is called with a copy of the rendering values</span>
<span class="sd">        dictionary. The dictionary contains the key 0 coming from the</span>
<span class="sd">        compilation of the contents of this element</span>

<span class="sd">        The code will contain the call of the template and a function from the</span>
<span class="sd">        compilation of the content of this element.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-call&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t-call-options&#39;</span><span class="p">):</span> <span class="c1"># retro-compatibility</span>
            <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;t-options&#39;</span><span class="p">,</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-call-options&#39;</span><span class="p">))</span>

        <span class="n">nsmap</span> <span class="o">=</span> <span class="n">compile_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nsmap&#39;</span><span class="p">)</span>

        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">rstrip</span><span class="o">=</span><span class="n">el</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span><span class="p">)</span>

        <span class="c1"># options</span>
        <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-consumed-options&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="s2">&quot;t_call_options = values.pop(&#39;__qweb_options__&#39;, </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nsmap</span><span class="p">:</span>
            <span class="c1"># update this dict with the current nsmap so that the callee know</span>
            <span class="c1"># if he outputting the xmlns attributes is relevenat or not</span>
            <span class="n">nsmap</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;nsmap&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">nsmap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">!r}</span><span class="s1">:</span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nsmap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;None:</span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;t_call_options.update(nsmap=</span><span class="se">{{</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nsmap</span><span class="p">)</span><span class="si">}</span><span class="se">}}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>

        <span class="c1"># values (t-out=&quot;0&quot; from content and variables from t-set)</span>
        <span class="n">def_name</span> <span class="o">=</span> <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;make_name&#39;</span><span class="p">](</span><span class="s1">&#39;t_call&#39;</span><span class="p">)</span>

        <span class="c1"># values from content (t-out=&quot;0&quot; and t-set inside the content)</span>
        <span class="n">code_content</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;def </span><span class="si">{</span><span class="n">def_name</span><span class="si">}</span><span class="s2">(self, values):&quot;</span><span class="p">]</span>
        <span class="n">code_content</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_directive</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="s1">&#39;inner-content&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_append_text</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">)</span> <span class="c1"># To ensure the template function is a generator and doesn&#39;t become a regular function</span>
        <span class="n">code_content</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_flush_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rstrip</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;template_functions&#39;</span><span class="p">][</span><span class="n">def_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">code_content</span>

        <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            t_call_values = values.copy()</span>
<span class="s2">            t_call_values[</span><span class="si">{</span><span class="n">T_CALL_SLOT</span><span class="si">}</span><span class="s2">] = list(</span><span class="si">{</span><span class="n">def_name</span><span class="si">}</span><span class="s2">(self, t_call_values))</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>

        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_format</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>

        <span class="c1"># call</span>
        <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            irQweb = self.with_context(**t_call_options)</span>
<span class="s2">            template = </span><span class="si">{</span><span class="n">template</span><span class="si">}</span>
<span class="s2">            if template.isnumeric():</span>
<span class="s2">                template = int(template)</span>
<span class="s2">            t_call_template_functions, def_name = irQweb._compile(template)</span>
<span class="s2">            render_template = t_call_template_functions[def_name]</span>
<span class="s2">            yield from render_template(irQweb, t_call_values)</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">_compile_directive_lang</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;t-call&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;t-lang is an alias of t-options-lang but only available on the same node of t-call&quot;</span><span class="p">)</span>
        <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;t-options-lang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-lang&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_node</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compile_directive_call_assets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; This special &#39;t-call-assets&#39; tag can be used in order to aggregate/minify javascript and css assets&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;t-call-assets cannot contain children nodes&quot;</span><span class="p">)</span>

        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
        <span class="n">xmlid</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-call-assets&#39;</span><span class="p">)</span>
        <span class="n">css</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_bool</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-css&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
        <span class="n">js</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_bool</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-js&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
        <span class="c1"># async_load support was removed</span>
        <span class="n">defer_load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_bool</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;defer_load&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="n">lazy_load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_bool</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;lazy_load&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="n">media</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;media&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            t_call_assets_nodes = self._get_asset_nodes(</span>
<span class="s2">                </span><span class="si">{</span><span class="n">xmlid</span><span class="si">!r}</span><span class="s2">,</span>
<span class="s2">                css=</span><span class="si">{</span><span class="n">css</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                js=</span><span class="si">{</span><span class="n">js</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                debug=values.get(&quot;debug&quot;),</span>
<span class="s2">                defer_load=</span><span class="si">{</span><span class="n">defer_load</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                lazy_load=</span><span class="si">{</span><span class="n">lazy_load</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                media=</span><span class="si">{</span><span class="n">media</span><span class="si">!r}</span><span class="s2">,</span>
<span class="s2">            )</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">level</span><span class="p">))</span>

        <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            for index, (tagName, asset_attrs) in enumerate(t_call_assets_nodes):</span>
<span class="s2">                if index:</span>
<span class="s2">                    yield &#39;</span><span class="se">\\</span><span class="s2">n        &#39;</span>
<span class="s2">                yield &#39;&lt;&#39;</span>
<span class="s2">                yield tagName</span>

<span class="s2">                attrs = self._post_processing_att(tagName, asset_attrs)</span>
<span class="s2">                for name, value in attrs.items():</span>
<span class="s2">                    if value or isinstance(value, str):</span>
<span class="s2">                        yield f&#39; {escape(str(name))}=&quot;{escape(str(value))}&quot;&#39;</span>

<span class="s2">                if tagName in VOID_ELEMENTS:</span>
<span class="s2">                    yield &#39;/&gt;&#39;</span>
<span class="s2">                else:</span>
<span class="s2">                    yield &#39;&gt;&#39;</span>
<span class="s2">                    yield &#39;&lt;/&#39;</span>
<span class="s2">                    yield tagName</span>
<span class="s2">                    yield &#39;&gt;&#39;</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">_compile_directive_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile the `t-cache` tuple expression into a key cache.</span>

<span class="sd">        The `t-cache` directive allows you to keep the rendered result</span>
<span class="sd">        of a template part. The supplied key must be a tuple. This tuple</span>
<span class="sd">        can contain recordset in this case the zone will be invalidated</span>
<span class="sd">        each time the write_date of these records changes.</span>
<span class="sd">        The values are scoped into the `t-cache` and are not available</span>
<span class="sd">        outside.</span>
<span class="sd">        see: `t-nocache`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-cache&#39;</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="n">def_name</span> <span class="o">=</span> <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;make_name&#39;</span><span class="p">](</span><span class="s1">&#39;t_cache&#39;</span><span class="p">)</span>

        <span class="c1"># Generate the content function</span>
        <span class="n">def_code</span> <span class="o">=</span> <span class="p">[</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;def </span><span class="si">{</span><span class="n">def_name</span><span class="si">}</span><span class="s2">(self, values):&quot;&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
        <span class="n">def_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_directives</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">def_content</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;_text_concat&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_append_text</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">)</span> <span class="c1"># To ensure the template function is a generator and doesn&#39;t become a regular function</span>
        <span class="n">def_code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">def_content</span><span class="p">)</span>
        <span class="n">def_code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_flush_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;template_functions&#39;</span><span class="p">][</span><span class="n">def_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">def_code</span>

        <span class="c1"># Get the dynamic key for the cache and load the content.</span>
        <span class="c1"># The t-nocache yield a tuple (ref, function name) instead of a</span>
        <span class="c1"># When reading tuple coming from t-nocache, we check if the</span>
        <span class="c1"># method is already known otherwise the corresponding template</span>
        <span class="c1"># and its functions are loaded.</span>
        <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            template_cache_key = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_expr</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="si">}</span><span class="s2"> if not self.env.context.get(&#39;is_t_cache_disabled&#39;) else None</span>
<span class="s2">            cache_key = self._get_cache_key(template_cache_key) if template_cache_key else None</span>
<span class="s2">            uniq_cache_key = cache_key and (</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;__qweb_base_key_cache&#39;</span><span class="p">])</span><span class="si">!r}</span><span class="s2">, &#39;</span><span class="si">{</span><span class="n">def_name</span><span class="si">}</span><span class="s2">_cache&#39;, cache_key)</span>
<span class="s2">            loaded_values = values[&#39;__qweb_loaded_values&#39;]</span>
<span class="s2">            def </span><span class="si">{</span><span class="n">def_name</span><span class="si">}</span><span class="s2">_cache():</span>
<span class="s2">                content = []</span>
<span class="s2">                text = []</span>
<span class="s2">                for item in </span><span class="si">{</span><span class="n">def_name</span><span class="si">}</span><span class="s2">(self, </span><span class="se">{{</span><span class="s2">**values, &#39;__qweb_in_cache&#39;: True</span><span class="se">}}</span><span class="s2">):</span>
<span class="s2">                    if isinstance(item, str):</span>
<span class="s2">                        text.append(item)</span>
<span class="s2">                    else:</span>
<span class="s2">                        content.append(&#39;&#39;.join(text))</span>
<span class="s2">                        content.append(item)</span>
<span class="s2">                        text = []</span>
<span class="s2">                if text:</span>
<span class="s2">                    content.append(&#39;&#39;.join(text))</span>
<span class="s2">                return content</span>
<span class="s2">            cache_content = self._load_values(uniq_cache_key, </span><span class="si">{</span><span class="n">def_name</span><span class="si">}</span><span class="s2">_cache, loaded_values)</span>
<span class="s2">            if values.get(&#39;__qweb_in_cache&#39;):</span>
<span class="s2">                yield from cache_content</span>
<span class="s2">            else:</span>
<span class="s2">                for item in cache_content:</span>
<span class="s2">                    if isinstance(item, str):</span>
<span class="s2">                        yield item</span>
<span class="s2">                    else:</span>
<span class="s2">                        ref, function_name, cached_values = item</span>
<span class="s2">                        t_nocache_function = loaded_values.get(function_name)</span>
<span class="s2">                        if not t_nocache_function:</span>
<span class="s2">                            t_call_template_functions, def_name = self._compile(ref)</span>
<span class="s2">                            t_nocache_function = t_call_template_functions[function_name]</span>

<span class="s2">                        nocache_values = values[&#39;__qweb_root_values&#39;].copy()</span>
<span class="s2">                        nocache_values.update(cached_values)</span>
<span class="s2">                        yield &#39;&#39;.join(t_nocache_function(self, nocache_values))</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">code</span>

    <span class="k">def</span> <span class="nf">_compile_directive_nocache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The `t-nocache` directive makes it possible to force rendering</span>
<span class="sd">        of a part even if it is in a `t-cache`. The values available in</span>
<span class="sd">        the `t-nocache` are the one provided when calling the template</span>
<span class="sd">        (and therefore ignores any t-set that could have been done).</span>

<span class="sd">        The `t-nocache-*` are the values whose result of the</span>
<span class="sd">        expression will be cached and added to the root&#39;s values when</span>
<span class="sd">        rendering the no cache part. Only primitive types can be cached.</span>

<span class="sd">        see: `t-cache`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;t-nocache&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;t-nocache-* must be on the same node as t-nocache&quot;</span><span class="p">)</span>

        <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;t-nocache&#39;</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>

        <span class="c1"># t-nocache-* will generate the values to put in cache</span>
        <span class="c1"># must cosume this attributes before generate the cached content.</span>
        <span class="n">code_cache_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;t-nocache-&#39;</span><span class="p">):</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">varname</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">10</span><span class="p">:]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">VARNAME_REGEXP</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">varname</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The varname </span><span class="si">{</span><span class="n">varname</span><span class="si">!r}</span><span class="s1"> can only contain alphanumeric characters and underscores.&#39;</span><span class="p">)</span>
                <span class="n">code_cache_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    cached_value = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_compile_expr</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="si">}</span>
<span class="s2">                    if cached_value is not None and not isinstance(cached_value, (str, int, float, bool)):</span>
<span class="s2">                        raise ValueError(f&#39;&#39;&#39;The value type of </span><span class="si">{</span><span class="n">key</span><span class="si">!r}</span><span class="s2"> cannot be cached: </span><span class="se">{{</span><span class="s2">cached_value!r</span><span class="se">}}</span><span class="s2">&#39;&#39;&#39;)</span>
<span class="s2">                    cached_values[</span><span class="si">{</span><span class="n">varname</span><span class="si">!r}</span><span class="s2">] = cached_value</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># generate the cached content method</span>
        <span class="n">def_name</span> <span class="o">=</span> <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;make_name&#39;</span><span class="p">](</span><span class="s1">&#39;t_nocache&#39;</span><span class="p">)</span>
        <span class="n">def_code</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;def </span><span class="si">{</span><span class="n">def_name</span><span class="si">}</span><span class="s2">(self, values):&quot;</span><span class="p">]</span>
        <span class="n">def_code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="s2">&quot;try:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">def_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_directives</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">def_content</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;_text_concat&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_append_text</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">compile_context</span><span class="p">)</span> <span class="c1"># To ensure the template function is a generator and doesn&#39;t become a regular function</span>
        <span class="n">def_code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">def_content</span><span class="p">)</span>
        <span class="n">def_code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_flush_text</span><span class="p">(</span><span class="n">compile_context</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">def_code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                except QWebException:</span>
<span class="s2">                    raise</span>
<span class="s2">                except Exception as e:</span>
<span class="s2">                    raise QWebException(&quot;Error while render the template&quot;,</span>
<span class="s2">                        self, template, ref=</span><span class="si">{</span><span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span><span class="si">!r}</span><span class="s2">, code=code) from e</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;template_functions&#39;</span><span class="p">][</span><span class="n">def_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">def_code</span>

        <span class="c1"># if the nocache is inside a cache return a tuple with the method name and the cached values</span>
        <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            if values.get(&#39;__qweb_in_cache&#39;):</span>
<span class="s2">                cached_values = </span><span class="si">{}</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
        <span class="n">code</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">code_cache_values</span><span class="p">)</span>
        <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;yield (</span><span class="si">{</span><span class="n">compile_context</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">]</span><span class="si">!r}</span><span class="s2">, </span><span class="si">{</span><span class="n">def_name</span><span class="si">!r}</span><span class="s2">, cached_values)&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="c1"># else render the content</span>
        <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent_code</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            else:</span>
<span class="s2">                yield from </span><span class="si">{</span><span class="n">def_name</span><span class="si">}</span><span class="s2">(self, values)</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">code</span>

    <span class="c1"># methods called by the compiled function at rendering time.</span>

    <span class="k">def</span> <span class="nf">_debug_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debugger</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method called at running time to load debugger.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">debugger</span><span class="p">:</span>
            <span class="nb">breakpoint</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">debugger</span> <span class="ow">in</span> <span class="n">SUPPORTED_DEBUGGER</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Using t-debug with an explicit debugger is deprecated &quot;</span>
                <span class="s2">&quot;since Odoo 17.0, keep the value empty and configure the &quot;</span>
                <span class="s2">&quot;``breakpoint`` builtin instead.&quot;</span><span class="p">,</span>
                <span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nb">__import__</span><span class="p">(</span><span class="n">debugger</span><span class="p">)</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unsupported t-debug value: </span><span class="si">{</span><span class="n">debugger</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_post_processing_att</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tagName</span><span class="p">,</span> <span class="n">atts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method called at compile time for the static node and called at</span>
<span class="sd">            runing time for the dynamic attributes.</span>

<span class="sd">            This method may be overwrited to filter or modify the attributes</span>
<span class="sd">            (during compilation for static node or after they compilation in</span>
<span class="sd">            the case of dynamic elements).</span>

<span class="sd">            @returns dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">atts</span>

    <span class="k">def</span> <span class="nf">_get_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">tagName</span><span class="p">,</span> <span class="n">field_options</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method called at compile time to return the field value.</span>

<span class="sd">        :returns: tuple:</span>
<span class="sd">            * dict: attributes</span>
<span class="sd">            * string or None: content</span>
<span class="sd">            * boolean: force_display display the tag if the content and default_content are None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>

        <span class="c1"># adds generic field options</span>
        <span class="n">field_options</span><span class="p">[</span><span class="s1">&#39;tagName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tagName</span>
        <span class="n">field_options</span><span class="p">[</span><span class="s1">&#39;expression&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expression</span>
        <span class="n">field_options</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;widget&#39;</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="n">inherit_branding</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;inherit_branding&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;inherit_branding&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span>
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inherit_branding_auto&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">record</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;write&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="n">field_options</span><span class="p">[</span><span class="s1">&#39;inherit_branding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inherit_branding</span>
        <span class="n">translate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;edit_translations&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;translatable&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span>
        <span class="n">field_options</span><span class="p">[</span><span class="s1">&#39;translate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">translate</span>

        <span class="c1"># field converter</span>
        <span class="n">model</span> <span class="o">=</span> <span class="s1">&#39;ir.qweb.field.&#39;</span> <span class="o">+</span> <span class="n">field_options</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="n">converter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb.field&#39;</span><span class="p">]</span>

        <span class="c1"># get content (the return values from fields are considered to be markup safe)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">record_to_html</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_options</span><span class="p">)</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">attributes</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_options</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">inherit_branding</span> <span class="ow">or</span> <span class="n">translate</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">tagName</span><span class="p">,</span> <span class="n">field_options</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method called at compile time to return the widget value.</span>

<span class="sd">        :returns: tuple:</span>
<span class="sd">            * dict: attributes</span>
<span class="sd">            * string or None: content</span>
<span class="sd">            * boolean: force_display display the tag if the content and default_content are None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_options</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_options</span><span class="p">[</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span>
        <span class="n">field_options</span><span class="p">[</span><span class="s1">&#39;tagName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tagName</span>
        <span class="n">field_options</span><span class="p">[</span><span class="s1">&#39;expression&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expression</span>
        <span class="n">inherit_branding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inherit_branding&#39;</span><span class="p">)</span>
        <span class="n">field_options</span><span class="p">[</span><span class="s1">&#39;inherit_branding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inherit_branding</span>

        <span class="c1"># field converter</span>
        <span class="n">model</span> <span class="o">=</span> <span class="s1">&#39;ir.qweb.field.&#39;</span> <span class="o">+</span> <span class="n">field_options</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="n">converter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb.field&#39;</span><span class="p">]</span>

        <span class="c1"># get content (the return values from widget are considered to be markup safe)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">value_to_html</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">field_options</span><span class="p">)</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;data-oe-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_options</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;data-oe-expression&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_options</span><span class="p">[</span><span class="s1">&#39;expression&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">inherit_branding</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_asset_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">css</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">js</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">defer_load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lazy_load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">media</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates asset nodes.</span>
<span class="sd">        If debug=assets, the assets will be regenerated when a file which composes them has been modified.</span>
<span class="sd">        Else, the assets will be generated only once and then stored in cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">media</span> <span class="o">=</span> <span class="n">css</span> <span class="ow">and</span> <span class="n">media</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="n">links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset_links</span><span class="p">(</span><span class="n">bundle</span><span class="p">,</span> <span class="n">css</span><span class="o">=</span><span class="n">css</span><span class="p">,</span> <span class="n">js</span><span class="o">=</span><span class="n">js</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_links_to_nodes</span><span class="p">(</span><span class="n">links</span><span class="p">,</span> <span class="n">defer_load</span><span class="o">=</span><span class="n">defer_load</span><span class="p">,</span> <span class="n">lazy_load</span><span class="o">=</span><span class="n">lazy_load</span><span class="p">,</span> <span class="n">media</span><span class="o">=</span><span class="n">media</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_asset_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">css</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">js</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates asset nodes.</span>
<span class="sd">        If debug=assets, the assets will be regenerated when a file which composes them has been modified.</span>
<span class="sd">        Else, the assets will be generated only once and then stored in cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rtl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.lang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">_lang_get_direction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">lang</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;rtl&#39;</span>
        <span class="n">assets_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_params</span><span class="p">()</span> <span class="c1"># website_id</span>
        <span class="n">debug_assets</span> <span class="o">=</span> <span class="n">debug</span> <span class="ow">and</span> <span class="s1">&#39;assets&#39;</span> <span class="ow">in</span> <span class="n">debug</span>

        <span class="k">if</span> <span class="n">debug_assets</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_asset_links</span><span class="p">(</span><span class="n">bundle</span><span class="p">,</span> <span class="n">css</span><span class="o">=</span><span class="n">css</span><span class="p">,</span> <span class="n">js</span><span class="o">=</span><span class="n">js</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">assets_params</span><span class="o">=</span><span class="n">assets_params</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="n">rtl</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_asset_links_cache</span><span class="p">(</span><span class="n">bundle</span><span class="p">,</span> <span class="n">css</span><span class="o">=</span><span class="n">css</span><span class="p">,</span> <span class="n">js</span><span class="o">=</span><span class="n">js</span><span class="p">,</span> <span class="n">assets_params</span><span class="o">=</span><span class="n">assets_params</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="n">rtl</span><span class="p">)</span>

    <span class="c1"># qweb cache feature</span>

    <span class="k">def</span> <span class="nf">_get_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Convert the template cache key item into a hashable key.</span>
<span class="sd">            :param cache_key: tuple</span>
<span class="sd">            :returns: tuple of hashable items</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">cache_key</span><span class="p">,)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cache_key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># use try catch instead of isinstance to detect lazy values</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">ids</span><span class="p">))</span>
                <span class="n">dates</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;write_date&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dates</span><span class="p">:</span>
                    <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">,</span> <span class="n">get_value</span><span class="p">,</span> <span class="n">loaded_values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; generate value from the function if the result is not cached. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cache_key</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">get_value</span><span class="p">()</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">loaded_values</span> <span class="ow">and</span> <span class="n">loaded_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cached_values</span><span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">get_value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loaded_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loaded_values</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="c1"># The cache does not need to be invalidated if the &#39;base_key_cache&#39;</span>
    <span class="c1"># in &#39;_compile&#39; method contains the write_date of all inherited views.</span>
    <span class="nd">@tools</span><span class="o">.</span><span class="n">conditional</span><span class="p">(</span>
        <span class="s1">&#39;xml&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dev_mode&#39;</span><span class="p">],</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">ormcache</span><span class="p">(</span><span class="s1">&#39;cache_key&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="s1">&#39;templates.cached_values&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_cached_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_key</span><span class="p">,</span> <span class="n">get_value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; generate value from the function if the result is not cached. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">get_value</span><span class="p">()</span>

    <span class="c1"># other methods used for the asset bundles</span>
    <span class="nd">@tools</span><span class="o">.</span><span class="n">conditional</span><span class="p">(</span>
        <span class="c1"># in non-xml-debug mode we want assets to be cached forever, and the admin can force a cache clear</span>
        <span class="c1"># by restarting the server after updating the source code (or using the &quot;Clear server cache&quot; in debug tools)</span>
        <span class="s1">&#39;xml&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dev_mode&#39;</span><span class="p">],</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">ormcache</span><span class="p">(</span><span class="s1">&#39;bundle&#39;</span><span class="p">,</span> <span class="s1">&#39;css&#39;</span><span class="p">,</span> <span class="s1">&#39;js&#39;</span><span class="p">,</span> <span class="s1">&#39;tuple(sorted(assets_params.items()))&#39;</span><span class="p">,</span> <span class="s1">&#39;rtl&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="s1">&#39;assets&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_generate_asset_links_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">css</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">js</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">assets_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_asset_links</span><span class="p">(</span><span class="n">bundle</span><span class="p">,</span> <span class="n">css</span><span class="p">,</span> <span class="n">js</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">assets_params</span><span class="p">,</span> <span class="n">rtl</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_asset_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">assets_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">assets_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">assets_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_params</span><span class="p">()</span>  <span class="c1"># website_id</span>
        <span class="n">asset_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_paths</span><span class="p">(</span><span class="n">bundle</span><span class="o">=</span><span class="n">bundle</span><span class="p">,</span> <span class="n">assets_params</span><span class="o">=</span><span class="n">assets_params</span><span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">external_asset</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">full_path</span><span class="p">,</span> <span class="n">_bundle</span><span class="p">,</span> <span class="n">last_modified</span> <span class="ow">in</span> <span class="n">asset_paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">full_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">EXTERNAL_ASSET</span><span class="p">:</span>
                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>
                    <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">full_path</span><span class="p">,</span>
                    <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;last_modified&#39;</span><span class="p">:</span> <span class="n">last_modified</span><span class="p">,</span>
                <span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">external_asset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">external_asset</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_asset_bundle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle_name</span><span class="p">,</span> <span class="n">css</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">js</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">assets_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">assets_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">assets_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_params</span><span class="p">()</span>
        <span class="n">files</span><span class="p">,</span> <span class="n">external_assets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset_content</span><span class="p">(</span><span class="n">bundle_name</span><span class="p">,</span> <span class="n">assets_params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">AssetsBundle</span><span class="p">(</span><span class="n">bundle_name</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">external_assets</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">css</span><span class="o">=</span><span class="n">css</span><span class="p">,</span> <span class="n">js</span><span class="o">=</span><span class="n">js</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="n">debug_assets</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="n">rtl</span><span class="p">,</span> <span class="n">assets_params</span><span class="o">=</span><span class="n">assets_params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_links_to_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">defer_load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lazy_load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">media</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_link_to_node</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">defer_load</span><span class="o">=</span><span class="n">defer_load</span><span class="p">,</span> <span class="n">lazy_load</span><span class="o">=</span><span class="n">lazy_load</span><span class="p">,</span> <span class="n">media</span><span class="o">=</span><span class="n">media</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_link_to_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">defer_load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lazy_load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">media</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">path</span> <span class="k">else</span> <span class="s1">&#39;js&#39;</span>
        <span class="n">is_js</span> <span class="o">=</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">SCRIPT_EXTENSIONS</span>
        <span class="n">is_xml</span> <span class="o">=</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">TEMPLATE_EXTENSIONS</span>
        <span class="n">is_css</span> <span class="o">=</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">STYLE_EXTENSIONS</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_js</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_xml</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_css</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">is_js</span><span class="p">:</span>
            <span class="n">is_asset_bundle</span> <span class="o">=</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/web/assets/&#39;</span><span class="p">)</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;text/javascript&#39;</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">defer_load</span> <span class="ow">or</span> <span class="n">lazy_load</span><span class="p">):</span>
                <span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;defer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;defer&#39;</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lazy_load</span><span class="p">:</span>
                    <span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;data-src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>

            <span class="k">if</span> <span class="n">is_asset_bundle</span><span class="p">:</span>
                <span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;onerror&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;__odooAssetError=1&quot;</span>

            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">is_css</span><span class="p">:</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;text/</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="c1"># we don&#39;t really expect to have anything else than pure css here</span>
                <span class="s1">&#39;rel&#39;</span><span class="p">:</span> <span class="s1">&#39;stylesheet&#39;</span><span class="p">,</span>
                <span class="s1">&#39;href&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>
                <span class="s1">&#39;media&#39;</span><span class="p">:</span> <span class="n">media</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;link&#39;</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_xml</span><span class="p">:</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;text/xml&#39;</span><span class="p">,</span>
                <span class="s1">&#39;async&#39;</span><span class="p">:</span> <span class="s1">&#39;async&#39;</span><span class="p">,</span>
                <span class="s1">&#39;rel&#39;</span><span class="p">:</span> <span class="s1">&#39;prefetch&#39;</span><span class="p">,</span>
                <span class="s1">&#39;data-src&#39;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_generate_asset_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">css</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">js</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">assets_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">asset_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="n">bundle</span><span class="p">,</span> <span class="n">css</span><span class="o">=</span><span class="n">css</span><span class="p">,</span> <span class="n">js</span><span class="o">=</span><span class="n">js</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="n">debug_assets</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="n">rtl</span><span class="p">,</span> <span class="n">assets_params</span><span class="o">=</span><span class="n">assets_params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">asset_bundle</span><span class="o">.</span><span class="n">get_links</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_asset_link_urls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">asset_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset_nodes</span><span class="p">(</span><span class="n">bundle</span><span class="p">,</span> <span class="n">js</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;href&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">asset_nodes</span> <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;link&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_pregenerate_assets_bundles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pregenerates all assets that may be used in web pages to speedup first loading.</span>
<span class="sd">        This may is mainly usefull for tests.</span>

<span class="sd">        The current version is looking for all t-call-assets in view to generate the minimal</span>
<span class="sd">        set of bundles to generate.</span>

<span class="sd">        Current version only generate assets without extra, not taking care of rtl.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">runbot</span><span class="p">(</span><span class="s1">&#39;Pregenerating assets bundles&#39;</span><span class="p">)</span>

        <span class="n">js_bundles</span><span class="p">,</span> <span class="n">css_bundles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bundles_to_pregenarate</span><span class="p">()</span>

        <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">bundle</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">js_bundles</span><span class="p">):</span>
            <span class="n">links</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="n">bundle</span><span class="p">,</span> <span class="n">css</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">js</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;JS Assets bundles generated in </span><span class="si">%s</span><span class="s1"> seconds&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">bundle</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">css_bundles</span><span class="p">):</span>
            <span class="n">links</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="n">bundle</span><span class="p">,</span> <span class="n">css</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">js</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CSS Assets bundles generated in </span><span class="si">%s</span><span class="s1"> seconds&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">links</span>

    <span class="k">def</span> <span class="nf">_get_bundles_to_pregenarate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the list of bundles to pregenerate.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">views</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;qweb&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;arch_db&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;t-call-assets&#39;</span><span class="p">)])</span>
        <span class="n">js_bundles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">css_bundles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="n">views</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">call_asset</span> <span class="ow">in</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">arch_db</span><span class="p">)</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&quot;//*[@t-call-assets]&quot;</span><span class="p">):</span>
                <span class="n">asset</span> <span class="o">=</span> <span class="n">call_asset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t-call-assets&#39;</span><span class="p">)</span>
                <span class="n">js</span> <span class="o">=</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">call_asset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t-js&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">))</span>
                <span class="n">css</span> <span class="o">=</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">call_asset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t-css&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">js</span><span class="p">:</span>
                    <span class="n">js_bundles</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">css</span><span class="p">:</span>
                    <span class="n">css_bundles</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">js_bundles</span><span class="p">,</span> <span class="n">css_bundles</span><span class="p">)</span></div>


<div class="viewcode-block" id="render">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_qweb.render">[docs]</a>
<span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">load</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Rendering of a qweb template without database and outside the registry.</span>
<span class="sd">    (Widget, field, or asset rendering is not implemented.)</span>
<span class="sd">    :param (string|int) template_name: template identifier</span>
<span class="sd">    :param dict values: template values to be used for rendering</span>
<span class="sd">    :param def load: function like `load(template_name)` which returns an etree</span>
<span class="sd">        from the given template name (from initial rendering or template</span>
<span class="sd">        `t-call`).</span>
<span class="sd">    :param options: used to compile the template</span>
<span class="sd">    :returns: bytes marked as markup-safe (decode to :class:`markupsafe.Markup`</span>
<span class="sd">                instead of `str`)</span>
<span class="sd">    :rtype: MarkupSafe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">MockPool</span><span class="p">:</span>
        <span class="n">db_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">_Registry__caches</span> <span class="o">=</span> <span class="p">{</span><span class="n">cache_name</span><span class="p">:</span> <span class="n">LRU</span><span class="p">(</span><span class="n">cache_size</span><span class="p">)</span> <span class="k">for</span> <span class="n">cache_name</span><span class="p">,</span> <span class="n">cache_size</span> <span class="ow">in</span> <span class="n">registry</span><span class="o">.</span><span class="n">_REGISTRY_CACHES</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">_Registry__caches_groups</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cache_name</span><span class="p">,</span> <span class="n">cache</span> <span class="ow">in</span> <span class="n">_Registry__caches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_Registry__caches_groups</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">cache_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span>


    <span class="k">class</span> <span class="nc">MockIrQWeb</span><span class="p">(</span><span class="n">IrQWeb</span><span class="p">):</span>
        <span class="n">_register</span> <span class="o">=</span> <span class="kc">False</span>               <span class="c1"># not visible in real registry</span>

        <span class="n">pool</span> <span class="o">=</span> <span class="n">MockPool</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Load the template referenced by ``ref``.</span>

<span class="sd">            :returns: The loaded template (as string or etree) and its</span>
<span class="sd">                identifier</span>
<span class="sd">            :rtype: Tuple[Union[etree, str], Optional[str, int]]</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;load&#39;</span><span class="p">](</span><span class="n">ref</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_prepare_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
            <span class="n">values</span><span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">values</span><span class="p">[</span><span class="s1">&#39;false&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">is_t_cache_disabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">__qweb_loaded_values</span><span class="o">=</span><span class="p">{})</span>

        <span class="k">def</span> <span class="nf">_get_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Fields are not allowed in this rendering mode. Please use </span><span class="se">\&quot;</span><span class="s2">env[&#39;ir.qweb&#39;]._render</span><span class="se">\&quot;</span><span class="s2"> method&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_get_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Widgets are not allowed in this rendering mode. Please use </span><span class="se">\&quot;</span><span class="s2">env[&#39;ir.qweb&#39;]._render</span><span class="se">\&quot;</span><span class="s2"> method&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_get_asset_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Assets are not allowed in this rendering mode. Please use </span><span class="se">\&quot;</span><span class="s2">env[&#39;ir.qweb&#39;]._render</span><span class="se">\&quot;</span><span class="s2"> method&quot;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">MockEnv</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">su</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot; Return an mocked environment based and update the sent context.</span>
<span class="sd">                Allow to use `ir_qweb.with_context` with sand boxed qweb.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">env</span> <span class="o">=</span> <span class="n">MockEnv</span><span class="p">()</span>
            <span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">env</span>

    <span class="n">renderer</span> <span class="o">=</span> <span class="n">MockIrQWeb</span><span class="p">(</span><span class="n">MockEnv</span><span class="p">(),</span> <span class="nb">tuple</span><span class="p">(),</span> <span class="nb">tuple</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">renderer</span><span class="o">.</span><span class="n">_render</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="n">load</span><span class="p">,</span> <span class="n">minimal_qcontext</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Amr.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>