<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>odoo.addons.base.models.ir_ui_view &mdash; Amr  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Amr
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modules.html">odoo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Amr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../../odoo.html">odoo</a></li>
          <li class="breadcrumb-item"><a href="../../base.html">odoo.addons.base</a></li>
      <li class="breadcrumb-item active">odoo.addons.base.models.ir_ui_view</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for odoo.addons.base.models.ir_ui_view</h1><div class="highlight"><pre>
<span></span><span class="c1"># Part of Odoo. See LICENSE file for full copyright and licensing details.</span>

<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>

<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
<span class="kn">from</span> <span class="nn">lxml.etree</span> <span class="kn">import</span> <span class="n">LxmlError</span>
<span class="kn">from</span> <span class="nn">lxml.builder</span> <span class="kn">import</span> <span class="n">E</span>

<span class="kn">import</span> <span class="nn">odoo</span>
<span class="kn">from</span> <span class="nn">odoo</span> <span class="kn">import</span> <span class="n">api</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">tools</span><span class="p">,</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">odoo.exceptions</span> <span class="kn">import</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="n">AccessError</span><span class="p">,</span> <span class="n">UserError</span>
<span class="kn">from</span> <span class="nn">odoo.http</span> <span class="kn">import</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">odoo.modules.module</span> <span class="kn">import</span> <span class="n">get_resource_from_path</span>
<span class="kn">from</span> <span class="nn">odoo.tools</span> <span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">ConstantMapping</span><span class="p">,</span> <span class="n">get_diff</span><span class="p">,</span> <span class="n">pycompat</span><span class="p">,</span> <span class="n">apply_inheritance_specs</span><span class="p">,</span> <span class="n">locate_node</span><span class="p">,</span> <span class="n">str2bool</span>
<span class="kn">from</span> <span class="nn">odoo.tools</span> <span class="kn">import</span> <span class="n">safe_eval</span><span class="p">,</span> <span class="n">lazy</span><span class="p">,</span> <span class="n">lazy_property</span><span class="p">,</span> <span class="n">frozendict</span>
<span class="kn">from</span> <span class="nn">odoo.tools.convert</span> <span class="kn">import</span> <span class="n">_fix_multiple_roots</span>
<span class="kn">from</span> <span class="nn">odoo.tools.misc</span> <span class="kn">import</span> <span class="n">file_path</span>
<span class="kn">from</span> <span class="nn">odoo.tools.translate</span> <span class="kn">import</span> <span class="n">xml_translate</span><span class="p">,</span> <span class="n">TRANSLATED_ATTRS</span>
<span class="kn">from</span> <span class="nn">odoo.tools.view_validation</span> <span class="kn">import</span> <span class="n">valid_view</span><span class="p">,</span> <span class="n">get_domain_value_names</span><span class="p">,</span> <span class="n">get_expression_field_names</span><span class="p">,</span> <span class="n">get_dict_asts</span>
<span class="kn">from</span> <span class="nn">odoo.models</span> <span class="kn">import</span> <span class="n">check_method_name</span>
<span class="kn">from</span> <span class="nn">odoo.osv.expression</span> <span class="kn">import</span> <span class="n">expression</span>

<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">MOVABLE_BRANDING</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data-oe-model&#39;</span><span class="p">,</span> <span class="s1">&#39;data-oe-id&#39;</span><span class="p">,</span> <span class="s1">&#39;data-oe-field&#39;</span><span class="p">,</span> <span class="s1">&#39;data-oe-xpath&#39;</span><span class="p">,</span> <span class="s1">&#39;data-oe-source-id&#39;</span><span class="p">]</span>
<span class="n">VIEW_MODIFIERS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;column_invisible&#39;</span><span class="p">,</span> <span class="s1">&#39;invisible&#39;</span><span class="p">,</span> <span class="s1">&#39;readonly&#39;</span><span class="p">,</span> <span class="s1">&#39;required&#39;</span><span class="p">)</span>

<span class="c1"># Some views have a js compiler that generates an owl template from the arch. In that template,</span>
<span class="c1"># `__comp__` is a reserved keyword giving access to the component instance (e.g. the form renderer</span>
<span class="c1"># or the kanban record). However, we don&#39;t want to see implementation details leaking in archs, so</span>
<span class="c1"># we use the following regex to detect the use of `__comp__` in dynamic attributes, to forbid it.</span>
<span class="n">COMP_REGEX</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(^|[^\w])\s*__comp__\s*([^\w]|$)&#39;</span>

<span class="n">ref_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2"># first match &#39;form_view_ref&#39; key, backrefs are used to handle single or</span>
<span class="s2"># double quoting of the value</span>
<span class="s2">([&#39;&quot;])(?P&lt;view_type&gt;\w+_view_ref)\1</span>
<span class="s2"># colon separator (with optional spaces around)</span>
<span class="s2">\s*:\s*</span>
<span class="s2"># open quote for value</span>
<span class="s2">([&#39;&quot;])</span>
<span class="s2">(?P&lt;view_id&gt;</span>
<span class="s2">    # we&#39;ll just match stuff which is normally part of an xid:</span>
<span class="s2">    # word and &quot;.&quot; characters</span>
<span class="s2">    [.\w]+</span>
<span class="s2">)</span>
<span class="s2"># close with same quote as opening</span>
<span class="s2">\3</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>


<div class="viewcode-block" id="att_names">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.att_names">[docs]</a>
<span class="k">def</span> <span class="nf">att_names</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">yield</span> <span class="n">name</span>
    <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;t-att-</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;t-attf-</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span></div>



<span class="nd">@lazy</span>
<span class="k">def</span> <span class="nf">keep_query</span><span class="p">():</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">odoo</span><span class="o">.</span><span class="n">addons</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">ir_qweb</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;keep_query has been moved to </span><span class="si">{</span><span class="n">mod</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mod</span><span class="o">.</span><span class="n">keep_query</span>


<div class="viewcode-block" id="ViewCustom">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.ViewCustom">[docs]</a>
<span class="k">class</span> <span class="nc">ViewCustom</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;ir.ui.view.custom&#39;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s1">&#39;Custom View&#39;</span>
    <span class="n">_order</span> <span class="o">=</span> <span class="s1">&#39;create_date desc&#39;</span>  <span class="c1"># search(limit=1) should return the last customization</span>
    <span class="n">_rec_name</span> <span class="o">=</span> <span class="s1">&#39;user_id&#39;</span>
    <span class="n">_allow_sudo_commands</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">ref_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Original View&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;cascade&#39;</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;res.users&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;cascade&#39;</span><span class="p">)</span>
    <span class="n">arch</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;View Architecture&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_auto_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ViewCustom</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_auto_init</span><span class="p">()</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span> <span class="s1">&#39;ir_ui_view_custom_user_id_ref_id&#39;</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;ref_id&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">res</span></div>



<span class="k">def</span> <span class="nf">_hasclass</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="o">*</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Checks if the context node has all the classes passed as arguments</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">node_classes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">context_node</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">node_classes</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>


<div class="viewcode-block" id="get_view_arch_from_file">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.get_view_arch_from_file">[docs]</a>
<span class="k">def</span> <span class="nf">get_view_arch_from_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">xmlid</span><span class="p">):</span>
    <span class="n">module</span><span class="p">,</span> <span class="n">view_id</span> <span class="o">=</span> <span class="n">xmlid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

    <span class="n">xpath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;//*[@id=&#39;</span><span class="si">{</span><span class="n">xmlid</span><span class="si">}</span><span class="s2">&#39; or @id=&#39;</span><span class="si">{</span><span class="n">view_id</span><span class="si">}</span><span class="s2">&#39;]&quot;</span>
    <span class="c1"># when view is created from model with inheritS of ir_ui_view, the</span>
    <span class="c1"># xmlid has been suffixed by &#39;_ir_ui_view&#39;. We need to also search</span>
    <span class="c1"># for views without this prefix.</span>
    <span class="k">if</span> <span class="n">view_id</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_ir_ui_view&#39;</span><span class="p">):</span>
        <span class="c1"># len(&#39;_ir_ui_view&#39;) == 11</span>
        <span class="n">xpath</span> <span class="o">=</span> <span class="n">xpath</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; or @id=&#39;</span><span class="si">{</span><span class="n">xmlid</span><span class="p">[:</span><span class="o">-</span><span class="mi">11</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; or @id=&#39;</span><span class="si">{</span><span class="n">view_id</span><span class="p">[:</span><span class="o">-</span><span class="mi">11</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;]&quot;</span>

    <span class="n">document</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">document</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">xpath</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;record&#39;</span><span class="p">:</span>
            <span class="n">field_arch</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;field[@name=&quot;arch&quot;]&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field_arch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_fix_multiple_roots</span><span class="p">(</span><span class="n">field_arch</span><span class="p">)</span>
                <span class="n">inner</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;unicode&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">field_arch</span><span class="o">.</span><span class="n">iterchildren</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">field_arch</span><span class="o">.</span><span class="n">text</span> <span class="o">+</span> <span class="n">inner</span>

            <span class="n">field_view</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;field[@name=&quot;view_id&quot;]&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field_view</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ref_module</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">ref_view_id</span> <span class="o">=</span> <span class="n">field_view</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ref&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="n">ref_xmlid</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ref_module</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">module</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">ref_view_id</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">return</span> <span class="n">get_view_arch_from_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">ref_xmlid</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;template&#39;</span><span class="p">:</span>
            <span class="c1"># The following dom operations has been copied from convert.py&#39;s _tag_template()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inherit_id&#39;</span><span class="p">):</span>
                <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;t-name&#39;</span><span class="p">,</span> <span class="n">xmlid</span><span class="p">)</span>
                <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;t&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span>
            <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;unicode&#39;</span><span class="p">)</span>

    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not find view arch definition in file &#39;</span><span class="si">%s</span><span class="s2">&#39; for xmlid &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">xmlid</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>



<span class="n">xpath_utils</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">FunctionNamespace</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">xpath_utils</span><span class="p">[</span><span class="s1">&#39;hasclass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_hasclass</span>

<span class="n">TRANSLATED_ATTRS_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;@(</span><span class="si">%s</span><span class="s2">)\b&quot;</span> <span class="o">%</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TRANSLATED_ATTRS</span><span class="p">))</span>
<span class="n">WRONGCLASS</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(@class\s*=|=\s*@class|contains\(@class)&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="View">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.View">[docs]</a>
<span class="k">class</span> <span class="nc">View</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;ir.ui.view&#39;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s1">&#39;View&#39;</span>
    <span class="n">_order</span> <span class="o">=</span> <span class="s2">&quot;priority,name,id&quot;</span>
    <span class="n">_allow_sudo_commands</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;View Name&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;btree_not_null&#39;</span><span class="p">)</span>
    <span class="n">priority</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Integer</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Sequence&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Selection</span><span class="p">([(</span><span class="s1">&#39;tree&#39;</span><span class="p">,</span> <span class="s1">&#39;Tree&#39;</span><span class="p">),</span>
                             <span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="s1">&#39;Form&#39;</span><span class="p">),</span>
                             <span class="p">(</span><span class="s1">&#39;graph&#39;</span><span class="p">,</span> <span class="s1">&#39;Graph&#39;</span><span class="p">),</span>
                             <span class="p">(</span><span class="s1">&#39;pivot&#39;</span><span class="p">,</span> <span class="s1">&#39;Pivot&#39;</span><span class="p">),</span>
                             <span class="p">(</span><span class="s1">&#39;calendar&#39;</span><span class="p">,</span> <span class="s1">&#39;Calendar&#39;</span><span class="p">),</span>
                             <span class="p">(</span><span class="s1">&#39;gantt&#39;</span><span class="p">,</span> <span class="s1">&#39;Gantt&#39;</span><span class="p">),</span>
                             <span class="p">(</span><span class="s1">&#39;kanban&#39;</span><span class="p">,</span> <span class="s1">&#39;Kanban&#39;</span><span class="p">),</span>
                             <span class="p">(</span><span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="s1">&#39;Search&#39;</span><span class="p">),</span>
                             <span class="p">(</span><span class="s1">&#39;qweb&#39;</span><span class="p">,</span> <span class="s1">&#39;QWeb&#39;</span><span class="p">)],</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;View Type&#39;</span><span class="p">)</span>
    <span class="n">arch</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_arch&#39;</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="s1">&#39;_inverse_arch&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;View Architecture&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;This field should be used when accessing view arch. It will use translation.</span>
<span class="s2">                               Note that it will read `arch_db` or `arch_fs` if in dev-xml mode.&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">arch_base</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_arch_base&#39;</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="s1">&#39;_inverse_arch_base&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Base View Architecture&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;This field is the same as `arch` field without translations&quot;</span><span class="p">)</span>
    <span class="n">arch_db</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Arch Blob&#39;</span><span class="p">,</span> <span class="n">translate</span><span class="o">=</span><span class="n">xml_translate</span><span class="p">,</span>
                          <span class="n">help</span><span class="o">=</span><span class="s2">&quot;This field stores the view arch.&quot;</span><span class="p">)</span>
    <span class="n">arch_fs</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Arch Filename&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;File from where the view originates.</span>
<span class="s2">                                                          Useful to (hard) reset broken views or to read arch from file in dev-xml mode.&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">arch_updated</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Modified Architecture&#39;</span><span class="p">)</span>
    <span class="n">arch_prev</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Previous View Architecture&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;This field will save the current `arch_db` before writing on it.</span>
<span class="s2">                                                                         Useful to (soft) reset a broken view.&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">inherit_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Inherited View&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;restrict&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">inherit_children_ids</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">One2many</span><span class="p">(</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">,</span> <span class="s1">&#39;inherit_id&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Views which inherit from this one&#39;</span><span class="p">)</span>
    <span class="n">model_data_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s2">&quot;Model Data&quot;</span><span class="p">,</span>
                                    <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_model_data_id&#39;</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="s1">&#39;_search_model_data_id&#39;</span><span class="p">)</span>
    <span class="n">xml_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s2">&quot;External ID&quot;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_xml_id&#39;</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s2">&quot;ID of the view defined in xml file&quot;</span><span class="p">)</span>
    <span class="n">groups_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2many</span><span class="p">(</span><span class="s1">&#39;res.groups&#39;</span><span class="p">,</span> <span class="s1">&#39;ir_ui_view_group_rel&#39;</span><span class="p">,</span> <span class="s1">&#39;view_id&#39;</span><span class="p">,</span> <span class="s1">&#39;group_id&#39;</span><span class="p">,</span>
                                 <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Groups&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If this field is empty, the view applies to all users. Otherwise, the view applies to the users of those groups only.&quot;</span><span class="p">)</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Selection</span><span class="p">([(</span><span class="s1">&#39;primary&#39;</span><span class="p">,</span> <span class="s2">&quot;Base view&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;extension&#39;</span><span class="p">,</span> <span class="s2">&quot;Extension View&quot;</span><span class="p">)],</span>
                            <span class="n">string</span><span class="o">=</span><span class="s2">&quot;View inheritance mode&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Only applies if this view inherits from an other one (inherit_id is not False/Null).</span>

<span class="s2">* if extension (default), if this view is requested the closest primary view</span>
<span class="s2">is looked up (via inherit_id), then all views inheriting from it with this</span>
<span class="s2">view&#39;s model are applied</span>
<span class="s2">* if primary, the closest primary view is fully resolved (even if it uses a</span>
<span class="s2">different model than this one), then this view&#39;s inheritance specs</span>
<span class="s2">(&lt;xpath/&gt;) are applied, and the result is used as if it were this view&#39;s</span>
<span class="s2">actual arch.</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># The &quot;active&quot; field is not updated during updates if &lt;template&gt; is used</span>
    <span class="c1"># instead of &lt;record&gt; to define the view in XML, see _tag_template. For</span>
    <span class="c1"># qweb views, you should not rely on the active field being updated anyway</span>
    <span class="c1"># as those views, if used in frontend layouts, can be duplicated (see COW)</span>
    <span class="c1"># and will thus always require upgrade scripts if you really want to change</span>
    <span class="c1"># the default value of their &quot;active&quot; field.</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;If this view is inherited,</span>
<span class="s2">* if True, the view always extends its parent</span>
<span class="s2">* if False, the view currently does not extend its parent but can be enabled</span>
<span class="s2">         &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">model_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s2">&quot;ir.model&quot;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s2">&quot;Model of the view&quot;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_model_id&#39;</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="s1">&#39;_inverse_compute_model_id&#39;</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;arch_db&#39;</span><span class="p">,</span> <span class="s1">&#39;arch_fs&#39;</span><span class="p">,</span> <span class="s1">&#39;arch_updated&#39;</span><span class="p">)</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">depends_context</span><span class="p">(</span><span class="s1">&#39;read_arch_from_file&#39;</span><span class="p">,</span> <span class="s1">&#39;lang&#39;</span><span class="p">,</span> <span class="s1">&#39;edit_translations&#39;</span><span class="p">,</span> <span class="s1">&#39;check_translations&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_arch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">resolve_external_ids</span><span class="p">(</span><span class="n">arch_fs</span><span class="p">,</span> <span class="n">view_xml_id</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">replacer</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                <span class="n">xmlid</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;xmlid&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xmlid</span><span class="p">:</span>
                    <span class="n">xmlid</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">view_xml_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xmlid</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;prefix&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_xmlid_to_res_id</span><span class="p">(</span><span class="n">xmlid</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?P&lt;prefix&gt;[^%])%\((?P&lt;xmlid&gt;.*?)\)[ds]&#39;</span><span class="p">,</span> <span class="n">replacer</span><span class="p">,</span> <span class="n">arch_fs</span><span class="p">)</span>

        <span class="n">lang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span> <span class="ow">or</span> <span class="s1">&#39;en_US&#39;</span>
        <span class="n">env_en</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">edit_translations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="s1">&#39;en_US&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">env</span>
        <span class="n">env_lang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="n">lang</span><span class="p">)</span><span class="o">.</span><span class="n">env</span>
        <span class="n">field_arch_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;arch_db&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">arch_fs</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">read_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;read_arch_from_file&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="s1">&#39;xml&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dev_mode&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">view</span><span class="o">.</span><span class="n">arch_updated</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">read_file</span> <span class="ow">and</span> <span class="n">view</span><span class="o">.</span><span class="n">arch_fs</span> <span class="ow">and</span> <span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">xml_id</span> <span class="ow">or</span> <span class="n">view</span><span class="o">.</span><span class="n">key</span><span class="p">):</span>
                <span class="n">xml_id</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">xml_id</span> <span class="ow">or</span> <span class="n">view</span><span class="o">.</span><span class="n">key</span>
                <span class="c1"># It is safe to split on / herebelow because arch_fs is explicitely stored with &#39;/&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fullpath</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">arch_fs</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;View </span><span class="si">%s</span><span class="s2">: Full path [</span><span class="si">%s</span><span class="s2">] cannot be found.&quot;</span><span class="p">,</span> <span class="n">xml_id</span><span class="p">,</span> <span class="n">view</span><span class="o">.</span><span class="n">arch_fs</span><span class="p">)</span>
                    <span class="n">arch_fs</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">continue</span>

                <span class="n">arch_fs</span> <span class="o">=</span> <span class="n">get_view_arch_from_file</span><span class="p">(</span><span class="n">fullpath</span><span class="p">,</span> <span class="n">xml_id</span><span class="p">)</span>
                <span class="c1"># replace %(xml_id)s, %(xml_id)d, %%(xml_id)s, %%(xml_id)d by the res_id</span>
                <span class="k">if</span> <span class="n">arch_fs</span><span class="p">:</span>
                    <span class="n">arch_fs</span> <span class="o">=</span> <span class="n">resolve_external_ids</span><span class="p">(</span><span class="n">arch_fs</span><span class="p">,</span> <span class="n">xml_id</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
                    <span class="n">translation_dictionary</span> <span class="o">=</span> <span class="n">field_arch_db</span><span class="o">.</span><span class="n">get_translation_dictionary</span><span class="p">(</span>
                        <span class="n">view</span><span class="o">.</span><span class="n">with_env</span><span class="p">(</span><span class="n">env_en</span><span class="p">)</span><span class="o">.</span><span class="n">arch_db</span><span class="p">,</span> <span class="p">{</span><span class="n">lang</span><span class="p">:</span> <span class="n">view</span><span class="o">.</span><span class="n">with_env</span><span class="p">(</span><span class="n">env_lang</span><span class="p">)</span><span class="o">.</span><span class="n">arch_db</span><span class="p">}</span>
                    <span class="p">)</span>
                    <span class="n">arch_fs</span> <span class="o">=</span> <span class="n">field_arch_db</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">term</span><span class="p">:</span> <span class="n">translation_dictionary</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="n">lang</span><span class="p">],</span>
                        <span class="n">arch_fs</span>
                    <span class="p">)</span>
            <span class="n">view</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">to_text</span><span class="p">(</span><span class="n">arch_fs</span> <span class="ow">or</span> <span class="n">view</span><span class="o">.</span><span class="n">arch_db</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_inverse_arch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">arch_db</span><span class="o">=</span><span class="n">view</span><span class="o">.</span><span class="n">arch</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;install_filename&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">:</span>
                <span class="c1"># we store the relative path to the resource instead of the absolute path, if found</span>
                <span class="c1"># (it will be missing e.g. when importing data-only modules using base_import_module)</span>
                <span class="n">path_info</span> <span class="o">=</span> <span class="n">get_resource_from_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">[</span><span class="s1">&#39;install_filename&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">path_info</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;arch_fs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_info</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;arch_updated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">view</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># the xml_translate will clean the arch_db when write (e.g. (&#39;&lt;div&gt;&#39;) -&gt; (&#39;&lt;div&gt;&lt;/div&gt;&#39;))</span>
            <span class="c1"># view.arch should be reassigned here</span>
            <span class="n">view</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">arch_db</span>
        <span class="c1"># the field &#39;arch&#39; depends on the context and has been implicitly</span>
        <span class="c1"># modified in all languages; the invalidation below ensures that the</span>
        <span class="c1"># field does not keep an old value in another environment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invalidate_recordset</span><span class="p">([</span><span class="s1">&#39;arch&#39;</span><span class="p">])</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;arch&#39;</span><span class="p">)</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">depends_context</span><span class="p">(</span><span class="s1">&#39;read_arch_from_file&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_arch_base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># &#39;arch_base&#39; is the same as &#39;arch&#39; without translation</span>
        <span class="k">for</span> <span class="n">view</span><span class="p">,</span> <span class="n">view_wo_lang</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="kc">None</span><span class="p">)):</span>
            <span class="n">view</span><span class="o">.</span><span class="n">arch_base</span> <span class="o">=</span> <span class="n">view_wo_lang</span><span class="o">.</span><span class="n">arch</span>

    <span class="k">def</span> <span class="nf">_inverse_arch_base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">view</span><span class="p">,</span> <span class="n">view_wo_lang</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="kc">None</span><span class="p">)):</span>
            <span class="n">view_wo_lang</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">arch_base</span>

<div class="viewcode-block" id="View.reset_arch">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.View.reset_arch">[docs]</a>
    <span class="k">def</span> <span class="nf">reset_arch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;soft&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Reset the view arch to its previous arch (soft) or its XML file arch</span>
<span class="sd">        if exists (hard).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">arch</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;soft&#39;</span><span class="p">:</span>
                <span class="n">arch</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">arch_prev</span>
            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;hard&#39;</span> <span class="ow">and</span> <span class="n">view</span><span class="o">.</span><span class="n">arch_fs</span><span class="p">:</span>
                <span class="n">arch</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">read_arch_from_file</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">arch</span>
            <span class="k">if</span> <span class="n">arch</span><span class="p">:</span>
                <span class="c1"># Don&#39;t save current arch in previous since we reset, this arch is probably broken</span>
                <span class="n">view</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">no_save_prev</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;arch_db&#39;</span><span class="p">:</span> <span class="n">arch</span><span class="p">})</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;write_date&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_model_data_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># get the first ir_model_data record corresponding to self</span>
        <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">view</span><span class="o">.</span><span class="n">model_data_id</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;ir.ui.view&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">search_read</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;res_id&#39;</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;id desc&#39;</span><span class="p">):</span>
            <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;res_id&#39;</span><span class="p">])</span>
            <span class="n">view</span><span class="o">.</span><span class="n">model_data_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_search_model_data_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;name&#39;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;id&#39;</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;ir.ui.view&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">value</span><span class="p">)]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;res_id&#39;</span><span class="p">))]</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_model_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">record</span><span class="o">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_inverse_compute_model_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">record</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">model_id</span><span class="o">.</span><span class="n">model</span>

    <span class="k">def</span> <span class="nf">_compute_xml_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">xml_ids</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;ir.ui.view&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">search_read</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;res_id&#39;</span><span class="p">]):</span>
            <span class="n">xml_ids</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;res_id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">view</span><span class="o">.</span><span class="n">xml_id</span> <span class="o">=</span> <span class="n">xml_ids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_valid_inheritance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arch</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Check whether view inheritance is based on translated attribute. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">arch</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//*[@position]&#39;</span><span class="p">):</span>
            <span class="c1"># inheritance may not use a translated attribute as selector</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;xpath&#39;</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">TRANSLATED_ATTRS_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expr&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;View inheritance may not use attribute </span><span class="si">%r</span><span class="s2"> as a selector.&quot;</span> <span class="o">%</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">WRONGCLASS</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expr&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)):</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Error-prone use of @class in view </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">): use the &quot;</span>
                        <span class="s2">&quot;hasclass(*classes) function to filter elements by &quot;</span>
                        <span class="s2">&quot;their classes&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_id</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">TRANSLATED_ATTRS</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;View inheritance may not use attribute </span><span class="si">%r</span><span class="s2"> as a selector.&quot;</span> <span class="o">%</span> <span class="n">attr</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="s1">&#39;arch_db&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Sanity checks: the view should not break anything upon rendering!</span>
        <span class="c1"># Any exception raised below will cause a transaction rollback.</span>
        <span class="n">partial_validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ir_ui_view_partial_validation&#39;</span><span class="p">)</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">validate_view_ids</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span> <span class="k">if</span> <span class="n">partial_validation</span> <span class="k">else</span> <span class="kc">True</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># verify the view is valid xml and that the inheritance resolves</span>
                <span class="k">if</span> <span class="n">view</span><span class="o">.</span><span class="n">inherit_id</span><span class="p">:</span>
                    <span class="n">view_arch</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">arch</span><span class="p">)</span>
                    <span class="n">view</span><span class="o">.</span><span class="n">_valid_inheritance</span><span class="p">(</span><span class="n">view_arch</span><span class="p">)</span>
                <span class="n">combined_arch</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">_get_combined_arch</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">view</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;qweb&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">ParseError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;Error while parsing or validating view:</span><span class="se">\n\n</span><span class="si">%(error)s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">error</span><span class="o">=</span><span class="n">tools</span><span class="o">.</span><span class="n">ustr</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="n">view</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="p">))</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span>
                <span class="n">err</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">err</span> <span class="kn">from</span> <span class="kc">None</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># verify that all fields used are valid, etc.</span>
                <span class="n">view</span><span class="o">.</span><span class="n">_validate_view</span><span class="p">(</span><span class="n">combined_arch</span><span class="p">,</span> <span class="n">view</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
                <span class="n">combined_archs</span> <span class="o">=</span> <span class="p">[</span><span class="n">combined_arch</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">combined_arch</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//*[@attrs]&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">combined_arch</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//*[@states]&#39;</span><span class="p">):</span>
                    <span class="n">view_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">view</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">view</span><span class="o">.</span><span class="n">xml_id</span><span class="si">}</span><span class="s1">)&#39;</span> <span class="k">if</span> <span class="n">view</span><span class="o">.</span><span class="n">xml_id</span> <span class="k">else</span> <span class="n">view</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Since 17.0, the &quot;attrs&quot; and &quot;states&quot; attributes are no longer used.</span><span class="se">\n</span><span class="s1">View: </span><span class="si">%(name)s</span><span class="s1"> in </span><span class="si">%(file)s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">view_name</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">view</span><span class="o">.</span><span class="n">arch_fs</span>
                    <span class="p">))</span>
                    <span class="n">err</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;invalid view&#39;</span><span class="p">}</span>
                    <span class="k">raise</span> <span class="n">err</span>

                <span class="k">if</span> <span class="n">combined_archs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span>
                    <span class="c1"># A &lt;data&gt; element is a wrapper for multiple root nodes</span>
                    <span class="n">combined_archs</span> <span class="o">=</span> <span class="n">combined_archs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">view_arch</span> <span class="ow">in</span> <span class="n">combined_archs</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">view_arch</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//*[@__validate__]&#39;</span><span class="p">):</span>
                        <span class="k">del</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;__validate__&#39;</span><span class="p">]</span>
                    <span class="n">check</span> <span class="o">=</span> <span class="n">valid_view</span><span class="p">(</span><span class="n">view_arch</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">view</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">check</span><span class="p">:</span>
                        <span class="n">view_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">view</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">view</span><span class="o">.</span><span class="n">xml_id</span><span class="si">}</span><span class="s1">)&#39;</span> <span class="k">if</span> <span class="n">view</span><span class="o">.</span><span class="n">xml_id</span> <span class="k">else</span> <span class="n">view</span><span class="o">.</span><span class="n">name</span>
                        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                            <span class="s1">&#39;Invalid view </span><span class="si">%(name)s</span><span class="s1"> definition in </span><span class="si">%(file)s</span><span class="s1">&#39;</span><span class="p">,</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">view_name</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">view</span><span class="o">.</span><span class="n">arch_fs</span>
                        <span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;context&#39;</span><span class="p">):</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">combined_arch</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;unicode&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">fivelines</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;line&quot;</span><span class="p">]</span><span class="o">-</span><span class="mi">3</span><span class="p">):</span><span class="n">e</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;line&quot;</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;Error while validating view near:</span><span class="se">\n\n</span><span class="si">%(fivelines)s</span><span class="se">\n</span><span class="si">%(error)s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">fivelines</span><span class="o">=</span><span class="n">fivelines</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">tools</span><span class="o">.</span><span class="n">ustr</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                    <span class="p">))</span>
                    <span class="n">err</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">context</span>
                    <span class="k">raise</span> <span class="n">err</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">err</span> <span class="o">=</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;Error while validating view (</span><span class="si">%(view)s</span><span class="s2">):</span><span class="se">\n\n</span><span class="si">%(error)s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">tools</span><span class="o">.</span><span class="n">ustr</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__context__</span><span class="p">),</span>
                    <span class="p">))</span>
                    <span class="n">err</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;invalid view&#39;</span><span class="p">}</span>
                    <span class="k">raise</span> <span class="n">err</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__context__</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;groups_id&#39;</span><span class="p">,</span> <span class="s1">&#39;inherit_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">groups_id</span> <span class="ow">and</span>
                <span class="n">view</span><span class="o">.</span><span class="n">inherit_id</span> <span class="ow">and</span>
                <span class="n">view</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s1">&#39;primary&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Inherited view cannot have &#39;Groups&#39; define on the record. Use &#39;groups&#39; attributes inside the view definition&quot;</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="s1">&#39;inherit_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_000_inheritance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># NOTE: constraints methods are check alphabetically. Always ensure this method will be</span>
        <span class="c1">#       called before other constraint methods to avoid infinite loop in `_get_combined_arch`.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_recursion</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="s1">&#39;inherit_id&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;You cannot create recursive inherited views.&#39;</span><span class="p">))</span>

    <span class="n">_sql_constraints</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;inheritance_mode&#39;</span><span class="p">,</span>
         <span class="s2">&quot;CHECK (mode != &#39;extension&#39; OR inherit_id IS NOT NULL)&quot;</span><span class="p">,</span>
         <span class="s2">&quot;Invalid inheritance mode: if the mode is &#39;extension&#39;, the view must&quot;</span>
         <span class="s2">&quot; extend an other view&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;qweb_required_key&#39;</span><span class="p">,</span>
         <span class="s2">&quot;CHECK (type != &#39;qweb&#39; OR key IS NOT NULL)&quot;</span><span class="p">,</span>
         <span class="s2">&quot;Invalid key: QWeb view should have a key&quot;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_auto_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">View</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_auto_init</span><span class="p">()</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span> <span class="s1">&#39;ir_ui_view_model_type_inherit_id&#39;</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;inherit_id&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">_compute_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;inherit_id&#39;</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="c1"># Do not automatically change the mode if the view already has an inherit_id,</span>
            <span class="c1"># and the user change it to another.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;inherit_id&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="nb">all</span><span class="p">(</span><span class="ow">not</span> <span class="n">view</span><span class="o">.</span><span class="n">inherit_id</span> <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">):</span>
                <span class="n">values</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;extension&#39;</span> <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;inherit_id&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;primary&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span>

<div class="viewcode-block" id="View.create">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.View.create">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model_create_multi</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">vals_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;arch_db&#39;</span> <span class="ow">in</span> <span class="n">values</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;arch_db&#39;</span><span class="p">]:</span>
                <span class="c1"># delete empty arch_db to avoid triggering _check_xml before _inverse_arch_base is called</span>
                <span class="k">del</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;arch_db&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inherit_id&#39;</span><span class="p">):</span>
                    <span class="n">values</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;inherit_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">type</span>
                <span class="k">else</span><span class="p">:</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;arch&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;arch_base&#39;</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Missing view architecture.&#39;</span><span class="p">))</span>
                        <span class="n">values</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;arch&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;arch_base&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">tag</span>
                    <span class="k">except</span> <span class="n">LxmlError</span><span class="p">:</span>
                        <span class="c1"># don&#39;t raise here, the constraint that runs `self._check_xml` will</span>
                        <span class="c1"># do the job properly.</span>
                        <span class="k">pass</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;qweb&#39;</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;gen_key.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())[:</span><span class="mi">6</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">):</span>
                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">),</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span>
            <span class="c1"># Create might be called with either `arch` (xml files), `arch_base` (form view) or `arch_db`.</span>
            <span class="n">values</span><span class="p">[</span><span class="s1">&#39;arch_prev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;arch_base&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;arch_db&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;arch&#39;</span><span class="p">)</span>
            <span class="c1"># write on arch: bypass _inverse_arch()</span>
            <span class="k">if</span> <span class="s1">&#39;arch&#39;</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;arch_db&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;arch&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;install_filename&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">:</span>
                    <span class="c1"># we store the relative path to the resource instead of the absolute path, if found</span>
                    <span class="c1"># (it will be missing e.g. when importing data-only modules using base_import_module)</span>
                    <span class="n">path_info</span> <span class="o">=</span> <span class="n">get_resource_from_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">[</span><span class="s1">&#39;install_filename&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">path_info</span><span class="p">:</span>
                        <span class="n">values</span><span class="p">[</span><span class="s1">&#39;arch_fs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_info</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">values</span><span class="p">[</span><span class="s1">&#39;arch_updated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">values</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compute_defaults</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">(</span><span class="s1">&#39;templates&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">View</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">ir_ui_view_partial_validation</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">vals_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">with_env</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span></div>


<div class="viewcode-block" id="View.write">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.View.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
        <span class="c1"># Keep track if view was modified. That will be useful for the --dev mode</span>
        <span class="c1"># to prefer modified arch over file arch.</span>
        <span class="k">if</span> <span class="s1">&#39;arch_updated&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vals</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;arch&#39;</span> <span class="ow">in</span> <span class="n">vals</span> <span class="ow">or</span> <span class="s1">&#39;arch_base&#39;</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;install_filename&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">:</span>
            <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;arch_updated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># drop the corresponding view customizations (used for dashboards for example), otherwise</span>
        <span class="c1"># not all users would see the updated views</span>
        <span class="n">custom_view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.ui.view.custom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;ref_id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">custom_view</span><span class="p">:</span>
            <span class="n">custom_view</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">(</span><span class="s1">&#39;templates&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;arch_db&#39;</span> <span class="ow">in</span> <span class="n">vals</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;no_save_prev&#39;</span><span class="p">):</span>
            <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;arch_prev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arch_db</span>

        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">View</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compute_defaults</span><span class="p">(</span><span class="n">vals</span><span class="p">))</span>

        <span class="c1"># Check the xml of the view if it gets re-activated.</span>
        <span class="c1"># Ideally, `active` shoud have been added to the `api.constrains` of `_check_xml`,</span>
        <span class="c1"># but the ORM writes and validates regular field (such as `active`) before inverse fields (such as `arch`),</span>
        <span class="c1"># and therefore when writing `active` and `arch` at the same time, `_check_xml` is called twice,</span>
        <span class="c1"># and the first time it tries to validate the view without the modification to the arch,</span>
        <span class="c1"># which is problematic if the user corrects the view at the same time he re-enables it.</span>
        <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">):</span>
            <span class="c1"># Call `_validate_fields` instead of `_check_xml` to have the regular constrains error dialog</span>
            <span class="c1"># instead of the traceback dialog.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_fields</span><span class="p">([</span><span class="s1">&#39;arch_db&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="View.unlink">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.View.unlink">[docs]</a>
    <span class="k">def</span> <span class="nf">unlink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># if in uninstall mode and has children views, emulate an ondelete cascade</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_force_unlink&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit_children_ids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inherit_children_ids</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">(</span><span class="s1">&#39;templates&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">View</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_update_field_translations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">translations</span><span class="p">,</span> <span class="n">digest</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">View</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">no_save_prev</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span><span class="o">.</span><span class="n">_update_field_translations</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">translations</span><span class="p">,</span> <span class="n">digest</span><span class="p">)</span>

<div class="viewcode-block" id="View.copy">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.View.copy">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">returns</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">and</span> <span class="n">default</span> <span class="ow">and</span> <span class="s1">&#39;key&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">default</span><span class="p">:</span>
            <span class="n">new_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())[:</span><span class="mi">6</span><span class="p">]</span>
            <span class="n">default</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">default</span> <span class="ow">or</span> <span class="p">{},</span> <span class="n">key</span><span class="o">=</span><span class="n">new_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">View</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">default</span><span class="p">)</span></div>


    <span class="c1"># default view selection</span>
<div class="viewcode-block" id="View.default_view">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.View.default_view">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">default_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">view_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Fetches the default view for the provided (model, view_type) pair:</span>
<span class="sd">         primary view with the lowest priority.</span>

<span class="sd">        :param str model:</span>
<span class="sd">        :param int view_type:</span>
<span class="sd">        :return: id of the default view of False if none found</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">model</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">view_type</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;primary&#39;</span><span class="p">)]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">id</span></div>


    <span class="c1">#------------------------------------------------------</span>
    <span class="c1"># Inheritance mecanism</span>
    <span class="c1">#------------------------------------------------------</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_inheriting_views_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return a domain to filter the sub-views to inherit from. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)]</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_filter_xmlid_query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This method is meant to be overridden by other modules.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;SELECT res_id FROM ir_model_data</span>
<span class="s2">                  WHERE res_id IN </span><span class="si">%(res_ids)s</span><span class="s2"> AND model = &#39;ir.ui.view&#39; AND module IN </span><span class="si">%(modules)s</span>
<span class="s2">               &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_get_inheriting_views</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the views that inherit from the current recordset, and return</span>
<span class="sd">        them as a recordset, ordered by priority then by id.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">)</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_inheriting_views_domain</span><span class="p">()</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">expression</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">])</span>
        <span class="n">from_clause</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">where_params</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_sql</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">from_clause</span> <span class="o">==</span> <span class="s1">&#39;&quot;ir_ui_view&quot;&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unexpected from clause: </span><span class="si">{</span><span class="n">from_clause</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_flush_search</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;inherit_id&#39;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">])</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            WITH RECURSIVE ir_ui_view_inherits AS (</span>
<span class="s2">                SELECT id, inherit_id, priority, mode, model</span>
<span class="s2">                FROM ir_ui_view</span>
<span class="s2">                WHERE id IN %s AND (</span><span class="si">{</span><span class="n">where_clause</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">            UNION</span>
<span class="s2">                SELECT ir_ui_view.id, ir_ui_view.inherit_id, ir_ui_view.priority,</span>
<span class="s2">                       ir_ui_view.mode, ir_ui_view.model</span>
<span class="s2">                FROM ir_ui_view</span>
<span class="s2">                INNER JOIN ir_ui_view_inherits parent ON parent.id = ir_ui_view.inherit_id</span>
<span class="s2">                WHERE coalesce(ir_ui_view.model, &#39;&#39;) = coalesce(parent.model, &#39;&#39;)</span>
<span class="s2">                      AND ir_ui_view.mode = &#39;extension&#39;</span>
<span class="s2">                      AND (</span><span class="si">{</span><span class="n">where_clause</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">            )</span>
<span class="s2">            SELECT</span>
<span class="s2">                v.id, v.inherit_id, v.mode</span>
<span class="s2">            FROM ir_ui_view_inherits v</span>
<span class="s2">            ORDER BY v.priority, v.id</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="c1"># ORDER BY v.priority, v.id:</span>
        <span class="c1"># 1/ sort by priority: abritrary value set by developers on some</span>
        <span class="c1">#    views to solve &quot;dependency hell&quot; problems and force a view</span>
        <span class="c1">#    to be combined earlier or later. e.g. all views created via</span>
        <span class="c1">#    studio have a priority=99 to be loaded last.</span>
        <span class="c1"># 2/ sort by view id: the order the views were inserted in the</span>
        <span class="c1">#    database. e.g. base views are placed before stock ones.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)]</span> <span class="o">+</span> <span class="n">where_params</span> <span class="o">+</span> <span class="n">where_params</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="n">views</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">)</span>

        <span class="c1"># optimization: fill in cache of inherit_id and mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;inherit_id&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">])</span>

        <span class="c1"># During an upgrade, we can only use the views that have been</span>
        <span class="c1"># fully upgraded already.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_init</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;load_all_views&#39;</span><span class="p">):</span>
            <span class="n">views</span> <span class="o">=</span> <span class="n">views</span><span class="o">.</span><span class="n">_filter_loaded_views</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">views</span>

    <span class="k">def</span> <span class="nf">_filter_loaded_views</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        During the module upgrade phase it may happen that a view is</span>
<span class="sd">        present in the database but the fields it relies on are not</span>
<span class="sd">        fully loaded yet. This method only considers views that belong</span>
<span class="sd">        to modules whose code is already loaded. Custom views defined</span>
<span class="sd">        directly in the database are loaded only after the module</span>
<span class="sd">        initialization phase is completely finished.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check that all found ids have a corresponding xml_id in a loaded module</span>
        <span class="n">check_view_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;check_view_ids&#39;</span><span class="p">]</span>
        <span class="n">ids_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="n">vid</span> <span class="k">for</span> <span class="n">vid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span> <span class="k">if</span> <span class="n">vid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">check_view_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids_to_check</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">loaded_modules</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_init_modules</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;install_module&#39;</span><span class="p">),)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_filter_xmlid_query</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;res_ids&#39;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ids_to_check</span><span class="p">),</span> <span class="s1">&#39;modules&#39;</span><span class="p">:</span> <span class="n">loaded_modules</span><span class="p">})</span>
        <span class="n">valid_view_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()}</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">check_view_ids</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">vid</span> <span class="k">for</span> <span class="n">vid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span> <span class="k">if</span> <span class="n">vid</span> <span class="ow">in</span> <span class="n">valid_view_ids</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_view_access</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Verify that a view is accessible by the current user based on the</span>
<span class="sd">        groups attribute. Views with no groups are considered private.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s1">&#39;primary&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit_id</span><span class="o">.</span><span class="n">_check_view_access</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_id</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">groups_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_id</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;View &#39;</span><span class="si">%(name)s</span><span class="s2">&#39; accessible only to groups </span><span class="si">%(groups)s</span><span class="s2"> &quot;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
                <span class="n">groups</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">g</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_id</span><span class="p">]</span>
            <span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;View &#39;</span><span class="si">%(name)s</span><span class="s2">&#39; is private&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">AccessError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_raise_view_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">from_exception</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_traceback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Handle a view error by raising an exception.</span>

<span class="sd">        :param str message: message to raise or log, augmented with contextual</span>
<span class="sd">                            view information</span>
<span class="sd">        :param node: the lxml element where the error is located (if any)</span>
<span class="sd">        :param BaseException from_exception:</span>
<span class="sd">            when raising an exception, chain it to the provided one (default:</span>
<span class="sd">            disable chaining)</span>
<span class="sd">        :param types.TracebackType from_traceback:</span>
<span class="sd">            when raising an exception, start with this traceback (default: start</span>
<span class="sd">            at exception creation)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">err</span> <span class="o">=</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">from_traceback</span><span class="p">)</span>
        <span class="n">err</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;view&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s1">&#39;xmlid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;install_xmlid&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_id</span><span class="p">,</span>
            <span class="s1">&#39;view.model&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="s1">&#39;view.parent&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit_id</span><span class="p">,</span>
            <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;install_filename&#39;</span><span class="p">),</span>
            <span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">sourceline</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">raise</span> <span class="n">err</span> <span class="kn">from</span> <span class="nn">from_exception</span>

    <span class="k">def</span> <span class="nf">_log_view_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Handle a view issue by logging a warning.</span>

<span class="sd">        :param str message: message to raise or log, augmented with contextual</span>
<span class="sd">                            view information</span>
<span class="sd">        :param node: the lxml element where the error is located (if any)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">error_context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;view&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s1">&#39;xmlid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;install_xmlid&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_id</span><span class="p">,</span>
            <span class="s1">&#39;view.model&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="s1">&#39;view.parent&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit_id</span><span class="p">,</span>
            <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;install_filename&#39;</span><span class="p">),</span>
            <span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">sourceline</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">View error context:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">message</span><span class="p">,</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">error_context</span><span class="p">)</span>
        <span class="p">)</span>

<div class="viewcode-block" id="View.locate_node">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.View.locate_node">[docs]</a>
    <span class="k">def</span> <span class="nf">locate_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arch</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Locate a node in a source (parent) architecture.</span>

<span class="sd">        Given a complete source (parent) architecture (i.e. the field</span>
<span class="sd">        `arch` in a view), and a &#39;spec&#39; node (a node in an inheriting</span>
<span class="sd">        view that specifies the location in the source view of what</span>
<span class="sd">        should be changed), return (if it exists) the node in the</span>
<span class="sd">        source view matching the specification.</span>

<span class="sd">        :param arch: a parent architecture to modify</span>
<span class="sd">        :param spec: a modifying node in an inheriting view</span>
<span class="sd">        :return: a node in the source matching the spec</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">locate_node</span><span class="p">(</span><span class="n">arch</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span></div>


<div class="viewcode-block" id="View.inherit_branding">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.View.inherit_branding">[docs]</a>
    <span class="k">def</span> <span class="nf">inherit_branding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specs_tree</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">specs_tree</span><span class="o">.</span><span class="n">iterchildren</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">):</span>
            <span class="n">xpath</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">getroottree</span><span class="p">()</span><span class="o">.</span><span class="n">getpath</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;data&#39;</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;xpath&#39;</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inherit_branding</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t-field&#39;</span><span class="p">):</span>
                <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;data-oe-xpath&#39;</span><span class="p">,</span> <span class="n">xpath</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inherit_branding</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;data-oe-id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
                <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;data-oe-xpath&#39;</span><span class="p">,</span> <span class="n">xpath</span><span class="p">)</span>
                <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;data-oe-model&#39;</span><span class="p">,</span> <span class="s1">&#39;ir.ui.view&#39;</span><span class="p">)</span>
                <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;data-oe-field&#39;</span><span class="p">,</span> <span class="s1">&#39;arch&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">specs_tree</span></div>


    <span class="k">def</span> <span class="nf">_add_validation_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combined_arch</span><span class="p">,</span> <span class="n">view</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Add a validation flag on elements in ``combined_arch`` or ``arch``.</span>
<span class="sd">        This is part of the partial validation of views.</span>

<span class="sd">        :param Element combined_arch: the architecture to be modified by ``arch``</span>
<span class="sd">        :param view: an optional view inheriting ``self``</span>
<span class="sd">        :param Element arch: an optional modifying architecture from inheriting</span>
<span class="sd">            view ``view``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># validate_view_ids is either falsy (no validation), True (full</span>
        <span class="c1"># validation) or a collection of ids (partial validation)</span>
        <span class="n">validate_view_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;validate_view_ids&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">validate_view_ids</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">validate_view_ids</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">validate_view_ids</span><span class="p">:</span>
            <span class="c1"># optimization, flag the root node</span>
            <span class="n">combined_arch</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;__validate__&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">view</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">view</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">validate_view_ids</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">arch</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//*[@position]&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;inside&#39;</span><span class="p">):</span>
                <span class="c1"># validate the elements being inserted, except the ones that</span>
                <span class="c1"># specify a move, as in:</span>
                <span class="c1">#   &lt;field name=&quot;foo&quot; position=&quot;after&quot;&gt;</span>
                <span class="c1">#       &lt;field name=&quot;bar&quot; position=&quot;move&quot;/&gt;</span>
                <span class="c1">#   &lt;/field&gt;</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">iterchildren</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">child</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">):</span>
                        <span class="n">child</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;__validate__&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span>
                <span class="c1"># validate everything, since this impacts the whole arch</span>
                <span class="n">combined_arch</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;__validate__&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;attributes&#39;</span><span class="p">:</span>
                <span class="c1"># validate the element being modified by adding</span>
                <span class="c1"># attribute &quot;__validate__&quot; on it:</span>
                <span class="c1">#   &lt;field name=&quot;foo&quot; position=&quot;attributes&quot;&gt;</span>
                <span class="c1">#       &lt;attribute name=&quot;readonly&quot;&gt;1&lt;/attribute&gt;</span>
                <span class="c1">#       &lt;attribute name=&quot;__validate__&quot;&gt;1&lt;/attribute&gt;    &lt;!-- add this --&gt;</span>
                <span class="c1">#   &lt;/field&gt;</span>
                <span class="n">node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">attribute</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;__validate__&#39;</span><span class="p">))</span>

<div class="viewcode-block" id="View.apply_inheritance_specs">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.View.apply_inheritance_specs">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">apply_inheritance_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">specs_tree</span><span class="p">,</span> <span class="n">pre_locate</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Apply an inheriting view (a descendant of the base view)</span>

<span class="sd">        Apply to a source architecture all the spec nodes (i.e. nodes</span>
<span class="sd">        describing where and what changes to apply to some parent</span>
<span class="sd">        architecture) given by an inheriting view.</span>

<span class="sd">        :param Element source: a parent architecture to modify</span>
<span class="sd">        :param Element specs_tree: a modifying architecture in an inheriting view</span>
<span class="sd">        :param (optional) pre_locate: function that is execute before locating a node.</span>
<span class="sd">                                        This function receives an arch as argument.</span>
<span class="sd">        :return: a modified source where the specs are applied</span>
<span class="sd">        :rtype: Element</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Queue of specification nodes (i.e. nodes describing where and</span>
        <span class="c1"># changes to apply to some parent architecture).</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">apply_inheritance_specs</span><span class="p">(</span>
                <span class="n">source</span><span class="p">,</span> <span class="n">specs_tree</span><span class="p">,</span>
                <span class="n">inherit_branding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inherit_branding&#39;</span><span class="p">),</span>
                <span class="n">pre_locate</span><span class="o">=</span><span class="n">pre_locate</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">specs_tree</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">source</span></div>


    <span class="k">def</span> <span class="nf">_combine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return self&#39;s arch combined with its inherited views archs.</span>

<span class="sd">        :param hierarchy: mapping from parent views to their child views</span>
<span class="sd">        :return: combined architecture</span>
<span class="sd">        :rtype: Element</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;primary&#39;</span>

        <span class="c1"># We achieve a pre-order depth-first hierarchy traversal where</span>
        <span class="c1"># primary views (and their children) are traversed after all the</span>
        <span class="c1"># extensions for the current primary view have been visited.</span>
        <span class="c1">#</span>
        <span class="c1"># https://en.wikipedia.org/wiki/Tree_traversal#Depth-first_search_of_binary_tree</span>
        <span class="c1">#</span>
        <span class="c1"># Example:                  hierarchy = {</span>
        <span class="c1">#                               1: [2, 3],  # primary view</span>
        <span class="c1">#             1*                2: [4, 5],</span>
        <span class="c1">#            / \                3: [],</span>
        <span class="c1">#           2   3               4: [6],     # primary view</span>
        <span class="c1">#          / \                  5: [7, 8],</span>
        <span class="c1">#         4*  5                 6: [],</span>
        <span class="c1">#        /   / \                7: [],</span>
        <span class="c1">#       6   7   8               8: [],</span>
        <span class="c1">#                           }</span>
        <span class="c1">#</span>
        <span class="c1"># Tree traversal order (`view` and `queue` at the `while` stmt):</span>
        <span class="c1">#   1 [2, 3]</span>
        <span class="c1">#   2 [5, 3, 4]</span>
        <span class="c1">#   5 [7, 8, 3, 4]</span>
        <span class="c1">#   7 [8, 3, 4]</span>
        <span class="c1">#   8 [3, 4]</span>
        <span class="c1">#   3 [4]</span>
        <span class="c1">#   4 [6]</span>
        <span class="c1">#   6 []</span>
        <span class="n">combined_arch</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arch</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inherit_branding&#39;</span><span class="p">):</span>
            <span class="n">combined_arch</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;data-oe-model&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.ui.view&#39;</span><span class="p">,</span>
                <span class="s1">&#39;data-oe-id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                <span class="s1">&#39;data-oe-field&#39;</span><span class="p">:</span> <span class="s1">&#39;arch&#39;</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_validation_flag</span><span class="p">(</span><span class="n">combined_arch</span><span class="p">)</span>

        <span class="c1"># The depth-first traversal is implemented with a double-ended queue.</span>
        <span class="c1"># The queue is traversed from left to right, and after each view in the</span>
        <span class="c1"># queue is processed, its children are pushed at the left of the queue,</span>
        <span class="c1"># so that they are traversed in order.  The queue is therefore mostly</span>
        <span class="c1"># used as a stack.  An exception is made for primary views, which are</span>
        <span class="c1"># pushed at the other end of the queue, so that they are applied after</span>
        <span class="c1"># all extensions have been applied.</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">hierarchy</span><span class="p">[</span><span class="bp">self</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">mode</span><span class="p">))</span>
        <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="n">arch</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">arch</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">view</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inherit_branding&#39;</span><span class="p">):</span>
                <span class="n">view</span><span class="o">.</span><span class="n">inherit_branding</span><span class="p">(</span><span class="n">arch</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_validation_flag</span><span class="p">(</span><span class="n">combined_arch</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">arch</span><span class="p">)</span>
            <span class="n">combined_arch</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">apply_inheritance_specs</span><span class="p">(</span><span class="n">combined_arch</span><span class="p">,</span> <span class="n">arch</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">child_view</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">hierarchy</span><span class="p">[</span><span class="n">view</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">child_view</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;primary&#39;</span><span class="p">:</span>
                    <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child_view</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">queue</span><span class="o">.</span><span class="n">appendleft</span><span class="p">(</span><span class="n">child_view</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">combined_arch</span>

<div class="viewcode-block" id="View.read_combined">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.View.read_combined">[docs]</a>
    <span class="k">def</span> <span class="nf">read_combined</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Utility function to get a view combined with its inherited views.</span>

<span class="sd">        * Gets the top of the view tree if a sub-view is requested</span>
<span class="sd">        * Applies all inherited archs on the root view</span>
<span class="sd">        * Returns the view with all requested fields</span>
<span class="sd">          .. note:: ``arch`` is always added to the fields list even if not</span>
<span class="sd">                    requested (similar to ``id``)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;use get_combined_arch() instead&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">({</span><span class="s1">&#39;arch&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">fields</span><span class="p">))</span>
        <span class="p">[</span><span class="n">result</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;arch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_combined_arch</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="View.get_combined_arch">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.View.get_combined_arch">[docs]</a>
    <span class="k">def</span> <span class="nf">get_combined_arch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the arch of ``self`` (as a string) combined with its inherited views. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_combined_arch</span><span class="p">(),</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;unicode&#39;</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_get_combined_arch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the arch of ``self`` (as an etree) combined with its inherited views. &quot;&quot;&quot;</span>
        <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">view_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">view_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="o">.</span><span class="n">inherit_id</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">inherit_id</span>

        <span class="n">views</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">view_ids</span><span class="p">)</span>

        <span class="c1"># Add inherited views to the list of loading forced views</span>
        <span class="c1"># Otherwise, inherited views could not find elements created in</span>
        <span class="c1"># their direct parents if that parent is defined in the same module</span>
        <span class="c1"># introduce check_view_ids in context</span>
        <span class="k">if</span> <span class="s1">&#39;check_view_ids&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">views</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="p">:</span>
            <span class="n">views</span> <span class="o">=</span> <span class="n">views</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">check_view_ids</span><span class="o">=</span><span class="p">[])</span>
        <span class="n">views</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;check_view_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">view_ids</span><span class="p">)</span>

        <span class="c1"># Map each node to its children nodes. Note that all children nodes are</span>
        <span class="c1"># part of a single prefetch set, which is all views to combine.</span>
        <span class="n">tree_views</span> <span class="o">=</span> <span class="n">views</span><span class="o">.</span><span class="n">_get_inheriting_views</span><span class="p">()</span>
        <span class="n">hierarchy</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="n">tree_views</span><span class="p">:</span>
            <span class="n">hierarchy</span><span class="p">[</span><span class="n">view</span><span class="o">.</span><span class="n">inherit_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">view</span><span class="p">)</span>

        <span class="c1"># optimization: make root part of the prefetch set, too</span>
        <span class="n">arch</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">with_prefetch</span><span class="p">(</span><span class="n">tree_views</span><span class="o">.</span><span class="n">_prefetch_ids</span><span class="p">)</span><span class="o">.</span><span class="n">_combine</span><span class="p">(</span><span class="n">hierarchy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arch</span>

    <span class="k">def</span> <span class="nf">_get_view_refs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Extract the `[view_type]_view_ref` keys and values from the node context attribute,</span>
<span class="sd">        giving the views to use for a field node.</span>

<span class="sd">        :param node: the field node as an etree</span>
<span class="sd">        :return: a dictonary mapping the `[view_type]_view_ref` key to the xmlid of the view to use for that view type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;view_type&#39;</span><span class="p">):</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;view_id&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ref_re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">))</span>
        <span class="p">}</span>

    <span class="c1">#------------------------------------------------------</span>
    <span class="c1"># Postprocessing: translation, groups and modifiers</span>
    <span class="c1">#------------------------------------------------------</span>
    <span class="c1"># TODO: remove group processing from ir_qweb</span>
    <span class="c1">#------------------------------------------------------</span>
<div class="viewcode-block" id="View.postprocess_and_fields">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.View.postprocess_and_fields">[docs]</a>
    <span class="k">def</span> <span class="nf">postprocess_and_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return an architecture and a description of all the fields.</span>

<span class="sd">        The field description combines the result of fields_get() and</span>
<span class="sd">        postprocess().</span>

<span class="sd">        :param self: the view to postprocess</span>
<span class="sd">        :param node: the architecture as an etree</span>
<span class="sd">        :param model: the view&#39;s reference model name</span>
<span class="sd">        :return: a tuple (arch, fields) where arch is the given node as a</span>
<span class="sd">            string and fields is the description of all the fields.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>      <span class="c1"># self is at most one view</span>

        <span class="n">name_manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_view</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">model</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

        <span class="n">arch</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;unicode&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">name_managers</span> <span class="o">=</span> <span class="p">[</span><span class="n">name_manager</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name_manager</span> <span class="ow">in</span> <span class="n">name_managers</span><span class="p">:</span>
            <span class="n">models</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">name_manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">name_manager</span><span class="o">.</span><span class="n">available_fields</span><span class="p">)</span>
            <span class="n">name_managers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">name_manager</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arch</span><span class="p">,</span> <span class="n">models</span></div>


    <span class="k">def</span> <span class="nf">_postprocess_access_rights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply group restrictions: elements with a &#39;groups&#39; attribute should</span>
<span class="sd">        be removed from the view to people who are not members.</span>

<span class="sd">        Compute and set on node access rights based on view type. Specific</span>
<span class="sd">        views can add additional specific rights like creating columns for</span>
<span class="sd">        many2one-based grouping views.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//*[@groups]&#39;</span><span class="p">):</span>
            <span class="n">attrib_groups</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attrib_groups</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_has_groups</span><span class="p">(</span><span class="n">attrib_groups</span><span class="p">):</span>
                <span class="n">node</span><span class="o">.</span><span class="n">getparent</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;postprocess_added&#39;</span><span class="p">)):</span>
                <span class="c1"># Move content of &lt;t groups=&quot;&quot;&gt; blocks</span>
                <span class="c1"># and remove the &lt;t&gt; node.</span>
                <span class="c1"># This is to keep the structure</span>
                <span class="c1"># &lt;group&gt;</span>
                <span class="c1">#   &lt;field name=&quot;foo&quot;/&gt;</span>
                <span class="c1">#   &lt;field name=&quot;bar&quot;/&gt;</span>
                <span class="c1"># &lt;group&gt;</span>
                <span class="c1"># so the web client adds the label as expected.</span>
                <span class="c1"># This is also to avoid having &lt;t&gt; nodes in tree views</span>
                <span class="c1"># e.g.</span>
                <span class="c1"># &lt;tree&gt;</span>
                <span class="c1">#   &lt;field name=&quot;foo&quot;/&gt;</span>
                <span class="c1">#   &lt;t groups=&quot;foo&quot;&gt;</span>
                <span class="c1">#     &lt;field name=&quot;bar&quot; groups=&quot;bar&quot;/&gt;</span>
                <span class="c1">#   &lt;/t&gt;</span>
                <span class="c1"># &lt;/tree&gt;</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">addnext</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="n">node</span><span class="o">.</span><span class="n">getparent</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="n">base_model</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_access_rights&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//*[@model_access_rights]&#39;</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;model_access_rights&#39;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;field&#39;</span><span class="p">:</span>
                <span class="n">can_create</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">can_write</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;write&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;can_create&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">can_create</span><span class="p">)))</span>
                <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;can_write&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">can_write</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_base_model</span> <span class="o">=</span> <span class="n">base_model</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">_name</span>
                <span class="k">for</span> <span class="n">action</span><span class="p">,</span> <span class="n">operation</span> <span class="ow">in</span> <span class="p">((</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="s1">&#39;unlink&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;edit&#39;</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;kanban&#39;</span><span class="p">:</span>
                    <span class="n">group_by_name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_group_by&#39;</span><span class="p">)</span>
                    <span class="n">group_by_field</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">group_by_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">group_by_field</span> <span class="ow">and</span> <span class="n">group_by_field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2one&#39;</span><span class="p">:</span>
                        <span class="n">group_by_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">group_by_field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">action</span><span class="p">,</span> <span class="n">operation</span> <span class="ow">in</span> <span class="p">((</span><span class="s1">&#39;group_create&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;group_delete&#39;</span><span class="p">,</span> <span class="s1">&#39;unlink&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;group_edit&#39;</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">group_by_model</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                                <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tree</span>

    <span class="k">def</span> <span class="nf">_postprocess_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parent_name_manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Process the given architecture, modifying it in-place to add and</span>
<span class="sd">        remove stuff.</span>

<span class="sd">        :param self: the optional view to postprocess</span>
<span class="sd">        :param node: the combined architecture as an etree</span>
<span class="sd">        :param model_name: the view&#39;s reference model name</span>
<span class="sd">        :param editable: whether the view is considered editable</span>
<span class="sd">        :return: the processed architecture&#39;s NameManager</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">node</span>

        <span class="k">if</span> <span class="n">model_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Model not found: </span><span class="si">%(model)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model_name</span><span class="p">),</span> <span class="n">root</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onchange_able_view</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_on_change</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

        <span class="n">name_manager</span> <span class="o">=</span> <span class="n">NameManager</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent_name_manager</span><span class="p">)</span>

        <span class="n">root_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;view_type&#39;</span><span class="p">:</span> <span class="n">root</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span>
            <span class="s1">&#39;view_editable&#39;</span><span class="p">:</span> <span class="n">editable</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_editable_node</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">),</span>
            <span class="s1">&#39;mobile&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mobile&#39;</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="c1"># use a stack to recursively traverse the tree</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="p">[(</span><span class="n">root</span><span class="p">,</span> <span class="n">editable</span><span class="p">)]</span>
        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">node</span><span class="p">,</span> <span class="n">editable</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

            <span class="c1"># compute default</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span>
            <span class="n">had_parent</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">getparent</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">node_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">root_info</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="n">editable</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_editable_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">))</span>

            <span class="c1"># tag-specific postprocessing</span>
            <span class="n">postprocessor</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_postprocess_tag_</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">postprocessor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">postprocessor</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">had_parent</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">getparent</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># the node has been removed, stop processing here</span>
                    <span class="k">continue</span>

            <span class="c1"># if present, iterate on node_info[&#39;children&#39;] instead of node</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">node_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;children&#39;</span><span class="p">,</span> <span class="n">node</span><span class="p">)):</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">child</span><span class="p">,</span> <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;editable&#39;</span><span class="p">]))</span>

        <span class="n">name_manager</span><span class="o">.</span><span class="n">update_available_fields</span><span class="p">()</span>
        <span class="n">root</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;model_access_rights&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">name_manager</span>

    <span class="k">def</span> <span class="nf">_postprocess_on_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arch</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Add attribute on_change=&quot;1&quot; on fields that are dependencies of</span>
<span class="sd">            computed fields on the same view.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># map each field object to its corresponding nodes in arch</span>
        <span class="n">field_nodes</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;field&#39;</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
                    <span class="n">field_nodes</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">relational</span><span class="p">:</span>
                        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                <span class="n">collect</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

        <span class="n">collect</span><span class="p">(</span><span class="n">arch</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="n">field_nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># if field should trigger an onchange, add on_change=&quot;1&quot; on the</span>
            <span class="c1"># nodes referring to field</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_has_onchange</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">field_nodes</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;on_change&#39;</span><span class="p">):</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;on_change&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_x2many_missing_view_archs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">field_node</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For x2many fields that require to have some multi-record arch (kanban or list) to display the records</span>
<span class="sd">        be available, this function fetches all arch that are needed and return them.</span>
<span class="sd">        The caller function is responsible to do what it needs with them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_view_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">tag</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">field_node</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&quot;./*[descendant::field]&quot;</span><span class="p">)]</span>
        <span class="n">missing_view_types</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">view_type</span> <span class="ow">in</span> <span class="n">current_view_types</span> <span class="k">for</span> <span class="n">view_type</span> <span class="ow">in</span> <span class="n">field_node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;kanban,tree&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)):</span>
            <span class="n">missing_view_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">field_node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;kanban&#39;</span> <span class="k">if</span> <span class="n">node_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mobile&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;tree&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">missing_view_types</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">comodel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_view_refs</span><span class="p">(</span><span class="n">field_node</span><span class="p">)</span>
        <span class="c1"># Do not propagate &lt;view_type&gt;_view_ref of parent call to `_get_view`</span>
        <span class="n">comodel</span> <span class="o">=</span> <span class="n">comodel</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">view_type</span><span class="si">}</span><span class="s1">_view_ref&#39;</span><span class="p">:</span> <span class="n">refs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">view_type</span><span class="si">}</span><span class="s1">_view_ref&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">view_type</span> <span class="ow">in</span> <span class="n">missing_view_types</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">comodel</span><span class="o">.</span><span class="n">_get_view</span><span class="p">(</span><span class="n">view_type</span><span class="o">=</span><span class="n">view_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">view_type</span> <span class="ow">in</span> <span class="n">missing_view_types</span><span class="p">]</span>

    <span class="c1">#------------------------------------------------------</span>
    <span class="c1"># Specific node postprocessors</span>
    <span class="c1">#------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_postprocess_tag_calendar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">additional_field</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;date_start&#39;</span><span class="p">,</span> <span class="s1">&#39;date_delay&#39;</span><span class="p">,</span> <span class="s1">&#39;date_stop&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;all_day&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">additional_field</span><span class="p">):</span>
                <span class="n">name_manager</span><span class="o">.</span><span class="n">has_field</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">additional_field</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;filter&#39;</span><span class="p">:</span>
                <span class="n">name_manager</span><span class="o">.</span><span class="n">has_field</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_postprocess_tag_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">):</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="s1">&#39;select&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">)}</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">name_manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">):</span>
                        <span class="c1"># if the node has a group (e.g. &quot;base.group_no_one&quot;)</span>
                        <span class="c1"># and the field in the Python model has a group as well (e.g. &quot;base.group_system&quot;)</span>
                        <span class="c1"># the user must have both group to see the field.</span>
                        <span class="c1"># groups=&quot;base.group_no_one,base.group_system&quot; directly on the node</span>
                        <span class="c1"># would be one of the two groups, not both (OR instead of AND).</span>
                        <span class="c1"># To make mandatory to have both groups, wrap the field node in a &lt;t&gt; node with the group</span>
                        <span class="c1"># set on the field in the Python model</span>
                        <span class="c1"># e.g. &lt;t groups=&quot;base.group_system&quot;&gt;&lt;field name=&quot;foo&quot; groups=&quot;base.group_no_one&quot;/&gt;&lt;/t&gt;</span>
                        <span class="c1"># The &lt;t&gt; node will be removed later, in _postprocess_access_rights.</span>
                        <span class="n">node_t</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">groups</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">groups</span><span class="p">,</span> <span class="n">postprocess_added</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">getparent</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node_t</span><span class="p">)</span>
                        <span class="n">node_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">node_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;view_type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;form&#39;</span>
                    <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;one2many&#39;</span><span class="p">,</span> <span class="s1">&#39;many2many&#39;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;widget&#39;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;invisible&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">name_manager</span><span class="o">.</span><span class="n">parent</span>
                <span class="p">):</span>
                    <span class="c1"># Embed kanban/tree/form views for visible x2many fields in form views</span>
                    <span class="c1"># if no widget or the widget requires it.</span>
                    <span class="c1"># So the web client doesn&#39;t have to call `get_views` for x2many fields not embedding their view</span>
                    <span class="c1"># in the main form view.</span>
                    <span class="k">for</span> <span class="n">arch</span><span class="p">,</span> <span class="n">_view</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_x2many_missing_view_archs</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arch</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="s1">&#39;tree&#39;</span><span class="p">,</span> <span class="s1">&#39;graph&#39;</span><span class="p">,</span> <span class="s1">&#39;kanban&#39;</span><span class="p">,</span> <span class="s1">&#39;calendar&#39;</span><span class="p">):</span>
                        <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_view</span><span class="p">(</span>
                            <span class="n">child</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;editable&#39;</span><span class="p">],</span> <span class="n">parent_name_manager</span><span class="o">=</span><span class="n">name_manager</span><span class="p">,</span>
                        <span class="p">)</span>
                <span class="k">if</span> <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;editable&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;many2one&#39;</span><span class="p">,</span> <span class="s1">&#39;many2many&#39;</span><span class="p">):</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;model_access_rights&#39;</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">)</span>

            <span class="n">name_manager</span><span class="o">.</span><span class="n">has_field</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="n">attrs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_postprocess_tag_form</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">name_manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">view_header_get</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_postprocess_tag_groupby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
        <span class="c1"># groupby nodes should be considered as nested view because they may</span>
        <span class="c1"># contain fields on the comodel</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">name_manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># post-process the node as a nested view, and associate it to the field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_view</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">parent_name_manager</span><span class="o">=</span><span class="n">name_manager</span><span class="p">)</span>
        <span class="n">name_manager</span><span class="o">.</span><span class="n">has_field</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_postprocess_tag_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;for&#39;</span><span class="p">):</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">name_manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;for&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">):</span>
                    <span class="c1"># See the comment for this in `_postprocess_tag_field`</span>
                    <span class="n">node_t</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">groups</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">groups</span><span class="p">,</span> <span class="n">postprocess_added</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">)</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">getparent</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node_t</span><span class="p">)</span>
                    <span class="n">node_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_postprocess_tag_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
        <span class="n">searchpanel</span> <span class="o">=</span> <span class="p">[</span><span class="n">child</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span> <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;searchpanel&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">searchpanel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_view</span><span class="p">(</span>
                <span class="n">searchpanel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">name_manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">parent_name_manager</span><span class="o">=</span><span class="n">name_manager</span>
            <span class="p">)</span>
            <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">child</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span> <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s1">&#39;searchpanel&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_postprocess_tag_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
        <span class="c1"># reuse form view post-processing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_tag_form</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">)</span>

    <span class="c1">#-------------------------------------------------------------------</span>
    <span class="c1"># view editability</span>
    <span class="c1">#-------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">_editable_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return whether the given node must be considered editable. &quot;&quot;&quot;</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_editable_tag_</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">)</span>
        <span class="c1"># by default views are non-editable</span>
        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">selection</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_editable_tag_form</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_editable_tag_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;editable&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;multi_edit&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_editable_tag_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">):</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">name_manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">field</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">field</span><span class="o">.</span><span class="n">is_editable</span><span class="p">()</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;readonly&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_onchange_able_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_onchange_able_view_</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_onchange_able_view_form</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_onchange_able_view_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_onchange_able_view_kanban</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_modifiers_from_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">modifier_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;kanban&#39;</span><span class="p">,</span> <span class="s1">&#39;tree&#39;</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">):</span>
            <span class="n">modifier_names</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;readonly&#39;</span><span class="p">,</span> <span class="s1">&#39;required&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">modifier_names</span>

    <span class="c1">#-------------------------------------------------------------------</span>
    <span class="c1"># view validation</span>
    <span class="c1">#-------------------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">_validate_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">view_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Validate the given architecture node, and return its corresponding</span>
<span class="sd">        NameManager.</span>

<span class="sd">        :param self: the view being validated</span>
<span class="sd">        :param node: the combined architecture as an etree</span>
<span class="sd">        :param model_name: the reference model name for the given architecture</span>
<span class="sd">        :param editable: whether the view is considered editable</span>
<span class="sd">        :param full: whether the whole view must be validated</span>
<span class="sd">        :return: the combined architecture&#39;s NameManager</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>

        <span class="n">view_type</span> <span class="o">=</span> <span class="n">view_type</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="n">view_type</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s1">&#39;The root node of a </span><span class="si">%(view_type)s</span><span class="s1"> view should be a &lt;</span><span class="si">%(view_type)s</span><span class="s1">&gt;, not a &lt;</span><span class="si">%(tag)s</span><span class="s1">&gt;&#39;</span><span class="p">,</span>
                <span class="n">view_type</span><span class="o">=</span><span class="n">view_type</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span>
            <span class="p">),</span> <span class="n">node</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Model not found: </span><span class="si">%(model)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model_name</span><span class="p">),</span> <span class="n">node</span><span class="p">)</span>

        <span class="c1"># fields_get() optimization: validation does not require translations</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">name_manager</span> <span class="o">=</span> <span class="n">NameManager</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="n">view_type</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span>
        <span class="c1"># use a stack to recursively traverse the tree</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="p">[(</span><span class="n">node</span><span class="p">,</span> <span class="n">editable</span><span class="p">,</span> <span class="n">full</span><span class="p">)]</span>
        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">node</span><span class="p">,</span> <span class="n">editable</span><span class="p">,</span> <span class="n">validate</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

            <span class="c1"># compute default</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span>
            <span class="n">validate</span> <span class="o">=</span> <span class="n">validate</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;__validate__&#39;</span><span class="p">)</span>
            <span class="n">node_info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;editable&#39;</span><span class="p">:</span> <span class="n">editable</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_editable_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">),</span>
                <span class="s1">&#39;validate&#39;</span><span class="p">:</span> <span class="n">validate</span><span class="p">,</span>
                <span class="s1">&#39;view_type&#39;</span><span class="p">:</span> <span class="n">view_type</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># tag-specific validation</span>
            <span class="n">validator</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_validate_tag_</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">validator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">validator</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_validate_attributes</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">child</span><span class="p">,</span> <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;editable&#39;</span><span class="p">],</span> <span class="n">validate</span><span class="p">))</span>

        <span class="n">name_manager</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">name_manager</span>

    <span class="c1">#------------------------------------------------------</span>
    <span class="c1"># Node validator</span>
    <span class="c1">#------------------------------------------------------</span>
    <span class="k">def</span> <span class="nf">_validate_tag_form</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_validate_tag_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
        <span class="c1"># reuse form view validation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_tag_form</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="n">allowed_tags</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;field&#39;</span><span class="p">,</span> <span class="s1">&#39;button&#39;</span><span class="p">,</span> <span class="s1">&#39;control&#39;</span><span class="p">,</span> <span class="s1">&#39;groupby&#39;</span><span class="p">,</span> <span class="s1">&#39;widget&#39;</span><span class="p">,</span> <span class="s1">&#39;header&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">iterchildren</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_tags</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">etree</span><span class="o">.</span><span class="n">_Comment</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                    <span class="s1">&#39;Tree child can only have one of </span><span class="si">%(tags)s</span><span class="s1"> tag (not </span><span class="si">%(wrong_tag)s</span><span class="s1">)&#39;</span><span class="p">,</span>
                    <span class="n">tags</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">allowed_tags</span><span class="p">),</span> <span class="n">wrong_tag</span><span class="o">=</span><span class="n">child</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_tag_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">iterchildren</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s1">&#39;field&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">etree</span><span class="o">.</span><span class="n">_Comment</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;A &lt;graph&gt; can only contains &lt;field&gt; nodes, found a &lt;</span><span class="si">%s</span><span class="s1">&gt;&#39;</span><span class="p">,</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_tag_calendar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">additional_field</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;date_start&#39;</span><span class="p">,</span> <span class="s1">&#39;date_delay&#39;</span><span class="p">,</span> <span class="s1">&#39;date_stop&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;all_day&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">additional_field</span><span class="p">):</span>
                <span class="n">name_manager</span><span class="o">.</span><span class="n">has_field</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">additional_field</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;filter&#39;</span><span class="p">:</span>
                <span class="n">name_manager</span><span class="o">.</span><span class="n">has_field</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_validate_tag_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">iterdescendants</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s2">&quot;field&quot;</span><span class="p">):</span>
            <span class="c1"># the field of the search view may be within a group node, which is why we must check</span>
            <span class="c1"># for all descendants containing a node with a field tag, if this is not the case</span>
            <span class="c1"># then a search is not possible.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="s1">&#39;Search tag requires at least one field element&#39;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

        <span class="n">searchpanels</span> <span class="o">=</span> <span class="p">[</span><span class="n">child</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span> <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;searchpanel&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">searchpanels</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">searchpanels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Search tag can only contain one search panel&#39;</span><span class="p">),</span> <span class="n">node</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">searchpanels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_view</span><span class="p">(</span><span class="n">searchpanels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">name_manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">view_type</span><span class="o">=</span><span class="s2">&quot;searchpanel&quot;</span><span class="p">,</span>
                                <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_validate_tag_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
        <span class="n">validate</span> <span class="o">=</span> <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">]</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Field tag must have a </span><span class="se">\&quot;</span><span class="s2">name</span><span class="se">\&quot;</span><span class="s2"> attribute defined&quot;</span><span class="p">),</span> <span class="n">node</span><span class="p">)</span>

        <span class="n">field</span> <span class="o">=</span> <span class="n">name_manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">relational</span><span class="p">:</span>
                <span class="n">domain</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;domain&#39;</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;editable&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">_description_domain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="c1"># dynamic domain: in [(&#39;foo&#39;, &#39;=&#39;, bar)], field &#39;foo&#39; must</span>
                    <span class="c1"># exist on the comodel and field &#39;bar&#39; must be in the view</span>
                    <span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;domain of &lt;field name=&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;&gt;&#39;</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;domain&#39;</span><span class="p">)</span>
                            <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;domain of python field </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_domain_identifiers</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;Modifier must be a domain&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Non-domain syntaxes are deprecated for attribute &#39;domain&#39;: </span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">domain</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span>

            <span class="k">elif</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;domain&#39;</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                    <span class="s1">&#39;Domain on non-relational field &quot;</span><span class="si">%(name)s</span><span class="s1">&quot; makes no sense (domain:</span><span class="si">%(domain)s</span><span class="s1">)&#39;</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;domain&#39;</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="s1">&#39;tree&#39;</span><span class="p">,</span> <span class="s1">&#39;graph&#39;</span><span class="p">,</span> <span class="s1">&#39;kanban&#39;</span><span class="p">,</span> <span class="s1">&#39;calendar&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">node</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="n">sub_manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_view</span><span class="p">(</span>
                    <span class="n">child</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">,</span> <span class="n">view_type</span><span class="o">=</span><span class="n">child</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;editable&#39;</span><span class="p">],</span> <span class="n">full</span><span class="o">=</span><span class="n">validate</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">groups_uses</span> <span class="ow">in</span> <span class="n">sub_manager</span><span class="o">.</span><span class="n">mandatory_parent_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">groups</span><span class="p">,</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">groups_uses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">name_manager</span><span class="o">.</span><span class="n">must_have_field</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">use</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name_manager</span><span class="o">.</span><span class="n">field_info</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                <span class="s1">&#39;Field &quot;</span><span class="si">%(field_name)s</span><span class="s1">&quot; does not exist in model &quot;</span><span class="si">%(model_name)s</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
                <span class="n">field_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="n">name_manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

        <span class="n">name_manager</span><span class="o">.</span><span class="n">has_field</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="s1">&#39;select&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">)})</span>

    <span class="k">def</span> <span class="nf">_validate_tag_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;domain&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">domain</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;domain of &lt;filter name=&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;&gt;&#39;</span> <span class="k">if</span> <span class="n">name</span> <span class="k">else</span> <span class="s1">&#39;domain of &lt;filter&gt;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_domain_identifiers</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">name_manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_tag_button</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="n">special</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;special&#39;</span><span class="p">)</span>
        <span class="n">type_</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">special</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">special</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;cancel&#39;</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Invalid special &#39;</span><span class="si">%(value)s</span><span class="s2">&#39; in button&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">special</span><span class="p">),</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">type_</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">type_</span> <span class="o">==</span> <span class="s1">&#39;edit&#39;</span><span class="p">:</span> <span class="c1"># list_renderer, used in kanban view</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Button must have a name&quot;</span><span class="p">),</span> <span class="n">node</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">type_</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">name_manager</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">func</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%(action_name)s</span><span class="s2"> is not a valid action on </span><span class="si">%(model_name)s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">action_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="n">name_manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">check_method_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">AccessError</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%(method)s</span><span class="s2"> on </span><span class="si">%(model)s</span><span class="s2"> is private and cannot be called from a button&quot;</span><span class="p">,</span>
                        <span class="n">method</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">name_manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> on </span><span class="si">%s</span><span class="s2"> has parameters and cannot be called from a button&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name_manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_name</span><span class="p">),</span> <span class="n">node</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">type_</span> <span class="o">==</span> <span class="s1">&#39;action&#39;</span><span class="p">:</span>
                <span class="n">name_manager</span><span class="o">.</span><span class="n">must_exist_action</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

            <span class="n">name_manager</span><span class="o">.</span><span class="n">has_action</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;icon&#39;</span><span class="p">):</span>
            <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;A button with icon attribute (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;icon&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_fa_class_accessibility</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_tag_groupby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
        <span class="c1"># groupby nodes should be considered as nested view because they may</span>
        <span class="c1"># contain fields on the comodel</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">name_manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;many2one&#39;</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;Field &#39;</span><span class="si">%(name)s</span><span class="s2">&#39; found in &#39;groupby&#39; node can only be of type many2one, found </span><span class="si">%(type)s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                <span class="n">domain</span> <span class="o">=</span> <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;editable&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">_description_domain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">desc</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;domain of python field &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_validate_domain_identifiers</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">)</span>

            <span class="c1"># move all children nodes into a new node &lt;groupby&gt;</span>
            <span class="n">groupby_node</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="o">*</span><span class="n">node</span><span class="p">)</span>
            <span class="c1"># validate the node as a nested view</span>
            <span class="n">sub_manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_view</span><span class="p">(</span>
                <span class="n">groupby_node</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">,</span> <span class="n">view_type</span><span class="o">=</span><span class="s2">&quot;groupby&quot;</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">name_manager</span><span class="o">.</span><span class="n">has_field</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">groups_uses</span> <span class="ow">in</span> <span class="n">sub_manager</span><span class="o">.</span><span class="n">mandatory_parent_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">groups</span><span class="p">,</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">groups_uses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">name_manager</span><span class="o">.</span><span class="n">must_have_field</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">use</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                <span class="s2">&quot;Field &#39;</span><span class="si">%(field)s</span><span class="s2">&#39; found in &#39;groupby&#39; node does not exist in model </span><span class="si">%(model)s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">field</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">name_manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_tag_searchpanel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">iterchildren</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;domain&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">child</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;multi&#39;</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Searchpanel item with select multi cannot have a domain.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_tag_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="c1"># replace return not arch.xpath(&#39;//label[not(@for) and not(descendant::input)]&#39;)</span>
        <span class="n">for_</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;for&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">for_</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Label tag must contain a &quot;for&quot;. To match label style &#39;</span>
                    <span class="s1">&#39;without corresponding field or button, use </span><span class="se">\&#39;</span><span class="s1">class=&quot;o_form_label&quot;</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name_manager</span><span class="o">.</span><span class="n">must_have_name</span><span class="p">(</span><span class="n">for_</span><span class="p">,</span> <span class="s1">&#39;&lt;label for=&quot;...&quot;&gt;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_tag_page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">getparent</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">getparent</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s1">&#39;notebook&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Page direct ancestor must be notebook&#39;</span><span class="p">),</span> <span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_tag_img</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alt</span><span class="p">)</span> <span class="k">for</span> <span class="n">alt</span> <span class="ow">in</span> <span class="n">att_names</span><span class="p">(</span><span class="s1">&#39;alt&#39;</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="s1">&#39;&lt;img&gt; tag must contain an alt attribute&#39;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_tag_a</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
        <span class="c1">#(&#39;calendar&#39;, &#39;form&#39;, &#39;graph&#39;, &#39;kanban&#39;, &#39;pivot&#39;, &#39;search&#39;, &#39;tree&#39;, &#39;activity&#39;)</span>
        <span class="k">if</span> <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="s1">&#39;btn&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">att_names</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;button&#39;</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&quot;&lt;a&gt;&quot; tag with &quot;btn&quot; class must have &quot;button&quot; role&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_tag_ul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">]:</span>
            <span class="c1"># was applied to all nodes, but in practice only used on div and ul</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_dropdown_menu</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_tag_div</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node_info</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_dropdown_menu</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_progress_bar</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="c1">#------------------------------------------------------</span>
    <span class="c1"># Validation tools</span>
    <span class="c1">#------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">_check_dropdown_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1">#(&#39;calendar&#39;, &#39;form&#39;, &#39;graph&#39;, &#39;kanban&#39;, &#39;pivot&#39;, &#39;search&#39;, &#39;tree&#39;, &#39;activity&#39;)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="s1">&#39;dropdown-menu&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">att_names</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;menu&#39;</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;dropdown-menu class must have menu role&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_progress_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="s1">&#39;o_progressbar&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">att_names</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;progressbar&#39;</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;o_progressbar class must have progressbar role&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">att_names</span><span class="p">(</span><span class="s1">&#39;aria-valuenow&#39;</span><span class="p">)):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;o_progressbar class must have aria-valuenow attribute&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">att_names</span><span class="p">(</span><span class="s1">&#39;aria-valuemin&#39;</span><span class="p">)):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;o_progressbar class must have aria-valuemin attribute&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">att_names</span><span class="p">(</span><span class="s1">&#39;aria-valuemax&#39;</span><span class="p">)):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;o_progressbar class must have aria-valuemaxattribute&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_is_qweb_based_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_type</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">view_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;kanban&quot;</span><span class="p">,</span> <span class="s2">&quot;gantt&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generic validation of node attributes. &quot;&quot;&quot;</span>

        <span class="c1"># python expression used in for readonly, invisible, ...</span>
        <span class="c1"># and thus are only executed client side</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">VIEW_MODIFIERS</span><span class="p">:</span>
            <span class="n">py_expression</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">py_expression</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_validate_expression</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">py_expression</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;modifier </span><span class="si">{</span><span class="n">attr</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="s1">&#39;t-att-class&#39;</span><span class="p">,</span> <span class="s1">&#39;t-attf-class&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_validate_classes</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;context&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">vnames</span> <span class="o">=</span> <span class="n">get_expression_field_names</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">}</span>
                <span class="k">except</span> <span class="ne">SyntaxError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Invalid context: </span><span class="si">%(expr)r</span><span class="s1"> is not a valid Python expression </span><span class="se">\n\n</span><span class="s1"> </span><span class="si">%(e)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">vnames</span><span class="p">:</span>
                    <span class="n">name_manager</span><span class="o">.</span><span class="n">must_have_fields</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">vnames</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;context (</span><span class="si">{</span><span class="n">expr</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val_ast</span> <span class="ow">in</span> <span class="n">get_dict_asts</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;group_by&#39;</span><span class="p">:</span>  <span class="c1"># only in context</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val_ast</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val_ast</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                                <span class="s1">&#39;&quot;group_by&quot; value must be a string </span><span class="si">%(attribute)s</span><span class="s1">=</span><span class="si">%(value)r</span><span class="s1">&#39;</span><span class="p">,</span>
                                <span class="n">attribute</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                        <span class="n">group_by</span> <span class="o">=</span> <span class="n">val_ast</span><span class="o">.</span><span class="n">value</span>
                        <span class="n">fname</span> <span class="o">=</span> <span class="n">group_by</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">fname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name_manager</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                                <span class="s1">&#39;Unknown field &quot;</span><span class="si">%(field)s</span><span class="s1">&quot; in &quot;group_by&quot; value in </span><span class="si">%(attribute)s</span><span class="s1">=</span><span class="si">%(value)r</span><span class="s1">&#39;</span><span class="p">,</span>
                                <span class="n">field</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;groups&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
                    <span class="n">name_manager</span><span class="o">.</span><span class="n">must_exist_group</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">node</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;col&#39;</span><span class="p">,</span> <span class="s1">&#39;colspan&#39;</span><span class="p">):</span>
                <span class="c1"># col check is mainly there for the tag &#39;group&#39;, but previous</span>
                <span class="c1"># check was generic in view form</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span>
                        <span class="n">_</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(attribute)r</span><span class="s1"> value must be an integer (</span><span class="si">%(value)s</span><span class="s1">)&#39;</span><span class="p">,</span>
                          <span class="n">attribute</span><span class="o">=</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">expr</span><span class="p">),</span>
                        <span class="n">node</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;decoration-&#39;</span><span class="p">):</span>
                <span class="n">vnames</span> <span class="o">=</span> <span class="n">get_expression_field_names</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">}</span>
                <span class="k">if</span> <span class="n">vnames</span><span class="p">:</span>
                    <span class="n">name_manager</span><span class="o">.</span><span class="n">must_have_fields</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">vnames</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">expr</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;data-bs-toggle&#39;</span> <span class="ow">and</span> <span class="n">expr</span> <span class="o">==</span> <span class="s1">&#39;tab&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;tab&#39;</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;tab link (data-bs-toggle=&quot;tab&quot;) must have &quot;tab&quot; role&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                <span class="n">aria_control</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;aria-controls&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t-att-aria-controls&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">aria_control</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t-attf-aria-controls&#39;</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;tab link (data-bs-toggle=&quot;tab&quot;) must have &quot;aria_control&quot; defined&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">aria_control</span> <span class="ow">and</span> <span class="s1">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">aria_control</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;aria-controls in tablink cannot contains &quot;#&quot;&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s2">&quot;role&quot;</span> <span class="ow">and</span> <span class="n">expr</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;presentation&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;A role cannot be `none` or `presentation`. &quot;</span>
                    <span class="s2">&quot;All your elements must be accessible with screen readers, describe it.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;attribute &#39;group&#39; is not valid.  Did you mean &#39;groups&#39;?&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

            <span class="k">elif</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(t\-att\-|t\-attf\-)?data-tooltip(-template|-info)?$&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Forbidden attribute used in arch (</span><span class="si">%s</span><span class="s2">).&quot;</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="n">node</span><span class="p">)</span>

            <span class="k">elif</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;t-&quot;</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_validate_qweb_directive</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">node_info</span><span class="p">[</span><span class="s2">&quot;view_type&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">COMP_REGEX</span><span class="p">,</span> <span class="n">expr</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Forbidden use of `__comp__` in arch.&quot;</span><span class="p">),</span> <span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Validate the classes present on node. &quot;&quot;&quot;</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
        <span class="c1"># Be careful: not always true if it is an expression</span>
        <span class="c1"># example: &lt;div t-attf-class=&quot;{{!selection_mode ? &#39;oe_kanban_color_&#39; + kanban_getcolor(record.color.raw_value) : &#39;&#39;}} oe_kanban_card oe_kanban_global_click oe_applicant_kanban oe_semantic_html_override&quot;&gt;</span>
        <span class="k">if</span> <span class="s1">&#39;modal&#39;</span> <span class="ow">in</span> <span class="n">classes</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;dialog&#39;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&quot;modal&quot; class should only be used with &quot;dialog&quot; role&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;modal-header&#39;</span> <span class="ow">in</span> <span class="n">classes</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s1">&#39;header&#39;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&quot;modal-header&quot; class should only be used in &quot;header&quot; tag&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;modal-body&#39;</span> <span class="ow">in</span> <span class="n">classes</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s1">&#39;main&#39;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&quot;modal-body&quot; class should only be used in &quot;main&quot; tag&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;modal-footer&#39;</span> <span class="ow">in</span> <span class="n">classes</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s1">&#39;footer&#39;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&quot;modal-footer&quot; class should only be used in &quot;footer&quot; tag&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;tab-pane&#39;</span> <span class="ow">in</span> <span class="n">classes</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;tabpanel&#39;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&quot;tab-pane&quot; class should only be used with &quot;tabpanel&quot; role&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;nav-tabs&#39;</span> <span class="ow">in</span> <span class="n">classes</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;tablist&#39;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;A tab list with class nav-tabs must have role=&quot;tablist&quot;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">klass</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;alert-&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">klass</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;alert&#39;</span><span class="p">,</span> <span class="s1">&#39;alertdialog&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="s1">&#39;alert-link&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">classes</span>
            <span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;An alert (class alert-*) must have an alert, alertdialog or &quot;</span>
                        <span class="s2">&quot;status role or an alert-link class. Please use alert and &quot;</span>
                        <span class="s2">&quot;alertdialog only for what expects to stop any activity to &quot;</span>
                        <span class="s2">&quot;be read immediately.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">klass</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;fa-&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">klass</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">):</span>
            <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;A &lt;</span><span class="si">%s</span><span class="s1">&gt; with fa class (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_fa_class_accessibility</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">klass</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;btn&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">klass</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;button&#39;</span><span class="p">,</span> <span class="s1">&#39;select&#39;</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;input&#39;</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;button&#39;</span><span class="p">,</span> <span class="s1">&#39;submit&#39;</span><span class="p">,</span> <span class="s1">&#39;reset&#39;</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">klass</span> <span class="ow">in</span> <span class="n">classes</span> <span class="k">for</span> <span class="n">klass</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;btn-group&#39;</span><span class="p">,</span> <span class="s1">&#39;btn-toolbar&#39;</span><span class="p">,</span> <span class="s1">&#39;btn-addr&#39;</span><span class="p">)):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;A simili button must be in tag a/button/select or tag `input` &quot;</span>
                        <span class="s2">&quot;with type button/submit/reset or have class in &quot;</span>
                        <span class="s2">&quot;btn-group/btn-toolbar/btn-addr&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_fa_class_accessibility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
        <span class="n">valid_aria_attrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">att_names</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">),</span> <span class="o">*</span><span class="n">att_names</span><span class="p">(</span><span class="s1">&#39;aria-label&#39;</span><span class="p">),</span> <span class="o">*</span><span class="n">att_names</span><span class="p">(</span><span class="s1">&#39;aria-labelledby&#39;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">valid_t_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;t-value&#39;</span><span class="p">,</span> <span class="s1">&#39;t-raw&#39;</span><span class="p">,</span> <span class="s1">&#39;t-field&#39;</span><span class="p">,</span> <span class="s1">&#39;t-esc&#39;</span><span class="p">,</span> <span class="s1">&#39;t-out&#39;</span><span class="p">}</span>

        <span class="c1">## Following or preceding text</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">tail</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">getparent</span><span class="p">()</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="c1"># text&lt;i class=&quot;fa-...&quot;/&gt; or &lt;i class=&quot;fa-...&quot;/&gt;text or</span>
            <span class="k">return</span>

        <span class="c1">## Following or preceding text in span</span>
        <span class="k">def</span> <span class="nf">has_text</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">elem</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;span&#39;</span> <span class="ow">and</span> <span class="n">elem</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t-esc&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">elem</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t-raw&#39;</span><span class="p">)):</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">has_text</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">getnext</span><span class="p">())</span> <span class="ow">or</span> <span class="n">has_text</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">getprevious</span><span class="p">()):</span>
            <span class="k">return</span>

        <span class="k">def</span> <span class="nf">has_title_or_aria_label</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">valid_aria_attrs</span><span class="p">)</span>

        <span class="c1">## Aria label can be on ancestors</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">has_title_or_aria_label</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">iterancestors</span><span class="p">())):</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1">## And we ignore all elements with describing in children</span>
        <span class="k">def</span> <span class="nf">contains_description</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;excessive depth in fa&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">valid_t_attrs</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">has_title_or_aria_label</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;field&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>  <span class="c1"># not sure, does it match *[text()]</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">contains_description</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">contains_description</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> must have title in its tag, parents, descendants or have text&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="n">description</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_qweb_directive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">directive</span><span class="p">,</span> <span class="n">view_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Some views (e.g. kanban, form) generate owl templates from the archs.</span>
<span class="sd">        However, we don&#39;t want to see owl directives directly written in archs.</span>
<span class="sd">        There are exceptions though, since the kanban and gantt archs define qweb templates.</span>
<span class="sd">        We thus here validate that the given directive is allowed, according to the view_type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">allowed_directives</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;t-translation&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_qweb_based_view</span><span class="p">(</span><span class="n">view_type</span><span class="p">):</span>
            <span class="n">allowed_directives</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="s2">&quot;t-name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;t-esc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;t-out&quot;</span><span class="p">,</span>
                <span class="s2">&quot;t-set&quot;</span><span class="p">,</span>
                <span class="s2">&quot;t-value&quot;</span><span class="p">,</span>
                <span class="s2">&quot;t-if&quot;</span><span class="p">,</span>
                <span class="s2">&quot;t-else&quot;</span><span class="p">,</span>
                <span class="s2">&quot;t-elif&quot;</span><span class="p">,</span>
                <span class="s2">&quot;t-foreach&quot;</span><span class="p">,</span>
                <span class="s2">&quot;t-as&quot;</span><span class="p">,</span>
                <span class="s2">&quot;t-key&quot;</span><span class="p">,</span>
                <span class="s2">&quot;t-att.*&quot;</span><span class="p">,</span>
                <span class="s2">&quot;t-call&quot;</span><span class="p">,</span>
                <span class="s2">&quot;t-debug&quot;</span><span class="p">,</span>
            <span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">next</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">regex</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">directive</span><span class="p">),</span> <span class="n">allowed_directives</span><span class="p">),</span> <span class="kc">None</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Forbidden owl directive used in arch (</span><span class="si">%s</span><span class="s2">).&quot;</span><span class="p">,</span> <span class="n">directive</span><span class="p">),</span> <span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">py_expression</span><span class="p">,</span> <span class="n">use</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">py_expression</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">):</span>
                <span class="c1"># most (~95%) elements are 1/True/0/False</span>
                <span class="k">return</span>
            <span class="n">fnames</span> <span class="o">=</span> <span class="n">get_expression_field_names</span><span class="p">(</span><span class="n">py_expression</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">}</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Invalid </span><span class="si">%(use)s</span><span class="s2">: </span><span class="si">%(expr)r</span><span class="se">\n</span><span class="si">%(error)s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">use</span><span class="o">=</span><span class="n">use</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="n">py_expression</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">from_exception</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
        <span class="n">name_manager</span><span class="o">.</span><span class="n">must_have_fields</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">fnames</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">use</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">py_expression</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_domain_identifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name_manager</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">use</span><span class="p">,</span> <span class="n">target_model</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fnames</span><span class="p">,</span> <span class="n">vnames</span> <span class="o">=</span> <span class="n">get_domain_value_names</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Invalid </span><span class="si">%(use)s</span><span class="s2">: </span><span class="si">%(expr)r</span><span class="se">\n</span><span class="si">%(error)s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">use</span><span class="o">=</span><span class="n">use</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">from_exception</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_field_paths</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">fnames</span><span class="p">,</span> <span class="n">target_model</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">use</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">name_manager</span><span class="o">.</span><span class="n">must_have_fields</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">vnames</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">use</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_field_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">field_paths</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">use</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Check whether the given field paths (dot-separated field names)</span>
<span class="sd">        correspond to actual sequences of fields on the given model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">field_path</span> <span class="ow">in</span> <span class="n">field_paths</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">field_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;parent&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">Model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                        <span class="s1">&#39;Non-relational field </span><span class="si">%(field)r</span><span class="s1"> in path </span><span class="si">%(field_path)r</span><span class="s1"> in </span><span class="si">%(use)s</span><span class="s1">)&#39;</span><span class="p">,</span>
                        <span class="n">field</span><span class="o">=</span><span class="n">names</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">field_path</span><span class="o">=</span><span class="n">field_path</span><span class="p">,</span> <span class="n">use</span><span class="o">=</span><span class="n">use</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                        <span class="s1">&#39;Unknown field &quot;</span><span class="si">%(model)s</span><span class="s1">.</span><span class="si">%(field)s</span><span class="s1">&quot; in </span><span class="si">%(use)s</span><span class="s1">)&#39;</span><span class="p">,</span>
                        <span class="n">model</span><span class="o">=</span><span class="n">Model</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">use</span><span class="o">=</span><span class="n">use</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">_description_searchable</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                        <span class="s1">&#39;Unsearchable field </span><span class="si">%(field)r</span><span class="s1"> in path </span><span class="si">%(field_path)r</span><span class="s1"> in </span><span class="si">%(use)s</span><span class="s1">)&#39;</span><span class="p">,</span>
                        <span class="n">field</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">field_path</span><span class="o">=</span><span class="n">field_path</span><span class="p">,</span> <span class="n">use</span><span class="o">=</span><span class="n">use</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">)</span>

    <span class="c1">#------------------------------------------------------</span>
    <span class="c1"># QWeb template views</span>
    <span class="c1">#------------------------------------------------------</span>

    <span class="k">def</span> <span class="nf">_read_template_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the list of context keys to use for caching ``_read_template``. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;lang&#39;</span><span class="p">,</span> <span class="s1">&#39;inherit_branding&#39;</span><span class="p">,</span> <span class="s1">&#39;edit_translations&#39;</span><span class="p">]</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_read_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_id</span><span class="p">):</span>
        <span class="n">arch_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">view_id</span><span class="p">)</span><span class="o">.</span><span class="n">_get_combined_arch</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distribute_branding</span><span class="p">(</span><span class="n">arch_tree</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">arch_tree</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;unicode&#39;</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_view_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the view ID corresponding to ``template``, which may be a</span>
<span class="sd">        view ID or an XML ID. Note that this method may be overridden for other</span>
<span class="sd">        kinds of template values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">template</span>
        <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">template</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid template id: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">template</span><span class="p">)</span>
        <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">template</span><span class="p">)],</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">view</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">view</span><span class="o">.</span><span class="n">id</span>
        <span class="n">res_model</span><span class="p">,</span> <span class="n">res_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_xmlid_to_res_model_res_id</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">raise_if_not_found</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">res_model</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s2">&quot;Call _get_view_id, expected </span><span class="si">%r</span><span class="s2">, got </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">res_model</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res_id</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_ref</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the view corresponding to ``view_ref``, which may be a</span>
<span class="sd">        view ID or an XML ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_view_id</span><span class="p">(</span><span class="n">view_ref</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_contains_branded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span>\
            <span class="ow">or</span> <span class="s1">&#39;t-raw&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span>\
            <span class="ow">or</span> <span class="s1">&#39;t-call&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span>\
            <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_node_branded</span><span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">iterdescendants</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_pop_view_branding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="n">distributed_branding</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">attribute</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">MOVABLE_BRANDING</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attribute</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">distributed_branding</span>

<div class="viewcode-block" id="View.distribute_branding">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.View.distribute_branding">[docs]</a>
    <span class="k">def</span> <span class="nf">distribute_branding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">branding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent_xpath</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                            <span class="n">index_map</span><span class="o">=</span><span class="n">ConstantMapping</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t-ignore&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">e</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;head&#39;</span><span class="p">:</span>
            <span class="c1"># remove any view branding possibly injected by inheritance</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">MOVABLE_BRANDING</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">descendant</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">iterdescendants</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">attrs</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">descendant</span><span class="o">.</span><span class="n">attrib</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pop_view_branding</span><span class="p">(</span><span class="n">descendant</span><span class="p">)</span>

            <span class="c1"># Remove the processing instructions indicating where nodes were</span>
            <span class="c1"># removed (see apply_inheritance_specs)</span>
            <span class="k">for</span> <span class="n">descendant</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">iterdescendants</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="n">etree</span><span class="o">.</span><span class="n">ProcessingInstruction</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">descendant</span><span class="o">.</span><span class="n">target</span> <span class="o">==</span> <span class="s1">&#39;apply-inheritance-specs-node-removal&#39;</span><span class="p">:</span>
                    <span class="n">descendant</span><span class="o">.</span><span class="n">getparent</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">descendant</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">node_path</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data-oe-xpath&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">node_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">[</span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent_xpath</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">index_map</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">tag</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">branding</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t-field&#39;</span><span class="p">):</span>
                <span class="n">e</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;data-oe-xpath&#39;</span><span class="p">,</span> <span class="n">node_path</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data-oe-model&#39;</span><span class="p">):</span>
                <span class="n">e</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">branding</span><span class="p">)</span>
                <span class="n">e</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;data-oe-xpath&#39;</span><span class="p">,</span> <span class="n">node_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data-oe-model&#39;</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">{</span><span class="s1">&#39;t-esc&#39;</span><span class="p">,</span> <span class="s1">&#39;t-raw&#39;</span><span class="p">,</span> <span class="s1">&#39;t-out&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">attrib</span><span class="p">):</span>
            <span class="c1"># nodes which fully generate their content and have no reason to</span>
            <span class="c1"># be branded because they can not sensibly be edited</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pop_view_branding</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contains_branded</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
            <span class="c1"># if a branded element contains branded elements distribute own</span>
            <span class="c1"># branding to children unless it&#39;s t-raw, then just remove branding</span>
            <span class="c1"># on current element</span>
            <span class="n">distributed_branding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pop_view_branding</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;t-raw&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
                <span class="c1"># TODO: collections.Counter if remove p2.6 compat</span>
                <span class="c1"># running index by tag type, for XPath query generation</span>
                <span class="n">indexes</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">iterchildren</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">,</span> <span class="n">etree</span><span class="o">.</span><span class="n">ProcessingInstruction</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data-oe-xpath&#39;</span><span class="p">):</span>
                        <span class="c1"># injected by view inheritance, skip otherwise</span>
                        <span class="c1"># generated xpath is incorrect</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">distribute_branding</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="ow">is</span> <span class="n">etree</span><span class="o">.</span><span class="n">ProcessingInstruction</span><span class="p">:</span>
                        <span class="c1"># If a node is known to have been replaced during</span>
                        <span class="c1"># applying an inheritance, increment its index to</span>
                        <span class="c1"># compute an accurate xpath for subsequent nodes</span>
                        <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">target</span> <span class="o">==</span> <span class="s1">&#39;apply-inheritance-specs-node-removal&#39;</span><span class="p">:</span>
                            <span class="n">indexes</span><span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">text</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">e</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">indexes</span><span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">distribute_branding</span><span class="p">(</span>
                            <span class="n">child</span><span class="p">,</span> <span class="n">distributed_branding</span><span class="p">,</span>
                            <span class="n">parent_xpath</span><span class="o">=</span><span class="n">node_path</span><span class="p">,</span> <span class="n">index_map</span><span class="o">=</span><span class="n">indexes</span><span class="p">)</span></div>


<div class="viewcode-block" id="View.is_node_branded">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.View.is_node_branded">[docs]</a>
    <span class="k">def</span> <span class="nf">is_node_branded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Finds out whether a node is branded or qweb-active (bears a</span>
<span class="sd">        @data-oe-model or a @t-* *which is not t-field* as t-field does not</span>
<span class="sd">        section out views)</span>

<span class="sd">        :param node: an etree-compatible element to test</span>
<span class="sd">        :type node: etree._Element</span>
<span class="sd">        :rtype: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span>
            <span class="p">(</span><span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;data-oe-model&#39;</span><span class="p">,</span> <span class="s1">&#39;groups&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;t-&#39;</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span>
        <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="ow">is</span> <span class="n">etree</span><span class="o">.</span><span class="n">ProcessingInstruction</span>
            <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">target</span> <span class="o">==</span> <span class="s1">&#39;apply-inheritance-specs-node-removal&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="View.render_public_asset">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.View.render_public_asset">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">render_public_asset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">template_sudo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">template</span><span class="p">)</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span>
        <span class="n">template_sudo</span><span class="o">.</span><span class="n">_check_view_access</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">_render</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_render_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_render</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

    <span class="c1">#------------------------------------------------------</span>
    <span class="c1"># Misc</span>
    <span class="c1">#------------------------------------------------------</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_validate_custom_views</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate architecture of custom views (= without xml id) for a given model.</span>
<span class="sd">            This method is called at the end of registry update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT max(v.id)</span>
<span class="s2">                     FROM ir_ui_view v</span>
<span class="s2">                LEFT JOIN ir_model_data md ON (md.model = &#39;ir.ui.view&#39; AND md.res_id = v.id)</span>
<span class="s2">                    WHERE md.module IN (SELECT name FROM ir_module_module) IS NOT TRUE</span>
<span class="s2">                      AND v.model = </span><span class="si">%s</span>
<span class="s2">                      AND v.active = true</span>
<span class="s2">                 GROUP BY coalesce(v.inherit_id, v.id)&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="n">model</span><span class="p">])</span>

        <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">it</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">rec</span><span class="o">.</span><span class="n">with_context</span><span class="p">({</span><span class="s1">&#39;load_all_views&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span><span class="o">.</span><span class="n">_check_xml</span><span class="p">()</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_validate_module_views</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Validate the architecture of all the views of a given module that</span>
<span class="sd">            are impacted by view updates, but have not been checked yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_init</span>

        <span class="c1"># only validate the views that still exist...</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">module</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span>
        <span class="n">prefix_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="n">xmlid</span><span class="p">[</span><span class="n">prefix_len</span><span class="p">:]</span>
            <span class="k">for</span> <span class="n">xmlid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">loaded_xmlids</span>
            <span class="k">if</span> <span class="n">xmlid</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># retrieve the views with an XML id that has not been checked yet, i.e.,</span>
        <span class="c1"># the views with noupdate=True on their xml id</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT v.id</span>
<span class="s2">            FROM ir_ui_view v</span>
<span class="s2">            JOIN ir_model_data md ON (md.model = &#39;ir.ui.view&#39; AND md.res_id = v.id)</span>
<span class="s2">            WHERE md.module = </span><span class="si">%s</span><span class="s2"> AND md.name IN </span><span class="si">%s</span><span class="s2"> AND md.noupdate</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">names</span><span class="p">))</span>
        <span class="n">views</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()])</span>

        <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="n">views</span><span class="p">:</span>
            <span class="n">view</span><span class="o">.</span><span class="n">_check_xml</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_create_all_specific_views</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processed_modules</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;To be overriden and have specific view behaviour on create&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_get_specific_views</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Given a view, return a record set containing all the specific views</span>
<span class="sd">            for that view&#39;s key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="c1"># Only qweb views have a specific conterpart</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;qweb&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">]</span>
        <span class="c1"># A specific view can have a xml_id if exported/imported but it will not be equals to it&#39;s key (only generic view will).</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)])</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">xml_id</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_records_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; During module update, when updating a generic view, we should also</span>
<span class="sd">            update its specific views (COW&#39;d).</span>
<span class="sd">            Note that we will only update unmodified fields. That will mimic the</span>
<span class="sd">            noupdate behavior on views having an ir.model.data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;qweb&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cow_view</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_specific_views</span><span class="p">():</span>
                <span class="n">authorized_vals</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;inherit_id&#39;</span> <span class="ow">and</span> <span class="n">cow_view</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                        <span class="n">authorized_vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="c1"># if inherit_id update, replicate change on cow view but</span>
                <span class="c1"># only if that cow view inherit_id wasn&#39;t manually changed</span>
                <span class="n">inherit_id</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inherit_id&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">inherit_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit_id</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">inherit_id</span> <span class="ow">and</span> \
                   <span class="n">cow_view</span><span class="o">.</span><span class="n">inherit_id</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherit_id</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_load_records_write_on_cow</span><span class="p">(</span><span class="n">cow_view</span><span class="p">,</span> <span class="n">inherit_id</span><span class="p">,</span> <span class="n">authorized_vals</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cow_view</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">no_cow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">authorized_vals</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">View</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_load_records_write</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_records_write_on_cow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cow_view</span><span class="p">,</span> <span class="n">inherit_id</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="c1"># for modules updated before `website`, we need to</span>
        <span class="c1"># store the change to replay later on cow views</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">,</span> <span class="s1">&#39;website_views_to_adapt&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">website_views_to_adapt</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">website_views_to_adapt</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
            <span class="n">cow_view</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">inherit_id</span><span class="p">,</span>
            <span class="n">values</span><span class="p">,</span>
        <span class="p">))</span></div>



<div class="viewcode-block" id="ResetViewArchWizard">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.ResetViewArchWizard">[docs]</a>
<span class="k">class</span> <span class="nc">ResetViewArchWizard</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">TransientModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; A wizard to compare and reset views architecture. &quot;&quot;&quot;</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s2">&quot;reset.view.arch.wizard&quot;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s2">&quot;Reset View Architecture Wizard&quot;</span>

    <span class="n">view_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;View&#39;</span><span class="p">)</span>
    <span class="n">view_name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">related</span><span class="o">=</span><span class="s1">&#39;view_id.name&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;View Name&#39;</span><span class="p">)</span>
    <span class="n">has_diff</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_arch_diff&#39;</span><span class="p">)</span>
    <span class="n">arch_diff</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Html</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Architecture Diff&#39;</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_arch_diff&#39;</span><span class="p">,</span> <span class="n">sanitize_tags</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">reset_mode</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Selection</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">&#39;soft&#39;</span><span class="p">,</span> <span class="s1">&#39;Restore previous version (soft reset).&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;hard&#39;</span><span class="p">,</span> <span class="s1">&#39;Reset to file version (hard reset).&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;other_view&#39;</span><span class="p">,</span> <span class="s1">&#39;Reset to another view.&#39;</span><span class="p">)],</span>
        <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Reset Mode&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;soft&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">compare_view_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Compare To View&#39;</span><span class="p">)</span>
    <span class="n">arch_to_compare</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="s1">&#39;Arch To Compare To&#39;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_arch_diff&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="ResetViewArchWizard.default_get">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.ResetViewArchWizard.default_get">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">default_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
        <span class="n">view_ids</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active_model&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;ir.ui.view&#39;</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active_ids&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">view_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Can&#39;t compare more than two views.&quot;</span><span class="p">))</span>

        <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">default_get</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;view_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">view_ids</span> <span class="ow">and</span> <span class="n">view_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">view_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;reset_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;other_view&#39;</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;compare_view_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">view_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;reset_mode&#39;</span><span class="p">,</span> <span class="s1">&#39;view_id&#39;</span><span class="p">,</span> <span class="s1">&#39;compare_view_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_arch_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Depending of `reset_mode`, return the differences between the</span>
<span class="sd">        current view arch and either its previous arch, its initial arch or</span>
<span class="sd">        another view arch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">get_table_name</span><span class="p">(</span><span class="n">view_id</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">view_id</span><span class="o">.</span><span class="n">display_name</span>
            <span class="k">if</span> <span class="n">view_id</span><span class="o">.</span><span class="n">key</span> <span class="ow">or</span> <span class="n">view_id</span><span class="o">.</span><span class="n">xml_id</span><span class="p">:</span>
                <span class="n">span</span> <span class="o">=</span> <span class="s1">&#39;&lt;span class=&quot;ml-1 font-weight-normal small&quot;&gt;(</span><span class="si">%s</span><span class="s1">)&lt;/span&gt;&#39;</span>
                <span class="n">name</span> <span class="o">+=</span> <span class="n">span</span> <span class="o">%</span> <span class="p">(</span><span class="n">view_id</span><span class="o">.</span><span class="n">key</span> <span class="ow">or</span> <span class="n">view_id</span><span class="o">.</span><span class="n">xml_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">name</span>

        <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">diff_to</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">diff_to_name</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">view</span><span class="o">.</span><span class="n">reset_mode</span> <span class="o">==</span> <span class="s1">&#39;soft&#39;</span><span class="p">:</span>
                <span class="n">diff_to</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">view_id</span><span class="o">.</span><span class="n">arch_prev</span>
                <span class="n">diff_to_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Previous Arch&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">view</span><span class="o">.</span><span class="n">reset_mode</span> <span class="o">==</span> <span class="s1">&#39;other_view&#39;</span><span class="p">:</span>
                <span class="n">diff_to</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">compare_view_id</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">arch</span>
                <span class="n">diff_to_name</span> <span class="o">=</span> <span class="n">get_table_name</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">compare_view_id</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">view</span><span class="o">.</span><span class="n">reset_mode</span> <span class="o">==</span> <span class="s1">&#39;hard&#39;</span> <span class="ow">and</span> <span class="n">view</span><span class="o">.</span><span class="n">view_id</span><span class="o">.</span><span class="n">arch_fs</span><span class="p">:</span>
                <span class="n">diff_to</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">view_id</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">read_arch_from_file</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">arch</span>
                <span class="n">diff_to_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;File Arch&quot;</span><span class="p">)</span>

            <span class="n">view</span><span class="o">.</span><span class="n">arch_to_compare</span> <span class="o">=</span> <span class="n">diff_to</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">diff_to</span><span class="p">:</span>
                <span class="n">view</span><span class="o">.</span><span class="n">arch_diff</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">view</span><span class="o">.</span><span class="n">has_diff</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">view_arch</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">view_id</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">arch</span>
                <span class="n">view</span><span class="o">.</span><span class="n">arch_diff</span> <span class="o">=</span> <span class="n">get_diff</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">view_arch</span><span class="p">,</span> <span class="n">get_table_name</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">view_id</span><span class="p">)</span> <span class="k">if</span> <span class="n">view</span><span class="o">.</span><span class="n">reset_mode</span> <span class="o">==</span> <span class="s1">&#39;other_view&#39;</span> <span class="k">else</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Current Arch&quot;</span><span class="p">)),</span>
                    <span class="p">(</span><span class="n">diff_to</span><span class="p">,</span> <span class="n">diff_to_name</span><span class="p">),</span>
                    <span class="n">custom_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">dark_color_scheme</span><span class="o">=</span><span class="n">request</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;color_scheme&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;dark&#39;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">view</span><span class="o">.</span><span class="n">has_diff</span> <span class="o">=</span> <span class="n">view_arch</span> <span class="o">!=</span> <span class="n">diff_to</span>

<div class="viewcode-block" id="ResetViewArchWizard.reset_view_button">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.ResetViewArchWizard.reset_view_button">[docs]</a>
    <span class="k">def</span> <span class="nf">reset_view_button</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_mode</span> <span class="o">==</span> <span class="s1">&#39;other_view&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view_id</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;arch_db&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">arch_to_compare</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view_id</span><span class="o">.</span><span class="n">reset_arch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reset_mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.act_window_close&#39;</span><span class="p">}</span></div>
</div>



<div class="viewcode-block" id="Model">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.Model">[docs]</a>
<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">AbstractModel</span><span class="p">):</span>
    <span class="n">_inherit</span> <span class="o">=</span> <span class="s1">&#39;base&#39;</span>

    <span class="n">_date_name</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span>         <span class="c1">#: field to use for default calendar view</span>

    <span class="k">def</span> <span class="nf">_get_access_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">access_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force_website</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return an action to open the document. This method is meant to be</span>
<span class="sd">        overridden in addons that want to give specific access to the document.</span>
<span class="sd">        By default, it opens the formview of the document.</span>

<span class="sd">        :param integer access_uid: optional access_uid being the user that</span>
<span class="sd">            accesses the document. May be different from the current user as we</span>
<span class="sd">            may compute an access for someone else.</span>
<span class="sd">        :param integer force_website: force frontend redirection if available</span>
<span class="sd">            on self. Used in overrides, notably with portal / website addons.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_formview_action</span><span class="p">(</span><span class="n">access_uid</span><span class="o">=</span><span class="n">access_uid</span><span class="p">)</span>

<div class="viewcode-block" id="Model.get_empty_list_help">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.Model.get_empty_list_help">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">get_empty_list_help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">help_message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Hook method to customize the help message in empty list/kanban views.</span>

<span class="sd">        By default, it returns the help received as parameter.</span>

<span class="sd">        :param str help: ir.actions.act_window help content</span>
<span class="sd">        :return: help message displayed when there is no result to display</span>
<span class="sd">          in a list/kanban view (by default, it returns the action help)</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">help_message</span></div>


    <span class="c1">#</span>
    <span class="c1"># Override this method if you need a window title that depends on the context</span>
    <span class="c1">#</span>
<div class="viewcode-block" id="Model.view_header_get">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.Model.view_header_get">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">view_header_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">view_type</span><span class="o">=</span><span class="s1">&#39;form&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_default_form_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generates a default single-line form view using all fields</span>
<span class="sd">        of the current model.</span>

<span class="sd">        :returns: a form view as an lxml document</span>
<span class="sd">        :rtype: etree._Element</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sheet</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">sheet</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">)</span>
        <span class="n">main_group</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
        <span class="n">left_group</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
        <span class="n">right_group</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">automatic</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;one2many&#39;</span><span class="p">,</span> <span class="s1">&#39;many2many&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">):</span>
                <span class="c1"># append to sheet left and right group if needed</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_group</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">main_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">left_group</span><span class="p">)</span>
                    <span class="n">left_group</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_group</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">main_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">right_group</span><span class="p">)</span>
                    <span class="n">right_group</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">main_group</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sheet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">main_group</span><span class="p">)</span>
                    <span class="n">main_group</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
                <span class="c1"># add an oneline group for field type &#39;one2many&#39;, &#39;many2many&#39;, &#39;text&#39;, &#39;html&#39;</span>
                <span class="n">sheet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">fname</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_group</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_group</span><span class="p">):</span>
                    <span class="n">right_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">fname</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">left_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">fname</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">left_group</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">main_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">left_group</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">right_group</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">main_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">right_group</span><span class="p">)</span>
        <span class="n">sheet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">main_group</span><span class="p">)</span>
        <span class="n">sheet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">separator</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">E</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">sheet</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_default_search_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generates a single-field search view, based on _rec_name.</span>

<span class="sd">        :returns: a tree view as an lxml document</span>
<span class="sd">        :rtype: etree._Element</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name_fallback</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">E</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_default_tree_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generates a single-field tree view, based on _rec_name.</span>

<span class="sd">        :returns: a tree view as an lxml document</span>
<span class="sd">        :rtype: etree._Element</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name_fallback</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">E</span><span class="o">.</span><span class="n">tree</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_default_pivot_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generates an empty pivot view.</span>

<span class="sd">        :returns: a pivot view as an lxml document</span>
<span class="sd">        :rtype: etree._Element</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">E</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_default_kanban_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generates a single-field kanban view, based on _rec_name.</span>

<span class="sd">        :returns: a kanban view as an lxml document</span>
<span class="sd">        :rtype: etree._Element</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">field</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name_fallback</span><span class="p">())</span>
        <span class="n">content_div</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s2">&quot;o_kanban_card_content&quot;</span><span class="p">})</span>
        <span class="n">card_div</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">content_div</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;t-attf-class&#39;</span><span class="p">:</span> <span class="s2">&quot;oe_kanban_card oe_kanban_global_click&quot;</span><span class="p">})</span>
        <span class="n">kanban_box</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">card_div</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;t-name&#39;</span><span class="p">:</span> <span class="s2">&quot;kanban-box&quot;</span><span class="p">})</span>
        <span class="n">templates</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">templates</span><span class="p">(</span><span class="n">kanban_box</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">E</span><span class="o">.</span><span class="n">kanban</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_default_graph_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generates a single-field graph view, based on _rec_name.</span>

<span class="sd">        :returns: a graph view as an lxml document</span>
<span class="sd">        :rtype: etree._Element</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name_fallback</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">E</span><span class="o">.</span><span class="n">graph</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_default_calendar_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generates a default calendar view by trying to infer</span>
<span class="sd">        calendar fields from a number of pre-set attribute names</span>

<span class="sd">        :returns: a calendar view</span>
<span class="sd">        :rtype: etree._Element</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">set_first_of</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">in_</span><span class="p">,</span> <span class="n">to</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Sets the first value of ``seq`` also found in ``in_`` to</span>
<span class="sd">            the ``to`` attribute of the ``view`` being closed over.</span>

<span class="sd">            Returns whether it&#39;s found a suitable value (and set it on</span>
<span class="sd">            the attribute) or not</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">in_</span><span class="p">:</span>
                    <span class="n">view</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">view</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">calendar</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">)</span>
        <span class="n">view</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name_fallback</span><span class="p">()))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">set_first_of</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_date_name</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;date_start&#39;</span><span class="p">,</span> <span class="s1">&#39;x_date&#39;</span><span class="p">,</span> <span class="s1">&#39;x_date_start&#39;</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span> <span class="s1">&#39;date_start&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Insufficient fields for Calendar View!&quot;</span><span class="p">))</span>

        <span class="n">set_first_of</span><span class="p">([</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;partner_id&quot;</span><span class="p">,</span> <span class="s2">&quot;x_user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;x_partner_id&quot;</span><span class="p">],</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">set_first_of</span><span class="p">([</span><span class="s2">&quot;date_stop&quot;</span><span class="p">,</span> <span class="s2">&quot;date_end&quot;</span><span class="p">,</span> <span class="s2">&quot;x_date_stop&quot;</span><span class="p">,</span> <span class="s2">&quot;x_date_end&quot;</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span> <span class="s1">&#39;date_stop&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">set_first_of</span><span class="p">([</span><span class="s2">&quot;date_delay&quot;</span><span class="p">,</span> <span class="s2">&quot;planned_hours&quot;</span><span class="p">,</span> <span class="s2">&quot;x_date_delay&quot;</span><span class="p">,</span> <span class="s2">&quot;x_planned_hours&quot;</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span> <span class="s1">&#39;date_delay&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;Insufficient fields to generate a Calendar View for </span><span class="si">%s</span><span class="s2">, missing a date_stop or a date_delay&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
                <span class="p">))</span>

        <span class="k">return</span> <span class="n">view</span>

<div class="viewcode-block" id="Model.get_views">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.Model.get_views">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">get_views</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">views</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Returns the fields_views of given views, along with the fields of</span>
<span class="sd">        the current model, and optionally its filters for the given action.</span>

<span class="sd">        The return of the method can only depend on the requested view types,</span>
<span class="sd">        access rights (views or other records), view access rules, options,</span>
<span class="sd">        context lang and TYPE_view_ref (other context values cannot be used).</span>

<span class="sd">        Python expressions contained in views or representing domains (on</span>
<span class="sd">        python fields) will be evaluated by the client with all the context</span>
<span class="sd">        values as well as the record values it has.</span>

<span class="sd">        :param views: list of [view_id, view_type]</span>
<span class="sd">        :param dict options: a dict optional boolean flags, set to enable:</span>

<span class="sd">            ``toolbar``</span>
<span class="sd">                includes contextual actions when loading fields_views</span>
<span class="sd">            ``load_filters``</span>
<span class="sd">                returns the model&#39;s filters</span>
<span class="sd">            ``action_id``</span>
<span class="sd">                id of the action to get the filters, otherwise loads the global</span>
<span class="sd">                filters or the model</span>

<span class="sd">        :return: dictionary with fields_views, fields and optionally filters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">options</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">v_type</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_view</span><span class="p">(</span>
                <span class="n">v_id</span><span class="p">,</span> <span class="n">v_type</span> <span class="k">if</span> <span class="n">v_type</span> <span class="o">!=</span> <span class="s1">&#39;list&#39;</span> <span class="k">else</span> <span class="s1">&#39;tree&#39;</span><span class="p">,</span>
                <span class="o">**</span><span class="n">options</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="p">[</span><span class="n">v_id</span><span class="p">,</span> <span class="n">v_type</span><span class="p">]</span> <span class="ow">in</span> <span class="n">views</span>
        <span class="p">}</span>

        <span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">model_fields</span> <span class="ow">in</span> <span class="n">view</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;models&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">models</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model_fields</span><span class="p">)</span>

        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;models&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">model_fields</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;models&#39;</span><span class="p">][</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">fields_get</span><span class="p">(</span>
                <span class="n">allfields</span><span class="o">=</span><span class="n">model_fields</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_view_field_attributes</span><span class="p">()</span>
            <span class="p">)</span>

        <span class="c1"># Add related action information if asked</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;toolbar&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">view</span><span class="p">[</span><span class="s1">&#39;toolbar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">bindings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.actions.actions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_bindings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">action_type</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">((</span><span class="s1">&#39;report&#39;</span><span class="p">,</span> <span class="s1">&#39;print&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">bindings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">action_type</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="n">view_types</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">action</span><span class="p">[</span><span class="s1">&#39;binding_view_types&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">action</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;binding_view_types&#39;</span><span class="p">)</span>
                        <span class="k">else</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">view_type</span> <span class="ow">in</span> <span class="n">view_types</span><span class="p">:</span>
                        <span class="n">view_type</span> <span class="o">=</span> <span class="n">view_type</span> <span class="k">if</span> <span class="n">view_type</span> <span class="o">!=</span> <span class="s1">&#39;tree&#39;</span> <span class="k">else</span> <span class="s1">&#39;list&#39;</span>
                        <span class="k">if</span> <span class="n">view_type</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]:</span>
                            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">][</span><span class="n">view_type</span><span class="p">][</span><span class="s1">&#39;toolbar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;load_filters&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;search&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">][</span><span class="s1">&#39;search&#39;</span><span class="p">][</span><span class="s1">&#39;filters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.filters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_filters</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;action_id&#39;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">view_type</span><span class="o">=</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the model view combined architecture (the view along all its inheriting views).</span>

<span class="sd">        :param int view_id: id of the view or None</span>
<span class="sd">        :param str view_type: type of the view to return if view_id is None (&#39;form&#39;, &#39;tree&#39;, ...)</span>
<span class="sd">        :param dict options: bool options to return additional features:</span>
<span class="sd">            - bool mobile: true if the web client is currently using the responsive mobile view</span>
<span class="sd">              (to use kanban views instead of list views for x2many fields)</span>
<span class="sd">        :return: architecture of the view as an etree node, and the browse record of the view used</span>
<span class="sd">        :rtype: tuple</span>
<span class="sd">        :raise AttributeError:</span>
<span class="sd">            if no view exists for that model, and no method `_get_default_[view_type]_view` exists for the view type</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">View</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span>

        <span class="c1"># try to find a view_id if none provided</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">view_id</span><span class="p">:</span>
            <span class="c1"># &lt;view_type&gt;_view_ref in context can be used to override the default view</span>
            <span class="n">view_ref_key</span> <span class="o">=</span> <span class="n">view_type</span> <span class="o">+</span> <span class="s1">&#39;_view_ref&#39;</span>
            <span class="n">view_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">view_ref_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">view_ref</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">view_ref</span><span class="p">:</span>
                    <span class="n">module</span><span class="p">,</span> <span class="n">view_ref</span> <span class="o">=</span> <span class="n">view_ref</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT res_id FROM ir_model_data WHERE model=&#39;ir.ui.view&#39; AND module=</span><span class="si">%s</span><span class="s2"> AND name=</span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">view_ref</span><span class="p">))</span>
                    <span class="n">view_ref_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">view_ref_res</span><span class="p">:</span>
                        <span class="n">view_id</span> <span class="o">=</span> <span class="n">view_ref_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s1">&#39;</span><span class="si">%r</span><span class="s1"> requires a fully-qualified external id (got: </span><span class="si">%r</span><span class="s1"> for model </span><span class="si">%s</span><span class="s1">). &#39;</span>
                        <span class="s1">&#39;Please use the complete `module.view_id` form instead.&#39;</span><span class="p">,</span> <span class="n">view_ref_key</span><span class="p">,</span> <span class="n">view_ref</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">view_id</span><span class="p">:</span>
                <span class="c1"># otherwise try to find the lowest priority matching ir.ui.view</span>
                <span class="n">view_id</span> <span class="o">=</span> <span class="n">View</span><span class="o">.</span><span class="n">default_view</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">view_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">view_id</span><span class="p">:</span>
            <span class="c1"># read the view with inherited views applied</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">View</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">view_id</span><span class="p">)</span>
            <span class="n">arch</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">_get_combined_arch</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># fallback on default views methods if no ir.ui.view could be found</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">View</span><span class="o">.</span><span class="n">browse</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">arch</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_get_default_</span><span class="si">%s</span><span class="s1">_view&#39;</span> <span class="o">%</span> <span class="n">view_type</span><span class="p">)()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;No default view of type &#39;</span><span class="si">%s</span><span class="s2">&#39; could be found!&quot;</span><span class="p">,</span> <span class="n">view_type</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">arch</span><span class="p">,</span> <span class="n">view</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_view_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">view_type</span><span class="o">=</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Get the key to use for caching `_get_view_cache`.</span>

<span class="sd">        This method is meant to be overriden by models needing additional keys.</span>

<span class="sd">        :param int view_id: id of the view or None</span>
<span class="sd">        :param str view_type: type of the view to return if view_id is None (&#39;form&#39;, &#39;tree&#39;, ...)</span>
<span class="sd">        :param dict options: bool options to return additional features:</span>
<span class="sd">            - bool mobile: true if the web client is currently using the responsive mobile view</span>
<span class="sd">              (to use kanban views instead of list views for x2many fields)</span>
<span class="sd">        :return: a cache key</span>
<span class="sd">        :rtype: tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">view_id</span><span class="p">,</span> <span class="n">view_type</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mobile&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span><span class="p">)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_view_ref&#39;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="nd">@tools</span><span class="o">.</span><span class="n">conditional</span><span class="p">(</span>
        <span class="s1">&#39;xml&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dev_mode&#39;</span><span class="p">],</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">ormcache</span><span class="p">(</span><span class="s1">&#39;self._get_view_cache_key(view_id, view_type, **options)&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="s1">&#39;templates&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_view_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">view_type</span><span class="o">=</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Get the view information ready to be cached</span>

<span class="sd">        The cached view includes the postprocessed view, including inherited views, for all groups.</span>
<span class="sd">        The blocks restricted to groups must therefore be removed after calling this method</span>
<span class="sd">        for users not part of the given groups.</span>

<span class="sd">        :param int view_id: id of the view or None</span>
<span class="sd">        :param str view_type: type of the view to return if view_id is None (&#39;form&#39;, &#39;tree&#39;, ...)</span>
<span class="sd">        :param dict options: boolean options to return additional features:</span>
<span class="sd">            - bool mobile: true if the web client is currently using the responsive mobile view</span>
<span class="sd">              (to use kanban views instead of list views for x2many fields)</span>
<span class="sd">        :return: a dictionnary including</span>
<span class="sd">            - string arch: the architecture of the view (including inherited views, postprocessed, for all groups)</span>
<span class="sd">            - int id: the view id</span>
<span class="sd">            - string model: the view model</span>
<span class="sd">            - dict models: the fields of the models used in the view (including sub-views)</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the view arch and all other attributes describing the composition of the view</span>
        <span class="n">arch</span><span class="p">,</span> <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_view</span><span class="p">(</span><span class="n">view_id</span><span class="p">,</span> <span class="n">view_type</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

        <span class="c1"># Apply post processing, groups and modifiers etc...</span>
        <span class="n">arch</span><span class="p">,</span> <span class="n">models</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">postprocess_and_fields</span><span class="p">(</span><span class="n">arch</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="n">models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_view_fields</span><span class="p">(</span><span class="n">view_type</span> <span class="ow">or</span> <span class="n">view</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">models</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;arch&#39;</span><span class="p">:</span> <span class="n">arch</span><span class="p">,</span>
            <span class="c1"># TODO: only `web_studio` seems to require this. I guess this is acceptable to keep it.</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">view</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="c1"># TODO: only `web_studio` seems to require this. But this one on the other hand should be eliminated:</span>
            <span class="c1"># you just called `get_views` for that model, so obviously the web client already knows the model.</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
            <span class="c1"># Set a frozendict and tuple for the field list to make sure the value in cache cannot be updated.</span>
            <span class="s1">&#39;models&#39;</span><span class="p">:</span> <span class="n">frozendict</span><span class="p">({</span><span class="n">model</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">fields</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">()}),</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">frozendict</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<div class="viewcode-block" id="Model.get_view">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.Model.get_view">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">get_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">view_type</span><span class="o">=</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; get_view([view_id | view_type=&#39;form&#39;])</span>

<span class="sd">        Get the detailed composition of the requested view like model, view architecture.</span>

<span class="sd">        The return of the method can only depend on the requested view types,</span>
<span class="sd">        access rights (views or other records), view access rules, options,</span>
<span class="sd">        context lang and TYPE_view_ref (other context values cannot be used).</span>

<span class="sd">        :param int view_id: id of the view or None</span>
<span class="sd">        :param str view_type: type of the view to return if view_id is None (&#39;form&#39;, &#39;tree&#39;, ...)</span>
<span class="sd">        :param dict options: boolean options to return additional features:</span>
<span class="sd">            - bool mobile: true if the web client is currently using the responsive mobile view</span>
<span class="sd">            (to use kanban views instead of list views for x2many fields)</span>
<span class="sd">        :return: composition of the requested view (including inherited views and extensions)</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        :raise AttributeError:</span>

<span class="sd">            * if the inherited view has unknown position to work with other than &#39;before&#39;, &#39;after&#39;, &#39;inside&#39;, &#39;replace&#39;</span>
<span class="sd">            * if some tag other than &#39;position&#39; is found in parent view</span>

<span class="sd">        :raise Invalid ArchitectureError: if there is view type other than form, tree, calendar, search etc... defined on the structure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_view_cache</span><span class="p">(</span><span class="n">view_id</span><span class="p">,</span> <span class="n">view_type</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">))</span>

        <span class="n">node</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;arch&#39;</span><span class="p">])</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_postprocess_access_rights</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;arch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;unicode&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_view_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_type</span><span class="p">,</span> <span class="n">models</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Returns the field names required by the web client to load the views according to the view type.</span>

<span class="sd">        The method is meant to be overridden by modules extending web client features and requiring additional</span>
<span class="sd">        fields.</span>

<span class="sd">        :param string view_type: type of the view</span>
<span class="sd">        :param dict models: dict holding the models and fields used in the view architecture.</span>
<span class="sd">        :return: dict holding the models and field required by the web client given the view type.</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">view_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;kanban&#39;</span><span class="p">,</span> <span class="s1">&#39;tree&#39;</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">model_fields</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">model_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;write_date&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
                    <span class="n">model_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;write_date&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">view_type</span> <span class="o">==</span> <span class="s1">&#39;search&#39;</span><span class="p">:</span>
            <span class="n">models</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">view_type</span> <span class="o">==</span> <span class="s1">&#39;graph&#39;</span><span class="p">:</span>
            <span class="n">models</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">fname</span> <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">view_type</span> <span class="o">==</span> <span class="s1">&#39;pivot&#39;</span><span class="p">:</span>
            <span class="n">models</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">fname</span> <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">groupable</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">models</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_view_field_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Returns the field attributes required by the web client to load the views.</span>

<span class="sd">        The method is meant to be overridden by modules extending web client features and requiring additional</span>
<span class="sd">        field attributes.</span>

<span class="sd">        :return: string list of field attribute names</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s1">&#39;change_default&#39;</span><span class="p">,</span> <span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="s1">&#39;currency_field&#39;</span><span class="p">,</span> <span class="s1">&#39;definition_record&#39;</span><span class="p">,</span> <span class="s1">&#39;definition_record_field&#39;</span><span class="p">,</span> <span class="s1">&#39;digits&#39;</span><span class="p">,</span> <span class="s1">&#39;domain&#39;</span><span class="p">,</span> <span class="s1">&#39;group_operator&#39;</span><span class="p">,</span> <span class="s1">&#39;groups&#39;</span><span class="p">,</span>
            <span class="s1">&#39;help&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;readonly&#39;</span><span class="p">,</span> <span class="s1">&#39;related&#39;</span><span class="p">,</span> <span class="s1">&#39;relation&#39;</span><span class="p">,</span> <span class="s1">&#39;relation_field&#39;</span><span class="p">,</span> <span class="s1">&#39;required&#39;</span><span class="p">,</span> <span class="s1">&#39;searchable&#39;</span><span class="p">,</span> <span class="s1">&#39;selection&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sortable&#39;</span><span class="p">,</span> <span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;translate&#39;</span><span class="p">,</span> <span class="s1">&#39;trim&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span>
        <span class="p">]</span>

<div class="viewcode-block" id="Model.get_formview_id">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.Model.get_formview_id">[docs]</a>
    <span class="k">def</span> <span class="nf">get_formview_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">access_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return a view id to open the document ``self`` with. This method is</span>
<span class="sd">            meant to be overridden in addons that want to give specific view ids</span>
<span class="sd">            for example.</span>

<span class="sd">            Optional access_uid holds the user that would access the form view</span>
<span class="sd">            id different from the current environment user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Model.get_formview_action">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.Model.get_formview_action">[docs]</a>
    <span class="k">def</span> <span class="nf">get_formview_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">access_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return an action to open the document ``self``. This method is meant</span>
<span class="sd">            to be overridden in addons that want to give specific view ids for</span>
<span class="sd">            example.</span>

<span class="sd">        An optional access_uid holds the user that will access the document</span>
<span class="sd">        that could be different from the current user. &quot;&quot;&quot;</span>
        <span class="n">view_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">get_formview_id</span><span class="p">(</span><span class="n">access_uid</span><span class="o">=</span><span class="n">access_uid</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.act_window&#39;</span><span class="p">,</span>
            <span class="s1">&#39;res_model&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
            <span class="s1">&#39;views&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="n">view_id</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">)],</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;current&#39;</span><span class="p">,</span>
            <span class="s1">&#39;res_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">),</span>
        <span class="p">}</span></div>


    <span class="k">def</span> <span class="nf">_get_records_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return an action to open given records.</span>
<span class="sd">            If there&#39;s more than one record, it will be a List, otherwise it&#39;s a Form.</span>
<span class="sd">            Given keyword arguments will overwrite default ones. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">length_dependent</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;views&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">)]}</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">length_dependent</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;views&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">)],</span> <span class="s1">&#39;res_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">length_dependent</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;views&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">),</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">)],</span>
                <span class="s1">&#39;domain&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)]</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.act_window&#39;</span><span class="p">,</span>
            <span class="s1">&#39;res_model&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;current&#39;</span><span class="p">,</span>
            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">),</span>
            <span class="o">**</span><span class="n">length_dependent</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">}</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_onchange_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the onchange spec from a view description; if not given, the</span>
<span class="sd">            result of ``self.get_view()`` is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># for traversing the XML arch and populating result</span>
        <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;field&#39;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">prefix</span> <span class="k">else</span> <span class="n">name</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">names</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;on_change&#39;</span><span class="p">)</span>
                <span class="c1"># traverse the subviews included in relational fields</span>
                <span class="k">for</span> <span class="n">child_view</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&quot;./*[descendant::field]&quot;</span><span class="p">):</span>
                    <span class="n">process</span><span class="p">(</span><span class="n">child_view</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                    <span class="n">process</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">view_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">view_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_view</span><span class="p">()</span>
        <span class="n">process</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">view_info</span><span class="p">[</span><span class="s1">&#39;arch&#39;</span><span class="p">]),</span> <span class="n">view_info</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_fields_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the fields specification from a view description; if not</span>
<span class="sd">        given, the result of ``self.get_view()`` is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">fill_spec</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">fields_spec</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;field&#39;</span><span class="p">:</span>
                <span class="n">field_name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">field_spec</span> <span class="o">=</span> <span class="n">fields_spec</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">sub_fields_spec</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2one&#39;</span><span class="p">:</span>
                        <span class="n">sub_fields_spec</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;display_name&#39;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">relational</span><span class="p">:</span>
                        <span class="n">comodel</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                            <span class="n">fill_spec</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">comodel</span><span class="p">,</span> <span class="n">sub_fields_spec</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;one2many&#39;</span><span class="p">:</span>
                        <span class="n">sub_fields_spec</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">inverse_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">sub_fields_spec</span><span class="p">:</span>
                        <span class="n">field_spec</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;fields&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sub_fields_spec</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                    <span class="n">fill_spec</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">fields_spec</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">view_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">view_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_view</span><span class="p">()</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fill_spec</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">view_info</span><span class="p">[</span><span class="s1">&#39;arch&#39;</span><span class="p">]),</span> <span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="NameManager">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.NameManager">[docs]</a>
<span class="k">class</span> <span class="nc">NameManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; An object that manages all the named elements in a view. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_fields</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>  <span class="c1"># {field_name: {&#39;groups&#39;: groups, &#39;info&#39;: field_info}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_actions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mandatory_fields</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>  <span class="c1"># {field_name: {&#39;groups&#39;: &#39;use}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mandatory_parent_fields</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>  <span class="c1"># {field_name: {&#39;groups&#39;: use}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mandatory_names</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>           <span class="c1"># {name: use}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">must_exist_actions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">must_exist_groups</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">field_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">field_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fields_get</span><span class="p">(</span><span class="n">attributes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;readonly&#39;</span><span class="p">,</span> <span class="s1">&#39;required&#39;</span><span class="p">])</span>
        <span class="n">has_access</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">has_access</span><span class="p">(</span><span class="s1">&#39;write&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">has_access</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">field_info</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;readonly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">field_info</span>

<div class="viewcode-block" id="NameManager.has_field">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.NameManager.has_field">[docs]</a>
    <span class="k">def</span> <span class="nf">has_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">frozendict</span><span class="p">()):</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_node_groups</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="NameManager.has_action">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.NameManager.has_action">[docs]</a>
    <span class="k">def</span> <span class="nf">has_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_actions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="NameManager.must_have_field">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.NameManager.must_have_field">[docs]</a>
    <span class="k">def</span> <span class="nf">must_have_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">use</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">node_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_node_groups</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">groups</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span> <span class="o">+</span> <span class="n">node_groups</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">node_groups</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;parent.&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mandatory_parent_fields</span><span class="p">[</span><span class="n">name</span><span class="p">[</span><span class="mi">7</span><span class="p">:]][</span><span class="n">groups</span><span class="p">]</span> <span class="o">=</span> <span class="n">use</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mandatory_fields</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">groups</span><span class="p">]</span> <span class="o">=</span> <span class="n">use</span></div>


<div class="viewcode-block" id="NameManager.must_have_fields">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.NameManager.must_have_fields">[docs]</a>
    <span class="k">def</span> <span class="nf">must_have_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">use</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">must_have_field</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">use</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">)</span></div>


<div class="viewcode-block" id="NameManager.must_have_name">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.NameManager.must_have_name">[docs]</a>
    <span class="k">def</span> <span class="nf">must_have_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">use</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mandatory_names</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">use</span></div>


<div class="viewcode-block" id="NameManager.must_exist_action">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.NameManager.must_exist_action">[docs]</a>
    <span class="k">def</span> <span class="nf">must_exist_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_id</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">must_exist_actions</span><span class="p">[</span><span class="n">action_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span></div>


<div class="viewcode-block" id="NameManager.must_exist_group">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.NameManager.must_exist_group">[docs]</a>
    <span class="k">def</span> <span class="nf">must_exist_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">must_exist_groups</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span></div>


    <span class="k">def</span> <span class="nf">_get_node_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">([</span><span class="n">node</span><span class="p">],</span> <span class="n">node</span><span class="o">.</span><span class="n">iterancestors</span><span class="p">())</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">))</span>

<div class="viewcode-block" id="NameManager.check">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.NameManager.check">[docs]</a>
    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
        <span class="c1"># context for translations below</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span>          <span class="c1"># pylint: disable=unused-variable</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">use</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mandatory_names</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_actions</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_names</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;Name or id </span><span class="si">%(name_or_id)r</span><span class="s2"> in </span><span class="si">%(use)s</span><span class="s2"> must be present in view but is missing.&quot;</span><span class="p">,</span>
                    <span class="n">name_or_id</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">use</span><span class="o">=</span><span class="n">use</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">view</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_fields</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_info</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Field `</span><span class="si">%(name)s</span><span class="s2">` does not exist&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
                <span class="n">view</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">must_exist_actions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># logic mimics /web/action/load behaviour</span>
            <span class="n">action</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">action_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">model</span><span class="p">,</span> <span class="n">action_id</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_xmlid_to_res_model_res_id</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">raise_if_not_found</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">action_id</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Invalid xmlid </span><span class="si">%(xmlid)s</span><span class="s2"> for button of type action.&quot;</span><span class="p">,</span> <span class="n">xmlid</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">view</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="n">model</span><span class="p">],</span> <span class="n">view</span><span class="o">.</span><span class="n">pool</span><span class="p">[</span><span class="s1">&#39;ir.actions.actions&#39;</span><span class="p">]):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%(xmlid)s</span><span class="s2"> is of type </span><span class="si">%(xmlid_model)s</span><span class="s2">, expected a subclass of ir.actions.actions&quot;</span><span class="p">,</span>
                        <span class="n">xmlid</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">xmlid_model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">view</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.actions.actions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">action_id</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">action</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;Action </span><span class="si">%(action_reference)s</span><span class="s2"> (id: </span><span class="si">%(action_id)s</span><span class="s2">) does not exist for button of type action.&quot;</span><span class="p">,</span>
                    <span class="n">action_reference</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">action_id</span><span class="o">=</span><span class="n">action_id</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">view</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">must_exist_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">view</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_xmlid_to_res_id</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">raise_if_not_found</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;The group </span><span class="si">%(name)r</span><span class="s2"> defined in view does not exist!&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
                <span class="n">view</span><span class="o">.</span><span class="n">_log_view_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">groups_uses</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mandatory_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">use</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">groups_uses</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>  <span class="c1"># always available</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;Invalid composed field </span><span class="si">%(definition)s</span><span class="s2"> in </span><span class="si">%(use)s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">definition</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">use</span><span class="o">=</span><span class="n">use</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">view</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;active_id&#39;</span><span class="p">,</span> <span class="s1">&#39;active_ids&#39;</span><span class="p">,</span> <span class="s1">&#39;active_model&#39;</span><span class="p">]:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Using active_id, active_ids and active_model in expressions is deprecated, found </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;Field </span><span class="si">%(name)r</span><span class="s2"> used in </span><span class="si">%(use)s</span><span class="s2"> must be present in view but is missing.&quot;</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">use</span><span class="o">=</span><span class="n">use</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">view</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;select&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;multi&#39;</span><span class="p">:</span>  <span class="c1"># mainly for searchpanel, but can be a generic behaviour.</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                    <span class="s2">&quot;Field </span><span class="si">%(name)r</span><span class="s2"> used in </span><span class="si">%(use)s</span><span class="s2"> is present in view but is in select multi.&quot;</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">use</span><span class="o">=</span><span class="n">use</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">view</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">combinate</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
                <span class="c1"># [[&#39;A&#39;], [&#39;B&#39;, &#39;C&#39;], [&#39;D&#39;, &#39;E&#39;]]</span>
                <span class="c1"># returns</span>
                <span class="c1"># [[&#39;A&#39;, &#39;B&#39;, &#39;D&#39;], [&#39;A&#39;, &#39;C&#39;, &#39;D&#39;], [&#39;A&#39;, &#39;B&#39;, &#39;E&#39;], [&#39;A&#39;, &#39;C&#39;, &#39;E&#39;]]</span>

                <span class="c1"># [[&#39;!A&#39;, &#39;!B&#39;], [&#39;C&#39;, &#39;D&#39;]]</span>
                <span class="c1"># returns</span>
                <span class="c1"># [[&#39;!A&#39;, &#39;!B&#39;, &#39;C&#39;], [&#39;!A&#39;, &#39;!B&#39;, &#39;D&#39;]]</span>

                <span class="c1"># [[&#39;A&#39;, &#39;B&#39;], [&#39;!C&#39;, &#39;!D&#39;]]</span>
                <span class="c1"># returns</span>
                <span class="c1"># [[&#39;A&#39;, &#39;!C&#39;, &#39;!D&#39;], [&#39;B&#39;, &#39;!C&#39;, &#39;!D&#39;]]</span>

                <span class="c1"># [[&#39;!A&#39;, &#39;!B&#39;, &#39;C&#39;, &#39;D&#39;], [&#39;E&#39;, &#39;F&#39;]]</span>
                <span class="c1"># returns</span>
                <span class="c1"># [[&#39;!A&#39;, &#39;!B&#39;, &#39;C&#39;, &#39;E&#39;], [&#39;!A&#39;, &#39;!B&#39;, &#39;D&#39;, &#39;E&#39;], [&#39;!A&#39;, &#39;!B&#39;, &#39;C&#39;, &#39;F&#39;], [&#39;!A&#39;, &#39;!B&#39;, &#39;D&#39;, &#39;F&#39;]]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">groups</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[]</span>
                <span class="n">positive</span> <span class="o">=</span> <span class="p">[(</span><span class="n">group</span><span class="p">,)</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">group</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">group</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">)]</span>
                <span class="n">negative</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">group</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">group</span> <span class="ow">and</span> <span class="n">group</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">))</span>
                <span class="n">combinations</span> <span class="o">=</span> <span class="p">[</span><span class="n">negative</span> <span class="o">+</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">positive</span><span class="p">]</span> <span class="k">if</span> <span class="n">positive</span> <span class="k">else</span> <span class="p">[</span><span class="n">negative</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">combinations</span> <span class="o">=</span> <span class="p">[</span><span class="n">group</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">combinate</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">]</span>
                <span class="k">return</span> <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">combination</span><span class="p">)</span> <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">combination</span><span class="p">)</span> <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">mandatory_for_groups</span><span class="p">,</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">groups_uses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">mandatory_combinations</span> <span class="o">=</span> <span class="n">combinate</span><span class="p">(</span><span class="n">mandatory_for_groups</span> <span class="ow">or</span> <span class="p">[(</span><span class="kc">None</span><span class="p">,)])</span>
                <span class="n">available_combinations</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">combination</span>
                    <span class="k">for</span> <span class="n">available_for_groups</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_fields</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;groups&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="n">combinate</span><span class="p">(</span><span class="n">available_for_groups</span> <span class="ow">or</span> <span class="p">[(</span><span class="kc">None</span><span class="p">,)])</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="c1"># If (None,) is in available_combinations,</span>
                    <span class="c1"># it means the field is in the view without any group restriction,</span>
                    <span class="c1"># and is therefore available for anyone / any group</span>
                    <span class="p">{</span><span class="kc">None</span><span class="p">}</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available_combinations</span>
                    <span class="c1"># If there are two mutually exclusive combinations,</span>
                    <span class="c1"># it means the field is available for anyone / any group</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                        <span class="p">{</span><span class="n">group</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;!&#39;</span> <span class="o">+</span> <span class="n">group</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">combination</span><span class="p">}</span>
                        <span class="ow">in</span> <span class="n">available_combinations</span>
                        <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="n">available_combinations</span>
                    <span class="p">)</span>
                    <span class="ow">and</span> <span class="p">((</span>
                    <span class="c1"># For all mandatory combinations, find an available combination</span>
                    <span class="c1"># which is included in the mandatory combination</span>
                    <span class="c1"># e.g.</span>
                    <span class="c1"># mandatory combination: A B C</span>
                    <span class="c1"># available combination: A B</span>
                    <span class="c1"># The above is valid, the field will be available for users having both A and B groups</span>
                    <span class="c1"># and the field is mandatory only for users having A B and C groups.</span>
                    <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
                        <span class="nb">any</span><span class="p">(</span>
                            <span class="n">available_combination</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">mandatory_combination</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">available_combination</span> <span class="ow">in</span> <span class="n">available_combinations</span>
                        <span class="p">)</span> <span class="k">for</span> <span class="n">mandatory_combination</span> <span class="ow">in</span> <span class="n">mandatory_combinations</span>
                    <span class="p">)</span>
                    <span class="c1"># Same than above but take into account implied groups (e.g. group_system includes group_erp_manager and group_user)</span>
                    <span class="c1"># for positive groups</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
                        <span class="nb">any</span><span class="p">(</span>
                            <span class="n">available_combination</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">combination</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">available_combination</span> <span class="ow">in</span> <span class="n">available_combinations</span>
                            <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span>
                            <span class="p">(</span>
                                <span class="n">mandatory_combination</span> <span class="o">-</span> <span class="p">{</span><span class="n">group</span><span class="p">}</span> <span class="o">|</span> <span class="p">{</span><span class="n">trans_group</span><span class="p">}</span>
                                <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">mandatory_combination</span> <span class="k">if</span> <span class="n">group</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">group</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">trans_group</span> <span class="ow">in</span> <span class="n">view</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">trans_implied_ids</span><span class="o">.</span><span class="n">get_external_id</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">for</span> <span class="n">mandatory_combination</span> <span class="ow">in</span> <span class="n">mandatory_combinations</span>
                    <span class="p">)</span>
                    <span class="c1"># Same than above but take into account implied groups (e.g. group_system includes group_erp_manager and group_user)</span>
                    <span class="c1"># for negative groups</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
                        <span class="nb">any</span><span class="p">(</span>
                            <span class="n">combination</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">mandatory_combination</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">available_combination</span> <span class="ow">in</span> <span class="n">available_combinations</span>
                            <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span>
                            <span class="p">(</span>
                                <span class="n">available_combination</span> <span class="o">-</span> <span class="p">{</span><span class="n">group</span><span class="p">}</span> <span class="o">|</span> <span class="p">{</span><span class="s1">&#39;!&#39;</span> <span class="o">+</span> <span class="n">trans_group</span><span class="p">}</span>
                                <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">available_combination</span> <span class="k">if</span> <span class="n">group</span> <span class="ow">and</span> <span class="n">group</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">trans_group</span> <span class="ow">in</span> <span class="n">view</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">trans_implied_ids</span><span class="o">.</span><span class="n">get_external_id</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                            <span class="p">)</span>
                        <span class="p">)</span> <span class="k">for</span> <span class="n">mandatory_combination</span> <span class="ow">in</span> <span class="n">mandatory_combinations</span>
                    <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="c1"># if &#39;base.group_no_one&#39; is in available_combinations the group</span>
                    <span class="c1"># must be in mandatory_combinations because depending of session</span>
                    <span class="ow">or</span> <span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;base.group_no_one&#39;</span><span class="p">}</span> <span class="ow">in</span> <span class="n">available_combinations</span> <span class="ow">and</span>
                        <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="s1">&#39;base.group_no_one&#39;</span> <span class="ow">in</span> <span class="n">combination</span> <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="n">mandatory_combinations</span><span class="p">)</span>
                    <span class="p">))</span>
                <span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;Field </span><span class="si">%(name)r</span><span class="s2"> used in </span><span class="si">%(use)s</span><span class="s2"> is restricted to the group(s) </span><span class="si">%(groups)s</span><span class="s2">.&quot;</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">use</span><span class="o">=</span><span class="n">use</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">group</span>
                            <span class="k">for</span> <span class="n">availability</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_fields</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;groups&#39;</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">combination</span> <span class="ow">in</span> <span class="n">availability</span>
                            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">combination</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">view</span><span class="o">.</span><span class="n">_raise_view_error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="NameManager.update_available_fields">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.ir_ui_view.NameManager.update_available_fields">[docs]</a>
    <span class="k">def</span> <span class="nf">update_available_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">()))</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Amr.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>