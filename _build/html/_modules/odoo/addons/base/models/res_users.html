<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>odoo.addons.base.models.res_users &mdash; Amr  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Amr
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modules.html">odoo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Amr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../../odoo.html">odoo</a></li>
          <li class="breadcrumb-item"><a href="../../base.html">odoo.addons.base</a></li>
      <li class="breadcrumb-item active">odoo.addons.base.models.res_users</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for odoo.addons.base.models.res_users</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># Part of Odoo. See LICENSE file for full copyright and licensing details.</span>

<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">hmac</span>
<span class="kn">import</span> <span class="nn">ipaddress</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">repeat</span>
<span class="kn">from</span> <span class="nn">markupsafe</span> <span class="kn">import</span> <span class="n">Markup</span>

<span class="kn">import</span> <span class="nn">babel.core</span>
<span class="kn">import</span> <span class="nn">pytz</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
<span class="kn">from</span> <span class="nn">lxml.builder</span> <span class="kn">import</span> <span class="n">E</span>
<span class="kn">from</span> <span class="nn">passlib.context</span> <span class="kn">import</span> <span class="n">CryptContext</span>
<span class="kn">from</span> <span class="nn">psycopg2</span> <span class="kn">import</span> <span class="n">sql</span>

<span class="kn">from</span> <span class="nn">odoo</span> <span class="kn">import</span> <span class="n">api</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">tools</span><span class="p">,</span> <span class="n">SUPERUSER_ID</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Command</span>
<span class="kn">from</span> <span class="nn">odoo.addons.base.models.ir_model</span> <span class="kn">import</span> <span class="n">MODULE_UNINSTALL_FLAG</span>
<span class="kn">from</span> <span class="nn">odoo.exceptions</span> <span class="kn">import</span> <span class="n">AccessDenied</span><span class="p">,</span> <span class="n">AccessError</span><span class="p">,</span> <span class="n">UserError</span><span class="p">,</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">odoo.http</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">DEFAULT_LANG</span>
<span class="kn">from</span> <span class="nn">odoo.osv</span> <span class="kn">import</span> <span class="n">expression</span>
<span class="kn">from</span> <span class="nn">odoo.service.db</span> <span class="kn">import</span> <span class="n">check_super</span>
<span class="kn">from</span> <span class="nn">odoo.tools</span> <span class="kn">import</span> <span class="n">is_html_empty</span><span class="p">,</span> <span class="n">partition</span><span class="p">,</span> <span class="n">collections</span><span class="p">,</span> <span class="n">frozendict</span><span class="p">,</span> <span class="n">lazy_property</span>

<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Only users who can modify the user (incl. the user herself) see the real contents of these fields</span>
<span class="n">USER_PRIVATE_FIELDS</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">MIN_ROUNDS</span> <span class="o">=</span> <span class="mi">600_000</span>
<span class="n">concat</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span>

<span class="c1">#</span>
<span class="c1"># Functions for manipulating boolean and selection pseudo-fields</span>
<span class="c1">#</span>
<div class="viewcode-block" id="name_boolean_group">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.name_boolean_group">[docs]</a>
<span class="k">def</span> <span class="nf">name_boolean_group</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;in_group_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span></div>


<div class="viewcode-block" id="name_selection_groups">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.name_selection_groups">[docs]</a>
<span class="k">def</span> <span class="nf">name_selection_groups</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;sel_groups_&#39;</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span></div>


<div class="viewcode-block" id="is_boolean_group">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.is_boolean_group">[docs]</a>
<span class="k">def</span> <span class="nf">is_boolean_group</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;in_group_&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_selection_groups">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.is_selection_groups">[docs]</a>
<span class="k">def</span> <span class="nf">is_selection_groups</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;sel_groups_&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_reified_group">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.is_reified_group">[docs]</a>
<span class="k">def</span> <span class="nf">is_reified_group</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">is_boolean_group</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_selection_groups</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_boolean_group">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.get_boolean_group">[docs]</a>
<span class="k">def</span> <span class="nf">get_boolean_group</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">9</span><span class="p">:])</span></div>


<div class="viewcode-block" id="get_selection_groups">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.get_selection_groups">[docs]</a>
<span class="k">def</span> <span class="nf">get_selection_groups</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">name</span><span class="p">[</span><span class="mi">11</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span></div>


<div class="viewcode-block" id="parse_m2m">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.parse_m2m">[docs]</a>
<span class="k">def</span> <span class="nf">parse_m2m</span><span class="p">(</span><span class="n">commands</span><span class="p">):</span>
    <span class="s2">&quot;return a list of ids corresponding to a many2many value&quot;</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Command</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span> <span class="n">Command</span><span class="o">.</span><span class="n">LINK</span><span class="p">):</span>
                <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">Command</span><span class="o">.</span><span class="n">CLEAR</span><span class="p">:</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">Command</span><span class="o">.</span><span class="n">SET</span><span class="p">:</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ids</span></div>


<span class="k">def</span> <span class="nf">_jsonable</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="check_identity">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.check_identity">[docs]</a>
<span class="k">def</span> <span class="nf">check_identity</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Wrapped method should be an *action method* (called from a button</span>
<span class="sd">    type=object), and requires extra security to be executed. This decorator</span>
<span class="sd">    checks if the identity (password) has been checked in the last 10mn, and</span>
<span class="sd">    pops up an identity check wizard if not.</span>

<span class="sd">    Prevents access outside of interactive contexts (aka with a request)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;This method can only be accessed over HTTP&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;identity-check-last&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">60</span><span class="p">:</span>
            <span class="c1"># update identity-check-last like github?</span>
            <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users.identitycheck&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span>
                <span class="p">{</span> <span class="c1"># strip non-jsonable keys (e.g. mapped to recordsets)</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">_jsonable</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="p">},</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span>
                <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="p">])</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.act_window&#39;</span><span class="p">,</span>
            <span class="s1">&#39;res_model&#39;</span><span class="p">:</span> <span class="s1">&#39;res.users.identitycheck&#39;</span><span class="p">,</span>
            <span class="s1">&#39;res_id&#39;</span><span class="p">:</span> <span class="n">w</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Security Control&quot;</span><span class="p">),</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span>
            <span class="s1">&#39;views&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">)],</span>
        <span class="p">}</span>
    <span class="n">wrapped</span><span class="o">.</span><span class="n">__has_check_identity</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">wrapped</span></div>


<span class="c1">#----------------------------------------------------------</span>
<span class="c1"># Basic res.groups and res.users</span>
<span class="c1">#----------------------------------------------------------</span>

<div class="viewcode-block" id="Groups">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Groups">[docs]</a>
<span class="k">class</span> <span class="nc">Groups</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s2">&quot;res.groups&quot;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s2">&quot;Access Groups&quot;</span>
    <span class="n">_rec_name</span> <span class="o">=</span> <span class="s1">&#39;full_name&#39;</span>
    <span class="n">_order</span> <span class="o">=</span> <span class="s1">&#39;name&#39;</span>
    <span class="n">_allow_sudo_commands</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">translate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2many</span><span class="p">(</span><span class="s1">&#39;res.users&#39;</span><span class="p">,</span> <span class="s1">&#39;res_groups_users_rel&#39;</span><span class="p">,</span> <span class="s1">&#39;gid&#39;</span><span class="p">,</span> <span class="s1">&#39;uid&#39;</span><span class="p">)</span>
    <span class="n">model_access</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">One2many</span><span class="p">(</span><span class="s1">&#39;ir.model.access&#39;</span><span class="p">,</span> <span class="s1">&#39;group_id&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Access Controls&#39;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">rule_groups</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2many</span><span class="p">(</span><span class="s1">&#39;ir.rule&#39;</span><span class="p">,</span> <span class="s1">&#39;rule_group_rel&#39;</span><span class="p">,</span>
        <span class="s1">&#39;group_id&#39;</span><span class="p">,</span> <span class="s1">&#39;rule_group_id&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Rules&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s2">&quot;[(&#39;global&#39;, &#39;=&#39;, False)]&quot;</span><span class="p">)</span>
    <span class="n">menu_access</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2many</span><span class="p">(</span><span class="s1">&#39;ir.ui.menu&#39;</span><span class="p">,</span> <span class="s1">&#39;ir_ui_menu_group_rel&#39;</span><span class="p">,</span> <span class="s1">&#39;gid&#39;</span><span class="p">,</span> <span class="s1">&#39;menu_id&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Access Menu&#39;</span><span class="p">)</span>
    <span class="n">view_access</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2many</span><span class="p">(</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">,</span> <span class="s1">&#39;ir_ui_view_group_rel&#39;</span><span class="p">,</span> <span class="s1">&#39;group_id&#39;</span><span class="p">,</span> <span class="s1">&#39;view_id&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Views&#39;</span><span class="p">)</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">translate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">category_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;ir.module.category&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Application&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Integer</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Color Index&#39;</span><span class="p">)</span>
    <span class="n">full_name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_full_name&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Group Name&#39;</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="s1">&#39;_search_full_name&#39;</span><span class="p">)</span>
    <span class="n">share</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Share Group&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Group created to set access rights for sharing data with some users.&quot;</span><span class="p">)</span>

    <span class="n">_sql_constraints</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;name_uniq&#39;</span><span class="p">,</span> <span class="s1">&#39;unique (category_id, name)&#39;</span><span class="p">,</span> <span class="s1">&#39;The name of the group must be unique within an application!&#39;</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_one_user_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">_check_one_user_type</span><span class="p">()</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">ondelete</span><span class="p">(</span><span class="n">at_uninstall</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_unlink_except_settings_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">classified</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.config.settings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_classified_fields</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_name</span><span class="p">,</span> <span class="n">_groups</span><span class="p">,</span> <span class="n">implied_group</span> <span class="ow">in</span> <span class="n">classified</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">implied_group</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;You cannot delete a group linked with a settings field.&#39;</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;category_id.name&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_full_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Important: value must be stored in environment of group, not group1!</span>
        <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">group1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">group1</span><span class="o">.</span><span class="n">category_id</span><span class="p">:</span>
                <span class="n">group</span><span class="o">.</span><span class="n">full_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> / </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">group1</span><span class="o">.</span><span class="n">category_id</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">group1</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group</span><span class="o">.</span><span class="n">full_name</span> <span class="o">=</span> <span class="n">group1</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">_search_full_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">operand</span><span class="p">):</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[[(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">operand</span><span class="p">)]]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operand</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">operand</span> <span class="o">=</span> <span class="p">[</span><span class="n">operand</span><span class="p">]</span>
        <span class="n">where</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">operand</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="p">]</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">category_name</span> <span class="o">=</span> <span class="n">values</span> <span class="ow">and</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="n">group_name</span>
            <span class="n">group_domain</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">lst</span> <span class="ow">and</span> <span class="p">[</span><span class="n">group_name</span><span class="p">]</span> <span class="ow">or</span> <span class="n">group_name</span><span class="p">)]</span>
            <span class="n">category_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.module.category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">_search</span><span class="p">(</span>
                <span class="p">[(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="p">[</span><span class="n">category_name</span><span class="p">]</span> <span class="k">if</span> <span class="n">lst</span> <span class="k">else</span> <span class="n">category_name</span><span class="p">)])</span>
            <span class="n">category_domain</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;category_id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">category_ids</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">operator</span> <span class="ow">in</span> <span class="n">expression</span><span class="o">.</span><span class="n">NEGATIVE_TERM_OPERATORS</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">category_domain</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">OR</span><span class="p">([</span><span class="n">category_domain</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;category_id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">operator</span> <span class="ow">in</span> <span class="n">expression</span><span class="o">.</span><span class="n">NEGATIVE_TERM_OPERATORS</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="ow">not</span> <span class="n">values</span><span class="p">):</span>
                <span class="n">sub_where</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">AND</span><span class="p">([</span><span class="n">group_domain</span><span class="p">,</span> <span class="n">category_domain</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sub_where</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">OR</span><span class="p">([</span><span class="n">group_domain</span><span class="p">,</span> <span class="n">category_domain</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">operator</span> <span class="ow">in</span> <span class="n">expression</span><span class="o">.</span><span class="n">NEGATIVE_TERM_OPERATORS</span><span class="p">:</span>
                <span class="n">where</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">AND</span><span class="p">([</span><span class="n">where</span><span class="p">,</span> <span class="n">sub_where</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">where</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">OR</span><span class="p">([</span><span class="n">where</span><span class="p">,</span> <span class="n">sub_where</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">where</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">access_rights_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># add explicit ordering if search is sorted on full_name</span>
        <span class="k">if</span> <span class="n">order</span> <span class="ow">and</span> <span class="n">order</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;full_name&#39;</span><span class="p">):</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">sorted</span><span class="p">(</span><span class="s1">&#39;full_name&#39;</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;DESC&#39;</span><span class="p">))</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span><span class="o">+</span><span class="n">limit</span><span class="p">]</span> <span class="k">if</span> <span class="n">limit</span> <span class="k">else</span> <span class="n">groups</span><span class="p">[</span><span class="n">offset</span><span class="p">:]</span>
            <span class="k">return</span> <span class="n">groups</span><span class="o">.</span><span class="n">_as_query</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_search</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">access_rights_uid</span><span class="p">)</span>

<div class="viewcode-block" id="Groups.copy">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Groups.copy">[docs]</a>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="n">chosen_name</span> <span class="o">=</span> <span class="n">default</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">default</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">default_name</span> <span class="o">=</span> <span class="n">chosen_name</span> <span class="ow">or</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (copy)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">default</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">default</span> <span class="ow">or</span> <span class="p">{},</span> <span class="n">name</span><span class="o">=</span><span class="n">default_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Groups</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">default</span><span class="p">)</span></div>


<div class="viewcode-block" id="Groups.write">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Groups.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;The name of the group can not start with &quot;-&quot;&#39;</span><span class="p">))</span>
        <span class="c1"># invalidate caches before updating groups, since the recomputation of</span>
        <span class="c1"># field &#39;share&#39; depends on method has_group()</span>
        <span class="c1"># DLE P139</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.access&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">call_cache_clearing_methods</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Groups</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_ensure_xml_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the groups external identifiers, creating the external identifier for groups missing one&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_external_id</span><span class="p">()</span>
        <span class="n">missings</span> <span class="o">=</span> <span class="p">{</span><span class="n">group_id</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;__custom__.group_</span><span class="si">{</span><span class="n">group_id</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">ext_id</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">ext_id</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">missings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="s1">&#39;res.groups&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;res_id&#39;</span><span class="p">:</span> <span class="n">group_id</span><span class="p">,</span>
                        <span class="s1">&#39;module&#39;</span><span class="p">:</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="p">}</span>
                    <span class="k">for</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">missings</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">missings</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="ResUsersLog">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.ResUsersLog">[docs]</a>
<span class="k">class</span> <span class="nc">ResUsersLog</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;res.users.log&#39;</span>
    <span class="n">_order</span> <span class="o">=</span> <span class="s1">&#39;id desc&#39;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s1">&#39;Users Log&#39;</span>
    <span class="c1"># Uses the magical fields `create_uid` and `create_date` for recording logins.</span>
    <span class="c1"># See `bus.presence` for more recent activity tracking purposes.</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">autovacuum</span>
    <span class="k">def</span> <span class="nf">_gc_user_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            DELETE FROM res_users_log log1 WHERE EXISTS (</span>
<span class="s2">                SELECT 1 FROM res_users_log log2</span>
<span class="s2">                WHERE log1.create_uid = log2.create_uid</span>
<span class="s2">                AND log1.create_date &lt; log2.create_date</span>
<span class="s2">            )</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;GC&#39;d </span><span class="si">%d</span><span class="s2"> user log entries&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">rowcount</span><span class="p">)</span></div>



<div class="viewcode-block" id="Users">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users">[docs]</a>
<span class="k">class</span> <span class="nc">Users</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; User class. A res.users record models an OpenERP user and is different</span>
<span class="sd">        from an employee.</span>

<span class="sd">        res.users class now inherits from res.partner. The partner model is</span>
<span class="sd">        used to store the data related to the partner: lang, name, address,</span>
<span class="sd">        avatar, ... The user model is now dedicated to technical data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s2">&quot;res.users&quot;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s1">&#39;User&#39;</span>
    <span class="n">_inherits</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;res.partner&#39;</span><span class="p">:</span> <span class="s1">&#39;partner_id&#39;</span><span class="p">}</span>
    <span class="n">_order</span> <span class="o">=</span> <span class="s1">&#39;name, login&#39;</span>
    <span class="n">_allow_sudo_commands</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_check_company_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">companies</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">companies</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="p">[(</span><span class="s1">&#39;company_ids&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">to_company_ids</span><span class="p">(</span><span class="n">companies</span><span class="p">))]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">SELF_READABLE_FIELDS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; The list of fields a user can read on their own user record.</span>
<span class="sd">        In order to add fields, please override this property on model extensions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s1">&#39;signature&#39;</span><span class="p">,</span> <span class="s1">&#39;company_id&#39;</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;image_1920&#39;</span><span class="p">,</span>
            <span class="s1">&#39;image_1024&#39;</span><span class="p">,</span> <span class="s1">&#39;image_512&#39;</span><span class="p">,</span> <span class="s1">&#39;image_256&#39;</span><span class="p">,</span> <span class="s1">&#39;image_128&#39;</span><span class="p">,</span> <span class="s1">&#39;lang&#39;</span><span class="p">,</span> <span class="s1">&#39;tz&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tz_offset&#39;</span><span class="p">,</span> <span class="s1">&#39;groups_id&#39;</span><span class="p">,</span> <span class="s1">&#39;partner_id&#39;</span><span class="p">,</span> <span class="s1">&#39;write_date&#39;</span><span class="p">,</span> <span class="s1">&#39;action_id&#39;</span><span class="p">,</span>
            <span class="s1">&#39;avatar_1920&#39;</span><span class="p">,</span> <span class="s1">&#39;avatar_1024&#39;</span><span class="p">,</span> <span class="s1">&#39;avatar_512&#39;</span><span class="p">,</span> <span class="s1">&#39;avatar_256&#39;</span><span class="p">,</span> <span class="s1">&#39;avatar_128&#39;</span><span class="p">,</span>
            <span class="s1">&#39;share&#39;</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">SELF_WRITEABLE_FIELDS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; The list of fields a user can write on their own user record.</span>
<span class="sd">        In order to add fields, please override this property on model extensions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;signature&#39;</span><span class="p">,</span> <span class="s1">&#39;action_id&#39;</span><span class="p">,</span> <span class="s1">&#39;company_id&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;image_1920&#39;</span><span class="p">,</span> <span class="s1">&#39;lang&#39;</span><span class="p">,</span> <span class="s1">&#39;tz&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_default_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Default groups for employees</span>

<span class="sd">        All the groups of the Template User</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">default_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.default_user&#39;</span><span class="p">,</span> <span class="n">raise_if_not_found</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">default_user</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">groups_id</span> <span class="k">if</span> <span class="n">default_user</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="n">partner_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;res.partner&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;restrict&#39;</span><span class="p">,</span> <span class="n">auto_join</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Related Partner&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Partner-related data of the user&#39;</span><span class="p">)</span>
    <span class="n">login</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Used to log into the system&quot;</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span>
        <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_password&#39;</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="s1">&#39;_set_password&#39;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Keep empty if you don&#39;t want the user to be able to connect on the system.&quot;</span><span class="p">)</span>
    <span class="n">new_password</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Set Password&#39;</span><span class="p">,</span>
        <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_password&#39;</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="s1">&#39;_set_new_password&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specify a value only when creating a user or if you&#39;re &quot;</span>\
             <span class="s2">&quot;changing the user&#39;s password, otherwise leave empty. After &quot;</span>\
             <span class="s2">&quot;a change of password, the user has to login again.&quot;</span><span class="p">)</span>
    <span class="n">signature</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Html</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s2">&quot;Email Signature&quot;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_signature&#39;</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">active_partner</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">related</span><span class="o">=</span><span class="s1">&#39;partner_id.active&#39;</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s2">&quot;Partner is Active&quot;</span><span class="p">)</span>
    <span class="n">action_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;ir.actions.actions&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Home Action&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If specified, this action will be opened at log on for this user, in addition to the standard menu.&quot;</span><span class="p">)</span>
    <span class="n">groups_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2many</span><span class="p">(</span><span class="s1">&#39;res.groups&#39;</span><span class="p">,</span> <span class="s1">&#39;res_groups_users_rel&#39;</span><span class="p">,</span> <span class="s1">&#39;uid&#39;</span><span class="p">,</span> <span class="s1">&#39;gid&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Groups&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">_default_groups</span><span class="p">())</span>
    <span class="n">log_ids</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">One2many</span><span class="p">(</span><span class="s1">&#39;res.users.log&#39;</span><span class="p">,</span> <span class="s1">&#39;create_uid&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;User log entries&#39;</span><span class="p">)</span>
    <span class="n">login_date</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Datetime</span><span class="p">(</span><span class="n">related</span><span class="o">=</span><span class="s1">&#39;log_ids.create_date&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Latest authentication&#39;</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">share</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_share&#39;</span><span class="p">,</span> <span class="n">compute_sudo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Share User&#39;</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
         <span class="n">help</span><span class="o">=</span><span class="s2">&quot;External user with limited access, created only for the purpose of sharing data.&quot;</span><span class="p">)</span>
    <span class="n">companies_count</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Integer</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_companies_count&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s2">&quot;Number of Companies&quot;</span><span class="p">)</span>
    <span class="n">tz_offset</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_tz_offset&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Timezone offset&#39;</span><span class="p">)</span>
    <span class="n">res_users_settings_ids</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">One2many</span><span class="p">(</span><span class="s1">&#39;res.users.settings&#39;</span><span class="p">,</span> <span class="s1">&#39;user_id&#39;</span><span class="p">)</span>
    <span class="c1"># Provide a target for relateds that is not a x2Many field.</span>
    <span class="n">res_users_settings_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;res.users.settings&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s2">&quot;Settings&quot;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_res_users_settings_id&#39;</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="s1">&#39;_search_res_users_settings_id&#39;</span><span class="p">)</span>

    <span class="c1"># Special behavior for this field: res.company.search() will only return the companies</span>
    <span class="c1"># available to the current user (should be the user&#39;s companies?), when the user_preference</span>
    <span class="c1"># context is set.</span>
    <span class="n">company_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;res.company&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Company&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The default company for this user.&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;user_preference&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
    <span class="n">company_ids</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2many</span><span class="p">(</span><span class="s1">&#39;res.company&#39;</span><span class="p">,</span> <span class="s1">&#39;res_company_users_rel&#39;</span><span class="p">,</span> <span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;cid&#39;</span><span class="p">,</span>
        <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Companies&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>

    <span class="c1"># overridden inherited fields to bypass access rights, in case you have</span>
    <span class="c1"># access to the user but not its corresponding partner</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">related</span><span class="o">=</span><span class="s1">&#39;partner_id.name&#39;</span><span class="p">,</span> <span class="n">inherited</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">related</span><span class="o">=</span><span class="s1">&#39;partner_id.email&#39;</span><span class="p">,</span> <span class="n">inherited</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">accesses_count</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Integer</span><span class="p">(</span><span class="s1">&#39;# Access Rights&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of access rights that apply to the current user&#39;</span><span class="p">,</span>
                                    <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_accesses_count&#39;</span><span class="p">,</span> <span class="n">compute_sudo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">rules_count</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Integer</span><span class="p">(</span><span class="s1">&#39;# Record Rules&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of record rules that apply to the current user&#39;</span><span class="p">,</span>
                                 <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_accesses_count&#39;</span><span class="p">,</span> <span class="n">compute_sudo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">groups_count</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Integer</span><span class="p">(</span><span class="s1">&#39;# Groups&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of groups that apply to the current user&#39;</span><span class="p">,</span>
                                  <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_accesses_count&#39;</span><span class="p">,</span> <span class="n">compute_sudo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">_sql_constraints</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;login_key&#39;</span><span class="p">,</span> <span class="s1">&#39;UNIQUE (login)&#39;</span><span class="p">,</span> <span class="s1">&#39;You can not have two users with the same login!&#39;</span><span class="p">)</span>
    <span class="p">]</span>

<div class="viewcode-block" id="Users.init">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.init">[docs]</a>
    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span>

        <span class="c1"># allow setting plaintext passwords via SQL and have them</span>
        <span class="c1"># automatically encrypted at startup: look for passwords which don&#39;t</span>
        <span class="c1"># match the &quot;extended&quot; MCF and pass those through passlib.</span>
        <span class="c1"># Alternative: iterate on *all* passwords and use CryptContext.identify</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT id, password FROM res_users</span>
<span class="s2">        WHERE password IS NOT NULL</span>
<span class="s2">          AND password !~ &#39;^\$[^$]+\$[^$]+\$.&#39;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">rowcount</span><span class="p">:</span>
            <span class="n">Users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">uid</span><span class="p">,</span> <span class="n">pw</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
                <span class="n">Users</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">pw</span></div>


    <span class="k">def</span> <span class="nf">_set_password</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crypt_context</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_encrypted_password</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">ctx</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_set_encrypted_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">pw</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crypt_context</span><span class="p">()</span><span class="o">.</span><span class="n">identify</span><span class="p">(</span><span class="n">pw</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;plaintext&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s1">&#39;UPDATE res_users SET password=</span><span class="si">%s</span><span class="s1"> WHERE id=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">pw</span><span class="p">,</span> <span class="n">uid</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">invalidate_recordset</span><span class="p">([</span><span class="s1">&#39;password&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_check_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Validates the current user&#39;s password.</span>

<span class="sd">        Override this method to plug additional authentication methods.</span>

<span class="sd">        Overrides should:</span>

<span class="sd">        * call `super` to delegate to parents for credentials-checking</span>
<span class="sd">        * catch AccessDenied and perform their own checking</span>
<span class="sd">        * (re)raise AccessDenied if the credentials are still invalid</span>
<span class="sd">          according to their own validation method</span>

<span class="sd">        When trying to check for credentials validity, call _check_credentials</span>
<span class="sd">        instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Override this method to plug additional authentication methods&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;SELECT COALESCE(password, &#39;&#39;) FROM res_users WHERE id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="p">[</span><span class="n">hashed</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="n">valid</span><span class="p">,</span> <span class="n">replacement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crypt_context</span><span class="p">()</span>\
            <span class="o">.</span><span class="n">verify_and_update</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">hashed</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">replacement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_encrypted_password</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">replacement</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AccessDenied</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compute_password</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">user</span><span class="o">.</span><span class="n">new_password</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">_set_new_password</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">new_password</span><span class="p">:</span>
                <span class="c1"># Do not update the password if no value is provided, ignore silently.</span>
                <span class="c1"># For example web client submits False values for all empty fields.</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">user</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
                <span class="c1"># To change their own password, users must use the client-specific change password wizard,</span>
                <span class="c1"># so that the new password is immediately used for further RPC requests, otherwise the user</span>
                <span class="c1"># will face unexpected &#39;Access Denied&#39; exceptions.</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Please use the change password wizard (in User Preferences or User menu) to change your own password.&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">new_password</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">user</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="n">is_html_empty</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">signature</span><span class="p">)):</span>
            <span class="n">user</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">Markup</span><span class="p">(</span><span class="s1">&#39;&lt;p&gt;--&lt;br /&gt;</span><span class="si">%s</span><span class="s1">&lt;/p&gt;&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;groups_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_share</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user_group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_xmlid_to_res_id</span><span class="p">(</span><span class="s1">&#39;base.group_user&#39;</span><span class="p">)</span>
        <span class="n">internal_users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;groups_id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">user_group_id</span><span class="p">])])</span>
        <span class="n">internal_users</span><span class="o">.</span><span class="n">share</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="p">(</span><span class="bp">self</span> <span class="o">-</span> <span class="n">internal_users</span><span class="p">)</span><span class="o">.</span><span class="n">share</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;company_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_companies_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">companies_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">search_count</span><span class="p">([])</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;tz&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_tz_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">user</span><span class="o">.</span><span class="n">tz_offset</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">tz</span> <span class="ow">or</span> <span class="s1">&#39;GMT&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%z&#39;</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;groups_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_accesses_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">groups_id</span>
            <span class="n">user</span><span class="o">.</span><span class="n">accesses_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">model_access</span><span class="p">)</span>
            <span class="n">user</span><span class="o">.</span><span class="n">rules_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">rule_groups</span><span class="p">)</span>
            <span class="n">user</span><span class="o">.</span><span class="n">groups_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;res_users_settings_ids&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_res_users_settings_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">user</span><span class="o">.</span><span class="n">res_users_settings_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">res_users_settings_ids</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">res_users_settings_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_search_res_users_settings_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">operand</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="s1">&#39;res_users_settings_ids&#39;</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">operand</span><span class="p">)]</span>

<div class="viewcode-block" id="Users.on_change_login">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.on_change_login">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">onchange</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">on_change_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">login</span> <span class="ow">and</span> <span class="n">tools</span><span class="o">.</span><span class="n">single_email_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">login</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">login</span></div>


<div class="viewcode-block" id="Users.onchange_parent_id">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.onchange_parent_id">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">onchange</span><span class="p">(</span><span class="s1">&#39;parent_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">onchange_parent_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">partner_id</span><span class="o">.</span><span class="n">onchange_parent_id</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_fetch_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
        <span class="n">records</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_fetch_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">USER_PRIVATE_FIELDS</span><span class="p">)</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;write&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">records</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">USER_PRIVATE_FIELDS</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fname</span><span class="p">],</span> <span class="n">repeat</span><span class="p">(</span><span class="s1">&#39;********&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">records</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="s1">&#39;company_id&#39;</span><span class="p">,</span> <span class="s1">&#39;company_ids&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_company</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">active</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">company_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">company_ids</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Company </span><span class="si">%(company_name)s</span><span class="s1"> is not in the allowed companies for user </span><span class="si">%(user_name)s</span><span class="s1"> (</span><span class="si">%(company_allowed)s</span><span class="s1">).&#39;</span><span class="p">,</span>
                      <span class="n">company_name</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">company_id</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                      <span class="n">user_name</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                      <span class="n">company_allowed</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;company_ids.name&#39;</span><span class="p">)))</span>
                <span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="s1">&#39;action_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_action_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">action_open_website</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.action_open_website&#39;</span><span class="p">,</span> <span class="n">raise_if_not_found</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">action_open_website</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">action_id</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">action_open_website</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;The &quot;App Switcher&quot; action cannot be selected as home action.&#39;</span><span class="p">))</span>
        <span class="c1"># Prevent using reload actions.</span>
        <span class="c1"># We use sudo() because  &quot;Access rights&quot; admins can&#39;t read action models</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">action_id</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;ir.actions.client&quot;</span><span class="p">:</span>
                <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;ir.actions.client&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">action_id</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>  <span class="c1"># magic</span>
                <span class="k">if</span> <span class="n">action</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;reload&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;The &quot;</span><span class="si">%s</span><span class="s1">&quot; action cannot be selected as home action.&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>


    <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="s1">&#39;groups_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_one_user_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;We check that no users are both portal and users (same with public).</span>
<span class="sd">           This could typically happen because of implied groups.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_types_category</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.module_category_user_type&#39;</span><span class="p">,</span> <span class="n">raise_if_not_found</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">user_types_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.groups&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
            <span class="p">[(</span><span class="s1">&#39;category_id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">user_types_category</span><span class="o">.</span><span class="n">id</span><span class="p">)])</span> <span class="k">if</span> <span class="n">user_types_category</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">user_types_groups</span><span class="p">:</span>  <span class="c1"># needed at install</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_multiple_groups</span><span class="p">(</span><span class="n">user_types_groups</span><span class="o">.</span><span class="n">ids</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;The user cannot have more than one user types.&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_has_multiple_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_ids</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The method is not fast if the list of ids is very long;</span>
<span class="sd">           so we rather check all users than limit to the size of the group</span>
<span class="sd">        :param group_ids: list of group ids</span>
<span class="sd">        :return: boolean: is there at least a user in at least 2 of the provided groups</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">group_ids</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">group_ids</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">where_clause</span> <span class="o">=</span> <span class="s2">&quot;AND r.uid = </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">where_clause</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># default; we check ALL users (actually pretty efficient)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    SELECT 1 FROM res_groups_users_rel WHERE EXISTS(</span>
<span class="s2">                        SELECT r.uid</span>
<span class="s2">                        FROM res_groups_users_rel r</span>
<span class="s2">                        WHERE r.gid IN </span><span class="si">%s</span><span class="s2">&quot;&quot;&quot;</span> <span class="o">+</span> <span class="n">where_clause</span> <span class="o">+</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                        GROUP BY r.uid HAVING COUNT(r.gid) &gt; 1</span>
<span class="s2">                    )</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="Users.toggle_active">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.toggle_active">[docs]</a>
    <span class="k">def</span> <span class="nf">toggle_active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">active</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">partner_id</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
                <span class="n">user</span><span class="o">.</span><span class="n">partner_id</span><span class="o">.</span><span class="n">toggle_active</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Users</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">toggle_active</span><span class="p">()</span></div>


<div class="viewcode-block" id="Users.onchange">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.onchange">[docs]</a>
    <span class="k">def</span> <span class="nf">onchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">fields_spec</span><span class="p">):</span>
        <span class="c1"># Hacky fix to access fields in `SELF_READABLE_FIELDS` in the onchange logic.</span>
        <span class="c1"># Put field values in the cache.</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()[</span><span class="n">field_name</span><span class="p">]</span> <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SELF_READABLE_FIELDS</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">onchange</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">fields_spec</span><span class="p">)</span></div>


<div class="viewcode-block" id="Users.read">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.read">[docs]</a>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="s1">&#39;_classic_read&#39;</span><span class="p">):</span>
        <span class="n">readable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SELF_READABLE_FIELDS</span>
        <span class="k">if</span> <span class="n">fields</span> <span class="ow">and</span> <span class="bp">self</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">readable</span> <span class="ow">or</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;context_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">):</span>
            <span class="c1"># safe fields only, so we read as super-user to bypass access rights</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Users</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="n">load</span><span class="p">)</span></div>


<div class="viewcode-block" id="Users.check_field_access_rights">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.check_field_access_rights">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">check_field_access_rights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">field_names</span><span class="p">):</span>
        <span class="n">readable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SELF_READABLE_FIELDS</span>
        <span class="k">if</span> <span class="n">field_names</span> <span class="ow">and</span> <span class="bp">self</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">readable</span> <span class="ow">or</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;context_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">):</span>
            <span class="c1"># safe fields only, so we read as super-user to bypass access rights</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Users</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">check_field_access_rights</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">field_names</span><span class="p">)</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_read_group_check_field_access_rights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_names</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_read_group_check_field_access_rights</span><span class="p">(</span><span class="n">field_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">field_names</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">USER_PRIVATE_FIELDS</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">AccessError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Invalid &#39;group by&#39; parameter&quot;</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">access_rights_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">su</span> <span class="ow">and</span> <span class="n">domain</span><span class="p">:</span>
            <span class="n">domain_fields</span> <span class="o">=</span> <span class="p">{</span><span class="n">term</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">domain</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))}</span>
            <span class="k">if</span> <span class="n">domain_fields</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">USER_PRIVATE_FIELDS</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">AccessError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Invalid search criterion&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_search</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">access_rights_uid</span><span class="p">)</span>

<div class="viewcode-block" id="Users.create">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.create">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model_create_multi</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
        <span class="n">users</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Users</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">vals_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
            <span class="c1"># if partner is global we keep it that way</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">partner_id</span><span class="o">.</span><span class="n">company_id</span><span class="p">:</span>
                <span class="n">user</span><span class="o">.</span><span class="n">partner_id</span><span class="o">.</span><span class="n">company_id</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">company_id</span>
            <span class="n">user</span><span class="o">.</span><span class="n">partner_id</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">active</span>
            <span class="c1"># Generate employee initals as avatar for internal users without image</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">image_1920</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">share</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">user</span><span class="o">.</span><span class="n">image_1920</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">partner_id</span><span class="o">.</span><span class="n">_avatar_generate_svg</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">users</span></div>


    <span class="k">def</span> <span class="nf">_apply_groups_to_existing_employees</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Should new groups be added to existing employees?</span>

<span class="sd">        If the template user is being modified, the groups should be applied to</span>
<span class="sd">        every other base_user users</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">default_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.default_user&#39;</span><span class="p">,</span> <span class="n">raise_if_not_found</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">default_user</span> <span class="ow">and</span> <span class="n">default_user</span> <span class="ow">in</span> <span class="bp">self</span>

<div class="viewcode-block" id="Users.write">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">SUPERUSER_ID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;You cannot activate the superuser.&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;You cannot deactivate the user you&#39;re currently logged in as.&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">active</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">partner_id</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
                    <span class="n">user</span><span class="o">.</span><span class="n">partner_id</span><span class="o">.</span><span class="n">toggle_active</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="n">writeable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SELF_WRITEABLE_FIELDS</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="n">writeable</span> <span class="ow">or</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;context_&#39;</span><span class="p">)):</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;company_id&#39;</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;company_id&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">company_ids</span><span class="o">.</span><span class="n">ids</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;company_id&#39;</span><span class="p">]</span>
                <span class="c1"># safe fields only, so we write as super-user to bypass access rights</span>
                <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span>

        <span class="n">old_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;groups_id&#39;</span> <span class="ow">in</span> <span class="n">values</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_groups_to_existing_employees</span><span class="p">():</span>
            <span class="c1"># if modify groups_id content, compute the delta of groups to apply</span>
            <span class="c1"># the new ones to other existing users</span>
            <span class="n">old_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_groups</span><span class="p">()</span>

        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Users</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">old_groups</span><span class="p">:</span>
            <span class="c1"># new elements in _default_groups() means new groups for default users</span>
            <span class="c1"># that needs to be added to existing ones as well for consistency</span>
            <span class="n">added_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_groups</span><span class="p">()</span> <span class="o">-</span> <span class="n">old_groups</span>
            <span class="k">if</span> <span class="n">added_groups</span><span class="p">:</span>
                <span class="n">internal_users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.group_user&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">users</span> <span class="o">-</span> <span class="bp">self</span>
                <span class="n">internal_users</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;groups_id&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span> <span class="k">for</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">added_groups</span><span class="o">.</span><span class="n">ids</span><span class="p">]})</span>

        <span class="k">if</span> <span class="s1">&#39;company_id&#39;</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="c1"># if partner is global we keep it that way</span>
                <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">partner_id</span><span class="o">.</span><span class="n">company_id</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">partner_id</span><span class="o">.</span><span class="n">company_id</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;company_id&#39;</span><span class="p">]:</span>
                    <span class="n">user</span><span class="o">.</span><span class="n">partner_id</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;company_id&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">company_id</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>

        <span class="k">if</span> <span class="s1">&#39;company_id&#39;</span> <span class="ow">in</span> <span class="n">values</span> <span class="ow">or</span> <span class="s1">&#39;company_ids&#39;</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="c1"># Reset lazy properties `company` &amp; `companies` on all envs,</span>
            <span class="c1"># and also their _cache_key, which may depend on them.</span>
            <span class="c1"># This is unlikely in a business code to change the company of a user and then do business stuff</span>
            <span class="c1"># but in case it happens this is handled.</span>
            <span class="c1"># e.g. `account_test_savepoint.py` `setup_company_data`, triggered by `test_account_invoice_report.py`</span>
            <span class="k">for</span> <span class="n">env</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">transaction</span><span class="o">.</span><span class="n">envs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="n">lazy_property</span><span class="o">.</span><span class="n">reset_all</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
                    <span class="n">env</span><span class="o">.</span><span class="n">_cache_key</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># clear caches linked to the users</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span> <span class="ow">and</span> <span class="s1">&#39;groups_id&#39;</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="c1"># DLE P139: Calling invalidate_cache on a new, well you lost everything as you wont be able to take it back from the cache</span>
            <span class="c1"># `test_00_equipment_multicompany_user`</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.access&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">call_cache_clearing_methods</span><span class="p">()</span>

        <span class="c1"># per-method / per-model caches have been removed so the various</span>
        <span class="c1"># clear_cache/clear_caches methods pretty much just end up calling</span>
        <span class="c1"># Registry.clear_cache</span>
        <span class="n">invalidation_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_invalidation_fields</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">invalidation_fields</span> <span class="o">&amp;</span> <span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;context_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">values</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">res</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">ondelete</span><span class="p">(</span><span class="n">at_uninstall</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_unlink_except_master_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">portal_user_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.template_portal_user_id&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">default_user_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.default_user&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">SUPERUSER_ID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;You can not remove the admin user as it is used internally for resources created by Odoo (updates, module installation, ...)&#39;</span><span class="p">))</span>
        <span class="n">user_admin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.user_admin&#39;</span><span class="p">,</span> <span class="n">raise_if_not_found</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_admin</span> <span class="ow">and</span> <span class="n">user_admin</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;You cannot delete the admin user because it is utilized in various places (such as security configurations,...). Instead, archive it.&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">portal_user_template</span> <span class="ow">and</span> <span class="n">portal_user_template</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">default_user_template</span> <span class="ow">and</span> <span class="n">default_user_template</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Deleting the template users is not allowed. Deleting this profile will compromise critical functionalities.&#39;</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_name_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="s1">&#39;ilike&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">user_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">operator</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">expression</span><span class="o">.</span><span class="n">NEGATIVE_TERM_OPERATORS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;ilike&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">name</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">name_domain</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name_domain</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)]</span>
            <span class="n">user_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search</span><span class="p">(</span><span class="n">expression</span><span class="o">.</span><span class="n">AND</span><span class="p">([</span><span class="n">name_domain</span><span class="p">,</span> <span class="n">domain</span><span class="p">]),</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_ids</span><span class="p">:</span>
            <span class="n">user_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search</span><span class="p">(</span><span class="n">expression</span><span class="o">.</span><span class="n">AND</span><span class="p">([[(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">name</span><span class="p">)],</span> <span class="n">domain</span><span class="p">]),</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user_ids</span>

<div class="viewcode-block" id="Users.copy">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.copy">[docs]</a>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="n">default</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">default</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">default</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;partner_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">default</span><span class="p">):</span>
            <span class="n">default</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (copy)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;login&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">default</span><span class="p">:</span>
            <span class="n">default</span><span class="p">[</span><span class="s1">&#39;login&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (copy)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">login</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Users</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">default</span><span class="p">)</span></div>


<div class="viewcode-block" id="Users.context_get">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.context_get">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="nd">@tools</span><span class="o">.</span><span class="n">ormcache</span><span class="p">(</span><span class="s1">&#39;self._uid&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">context_get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span>
        <span class="c1"># determine field names to read</span>
        <span class="n">name_to_key</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">name</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span> <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;context_&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">name</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;context_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">,</span> <span class="s1">&#39;tz&#39;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="c1"># use read() to not read other fields: this must work while modifying</span>
        <span class="c1"># the schema of models res.users or res.partner</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">name_to_key</span><span class="p">),</span> <span class="n">load</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">name_to_key</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># ensure lang is set and available</span>
        <span class="c1"># context &gt; request &gt; company &gt; english &gt; any lang installed</span>
        <span class="n">langs</span> <span class="o">=</span> <span class="p">[</span><span class="n">code</span> <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.lang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_installed</span><span class="p">()]</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">langs</span><span class="p">:</span>
            <span class="n">lang</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">best_lang</span> <span class="k">if</span> <span class="n">request</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">lang</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">langs</span><span class="p">:</span>
                <span class="n">lang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">company_id</span><span class="o">.</span><span class="n">partner_id</span><span class="o">.</span><span class="n">lang</span>
                <span class="k">if</span> <span class="n">lang</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">langs</span><span class="p">:</span>
                    <span class="n">lang</span> <span class="o">=</span> <span class="n">DEFAULT_LANG</span>
                    <span class="k">if</span> <span class="n">lang</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">langs</span><span class="p">:</span>
                        <span class="n">lang</span> <span class="o">=</span> <span class="n">langs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">langs</span> <span class="k">else</span> <span class="n">DEFAULT_LANG</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;lang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lang</span>

        <span class="c1"># ensure uid is set</span>
        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span>

        <span class="k">return</span> <span class="n">frozendict</span><span class="p">(</span><span class="n">context</span><span class="p">)</span></div>


    <span class="nd">@tools</span><span class="o">.</span><span class="n">ormcache</span><span class="p">(</span><span class="s1">&#39;self.id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_company_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># use search() instead of `self.company_ids` to avoid extra query for `active_test`</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;user_ids&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span><span class="o">.</span><span class="n">_ids</span>

<div class="viewcode-block" id="Users.action_get">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.action_get">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">action_get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.action_res_users_my&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="Users.check_super">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.check_super">[docs]</a>
    <span class="k">def</span> <span class="nf">check_super</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">passwd</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">check_super</span><span class="p">(</span><span class="n">passwd</span><span class="p">)</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_invalidation_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;groups_id&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="s1">&#39;lang&#39;</span><span class="p">,</span> <span class="s1">&#39;tz&#39;</span><span class="p">,</span> <span class="s1">&#39;company_id&#39;</span><span class="p">,</span> <span class="s1">&#39;company_ids&#39;</span><span class="p">,</span>
            <span class="o">*</span><span class="n">USER_PRIVATE_FIELDS</span><span class="p">,</span>
            <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_session_token_fields</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_update_last_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># only create new records to avoid any side-effect on concurrent transactions</span>
        <span class="c1"># extra records will be deleted by the periodical garbage collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users.log&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span> <span class="c1"># populated by defaults</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_login_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">login</span><span class="p">)]</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_email_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">email</span><span class="p">)]</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_login_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_login</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">user_agent_env</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">password</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AccessDenied</span><span class="p">()</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">request</span> <span class="k">else</span> <span class="s1">&#39;n/a&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">cls</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cr</span><span class="p">:</span>
                <span class="bp">self</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">SUPERUSER_ID</span><span class="p">,</span> <span class="p">{})[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assert_can_auth</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">login</span><span class="p">):</span>
                    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_login_domain</span><span class="p">(</span><span class="n">login</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_login_order</span><span class="p">(),</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">AccessDenied</span><span class="p">()</span>
                    <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                    <span class="n">user</span><span class="o">.</span><span class="n">_check_credentials</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user_agent_env</span><span class="p">)</span>
                    <span class="n">tz</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tz&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">request</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">tz</span> <span class="ow">in</span> <span class="n">pytz</span><span class="o">.</span><span class="n">all_timezones</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">tz</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">login_date</span><span class="p">):</span>
                        <span class="c1"># first login or missing tz -&gt; set tz to browser tz</span>
                        <span class="n">user</span><span class="o">.</span><span class="n">tz</span> <span class="o">=</span> <span class="n">tz</span>
                    <span class="n">user</span><span class="o">.</span><span class="n">_update_last_login</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">AccessDenied</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Login failed for db:</span><span class="si">%s</span><span class="s2"> login:</span><span class="si">%s</span><span class="s2"> from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Login successful for db:</span><span class="si">%s</span><span class="s2"> login:</span><span class="si">%s</span><span class="s2"> from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>

<div class="viewcode-block" id="Users.authenticate">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.authenticate">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">user_agent_env</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verifies and returns the user ID corresponding to the given</span>
<span class="sd">          ``login`` and ``password`` combination, or False if there was</span>
<span class="sd">          no matching user.</span>
<span class="sd">           :param str db: the database on which user is trying to authenticate</span>
<span class="sd">           :param str login: username</span>
<span class="sd">           :param str password: user password</span>
<span class="sd">           :param dict user_agent_env: environment dictionary describing any</span>
<span class="sd">               relevant environment attributes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_login</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">user_agent_env</span><span class="o">=</span><span class="n">user_agent_env</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_agent_env</span> <span class="ow">and</span> <span class="n">user_agent_env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;base_location&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">cls</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cr</span><span class="p">:</span>
                <span class="n">env</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_group</span><span class="p">(</span><span class="s1">&#39;base.group_system&#39;</span><span class="p">):</span>
                    <span class="c1"># Successfully logged in as system user!</span>
                    <span class="c1"># Attempt to guess the web base url...</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">base</span> <span class="o">=</span> <span class="n">user_agent_env</span><span class="p">[</span><span class="s1">&#39;base_location&#39;</span><span class="p">]</span>
                        <span class="n">ICP</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.config_parameter&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">ICP</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;web.base.url.freeze&#39;</span><span class="p">):</span>
                            <span class="n">ICP</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="s1">&#39;web.base.url&#39;</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to update web.base.url configuration parameter&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">uid</span></div>


<div class="viewcode-block" id="Users.check">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.check">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="nd">@tools</span><span class="o">.</span><span class="n">ormcache</span><span class="p">(</span><span class="s1">&#39;uid&#39;</span><span class="p">,</span> <span class="s1">&#39;passwd&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">passwd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verifies that the given (uid, password) is authorized for the database ``db`` and</span>
<span class="sd">           raise an exception if it is not.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">passwd</span><span class="p">:</span>
            <span class="c1"># empty passwords disallowed for obvious security reasons</span>
            <span class="k">raise</span> <span class="n">AccessDenied</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">cursor</span><span class="p">())</span> <span class="k">as</span> <span class="n">cr</span><span class="p">:</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="p">{})[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assert_can_auth</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">uid</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">AccessDenied</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_credentials</span><span class="p">(</span><span class="n">passwd</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;interactive&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span></div>


    <span class="k">def</span> <span class="nf">_get_session_token_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">}</span>

    <span class="nd">@tools</span><span class="o">.</span><span class="n">ormcache</span><span class="p">(</span><span class="s1">&#39;sid&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_session_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Compute a session token given a session id and a user id &quot;&quot;&quot;</span>
        <span class="c1"># retrieve the fields used to generate the session token</span>
        <span class="n">session_fields</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_session_token_fields</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT </span><span class="si">%s</span><span class="s2">, (SELECT value FROM ir_config_parameter WHERE key=&#39;database.secret&#39;)</span>
<span class="s2">                                FROM res_users</span>
<span class="s2">                                WHERE id=</span><span class="si">%%</span><span class="s2">s&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">session_fields</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">data_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="c1"># generate hmac key</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data_fields</span><span class="p">,))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="c1"># hmac the session id</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">sid</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sha256</span><span class="p">)</span>
        <span class="c1"># keep in the cache the token</span>
        <span class="k">return</span> <span class="n">h</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<div class="viewcode-block" id="Users.change_password">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.change_password">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">change_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_passwd</span><span class="p">,</span> <span class="n">new_passwd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Change current user password. Old password must be provided explicitly</span>
<span class="sd">        to prevent hijacking an existing user session, or for cases where the cleartext</span>
<span class="sd">        password is not used to authenticate requests.</span>

<span class="sd">        :return: True</span>
<span class="sd">        :raise: odoo.exceptions.AccessDenied when old password is wrong</span>
<span class="sd">        :raise: odoo.exceptions.UserError when new password is not set or empty</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">old_passwd</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AccessDenied</span><span class="p">()</span>

        <span class="c1"># alternatively: use identitycheck wizard?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_credentials</span><span class="p">(</span><span class="n">old_passwd</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;interactive&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

        <span class="c1"># use self.env.user here, because it has uid=SUPERUSER_ID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">_change_password</span><span class="p">(</span><span class="n">new_passwd</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>


    <span class="k">def</span> <span class="nf">_change_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_passwd</span><span class="p">):</span>
        <span class="n">new_passwd</span> <span class="o">=</span> <span class="n">new_passwd</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_passwd</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Setting empty passwords is not allowed for security reasons!&quot;</span><span class="p">))</span>

        <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">request</span> <span class="k">else</span> <span class="s1">&#39;n/a&#39;</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Password change for </span><span class="si">%r</span><span class="s2"> (#</span><span class="si">%d</span><span class="s2">) by </span><span class="si">%r</span><span class="s2"> (#</span><span class="si">%d</span><span class="s2">) from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">login</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">login</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
             <span class="n">ip</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">new_passwd</span>

    <span class="k">def</span> <span class="nf">_deactivate_portal_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">post</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Try to remove the current portal user.</span>

<span class="sd">        This is used to give the opportunity to portal users to de-activate their accounts.</span>
<span class="sd">        Indeed, as the portal users can easily create accounts, they will sometimes wish</span>
<span class="sd">        it removed because they don&#39;t use this Odoo portal anymore.</span>

<span class="sd">        Before this feature, they would have to contact the website or the support to get</span>
<span class="sd">        their account removed, which could be tedious.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">non_portal_users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">user</span><span class="p">:</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">share</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">non_portal_users</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AccessDenied</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s1">&#39;Only the portal users can delete their accounts. &#39;</span>
                <span class="s1">&#39;The user(s) </span><span class="si">%s</span><span class="s1"> can not be deleted.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">non_portal_users</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)),</span>
            <span class="p">))</span>

        <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">request</span> <span class="k">else</span> <span class="s1">&#39;n/a&#39;</span>

        <span class="n">res_users_deletion_values</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Account deletion asked for &quot;</span><span class="si">%s</span><span class="s1">&quot; (#</span><span class="si">%i</span><span class="s1">) from </span><span class="si">%s</span><span class="s1">. &#39;</span>
                <span class="s1">&#39;Archive the user and remove login information.&#39;</span><span class="p">,</span>
                <span class="n">user</span><span class="o">.</span><span class="n">login</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">user</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
                <span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;__deleted_user_</span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="n">user</span><span class="o">.</span><span class="n">api_key_ids</span><span class="o">.</span><span class="n">_remove</span><span class="p">()</span>

            <span class="n">res_users_deletion_values</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="s1">&#39;todo&#39;</span><span class="p">,</span>
            <span class="p">})</span>

        <span class="c1"># Here we try to archive the user / partner, and then add the user in a deletion</span>
        <span class="c1"># queue, to remove it from the database. As the deletion might fail (if the</span>
        <span class="c1"># partner is related to an invoice e.g.) it&#39;s important to archive it here.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># A user can not self-deactivate</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">SUPERUSER_ID</span><span class="p">)</span><span class="o">.</span><span class="n">action_archive</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partner_id</span><span class="o">.</span><span class="n">action_archive</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># Add users in the deletion queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users.deletion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">res_users_deletion_values</span><span class="p">)</span>

<div class="viewcode-block" id="Users.preference_save">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.preference_save">[docs]</a>
    <span class="k">def</span> <span class="nf">preference_save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.client&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;reload_context&#39;</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="Users.preference_change_password">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.preference_change_password">[docs]</a>
    <span class="nd">@check_identity</span>
    <span class="k">def</span> <span class="nf">preference_change_password</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.act_window&#39;</span><span class="p">,</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span>
            <span class="s1">&#39;res_model&#39;</span><span class="p">:</span> <span class="s1">&#39;change.password.own&#39;</span><span class="p">,</span>
            <span class="s1">&#39;view_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;form&#39;</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="Users.action_revoke_all_devices">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.action_revoke_all_devices">[docs]</a>
    <span class="k">def</span> <span class="nf">action_revoke_all_devices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">dialog_size</span><span class="o">=</span><span class="s1">&#39;medium&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Log out from all devices?&#39;</span><span class="p">),</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.act_window&#39;</span><span class="p">,</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span>
            <span class="s1">&#39;res_model&#39;</span><span class="p">:</span> <span class="s1">&#39;res.users.identitycheck&#39;</span><span class="p">,</span>
            <span class="s1">&#39;view_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;form&#39;</span><span class="p">,</span>
            <span class="s1">&#39;view_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.res_users_identitycheck_view_form_revokedevices&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="n">ctx</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="Users.has_group">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.has_group">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">has_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_ext_id</span><span class="p">):</span>
        <span class="c1"># use singleton&#39;s id if called on a non-empty recordset, otherwise</span>
        <span class="c1"># context uid</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="ow">and</span> <span class="n">uid</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">:</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_group</span><span class="p">(</span><span class="n">group_ext_id</span><span class="p">)</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="nd">@tools</span><span class="o">.</span><span class="n">ormcache</span><span class="p">(</span><span class="s1">&#39;self._uid&#39;</span><span class="p">,</span> <span class="s1">&#39;group_ext_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_has_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_ext_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks whether user belongs to given group.</span>

<span class="sd">        :param str group_ext_id: external ID (XML ID) of the group.</span>
<span class="sd">           Must be provided in fully-qualified form (``module.ext_id``), as there</span>
<span class="sd">           is no implicit module to use..</span>
<span class="sd">        :return: True if the current user is a member of the group with the</span>
<span class="sd">           given external ID (XML ID), else False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">group_ext_id</span> <span class="ow">and</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">group_ext_id</span><span class="p">,</span> <span class="s2">&quot;External ID &#39;</span><span class="si">%s</span><span class="s2">&#39; must be fully qualified&quot;</span> <span class="o">%</span> <span class="n">group_ext_id</span>
        <span class="n">module</span><span class="p">,</span> <span class="n">ext_id</span> <span class="o">=</span> <span class="n">group_ext_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;SELECT 1 FROM res_groups_users_rel WHERE uid=</span><span class="si">%s</span><span class="s2"> AND gid IN</span>
<span class="s2">                            (SELECT res_id FROM ir_model_data WHERE module=</span><span class="si">%s</span><span class="s2"> AND name=</span><span class="si">%s</span><span class="s2"> AND model=&#39;res.groups&#39;)&quot;&quot;&quot;</span><span class="p">,</span>
                         <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">ext_id</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_action_show</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If self is a singleton, directly access the form view. If it is a recordset, open a tree view&quot;&quot;&quot;</span>
        <span class="n">view_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.view_users_form&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span>
        <span class="n">action</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.act_window&#39;</span><span class="p">,</span>
            <span class="s1">&#39;res_model&#39;</span><span class="p">:</span> <span class="s1">&#39;res.users&#39;</span><span class="p">,</span>
            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;create&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">action</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Users&#39;</span><span class="p">),</span>
                <span class="s1">&#39;view_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;list,form&#39;</span><span class="p">,</span>
                <span class="s1">&#39;views&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">view_id</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">]],</span>
                <span class="s1">&#39;domain&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)],</span>
            <span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">action</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;view_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;form&#39;</span><span class="p">,</span>
                <span class="s1">&#39;views&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="n">view_id</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">]],</span>
                <span class="s1">&#39;res_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">action</span>

<div class="viewcode-block" id="Users.action_show_groups">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.action_show_groups">[docs]</a>
    <span class="k">def</span> <span class="nf">action_show_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Groups&#39;</span><span class="p">),</span>
            <span class="s1">&#39;view_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;tree,form&#39;</span><span class="p">,</span>
            <span class="s1">&#39;res_model&#39;</span><span class="p">:</span> <span class="s1">&#39;res.groups&#39;</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.act_window&#39;</span><span class="p">,</span>
            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;create&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
            <span class="s1">&#39;domain&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_id</span><span class="o">.</span><span class="n">ids</span><span class="p">)],</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;current&#39;</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="Users.action_show_accesses">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.action_show_accesses">[docs]</a>
    <span class="k">def</span> <span class="nf">action_show_accesses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Access Rights&#39;</span><span class="p">),</span>
            <span class="s1">&#39;view_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;tree,form&#39;</span><span class="p">,</span>
            <span class="s1">&#39;res_model&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.model.access&#39;</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.act_window&#39;</span><span class="p">,</span>
            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;create&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
            <span class="s1">&#39;domain&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_id</span><span class="o">.</span><span class="n">model_access</span><span class="o">.</span><span class="n">ids</span><span class="p">)],</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;current&#39;</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="Users.action_show_rules">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.action_show_rules">[docs]</a>
    <span class="k">def</span> <span class="nf">action_show_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Record Rules&#39;</span><span class="p">),</span>
            <span class="s1">&#39;view_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;tree,form&#39;</span><span class="p">,</span>
            <span class="s1">&#39;res_model&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.rule&#39;</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.act_window&#39;</span><span class="p">,</span>
            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;create&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
            <span class="s1">&#39;domain&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_id</span><span class="o">.</span><span class="n">rule_groups</span><span class="o">.</span><span class="n">ids</span><span class="p">)],</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;current&#39;</span><span class="p">,</span>
        <span class="p">}</span></div>


    <span class="k">def</span> <span class="nf">_is_internal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">share</span>

    <span class="k">def</span> <span class="nf">_is_portal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_group</span><span class="p">(</span><span class="s1">&#39;base.group_portal&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_is_public</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_group</span><span class="p">(</span><span class="s1">&#39;base.group_public&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_is_system</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_group</span><span class="p">(</span><span class="s1">&#39;base.group_system&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_is_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_superuser</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_group</span><span class="p">(</span><span class="s1">&#39;base.group_erp_manager&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_is_superuser</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">SUPERUSER_ID</span>

<div class="viewcode-block" id="Users.get_company_currency_id">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.Users.get_company_currency_id">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">get_company_currency_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">currency_id</span><span class="o">.</span><span class="n">id</span></div>


    <span class="nd">@tools</span><span class="o">.</span><span class="n">ormcache</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_crypt_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Passlib CryptContext instance used to encrypt and verify</span>
<span class="sd">        passwords. Can be overridden if technical, legal or political matters</span>
<span class="sd">        require different kdfs than the provided default.</span>

<span class="sd">        The work factor of the default KDF can be configured using the</span>
<span class="sd">        ``password.hashing.rounds`` ICP.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.config_parameter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">CryptContext</span><span class="p">(</span>
            <span class="c1"># kdf which can be verified by the context. The default encryption</span>
            <span class="c1"># kdf is the first of the list</span>
            <span class="p">[</span><span class="s1">&#39;pbkdf2_sha512&#39;</span><span class="p">,</span> <span class="s1">&#39;plaintext&#39;</span><span class="p">],</span>
            <span class="c1"># deprecated algorithms are still verified as usual, but</span>
            <span class="c1"># ``needs_update`` will indicate that the stored hash should be</span>
            <span class="c1"># replaced by a more recent algorithm.</span>
            <span class="n">deprecated</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">],</span>
            <span class="n">pbkdf2_sha512__rounds</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">MIN_ROUNDS</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;password.hashing.rounds&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))),</span>
        <span class="p">)</span>

    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">_assert_can_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checks that the current environment even allows the current auth</span>
<span class="sd">        request to happen.</span>

<span class="sd">        The baseline implementation is a simple linear login cooldown: after</span>
<span class="sd">        a number of failures trying to log-in, the user (by login) is put on</span>
<span class="sd">        cooldown. During the cooldown period, login *attempts* are ignored</span>
<span class="sd">        and logged.</span>

<span class="sd">        :param user: user id or login, for logging purpose</span>

<span class="sd">        .. warning::</span>

<span class="sd">            The login counter is not shared between workers and not</span>
<span class="sd">            specifically thread-safe, the feature exists mostly for</span>
<span class="sd">            rate-limiting on large number of login attempts (brute-forcing</span>
<span class="sd">            passwords) so that should not be much of an issue.</span>

<span class="sd">            For a more complex strategy (e.g. database or distribute storage)</span>
<span class="sd">            override this method. To simply change the cooldown criteria</span>
<span class="sd">            (configuration, ...) override _on_login_cooldown instead.</span>

<span class="sd">        .. note::</span>

<span class="sd">            This is a *context manager* so it can be called around the login</span>
<span class="sd">            procedure without having to call it itself.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># needs request for remote address</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="p">:</span>
            <span class="k">yield</span>
            <span class="k">return</span>

        <span class="n">reg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span>
        <span class="n">failures_map</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="s1">&#39;_login_failures&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">failures_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">failures_map</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">_login_failures</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span> <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">min</span><span class="p">))</span>

        <span class="n">source</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">remote_addr</span>
        <span class="p">(</span><span class="n">failures</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span> <span class="o">=</span> <span class="n">failures_map</span><span class="p">[</span><span class="n">source</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_login_cooldown</span><span class="p">(</span><span class="n">failures</span><span class="p">,</span> <span class="n">previous</span><span class="p">):</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Login attempt ignored for </span><span class="si">%s</span><span class="s2"> (user </span><span class="si">%r</span><span class="s2">) on </span><span class="si">%s</span><span class="s2">: &quot;</span>
                <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> failures since last success, last failure at </span><span class="si">%s</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;You can configure the number of login failures before a &quot;</span>
                <span class="s2">&quot;user is put on cooldown as well as the duration in the &quot;</span>
                <span class="s2">&quot;System Parameters. Disable this feature by setting &quot;</span>
                <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">base.login_cooldown_after</span><span class="se">\&quot;</span><span class="s2"> to 0.&quot;</span><span class="p">,</span>
                <span class="n">source</span><span class="p">,</span> <span class="n">user</span> <span class="ow">or</span> <span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">dbname</span><span class="p">,</span> <span class="n">failures</span><span class="p">,</span> <span class="n">previous</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ipaddress</span><span class="o">.</span><span class="n">ip_address</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">is_private</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;The rate-limited IP address </span><span class="si">%s</span><span class="s2"> is classified as private &quot;</span>
                    <span class="s2">&quot;and *might* be a proxy. If your Odoo is behind a proxy, &quot;</span>
                    <span class="s2">&quot;it may be mis-configured. Check that you are running &quot;</span>
                    <span class="s2">&quot;Odoo in Proxy Mode and that the proxy is properly configured, see &quot;</span>
                    <span class="s2">&quot;https://www.odoo.com/documentation/17.0/administration/install/deploy.html#https for details.&quot;</span><span class="p">,</span>
                    <span class="n">source</span>
                <span class="p">)</span>
            <span class="k">raise</span> <span class="n">AccessDenied</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Too many login failures, please wait a bit before trying again.&quot;</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">except</span> <span class="n">AccessDenied</span><span class="p">:</span>
            <span class="p">(</span><span class="n">failures</span><span class="p">,</span> <span class="n">__</span><span class="p">)</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">_login_failures</span><span class="p">[</span><span class="n">source</span><span class="p">]</span>
            <span class="n">reg</span><span class="o">.</span><span class="n">_login_failures</span><span class="p">[</span><span class="n">source</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">failures</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reg</span><span class="o">.</span><span class="n">_login_failures</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_login_cooldown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">failures</span><span class="p">,</span> <span class="n">previous</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Decides whether the user trying to log in is currently</span>
<span class="sd">        &quot;on cooldown&quot; and not even allowed to attempt logging in.</span>

<span class="sd">        The default cooldown function simply puts the user on cooldown for</span>
<span class="sd">        &lt;login_cooldown_duration&gt; seconds after each failure following the</span>
<span class="sd">        &lt;login_cooldown_after&gt;th (0 to disable).</span>

<span class="sd">        Can be overridden to implement more complex backoff strategies, or</span>
<span class="sd">        e.g. wind down or reset the cooldown period as the previous failure</span>
<span class="sd">        recedes into the far past.</span>

<span class="sd">        :param int failures: number of recorded failures (since last success)</span>
<span class="sd">        :param previous: timestamp of previous failure</span>
<span class="sd">        :type previous:  datetime.datetime</span>
<span class="sd">        :returns: whether the user is currently in cooldown phase (true if cooldown, false if no cooldown and login can continue)</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.config_parameter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span>
        <span class="n">min_failures</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;base.login_cooldown_after&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">min_failures</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">delay</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;base.login_cooldown_duration&#39;</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">failures</span> <span class="o">&gt;=</span> <span class="n">min_failures</span> <span class="ow">and</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">previous</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">delay</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_register_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;check_credentials&#39;</span><span class="p">):</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The check_credentials method of res.users has been renamed _check_credentials. One of your installed modules defines one, but it will not be called anymore.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mfa_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; If an MFA method is enabled, returns its type as a string. &quot;&quot;&quot;</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_mfa_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; If an MFA method is enabled, returns the URL for its second step. &quot;&quot;&quot;</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_should_alert_new_device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Determine if an alert should be sent to the user regarding a new device</span>

<span class="sd">        To be overriden in 2FA modules implementing known devices</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<span class="c1">#</span>
<span class="c1"># Implied groups</span>
<span class="c1">#</span>
<span class="c1"># Extension of res.groups and res.users with a relation for &quot;implied&quot; or</span>
<span class="c1"># &quot;inherited&quot; groups.  Once a user belongs to a group, it automatically belongs</span>
<span class="c1"># to the implied groups (transitively).</span>
<span class="c1">#</span>

<div class="viewcode-block" id="GroupsImplied">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.GroupsImplied">[docs]</a>
<span class="k">class</span> <span class="nc">GroupsImplied</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">_inherit</span> <span class="o">=</span> <span class="s1">&#39;res.groups&#39;</span>

    <span class="n">implied_ids</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2many</span><span class="p">(</span><span class="s1">&#39;res.groups&#39;</span><span class="p">,</span> <span class="s1">&#39;res_groups_implied_rel&#39;</span><span class="p">,</span> <span class="s1">&#39;gid&#39;</span><span class="p">,</span> <span class="s1">&#39;hid&#39;</span><span class="p">,</span>
        <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Inherits&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Users of this group automatically inherit those groups&#39;</span><span class="p">)</span>
    <span class="n">trans_implied_ids</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2many</span><span class="p">(</span><span class="s1">&#39;res.groups&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Transitively inherits&#39;</span><span class="p">,</span>
        <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_trans_implied&#39;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;implied_ids.trans_implied_ids&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_trans_implied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Compute the transitive closure recursively. Note that the performance</span>
        <span class="c1"># is good, because the record cache behaves as a memo (the field is</span>
        <span class="c1"># never computed twice on a given group.)</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trans_implied_ids</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">implied_ids</span> <span class="o">|</span> <span class="n">g</span><span class="o">.</span><span class="n">implied_ids</span><span class="o">.</span><span class="n">trans_implied_ids</span>

<div class="viewcode-block" id="GroupsImplied.create">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.GroupsImplied.create">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model_create_multi</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
        <span class="n">user_ids_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">vals_list</span><span class="p">]</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">GroupsImplied</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">vals_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">user_ids</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">user_ids_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">user_ids</span><span class="p">:</span>
                <span class="c1"># delegate addition of users to add implied groups</span>
                <span class="n">group</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;users&#39;</span><span class="p">:</span> <span class="n">user_ids</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">groups</span></div>


<div class="viewcode-block" id="GroupsImplied.write">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.GroupsImplied.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">GroupsImplied</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;implied_ids&#39;</span><span class="p">):</span>
            <span class="c1"># add all implied groups (to all users of each group)</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    WITH RECURSIVE group_imply(gid, hid) AS (</span>
<span class="s2">                        SELECT gid, hid</span>
<span class="s2">                          FROM res_groups_implied_rel</span>
<span class="s2">                         UNION</span>
<span class="s2">                        SELECT i.gid, r.hid</span>
<span class="s2">                          FROM res_groups_implied_rel r</span>
<span class="s2">                          JOIN group_imply i ON (i.hid = r.gid)</span>
<span class="s2">                    )</span>
<span class="s2">                    INSERT INTO res_groups_users_rel (gid, uid)</span>
<span class="s2">                         SELECT i.hid, r.uid</span>
<span class="s2">                           FROM group_imply i, res_groups_users_rel r</span>
<span class="s2">                          WHERE r.gid = i.gid</span>
<span class="s2">                            AND i.gid = </span><span class="si">%(gid)s</span>
<span class="s2">                         EXCEPT</span>
<span class="s2">                         SELECT r.gid, r.uid</span>
<span class="s2">                           FROM res_groups_users_rel r</span>
<span class="s2">                           JOIN group_imply i ON (r.gid = i.hid)</span>
<span class="s2">                          WHERE i.gid = </span><span class="si">%(gid)s</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">gid</span><span class="o">=</span><span class="n">group</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_one_user_type</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span></div>


    <span class="k">def</span> <span class="nf">_apply_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">implied_group</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Add the given group to the groups implied by the current group</span>
<span class="sd">        :param implied_group: the implied group to add</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="n">implied_group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">implied_ids</span><span class="p">)</span>
        <span class="n">groups</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;implied_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">implied_group</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>

    <span class="k">def</span> <span class="nf">_remove_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">implied_group</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Remove the given group from the implied groups of the current group</span>
<span class="sd">        :param implied_group: the implied group to remove</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="n">implied_group</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">implied_ids</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">groups</span><span class="p">:</span>
            <span class="n">groups</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;implied_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">implied_group</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>
            <span class="c1"># if user belongs to implied_group thanks to another group, don&#39;t remove him</span>
            <span class="c1"># this avoids readding the template user and triggering the mechanism at 121cd0d6084cb28</span>
            <span class="n">users_to_unlink</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">user</span>
                <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">users</span>
                <span class="k">if</span> <span class="n">implied_group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">groups_id</span> <span class="o">-</span> <span class="n">implied_group</span><span class="p">)</span><span class="o">.</span><span class="n">trans_implied_ids</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">users_to_unlink</span><span class="p">:</span>
                <span class="c1"># do not remove inactive users (e.g. default)</span>
                <span class="n">implied_group</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;users&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users_to_unlink</span><span class="p">]})</span></div>


<div class="viewcode-block" id="UsersImplied">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.UsersImplied">[docs]</a>
<span class="k">class</span> <span class="nc">UsersImplied</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">_inherit</span> <span class="o">=</span> <span class="s1">&#39;res.users&#39;</span>

<div class="viewcode-block" id="UsersImplied.create">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.UsersImplied.create">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model_create_multi</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">vals_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;groups_id&#39;</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="c1"># complete &#39;groups_id&#39; with implied groups</span>
                <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">groups_id</span><span class="o">.</span><span class="n">_origin</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">gs</span> <span class="o">|</span> <span class="n">gs</span><span class="o">.</span><span class="n">trans_implied_ids</span>
                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;groups_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;groups_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">convert_to_write</span><span class="p">(</span><span class="n">gs</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">UsersImplied</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">vals_list</span><span class="p">)</span></div>


<div class="viewcode-block" id="UsersImplied.write">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.UsersImplied.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;groups_id&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">UsersImplied</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">users_before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">_is_internal</span><span class="p">())</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">UsersImplied</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">demoted_users</span> <span class="o">=</span> <span class="n">users_before</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="ow">not</span> <span class="n">u</span><span class="o">.</span><span class="n">_is_internal</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">demoted_users</span><span class="p">:</span>
            <span class="c1"># demoted users are restricted to the assigned groups only</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;groups_id&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">clear</span><span class="p">()]</span> <span class="o">+</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;groups_id&#39;</span><span class="p">]}</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">UsersImplied</span><span class="p">,</span> <span class="n">demoted_users</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
        <span class="c1"># add implied groups for all users (in batches)</span>
        <span class="n">users_batch</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">users_batch</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">groups_id</span><span class="p">]</span> <span class="o">+=</span> <span class="n">user</span>
        <span class="k">for</span> <span class="n">groups</span><span class="p">,</span> <span class="n">users</span> <span class="ow">in</span> <span class="n">users_batch</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">concat</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">trans_implied_ids</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">))</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;groups_id&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gs</span><span class="p">]}</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">UsersImplied</span><span class="p">,</span> <span class="n">users</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div>
</div>


<span class="c1">#</span>
<span class="c1"># Virtual checkbox and selection for res.user form view</span>
<span class="c1">#</span>
<span class="c1"># Extension of res.groups and res.users for the special groups view in the users</span>
<span class="c1"># form.  This extension presents groups with selection and boolean widgets:</span>
<span class="c1"># - Groups are shown by application, with boolean and/or selection fields.</span>
<span class="c1">#   Selection fields typically defines a role &quot;Name&quot; for the given application.</span>
<span class="c1"># - Uncategorized groups are presented as boolean fields and grouped in a</span>
<span class="c1">#   section &quot;Others&quot;.</span>
<span class="c1">#</span>
<span class="c1"># The user form view is modified by an inherited view (base.user_groups_view);</span>
<span class="c1"># the inherited view replaces the field &#39;groups_id&#39; by a set of reified group</span>
<span class="c1"># fields (boolean or selection fields).  The arch of that view is regenerated</span>
<span class="c1"># each time groups are changed.</span>
<span class="c1">#</span>
<span class="c1"># Naming conventions for reified groups fields:</span>
<span class="c1"># - boolean field &#39;in_group_ID&#39; is True iff</span>
<span class="c1">#       ID is in &#39;groups_id&#39;</span>
<span class="c1"># - selection field &#39;sel_groups_ID1_..._IDk&#39; is ID iff</span>
<span class="c1">#       ID is in &#39;groups_id&#39; and ID is maximal in the set {ID1, ..., IDk}</span>
<span class="c1">#</span>

<div class="viewcode-block" id="GroupsView">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.GroupsView">[docs]</a>
<span class="k">class</span> <span class="nc">GroupsView</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">_inherit</span> <span class="o">=</span> <span class="s1">&#39;res.groups&#39;</span>

<div class="viewcode-block" id="GroupsView.create">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.GroupsView.create">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model_create_multi</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">vals_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_user_groups_view</span><span class="p">()</span>
        <span class="c1"># actions.get_bindings() depends on action records</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">groups</span></div>


<div class="viewcode-block" id="GroupsView.write">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.GroupsView.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="c1"># determine which values the &quot;user groups view&quot; depends on</span>
        <span class="n">VIEW_DEPS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;category_id&#39;</span><span class="p">,</span> <span class="s1">&#39;implied_ids&#39;</span><span class="p">)</span>
        <span class="n">view_values0</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">VIEW_DEPS</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">values</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">GroupsView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="c1"># update the &quot;user groups view&quot; only if necessary</span>
        <span class="n">view_values1</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">VIEW_DEPS</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">values</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">view_values0</span> <span class="o">!=</span> <span class="n">view_values1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_user_groups_view</span><span class="p">()</span>
        <span class="c1"># actions.get_bindings() depends on action records</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="GroupsView.unlink">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.GroupsView.unlink">[docs]</a>
    <span class="k">def</span> <span class="nf">unlink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">GroupsView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_user_groups_view</span><span class="p">()</span>
        <span class="c1"># actions.get_bindings() depends on action records</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span></div>


    <span class="k">def</span> <span class="nf">_get_hidden_extra_categories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;base.module_category_hidden&#39;</span><span class="p">,</span> <span class="s1">&#39;base.module_category_extra&#39;</span><span class="p">,</span> <span class="s1">&#39;base.module_category_usability&#39;</span><span class="p">]</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_update_user_groups_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Modify the view with xmlid ``base.user_groups_view``, which inherits</span>
<span class="sd">            the user form view, and introduces the reified group fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># remove the language to avoid translations, it will be handled at the view level</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># We have to try-catch this, because at first init the view does not</span>
        <span class="c1"># exist but we are already creating some basic groups.</span>
        <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.user_groups_view&#39;</span><span class="p">,</span> <span class="n">raise_if_not_found</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">view</span> <span class="ow">and</span> <span class="n">view</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="s1">&#39;ir.ui.view&#39;</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;install_filename&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">MODULE_UNINSTALL_FLAG</span><span class="p">):</span>
            <span class="c1"># use a dummy view during install/upgrade/uninstall</span>
            <span class="n">xml</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;groups_id&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">group_no_one</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.group_no_one&#39;</span><span class="p">)</span>
            <span class="n">group_employee</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.group_user&#39;</span><span class="p">)</span>
            <span class="n">xml0</span><span class="p">,</span> <span class="n">xml1</span><span class="p">,</span> <span class="n">xml2</span><span class="p">,</span> <span class="n">xml3</span><span class="p">,</span> <span class="n">xml4</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="n">xml_by_category</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">xml1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">separator</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;User Type&#39;</span><span class="p">,</span> <span class="n">colspan</span><span class="o">=</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="s1">&#39;base.group_no_one&#39;</span><span class="p">))</span>

            <span class="n">user_type_field_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">user_type_readonly</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({})</span>
            <span class="n">sorted_tuples</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_groups_by_application</span><span class="p">(),</span>
                                   <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xml_id</span> <span class="o">!=</span> <span class="s1">&#39;base.module_category_user_type&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">app</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="n">category_name</span> <span class="ow">in</span> <span class="n">sorted_tuples</span><span class="p">:</span>  <span class="c1"># we process the user type first</span>
                <span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1"># hide groups in categories &#39;Hidden&#39; and &#39;Extra&#39; (except for group_no_one)</span>
                <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">xml_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hidden_extra_categories</span><span class="p">():</span>
                    <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;groups&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;base.group_no_one&#39;</span>

                <span class="c1"># User type (employee, portal or public) is a separated group. This is the only &#39;selection&#39;</span>
                <span class="c1"># group of res.groups without implied groups (with each other).</span>
                <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">xml_id</span> <span class="o">==</span> <span class="s1">&#39;base.module_category_user_type&#39;</span><span class="p">:</span>
                    <span class="c1"># application name with a selection field</span>
                    <span class="n">field_name</span> <span class="o">=</span> <span class="n">name_selection_groups</span><span class="p">(</span><span class="n">gs</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
                    <span class="c1"># test_reified_groups, put the user category type in invisible</span>
                    <span class="c1"># as it&#39;s used in domain of attrs of other fields,</span>
                    <span class="c1"># and the normal user category type field node is wrapped in a `groups=&quot;base.no_one&quot;`,</span>
                    <span class="c1"># and is therefore removed when not in debug mode.</span>
                    <span class="n">xml0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span> <span class="n">invisible</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">on_change</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">))</span>
                    <span class="n">user_type_field_name</span> <span class="o">=</span> <span class="n">field_name</span>
                    <span class="n">user_type_readonly</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">user_type_field_name</span><span class="si">}</span><span class="s1"> != </span><span class="si">{</span><span class="n">group_employee</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;widget&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;radio&#39;</span>
                    <span class="c1"># Trigger the on_change of this &quot;virtual field&quot;</span>
                    <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;on_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
                    <span class="n">xml1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">))</span>
                    <span class="n">xml1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">newline</span><span class="p">())</span>

                <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;selection&#39;</span><span class="p">:</span>
                    <span class="c1"># application name with a selection field</span>
                    <span class="n">field_name</span> <span class="o">=</span> <span class="n">name_selection_groups</span><span class="p">(</span><span class="n">gs</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
                    <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;readonly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_type_readonly</span>
                    <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;on_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
                    <span class="k">if</span> <span class="n">category_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xml_by_category</span><span class="p">:</span>
                        <span class="n">xml_by_category</span><span class="p">[</span><span class="n">category_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">xml_by_category</span><span class="p">[</span><span class="n">category_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">newline</span><span class="p">())</span>
                    <span class="n">xml_by_category</span><span class="p">[</span><span class="n">category_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">))</span>
                    <span class="n">xml_by_category</span><span class="p">[</span><span class="n">category_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">newline</span><span class="p">())</span>
                    <span class="c1"># add duplicate invisible field so default values are saved on create</span>
                    <span class="k">if</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;base.group_no_one&#39;</span><span class="p">:</span>
                        <span class="n">xml0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span> <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">invisible</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="s1">&#39;!base.group_no_one&#39;</span><span class="p">)))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># application separator with boolean fields</span>
                    <span class="n">app_name</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s1">&#39;Other&#39;</span>
                    <span class="n">xml4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">separator</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="n">app_name</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">))</span>
                    <span class="n">left_group</span><span class="p">,</span> <span class="n">right_group</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
                    <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;readonly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_type_readonly</span>
                    <span class="c1"># we can&#39;t use enumerate, as we sometime skip groups</span>
                    <span class="n">group_count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gs</span><span class="p">:</span>
                        <span class="n">field_name</span> <span class="o">=</span> <span class="n">name_boolean_group</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                        <span class="n">dest_group</span> <span class="o">=</span> <span class="n">left_group</span> <span class="k">if</span> <span class="n">group_count</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">right_group</span>
                        <span class="k">if</span> <span class="n">g</span> <span class="o">==</span> <span class="n">group_no_one</span><span class="p">:</span>
                            <span class="c1"># make the group_no_one invisible in the form view</span>
                            <span class="n">dest_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span> <span class="n">invisible</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dest_group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">))</span>
                        <span class="c1"># add duplicate invisible field so default values are saved on create</span>
                        <span class="n">xml0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span> <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">invisible</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="s1">&#39;!base.group_no_one&#39;</span><span class="p">)))</span>
                        <span class="n">group_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">xml4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="o">*</span><span class="n">left_group</span><span class="p">))</span>
                    <span class="n">xml4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="o">*</span><span class="n">right_group</span><span class="p">))</span>

            <span class="n">xml4</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s2">&quot;o_label_nowrap&quot;</span><span class="p">})</span>
            <span class="n">user_type_invisible</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">user_type_field_name</span><span class="si">}</span><span class="s1"> != </span><span class="si">{</span><span class="n">group_employee</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">user_type_field_name</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">xml_cat</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">xml_by_category</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">it</span><span class="p">:</span> <span class="n">it</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">master_category_name</span> <span class="o">=</span> <span class="n">xml_cat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">xml3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">xml_by_category</span><span class="p">[</span><span class="n">xml_cat</span><span class="p">]),</span> <span class="n">string</span><span class="o">=</span><span class="n">master_category_name</span><span class="p">))</span>

            <span class="n">field_name</span> <span class="o">=</span> <span class="s1">&#39;user_group_warning&#39;</span>
            <span class="n">user_group_warning_xml</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">div</span><span class="p">({</span>
                <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s2">&quot;alert alert-warning&quot;</span><span class="p">,</span>
                <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s2">&quot;alert&quot;</span><span class="p">,</span>
                <span class="s1">&#39;colspan&#39;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
                <span class="s1">&#39;invisible&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;not </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="n">user_group_warning_xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">label</span><span class="p">({</span>
                <span class="s1">&#39;for&#39;</span><span class="p">:</span> <span class="n">field_name</span><span class="p">,</span>
                <span class="s1">&#39;string&#39;</span><span class="p">:</span> <span class="s2">&quot;Access Rights Mismatch&quot;</span><span class="p">,</span>
                <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s2">&quot;text text-warning fw-bold&quot;</span><span class="p">,</span>
            <span class="p">}))</span>
            <span class="n">user_group_warning_xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">field_name</span><span class="p">))</span>
            <span class="n">xml2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_group_warning_xml</span><span class="p">)</span>

            <span class="n">xml</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span>
                <span class="o">*</span><span class="p">(</span><span class="n">xml0</span><span class="p">),</span>
                <span class="n">E</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">xml1</span><span class="p">),</span> <span class="n">groups</span><span class="o">=</span><span class="s2">&quot;base.group_no_one&quot;</span><span class="p">),</span>
                <span class="n">E</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">xml2</span><span class="p">),</span> <span class="n">invisible</span><span class="o">=</span><span class="n">user_type_invisible</span><span class="p">),</span>
                <span class="n">E</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">xml3</span><span class="p">),</span> <span class="n">invisible</span><span class="o">=</span><span class="n">user_type_invisible</span><span class="p">),</span>
                <span class="n">E</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">xml4</span><span class="p">),</span> <span class="n">invisible</span><span class="o">=</span><span class="n">user_type_invisible</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="s2">&quot;base.group_no_one&quot;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;groups_id&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">)</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">addprevious</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="s2">&quot;GENERATED AUTOMATICALLY BY GROUPS&quot;</span><span class="p">))</span>

        <span class="c1"># serialize and update the view</span>
        <span class="n">xml_content</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;unicode&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xml_content</span> <span class="o">!=</span> <span class="n">view</span><span class="o">.</span><span class="n">arch</span><span class="p">:</span>  <span class="c1"># avoid useless xml validation if no change</span>
            <span class="n">new_context</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">_context</span><span class="p">)</span>
            <span class="n">new_context</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;install_filename&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># don&#39;t set arch_fs for this computed view</span>
            <span class="n">new_context</span><span class="p">[</span><span class="s1">&#39;lang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">view</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">new_context</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;arch&#39;</span><span class="p">:</span> <span class="n">xml_content</span><span class="p">})</span>

<div class="viewcode-block" id="GroupsView.get_application_groups">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.GroupsView.get_application_groups">[docs]</a>
    <span class="k">def</span> <span class="nf">get_application_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the non-share groups that satisfy ``domain``. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">domain</span> <span class="o">+</span> <span class="p">[(</span><span class="s1">&#39;share&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)])</span></div>


<div class="viewcode-block" id="GroupsView.get_groups_by_application">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.GroupsView.get_groups_by_application">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">get_groups_by_application</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return all groups classified by application (module category), as a list::</span>

<span class="sd">                [(app, kind, groups), ...],</span>

<span class="sd">            where ``app`` and ``groups`` are recordsets, and ``kind`` is either</span>
<span class="sd">            ``&#39;boolean&#39;`` or ``&#39;selection&#39;``. Applications are given in sequence</span>
<span class="sd">            order.  If ``kind`` is ``&#39;selection&#39;``, ``groups`` are given in</span>
<span class="sd">            reverse implication order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">linearize</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="n">category_name</span><span class="p">):</span>
            <span class="c1"># &#39;User Type&#39; is an exception</span>
            <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">xml_id</span> <span class="o">==</span> <span class="s1">&#39;base.module_category_user_type&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="s1">&#39;selection&#39;</span><span class="p">,</span> <span class="n">gs</span><span class="o">.</span><span class="n">sorted</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="n">category_name</span><span class="p">)</span>
            <span class="c1"># determine sequence order: a group appears after its implied groups</span>
            <span class="n">order</span> <span class="o">=</span> <span class="p">{</span><span class="n">g</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">trans_implied_ids</span> <span class="o">&amp;</span> <span class="n">gs</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gs</span><span class="p">}</span>
            <span class="c1"># We want a selection for Accounting too. Auditor and Invoice are both</span>
            <span class="c1"># children of Accountant, but the two of them make a full accountant</span>
            <span class="c1"># so it makes no sense to have checkboxes.</span>
            <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">xml_id</span> <span class="o">==</span> <span class="s1">&#39;base.module_category_accounting_accounting&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="s1">&#39;selection&#39;</span><span class="p">,</span> <span class="n">gs</span><span class="o">.</span><span class="n">sorted</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">get</span><span class="p">),</span> <span class="n">category_name</span><span class="p">)</span>
            <span class="c1"># check whether order is total, i.e., sequence orders are distinct</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">gs</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="s1">&#39;selection&#39;</span><span class="p">,</span> <span class="n">gs</span><span class="o">.</span><span class="n">sorted</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">get</span><span class="p">),</span> <span class="n">category_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;Other&#39;</span><span class="p">))</span>

        <span class="c1"># classify all groups by application</span>
        <span class="n">by_app</span><span class="p">,</span> <span class="n">others</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_application_groups</span><span class="p">([]):</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">category_id</span><span class="p">:</span>
                <span class="n">by_app</span><span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">category_id</span><span class="p">]</span> <span class="o">+=</span> <span class="n">g</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">others</span> <span class="o">+=</span> <span class="n">g</span>
        <span class="c1"># build the result</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">app</span><span class="p">,</span> <span class="n">gs</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">by_app</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">it</span><span class="p">:</span> <span class="n">it</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sequence</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">parent_id</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">linearize</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">parent_id</span><span class="o">.</span><span class="n">sequence</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">parent_id</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">linearize</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s1">&#39;Other&#39;</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">others</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.module.category&#39;</span><span class="p">],</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span> <span class="n">others</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="s1">&#39;Other&#39;</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">res</span></div>
</div>



<div class="viewcode-block" id="ModuleCategory">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.ModuleCategory">[docs]</a>
<span class="k">class</span> <span class="nc">ModuleCategory</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">_inherit</span> <span class="o">=</span> <span class="s2">&quot;ir.module.category&quot;</span>

<div class="viewcode-block" id="ModuleCategory.write">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.ModuleCategory.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;res.groups&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">_update_user_groups_view</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="ModuleCategory.unlink">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.ModuleCategory.unlink">[docs]</a>
    <span class="k">def</span> <span class="nf">unlink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;res.groups&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">_update_user_groups_view</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span></div>
</div>



<div class="viewcode-block" id="UsersView">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.UsersView">[docs]</a>
<span class="k">class</span> <span class="nc">UsersView</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">_inherit</span> <span class="o">=</span> <span class="s1">&#39;res.users&#39;</span>

    <span class="n">user_group_warning</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s2">&quot;User Group Warning&quot;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s2">&quot;_compute_user_group_warning&quot;</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;groups_id&#39;</span><span class="p">,</span> <span class="s1">&#39;share&#39;</span><span class="p">)</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">depends_context</span><span class="p">(</span><span class="s1">&#39;show_user_group_warning&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_user_group_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_group_warning</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;show_user_group_warning&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;share&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]):</span>
                <span class="n">group_inheritance_warnings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_warning_for_group_inheritance</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group_inheritance_warnings</span><span class="p">:</span>
                    <span class="n">user</span><span class="o">.</span><span class="n">user_group_warning</span> <span class="o">=</span> <span class="n">group_inheritance_warnings</span>

<div class="viewcode-block" id="UsersView.create">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.UsersView.create">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model_create_multi</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
        <span class="n">new_vals_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">vals_list</span><span class="p">:</span>
            <span class="n">new_vals_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_remove_reified_groups</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
        <span class="n">users</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">UsersView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">new_vals_list</span><span class="p">)</span>
        <span class="n">group_multi_company_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_xmlid_to_res_id</span><span class="p">(</span>
            <span class="s1">&#39;base.group_multi_company&#39;</span><span class="p">,</span> <span class="n">raise_if_not_found</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group_multi_company_id</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">company_ids</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">group_multi_company_id</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">groups_id</span><span class="o">.</span><span class="n">ids</span><span class="p">:</span>
                    <span class="n">user</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;groups_id&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">group_multi_company_id</span><span class="p">)]})</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">company_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">group_multi_company_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">groups_id</span><span class="o">.</span><span class="n">ids</span><span class="p">:</span>
                    <span class="n">user</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;groups_id&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">group_multi_company_id</span><span class="p">)]})</span>
        <span class="k">return</span> <span class="n">users</span></div>


<div class="viewcode-block" id="UsersView.write">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.UsersView.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_reified_groups</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">UsersView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;company_ids&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="n">group_multi_company</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.group_multi_company&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group_multi_company</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">company_ids</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">group_multi_company</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">ids</span><span class="p">:</span>
                    <span class="n">user</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;groups_id&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">group_multi_company</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">company_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group_multi_company</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">ids</span><span class="p">:</span>
                    <span class="n">user</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;groups_id&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">group_multi_company</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="UsersView.new">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.UsersView.new">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_reified_groups</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>
        <span class="n">group_multi_company</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.group_multi_company&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group_multi_company</span> <span class="ow">and</span> <span class="s1">&#39;company_ids&#39;</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">company_ids</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">group_multi_company</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">ids</span><span class="p">:</span>
                <span class="n">user</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;groups_id&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">group_multi_company</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">company_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group_multi_company</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">ids</span><span class="p">:</span>
                <span class="n">user</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;groups_id&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">group_multi_company</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>
        <span class="k">return</span> <span class="n">user</span></div>


    <span class="k">def</span> <span class="nf">_prepare_warning_for_group_inheritance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Check (updated) groups configuration for user. If implieds groups</span>
<span class="sd">        will be added back due to inheritance and hierarchy in groups return</span>
<span class="sd">        a message explaining the missing groups.</span>

<span class="sd">        :param res.users user: target user</span>

<span class="sd">        :return: string to display in a warning</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Current groups of the user</span>
        <span class="n">current_groups</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">groups_id</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="s1">&#39;trans_implied_ids&#39;</span><span class="p">)</span>
        <span class="n">current_groups_by_category</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.groups&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">current_groups</span><span class="p">:</span>
            <span class="n">current_groups_by_category</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">category_id</span><span class="p">]</span> <span class="o">|=</span> <span class="n">group</span><span class="o">.</span><span class="n">trans_implied_ids</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">grp</span><span class="p">:</span> <span class="n">grp</span><span class="o">.</span><span class="n">category_id</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">category_id</span><span class="p">)</span>

        <span class="n">missing_groups</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># We don&#39;t want to show warning for &quot;Technical&quot; and &quot;Extra Rights&quot; groups</span>
        <span class="n">categories_to_ignore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.module_category_hidden&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.module_category_usability&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">current_groups</span><span class="p">:</span>
            <span class="c1"># Get the updated group from current groups</span>
            <span class="n">missing_implied_groups</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">implied_ids</span> <span class="o">-</span> <span class="n">user</span><span class="o">.</span><span class="n">groups_id</span>
            <span class="c1"># Get the missing group needed in updated group&#39;s category (For example, someone changes</span>
            <span class="c1"># Sales: Admin to Sales: User, but Field Service is already set to Admin, so here in the</span>
            <span class="c1"># &#39;Sales&#39; category, we will at the minimum need Admin group)</span>
            <span class="n">missing_implied_groups</span> <span class="o">=</span> <span class="n">missing_implied_groups</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">g</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">category_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">category_id</span> <span class="o">|</span> <span class="n">categories_to_ignore</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">g</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_groups_by_category</span><span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">category_id</span><span class="p">]</span> <span class="ow">and</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_has_groups</span><span class="p">(</span><span class="s1">&#39;base.group_no_one&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">category_id</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">missing_implied_groups</span><span class="p">:</span>
                <span class="c1"># prepare missing group message, by categories</span>
                <span class="n">missing_groups</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">missing_group</span><span class="o">.</span><span class="n">category_id</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Other&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">missing_group</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
                                                  <span class="k">for</span> <span class="n">missing_group</span> <span class="ow">in</span> <span class="n">missing_implied_groups</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Since </span><span class="si">%(user)s</span><span class="s1"> is a/an &quot;</span><span class="si">%(category)s</span><span class="s1">: </span><span class="si">%(group)s</span><span class="s1">&quot;, they will at least obtain the right </span><span class="si">%(missing_group_message)s</span><span class="s1">&#39;</span><span class="p">,</span>
              <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
              <span class="n">category</span><span class="o">=</span><span class="n">group</span><span class="o">.</span><span class="n">category_id</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Other&#39;</span><span class="p">),</span>
              <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
              <span class="n">missing_group_message</span><span class="o">=</span><span class="n">missing_group_message</span>
             <span class="p">)</span> <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">missing_group_message</span> <span class="ow">in</span> <span class="n">missing_groups</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_remove_reified_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; return `values` without reified group fields &quot;&quot;&quot;</span>
        <span class="n">add</span><span class="p">,</span> <span class="n">rem</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">values1</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">is_boolean_group</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="p">(</span><span class="n">add</span> <span class="k">if</span> <span class="n">val</span> <span class="k">else</span> <span class="n">rem</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_boolean_group</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">is_selection_groups</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="n">rem</span> <span class="o">+=</span> <span class="n">get_selection_groups</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                    <span class="n">add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">if</span> <span class="s1">&#39;groups_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">values</span> <span class="ow">and</span> <span class="p">(</span><span class="n">add</span> <span class="ow">or</span> <span class="n">rem</span><span class="p">):</span>
            <span class="n">added</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.groups&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">add</span><span class="p">)</span>
            <span class="n">added</span> <span class="o">|=</span> <span class="n">added</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;trans_implied_ids&#39;</span><span class="p">)</span>
            <span class="n">added_ids</span> <span class="o">=</span> <span class="n">added</span><span class="o">.</span><span class="n">_ids</span>
            <span class="c1"># remove group ids in `rem` and add group ids in `add`</span>
            <span class="c1"># do not remove groups that are added by implied</span>
            <span class="n">values1</span><span class="p">[</span><span class="s1">&#39;groups_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="p">[</span><span class="n">gid</span> <span class="k">for</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">rem</span> <span class="k">if</span> <span class="n">gid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">added_ids</span><span class="p">]),</span>
                <span class="nb">zip</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">add</span><span class="p">)</span>
            <span class="p">))</span>

        <span class="k">return</span> <span class="n">values1</span>

<div class="viewcode-block" id="UsersView.default_get">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.UsersView.default_get">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">default_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
        <span class="n">group_fields</span><span class="p">,</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">partition</span><span class="p">(</span><span class="n">is_reified_group</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>
        <span class="n">fields1</span> <span class="o">=</span> <span class="p">(</span><span class="n">fields</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;groups_id&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">group_fields</span> <span class="k">else</span> <span class="n">fields</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">UsersView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">default_get</span><span class="p">(</span><span class="n">fields1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_reified_groups</span><span class="p">(</span><span class="n">group_fields</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span></div>


    <span class="k">def</span> <span class="nf">_determine_fields_to_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">ignore_when_in_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">valid_fields</span> <span class="o">=</span> <span class="n">partition</span><span class="p">(</span><span class="n">is_reified_group</span><span class="p">,</span> <span class="n">field_names</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_determine_fields_to_fetch</span><span class="p">(</span><span class="n">valid_fields</span><span class="p">,</span> <span class="n">ignore_when_in_cache</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnames</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="s1">&#39;_classic_read&#39;</span><span class="p">):</span>
        <span class="n">valid_fields</span> <span class="o">=</span> <span class="n">partition</span><span class="p">(</span><span class="n">is_reified_group</span><span class="p">,</span> <span class="n">fnames</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_read_format</span><span class="p">(</span><span class="n">valid_fields</span><span class="p">,</span> <span class="n">load</span><span class="p">)</span>

<div class="viewcode-block" id="UsersView.onchange">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.UsersView.onchange">[docs]</a>
    <span class="k">def</span> <span class="nf">onchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">fields_spec</span><span class="p">):</span>
        <span class="n">reified_fnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">fname</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fields_spec</span> <span class="k">if</span> <span class="n">is_reified_group</span><span class="p">(</span><span class="n">fname</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">reified_fnames</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;groups_id&#39;</span><span class="p">}</span>
            <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_reified_groups</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">is_reified_group</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">):</span>
                <span class="n">field_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">fname</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">field_names</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_reified_group</span><span class="p">(</span><span class="n">fname</span><span class="p">)]</span>
                <span class="n">field_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;groups_id&#39;</span><span class="p">)</span>

            <span class="n">fields_spec</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">field_name</span><span class="p">:</span> <span class="n">field_spec</span>
                <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_spec</span> <span class="ow">in</span> <span class="n">fields_spec</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_reified_group</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">fields_spec</span><span class="p">[</span><span class="s1">&#39;groups_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">onchange</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">fields_spec</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reified_fnames</span> <span class="ow">and</span> <span class="s1">&#39;groups_id&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="p">{}):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_reified_groups</span><span class="p">(</span><span class="n">reified_fnames</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;groups_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="UsersView.read">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.UsersView.read">[docs]</a>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="s1">&#39;_classic_read&#39;</span><span class="p">):</span>
        <span class="c1"># determine whether reified groups fields are required, and which ones</span>
        <span class="n">fields1</span> <span class="o">=</span> <span class="n">fields</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_get</span><span class="p">())</span>
        <span class="n">group_fields</span><span class="p">,</span> <span class="n">other_fields</span> <span class="o">=</span> <span class="n">partition</span><span class="p">(</span><span class="n">is_reified_group</span><span class="p">,</span> <span class="n">fields1</span><span class="p">)</span>

        <span class="c1"># read regular fields (other_fields); add &#39;groups_id&#39; if necessary</span>
        <span class="n">drop_groups_id</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">group_fields</span> <span class="ow">and</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;groups_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other_fields</span><span class="p">:</span>
                <span class="n">other_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;groups_id&#39;</span><span class="p">)</span>
                <span class="n">drop_groups_id</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">other_fields</span> <span class="o">=</span> <span class="n">fields</span>

        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">UsersView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">other_fields</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="n">load</span><span class="p">)</span>

        <span class="c1"># post-process result to add reified group fields</span>
        <span class="k">if</span> <span class="n">group_fields</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_reified_groups</span><span class="p">(</span><span class="n">group_fields</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">drop_groups_id</span><span class="p">:</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;groups_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="UsersView.read_group">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.UsersView.read_group">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">read_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orderby</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fields</span><span class="p">:</span>
            <span class="c1"># ignore reified fields</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">fname</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_reified_group</span><span class="p">(</span><span class="n">fname</span><span class="p">)]</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">read_group</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">orderby</span><span class="o">=</span><span class="n">orderby</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="n">lazy</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_add_reified_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; add the given reified group fields into `values` &quot;&quot;&quot;</span>
        <span class="n">gids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">parse_m2m</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;groups_id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]))</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_boolean_group</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="n">values</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_boolean_group</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">in</span> <span class="n">gids</span>
            <span class="k">elif</span> <span class="n">is_selection_groups</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="c1"># determine selection groups, in order</span>
                <span class="n">sel_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.groups&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">get_selection_groups</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="n">sel_order</span> <span class="o">=</span> <span class="p">{</span><span class="n">g</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">trans_implied_ids</span> <span class="o">&amp;</span> <span class="n">sel_groups</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">sel_groups</span><span class="p">}</span>
                <span class="n">sel_groups</span> <span class="o">=</span> <span class="n">sel_groups</span><span class="o">.</span><span class="n">sorted</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">sel_order</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
                <span class="c1"># determine which ones are in gids</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="p">[</span><span class="n">gid</span> <span class="k">for</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">sel_groups</span><span class="o">.</span><span class="n">ids</span> <span class="k">if</span> <span class="n">gid</span> <span class="ow">in</span> <span class="n">gids</span><span class="p">]</span>
                <span class="c1"># if &#39;Internal User&#39; is in the group, this is the &quot;User Type&quot; group</span>
                <span class="c1"># and we need to show &#39;Internal User&#39; selected, not Public/Portal.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.group_user&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">:</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.group_user&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected</span> <span class="ow">and</span> <span class="n">selected</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">False</span>

<div class="viewcode-block" id="UsersView.fields_get">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.UsersView.fields_get">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">fields_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allfields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">UsersView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">fields_get</span><span class="p">(</span><span class="n">allfields</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="n">attributes</span><span class="p">)</span>
        <span class="c1"># add reified groups fields</span>
        <span class="k">for</span> <span class="n">app</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="n">category_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.groups&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">get_groups_by_application</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;selection&#39;</span><span class="p">:</span>
                <span class="c1"># &#39;User Type&#39; should not be &#39;False&#39;. A user is either &#39;employee&#39;, &#39;portal&#39; or &#39;public&#39; (required).</span>
                <span class="n">selection_vals</span> <span class="o">=</span> <span class="p">[(</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">xml_id</span> <span class="o">==</span> <span class="s1">&#39;base.module_category_user_type&#39;</span><span class="p">:</span>
                    <span class="n">selection_vals</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">field_name</span> <span class="o">=</span> <span class="n">name_selection_groups</span><span class="p">(</span><span class="n">gs</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">allfields</span> <span class="ow">and</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allfields</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># selection group field</span>
                <span class="n">tips</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
                    <span class="n">tips</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">description</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">tips</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">comment</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gs</span> <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">comment</span><span class="p">)</span>
                <span class="n">res</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;selection&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;string&#39;</span><span class="p">:</span> <span class="n">app</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Other&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;selection&#39;</span><span class="p">:</span> <span class="n">selection_vals</span> <span class="o">+</span> <span class="p">[(</span><span class="n">g</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gs</span><span class="p">],</span>
                    <span class="s1">&#39;help&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tips</span><span class="p">),</span>
                    <span class="s1">&#39;exportable&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;selectable&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># boolean group fields</span>
                <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gs</span><span class="p">:</span>
                    <span class="n">field_name</span> <span class="o">=</span> <span class="n">name_boolean_group</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">allfields</span> <span class="ow">and</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allfields</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">res</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;string&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="s1">&#39;help&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">comment</span><span class="p">,</span>
                        <span class="s1">&#39;exportable&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s1">&#39;selectable&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="p">}</span>
        <span class="c1"># add self readable/writable fields</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SELF_WRITEABLE_FIELDS</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SELF_READABLE_FIELDS</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">allfields</span><span class="p">:</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="n">missing</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">allfields</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="n">key</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SELF_WRITEABLE_FIELDS</span><span class="p">,</span> <span class="n">searchable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">(</span><span class="n">UsersView</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">())</span><span class="o">.</span><span class="n">fields_get</span><span class="p">(</span><span class="n">missing</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">res</span></div>
</div>


<div class="viewcode-block" id="CheckIdentity">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.CheckIdentity">[docs]</a>
<span class="k">class</span> <span class="nc">CheckIdentity</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">TransientModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Wizard used to re-check the user&#39;s credentials (password) and eventually</span>
<span class="sd">    revoke access to his account to every device he has an active session on.</span>

<span class="sd">    Might be useful before the more security-sensitive operations, users might be</span>
<span class="sd">    leaving their computer unlocked &amp; unattended. Re-checking credentials mitigates</span>
<span class="sd">    some of the risk of a third party using such an unattended device to manipulate</span>
<span class="sd">    the account.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;res.users.identitycheck&#39;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s2">&quot;Password Check Wizard&quot;</span>

    <span class="n">request</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">fields</span><span class="o">.</span><span class="n">NO_ACCESS</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_check_identity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_uid</span><span class="o">.</span><span class="n">_check_credentials</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;interactive&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
        <span class="k">except</span> <span class="n">AccessDenied</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Incorrect Password, try again or click on Forgot Password to reset your password.&quot;</span><span class="p">))</span>

<div class="viewcode-block" id="CheckIdentity.run_check">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.CheckIdentity.run_check">[docs]</a>
    <span class="k">def</span> <span class="nf">run_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">request</span><span class="p">,</span> <span class="s2">&quot;This method can only be accessed over HTTP&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_identity</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;identity-check-last&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">ctx</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
        <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">ctx</span><span class="p">)[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span> <span class="n">method</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s1">&#39;__has_check_identity&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">method</span><span class="p">()</span></div>


<div class="viewcode-block" id="CheckIdentity.revoke_all_devices">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.CheckIdentity.revoke_all_devices">[docs]</a>
    <span class="k">def</span> <span class="nf">revoke_all_devices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_identity</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">_change_password</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.client&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;reload&#39;</span><span class="p">}</span></div>
</div>


<span class="c1">#----------------------------------------------------------</span>
<span class="c1"># change password wizard</span>
<span class="c1">#----------------------------------------------------------</span>

<div class="viewcode-block" id="ChangePasswordWizard">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.ChangePasswordWizard">[docs]</a>
<span class="k">class</span> <span class="nc">ChangePasswordWizard</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">TransientModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; A wizard to manage the change of users&#39; passwords. &quot;&quot;&quot;</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s2">&quot;change.password.wizard&quot;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s2">&quot;Change Password Wizard&quot;</span>
    <span class="n">_transient_max_hours</span> <span class="o">=</span> <span class="mf">0.2</span>

    <span class="k">def</span> <span class="nf">_default_user_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active_model&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;res.users&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active_ids&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;user_login&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">login</span><span class="p">})</span>
            <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">user_ids</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="n">user_ids</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">One2many</span><span class="p">(</span><span class="s1">&#39;change.password.user&#39;</span><span class="p">,</span> <span class="s1">&#39;wizard_id&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Users&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_default_user_ids</span><span class="p">)</span>

<div class="viewcode-block" id="ChangePasswordWizard.change_password_button">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.ChangePasswordWizard.change_password_button">[docs]</a>
    <span class="k">def</span> <span class="nf">change_password_button</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_ids</span><span class="o">.</span><span class="n">change_password_button</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_ids</span><span class="o">.</span><span class="n">user_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.client&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;reload&#39;</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.act_window_close&#39;</span><span class="p">}</span></div>
</div>



<div class="viewcode-block" id="ChangePasswordUser">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.ChangePasswordUser">[docs]</a>
<span class="k">class</span> <span class="nc">ChangePasswordUser</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">TransientModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; A model to configure users in the change password wizard. &quot;&quot;&quot;</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;change.password.user&#39;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s1">&#39;User, Change Password Wizard&#39;</span>

    <span class="n">wizard_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;change.password.wizard&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Wizard&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;cascade&#39;</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;res.users&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;cascade&#39;</span><span class="p">)</span>
    <span class="n">user_login</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;User Login&#39;</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">new_passwd</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;New Password&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="ChangePasswordUser.change_password_button">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.ChangePasswordUser.change_password_button">[docs]</a>
    <span class="k">def</span> <span class="nf">change_password_button</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">new_passwd</span><span class="p">:</span>
                <span class="n">line</span><span class="o">.</span><span class="n">user_id</span><span class="o">.</span><span class="n">_change_password</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">new_passwd</span><span class="p">)</span>
        <span class="c1"># don&#39;t keep temporary passwords in the database longer than necessary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;new_passwd&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span></div>
</div>


<div class="viewcode-block" id="ChangePasswordOwn">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.ChangePasswordOwn">[docs]</a>
<span class="k">class</span> <span class="nc">ChangePasswordOwn</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">TransientModel</span><span class="p">):</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s2">&quot;change.password.own&quot;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s2">&quot;User, change own password wizard&quot;</span>
    <span class="n">_transient_max_hours</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="n">new_password</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s2">&quot;New Password&quot;</span><span class="p">)</span>
    <span class="n">confirm_password</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s2">&quot;New Password (Confirmation)&quot;</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="s1">&#39;new_password&#39;</span><span class="p">,</span> <span class="s1">&#39;confirm_password&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_password_confirmation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirm_password</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_password</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;The new password and its confirmation must be identical.&quot;</span><span class="p">))</span>

<div class="viewcode-block" id="ChangePasswordOwn.change_password">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.ChangePasswordOwn.change_password">[docs]</a>
    <span class="nd">@check_identity</span>
    <span class="k">def</span> <span class="nf">change_password</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">_change_password</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_password</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="c1"># reload to avoid a session expired error</span>
        <span class="c1"># would be great to update the session id in-place, but it seems dicey</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.client&#39;</span><span class="p">,</span> <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;reload&#39;</span><span class="p">}</span></div>
</div>


<span class="c1"># API keys support</span>
<span class="n">API_KEY_SIZE</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1"># in bytes</span>
<span class="n">INDEX_SIZE</span> <span class="o">=</span> <span class="mi">8</span> <span class="c1"># in hex digits, so 4 bytes, or 20% of the key</span>
<span class="n">KEY_CRYPT_CONTEXT</span> <span class="o">=</span> <span class="n">CryptContext</span><span class="p">(</span>
    <span class="c1"># default is 29000 rounds which is 25~50ms, which is probably unnecessary</span>
    <span class="c1"># given in this case all the keys are completely random data: dictionary</span>
    <span class="c1"># attacks on API keys isn&#39;t much of a concern</span>
    <span class="p">[</span><span class="s1">&#39;pbkdf2_sha512&#39;</span><span class="p">],</span> <span class="n">pbkdf2_sha512__rounds</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span>
<span class="p">)</span>
<div class="viewcode-block" id="APIKeysUser">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.APIKeysUser">[docs]</a>
<span class="k">class</span> <span class="nc">APIKeysUser</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">_inherit</span> <span class="o">=</span> <span class="s1">&#39;res.users&#39;</span>

    <span class="n">api_key_ids</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">One2many</span><span class="p">(</span><span class="s1">&#39;res.users.apikeys&#39;</span><span class="p">,</span> <span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s2">&quot;API Keys&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">SELF_READABLE_FIELDS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">SELF_READABLE_FIELDS</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;api_key_ids&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">SELF_WRITEABLE_FIELDS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">SELF_WRITEABLE_FIELDS</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;api_key_ids&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_rpc_api_keys_only</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; To be overridden if RPC access needs to be restricted to API keys, e.g. for 2FA &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_check_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">user_agent_env</span><span class="p">):</span>
        <span class="n">user_agent_env</span> <span class="o">=</span> <span class="n">user_agent_env</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">user_agent_env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;interactive&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;interactive&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_agent_env</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;_check_credentials without &#39;interactive&#39; env key, assuming interactive login. </span><span class="se">\</span>
<span class="s2">                    Check calls and overrides to ensure the &#39;interactive&#39; key is properly set in </span><span class="se">\</span>
<span class="s2">                    all _check_credentials environments&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_check_credentials</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user_agent_env</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">_rpc_api_keys_only</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_check_credentials</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user_agent_env</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">AccessDenied</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># &#39;rpc&#39; scope does not really exist, we basically require a global key (scope NULL)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users.apikeys&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_check_credentials</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;rpc&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">password</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">raise</span> <span class="n">AccessDenied</span><span class="p">()</span>

<div class="viewcode-block" id="APIKeysUser.api_key_wizard">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.APIKeysUser.api_key_wizard">[docs]</a>
    <span class="nd">@check_identity</span>
    <span class="k">def</span> <span class="nf">api_key_wizard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.act_window&#39;</span><span class="p">,</span>
            <span class="s1">&#39;res_model&#39;</span><span class="p">:</span> <span class="s1">&#39;res.users.apikeys.description&#39;</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;New API Key&#39;</span><span class="p">,</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span>
            <span class="s1">&#39;views&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">)],</span>
        <span class="p">}</span></div>
</div>


<div class="viewcode-block" id="APIKeys">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.APIKeys">[docs]</a>
<span class="k">class</span> <span class="nc">APIKeys</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;res.users.apikeys&#39;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s1">&#39;Users API Keys&#39;</span>
    <span class="n">_auto</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># so we can have a secret column</span>
    <span class="n">_allow_sudo_commands</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="s2">&quot;Description&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;res.users&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s2">&quot;cascade&quot;</span><span class="p">)</span>
    <span class="n">scope</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="s2">&quot;Scope&quot;</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">create_date</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Datetime</span><span class="p">(</span><span class="s2">&quot;Creation Date&quot;</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="APIKeys.init">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.APIKeys.init">[docs]</a>
    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS </span><span class="si">{table}</span><span class="s2"> (</span>
<span class="s2">            id serial primary key,</span>
<span class="s2">            name varchar not null,</span>
<span class="s2">            user_id integer not null REFERENCES res_users(id) ON DELETE CASCADE,</span>
<span class="s2">            scope varchar,</span>
<span class="s2">            index varchar(</span><span class="si">{index_size}</span><span class="s2">) not null CHECK (char_length(index) = </span><span class="si">{index_size}</span><span class="s2">),</span>
<span class="s2">            key varchar not null,</span>
<span class="s2">            create_date timestamp without time zone DEFAULT (now() at time zone &#39;utc&#39;)</span>
<span class="s2">        )</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">,</span> <span class="n">index_size</span><span class="o">=</span><span class="n">sql</span><span class="o">.</span><span class="n">Placeholder</span><span class="p">(</span><span class="s1">&#39;index_size&#39;</span><span class="p">)),</span> <span class="p">{</span>
            <span class="s1">&#39;index_size&#39;</span><span class="p">:</span> <span class="n">INDEX_SIZE</span>
        <span class="p">})</span>

        <span class="n">index_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">+</span> <span class="s2">&quot;_user_id_index_idx&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">:</span>
            <span class="c1"># unique determinist index name</span>
            <span class="n">index_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_idx_&quot;</span> <span class="o">+</span> <span class="n">sha256</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">8</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE INDEX IF NOT EXISTS </span><span class="si">{index_name}</span><span class="s2"> ON </span><span class="si">{table}</span><span class="s2"> (user_id, index);</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">,</span>
            <span class="n">index_name</span><span class="o">=</span><span class="n">sql</span><span class="o">.</span><span class="n">Identifier</span><span class="p">(</span><span class="n">index_name</span><span class="p">)</span>
        <span class="p">))</span></div>


<div class="viewcode-block" id="APIKeys.remove">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.APIKeys.remove">[docs]</a>
    <span class="nd">@check_identity</span>
    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Use the remove() method to remove an API Key. This method implement logic,</span>
<span class="sd">        but won&#39;t check the identity (mainly used to remove trusted devices)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.act_window_close&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">is_system</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">request</span> <span class="k">else</span> <span class="s1">&#39;n/a&#39;</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;API key(s) removed: scope: &lt;</span><span class="si">%s</span><span class="s2">&gt; for &#39;</span><span class="si">%s</span><span class="s2">&#39; (#</span><span class="si">%s</span><span class="s2">) from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;scope&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">login</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.act_window_close&#39;</span><span class="p">}</span>
        <span class="k">raise</span> <span class="n">AccessError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;You can not remove API keys unless they&#39;re yours or you are a system user&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">scope</span><span class="p">,</span> <span class="s2">&quot;scope is required&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">key</span><span class="p">[:</span><span class="n">INDEX_SIZE</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            SELECT user_id, key</span>
<span class="s1">            FROM </span><span class="si">{}</span><span class="s1"> INNER JOIN res_users u ON (u.id = user_id)</span>
<span class="s1">            WHERE u.active and index = </span><span class="si">%s</span><span class="s1"> AND (scope IS NULL OR scope = </span><span class="si">%s</span><span class="s1">)</span>
<span class="s1">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">),</span>
        <span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">scope</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">current_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">KEY_CRYPT_CONTEXT</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">current_key</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">user_id</span>

    <span class="k">def</span> <span class="nf">_generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates an api key.</span>
<span class="sd">        :param str scope: the scope of the key. If None, the key will give access to any rpc.</span>
<span class="sd">        :param str name: the name of the key, mainly intended to be displayed in the UI.</span>
<span class="sd">        :return: str: the key.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># no need to clear the LRU when *adding* a key, only when removing</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="n">API_KEY_SIZE</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        INSERT INTO </span><span class="si">{table}</span><span class="s2"> (name, user_id, scope, key, index)</span>
<span class="s2">        VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">        RETURNING id</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">),</span>
        <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">KEY_CRYPT_CONTEXT</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">k</span><span class="p">[:</span><span class="n">INDEX_SIZE</span><span class="p">]])</span>

        <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">request</span> <span class="k">else</span> <span class="s1">&#39;n/a&#39;</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> generated: scope: &lt;</span><span class="si">%s</span><span class="s2">&gt; for &#39;</span><span class="si">%s</span><span class="s2">&#39; (#</span><span class="si">%s</span><span class="s2">) from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">login</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">k</span></div>


<div class="viewcode-block" id="APIKeyDescription">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.APIKeyDescription">[docs]</a>
<span class="k">class</span> <span class="nc">APIKeyDescription</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">TransientModel</span><span class="p">):</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;res.users.apikeys.description&#39;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s1">&#39;API Key Description&#39;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="s2">&quot;Description&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="APIKeyDescription.make_key">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.APIKeyDescription.make_key">[docs]</a>
    <span class="nd">@check_identity</span>
    <span class="k">def</span> <span class="nf">make_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># only create keys for users who can delete their keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_make_key</span><span class="p">()</span>

        <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users.apikeys&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_generate</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">description</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.act_window&#39;</span><span class="p">,</span>
            <span class="s1">&#39;res_model&#39;</span><span class="p">:</span> <span class="s1">&#39;res.users.apikeys.show&#39;</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;API Key Ready&#39;</span><span class="p">),</span>
            <span class="s1">&#39;views&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">)],</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span>
            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;default_key&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="APIKeyDescription.check_access_make_key">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.APIKeyDescription.check_access_make_key">[docs]</a>
    <span class="k">def</span> <span class="nf">check_access_make_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_has_groups</span><span class="p">(</span><span class="s1">&#39;base.group_user&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">AccessError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Only internal users can create API keys&quot;</span><span class="p">))</span></div>
</div>


<div class="viewcode-block" id="APIKeyShow">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_users.APIKeyShow">[docs]</a>
<span class="k">class</span> <span class="nc">APIKeyShow</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">AbstractModel</span><span class="p">):</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;res.users.apikeys.show&#39;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s1">&#39;Show API Key&#39;</span>

    <span class="c1"># the field &#39;id&#39; is necessary for the onchange that returns the value of &#39;key&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Id</span><span class="p">()</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Amr.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>