<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>odoo.addons.base.models.res_partner &mdash; Amr  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Amr
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modules.html">odoo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Amr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../../odoo.html">odoo</a></li>
          <li class="breadcrumb-item"><a href="../../base.html">odoo.addons.base</a></li>
      <li class="breadcrumb-item active">odoo.addons.base.models.res_partner</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for odoo.addons.base.models.res_partner</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># Part of Odoo. See LICENSE file for full copyright and licensing details.</span>

<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">pytz</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>
<span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">urls</span>

<span class="kn">from</span> <span class="nn">odoo</span> <span class="kn">import</span> <span class="n">api</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">tools</span><span class="p">,</span> <span class="n">SUPERUSER_ID</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Command</span>
<span class="kn">from</span> <span class="nn">odoo.osv.expression</span> <span class="kn">import</span> <span class="n">get_unaccent_wrapper</span>
<span class="kn">from</span> <span class="nn">odoo.exceptions</span> <span class="kn">import</span> <span class="n">RedirectWarning</span><span class="p">,</span> <span class="n">UserError</span><span class="p">,</span> <span class="n">ValidationError</span>

<span class="c1"># Global variables used for the warning fields declared on the res.partner</span>
<span class="c1"># in the following modules : sale, purchase, account, stock</span>
<span class="n">WARNING_MESSAGE</span> <span class="o">=</span> <span class="p">[</span>
                   <span class="p">(</span><span class="s1">&#39;no-message&#39;</span><span class="p">,</span><span class="s1">&#39;No Message&#39;</span><span class="p">),</span>
                   <span class="p">(</span><span class="s1">&#39;warning&#39;</span><span class="p">,</span><span class="s1">&#39;Warning&#39;</span><span class="p">),</span>
                   <span class="p">(</span><span class="s1">&#39;block&#39;</span><span class="p">,</span><span class="s1">&#39;Blocking Message&#39;</span><span class="p">)</span>
                   <span class="p">]</span>
<span class="n">WARNING_HELP</span> <span class="o">=</span> <span class="s1">&#39;Selecting the &quot;Warning&quot; option will notify user with the message, Selecting &quot;Blocking Message&quot; will throw an exception with the message and block the flow. The Message has to be written in the next field.&#39;</span>


<span class="n">ADDRESS_FIELDS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;street&#39;</span><span class="p">,</span> <span class="s1">&#39;street2&#39;</span><span class="p">,</span> <span class="s1">&#39;zip&#39;</span><span class="p">,</span> <span class="s1">&#39;city&#39;</span><span class="p">,</span> <span class="s1">&#39;state_id&#39;</span><span class="p">,</span> <span class="s1">&#39;country_id&#39;</span><span class="p">)</span>
<span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
<span class="k">def</span> <span class="nf">_lang_get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.lang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_installed</span><span class="p">()</span>


<span class="c1"># put POSIX &#39;Etc/*&#39; entries at the end to avoid confusing users - see bug 1086728</span>
<span class="n">_tzs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">tz</span><span class="p">,</span> <span class="n">tz</span><span class="p">)</span> <span class="k">for</span> <span class="n">tz</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">all_timezones</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tz</span><span class="p">:</span> <span class="n">tz</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">tz</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Etc/&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;_&#39;</span><span class="p">)]</span>
<span class="k">def</span> <span class="nf">_tz_get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_tzs</span>


<div class="viewcode-block" id="FormatAddressMixin">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_partner.FormatAddressMixin">[docs]</a>
<span class="k">class</span> <span class="nc">FormatAddressMixin</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">AbstractModel</span><span class="p">):</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s2">&quot;format.address.mixin&quot;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s1">&#39;Address Format&#39;</span>

    <span class="k">def</span> <span class="nf">_view_get_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arch</span><span class="p">):</span>
        <span class="c1"># consider the country of the user, not the country of the partner we want to display</span>
        <span class="n">address_view_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">country_id</span><span class="o">.</span><span class="n">address_view_id</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span>
        <span class="n">address_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">country_id</span><span class="o">.</span><span class="n">address_format</span>
        <span class="k">if</span> <span class="n">address_view_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;no_address_format&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">address_view_id</span><span class="o">.</span><span class="n">model</span> <span class="ow">or</span> <span class="n">address_view_id</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">):</span>
            <span class="c1">#render the partner address accordingly to address_view_id</span>
            <span class="k">for</span> <span class="n">address_node</span> <span class="ow">in</span> <span class="n">arch</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&quot;//div[hasclass(&#39;o_address_format&#39;)]&quot;</span><span class="p">):</span>
                <span class="n">Partner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.partner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">no_address_format</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">sub_arch</span><span class="p">,</span> <span class="n">_sub_view</span> <span class="o">=</span> <span class="n">Partner</span><span class="o">.</span><span class="n">_get_view</span><span class="p">(</span><span class="n">address_view_id</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">)</span>
                <span class="c1">#if the model is different than res.partner, there are chances that the view won&#39;t work</span>
                <span class="c1">#(e.g fields not present on the model). In that case we just return arch</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">!=</span> <span class="s1">&#39;res.partner&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">postprocess_and_fields</span><span class="p">(</span><span class="n">sub_arch</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">arch</span>
                <span class="n">address_node</span><span class="o">.</span><span class="n">getparent</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">address_node</span><span class="p">,</span> <span class="n">sub_arch</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">address_format</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;no_address_format&#39;</span><span class="p">):</span>
            <span class="c1"># For the zip, city and state fields we need to move them around in order to follow the country address format.</span>
            <span class="c1"># The purpose of this is to help the user by following a format he is used to.</span>
            <span class="n">city_line</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">address_format</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;city&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">city_line</span><span class="p">:</span>
                <span class="n">field_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%(&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)s&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">city_line</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">address_node</span> <span class="ow">in</span> <span class="n">arch</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&quot;//div[hasclass(&#39;o_address_format&#39;)]&quot;</span><span class="p">):</span>
                    <span class="n">concerned_fields</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;zip&#39;</span><span class="p">,</span> <span class="s1">&#39;city&#39;</span><span class="p">,</span> <span class="s1">&#39;state_id&#39;</span><span class="p">}</span> <span class="o">-</span> <span class="p">{</span><span class="n">field_order</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
                    <span class="n">current_field</span> <span class="o">=</span> <span class="n">address_node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;.//field[@name=&#39;</span><span class="si">{</span><span class="n">field_order</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;]&quot;</span><span class="p">)</span>
                    <span class="c1"># First loop into the fields displayed in the address_format, and order them.</span>
                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">field_order</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;state_code&#39;</span><span class="p">,</span> <span class="s1">&#39;state_name&#39;</span><span class="p">):</span>
                            <span class="n">field</span> <span class="o">=</span> <span class="s1">&#39;state_id&#39;</span>
                        <span class="n">previous_field</span> <span class="o">=</span> <span class="n">current_field</span>
                        <span class="n">current_field</span> <span class="o">=</span> <span class="n">address_node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;.//field[@name=&#39;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&#39;]&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">previous_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">current_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">previous_field</span><span class="o">.</span><span class="n">addnext</span><span class="p">(</span><span class="n">current_field</span><span class="p">)</span>
                        <span class="n">concerned_fields</span> <span class="o">-=</span> <span class="p">{</span><span class="n">field</span><span class="p">}</span>
                    <span class="c1"># Add the remaining fields in &#39;concerned_fields&#39; at the end, after the others</span>
                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">concerned_fields</span><span class="p">:</span>
                        <span class="n">previous_field</span> <span class="o">=</span> <span class="n">current_field</span>
                        <span class="n">current_field</span> <span class="o">=</span> <span class="n">address_node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;.//field[@name=&#39;</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&#39;]&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">previous_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">current_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">previous_field</span><span class="o">.</span><span class="n">addnext</span><span class="p">(</span><span class="n">current_field</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">arch</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_view_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">view_type</span><span class="o">=</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The override of _get_view, using _view_get_address,</span>
<span class="sd">        changing the architecture according to the address view of the company,</span>
<span class="sd">        makes the view cache dependent on the company.</span>
<span class="sd">        Different companies could use each a different address view&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_view_cache_key</span><span class="p">(</span><span class="n">view_id</span><span class="p">,</span> <span class="n">view_type</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">key</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;no_address_format&#39;</span><span class="p">),)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">view_type</span><span class="o">=</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">arch</span><span class="p">,</span> <span class="n">view</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_view</span><span class="p">(</span><span class="n">view_id</span><span class="p">,</span> <span class="n">view_type</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">view</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;form&#39;</span><span class="p">:</span>
            <span class="n">arch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_view_get_address</span><span class="p">(</span><span class="n">arch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">arch</span><span class="p">,</span> <span class="n">view</span></div>



<div class="viewcode-block" id="PartnerCategory">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_partner.PartnerCategory">[docs]</a>
<span class="k">class</span> <span class="nc">PartnerCategory</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s1">&#39;Partner Tags&#39;</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;res.partner.category&#39;</span>
    <span class="n">_order</span> <span class="o">=</span> <span class="s1">&#39;name&#39;</span>
    <span class="n">_parent_store</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_get_default_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Tag Name&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">translate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Integer</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Color&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_get_default_color</span><span class="p">)</span>
    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;res.partner.category&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Parent Category&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;cascade&#39;</span><span class="p">)</span>
    <span class="n">child_ids</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">One2many</span><span class="p">(</span><span class="s1">&#39;res.partner.category&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_id&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Child Tags&#39;</span><span class="p">)</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The active field allows you to hide the category without removing it.&quot;</span><span class="p">)</span>
    <span class="n">parent_path</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unaccent</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">partner_ids</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2many</span><span class="p">(</span><span class="s1">&#39;res.partner&#39;</span><span class="p">,</span> <span class="n">column1</span><span class="o">=</span><span class="s1">&#39;category_id&#39;</span><span class="p">,</span> <span class="n">column2</span><span class="o">=</span><span class="s1">&#39;partner_id&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Partners&#39;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="s1">&#39;parent_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_parent_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_recursion</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;You can not create recursive tags.&#39;</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;parent_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_display_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the categories&#39; display name, including their direct</span>
<span class="sd">            parent by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">category</span>
            <span class="k">while</span> <span class="n">current</span><span class="p">:</span>
                <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">parent_id</span>
            <span class="n">category</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="s1">&#39; / &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">names</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_name_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="s1">&#39;ilike&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">domain</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="c1"># Be sure name_search is symetric to display_name</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; / &#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">name</span><span class="p">)]</span> <span class="o">+</span> <span class="n">domain</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span></div>



<div class="viewcode-block" id="PartnerTitle">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_partner.PartnerTitle">[docs]</a>
<span class="k">class</span> <span class="nc">PartnerTitle</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;res.partner.title&#39;</span>
    <span class="n">_order</span> <span class="o">=</span> <span class="s1">&#39;name&#39;</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s1">&#39;Partner Title&#39;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Title&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">translate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">shortcut</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Abbreviation&#39;</span><span class="p">,</span> <span class="n">translate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



<div class="viewcode-block" id="Partner">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_partner.Partner">[docs]</a>
<span class="k">class</span> <span class="nc">Partner</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s1">&#39;Contact&#39;</span>
    <span class="n">_inherit</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;format.address.mixin&#39;</span><span class="p">,</span> <span class="s1">&#39;avatar.mixin&#39;</span><span class="p">]</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s2">&quot;res.partner&quot;</span>
    <span class="n">_order</span> <span class="o">=</span> <span class="s2">&quot;complete_name ASC, id DESC&quot;</span>
    <span class="n">_rec_names_search</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;complete_name&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;ref&#39;</span><span class="p">,</span> <span class="s1">&#39;vat&#39;</span><span class="p">,</span> <span class="s1">&#39;company_registry&#39;</span><span class="p">]</span>  <span class="c1"># TODO vat must be sanitized the same way for storing/searching</span>
    <span class="n">_allow_sudo_commands</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># the partner types that must be added to a partner&#39;s complete name, like &quot;Delivery&quot;</span>
    <span class="n">_complete_name_displayed_types</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;invoice&#39;</span><span class="p">,</span> <span class="s1">&#39;delivery&#39;</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_default_category</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.partner.category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;category_id&#39;</span><span class="p">))</span>

<div class="viewcode-block" id="Partner.default_get">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_partner.Partner.default_get">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">default_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_fields</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the company of the parent as default if we are creating a child partner.</span>
<span class="sd">        Also take the parent lang by default if any, otherwise, fallback to default DB lang.&quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">default_get</span><span class="p">(</span><span class="n">default_fields</span><span class="p">)</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;res.partner&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;parent_id&#39;</span> <span class="ow">in</span> <span class="n">default_fields</span> <span class="ow">and</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parent_id&#39;</span><span class="p">):</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parent_id&#39;</span><span class="p">))</span>
            <span class="n">values</span><span class="p">[</span><span class="s1">&#39;company_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">company_id</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="s1">&#39;lang&#39;</span> <span class="ow">in</span> <span class="n">default_fields</span><span class="p">:</span>
            <span class="n">values</span><span class="p">[</span><span class="s1">&#39;lang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">parent</span><span class="o">.</span><span class="n">lang</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span>
        <span class="c1"># protection for `default_type` values leaking from menu action context (e.g. for crm&#39;s email)</span>
        <span class="k">if</span> <span class="s1">&#39;type&#39;</span> <span class="ow">in</span> <span class="n">default_fields</span> <span class="ow">and</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">):</span>
                <span class="n">values</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">values</span></div>


    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default_export_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">complete_name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_complete_name&#39;</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;res.partner.title&#39;</span><span class="p">)</span>
    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;res.partner&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Related Company&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parent_name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">related</span><span class="o">=</span><span class="s1">&#39;parent_id.name&#39;</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Parent name&#39;</span><span class="p">)</span>
    <span class="n">child_ids</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">One2many</span><span class="p">(</span><span class="s1">&#39;res.partner&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_id&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Contact&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)])</span>
    <span class="n">ref</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Reference&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">lang</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Selection</span><span class="p">(</span><span class="n">_lang_get</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Language&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;All the emails and documents sent to this contact will be translated in this language.&quot;</span><span class="p">)</span>
    <span class="n">active_lang_count</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Integer</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_active_lang_count&#39;</span><span class="p">)</span>
    <span class="n">tz</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Selection</span><span class="p">(</span><span class="n">_tz_get</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Timezone&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tz&#39;</span><span class="p">),</span>
                          <span class="n">help</span><span class="o">=</span><span class="s2">&quot;When printing documents and exporting/importing data, time values are computed according to this timezone.</span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="s2">&quot;If the timezone is not set, UTC (Coordinated Universal Time) is used.</span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="s2">&quot;Anywhere else, time values are computed according to the time offset of your web client.&quot;</span><span class="p">)</span>

    <span class="n">tz_offset</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_tz_offset&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Timezone offset&#39;</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span>
        <span class="s1">&#39;res.users&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Salesperson&#39;</span><span class="p">,</span>
        <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_user_id&#39;</span><span class="p">,</span>
        <span class="n">precompute</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># avoid queries post-create</span>
        <span class="n">readonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The internal user in charge of this contact.&#39;</span><span class="p">)</span>
    <span class="n">vat</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Tax ID&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The Tax Identification Number. Values here will be validated based on the country format. You can use &#39;/&#39; to indicate that the partner is not subject to tax.&quot;</span><span class="p">)</span>
    <span class="n">same_vat_partner_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;res.partner&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Partner with same Tax ID&#39;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_same_vat_partner_id&#39;</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">same_company_registry_partner_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;res.partner&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Partner with same Company Registry&#39;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_same_vat_partner_id&#39;</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">company_registry</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s2">&quot;Company ID&quot;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_company_registry&#39;</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
       <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The registry number of the company. Use it if it is different from the Tax ID. It must be unique across all partners of a same country&quot;</span><span class="p">)</span>
    <span class="n">bank_ids</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">One2many</span><span class="p">(</span><span class="s1">&#39;res.partner.bank&#39;</span><span class="p">,</span> <span class="s1">&#39;partner_id&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Banks&#39;</span><span class="p">)</span>
    <span class="n">website</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="s1">&#39;Website Link&#39;</span><span class="p">)</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Html</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Notes&#39;</span><span class="p">)</span>

    <span class="n">category_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2many</span><span class="p">(</span><span class="s1">&#39;res.partner.category&#39;</span><span class="p">,</span> <span class="n">column1</span><span class="o">=</span><span class="s1">&#39;partner_id&#39;</span><span class="p">,</span>
                                    <span class="n">column2</span><span class="o">=</span><span class="s1">&#39;category_id&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Tags&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_default_category</span><span class="p">)</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">employee</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;Check this box if this contact is an Employee.&quot;</span><span class="p">)</span>
    <span class="n">function</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Job Position&#39;</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Selection</span><span class="p">(</span>
        <span class="p">[(</span><span class="s1">&#39;contact&#39;</span><span class="p">,</span> <span class="s1">&#39;Contact&#39;</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;invoice&#39;</span><span class="p">,</span> <span class="s1">&#39;Invoice Address&#39;</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;delivery&#39;</span><span class="p">,</span> <span class="s1">&#39;Delivery Address&#39;</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;other&#39;</span><span class="p">,</span> <span class="s1">&#39;Other Address&#39;</span><span class="p">),</span>
        <span class="p">],</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Address Type&#39;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;contact&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;- Contact: Use this to organize the contact details of employees of a given company (e.g. CEO, CFO, ...).</span><span class="se">\n</span><span class="s2">&quot;</span>
             <span class="s2">&quot;- Invoice Address: Preferred address for all invoices. Selected by default when you invoice an order that belongs to this company.</span><span class="se">\n</span><span class="s2">&quot;</span>
             <span class="s2">&quot;- Delivery Address: Preferred address for all deliveries. Selected by default when you deliver an order that belongs to this company.</span><span class="se">\n</span><span class="s2">&quot;</span>
             <span class="s2">&quot;- Other: Other address for the company (e.g. subsidiary, ...)&quot;</span><span class="p">)</span>
    <span class="c1"># address fields</span>
    <span class="n">street</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">()</span>
    <span class="n">street2</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">()</span>
    <span class="nb">zip</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">change_default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">city</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">()</span>
    <span class="n">state_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s2">&quot;res.country.state&quot;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;State&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;restrict&#39;</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="s2">&quot;[(&#39;country_id&#39;, &#39;=?&#39;, country_id)]&quot;</span><span class="p">)</span>
    <span class="n">country_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;res.country&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;restrict&#39;</span><span class="p">)</span>
    <span class="n">country_code</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">related</span><span class="o">=</span><span class="s1">&#39;country_id.code&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s2">&quot;Country Code&quot;</span><span class="p">)</span>
    <span class="n">partner_latitude</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Geo Latitude&#39;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="n">partner_longitude</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Geo Longitude&#39;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">()</span>
    <span class="n">email_formatted</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span>
        <span class="s1">&#39;Formatted Email&#39;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_email_formatted&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Format email address &quot;Name &lt;email@domain&gt;&quot;&#39;</span><span class="p">)</span>
    <span class="n">phone</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">unaccent</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">mobile</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">unaccent</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">is_company</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Is a Company&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Check if the contact is a company, otherwise it is a person&quot;</span><span class="p">)</span>
    <span class="n">is_public</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_is_public&#39;</span><span class="p">)</span>
    <span class="n">industry_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;res.partner.industry&#39;</span><span class="p">,</span> <span class="s1">&#39;Industry&#39;</span><span class="p">)</span>
    <span class="c1"># company_type is only an interface field, do not use it in business logic</span>
    <span class="n">company_type</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Selection</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Company Type&#39;</span><span class="p">,</span>
        <span class="n">selection</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="s1">&#39;Individual&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;company&#39;</span><span class="p">,</span> <span class="s1">&#39;Company&#39;</span><span class="p">)],</span>
        <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_company_type&#39;</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="s1">&#39;_write_company_type&#39;</span><span class="p">)</span>
    <span class="n">company_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;res.company&#39;</span><span class="p">,</span> <span class="s1">&#39;Company&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Integer</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Color Index&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">user_ids</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">One2many</span><span class="p">(</span><span class="s1">&#39;res.users&#39;</span><span class="p">,</span> <span class="s1">&#39;partner_id&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Users&#39;</span><span class="p">,</span> <span class="n">auto_join</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">partner_share</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span>
        <span class="s1">&#39;Share Partner&#39;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_partner_share&#39;</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Either customer (not a user), either shared user. Indicated the current partner is a customer without &quot;</span>
             <span class="s2">&quot;access or with a limited access created for sharing data.&quot;</span><span class="p">)</span>
    <span class="n">contact_address</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_contact_address&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Complete Address&#39;</span><span class="p">)</span>

    <span class="c1"># technical field used for managing commercial fields</span>
    <span class="n">commercial_partner_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span>
        <span class="s1">&#39;res.partner&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Commercial Entity&#39;</span><span class="p">,</span>
        <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_commercial_partner&#39;</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">commercial_company_name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="s1">&#39;Company Name Entity&#39;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_commercial_company_name&#39;</span><span class="p">,</span>
                                          <span class="n">store</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">company_name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="s1">&#39;Company Name&#39;</span><span class="p">)</span>
    <span class="n">barcode</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use a barcode to identify this contact.&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">company_dependent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># hack to allow using plain browse record in qweb views, and used in ir.qweb.field.contact</span>
    <span class="bp">self</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="n">comodel_name</span><span class="o">=</span><span class="n">_name</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_get_ids&#39;</span><span class="p">)</span>

    <span class="n">_sql_constraints</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;check_name&#39;</span><span class="p">,</span> <span class="s2">&quot;CHECK( (type=&#39;contact&#39; AND name IS NOT NULL) or (type!=&#39;contact&#39;) )&quot;</span><span class="p">,</span> <span class="s1">&#39;Contacts require a name&#39;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_street_split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">tools</span><span class="o">.</span><span class="n">street_split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">street</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;user_ids.share&#39;</span><span class="p">,</span> <span class="s1">&#39;image_1920&#39;</span><span class="p">,</span> <span class="s1">&#39;is_company&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_avatar_1920</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_compute_avatar_1920</span><span class="p">()</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;user_ids.share&#39;</span><span class="p">,</span> <span class="s1">&#39;image_1024&#39;</span><span class="p">,</span> <span class="s1">&#39;is_company&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_avatar_1024</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_compute_avatar_1024</span><span class="p">()</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;user_ids.share&#39;</span><span class="p">,</span> <span class="s1">&#39;image_512&#39;</span><span class="p">,</span> <span class="s1">&#39;is_company&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_avatar_512</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_compute_avatar_512</span><span class="p">()</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;user_ids.share&#39;</span><span class="p">,</span> <span class="s1">&#39;image_256&#39;</span><span class="p">,</span> <span class="s1">&#39;is_company&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_avatar_256</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_compute_avatar_256</span><span class="p">()</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;user_ids.share&#39;</span><span class="p">,</span> <span class="s1">&#39;image_128&#39;</span><span class="p">,</span> <span class="s1">&#39;is_company&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_avatar_128</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_compute_avatar_128</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compute_avatar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">avatar_field</span><span class="p">,</span> <span class="n">image_field</span><span class="p">):</span>
        <span class="n">partners_with_internal_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">partner</span><span class="p">:</span> <span class="n">partner</span><span class="o">.</span><span class="n">user_ids</span> <span class="o">-</span> <span class="n">partner</span><span class="o">.</span><span class="n">user_ids</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="s1">&#39;share&#39;</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Partner</span><span class="p">,</span> <span class="n">partners_with_internal_user</span><span class="p">)</span><span class="o">.</span><span class="n">_compute_avatar</span><span class="p">(</span><span class="n">avatar_field</span><span class="p">,</span> <span class="n">image_field</span><span class="p">)</span>
        <span class="n">partners_without_image</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span> <span class="o">-</span> <span class="n">partners_with_internal_user</span><span class="p">)</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="ow">not</span> <span class="n">p</span><span class="p">[</span><span class="n">image_field</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">tools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">partners_without_image</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">_avatar_get_placeholder_path</span><span class="p">()):</span>
            <span class="n">group_partners</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.partner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="o">*</span><span class="n">group</span><span class="p">)</span>
            <span class="n">group_partners</span><span class="p">[</span><span class="n">avatar_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">group_partners</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_avatar_get_placeholder</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="bp">self</span> <span class="o">-</span> <span class="n">partners_with_internal_user</span> <span class="o">-</span> <span class="n">partners_without_image</span><span class="p">:</span>
            <span class="n">partner</span><span class="p">[</span><span class="n">avatar_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">partner</span><span class="p">[</span><span class="n">image_field</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_avatar_get_placeholder_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_company</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;base/static/img/company_image.png&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;delivery&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;base/static/img/truck.png&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;invoice&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;base/static/img/money.png&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_avatar_get_placeholder_path</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_complete_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>

        <span class="n">displayed_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_complete_name_displayed_types</span>
        <span class="n">type_description</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_description_selection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">))</span>

        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">company_name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_id</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">displayed_types</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">type_description</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_company</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">commercial_company_name</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">parent_id</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;is_company&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_id.name&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;company_name&#39;</span><span class="p">,</span> <span class="s1">&#39;commercial_company_name&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_complete_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">partner</span><span class="o">.</span><span class="n">complete_name</span> <span class="o">=</span> <span class="n">partner</span><span class="o">.</span><span class="n">with_context</span><span class="p">({})</span><span class="o">.</span><span class="n">_get_complete_name</span><span class="p">()</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_active_lang_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lang_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.lang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_installed</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">partner</span><span class="o">.</span><span class="n">active_lang_count</span> <span class="o">=</span> <span class="n">lang_count</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;tz&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_tz_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">partner</span><span class="o">.</span><span class="n">tz_offset</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="n">partner</span><span class="o">.</span><span class="n">tz</span> <span class="ow">or</span> <span class="s1">&#39;GMT&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%z&#39;</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;parent_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_user_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Synchronize sales rep with parent if partner is a person &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">partner</span><span class="p">:</span> <span class="ow">not</span> <span class="n">partner</span><span class="o">.</span><span class="n">user_id</span> <span class="ow">and</span> <span class="n">partner</span><span class="o">.</span><span class="n">company_type</span> <span class="o">==</span> <span class="s1">&#39;person&#39;</span> <span class="ow">and</span> <span class="n">partner</span><span class="o">.</span><span class="n">parent_id</span><span class="o">.</span><span class="n">user_id</span><span class="p">):</span>
            <span class="n">partner</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">partner</span><span class="o">.</span><span class="n">parent_id</span><span class="o">.</span><span class="n">user_id</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;user_ids.share&#39;</span><span class="p">,</span> <span class="s1">&#39;user_ids.active&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_partner_share</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">super_partner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">SUPERUSER_ID</span><span class="p">)</span><span class="o">.</span><span class="n">partner_id</span>
        <span class="k">if</span> <span class="n">super_partner</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">super_partner</span><span class="o">.</span><span class="n">partner_share</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="bp">self</span> <span class="o">-</span> <span class="n">super_partner</span><span class="p">:</span>
            <span class="n">partner</span><span class="o">.</span><span class="n">partner_share</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">partner</span><span class="o">.</span><span class="n">user_ids</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">share</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">partner</span><span class="o">.</span><span class="n">user_ids</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;vat&#39;</span><span class="p">,</span> <span class="s1">&#39;company_id&#39;</span><span class="p">,</span> <span class="s1">&#39;company_registry&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_same_vat_partner_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="c1"># use _origin to deal with onchange()</span>
            <span class="n">partner_id</span> <span class="o">=</span> <span class="n">partner</span><span class="o">.</span><span class="n">_origin</span><span class="o">.</span><span class="n">id</span>
            <span class="c1">#active_test = False because if a partner has been deactivated you still want to raise the error,</span>
            <span class="c1">#so that you can reactivate it instead of creating a new one, which would loose its history.</span>
            <span class="n">Partner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;vat&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">partner</span><span class="o">.</span><span class="n">vat</span><span class="p">),</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">partner</span><span class="o">.</span><span class="n">company_id</span><span class="p">:</span>
                <span class="n">domain</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;company_id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="n">partner</span><span class="o">.</span><span class="n">company_id</span><span class="o">.</span><span class="n">id</span><span class="p">])]</span>
            <span class="k">if</span> <span class="n">partner_id</span><span class="p">:</span>
                <span class="n">domain</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;!=&#39;</span><span class="p">,</span> <span class="n">partner_id</span><span class="p">),</span> <span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;child_of&#39;</span><span class="p">,</span> <span class="n">partner_id</span><span class="p">)]</span>
            <span class="c1"># For VAT number being only one character, we will skip the check just like the regular check_vat</span>
            <span class="n">should_check_vat</span> <span class="o">=</span> <span class="n">partner</span><span class="o">.</span><span class="n">vat</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">partner</span><span class="o">.</span><span class="n">vat</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span>
            <span class="n">partner</span><span class="o">.</span><span class="n">same_vat_partner_id</span> <span class="o">=</span> <span class="n">should_check_vat</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">partner</span><span class="o">.</span><span class="n">parent_id</span> <span class="ow">and</span> <span class="n">Partner</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># check company_registry</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;company_registry&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">partner</span><span class="o">.</span><span class="n">company_registry</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;company_id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="n">partner</span><span class="o">.</span><span class="n">company_id</span><span class="o">.</span><span class="n">id</span><span class="p">]),</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">partner_id</span><span class="p">:</span>
                <span class="n">domain</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;!=&#39;</span><span class="p">,</span> <span class="n">partner_id</span><span class="p">),</span> <span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;child_of&#39;</span><span class="p">,</span> <span class="n">partner_id</span><span class="p">)]</span>
            <span class="n">partner</span><span class="o">.</span><span class="n">same_company_registry_partner_id</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">partner</span><span class="o">.</span><span class="n">company_registry</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">partner</span><span class="o">.</span><span class="n">parent_id</span> <span class="ow">and</span> <span class="n">Partner</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_display_address_depends</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">_compute_contact_address</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">partner</span><span class="o">.</span><span class="n">contact_address</span> <span class="o">=</span> <span class="n">partner</span><span class="o">.</span><span class="n">_display_address</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_compute_get_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">partner</span><span class="o">.</span><span class="n">self</span> <span class="o">=</span> <span class="n">partner</span><span class="o">.</span><span class="n">id</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;is_company&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_id.commercial_partner_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_commercial_partner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">partner</span><span class="o">.</span><span class="n">is_company</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">partner</span><span class="o">.</span><span class="n">parent_id</span><span class="p">:</span>
                <span class="n">partner</span><span class="o">.</span><span class="n">commercial_partner_id</span> <span class="o">=</span> <span class="n">partner</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">partner</span><span class="o">.</span><span class="n">commercial_partner_id</span> <span class="o">=</span> <span class="n">partner</span><span class="o">.</span><span class="n">parent_id</span><span class="o">.</span><span class="n">commercial_partner_id</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;company_name&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_id.is_company&#39;</span><span class="p">,</span> <span class="s1">&#39;commercial_partner_id.name&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_commercial_company_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">partner</span><span class="o">.</span><span class="n">commercial_partner_id</span>
            <span class="n">partner</span><span class="o">.</span><span class="n">commercial_company_name</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">is_company</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">partner</span><span class="o">.</span><span class="n">company_name</span>

    <span class="k">def</span> <span class="nf">_compute_company_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># exists to allow overrides</span>
        <span class="k">for</span> <span class="n">company</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">company</span><span class="o">.</span><span class="n">company_registry</span> <span class="o">=</span> <span class="n">company</span><span class="o">.</span><span class="n">company_registry</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">view_type</span><span class="o">=</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">arch</span><span class="p">,</span> <span class="n">view</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_view</span><span class="p">(</span><span class="n">view_id</span><span class="p">,</span> <span class="n">view_type</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="n">company</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span>
        <span class="k">if</span> <span class="n">company</span><span class="o">.</span><span class="n">country_id</span><span class="o">.</span><span class="n">vat_label</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">arch</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s2">&quot;//field[@name=&#39;vat&#39;]&quot;</span><span class="p">):</span>
                <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">company</span><span class="o">.</span><span class="n">country_id</span><span class="o">.</span><span class="n">vat_label</span>
        <span class="k">return</span> <span class="n">arch</span><span class="p">,</span> <span class="n">view</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="s1">&#39;parent_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_parent_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_recursion</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;You cannot create recursive Partner hierarchies.&#39;</span><span class="p">))</span>

<div class="viewcode-block" id="Partner.copy">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_partner.Partner.copy">[docs]</a>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="n">chosen_name</span> <span class="o">=</span> <span class="n">default</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">default</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">new_name</span> <span class="o">=</span> <span class="n">chosen_name</span> <span class="ow">or</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (copy)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">default</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">default</span> <span class="ow">or</span> <span class="p">{},</span> <span class="n">name</span><span class="o">=</span><span class="n">new_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Partner</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">default</span><span class="p">)</span></div>


<div class="viewcode-block" id="Partner.onchange_parent_id">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_partner.Partner.onchange_parent_id">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">onchange</span><span class="p">(</span><span class="s1">&#39;parent_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">onchange_parent_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># return values in result, as this method is used by _fields_sync()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_id</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">partner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_origin</span>
        <span class="k">if</span> <span class="n">partner</span><span class="o">.</span><span class="n">parent_id</span> <span class="ow">and</span> <span class="n">partner</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_id</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;warning&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Warning&#39;</span><span class="p">),</span>
                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Changing the company of a contact should only be done if it &#39;</span>
                             <span class="s1">&#39;was never correctly set. If an existing contact starts working for a new &#39;</span>
                             <span class="s1">&#39;company then a new contact should be created under that new &#39;</span>
                             <span class="s1">&#39;company. You can use the &quot;Discard&quot; button to abandon this change.&#39;</span><span class="p">)}</span>
        <span class="k">if</span> <span class="n">partner</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;contact&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;contact&#39;</span><span class="p">:</span>
            <span class="c1"># for contacts: copy the parent address, if set (aka, at least one</span>
            <span class="c1"># value is set in the address: otherwise, keep the one from the</span>
            <span class="c1"># contact)</span>
            <span class="n">address_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_address_fields</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_id</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">address_fields</span><span class="p">):</span>
                <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">BaseModel</span><span class="p">)</span> <span class="k">else</span> <span class="n">value</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_id</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">address_fields</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">onchange</span><span class="p">(</span><span class="s1">&#39;parent_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_onchange_parent_id_for_lang</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># While creating / updating child contact, take the parent lang by default if any</span>
        <span class="c1"># otherwise, fallback to default context / DB lang</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_id</span><span class="o">.</span><span class="n">lang</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_lang&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">onchange</span><span class="p">(</span><span class="s1">&#39;country_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_onchange_country_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">country_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">country_id</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_id</span><span class="o">.</span><span class="n">country_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_id</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">onchange</span><span class="p">(</span><span class="s1">&#39;state_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_onchange_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_id</span><span class="o">.</span><span class="n">country_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">country_id</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_id</span><span class="o">.</span><span class="n">country_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">country_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_id</span><span class="o">.</span><span class="n">country_id</span>

<div class="viewcode-block" id="Partner.onchange_email">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_partner.Partner.onchange_email">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">onchange</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">onchange_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_1920</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gravatar_image&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_1920</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gravatar_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">)</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">onchange</span><span class="p">(</span><span class="s1">&#39;parent_id&#39;</span><span class="p">,</span> <span class="s1">&#39;company_id&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_onchange_company_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">company_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_id</span><span class="o">.</span><span class="n">company_id</span><span class="o">.</span><span class="n">id</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_email_formatted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Compute formatted email for partner, using formataddr. Be defensive</span>
<span class="sd">        in computation, notably</span>

<span class="sd">          * double format: if email already holds a formatted email like</span>
<span class="sd">            &#39;Name&#39; &lt;email@domain.com&gt; we should not use it as it to compute</span>
<span class="sd">            email formatted like &quot;Name &lt;&#39;Name&#39; &lt;email@domain.com&gt;&gt;&quot;;</span>
<span class="sd">          * multi emails: sometimes this field is used to hold several addresses</span>
<span class="sd">            like email1@domain.com, email2@domain.com. We currently let this value</span>
<span class="sd">            untouched, but remove any formatting from multi emails;</span>
<span class="sd">          * invalid email: if something is wrong, keep it in email_formatted as</span>
<span class="sd">            this eases management and understanding of failures at mail.mail,</span>
<span class="sd">            mail.notification and mailing.trace level;</span>
<span class="sd">          * void email: email_formatted is False, as we cannot do anything with</span>
<span class="sd">            it;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email_formatted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">emails_normalized</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">email_normalize_all</span><span class="p">(</span><span class="n">partner</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">emails_normalized</span><span class="p">:</span>
                <span class="c1"># note: multi-email input leads to invalid email like &quot;Name&quot; &lt;email1, email2&gt;</span>
                <span class="c1"># but this is current behavior in Odoo 14+ and some servers allow it</span>
                <span class="n">partner</span><span class="o">.</span><span class="n">email_formatted</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">formataddr</span><span class="p">((</span>
                    <span class="n">partner</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="sa">u</span><span class="s2">&quot;False&quot;</span><span class="p">,</span>
                    <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">emails_normalized</span><span class="p">)</span>
                <span class="p">))</span>
            <span class="k">elif</span> <span class="n">partner</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
                <span class="n">partner</span><span class="o">.</span><span class="n">email_formatted</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">formataddr</span><span class="p">((</span>
                    <span class="n">partner</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="sa">u</span><span class="s2">&quot;False&quot;</span><span class="p">,</span>
                    <span class="n">partner</span><span class="o">.</span><span class="n">email</span>
                <span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;is_company&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_company_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">partner</span><span class="o">.</span><span class="n">company_type</span> <span class="o">=</span> <span class="s1">&#39;company&#39;</span> <span class="k">if</span> <span class="n">partner</span><span class="o">.</span><span class="n">is_company</span> <span class="k">else</span> <span class="s1">&#39;person&#39;</span>

    <span class="k">def</span> <span class="nf">_write_company_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">partner</span><span class="o">.</span><span class="n">is_company</span> <span class="o">=</span> <span class="n">partner</span><span class="o">.</span><span class="n">company_type</span> <span class="o">==</span> <span class="s1">&#39;company&#39;</span>

<div class="viewcode-block" id="Partner.onchange_company_type">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_partner.Partner.onchange_company_type">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">onchange</span><span class="p">(</span><span class="s1">&#39;company_type&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">onchange_company_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_company</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">company_type</span> <span class="o">==</span> <span class="s1">&#39;company&#39;</span><span class="p">)</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">constrains</span><span class="p">(</span><span class="s1">&#39;barcode&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_check_barcode_unicity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">partner</span><span class="o">.</span><span class="n">barcode</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.partner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search_count</span><span class="p">([(</span><span class="s1">&#39;barcode&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">partner</span><span class="o">.</span><span class="n">barcode</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Another partner already has this barcode&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_update_fields_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Returns dict of write() values for synchronizing ``fields`` &quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2one&#39;</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
            <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;one2many&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;One2Many fields cannot be synchronized as part of `commercial_fields` or `address fields`&#39;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2many&#39;</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span><span class="o">.</span><span class="n">ids</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">values</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_address_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the list of address fields that are synced from the parent.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">ADDRESS_FIELDS</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_formatting_address_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the list of address fields usable to format addresses.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_address_fields</span><span class="p">()</span>

<div class="viewcode-block" id="Partner.update_address">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_partner.Partner.update_address">[docs]</a>
    <span class="k">def</span> <span class="nf">update_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
        <span class="n">addr_vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_address_fields</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">addr_vals</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Partner</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">addr_vals</span><span class="p">)</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_commercial_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Returns the list of fields that are managed by the commercial entity</span>
<span class="sd">        to which a partner belongs. These fields are meant to be hidden on</span>
<span class="sd">        partners that aren&#39;t `commercial entities` themselves, and will be</span>
<span class="sd">        delegated to the parent `commercial entity`. The list is meant to be</span>
<span class="sd">        extended by inheriting classes. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;vat&#39;</span><span class="p">,</span> <span class="s1">&#39;company_registry&#39;</span><span class="p">,</span> <span class="s1">&#39;industry_id&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_commercial_sync_from_company</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Handle sync of commercial fields when a new parent commercial entity is set,</span>
<span class="sd">        as if they were related fields &quot;&quot;&quot;</span>
        <span class="n">commercial_partner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commercial_partner_id</span>
        <span class="k">if</span> <span class="n">commercial_partner</span> <span class="o">!=</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">sync_vals</span> <span class="o">=</span> <span class="n">commercial_partner</span><span class="o">.</span><span class="n">_update_fields_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_commercial_fields</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sync_vals</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_commercial_sync_to_children</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_commercial_sync_to_children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Handle sync of commercial fields to descendants &quot;&quot;&quot;</span>
        <span class="n">commercial_partner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commercial_partner_id</span>
        <span class="n">sync_vals</span> <span class="o">=</span> <span class="n">commercial_partner</span><span class="o">.</span><span class="n">_update_fields_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_commercial_fields</span><span class="p">())</span>
        <span class="n">sync_children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_ids</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">is_company</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">sync_children</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">_commercial_sync_to_children</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">sync_children</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sync_vals</span><span class="p">)</span>
        <span class="n">sync_children</span><span class="o">.</span><span class="n">_compute_commercial_partner</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">_fields_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Sync commercial fields and address fields from company and to children after create/update,</span>
<span class="sd">        just as if those were all modeled as fields.related to the parent &quot;&quot;&quot;</span>
        <span class="c1"># 1. From UPSTREAM: sync from parent</span>
        <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parent_id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;contact&#39;</span><span class="p">:</span>
            <span class="c1"># 1a. Commercial fields: sync if parent changed</span>
            <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parent_id&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">_commercial_sync_from_company</span><span class="p">()</span>
            <span class="c1"># 1b. Address fields: sync if parent or use_parent changed *and* both are now set</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;contact&#39;</span><span class="p">:</span>
                <span class="n">onchange_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onchange_parent_id</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_address</span><span class="p">(</span><span class="n">onchange_vals</span><span class="p">)</span>

        <span class="c1"># 2. To DOWNSTREAM: sync children</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_children_sync</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_children_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_ids</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># 2a. Commercial Fields: sync if commercial entity</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commercial_partner_id</span> <span class="o">==</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">commercial_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commercial_fields</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">field</span> <span class="ow">in</span> <span class="n">values</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">commercial_fields</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">_commercial_sync_to_children</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_ids</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">is_company</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">commercial_partner_id</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commercial_partner_id</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">_commercial_sync_to_children</span><span class="p">()</span>
                <span class="k">break</span>
        <span class="c1"># 2b. Address fields: sync if address changed</span>
        <span class="n">address_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_address_fields</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">field</span> <span class="ow">in</span> <span class="n">values</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">address_fields</span><span class="p">):</span>
            <span class="n">contacts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_ids</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;contact&#39;</span><span class="p">)</span>
            <span class="n">contacts</span><span class="o">.</span><span class="n">update_address</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_handle_first_contact_creation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; On creation of first contact for a company (or root) that has no address, assume contact address</span>
<span class="sd">        was meant to be company address &quot;&quot;&quot;</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_id</span>
        <span class="n">address_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_address_fields</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">is_company</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">parent</span><span class="o">.</span><span class="n">parent_id</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">child_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> \
            <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">address_fields</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">parent</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">address_fields</span><span class="p">):</span>
            <span class="n">addr_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_fields_values</span><span class="p">(</span><span class="n">address_fields</span><span class="p">)</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">update_address</span><span class="p">(</span><span class="n">addr_vals</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clean_website</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">website</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">urls</span><span class="o">.</span><span class="n">url_parse</span><span class="p">(</span><span class="n">website</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">scheme</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">netloc</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">netloc</span><span class="o">=</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">website</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;http&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_url</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">website</span>

    <span class="k">def</span> <span class="nf">_compute_is_public</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">users</span> <span class="o">=</span> <span class="n">partner</span><span class="o">.</span><span class="n">user_ids</span>
            <span class="n">partner</span><span class="o">.</span><span class="n">is_public</span> <span class="o">=</span> <span class="n">users</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">_is_public</span><span class="p">()</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">)</span>

<div class="viewcode-block" id="Partner.write">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_partner.Partner.write">[docs]</a>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># DLE: It should not be necessary to modify this to make work the ORM. The problem was just the recompute</span>
            <span class="c1"># of partner.user_ids when you create a new user for this partner, see test test_70_archive_internal_partners</span>
            <span class="c1"># You modified it in a previous commit, see original commit of this:</span>
            <span class="c1"># https://github.com/odoo/odoo/commit/9d7226371730e73c296bcc68eb1f856f82b0b4ed</span>
            <span class="c1">#</span>
            <span class="c1"># RCO: when creating a user for partner, the user is automatically added in partner.user_ids.</span>
            <span class="c1"># This is wrong if the user is not active, as partner.user_ids only returns active users.</span>
            <span class="c1"># Hence this temporary hack until the ORM updates inverse fields correctly.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">invalidate_recordset</span><span class="p">([</span><span class="s1">&#39;user_ids&#39;</span><span class="p">])</span>
            <span class="n">users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;partner_id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">users</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;write&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;You cannot archive contacts linked to an active user.</span><span class="se">\n</span><span class="s1">&#39;</span>
                                  <span class="s1">&#39;You first need to archive their associated user.</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                                  <span class="s1">&#39;Linked active users : </span><span class="si">%(names)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">u</span><span class="o">.</span><span class="n">display_name</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">users</span><span class="p">]))</span>
                    <span class="n">action_error</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">_action_show</span><span class="p">()</span>
                    <span class="k">raise</span> <span class="n">RedirectWarning</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">action_error</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Go to users&#39;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;You cannot archive contacts linked to an active user.</span><span class="se">\n</span><span class="s1">&#39;</span>
                                            <span class="s1">&#39;Ask an administrator to archive their associated user first.</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                                            <span class="s1">&#39;Linked active users :</span><span class="se">\n</span><span class="si">%(names)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">u</span><span class="o">.</span><span class="n">display_name</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">users</span><span class="p">])))</span>
        <span class="c1"># res.partner must only allow to set the company_id of a partner if it</span>
        <span class="c1"># is the same as the company of all users that inherit from this partner</span>
        <span class="c1"># (this is to allow the code from res_users to write to the partner!) or</span>
        <span class="c1"># if setting the company_id to False (this is compatible with any user</span>
        <span class="c1"># company)</span>
        <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;website&#39;</span><span class="p">):</span>
            <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;website&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_website</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s1">&#39;website&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parent_id&#39;</span><span class="p">):</span>
            <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;company_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;company_id&#39;</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
            <span class="n">company_id</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;company_id&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">company_id</span> <span class="ow">and</span> <span class="n">partner</span><span class="o">.</span><span class="n">user_ids</span><span class="p">:</span>
                    <span class="n">company</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">company_id</span><span class="p">)</span>
                    <span class="n">companies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">company_id</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">partner</span><span class="o">.</span><span class="n">user_ids</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">companies</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">company</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">companies</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span>
                            <span class="p">(</span><span class="s2">&quot;The selected company is not compatible with the companies of the related user(s)&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">partner</span><span class="o">.</span><span class="n">child_ids</span><span class="p">:</span>
                    <span class="n">partner</span><span class="o">.</span><span class="n">child_ids</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;company_id&#39;</span><span class="p">:</span> <span class="n">company_id</span><span class="p">})</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># To write in SUPERUSER on field is_company and avoid access rights problems.</span>
        <span class="k">if</span> <span class="s1">&#39;is_company&#39;</span> <span class="ow">in</span> <span class="n">vals</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_has_groups</span><span class="p">(</span><span class="s1">&#39;base.group_partner_manager&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">su</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Partner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">())</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;is_company&#39;</span><span class="p">:</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_company&#39;</span><span class="p">)})</span>
            <span class="k">del</span> <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;is_company&#39;</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="ow">and</span> <span class="nb">super</span><span class="p">(</span><span class="n">Partner</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">_is_internal</span><span class="p">()</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">partner</span><span class="o">.</span><span class="n">user_ids</span> <span class="k">if</span> <span class="n">u</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;write&#39;</span><span class="p">)</span>
            <span class="n">partner</span><span class="o">.</span><span class="n">_fields_sync</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="Partner.create">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_partner.Partner.create">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model_create_multi</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;import_file&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_import_consistency</span><span class="p">(</span><span class="n">vals_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">vals_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;website&#39;</span><span class="p">):</span>
                <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;website&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_website</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s1">&#39;website&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parent_id&#39;</span><span class="p">):</span>
                <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;company_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">partners</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Partner</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">vals_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_partners_skip_fields_sync&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">partners</span>

        <span class="k">for</span> <span class="n">partner</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">partners</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
            <span class="n">partner</span><span class="o">.</span><span class="n">_fields_sync</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
            <span class="c1"># Lang: propagate from parent if no value was given</span>
            <span class="k">if</span> <span class="s1">&#39;lang&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vals</span> <span class="ow">and</span> <span class="n">partner</span><span class="o">.</span><span class="n">parent_id</span><span class="p">:</span>
                <span class="n">partner</span><span class="o">.</span><span class="n">_onchange_parent_id_for_lang</span><span class="p">()</span>
            <span class="n">partner</span><span class="o">.</span><span class="n">_handle_first_contact_creation</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">partners</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">ondelete</span><span class="p">(</span><span class="n">at_uninstall</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_unlink_except_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">users</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;partner_id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">users</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># no linked user, operation is allowed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;write&#39;</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;You cannot delete contacts linked to an active user.</span><span class="se">\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39;You should rather archive them after archiving their associated user.</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                          <span class="s1">&#39;Linked active users : </span><span class="si">%(names)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">u</span><span class="o">.</span><span class="n">display_name</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">users</span><span class="p">]))</span>
            <span class="n">action_error</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">_action_show</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">RedirectWarning</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">action_error</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Go to users&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;You cannot delete contacts linked to an active user.</span><span class="se">\n</span><span class="s1">&#39;</span>
                                    <span class="s1">&#39;Ask an administrator to archive their associated user first.</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                                    <span class="s1">&#39;Linked active users :</span><span class="se">\n</span><span class="si">%(names)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">u</span><span class="o">.</span><span class="n">display_name</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">users</span><span class="p">])))</span>

    <span class="k">def</span> <span class="nf">_load_records_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
        <span class="n">partners</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Partner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">_partners_skip_fields_sync</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span><span class="o">.</span><span class="n">_load_records_create</span><span class="p">(</span><span class="n">vals_list</span><span class="p">)</span>

        <span class="c1"># batch up first part of _fields_sync</span>
        <span class="c1"># group partners by commercial_partner_id (if not self) and parent_id (if type == contact)</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">partner</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">partners</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
            <span class="n">cp_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parent_id&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">partner</span><span class="o">.</span><span class="n">commercial_partner_id</span> <span class="o">!=</span> <span class="n">partner</span><span class="p">:</span>
                <span class="n">cp_id</span> <span class="o">=</span> <span class="n">partner</span><span class="o">.</span><span class="n">commercial_partner_id</span><span class="o">.</span><span class="n">id</span>

            <span class="n">add_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">partner</span><span class="o">.</span><span class="n">parent_id</span> <span class="ow">and</span> <span class="n">partner</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;contact&#39;</span><span class="p">:</span>
                <span class="n">add_id</span> <span class="o">=</span> <span class="n">partner</span><span class="o">.</span><span class="n">parent_id</span><span class="o">.</span><span class="n">id</span>
            <span class="n">groups</span><span class="p">[(</span><span class="n">cp_id</span><span class="p">,</span> <span class="n">add_id</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">partner</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">cp_id</span><span class="p">,</span> <span class="n">add_id</span><span class="p">),</span> <span class="n">children</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># values from parents (commercial, regular) written to their common children</span>
            <span class="n">to_write</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># commercial fields from commercial partner</span>
            <span class="k">if</span> <span class="n">cp_id</span><span class="p">:</span>
                <span class="n">to_write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">cp_id</span><span class="p">)</span><span class="o">.</span><span class="n">_update_fields_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_commercial_fields</span><span class="p">())</span>
            <span class="c1"># address fields from parent</span>
            <span class="k">if</span> <span class="n">add_id</span><span class="p">:</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">add_id</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_address_fields</span><span class="p">():</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">parent</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">to_write</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">BaseModel</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span>
            <span class="k">if</span> <span class="n">to_write</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">children</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">to_write</span><span class="p">)</span>

        <span class="c1"># do the second half of _fields_sync the &quot;normal&quot; way</span>
        <span class="k">for</span> <span class="n">partner</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">partners</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
            <span class="n">partner</span><span class="o">.</span><span class="n">_children_sync</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
            <span class="n">partner</span><span class="o">.</span><span class="n">_handle_first_contact_creation</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">partners</span>

<div class="viewcode-block" id="Partner.create_company">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_partner.Partner.create_company">[docs]</a>
    <span class="k">def</span> <span class="nf">create_company</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">company_name</span><span class="p">:</span>
            <span class="c1"># Create parent company</span>
            <span class="n">values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">company_name</span><span class="p">,</span> <span class="n">is_company</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vat</span><span class="p">)</span>
            <span class="n">values</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_fields_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_address_fields</span><span class="p">()))</span>
            <span class="n">new_company</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="c1"># Set new company as my parent</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
                <span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="n">new_company</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;child_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">partner_id</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">parent_id</span><span class="o">=</span><span class="n">new_company</span><span class="o">.</span><span class="n">id</span><span class="p">))</span> <span class="k">for</span> <span class="n">partner_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">child_ids</span><span class="o">.</span><span class="n">ids</span><span class="p">]</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Partner.open_commercial_entity">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_partner.Partner.open_commercial_entity">[docs]</a>
    <span class="k">def</span> <span class="nf">open_commercial_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Utility method used to add an &quot;Open Company&quot; button in partner views &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.act_window&#39;</span><span class="p">,</span>
                <span class="s1">&#39;res_model&#39;</span><span class="p">:</span> <span class="s1">&#39;res.partner&#39;</span><span class="p">,</span>
                <span class="s1">&#39;view_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;form&#39;</span><span class="p">,</span>
                <span class="s1">&#39;res_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">commercial_partner_id</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;current&#39;</span><span class="p">,</span>
                <span class="p">}</span></div>


<div class="viewcode-block" id="Partner.open_parent">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_partner.Partner.open_parent">[docs]</a>
    <span class="k">def</span> <span class="nf">open_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Utility method used to add an &quot;Open Parent&quot; button in partner views &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="n">address_form_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.view_partner_address_form&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.act_window&#39;</span><span class="p">,</span>
                <span class="s1">&#39;res_model&#39;</span><span class="p">:</span> <span class="s1">&#39;res.partner&#39;</span><span class="p">,</span>
                <span class="s1">&#39;view_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;form&#39;</span><span class="p">,</span>
                <span class="s1">&#39;views&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="n">address_form_id</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">)],</span>
                <span class="s1">&#39;res_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_id</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span>
                <span class="p">}</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;complete_name&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;vat&#39;</span><span class="p">,</span> <span class="s1">&#39;state_id&#39;</span><span class="p">,</span> <span class="s1">&#39;country_id&#39;</span><span class="p">,</span> <span class="s1">&#39;commercial_company_name&#39;</span><span class="p">)</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">depends_context</span><span class="p">(</span><span class="s1">&#39;show_address&#39;</span><span class="p">,</span> <span class="s1">&#39;partner_show_db_id&#39;</span><span class="p">,</span> <span class="s1">&#39;address_inline&#39;</span><span class="p">,</span> <span class="s1">&#39;show_email&#39;</span><span class="p">,</span> <span class="s1">&#39;show_vat&#39;</span><span class="p">,</span> <span class="s1">&#39;lang&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_compute_display_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">partner</span><span class="o">.</span><span class="n">with_context</span><span class="p">({</span><span class="s1">&#39;lang&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span><span class="p">})</span><span class="o">.</span><span class="n">_get_complete_name</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">partner</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;show_address&#39;</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">partner</span><span class="o">.</span><span class="n">_display_address</span><span class="p">(</span><span class="n">without_company</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+\n&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">partner</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;partner_show_db_id&#39;</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">partner</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="k">if</span> <span class="n">partner</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;address_inline&#39;</span><span class="p">):</span>
                <span class="n">splitted_names</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">splitted_names</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">strip</span><span class="p">()])</span>
            <span class="k">if</span> <span class="n">partner</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;show_email&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">partner</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> &lt;</span><span class="si">{</span><span class="n">partner</span><span class="o">.</span><span class="n">email</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
            <span class="k">if</span> <span class="n">partner</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;show_vat&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">partner</span><span class="o">.</span><span class="n">vat</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">partner</span><span class="o">.</span><span class="n">vat</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">partner</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<div class="viewcode-block" id="Partner.name_create">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_partner.Partner.name_create">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">name_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Override of orm&#39;s name_create method for partners. The purpose is</span>
<span class="sd">            to handle some basic formats to create partners using the</span>
<span class="sd">            name_create.</span>
<span class="sd">            If only an email address is received and that the regex cannot find</span>
<span class="sd">            a name, the name will have the email value.</span>
<span class="sd">            If &#39;force_email&#39; key in context: must find the email address. &quot;&quot;&quot;</span>
        <span class="n">default_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_type&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">default_type</span> <span class="ow">and</span> <span class="n">default_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">):</span>
            <span class="n">context</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;default_type&#39;</span><span class="p">)</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">email_normalized</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">parse_contact_from_email</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;force_email&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">email_normalized</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t create contact without email address!&quot;</span><span class="p">))</span>

        <span class="n">create_values</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">:</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">email_normalized</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">email_normalized</span><span class="p">:</span>  <span class="c1"># keep default_email in context</span>
            <span class="n">create_values</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email_normalized</span>
        <span class="n">partner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">create_values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">partner</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">partner</span><span class="o">.</span><span class="n">display_name</span></div>


<div class="viewcode-block" id="Partner.find_or_create">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_partner.Partner.find_or_create">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">returns</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">find_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">assert_valid_email</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Find a partner with the given ``email`` or use :py:method:`~.name_create`</span>
<span class="sd">        to create a new one.</span>

<span class="sd">        :param str email: email-like string, which should contain at least one email,</span>
<span class="sd">            e.g. ``&quot;Raoul Grosbedon &lt;r.g@grosbedon.fr&gt;&quot;``</span>
<span class="sd">        :param boolean assert_valid_email: raise if no valid email is found</span>
<span class="sd">        :return: newly created record</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;An email is required for find_or_create to work&#39;</span><span class="p">))</span>

        <span class="n">parsed_name</span><span class="p">,</span> <span class="n">parsed_email_normalized</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">parse_contact_from_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parsed_email_normalized</span> <span class="ow">and</span> <span class="n">assert_valid_email</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;A valid email is required for find_or_create to work properly.&#39;</span><span class="p">))</span>

        <span class="n">partners</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;=ilike&#39;</span><span class="p">,</span> <span class="n">parsed_email_normalized</span><span class="p">)],</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">partners</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">partners</span>

        <span class="n">create_values</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">:</span> <span class="n">parsed_name</span> <span class="ow">or</span> <span class="n">parsed_email_normalized</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">parsed_email_normalized</span><span class="p">:</span>  <span class="c1"># keep default_email in context</span>
            <span class="n">create_values</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parsed_email_normalized</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">create_values</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_get_gravatar_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="n">email_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://www.gravatar.com/avatar/&quot;</span> <span class="o">+</span> <span class="n">email_hash</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="s1">&#39;404&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="s1">&#39;128&#39;</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_email_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email_from</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">on_error</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Partner._email_send has not done anything but raise errors since 15.0&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="Partner.address_get">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_partner.Partner.address_get">[docs]</a>
    <span class="k">def</span> <span class="nf">address_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adr_pref</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Find contacts/addresses of the right type(s) by doing a depth-first-search</span>
<span class="sd">        through descendants within company boundaries (stop at entities flagged ``is_company``)</span>
<span class="sd">        then continuing the search at the ancestors that are within the same company boundaries.</span>
<span class="sd">        Defaults to partners of type ``&#39;default&#39;`` when the exact type is not found, or to the</span>
<span class="sd">        provided partner itself if no type ``&#39;default&#39;`` is found either. &quot;&quot;&quot;</span>
        <span class="n">adr_pref</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">adr_pref</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="s1">&#39;contact&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adr_pref</span><span class="p">:</span>
            <span class="n">adr_pref</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;contact&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">current_partner</span> <span class="o">=</span> <span class="n">partner</span>
            <span class="k">while</span> <span class="n">current_partner</span><span class="p">:</span>
                <span class="n">to_scan</span> <span class="o">=</span> <span class="p">[</span><span class="n">current_partner</span><span class="p">]</span>
                <span class="c1"># Scan descendants, DFS</span>
                <span class="k">while</span> <span class="n">to_scan</span><span class="p">:</span>
                    <span class="n">record</span> <span class="o">=</span> <span class="n">to_scan</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="n">adr_pref</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">type</span><span class="p">):</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">adr_pref</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">result</span>
                    <span class="n">to_scan</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">child_ids</span>
                                 <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span>
                                 <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">is_company</span><span class="p">]</span> <span class="o">+</span> <span class="n">to_scan</span>

                <span class="c1"># Continue scanning at ancestor if current_partner is not a commercial entity</span>
                <span class="k">if</span> <span class="n">current_partner</span><span class="o">.</span><span class="n">is_company</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">current_partner</span><span class="o">.</span><span class="n">parent_id</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">current_partner</span> <span class="o">=</span> <span class="n">current_partner</span><span class="o">.</span><span class="n">parent_id</span>

        <span class="c1"># default to type &#39;contact&#39; or the partner itself</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;contact&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">or</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">adr_type</span> <span class="ow">in</span> <span class="n">adr_pref</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">adr_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">adr_type</span><span class="p">)</span> <span class="ow">or</span> <span class="n">default</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="Partner.view_header_get">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_partner.Partner.view_header_get">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">view_header_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_id</span><span class="p">,</span> <span class="n">view_type</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;category_id&#39;</span><span class="p">):</span>
            <span class="k">return</span>  <span class="n">_</span><span class="p">(</span>
                <span class="s1">&#39;Partners: </span><span class="si">%(category)s</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.partner.category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;category_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">view_header_get</span><span class="p">(</span><span class="n">view_id</span><span class="p">,</span> <span class="n">view_type</span><span class="p">)</span></div>


<div class="viewcode-block" id="Partner.main_partner">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_partner.Partner.main_partner">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">returns</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">main_partner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Return the main partner &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.main_partner&#39;</span><span class="p">)</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_default_address_format</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%(street)s</span><span class="se">\n</span><span class="si">%(street2)s</span><span class="se">\n</span><span class="si">%(city)s</span><span class="s2"> </span><span class="si">%(state_code)s</span><span class="s2"> </span><span class="si">%(zip)s</span><span class="se">\n</span><span class="si">%(country_name)s</span><span class="s2">&quot;</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_address_format</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">country_id</span><span class="o">.</span><span class="n">address_format</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_address_format</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_prepare_display_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">without_company</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># get the information that will be injected into the display format</span>
        <span class="c1"># get the address format</span>
        <span class="n">address_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_address_format</span><span class="p">()</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;state_code&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_id</span><span class="o">.</span><span class="n">code</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;state_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_id</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;country_code&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">country_id</span><span class="o">.</span><span class="n">code</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;country_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_country_name</span><span class="p">(),</span>
            <span class="s1">&#39;company_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">commercial_company_name</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formatting_address_fields</span><span class="p">():</span>
            <span class="n">args</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">without_company</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;company_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">commercial_company_name</span><span class="p">:</span>
            <span class="n">address_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(company_name)s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">address_format</span>
        <span class="k">return</span> <span class="n">address_format</span><span class="p">,</span> <span class="n">args</span>

    <span class="k">def</span> <span class="nf">_display_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">without_company</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        The purpose of this function is to build and return an address formatted accordingly to the</span>
<span class="sd">        standards of the country where it belongs.</span>

<span class="sd">        :param without_company: if address contains company</span>
<span class="sd">        :returns: the address formatted in a display that fit its country habits (or the default ones</span>
<span class="sd">            if not country is specified)</span>
<span class="sd">        :rtype: string</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">address_format</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_display_address</span><span class="p">(</span><span class="n">without_company</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">address_format</span> <span class="o">%</span> <span class="n">args</span>

    <span class="k">def</span> <span class="nf">_display_address_depends</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># field dependencies of method _display_address()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_formatting_address_fields</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span>
            <span class="s1">&#39;country_id&#39;</span><span class="p">,</span> <span class="s1">&#39;company_name&#39;</span><span class="p">,</span> <span class="s1">&#39;state_id&#39;</span><span class="p">,</span>
        <span class="p">]</span>

<div class="viewcode-block" id="Partner.get_import_templates">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_partner.Partner.get_import_templates">[docs]</a>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">get_import_templates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[{</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Import Template for Customers&#39;</span><span class="p">),</span>
            <span class="s1">&#39;template&#39;</span><span class="p">:</span> <span class="s1">&#39;/base/static/xls/res_partner.xlsx&#39;</span>
        <span class="p">}]</span></div>


    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_check_import_consistency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The values created by an import are generated by a name search, field by field.</span>
<span class="sd">        As a result there is no check that the field values are consistent with each others.</span>
<span class="sd">        We check that if the state is given a value, it does belong to the given country, or we remove it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">States</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.country.state&#39;</span><span class="p">]</span>
        <span class="n">states_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">vals</span><span class="p">[</span><span class="s1">&#39;state_id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">vals_list</span> <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state_id&#39;</span><span class="p">)}</span>
        <span class="n">state_to_country</span> <span class="o">=</span> <span class="n">States</span><span class="o">.</span><span class="n">search_read</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">states_ids</span><span class="p">))],</span> <span class="p">[</span><span class="s1">&#39;country_id&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">vals_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state_id&#39;</span><span class="p">):</span>
                <span class="n">country_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;country_id&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">state_to_country</span> <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state_id&#39;</span><span class="p">))</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">States</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s1">&#39;state_id&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">country_id</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">country_id</span><span class="p">:</span>
                    <span class="n">state_domain</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">code</span><span class="p">),</span>
                                    <span class="p">(</span><span class="s1">&#39;country_id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">country_id</span><span class="p">)]</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">States</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">state_domain</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;state_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">id</span>  <span class="c1"># replace state or remove it if not found</span>

    <span class="k">def</span> <span class="nf">_get_country_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">country_id</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span></div>




<div class="viewcode-block" id="ResPartnerIndustry">
<a class="viewcode-back" href="../../../../../odoo.addons.base.models.html#odoo.addons.base.models.res_partner.ResPartnerIndustry">[docs]</a>
<span class="k">class</span> <span class="nc">ResPartnerIndustry</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="s1">&#39;Industry&#39;</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s2">&quot;res.partner.industry&quot;</span>
    <span class="n">_order</span> <span class="o">=</span> <span class="s2">&quot;name&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="n">translate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">full_name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="s1">&#39;Full Name&#39;</span><span class="p">,</span> <span class="n">translate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(</span><span class="s1">&#39;Active&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Amr.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>