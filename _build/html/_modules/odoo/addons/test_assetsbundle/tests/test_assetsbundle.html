<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>odoo.addons.test_assetsbundle.tests.test_assetsbundle &mdash; Amr  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Amr
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modules.html">odoo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Amr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../../odoo.html">odoo</a></li>
      <li class="breadcrumb-item active">odoo.addons.test_assetsbundle.tests.test_assetsbundle</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for odoo.addons.test_assetsbundle.tests.test_assetsbundle</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># Part of Odoo. See LICENSE file for full copyright and licensing details.</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">skip</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">patch</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">lxml</span>
<span class="kn">import</span> <span class="nn">base64</span>

<span class="kn">import</span> <span class="nn">odoo</span>
<span class="kn">from</span> <span class="nn">odoo</span> <span class="kn">import</span> <span class="n">api</span><span class="p">,</span> <span class="n">http</span>
<span class="kn">from</span> <span class="nn">odoo.addons</span> <span class="kn">import</span> <span class="n">__path__</span> <span class="k">as</span> <span class="n">ADDONS_PATH</span>
<span class="kn">from</span> <span class="nn">odoo.addons.base.models.assetsbundle</span> <span class="kn">import</span> <span class="n">AssetsBundle</span><span class="p">,</span> <span class="n">ANY_UNIQUE</span>
<span class="kn">from</span> <span class="nn">odoo.addons.base.models.ir_asset</span> <span class="kn">import</span> <span class="n">AssetPaths</span>
<span class="kn">from</span> <span class="nn">odoo.addons.base.models.ir_attachment</span> <span class="kn">import</span> <span class="n">IrAttachment</span>
<span class="kn">from</span> <span class="nn">odoo.modules.module</span> <span class="kn">import</span> <span class="n">get_manifest</span>
<span class="kn">from</span> <span class="nn">odoo.tests</span> <span class="kn">import</span> <span class="n">HttpCase</span><span class="p">,</span> <span class="n">tagged</span>
<span class="kn">from</span> <span class="nn">odoo.tests.common</span> <span class="kn">import</span> <span class="n">TransactionCase</span>
<span class="kn">from</span> <span class="nn">odoo.addons.base.models.ir_qweb</span> <span class="kn">import</span> <span class="n">QWebException</span>
<span class="kn">from</span> <span class="nn">odoo.tools</span> <span class="kn">import</span> <span class="n">mute_logger</span><span class="p">,</span> <span class="n">func</span>
<span class="kn">from</span> <span class="nn">odoo.tools.misc</span> <span class="kn">import</span> <span class="n">file_path</span>

<span class="n">GETMTINE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span>

<span class="c1"># ruff: noqa: S320</span>

<div class="viewcode-block" id="TestAddonPaths">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAddonPaths">[docs]</a>
<span class="k">class</span> <span class="nc">TestAddonPaths</span><span class="p">(</span><span class="n">TransactionCase</span><span class="p">):</span>
<div class="viewcode-block" id="TestAddonPaths.test_operations">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAddonPaths.test_operations">[docs]</a>
    <span class="k">def</span> <span class="nf">test_operations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">asset_paths</span> <span class="o">=</span> <span class="n">AssetPaths</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">asset_paths</span><span class="o">.</span><span class="n">list</span><span class="p">)</span>

        <span class="n">asset_paths</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/a&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/a&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/c&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/c&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/d&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/d&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">],</span> <span class="s1">&#39;bundle1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">asset_paths</span><span class="o">.</span><span class="n">list</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/a&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/a&#39;</span><span class="p">,</span> <span class="s1">&#39;bundle1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/c&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/c&#39;</span><span class="p">,</span> <span class="s1">&#39;bundle1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/d&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/d&#39;</span><span class="p">,</span> <span class="s1">&#39;bundle1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="c1"># append with a duplicate of &#39;c&#39;</span>
        <span class="n">asset_paths</span><span class="o">.</span><span class="n">append</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/c&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/c&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/f&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/f&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">],</span> <span class="s1">&#39;bundle2&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">asset_paths</span><span class="o">.</span><span class="n">list</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/a&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/a&#39;</span><span class="p">,</span> <span class="s1">&#39;bundle1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/c&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/c&#39;</span><span class="p">,</span> <span class="s1">&#39;bundle1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/d&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/d&#39;</span><span class="p">,</span> <span class="s1">&#39;bundle1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/f&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/f&#39;</span><span class="p">,</span> <span class="s1">&#39;bundle2&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="c1"># insert with a duplicate of &#39;c&#39; after &#39;c&#39;</span>
        <span class="n">asset_paths</span><span class="o">.</span><span class="n">insert</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/c&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/c&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/e&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/e&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">],</span> <span class="s1">&#39;bundle3&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">asset_paths</span><span class="o">.</span><span class="n">list</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/a&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/a&#39;</span><span class="p">,</span> <span class="s1">&#39;bundle1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/c&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/c&#39;</span><span class="p">,</span> <span class="s1">&#39;bundle1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/d&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/d&#39;</span><span class="p">,</span> <span class="s1">&#39;bundle1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/e&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/e&#39;</span><span class="p">,</span> <span class="s1">&#39;bundle3&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/f&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/f&#39;</span><span class="p">,</span> <span class="s1">&#39;bundle2&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="c1"># insert with a duplicate of &#39;d&#39; before &#39;d&#39;</span>
        <span class="n">asset_paths</span><span class="o">.</span><span class="n">insert</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/b&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/b&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/d&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/d&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">],</span> <span class="s1">&#39;bundle4&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">asset_paths</span><span class="o">.</span><span class="n">list</span><span class="p">,</span> <span class="p">[</span>

            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/a&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/a&#39;</span><span class="p">,</span> <span class="s1">&#39;bundle1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/b&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/b&#39;</span><span class="p">,</span> <span class="s1">&#39;bundle4&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/c&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/c&#39;</span><span class="p">,</span> <span class="s1">&#39;bundle1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/d&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/d&#39;</span><span class="p">,</span> <span class="s1">&#39;bundle1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/e&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/e&#39;</span><span class="p">,</span> <span class="s1">&#39;bundle3&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/f&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/f&#39;</span><span class="p">,</span> <span class="s1">&#39;bundle2&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="c1"># remove</span>
        <span class="n">asset_paths</span><span class="o">.</span><span class="n">remove</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/c&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/c&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/d&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/d&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/g&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/g&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">],</span> <span class="s1">&#39;bundle5&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">asset_paths</span><span class="o">.</span><span class="n">list</span><span class="p">,</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/a&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/a&#39;</span><span class="p">,</span> <span class="s1">&#39;bundle1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/b&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/b&#39;</span><span class="p">,</span> <span class="s1">&#39;bundle4&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/e&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/e&#39;</span><span class="p">,</span> <span class="s1">&#39;bundle3&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;/home/user/odoo/addons/web/f&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/f&#39;</span><span class="p">,</span> <span class="s1">&#39;bundle2&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">])</span></div>
</div>



<div class="viewcode-block" id="AddonManifestPatched">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.AddonManifestPatched">[docs]</a>
<span class="k">class</span> <span class="nc">AddonManifestPatched</span><span class="p">(</span><span class="n">TransactionCase</span><span class="p">):</span>
<div class="viewcode-block" id="AddonManifestPatched.setUp">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.AddonManifestPatched.setUp">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">installed_modules</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="s1">&#39;test_assetsbundle&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manifests</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;base&#39;</span><span class="p">:</span> <span class="n">get_manifest</span><span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="p">),</span>
            <span class="s1">&#39;web&#39;</span><span class="p">:</span> <span class="n">get_manifest</span><span class="p">(</span><span class="s1">&#39;web&#39;</span><span class="p">),</span>
            <span class="s1">&#39;test_assetsbundle&#39;</span><span class="p">:</span> <span class="n">get_manifest</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle&#39;</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="p">,</span> <span class="s1">&#39;_init_modules&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">installed_modules</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">odoo</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;_get_manifest_cached&#39;</span><span class="p">,</span> <span class="n">Mock</span><span class="p">(</span><span class="n">side_effect</span><span class="o">=</span><span class="k">lambda</span> <span class="n">module</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">manifests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="p">{})))</span></div>
</div>



<div class="viewcode-block" id="FileTouchable">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.FileTouchable">[docs]</a>
<span class="k">class</span> <span class="nc">FileTouchable</span><span class="p">(</span><span class="n">AddonManifestPatched</span><span class="p">):</span>
<div class="viewcode-block" id="FileTouchable.setUp">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.FileTouchable.setUp">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FileTouchable</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">touches</span> <span class="o">=</span> <span class="p">{}</span></div>


    <span class="k">def</span> <span class="nf">_touch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">touch_time</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">touches</span><span class="p">[</span><span class="n">filepath</span><span class="p">]</span> <span class="o">=</span> <span class="n">touch_time</span> <span class="ow">or</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;os.path.getmtime&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">filename</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">touches</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">or</span> <span class="n">GETMTINE</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span></div>



<div class="viewcode-block" id="TestJavascriptAssetsBundle">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestJavascriptAssetsBundle">[docs]</a>
<span class="k">class</span> <span class="nc">TestJavascriptAssetsBundle</span><span class="p">(</span><span class="n">FileTouchable</span><span class="p">):</span>
<div class="viewcode-block" id="TestJavascriptAssetsBundle.setUpClass">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestJavascriptAssetsBundle.setUpClass">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUpClass</span><span class="p">()</span>
        <span class="c1"># this is mainly to avoid tests breaking when executed after pre-generate</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">maxDiff</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.attachment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;=like&#39;</span><span class="p">,</span> <span class="s1">&#39;/web/assets/%test_assetsbundle%&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>


<div class="viewcode-block" id="TestJavascriptAssetsBundle.setUp">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestJavascriptAssetsBundle.setUp">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestJavascriptAssetsBundle</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jsbundle_name</span> <span class="o">=</span> <span class="s1">&#39;test_assetsbundle.bundle1&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span> <span class="o">=</span> <span class="s1">&#39;test_assetsbundle.bundle2&#39;</span></div>


    <span class="k">def</span> <span class="nf">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">files</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_content</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">AssetsBundle</span><span class="p">(</span><span class="n">bundle</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="n">debug_assets</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="n">rtl</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_any_ira_for_bundle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extension</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Returns all ir.attachments associated to a bundle, regardless of the verion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jsbundle_name</span> <span class="k">if</span> <span class="n">extension</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;js&#39;</span><span class="p">,</span> <span class="s1">&#39;min.js&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;.rtl&#39;</span> <span class="k">if</span> <span class="n">rtl</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">bundle_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bundle</span><span class="si">}{</span><span class="n">direction</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle_url</span><span class="p">(</span><span class="n">bundle_name</span><span class="p">,</span> <span class="n">ANY_UNIQUE</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;=like&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.attachment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>

<div class="viewcode-block" id="TestJavascriptAssetsBundle.test_01_generation">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestJavascriptAssetsBundle.test_01_generation">[docs]</a>
    <span class="k">def</span> <span class="nf">test_01_generation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checks that a bundle creates an ir.attachment record when its `js` method is called</span>
<span class="sd">        for the first time and this ir.attachment is different depending on `is_minified` param.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jsbundle_name</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># there shouldn&#39;t be any minified attachment associated to this bundle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.js&#39;</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="s2">&quot;there shouldn&#39;t be any minified attachment associated to this bundle&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bundle</span><span class="o">.</span><span class="n">get_attachments</span><span class="p">(</span><span class="s1">&#39;min.js&#39;</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="s2">&quot;there shouldn&#39;t be any minified attachment associated to this bundle&quot;</span><span class="p">)</span>

        <span class="c1"># trigger the first generation and, thus, the first save in database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>

        <span class="c1"># there should be one minified attachment associated to this bundle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.js&#39;</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="s2">&quot;there should be one minified attachment associated to this bundle&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bundle</span><span class="o">.</span><span class="n">get_attachments</span><span class="p">(</span><span class="s1">&#39;min.js&#39;</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="s2">&quot;there should be one minified attachment associated to this bundle&quot;</span><span class="p">)</span>

        <span class="c1"># there shouldn&#39;t be any non-minified attachment associated to this bundle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;js&#39;</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="s2">&quot;there shouldn&#39;t be any non-minified attachment associated to this bundle&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bundle</span><span class="o">.</span><span class="n">get_attachments</span><span class="p">(</span><span class="s1">&#39;js&#39;</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="s2">&quot;there shouldn&#39;t be any non-minified attachment associated to this bundle&quot;</span><span class="p">)</span>

        <span class="c1"># trigger the first generation and, thus, the first save in database for the non-minified version.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bundle_debug</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jsbundle_name</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bundle_debug</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>

        <span class="c1"># there should be one non-minified attachment associated to this bundle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;js&#39;</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="s2">&quot;there should be one non-minified attachment associated to this bundle&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bundle</span><span class="o">.</span><span class="n">get_attachments</span><span class="p">(</span><span class="s1">&#39;js&#39;</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="s2">&quot;there should be one non-minified attachment associated to this bundle&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestJavascriptAssetsBundle.test_02_access">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestJavascriptAssetsBundle.test_02_access">[docs]</a>
    <span class="k">def</span> <span class="nf">test_02_access</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checks that the bundle&#39;s cache is working, i.e. that the bundle creates only one</span>
<span class="sd">        ir.attachment record when rendered multiple times.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bundle0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jsbundle_name</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">bundle0</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.js&#39;</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="s2">&quot;there should be one minified attachment associated to this bundle&quot;</span><span class="p">)</span>

        <span class="n">version0</span> <span class="o">=</span> <span class="n">bundle0</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="s1">&#39;js&#39;</span><span class="p">)</span>
        <span class="n">ira0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.js&#39;</span><span class="p">)</span>
        <span class="n">date0</span> <span class="o">=</span> <span class="n">ira0</span><span class="o">.</span><span class="n">create_date</span>

        <span class="n">bundle1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jsbundle_name</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">bundle1</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.js&#39;</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="s2">&quot;there should be one minified attachment associated to this bundle&quot;</span><span class="p">)</span>

        <span class="n">version1</span> <span class="o">=</span> <span class="n">bundle1</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="s1">&#39;js&#39;</span><span class="p">)</span>
        <span class="n">ira1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.js&#39;</span><span class="p">)</span>
        <span class="n">date1</span> <span class="o">=</span> <span class="n">ira1</span><span class="o">.</span><span class="n">create_date</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">version0</span><span class="p">,</span> <span class="n">version1</span><span class="p">,</span>
                         <span class="s2">&quot;the version should not be changed because the bundle hasn&#39;t changed&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">date0</span><span class="p">,</span> <span class="n">date1</span><span class="p">,</span>
                         <span class="s2">&quot;the date of creation of the ir.attachment should not change because the bundle is unchanged&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestJavascriptAssetsBundle.test_03_date_invalidation">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestJavascriptAssetsBundle.test_03_date_invalidation">[docs]</a>
    <span class="k">def</span> <span class="nf">test_03_date_invalidation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checks that a bundle is invalidated when one of its assets&#39; modification date is changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bundle0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jsbundle_name</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">bundle0</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">last_modified0</span> <span class="o">=</span> <span class="n">bundle0</span><span class="o">.</span><span class="n">get_checksum</span><span class="p">(</span><span class="s1">&#39;js&#39;</span><span class="p">)</span>
        <span class="n">version0</span> <span class="o">=</span> <span class="n">bundle0</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="s1">&#39;js&#39;</span><span class="p">)</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle/static/src/js/test_jsfile1.js&#39;</span><span class="p">)</span>
        <span class="n">bundle1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jsbundle_name</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_touch</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">bundle1</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
            <span class="n">last_modified1</span> <span class="o">=</span> <span class="n">bundle1</span><span class="o">.</span><span class="n">get_checksum</span><span class="p">(</span><span class="s1">&#39;js&#39;</span><span class="p">)</span>
            <span class="n">version1</span> <span class="o">=</span> <span class="n">bundle1</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="s1">&#39;js&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">last_modified0</span><span class="p">,</span> <span class="n">last_modified1</span><span class="p">,</span>
                                <span class="s2">&quot;the creation date of the ir.attachment should change because the bundle has changed.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">version0</span><span class="p">,</span> <span class="n">version1</span><span class="p">,</span>
                                <span class="s2">&quot;the version must should because the bundle has changed.&quot;</span><span class="p">)</span>

            <span class="c1"># check if the previous attachment is correctly cleaned</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;js&#39;</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span>
                             <span class="s2">&quot;there should be one minified attachment associated to this bundle&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestJavascriptAssetsBundle.test_04_content_invalidation">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestJavascriptAssetsBundle.test_04_content_invalidation">[docs]</a>
    <span class="k">def</span> <span class="nf">test_04_content_invalidation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checks that a bundle is invalidated when its content is modified by adding a file to</span>
<span class="sd">        source.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bundle0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jsbundle_name</span><span class="p">)</span>
        <span class="n">bundle0</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">files0</span> <span class="o">=</span> <span class="n">bundle0</span><span class="o">.</span><span class="n">files</span>
        <span class="n">version0</span> <span class="o">=</span> <span class="n">bundle0</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="s1">&#39;js&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.js&#39;</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="s2">&quot;there should be one minified attachment associated to this bundle&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test bundle inheritance&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">jsbundle_name</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle/static/src/js/test_jsfile4.js&#39;</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="n">bundle1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jsbundle_name</span><span class="p">)</span>
        <span class="n">bundle1</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">files1</span> <span class="o">=</span> <span class="n">bundle1</span><span class="o">.</span><span class="n">files</span>
        <span class="n">version1</span> <span class="o">=</span> <span class="n">bundle1</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="s1">&#39;js&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">files0</span><span class="p">,</span> <span class="n">files1</span><span class="p">,</span>
                            <span class="s2">&quot;the list of files should be different because a file has been added to the bundle&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">version0</span><span class="p">,</span> <span class="n">version1</span><span class="p">,</span>
                            <span class="s2">&quot;the version should be different because a file has been added to the bundle&quot;</span><span class="p">)</span>

        <span class="c1"># check if the previous attachment are correctly cleaned</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.js&#39;</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="s2">&quot;there should be one minified attachment associated to this bundle&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestJavascriptAssetsBundle.test_05_normal_mode">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestJavascriptAssetsBundle.test_05_normal_mode">[docs]</a>
    <span class="k">def</span> <span class="nf">test_05_normal_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checks that a bundle rendered in normal mode outputs minified assets</span>
<span class="sd">            and create a minified ir.attachment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">debug_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jsbundle_name</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">debug_bundle</span><span class="o">.</span><span class="n">get_links</span><span class="p">()</span>
        <span class="n">debug_bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="c1"># there should be a minified file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.bundle1.min.js&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># there should be one minified assets created in normal mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.js&#39;</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="s2">&quot;there should be one minified assets created in normal mode&quot;</span><span class="p">)</span>

        <span class="c1"># there shouldn&#39;t be any non-minified assets created in normal mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;js&#39;</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="s2">&quot;there shouldn&#39;t be any non-minified assets created in normal mode&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestJavascriptAssetsBundle.test_07_debug_assets">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestJavascriptAssetsBundle.test_07_debug_assets">[docs]</a>
    <span class="k">def</span> <span class="nf">test_07_debug_assets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checks that a bundle rendered in debug assets mode outputs non-minified assets</span>
<span class="sd">            and create an non-minified ir.attachment at the .</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">debug_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jsbundle_name</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">debug_bundle</span><span class="o">.</span><span class="n">get_links</span><span class="p">()</span>
        <span class="n">debug_bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="c1"># there should be a minified file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.bundle1.js&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;there should be one non-minified assets created in debug assets mode&quot;</span><span class="p">)</span>

        <span class="c1"># there shouldn&#39;t be any minified assets created in debug mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.js&#39;</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span>
                         <span class="s2">&quot;there shouldn&#39;t be any minified assets created in debug assets mode&quot;</span><span class="p">)</span>

        <span class="c1"># there should be one non-minified assets created in debug mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;js&#39;</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="s2">&quot;there should be one non-minified assets without a version in its url created in debug assets mode&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestJavascriptAssetsBundle.test_08_css_generation3">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestJavascriptAssetsBundle.test_08_css_generation3">[docs]</a>
    <span class="k">def</span> <span class="nf">test_08_css_generation3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># self.cssbundle_xlmid contains 3 rules (not checked below)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bundle</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bundle</span><span class="o">.</span><span class="n">get_attachments</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestJavascriptAssetsBundle.test_09_css_access">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestJavascriptAssetsBundle.test_09_css_access">[docs]</a>
    <span class="k">def</span> <span class="nf">test_09_css_access</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checks that the bundle&#39;s cache is working, i.e. that a bundle creates only enough</span>
<span class="sd">        ir.attachment records when rendered multiple times.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bundle0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="p">)</span>
        <span class="n">bundle0</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">version0</span> <span class="o">=</span> <span class="n">bundle0</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">)</span>
        <span class="n">ira0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">)</span>
        <span class="n">date0</span> <span class="o">=</span> <span class="n">ira0</span><span class="o">.</span><span class="n">create_date</span>

        <span class="n">bundle1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="p">)</span>
        <span class="n">bundle1</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">version1</span> <span class="o">=</span> <span class="n">bundle1</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">)</span>
        <span class="n">ira1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">)</span>
        <span class="n">date1</span> <span class="o">=</span> <span class="n">ira1</span><span class="o">.</span><span class="n">create_date</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">version0</span><span class="p">,</span> <span class="n">version1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">date0</span><span class="p">,</span> <span class="n">date1</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestJavascriptAssetsBundle.test_11_css_content_invalidation">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestJavascriptAssetsBundle.test_11_css_content_invalidation">[docs]</a>
    <span class="k">def</span> <span class="nf">test_11_css_content_invalidation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checks that a bundle is invalidated when its content is modified by adding a file to</span>
<span class="sd">        source.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bundle0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="p">)</span>
        <span class="n">bundle0</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>
        <span class="n">files0</span> <span class="o">=</span> <span class="n">bundle0</span><span class="o">.</span><span class="n">files</span>
        <span class="n">version0</span> <span class="o">=</span> <span class="n">bundle0</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test bundle inheritance&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle/static/src/css/test_cssfile2.css&#39;</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="n">bundle1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="p">)</span>
        <span class="n">bundle1</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>
        <span class="n">files1</span> <span class="o">=</span> <span class="n">bundle1</span><span class="o">.</span><span class="n">files</span>
        <span class="n">version1</span> <span class="o">=</span> <span class="n">bundle1</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">files0</span><span class="p">,</span> <span class="n">files1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">version0</span><span class="p">,</span> <span class="n">version1</span><span class="p">)</span>

        <span class="c1"># check if the previous attachment are correctly cleaned</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestJavascriptAssetsBundle.test_12_css_debug">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestJavascriptAssetsBundle.test_12_css_debug">[docs]</a>
    <span class="k">def</span> <span class="nf">test_12_css_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Check that a bundle in debug mode outputs non-minified assets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">debug_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">links</span> <span class="o">=</span> <span class="n">debug_bundle</span><span class="o">.</span><span class="n">get_links</span><span class="p">()</span>
        <span class="c1"># there should be a minified file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">links</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;/web/assets/debug/test_assetsbundle.bundle2.css&#39;</span><span class="p">)</span>

        <span class="c1"># there should be one css asset created in debug mode</span>
        <span class="n">debug_bundle</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">)),</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="s1">&#39;there should be one css asset created in debug mode&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestJavascriptAssetsBundle.test_14_duplicated_css_assets">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestJavascriptAssetsBundle.test_14_duplicated_css_assets">[docs]</a>
    <span class="k">def</span> <span class="nf">test_14_duplicated_css_assets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checks that if the bundle&#39;s ir.attachment record is duplicated, the bundle is only sourced once. This could</span>
<span class="sd">        happen if multiple transactions try to render the bundle simultaneously.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bundle0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="p">)</span>
        <span class="n">bundle0</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># duplicate the asset bundle</span>
        <span class="n">ira0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">)</span>
        <span class="n">ira1</span> <span class="o">=</span> <span class="n">ira0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ira0</span><span class="o">.</span><span class="n">store_fname</span><span class="p">,</span> <span class="n">ira1</span><span class="o">.</span><span class="n">store_fname</span><span class="p">)</span>

        <span class="c1"># the ir.attachment records should be deduplicated in the bundle&#39;s content</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">bundle0</span><span class="o">.</span><span class="n">get_links</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.bundle2.min.css&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>


    <span class="c1"># Language direction specific tests</span>

<div class="viewcode-block" id="TestJavascriptAssetsBundle.test_15_rtl_css_generation">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestJavascriptAssetsBundle.test_15_rtl_css_generation">[docs]</a>
    <span class="k">def</span> <span class="nf">test_15_rtl_css_generation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checks that a bundle creates an ir.attachment record when its `css` method is called</span>
<span class="sd">        for the first time for language with different direction and separate bundle is created for rtl direction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># there shouldn&#39;t be any attachment associated to this bundle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bundle</span><span class="o">.</span><span class="n">get_attachments</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># trigger the first generation and, thus, the first save in database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bundle</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>

        <span class="c1"># there should be one attachment associated to this bundle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bundle</span><span class="o">.</span><span class="n">get_attachments</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestJavascriptAssetsBundle.test_16_ltr_and_rtl_css_access">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestJavascriptAssetsBundle.test_16_ltr_and_rtl_css_access">[docs]</a>
    <span class="k">def</span> <span class="nf">test_16_ltr_and_rtl_css_access</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checks that the bundle&#39;s cache is working, i.e. that the bundle creates only one</span>
<span class="sd">        ir.attachment record when rendered multiple times for rtl direction also check we have two css bundles,</span>
<span class="sd">        one for ltr and one for rtl.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Assets access for en_US language</span>
        <span class="n">ltr_bundle0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ltr_bundle0</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">ltr_version0</span> <span class="o">=</span> <span class="n">ltr_bundle0</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">)</span>
        <span class="n">ltr_ira0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">ltr_ira0</span><span class="p">)</span>

        <span class="n">ltr_bundle1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ltr_bundle1</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">ltr_version1</span> <span class="o">=</span> <span class="n">ltr_bundle1</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">)</span>
        <span class="n">ltr_ira1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">ltr_ira1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ltr_version0</span><span class="p">,</span> <span class="n">ltr_version1</span><span class="p">)</span>

        <span class="n">rtl_bundle0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">rtl_bundle0</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">rtl_version0</span> <span class="o">=</span> <span class="n">rtl_bundle0</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">rtl_bundle1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">rtl_bundle1</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">rtl_version1</span> <span class="o">=</span> <span class="n">rtl_bundle1</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">)</span>
        <span class="n">rtl_ira1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rtl_version0</span><span class="p">,</span> <span class="n">rtl_version1</span><span class="p">)</span>

        <span class="c1"># Checks rtl and ltr bundles are different</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">ltr_ira1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">rtl_ira1</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># Check two bundles are available, one for ltr and one for rtl</span>
        <span class="n">css_bundles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.attachment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;=like&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;/web/assets/%/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="si">}</span><span class="s1">%.min.css&#39;</span><span class="p">),</span>
        <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">css_bundles</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestJavascriptAssetsBundle.test_17_css_bundle_date_invalidation">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestJavascriptAssetsBundle.test_17_css_bundle_date_invalidation">[docs]</a>
    <span class="k">def</span> <span class="nf">test_17_css_bundle_date_invalidation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checks that both css bundles are invalidated when one of its assets&#39; modification date is changed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ltr_bundle0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ltr_bundle0</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>
        <span class="n">ltr_last_modified0</span> <span class="o">=</span> <span class="n">ltr_bundle0</span><span class="o">.</span><span class="n">get_checksum</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">)</span>
        <span class="n">ltr_version0</span> <span class="o">=</span> <span class="n">ltr_bundle0</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">)</span>

        <span class="n">rtl_bundle0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">rtl_bundle0</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>
        <span class="n">rtl_last_modified0</span> <span class="o">=</span> <span class="n">rtl_bundle0</span><span class="o">.</span><span class="n">get_checksum</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">)</span>
        <span class="n">rtl_version0</span> <span class="o">=</span> <span class="n">rtl_bundle0</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">)</span>

        <span class="c1"># Touch test_cssfile1.css</span>
        <span class="c1"># Note: No lang specific context given while calling _get_asset so it will load assets for en_US</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle/static/src/css/test_cssfile1.css&#39;</span><span class="p">)</span>
        <span class="n">ltr_bundle1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_touch</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">ltr_bundle1</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>
            <span class="n">ltr_last_modified1</span> <span class="o">=</span> <span class="n">ltr_bundle1</span><span class="o">.</span><span class="n">get_checksum</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">)</span>
            <span class="n">ltr_version1</span> <span class="o">=</span> <span class="n">ltr_bundle1</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">)</span>
            <span class="n">ltr_ira1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">ltr_last_modified0</span><span class="p">,</span> <span class="n">ltr_last_modified1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">ltr_version0</span><span class="p">,</span> <span class="n">ltr_version1</span><span class="p">)</span>

            <span class="n">rtl_bundle1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">rtl_bundle1</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>
            <span class="n">rtl_last_modified1</span> <span class="o">=</span> <span class="n">rtl_bundle1</span><span class="o">.</span><span class="n">get_checksum</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">)</span>
            <span class="n">rtl_version1</span> <span class="o">=</span> <span class="n">rtl_bundle1</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">)</span>
            <span class="n">rtl_ira1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">rtl_last_modified0</span><span class="p">,</span> <span class="n">rtl_last_modified1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">rtl_version0</span><span class="p">,</span> <span class="n">rtl_version1</span><span class="p">)</span>

            <span class="c1"># Checks rtl and ltr bundles are different</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">ltr_ira1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">rtl_ira1</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

            <span class="c1"># check if the previous attachment is correctly cleaned</span>
            <span class="n">css_bundles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.attachment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
                <span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;=like&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;/web/assets/%/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="si">}</span><span class="s1">%.css&#39;</span><span class="p">),</span>
            <span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">css_bundles</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestJavascriptAssetsBundle.test_18_css_bundle_content_invalidation">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestJavascriptAssetsBundle.test_18_css_bundle_content_invalidation">[docs]</a>
    <span class="k">def</span> <span class="nf">test_18_css_bundle_content_invalidation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checks that a bundle is invalidated when its content is modified by adding a file to</span>
<span class="sd">        source.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Assets for en_US</span>
        <span class="n">ltr_bundle0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="p">)</span>
        <span class="n">ltr_bundle0</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>
        <span class="n">ltr_files0</span> <span class="o">=</span> <span class="n">ltr_bundle0</span><span class="o">.</span><span class="n">files</span>
        <span class="n">ltr_version0</span> <span class="o">=</span> <span class="n">ltr_bundle0</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">)</span>

        <span class="n">rtl_bundle0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">rtl_bundle0</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>
        <span class="n">rtl_files0</span> <span class="o">=</span> <span class="n">rtl_bundle0</span><span class="o">.</span><span class="n">files</span>
        <span class="n">rtl_version0</span> <span class="o">=</span> <span class="n">rtl_bundle0</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">)</span>

        <span class="n">css_bundles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.attachment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;=like&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;/web/assets/%/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="si">}</span><span class="s1">%.min.css&#39;</span><span class="p">),</span>
        <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">css_bundles</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test bundle inheritance&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle/static/src/css/test_cssfile3.css&#39;</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="n">ltr_bundle1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="p">)</span>
        <span class="n">ltr_bundle1</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>
        <span class="n">ltr_files1</span> <span class="o">=</span> <span class="n">ltr_bundle1</span><span class="o">.</span><span class="n">files</span>
        <span class="n">ltr_version1</span> <span class="o">=</span> <span class="n">ltr_bundle1</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">)</span>
        <span class="n">ltr_ira1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">ltr_files0</span><span class="p">,</span> <span class="n">ltr_files1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">ltr_version0</span><span class="p">,</span> <span class="n">ltr_version1</span><span class="p">)</span>

        <span class="n">rtl_bundle1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">rtl_bundle1</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>
        <span class="n">rtl_files1</span> <span class="o">=</span> <span class="n">rtl_bundle1</span><span class="o">.</span><span class="n">files</span>
        <span class="n">rtl_version1</span> <span class="o">=</span> <span class="n">rtl_bundle1</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">)</span>
        <span class="n">rtl_ira1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_any_ira_for_bundle</span><span class="p">(</span><span class="s1">&#39;min.css&#39;</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">rtl_files0</span><span class="p">,</span> <span class="n">rtl_files1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">rtl_version0</span><span class="p">,</span> <span class="n">rtl_version1</span><span class="p">)</span>

        <span class="c1"># Checks rtl and ltr bundles are different</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">ltr_ira1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">rtl_ira1</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># check if the previous attachment are correctly cleaned</span>
        <span class="n">css_bundles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.attachment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;=like&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;/web/assets/%/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="si">}</span><span class="s1">%.min.css&#39;</span><span class="p">),</span>
        <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">css_bundles</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestJavascriptAssetsBundle.test_19_css_in_debug_assets">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestJavascriptAssetsBundle.test_19_css_in_debug_assets">[docs]</a>
    <span class="k">def</span> <span class="nf">test_19_css_in_debug_assets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checks that a bundle rendered in debug mode(assets) with right to left language direction stores css files in assets bundle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">debug_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">debug_bundle</span><span class="o">.</span><span class="n">get_links</span><span class="p">()</span>

        <span class="c1"># there should be an css assets bundle in /debug/rtl if user&#39;s lang direction is rtl and debug=assets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/web/assets/debug/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="si">}</span><span class="s1">.rtl.css&#39;</span><span class="p">,</span> <span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                      <span class="s2">&quot;there should be an css assets bundle in /debug/rtl if user&#39;s lang direction is rtl and debug=assets&quot;</span><span class="p">)</span>

        <span class="n">debug_bundle</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>
        <span class="c1"># there should be an css assets bundle created in /rtl if user&#39;s lang direction is rtl and debug=assets</span>
        <span class="n">css_bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.attachment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;=like&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;/web/assets/%/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cssbundle_name</span><span class="si">}</span><span class="s1">.rtl.css&#39;</span><span class="p">),</span>
        <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">css_bundle</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="s2">&quot;there should be an css assets bundle created in /rtl if user&#39;s lang direction is rtl and debug=assets&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestJavascriptAssetsBundle.test_20_external_lib_assets">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestJavascriptAssetsBundle.test_20_external_lib_assets">[docs]</a>
    <span class="k">def</span> <span class="nf">test_20_external_lib_assets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_render_template</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.template2&#39;</span><span class="p">)</span>

        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.bundle4&#39;</span><span class="p">)</span>
        <span class="n">links</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">get_links</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">),</span> <span class="mi">6</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;&lt;!DOCTYPE html&gt;</span>
<span class="s2">&lt;html&gt;</span>
<span class="s2">    &lt;head&gt;</span>
<span class="s2">        &lt;link type=&quot;text/css&quot; rel=&quot;stylesheet&quot; href=&quot;http://test.external.link/style1.css&quot;/&gt;</span>
<span class="s2">        &lt;link type=&quot;text/css&quot; rel=&quot;stylesheet&quot; href=&quot;http://test.external.link/style2.css&quot;/&gt;</span>
<span class="s2">        &lt;link type=&quot;text/css&quot; rel=&quot;stylesheet&quot; href=&quot;</span><span class="si">{</span><span class="n">links</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;/&gt;</span>
<span class="s2">        &lt;meta/&gt;</span>
<span class="s2">        &lt;script type=&quot;text/javascript&quot; src=&quot;http://test.external.link/javascript1.js&quot;&gt;&lt;/script&gt;</span>
<span class="s2">        &lt;script type=&quot;text/javascript&quot; src=&quot;http://test.external.link/javascript2.js&quot;&gt;&lt;/script&gt;</span>
<span class="s2">        &lt;script type=&quot;text/javascript&quot; src=&quot;</span><span class="si">{</span><span class="n">links</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot; onerror=&quot;__odooAssetError=1&quot;&gt;&lt;/script&gt;</span>
<span class="s2">    &lt;/head&gt;</span>
<span class="s2">    &lt;body&gt;</span>
<span class="s2">    &lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;&quot;&quot;&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="TestJavascriptAssetsBundle.test_21_external_lib_assets_debug_mode">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestJavascriptAssetsBundle.test_21_external_lib_assets_debug_mode">[docs]</a>
    <span class="k">def</span> <span class="nf">test_21_external_lib_assets_debug_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">html</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_render_template</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.template2&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;debug&quot;</span><span class="p">:</span> <span class="s2">&quot;assets&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span> <span class="p">(</span><span class="s2">&quot;&quot;&quot;&lt;!DOCTYPE html&gt;</span>
<span class="s2">&lt;html&gt;</span>
<span class="s2">    &lt;head&gt;</span>
<span class="s2">        &lt;link type=&quot;text/css&quot; rel=&quot;stylesheet&quot; href=&quot;http://test.external.link/style1.css&quot;/&gt;</span>
<span class="s2">        &lt;link type=&quot;text/css&quot; rel=&quot;stylesheet&quot; href=&quot;http://test.external.link/style2.css&quot;/&gt;</span>
<span class="s2">        &lt;link type=&quot;text/css&quot; rel=&quot;stylesheet&quot; href=&quot;/web/assets/debug/test_assetsbundle.bundle4.css&quot;/&gt;</span>
<span class="s2">        &lt;meta/&gt;</span>
<span class="s2">        &lt;script type=&quot;text/javascript&quot; src=&quot;http://test.external.link/javascript1.js&quot;&gt;&lt;/script&gt;</span>
<span class="s2">        &lt;script type=&quot;text/javascript&quot; src=&quot;http://test.external.link/javascript2.js&quot;&gt;&lt;/script&gt;</span>
<span class="s2">        &lt;script type=&quot;text/javascript&quot; src=&quot;/web/assets/debug/test_assetsbundle.bundle4.js&quot; onerror=&quot;__odooAssetError=1&quot;&gt;&lt;/script&gt;</span>
<span class="s2">    &lt;/head&gt;</span>
<span class="s2">    &lt;body&gt;</span>
<span class="s2">    &lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;&quot;&quot;&quot;</span><span class="p">))</span></div>
</div>


<div class="viewcode-block" id="TestXMLAssetsBundle">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestXMLAssetsBundle">[docs]</a>
<span class="k">class</span> <span class="nc">TestXMLAssetsBundle</span><span class="p">(</span><span class="n">FileTouchable</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">files</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_content</span><span class="p">(</span><span class="n">bundle</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">AssetsBundle</span><span class="p">(</span><span class="n">bundle</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="n">debug_assets</span><span class="p">,</span> <span class="n">rtl</span><span class="o">=</span><span class="n">rtl</span><span class="p">)</span>

<div class="viewcode-block" id="TestXMLAssetsBundle.test_01_broken_xml">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestXMLAssetsBundle.test_01_broken_xml">[docs]</a>
    <span class="k">def</span> <span class="nf">test_01_broken_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checks that a bundle don&#39;t try hard to parse broken xml, and returns a comprehensive</span>
<span class="sd">        error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.broken_xml&#39;</span><span class="p">)</span>

        <span class="c1"># there shouldn&#39;t be any test_assetsbundle.invalid_xml template.</span>
        <span class="c1"># there should be an parsing_error template with the parsing error message.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bundle</span><span class="o">.</span><span class="n">xml</span><span class="p">(),</span>
                         <span class="s1">&#39;&lt;t t-name=&quot;parsing_error_test_assetsbundle_static_invalid_src_xml_invalid_xml.xml&quot;&gt;&lt;parsererror&gt;Invalid XML template: /test_assetsbundle/static/invalid_src/xml/invalid_xml.xml </span><span class="se">\n</span><span class="s1"> Opening and ending tag mismatch: SomeComponent line 4 and t, line 5, column 7 &lt;/parsererror&gt;&lt;/t&gt;&#39;</span><span class="p">,</span>
                         <span class="s2">&quot;the parsing error should be shown&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestXMLAssetsBundle.test_02_multiple_broken_xml">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestXMLAssetsBundle.test_02_multiple_broken_xml">[docs]</a>
    <span class="k">def</span> <span class="nf">test_02_multiple_broken_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checks that a bundle with multiple broken xml returns a comprehensive error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.multiple_broken_xml&#39;</span><span class="p">)</span>

        <span class="c1"># there shouldn&#39;t be any test_assetsbundle.invalid_xml template or test_assetsbundle.second_invalid_xml template.</span>
        <span class="c1"># there should be two parsing_error templates with the parsing error message for each file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bundle</span><span class="o">.</span><span class="n">xml</span><span class="p">(),</span>
                         <span class="s1">&#39;&lt;t t-name=&quot;parsing_error_test_assetsbundle_static_invalid_src_xml_invalid_xml.xml&quot;&gt;&lt;parsererror&gt;Invalid XML template: /test_assetsbundle/static/invalid_src/xml/invalid_xml.xml </span><span class="se">\n</span><span class="s1"> Opening and ending tag mismatch: SomeComponent line 4 and t, line 5, column 7 &lt;/parsererror&gt;&lt;/t&gt;&lt;t t-name=&quot;parsing_error_test_assetsbundle_static_invalid_src_xml_second_invalid_xml.xml&quot;&gt;&lt;parsererror&gt;Invalid XML template: /test_assetsbundle/static/invalid_src/xml/second_invalid_xml.xml </span><span class="se">\n</span><span class="s1"> XML declaration allowed only at the start of the document, line 2, column 6 &lt;/parsererror&gt;&lt;/t&gt;&#39;</span><span class="p">,</span>
                         <span class="s2">&quot;the parsing error should be shown&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TestAssetsBundleInBrowser">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsBundleInBrowser">[docs]</a>
<span class="nd">@tagged</span><span class="p">(</span><span class="s1">&#39;-at_install&#39;</span><span class="p">,</span> <span class="s1">&#39;post_install&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestAssetsBundleInBrowser</span><span class="p">(</span><span class="n">HttpCase</span><span class="p">):</span>
<div class="viewcode-block" id="TestAssetsBundleInBrowser.test_01_js_interpretation">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsBundleInBrowser.test_01_js_interpretation">[docs]</a>
    <span class="k">def</span> <span class="nf">test_01_js_interpretation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checks that the javascript of a bundle is correctly interpreted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser_js</span><span class="p">(</span>
            <span class="s2">&quot;/test_assetsbundle/js&quot;</span><span class="p">,</span>
            <span class="s2">&quot;a + b + c === 6 ? console.log(&#39;test successful&#39;) : console.log(&#39;error&#39;)&quot;</span><span class="p">,</span>
            <span class="n">login</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsBundleInBrowser.test_02_js_interpretation_inline">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsBundleInBrowser.test_02_js_interpretation_inline">[docs]</a>
    <span class="nd">@skip</span><span class="p">(</span><span class="s2">&quot;Feature Regression&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_02_js_interpretation_inline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checks that the javascript of a bundle is correctly interpretet when mixed with inline.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">view_arch</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &lt;data&gt;</span>
<span class="s2">            &lt;xpath expr=&quot;.&quot; position=&quot;inside&quot;&gt;</span>
<span class="s2">                &lt;script type=&quot;text/javascript&quot;&gt;</span>
<span class="s2">                    var d = 4;</span>
<span class="s2">                &lt;/script&gt;</span>
<span class="s2">            &lt;/xpath&gt;</span>
<span class="s2">        &lt;/data&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test bundle inheritance inline js&#39;</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;qweb&#39;</span><span class="p">,</span>
            <span class="s1">&#39;arch&#39;</span><span class="p">:</span> <span class="n">view_arch</span><span class="p">,</span>
            <span class="s1">&#39;inherit_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse_ref</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.bundle1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">browser_js</span><span class="p">(</span>
            <span class="s2">&quot;/test_assetsbundle/js&quot;</span><span class="p">,</span>
            <span class="s2">&quot;a + b + c + d === 10 ? console.log(&#39;test successful&#39;) : console.log(&#39;error&#39;)&quot;</span><span class="p">,</span>
            <span class="n">login</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="c1"># LPE Fixme</span>
    <span class="c1"># Review point @al: is this really what we want people to do ?</span>
<div class="viewcode-block" id="TestAssetsBundleInBrowser.test_03_js_interpretation_recommended_new_method">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsBundleInBrowser.test_03_js_interpretation_recommended_new_method">[docs]</a>
    <span class="k">def</span> <span class="nf">test_03_js_interpretation_recommended_new_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checks the feature of test_02 is still produceable, but in another way</span>
<span class="sd">        &#39;/web/content/&lt;int:id&gt;/&lt;string: filename.js&gt;&#39;,</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;const d = 4;&#39;</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.attachment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;CustomJscode.js&#39;</span><span class="p">,</span>
            <span class="s1">&#39;mimetype&#39;</span><span class="p">:</span> <span class="s1">&#39;text/javascript&#39;</span><span class="p">,</span>
            <span class="s1">&#39;datas&#39;</span><span class="p">:</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">code</span><span class="p">),</span>
        <span class="p">})</span>
        <span class="c1"># Use this route (filename is necessary)</span>
        <span class="n">custom_url</span> <span class="o">=</span> <span class="s1">&#39;/web/content/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attach</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">attach</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">attach</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">custom_url</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;lol&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.bundle1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">custom_url</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">browser_js</span><span class="p">(</span>
            <span class="s2">&quot;/test_assetsbundle/js&quot;</span><span class="p">,</span>
            <span class="s2">&quot;a + b + c + d === 10 ? console.log(&#39;test successful&#39;) : console.log(&#39;error&#39;)&quot;</span><span class="p">,</span>
            <span class="n">login</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TestAssetsBundleWithIRAMock">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsBundleWithIRAMock">[docs]</a>
<span class="k">class</span> <span class="nc">TestAssetsBundleWithIRAMock</span><span class="p">(</span><span class="n">FileTouchable</span><span class="p">):</span>
<div class="viewcode-block" id="TestAssetsBundleWithIRAMock.setUp">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsBundleWithIRAMock.setUp">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestAssetsBundleWithIRAMock</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stylebundle_name</span> <span class="o">=</span> <span class="s1">&#39;test_assetsbundle.bundle3&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>

        <span class="c1"># patch methods &#39;create&#39; and &#39;unlink&#39; of model &#39;ir.attachment&#39;</span>
        <span class="n">origin_create</span> <span class="o">=</span> <span class="n">IrAttachment</span><span class="o">.</span><span class="n">create</span>
        <span class="n">origin_unlink</span> <span class="o">=</span> <span class="n">AssetsBundle</span><span class="o">.</span><span class="n">_unlink_attachments</span>

        <span class="nd">@api</span><span class="o">.</span><span class="n">model_create_multi</span>
        <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
            <span class="n">counter</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="s1">&#39;create&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals_list</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">origin_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">unlink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attachments</span><span class="p">):</span>
            <span class="n">counter</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="s1">&#39;unlink&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">origin_unlink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attachments</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">IrAttachment</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="n">create</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">AssetsBundle</span><span class="p">,</span> <span class="s1">&#39;_unlink_attachments&#39;</span><span class="p">,</span> <span class="n">unlink</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_get_asset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]),</span> <span class="s1">&#39;_get_installed_addons_list&#39;</span><span class="p">,</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">installed_modules</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stylebundle_name</span><span class="p">,</span> <span class="n">debug_assets</span><span class="o">=</span><span class="n">debug_assets</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_bundle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="n">should_create</span><span class="p">,</span> <span class="n">should_unlink</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">bundle</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">should_create</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">[</span><span class="s1">&#39;create&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;An attachment should have been created </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">[</span><span class="s1">&#39;create&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;No attachment should have been created </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">should_unlink</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">[</span><span class="s1">&#39;unlink&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;An attachment should have been unlink </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">[</span><span class="s1">&#39;unlink&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;No attachment should have been unlink </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="TestAssetsBundleWithIRAMock.test_01_debug_mode_assets">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsBundleWithIRAMock.test_01_debug_mode_assets">[docs]</a>
    <span class="k">def</span> <span class="nf">test_01_debug_mode_assets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checks that the ir.attachments records created for compiled assets in debug mode</span>
<span class="sd">        are correctly invalidated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Compile for the first time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bundle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(),</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;(First access)&#39;</span><span class="p">)</span>

        <span class="c1"># Compile a second time, without changes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bundle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(),</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;(Second access, no change)&#39;</span><span class="p">)</span>

        <span class="c1"># Touch the file and compile a third time</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle/static/src/scss/test_file1.scss&#39;</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">5</span>
        <span class="n">asset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_touch</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bundle</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Because we are in the same transaction since the beginning of the test, the first asset</span>
            <span class="c1"># created and the second one have the same write_date, but the file&#39;s last modified date</span>
            <span class="c1"># has really been modified. If we do not update the write_date to a posterior date, we are</span>
            <span class="c1"># not able to reproduce the case where we compile this bundle again without changing</span>
            <span class="c1"># anything.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.attachment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flush_model</span><span class="p">([</span><span class="s1">&#39;checksum&#39;</span><span class="p">,</span> <span class="s1">&#39;write_date&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;update ir_attachment set write_date=clock_timestamp() + interval &#39;10 seconds&#39; where id = (select max(id) from ir_attachment)&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.attachment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">invalidate_model</span><span class="p">([</span><span class="s1">&#39;write_date&#39;</span><span class="p">])</span>

            <span class="c1"># Compile a fourth time, without changes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bundle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_asset</span><span class="p">(),</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TestAssetsManifest">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest">[docs]</a>
<span class="nd">@tagged</span><span class="p">(</span><span class="s1">&#39;assets_manifest&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestAssetsManifest</span><span class="p">(</span><span class="n">AddonManifestPatched</span><span class="p">):</span>

<div class="viewcode-block" id="TestAssetsManifest.make_asset_view">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.make_asset_view">[docs]</a>
    <span class="k">def</span> <span class="nf">make_asset_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset_key</span><span class="p">,</span> <span class="n">t_call_assets_attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">default_attrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;t-js&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span>
            <span class="s1">&#39;t-css&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">t_call_assets_attrs</span><span class="p">:</span>
            <span class="n">default_attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">t_call_assets_attrs</span><span class="p">)</span>

        <span class="n">attrs</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">default_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            &lt;div&gt;</span>
<span class="s1">                &lt;t t-call-assets=&quot;</span><span class="si">%(asset_key)s</span><span class="s1">&quot; </span><span class="si">%(attrs)s</span><span class="s1"> /&gt;</span>
<span class="s1">            &lt;/div&gt;</span>
<span class="s1">        &#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">{</span>
            <span class="s1">&#39;asset_key&#39;</span><span class="p">:</span> <span class="n">asset_key</span><span class="p">,</span>
            <span class="s1">&#39;attrs&#39;</span><span class="p">:</span> <span class="n">attrs</span>
        <span class="p">}</span>

        <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test asset&#39;</span><span class="p">,</span>
            <span class="s1">&#39;arch&#39;</span><span class="p">:</span> <span class="n">arch</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;qweb&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="n">view</span></div>


<div class="viewcode-block" id="TestAssetsManifest.assertStringEqual">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.assertStringEqual">[docs]</a>
    <span class="k">def</span> <span class="nf">assertStringEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference</span><span class="p">,</span> <span class="n">tested</span><span class="p">):</span>
        <span class="n">tested</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">tested</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">reference</span> <span class="o">=</span> <span class="n">reference</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">tested</span><span class="p">,</span> <span class="n">reference</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_01_globmanifest">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_01_globmanifest">[docs]</a>
    <span class="k">def</span> <span class="nf">test_01_globmanifest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.manifest1&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile1.js */</span>
<span class="sd">            var a=1;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile2.js */</span>
<span class="sd">            var b=2;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile3.js */</span>
<span class="sd">            var c=3;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile4.js */</span>
<span class="sd">            var d=4;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_02_globmanifest_no_duplicates">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_02_globmanifest_no_duplicates">[docs]</a>
    <span class="k">def</span> <span class="nf">test_02_globmanifest_no_duplicates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.manifest2&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile1.js */</span>
<span class="sd">            var a=1;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile2.js */</span>
<span class="sd">            var b=2;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile3.js */</span>
<span class="sd">            var c=3;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile4.js */</span>
<span class="sd">            var d=4;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_03_globmanifest_file_before">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_03_globmanifest_file_before">[docs]</a>
    <span class="k">def</span> <span class="nf">test_03_globmanifest_file_before</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.manifest3&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile3.js */</span>
<span class="sd">            var c=3;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile1.js */</span>
<span class="sd">            var a=1;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile2.js */</span>
<span class="sd">            var b=2;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile4.js */</span>
<span class="sd">            var d=4;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_04_globmanifest_with_irasset">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_04_globmanifest_with_irasset">[docs]</a>
    <span class="k">def</span> <span class="nf">test_04_globmanifest_with_irasset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_jsfile4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle/static/src/js/test_jsfile1.js&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile3.js */</span>
<span class="sd">            var c=3;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile1.js */</span>
<span class="sd">            var a=1;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_05_only_irasset">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_05_only_irasset">[docs]</a>
    <span class="k">def</span> <span class="nf">test_05_only_irasset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_jsfile4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irasset1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle/static/src/js/test_jsfile1.js&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.irasset1&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>

        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile1.js */</span>
<span class="sd">            var a=1;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_06_1_replace">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_06_1_replace">[docs]</a>
    <span class="k">def</span> <span class="nf">test_06_1_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_jsfile4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.manifest1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;directive&#39;</span><span class="p">:</span> <span class="s1">&#39;replace&#39;</span><span class="p">,</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle/static/src/js/test_jsfile1.js&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;http://external.link/external.js&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.manifest1&#39;</span><span class="p">)</span>
        <span class="n">scripts</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">bundle</span><span class="o">.</span><span class="n">get_links</span><span class="p">()</span> <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;js&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scripts</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">scripts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;http://external.link/external.js&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">scripts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">attach</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile2.js */</span>
<span class="sd">            var b=2;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile3.js */</span>
<span class="sd">            var c=3;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile4.js */</span>
<span class="sd">            var d=4;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_06_2_replace">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_06_2_replace">[docs]</a>
    <span class="k">def</span> <span class="nf">test_06_2_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_jsfile4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;directive&#39;</span><span class="p">:</span> <span class="s1">&#39;replace&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle/static/src/js/test_jsfile1.js&#39;</span><span class="p">,</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle/static/src/js/test_jsfile3.js&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.attachment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;ilike&#39;</span><span class="p">,</span> <span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">)],</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;create_date DESC&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile1.js */</span>
<span class="sd">            var a=1;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_06_3_replace_globs">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_06_3_replace_globs">[docs]</a>
    <span class="k">def</span> <span class="nf">test_06_3_replace_globs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_jsfile4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;directive&#39;</span><span class="p">:</span> <span class="s1">&#39;prepend&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle/static/src/js/test_jsfile4.js&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="c1"># asset is now: js_file4 ; js_file3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_jsfile4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;directive&#39;</span><span class="p">:</span> <span class="s1">&#39;replace&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle/static/src/js/test_jsfile[12].js&#39;</span><span class="p">,</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle/static/src/js/test_jsfile[45].js&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="c1"># asset is now: js_file1 ; js_file2 ; js_file3</span>
        <span class="c1"># because js_file is replaced by 1 and 2</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile1.js */</span>
<span class="sd">            var a=1;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile2.js */</span>
<span class="sd">            var b=2;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile3.js */</span>
<span class="sd">            var c=3;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_07_remove">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_07_remove">[docs]</a>
    <span class="k">def</span> <span class="nf">test_07_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_jsfile4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.manifest5&#39;</span><span class="p">,</span>
            <span class="s1">&#39;directive&#39;</span><span class="p">:</span> <span class="s1">&#39;remove&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle/static/src/js/test_jsfile2.js&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.manifest5&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile1.js */</span>
<span class="sd">            var a=1;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile3.js */</span>
<span class="sd">            var c=3;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile4.js */</span>
<span class="sd">            var d=4;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_08_remove_inexistent_file">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_08_remove_inexistent_file">[docs]</a>
    <span class="k">def</span> <span class="nf">test_08_remove_inexistent_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_jsfile4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.remove_error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/test_assetsbundle/static/src/js/test_jsfile1.js&#39;</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_jsfile4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.remove_error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;directive&#39;</span><span class="p">:</span> <span class="s1">&#39;remove&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle/static/src/js/test_doesntexist.js&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.remove_error&#39;</span><span class="p">)</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="s2">&quot;[&#39;test_assetsbundle/static/src/js/test_doesntexist.js&#39;] not found&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_09_remove_wholeglob">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_09_remove_wholeglob">[docs]</a>
    <span class="k">def</span> <span class="nf">test_09_remove_wholeglob</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_jsfile4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.manifest2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;directive&#39;</span><span class="p">:</span> <span class="s1">&#39;remove&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle/static/src/*/**&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.manifest2&#39;</span><span class="p">)</span>
        <span class="c1"># indeed everything in the bundle matches the glob, so there is no attachment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">javascripts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">get_links</span><span class="p">())</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_10_prepend">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_10_prepend">[docs]</a>
    <span class="k">def</span> <span class="nf">test_10_prepend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_jsfile4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;directive&#39;</span><span class="p">:</span> <span class="s1">&#39;prepend&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle/static/src/js/test_jsfile1.js&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile1.js */</span>
<span class="sd">            var a=1;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile3.js */</span>
<span class="sd">            var c=3;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_11_include">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_11_include">[docs]</a>
    <span class="k">def</span> <span class="nf">test_11_include</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_jsfile4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;directive&#39;</span><span class="p">:</span> <span class="s1">&#39;include&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irasset_include1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.manifest6&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.irasset_include1&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile3.js */</span>
<span class="sd">            var c=3;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_12_include2">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_12_include2">[docs]</a>
    <span class="k">def</span> <span class="nf">test_12_include2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.manifest6&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile3.js */</span>
<span class="sd">            var c=3;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_13_include_circular">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_13_include_circular">[docs]</a>
    <span class="k">def</span> <span class="nf">test_13_include_circular</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_jsfile4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;directive&#39;</span><span class="p">:</span> <span class="s1">&#39;include&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irasset_include1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irasset_include2&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_jsfile4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;directive&#39;</span><span class="p">:</span> <span class="s1">&#39;include&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irasset_include2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irasset_include1&#39;</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.irasset_include1&#39;</span><span class="p">)</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="ne">RecursionError</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;Circular assets bundle declaration:&#39;</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_13_2_include_recursive_sibling">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_13_2_include_recursive_sibling">[docs]</a>
    <span class="k">def</span> <span class="nf">test_13_2_include_recursive_sibling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_jsfile4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;directive&#39;</span><span class="p">:</span> <span class="s1">&#39;include&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irasset_include1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irasset_include2&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_jsfile4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;directive&#39;</span><span class="p">:</span> <span class="s1">&#39;include&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irasset_include2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irasset_include3&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_jsfile4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;directive&#39;</span><span class="p">:</span> <span class="s1">&#39;include&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irasset_include2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irasset_include4&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_jsfile4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;directive&#39;</span><span class="p">:</span> <span class="s1">&#39;include&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irasset_include4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irasset_include3&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_jsfile4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irasset_include3&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle/static/src/js/test_jsfile1.js&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.irasset_include1&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile1.js */</span>
<span class="sd">            var a=1;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_14_other_module">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_14_other_module">[docs]</a>
    <span class="k">def</span> <span class="nf">test_14_other_module</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">installed_modules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;test_other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manifests</span><span class="p">[</span><span class="s1">&#39;test_other&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_other&#39;</span><span class="p">,</span>
            <span class="s1">&#39;depends&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;test_assetsbundle&#39;</span><span class="p">],</span>
            <span class="s1">&#39;addons_path&#39;</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
            <span class="s1">&#39;assets&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;test_other.mockmanifest1&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;include&#39;</span><span class="p">,</span> <span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_other.mockmanifest1&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile3.js */</span>
<span class="sd">            var c=3;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_15_other_module_append">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_15_other_module_append">[docs]</a>
    <span class="k">def</span> <span class="nf">test_15_other_module_append</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">installed_modules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;test_other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manifests</span><span class="p">[</span><span class="s1">&#39;test_other&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_other&#39;</span><span class="p">,</span>
            <span class="s1">&#39;depends&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;test_assetsbundle&#39;</span><span class="p">],</span>
            <span class="s1">&#39;addons_path&#39;</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
            <span class="s1">&#39;assets&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s1">&#39;test_assetsbundle/static/src/js/test_jsfile1.js&#39;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile3.js */</span>
<span class="sd">            var c=3;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile1.js */</span>
<span class="sd">            var a=1;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_16_other_module_prepend">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_16_other_module_prepend">[docs]</a>
    <span class="k">def</span> <span class="nf">test_16_other_module_prepend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">installed_modules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;test_other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manifests</span><span class="p">[</span><span class="s1">&#39;test_other&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_other&#39;</span><span class="p">,</span>
            <span class="s1">&#39;depends&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;test_assetsbundle&#39;</span><span class="p">],</span>
            <span class="s1">&#39;addons_path&#39;</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
            <span class="s1">&#39;assets&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;prepend&#39;</span><span class="p">,</span> <span class="s1">&#39;test_assetsbundle/static/src/js/test_jsfile1.js&#39;</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile1.js */</span>
<span class="sd">            var a=1;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile3.js */</span>
<span class="sd">            var c=3;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_17_other_module_replace">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_17_other_module_replace">[docs]</a>
    <span class="k">def</span> <span class="nf">test_17_other_module_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">installed_modules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;test_other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manifests</span><span class="p">[</span><span class="s1">&#39;test_other&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_other&#39;</span><span class="p">,</span>
            <span class="s1">&#39;depends&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;test_assetsbundle&#39;</span><span class="p">],</span>
            <span class="s1">&#39;addons_path&#39;</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
            <span class="s1">&#39;assets&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="s1">&#39;test_assetsbundle/static/src/js/test_jsfile3.js&#39;</span><span class="p">,</span> <span class="s1">&#39;test_assetsbundle/static/src/js/test_jsfile1.js&#39;</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile1.js */</span>
<span class="sd">            var a=1;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_17_other_module_remove">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_17_other_module_remove">[docs]</a>
    <span class="k">def</span> <span class="nf">test_17_other_module_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">installed_modules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;test_other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manifests</span><span class="p">[</span><span class="s1">&#39;test_other&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_other&#39;</span><span class="p">,</span>
            <span class="s1">&#39;depends&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;test_assetsbundle&#39;</span><span class="p">],</span>
            <span class="s1">&#39;addons_path&#39;</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
            <span class="s1">&#39;assets&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="s1">&#39;test_assetsbundle/static/src/js/test_jsfile3.js&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="s1">&#39;test_assetsbundle/static/src/js/test_jsfile1.js&#39;</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile1.js */</span>
<span class="sd">            var a=1;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_18_other_module_external">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_18_other_module_external">[docs]</a>
    <span class="k">def</span> <span class="nf">test_18_other_module_external</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">installed_modules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;test_other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manifests</span><span class="p">[</span><span class="s1">&#39;test_other&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_other&#39;</span><span class="p">,</span>
            <span class="s1">&#39;depends&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;test_assetsbundle&#39;</span><span class="p">],</span>
            <span class="s1">&#39;addons_path&#39;</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
            <span class="s1">&#39;assets&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s1">&#39;http://external.link/external.js&#39;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">)</span>
        <span class="n">scripts</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">bundle</span><span class="o">.</span><span class="n">get_links</span><span class="p">()</span> <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;js&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scripts</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">scripts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;http://external.link/external.js&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile3.js */</span>
<span class="sd">            var c=3;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


    <span class="c1">#</span>
    <span class="c1"># LPE Fixme: Warning, this matches a change in behavior</span>
    <span class="c1"># Before this, each node within an asset could have a &quot;media&quot; and/or a &quot;direction&quot;</span>
    <span class="c1"># attribute to tell the browser to take preferably the css resource</span>
    <span class="c1"># in the relevant viewport or text direction</span>
    <span class="c1">#</span>
    <span class="c1"># with the new ir_assert mechanism, these attributes are only evaluated at the t-call-asset</span>
    <span class="c1"># step, that is, a step earlier than before, implicating a more restrictive usage</span>
    <span class="c1">#</span>
<div class="viewcode-block" id="TestAssetsManifest.test_19_css_specific_attrs_in_tcallassets">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_19_css_specific_attrs_in_tcallassets">[docs]</a>
    <span class="k">def</span> <span class="nf">test_19_css_specific_attrs_in_tcallassets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irasset2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;http://external.css/externalstyle.css&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irasset2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle/static/src/css/test_cssfile1.css&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_asset_view</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.irasset2&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;t-js&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span>
            <span class="s1">&#39;t-css&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span>
            <span class="s1">&#39;media&#39;</span><span class="p">:</span> <span class="s1">&#39;print&#39;</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="n">rendered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_render</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">html_tree</span> <span class="o">=</span> <span class="n">lxml</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">rendered</span><span class="p">)</span>
        <span class="n">stylesheets</span> <span class="o">=</span> <span class="n">html_tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;link&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stylesheets</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">stylesheets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">),</span> <span class="s1">&#39;http://external.css/externalstyle.css&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">stylesheets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;media&#39;</span><span class="p">),</span> <span class="s1">&#39;print&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_20_css_base">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_20_css_base">[docs]</a>
    <span class="k">def</span> <span class="nf">test_20_css_base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irasset2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;http://external.css/externalstyle.css&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irasset2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle/static/src/scss/test_file1.scss&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.irasset2&#39;</span><span class="p">)</span>
        <span class="n">stylesheets</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">bundle</span><span class="o">.</span><span class="n">get_links</span><span class="p">()</span> <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;css&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stylesheets</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/scss/test_file1.scss */</span>
<span class="sd">             .rule1{color: black;}</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_21_js_before_css">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_21_js_before_css">[docs]</a>
    <span class="k">def</span> <span class="nf">test_21_js_before_css</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Non existing target node: ignore the manifest line&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">installed_modules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;test_other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manifests</span><span class="p">[</span><span class="s1">&#39;test_other&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_other&#39;</span><span class="p">,</span>
            <span class="s1">&#39;depends&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;test_assetsbundle&#39;</span><span class="p">],</span>
            <span class="s1">&#39;addons_path&#39;</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
            <span class="s1">&#39;assets&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;test_other.bundle4&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;test_assetsbundle/static/src/css/test_cssfile1.css&#39;</span><span class="p">,</span> <span class="s1">&#39;/test_assetsbundle/static/src/js/test_jsfile4.js&#39;</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.bundle4&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile1.js */</span>
<span class="sd">            var a=1;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile2.js */</span>
<span class="sd">            var b=2;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile3.js */</span>
<span class="sd">            var c=3;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_22_js_before_js">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_22_js_before_js">[docs]</a>
    <span class="k">def</span> <span class="nf">test_22_js_before_js</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">installed_modules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;test_other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manifests</span><span class="p">[</span><span class="s1">&#39;test_other&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_other&#39;</span><span class="p">,</span>
            <span class="s1">&#39;depends&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;test_assetsbundle&#39;</span><span class="p">],</span>
            <span class="s1">&#39;addons_path&#39;</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
            <span class="s1">&#39;assets&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;test_assetsbundle.bundle4&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;/test_assetsbundle/static/src/js/test_jsfile3.js&#39;</span><span class="p">,</span> <span class="s1">&#39;/test_assetsbundle/static/src/js/test_jsfile4.js&#39;</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.bundle4&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile1.js */</span>
<span class="sd">            var a=1;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile2.js */</span>
<span class="sd">            var b=2;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile4.js */</span>
<span class="sd">            var d=4;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile3.js */</span>
<span class="sd">            var c=3;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_23_js_after_css">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_23_js_after_css">[docs]</a>
    <span class="k">def</span> <span class="nf">test_23_js_after_css</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Non existing target node: ignore the manifest line&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">installed_modules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;test_other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manifests</span><span class="p">[</span><span class="s1">&#39;test_other&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_other&#39;</span><span class="p">,</span>
            <span class="s1">&#39;depends&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;test_assetsbundle&#39;</span><span class="p">],</span>
            <span class="s1">&#39;addons_path&#39;</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
            <span class="s1">&#39;assets&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;test_other.bundle4&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="s1">&#39;test_assetsbundle/static/src/css/test_cssfile1.css&#39;</span><span class="p">,</span> <span class="s1">&#39;/test_assetsbundle/static/src/js/test_jsfile4.js&#39;</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.bundle4&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile1.js */</span>
<span class="sd">            var a=1;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile2.js */</span>
<span class="sd">            var b=2;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile3.js */</span>
<span class="sd">            var c=3;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_24_js_after_js">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_24_js_after_js">[docs]</a>
    <span class="k">def</span> <span class="nf">test_24_js_after_js</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">installed_modules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;test_other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manifests</span><span class="p">[</span><span class="s1">&#39;test_other&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test_other&#39;</span><span class="p">,</span>
            <span class="s1">&#39;depends&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;test_assetsbundle&#39;</span><span class="p">],</span>
            <span class="s1">&#39;addons_path&#39;</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
            <span class="s1">&#39;assets&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;test_assetsbundle.bundle4&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="s1">&#39;/test_assetsbundle/static/src/js/test_jsfile2.js&#39;</span><span class="p">,</span> <span class="s1">&#39;/test_assetsbundle/static/src/js/test_jsfile4.js&#39;</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.bundle4&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile1.js */</span>
<span class="sd">            var a=1;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile2.js */</span>
<span class="sd">            var b=2;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile4.js */</span>
<span class="sd">            var d=4;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile3.js */</span>
<span class="sd">            var c=3;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_25_js_before_js_in_irasset">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_25_js_before_js_in_irasset">[docs]</a>
    <span class="k">def</span> <span class="nf">test_25_js_before_js_in_irasset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.bundle4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/test_assetsbundle/static/src/js/test_jsfile4.js&#39;</span><span class="p">,</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;/test_assetsbundle/static/src/js/test_jsfile3.js&#39;</span><span class="p">,</span>
            <span class="s1">&#39;directive&#39;</span><span class="p">:</span> <span class="s1">&#39;before&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.bundle4&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile1.js */</span>
<span class="sd">            var a=1;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile2.js */</span>
<span class="sd">            var b=2;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile4.js */</span>
<span class="sd">            var d=4;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile3.js */</span>
<span class="sd">            var c=3;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_26_js_after_js_in_irasset">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_26_js_after_js_in_irasset">[docs]</a>
    <span class="k">def</span> <span class="nf">test_26_js_after_js_in_irasset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.bundle4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/test_assetsbundle/static/src/js/test_jsfile4.js&#39;</span><span class="p">,</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;/test_assetsbundle/static/src/js/test_jsfile2.js&#39;</span><span class="p">,</span>
            <span class="s1">&#39;directive&#39;</span><span class="p">:</span> <span class="s1">&#39;after&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.bundle4&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile1.js */</span>
<span class="sd">            var a=1;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile2.js */</span>
<span class="sd">            var b=2;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile4.js */</span>
<span class="sd">            var d=4;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile3.js */</span>
<span class="sd">            var c=3;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_27_mixing_after_before_js_css_in_irasset">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_27_mixing_after_before_js_css_in_irasset">[docs]</a>
    <span class="k">def</span> <span class="nf">test_27_mixing_after_before_js_css_in_irasset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.bundle4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/test_assetsbundle/static/src/js/test_jsfile4.js&#39;</span><span class="p">,</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;/test_assetsbundle/static/src/css/test_cssfile1.css&#39;</span><span class="p">,</span>
            <span class="s1">&#39;directive&#39;</span><span class="p">:</span> <span class="s1">&#39;after&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.bundle4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/test_assetsbundle/static/src/css/test_cssfile3.css&#39;</span><span class="p">,</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;/test_assetsbundle/static/src/js/test_jsfile2.js&#39;</span><span class="p">,</span>
            <span class="s1">&#39;directive&#39;</span><span class="p">:</span> <span class="s1">&#39;before&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_asset_view</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.bundle4&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;t-js&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span>
            <span class="s1">&#39;t-css&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.bundle4&#39;</span><span class="p">)</span>
        <span class="n">attach_css</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>
        <span class="n">attach_js</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>

        <span class="n">js_content</span> <span class="o">=</span> <span class="n">attach_js</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">js_content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile1.js */</span>
<span class="sd">            var a=1;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile2.js */</span>
<span class="sd">            var b=2;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile4.js */</span>
<span class="sd">            var d=4;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile3.js */</span>
<span class="sd">            var c=3;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span>

        <span class="n">css_content</span> <span class="o">=</span> <span class="n">attach_css</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">css_content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/css/test_cssfile3.css */</span>
<span class="sd">            .rule4{color: green;}</span>

<span class="sd">            /* /test_assetsbundle/static/src/css/test_cssfile1.css */</span>
<span class="sd">            .rule1{color: black;}.rule2{color: yellow;}.rule3{color: red;}</span>

<span class="sd">            /* /test_assetsbundle/static/src/css/test_cssfile2.css */</span>
<span class="sd">            .rule4{color: blue;}</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_28_js_after_js_in_irasset_wrong_path">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_28_js_after_js_in_irasset_wrong_path">[docs]</a>
    <span class="k">def</span> <span class="nf">test_28_js_after_js_in_irasset_wrong_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.wrong_path&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/test_assetsbundle/static/src/js/test_jsfile4.js&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.wrong_path&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/test_assetsbundle/static/src/js/test_jsfile1.js&#39;</span><span class="p">,</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;/test_assetsbundle/static/src/js/doesnt_exist.js&#39;</span><span class="p">,</span>
            <span class="s1">&#39;directive&#39;</span><span class="p">:</span> <span class="s1">&#39;after&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.wrong_path&#39;</span><span class="p">)</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="s2">&quot;test_assetsbundle/static/src/js/doesnt_exist.js not found&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_29_js_after_js_in_irasset_glob">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_29_js_after_js_in_irasset_glob">[docs]</a>
    <span class="k">def</span> <span class="nf">test_29_js_after_js_in_irasset_glob</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/test_assetsbundle/static/src/*/**&#39;</span><span class="p">,</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;/test_assetsbundle/static/src/js/test_jsfile3.js&#39;</span><span class="p">,</span>
            <span class="s1">&#39;directive&#39;</span><span class="p">:</span> <span class="s1">&#39;after&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile3.js */</span>
<span class="sd">            var c=3;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile1.js */</span>
<span class="sd">            var a=1;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile2.js */</span>
<span class="sd">            var b=2;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile4.js */</span>
<span class="sd">            var d=4;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_30_js_before_js_in_irasset_glob">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_30_js_before_js_in_irasset_glob">[docs]</a>
    <span class="k">def</span> <span class="nf">test_30_js_before_js_in_irasset_glob</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/test_assetsbundle/static/src/js/test_jsfile[124].js&#39;</span><span class="p">,</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;/test_assetsbundle/static/src/js/test_jsfile3.js&#39;</span><span class="p">,</span>
            <span class="s1">&#39;directive&#39;</span><span class="p">:</span> <span class="s1">&#39;before&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.manifest4&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile1.js */</span>
<span class="sd">            var a=1;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile2.js */</span>
<span class="sd">            var b=2;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile4.js */</span>
<span class="sd">            var d=4;;</span>

<span class="sd">            /* /test_assetsbundle/static/src/js/test_jsfile3.js */</span>
<span class="sd">            var c=3;</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_31">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_31">[docs]</a>
    <span class="nd">@mute_logger</span><span class="p">(</span><span class="s1">&#39;odoo.addons.base.models.ir_asset&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_31</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path_to_dummy</span> <span class="o">=</span> <span class="s1">&#39;../../tests/dummy.js&#39;</span>
        <span class="n">me</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="n">path_to_dummy</span><span class="p">)</span>  <span class="c1"># assuming me = test_assetsbundle/tests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irassetsec&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/test_assetsbundle/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">path_to_dummy</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.irassetsec&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Could not get content for /test_assetsbundle/../../tests/dummy.js&quot;</span><span class="p">,</span> <span class="n">attach</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span><span class="o">.</span><span class="n">raw</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_32_a_relative_path_in_addon">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_32_a_relative_path_in_addon">[docs]</a>
    <span class="nd">@mute_logger</span><span class="p">(</span><span class="s1">&#39;odoo.addons.base.models.ir_asset&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_32_a_relative_path_in_addon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path_to_dummy</span> <span class="o">=</span> <span class="s1">&#39;../../tests/dummy.xml&#39;</span>
        <span class="n">me</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="n">path_to_dummy</span><span class="p">)</span>  <span class="c1"># assuming me = test_assetsbundle/tests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irassetsec&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/test_assetsbundle/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">path_to_dummy</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_paths</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.irassetsec&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;/test_assetsbundle/../../tests/dummy.xml&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;test_assetsbundle.irassetsec&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)])</span></div>

        <span class="c1"># TODO, validate this behaviour</span>
        <span class="c1"># the idea is that if the second element is False (not None) it will be added to the assetbundle, but considered in any case as an attachment url)</span>

<div class="viewcode-block" id="TestAssetsManifest.test_32_b_relative_path_outsied_addon">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_32_b_relative_path_outsied_addon">[docs]</a>
    <span class="nd">@mute_logger</span><span class="p">(</span><span class="s1">&#39;odoo.addons.base.models.ir_asset&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_32_b_relative_path_outsied_addon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path_to_dummy</span> <span class="o">=</span> <span class="s1">&#39;../../tests/dummy.xml&#39;</span>
        <span class="n">me</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="n">path_to_dummy</span><span class="p">)</span>  <span class="c1"># assuming me = test_assetsbundle/tests</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irassetsec&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">path_to_dummy</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_paths</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.irassetsec&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;../../tests/dummy.xml&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;test_assetsbundle.irassetsec&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)])</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_33">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_33">[docs]</a>
    <span class="k">def</span> <span class="nf">test_33</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manifests</span><span class="p">[</span><span class="s1">&#39;notinstalled_module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;notinstalled_module&#39;</span><span class="p">,</span>
            <span class="s1">&#39;depends&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;test_assetsbundle&#39;</span><span class="p">],</span>
            <span class="s1">&#39;addons_path&#39;</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irassetsec&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/notinstalled_module/somejsfile.js&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">Exception</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.irassetsec&#39;</span><span class="p">)</span>
            <span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;Unallowed to fetch files from addon notinstalled_module&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">))</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_33bis_notinstalled_not_in_manifests">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_33bis_notinstalled_not_in_manifests">[docs]</a>
    <span class="k">def</span> <span class="nf">test_33bis_notinstalled_not_in_manifests</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irassetsec&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/notinstalled_module/somejsfile.js&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_asset_view</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.irassetsec&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.attachment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;ilike&#39;</span><span class="p">,</span> <span class="s1">&#39;test_assetsbundle.irassetsec&#39;</span><span class="p">)],</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;create_date DESC&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">attach</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_34">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_34">[docs]</a>
    <span class="nd">@mute_logger</span><span class="p">(</span><span class="s1">&#39;odoo.addons.base.models.ir_asset&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_34</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irassetsec&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/test_assetsbundle/__manifest__.py&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.irassetsec&#39;</span><span class="p">)</span>
        <span class="n">links</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">get_links</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">links</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_35">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_35">[docs]</a>
    <span class="nd">@mute_logger</span><span class="p">(</span><span class="s1">&#39;odoo.addons.base.models.ir_asset&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_35</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irassetsec&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/test_assetsbundle/data/ir_asset.xml&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_paths</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.irassetsec&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;/test_assetsbundle/data/ir_asset.xml&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;test_assetsbundle.irassetsec&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)])</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_36">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_36">[docs]</a>
    <span class="k">def</span> <span class="nf">test_36</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irassetsec&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;/test_assetsbundle/static/accessible.xml&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_paths</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.irassetsec&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">modified</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>

        <span class="n">base_path</span> <span class="o">=</span> <span class="vm">__file__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/tests/test_assetsbundle.py&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="p">[(</span>
            <span class="s1">&#39;/test_assetsbundle/static/accessible.xml&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_path</span><span class="si">}</span><span class="s1">/static/accessible.xml&#39;</span><span class="p">,</span>
            <span class="s1">&#39;test_assetsbundle.irassetsec&#39;</span><span class="p">,</span>
            <span class="n">modified</span>
        <span class="p">)])</span></div>


<div class="viewcode-block" id="TestAssetsManifest.test_37_path_can_be_an_attachment">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestAssetsManifest.test_37_path_can_be_an_attachment">[docs]</a>
    <span class="k">def</span> <span class="nf">test_37_path_can_be_an_attachment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">scss_code</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            .my_div {</span>
<span class="s2">                &amp;.subdiv {</span>
<span class="s2">                    color: blue;</span>
<span class="s2">                }</span>
<span class="s2">            }</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.attachment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;my custom scss&#39;</span><span class="p">,</span>
            <span class="s1">&#39;mimetype&#39;</span><span class="p">:</span> <span class="s1">&#39;text/scss&#39;</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>
            <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle/my_style_attach.scss&#39;</span><span class="p">,</span>
            <span class="s1">&#39;datas&#39;</span><span class="p">:</span> <span class="n">scss_code</span>
        <span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle.irasset_custom_attach&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle/my_style_attach.scss&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;test_assetsbundle.irasset_custom_attach&#39;</span><span class="p">)</span>
        <span class="n">attach</span> <span class="o">=</span> <span class="n">bundle</span><span class="o">.</span><span class="n">css</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">attach</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="c1"># The scss should be compiled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStringEqual</span><span class="p">(</span>
            <span class="n">content</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            /* test_assetsbundle/my_style_attach.scss */</span>
<span class="sd">             .my_div.subdiv{color: blue;}</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="p">)</span></div>
</div>


<div class="viewcode-block" id="AssetsNodeOrmCacheUsage">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.AssetsNodeOrmCacheUsage">[docs]</a>
<span class="nd">@tagged</span><span class="p">(</span><span class="s1">&#39;-at_install&#39;</span><span class="p">,</span> <span class="s1">&#39;post_install&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">AssetsNodeOrmCacheUsage</span><span class="p">(</span><span class="n">TransactionCase</span><span class="p">):</span>

<div class="viewcode-block" id="AssetsNodeOrmCacheUsage.cache_keys">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.AssetsNodeOrmCacheUsage.cache_keys">[docs]</a>
    <span class="k">def</span> <span class="nf">cache_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">_Registry__caches</span><span class="p">[</span><span class="s1">&#39;assets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">d</span>

        <span class="n">asset_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span> <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ir.asset&#39;</span> <span class="ow">and</span> <span class="s1">&#39;_get_asset_paths&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="c1"># ignore topological sort entry</span>
        <span class="n">qweb_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span> <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">asset_keys</span><span class="p">,</span> <span class="n">qweb_keys</span></div>


<div class="viewcode-block" id="AssetsNodeOrmCacheUsage.test_assets_node_orm_cache_usage_debug">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.AssetsNodeOrmCacheUsage.test_assets_node_orm_cache_usage_debug">[docs]</a>
    <span class="k">def</span> <span class="nf">test_assets_node_orm_cache_usage_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">(</span><span class="s1">&#39;assets&#39;</span><span class="p">)</span>

        <span class="n">asset_keys</span><span class="p">,</span> <span class="n">qweb_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asset_keys</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qweb_keys</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_nodes</span><span class="p">(</span><span class="s1">&#39;web.assets_backend&#39;</span><span class="p">)</span>

        <span class="n">asset_keys</span><span class="p">,</span> <span class="n">qweb_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asset_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qweb_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_nodes</span><span class="p">(</span><span class="s1">&#39;web.assets_backend&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="s1">&#39;tests&#39;</span><span class="p">)</span>
        <span class="n">asset_keys</span><span class="p">,</span> <span class="n">qweb_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asset_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qweb_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_nodes</span><span class="p">(</span><span class="s1">&#39;web.assets_backend&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
        <span class="n">asset_keys</span><span class="p">,</span> <span class="n">qweb_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asset_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qweb_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># in debug=assets, the ormcache is not used for _generate_asset_links_cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_nodes</span><span class="p">(</span><span class="s1">&#39;web.assets_backend&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="s1">&#39;assets&#39;</span><span class="p">)</span>
        <span class="n">asset_keys</span><span class="p">,</span> <span class="n">qweb_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asset_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qweb_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="AssetsNodeOrmCacheUsage.test_assets_node_orm_cache_usage_file_type">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.AssetsNodeOrmCacheUsage.test_assets_node_orm_cache_usage_file_type">[docs]</a>
    <span class="k">def</span> <span class="nf">test_assets_node_orm_cache_usage_file_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">(</span><span class="s1">&#39;assets&#39;</span><span class="p">)</span>

        <span class="n">asset_keys</span><span class="p">,</span> <span class="n">qweb_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asset_keys</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qweb_keys</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_nodes</span><span class="p">(</span><span class="s1">&#39;web.assets_backend&#39;</span><span class="p">,</span> <span class="n">js</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">css</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">asset_keys</span><span class="p">,</span> <span class="n">qweb_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asset_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qweb_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_nodes</span><span class="p">(</span><span class="s1">&#39;web.assets_backend&#39;</span><span class="p">,</span> <span class="n">js</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">css</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">asset_keys</span><span class="p">,</span> <span class="n">qweb_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asset_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qweb_keys</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># NOTE: this result is not really desired but this is the current behaviour. In practice, we usually only generate one of them.</span>
        <span class="c1"># This could be enforced or avoided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_nodes</span><span class="p">(</span><span class="s1">&#39;web.assets_backend&#39;</span><span class="p">,</span> <span class="n">js</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">css</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">asset_keys</span><span class="p">,</span> <span class="n">qweb_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asset_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qweb_keys</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span></div>



<div class="viewcode-block" id="AssetsNodeOrmCacheUsage.test_assets_node_orm_cache_usage_lang">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.AssetsNodeOrmCacheUsage.test_assets_node_orm_cache_usage_lang">[docs]</a>
    <span class="k">def</span> <span class="nf">test_assets_node_orm_cache_usage_lang</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">(</span><span class="s1">&#39;assets&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.lang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_activate_lang</span><span class="p">(</span><span class="s1">&#39;ar_SY&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.lang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_activate_lang</span><span class="p">(</span><span class="s1">&#39;fr_FR&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.lang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_activate_lang</span><span class="p">(</span><span class="s1">&#39;en_US&#39;</span><span class="p">)</span>

        <span class="n">asset_keys</span><span class="p">,</span> <span class="n">qweb_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asset_keys</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qweb_keys</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="s1">&#39;fr_FR&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_get_asset_nodes</span><span class="p">(</span><span class="s1">&#39;web.assets_backend&#39;</span><span class="p">)</span>
        <span class="n">asset_keys</span><span class="p">,</span> <span class="n">qweb_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asset_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qweb_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="s1">&#39;en_US&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_get_asset_nodes</span><span class="p">(</span><span class="s1">&#39;web.assets_backend&#39;</span><span class="p">)</span>
        <span class="n">asset_keys</span><span class="p">,</span> <span class="n">qweb_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asset_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qweb_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="s1">&#39;ar_SY&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">_get_asset_nodes</span><span class="p">(</span><span class="s1">&#39;web.assets_backend&#39;</span><span class="p">)</span>
        <span class="n">asset_keys</span><span class="p">,</span> <span class="n">qweb_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asset_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qweb_keys</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># a second cache entry is created for rtl</span></div>


<div class="viewcode-block" id="AssetsNodeOrmCacheUsage.test_assets_node_orm_cache_usage_website">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.AssetsNodeOrmCacheUsage.test_assets_node_orm_cache_usage_website">[docs]</a>
    <span class="k">def</span> <span class="nf">test_assets_node_orm_cache_usage_website</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.module.module&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;website&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;uninstalled&#39;</span><span class="p">)]):</span>
            <span class="k">return</span>  <span class="c1"># only makes sence if website is installed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">(</span><span class="s1">&#39;assets&#39;</span><span class="p">)</span>

        <span class="n">asset_keys</span><span class="p">,</span> <span class="n">qweb_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asset_keys</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qweb_keys</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">website_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">_get_asset_nodes</span><span class="p">(</span><span class="s1">&#39;web.assets_backend&#39;</span><span class="p">)</span>
        <span class="n">asset_keys</span><span class="p">,</span> <span class="n">qweb_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asset_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qweb_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">website_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">_get_asset_nodes</span><span class="p">(</span><span class="s1">&#39;web.assets_backend&#39;</span><span class="p">)</span>
        <span class="n">asset_keys</span><span class="p">,</span> <span class="n">qweb_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asset_keys</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># the content may be different for different websites, even if it is not always the case</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qweb_keys</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="AssetsNodeOrmCacheUsage.test_assets_node_orm_cache_usage_node_flags">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.AssetsNodeOrmCacheUsage.test_assets_node_orm_cache_usage_node_flags">[docs]</a>
    <span class="k">def</span> <span class="nf">test_assets_node_orm_cache_usage_node_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">(</span><span class="s1">&#39;assets&#39;</span><span class="p">)</span>

        <span class="n">asset_keys</span><span class="p">,</span> <span class="n">qweb_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asset_keys</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qweb_keys</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_nodes</span><span class="p">(</span><span class="s1">&#39;web.assets_backend&#39;</span><span class="p">)</span>
        <span class="n">asset_keys</span><span class="p">,</span> <span class="n">qweb_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asset_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qweb_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_nodes</span><span class="p">(</span><span class="s1">&#39;web.assets_backend&#39;</span><span class="p">,</span> <span class="n">media</span><span class="o">=</span><span class="s1">&#39;print&#39;</span><span class="p">)</span>
        <span class="n">asset_keys</span><span class="p">,</span> <span class="n">qweb_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asset_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;media shouldn&#39;t create another entry&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qweb_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;media shouldn&#39;t create another entry&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_nodes</span><span class="p">(</span><span class="s1">&#39;web.assets_backend&#39;</span><span class="p">,</span> <span class="n">defer_load</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">asset_keys</span><span class="p">,</span> <span class="n">qweb_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asset_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;defer_load shouldn&#39;t create another entry&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qweb_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;defer_load shouldn&#39;t create another entry&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_nodes</span><span class="p">(</span><span class="s1">&#39;web.assets_backend&#39;</span><span class="p">,</span> <span class="n">lazy_load</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">asset_keys</span><span class="p">,</span> <span class="n">qweb_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">asset_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;lazy_load shouldn&#39;t create another entry&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qweb_keys</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;lazy_load shouldn&#39;t create another entry&quot;</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="TestErrorManagement">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestErrorManagement">[docs]</a>
<span class="nd">@tagged</span><span class="p">(</span><span class="s1">&#39;-at_install&#39;</span><span class="p">,</span> <span class="s1">&#39;post_install&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestErrorManagement</span><span class="p">(</span><span class="n">HttpCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestErrorManagement.test_assets_bundle_css_error_backend">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestErrorManagement.test_assets_bundle_css_error_backend">[docs]</a>
    <span class="k">def</span> <span class="nf">test_assets_bundle_css_error_backend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;web.assets_backend&#39;</span><span class="p">,</span> <span class="n">assets_params</span><span class="o">=</span><span class="p">{})</span><span class="o">.</span><span class="n">css</span><span class="p">()</span> <span class="c1"># force pregeneration so that we have the base style</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Css error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;web.assets_backend&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle/static/src/css/test_error.scss&#39;</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="k">with</span> <span class="n">mute_logger</span><span class="p">(</span><span class="s1">&#39;odoo.addons.base.models.assetsbundle&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_tour</span><span class="p">(</span><span class="s1">&#39;/web&#39;</span><span class="p">,</span> <span class="s1">&#39;css_error_tour&#39;</span><span class="p">,</span> <span class="n">login</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestErrorManagement.test_assets_bundle_css_error_frontend">
<a class="viewcode-back" href="../../../../../odoo.addons.test_assetsbundle.tests.html#odoo.addons.test_assetsbundle.tests.test_assetsbundle.TestErrorManagement.test_assets_bundle_css_error_frontend">[docs]</a>
    <span class="k">def</span> <span class="nf">test_assets_bundle_css_error_frontend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.qweb&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_asset_bundle</span><span class="p">(</span><span class="s1">&#39;web.assets_frontend&#39;</span><span class="p">,</span> <span class="n">assets_params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;website_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;website&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([],</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">})</span><span class="o">.</span><span class="n">css</span><span class="p">()</span> <span class="c1"># force pregeneration so that we have the base style</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.asset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Css error&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bundle&#39;</span><span class="p">:</span> <span class="s1">&#39;web.assets_frontend&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;test_assetsbundle/static/src/css/test_error.scss&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">with</span> <span class="n">mute_logger</span><span class="p">(</span><span class="s1">&#39;odoo.addons.base.models.assetsbundle&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_tour</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;css_error_tour_frontend&#39;</span><span class="p">,</span> <span class="n">login</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Amr.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>