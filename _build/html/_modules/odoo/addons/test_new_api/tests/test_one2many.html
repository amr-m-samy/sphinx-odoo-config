<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>odoo.addons.test_new_api.tests.test_one2many &mdash; Amr  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Amr
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modules.html">odoo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Amr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../../odoo.html">odoo</a></li>
      <li class="breadcrumb-item active">odoo.addons.test_new_api.tests.test_one2many</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for odoo.addons.test_new_api.tests.test_one2many</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">odoo.tests.common</span> <span class="kn">import</span> <span class="n">TransactionCase</span>
<span class="kn">from</span> <span class="nn">odoo.exceptions</span> <span class="kn">import</span> <span class="n">MissingError</span><span class="p">,</span> <span class="n">UserError</span>
<span class="kn">from</span> <span class="nn">odoo</span> <span class="kn">import</span> <span class="n">Command</span>
<span class="kn">from</span> <span class="nn">odoo.tools</span> <span class="kn">import</span> <span class="n">mute_logger</span>


<div class="viewcode-block" id="One2manyCase">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase">[docs]</a>
<span class="k">class</span> <span class="nc">One2manyCase</span><span class="p">(</span><span class="n">TransactionCase</span><span class="p">):</span>
<div class="viewcode-block" id="One2manyCase.setUp">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.setUp">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">One2manyCase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;test_new_api.multi.line&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;test_new_api.multi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;What is up?&quot;</span>
        <span class="p">})</span>

        <span class="c1"># data for One2many with inverse field Integer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Edition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;test_new_api.creativework.edition&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Book</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;test_new_api.creativework.book&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Movie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;test_new_api.creativework.movie&quot;</span><span class="p">]</span>

        <span class="n">book_model_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Book</span><span class="o">.</span><span class="n">_name</span><span class="p">)])</span><span class="o">.</span><span class="n">id</span>
        <span class="n">movie_model_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Movie</span><span class="o">.</span><span class="n">_name</span><span class="p">)])</span><span class="o">.</span><span class="n">id</span>

        <span class="n">books_data</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;Imaginary book&#39;</span><span class="p">,</span> <span class="p">()),</span>
            <span class="p">(</span><span class="s1">&#39;Another imaginary book&#39;</span><span class="p">,</span> <span class="p">()),</span>
            <span class="p">(</span><span class="s1">&#39;Nineteen Eighty Four&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;First edition&#39;</span><span class="p">,</span> <span class="s1">&#39;Fourth Edition&#39;</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="n">movies_data</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;The Gold Rush&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;1925 (silent)&#39;</span><span class="p">,</span> <span class="s1">&#39;1942&#39;</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">&#39;Imaginary movie&#39;</span><span class="p">,</span> <span class="p">()),</span>
            <span class="p">(</span><span class="s1">&#39;Another imaginary movie&#39;</span><span class="p">,</span> <span class="p">())</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">editions</span> <span class="ow">in</span> <span class="n">books_data</span><span class="p">:</span>
            <span class="n">book_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Book</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">})</span><span class="o">.</span><span class="n">id</span>
            <span class="k">for</span> <span class="n">edition</span> <span class="ow">in</span> <span class="n">editions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Edition</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;res_model_id&#39;</span><span class="p">:</span> <span class="n">book_model_id</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">edition</span><span class="p">,</span> <span class="s1">&#39;res_id&#39;</span><span class="p">:</span> <span class="n">book_id</span><span class="p">})</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">editions</span> <span class="ow">in</span> <span class="n">movies_data</span><span class="p">:</span>
            <span class="n">movie_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Movie</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">})</span><span class="o">.</span><span class="n">id</span>
            <span class="k">for</span> <span class="n">edition</span> <span class="ow">in</span> <span class="n">editions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Edition</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;res_model_id&#39;</span><span class="p">:</span> <span class="n">movie_model_id</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">edition</span><span class="p">,</span> <span class="s1">&#39;res_id&#39;</span><span class="p">:</span> <span class="n">movie_id</span><span class="p">})</span></div>


<div class="viewcode-block" id="One2manyCase.operations">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.operations">[docs]</a>
    <span class="k">def</span> <span class="nf">operations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run operations on o2m fields to check all works fine.&quot;&quot;&quot;</span>
        <span class="c1"># Check the lines first</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertItemsEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)])</span>
        <span class="c1"># Modify the first line and drop the last one</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">lines</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">lines</span><span class="p">),</span> <span class="mi">9</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># Invalidate the cache and check again; this crashes if the value</span>
        <span class="c1"># of self.multi.lines in cache contains new records</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">lines</span><span class="p">),</span> <span class="mi">9</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="One2manyCase.test_new_one_by_one">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.test_new_one_by_one">[docs]</a>
    <span class="k">def</span> <span class="nf">test_new_one_by_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check lines created with ``new()`` and appended one by one.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">lines</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Line</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operations</span><span class="p">()</span></div>


<div class="viewcode-block" id="One2manyCase.test_new_single">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.test_new_single">[docs]</a>
    <span class="k">def</span> <span class="nf">test_new_single</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check lines created with ``new()`` and added in one step.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Line</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Line</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)})</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operations</span><span class="p">()</span></div>


<div class="viewcode-block" id="One2manyCase.test_create_one_by_one">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.test_create_one_by_one">[docs]</a>
    <span class="k">def</span> <span class="nf">test_create_one_by_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check lines created with ``create()`` and appended one by one.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">lines</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Line</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operations</span><span class="p">()</span></div>


<div class="viewcode-block" id="One2manyCase.test_create_single">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.test_create_single">[docs]</a>
    <span class="k">def</span> <span class="nf">test_create_single</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check lines created with ``create()`` and added in one step.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Line</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Line</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)})</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operations</span><span class="p">()</span></div>


<div class="viewcode-block" id="One2manyCase.test_rpcstyle_one_by_one">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.test_rpcstyle_one_by_one">[docs]</a>
    <span class="k">def</span> <span class="nf">test_rpcstyle_one_by_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check lines created with RPC style and appended one by one.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)})]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operations</span><span class="p">()</span></div>


<div class="viewcode-block" id="One2manyCase.test_rpcstyle_one_by_one_on_new">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.test_rpcstyle_one_by_one_on_new">[docs]</a>
    <span class="k">def</span> <span class="nf">test_rpcstyle_one_by_one_on_new</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;test_new_api.multi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;What is up?&quot;</span>
        <span class="p">})</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)})]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operations</span><span class="p">()</span></div>


<div class="viewcode-block" id="One2manyCase.test_rpcstyle_single">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.test_rpcstyle_single">[docs]</a>
    <span class="k">def</span> <span class="nf">test_rpcstyle_single</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check lines created with RPC style and added in one step&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)})</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operations</span><span class="p">()</span></div>


<div class="viewcode-block" id="One2manyCase.test_rpcstyle_single_on_new">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.test_rpcstyle_single_on_new">[docs]</a>
    <span class="k">def</span> <span class="nf">test_rpcstyle_single_on_new</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;test_new_api.multi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;What is up?&quot;</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)})</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operations</span><span class="p">()</span></div>


<div class="viewcode-block" id="One2manyCase.test_many2one_integer">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.test_many2one_integer">[docs]</a>
    <span class="k">def</span> <span class="nf">test_many2one_integer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test several models one2many with same inverse Integer field&quot;&quot;&quot;</span>
        <span class="c1"># utility function to convert records to tuples with id,name</span>
        <span class="n">t</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">records</span><span class="p">:</span> <span class="n">records</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="n">books</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Book</span><span class="o">.</span><span class="n">search</span><span class="p">([])</span>
        <span class="n">books_with_edition</span> <span class="o">=</span> <span class="n">books</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">editions</span><span class="p">)</span>
        <span class="n">movies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Movie</span><span class="o">.</span><span class="n">search</span><span class="p">([])</span>
        <span class="n">movies_without_edition</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">editions</span><span class="p">)</span>
        <span class="n">movies_with_edition</span> <span class="o">=</span> <span class="n">movies</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">editions</span><span class="p">)</span>
        <span class="n">movie_editions</span> <span class="o">=</span> <span class="n">movies_with_edition</span><span class="o">.</span><span class="n">editions</span>
        <span class="n">one_movie_edition</span> <span class="o">=</span> <span class="n">movie_editions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">res_movies_without_edition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Movie</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;editions&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertItemsEqual</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">res_movies_without_edition</span><span class="p">),</span> <span class="n">t</span><span class="p">(</span><span class="n">movies_without_edition</span><span class="p">))</span>

        <span class="n">res_movies_with_edition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Movie</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;editions&#39;</span><span class="p">,</span> <span class="s1">&#39;!=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertItemsEqual</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">res_movies_with_edition</span><span class="p">),</span> <span class="n">t</span><span class="p">(</span><span class="n">movies_with_edition</span><span class="p">))</span>

        <span class="n">res_books_with_movie_edition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Book</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;editions&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">movie_editions</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">res_books_with_movie_edition</span><span class="p">))</span>

        <span class="n">res_books_without_movie_edition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Book</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;editions&#39;</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">,</span> <span class="n">movie_editions</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertItemsEqual</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">res_books_without_movie_edition</span><span class="p">),</span> <span class="n">t</span><span class="p">(</span><span class="n">books</span><span class="p">))</span>

        <span class="n">res_books_without_one_movie_edition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Book</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;editions&#39;</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">,</span> <span class="n">movie_editions</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertItemsEqual</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">res_books_without_one_movie_edition</span><span class="p">),</span> <span class="n">t</span><span class="p">(</span><span class="n">books</span><span class="p">))</span>

        <span class="n">res_books_with_one_movie_edition_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Book</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;editions&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">movie_editions</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">res_books_with_one_movie_edition_name</span><span class="p">))</span>

        <span class="n">res_books_without_one_movie_edition_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Book</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;editions&#39;</span><span class="p">,</span> <span class="s1">&#39;!=&#39;</span><span class="p">,</span> <span class="n">movie_editions</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertItemsEqual</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">res_books_without_one_movie_edition_name</span><span class="p">),</span> <span class="n">t</span><span class="p">(</span><span class="n">books</span><span class="p">))</span>

        <span class="n">res_movies_not_of_edition_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Movie</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;editions&#39;</span><span class="p">,</span> <span class="s1">&#39;!=&#39;</span><span class="p">,</span> <span class="n">one_movie_edition</span><span class="o">.</span><span class="n">name</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertItemsEqual</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">res_movies_not_of_edition_name</span><span class="p">),</span> <span class="n">t</span><span class="p">(</span><span class="n">movies</span><span class="o">.</span><span class="n">filtered</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">one_movie_edition</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">editions</span><span class="p">)))</span></div>


<div class="viewcode-block" id="One2manyCase.test_merge_partner">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.test_merge_partner">[docs]</a>
    <span class="k">def</span> <span class="nf">test_merge_partner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.field_with_caps&#39;</span><span class="p">]</span>
        <span class="n">partner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.partner&#39;</span><span class="p">]</span>

        <span class="n">p1</span> <span class="o">=</span> <span class="n">partner</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test1&#39;</span><span class="p">})</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">partner</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test2&#39;</span><span class="p">})</span>

        <span class="n">model1</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;pArTneR_321_id&#39;</span><span class="p">:</span> <span class="n">p1</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="n">model2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;pArTneR_321_id&#39;</span><span class="p">:</span> <span class="n">p2</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;base.partner.merge.automatic.wizard&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_merge</span><span class="p">((</span><span class="n">p1</span> <span class="o">+</span> <span class="n">p2</span><span class="p">)</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">model1</span><span class="o">.</span><span class="n">pArTneR_321_id</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">model2</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">model2</span><span class="o">.</span><span class="n">pArTneR_321_id</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span></div>


<div class="viewcode-block" id="One2manyCase.test_merge_partner_archived">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.test_merge_partner_archived">[docs]</a>
    <span class="k">def</span> <span class="nf">test_merge_partner_archived</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">partner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.partner&#39;</span><span class="p">]</span>

        <span class="n">p1</span> <span class="o">=</span> <span class="n">partner</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test1&#39;</span><span class="p">})</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">partner</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test2&#39;</span><span class="p">})</span>
        <span class="n">p3</span> <span class="o">=</span> <span class="n">partner</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test3&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
        <span class="n">partners_ids</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1</span> <span class="o">+</span> <span class="n">p2</span> <span class="o">+</span> <span class="n">p3</span><span class="p">)</span>

        <span class="n">wizard</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;base.partner.merge.automatic.wizard&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_ids</span><span class="o">=</span><span class="n">partners_ids</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">active_model</span><span class="o">=</span><span class="s1">&#39;res.partner&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wizard</span><span class="o">.</span><span class="n">partner_ids</span><span class="p">,</span> <span class="n">partners_ids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">wizard</span><span class="o">.</span><span class="n">dst_partner_id</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>

        <span class="n">wizard</span><span class="o">.</span><span class="n">action_merge</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">p3</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span></div>


<div class="viewcode-block" id="One2manyCase.test_partner_merge_wizard_more_than_one_user_error">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.test_partner_merge_wizard_more_than_one_user_error">[docs]</a>
    <span class="k">def</span> <span class="nf">test_partner_merge_wizard_more_than_one_user_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Test that partners cannot be merged if linked to more than one user even if only one is active. &quot;&quot;&quot;</span>
        <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">dst_partner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.partner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">([{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;test</span><span class="si">{</span><span class="n">idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
        <span class="n">u1</span><span class="p">,</span> <span class="n">u2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">([{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test1&#39;</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="s1">&#39;test1&#39;</span><span class="p">,</span> <span class="s1">&#39;partner_id&#39;</span><span class="p">:</span> <span class="n">p1</span><span class="o">.</span><span class="n">id</span><span class="p">},</span>
                                               <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test2&#39;</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="s1">&#39;test2&#39;</span><span class="p">,</span> <span class="s1">&#39;partner_id&#39;</span><span class="p">:</span> <span class="n">p2</span><span class="o">.</span><span class="n">id</span><span class="p">}])</span>
        <span class="n">MergeWizard_with_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;base.partner.merge.automatic.wizard&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span>
            <span class="n">active_ids</span><span class="o">=</span><span class="p">(</span><span class="n">u1</span><span class="o">.</span><span class="n">partner_id</span> <span class="o">+</span> <span class="n">u2</span><span class="o">.</span><span class="n">partner_id</span> <span class="o">+</span> <span class="n">dst_partner</span><span class="p">)</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">active_model</span><span class="o">=</span><span class="s1">&#39;res.partner&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">UserError</span><span class="p">):</span>
            <span class="n">MergeWizard_with_context</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span><span class="o">.</span><span class="n">action_merge</span><span class="p">()</span>

        <span class="n">u2</span><span class="o">.</span><span class="n">action_archive</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">UserError</span><span class="p">):</span>
            <span class="n">MergeWizard_with_context</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span><span class="o">.</span><span class="n">action_merge</span><span class="p">()</span>

        <span class="n">u2</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="n">MergeWizard_with_context</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span><span class="o">.</span><span class="n">action_merge</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">dst_partner</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">u1</span><span class="o">.</span><span class="n">partner_id</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">dst_partner</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></div>


<div class="viewcode-block" id="One2manyCase.test_cache_invalidation">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.test_cache_invalidation">[docs]</a>
    <span class="k">def</span> <span class="nf">test_cache_invalidation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Cache invalidation for one2many with integer inverse. &quot;&quot;&quot;</span>
        <span class="n">record0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.attachment.host&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">record0</span><span class="o">.</span><span class="n">attachment_ids</span><span class="p">,</span> <span class="s2">&quot;inconsistent cache&quot;</span><span class="p">)</span>

        <span class="c1"># creating attachment must compute name and invalidate attachment_ids</span>
        <span class="n">attachment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.attachment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;res_model&#39;</span><span class="p">:</span> <span class="n">record0</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
            <span class="s1">&#39;res_id&#39;</span><span class="p">:</span> <span class="n">record0</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">attachment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">record0</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span>
                             <span class="s2">&quot;field should be computed&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record0</span><span class="o">.</span><span class="n">attachment_ids</span><span class="p">,</span> <span class="n">attachment</span><span class="p">,</span> <span class="s2">&quot;inconsistent cache&quot;</span><span class="p">)</span>

        <span class="c1"># creating a host should not attempt to recompute attachment.name</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">record1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.attachment.host&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="c1"># field res_id should not have been invalidated</span>
            <span class="n">attachment</span><span class="o">.</span><span class="n">res_id</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">record1</span><span class="o">.</span><span class="n">attachment_ids</span><span class="p">,</span> <span class="s2">&quot;inconsistent cache&quot;</span><span class="p">)</span>

        <span class="c1"># writing on res_id must recompute name and invalidate attachment_ids</span>
        <span class="n">attachment</span><span class="o">.</span><span class="n">res_id</span> <span class="o">=</span> <span class="n">record1</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">attachment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">record1</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span>
                             <span class="s2">&quot;field should be recomputed&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record1</span><span class="o">.</span><span class="n">attachment_ids</span><span class="p">,</span> <span class="n">attachment</span><span class="p">,</span> <span class="s2">&quot;inconsistent cache&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">record0</span><span class="o">.</span><span class="n">attachment_ids</span><span class="p">,</span> <span class="s2">&quot;inconsistent cache&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="One2manyCase.test_recompute">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.test_recompute">[docs]</a>
    <span class="k">def</span> <span class="nf">test_recompute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test recomputation of fields that indirecly depend on one2many &quot;&quot;&quot;</span>
        <span class="n">discussion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.discussion_0&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">discussion</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span>

        <span class="c1"># detach message from discussion</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">discussion</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">message</span><span class="o">.</span><span class="n">discussion</span> <span class="o">=</span> <span class="kc">False</span></div>


        <span class="c1"># DLE P54: a computed stored field should not depend on the context</span>
        <span class="c1"># writing on the one2many and actually modifying the relation must</span>
        <span class="c1"># trigger recomputation of fields that depend on its inverse many2one</span>
        <span class="c1"># self.assertNotIn(message, discussion.messages)</span>
        <span class="c1"># discussion.with_context(compute_name=&#39;X&#39;).write({&#39;messages&#39;: [(4, message.id)]})</span>
        <span class="c1"># self.assertEqual(message.name, &#39;X&#39;)</span>

        <span class="c1"># writing on the one2many without modifying the relation should not</span>
        <span class="c1"># trigger recomputation of fields that depend on its inverse many2one</span>
        <span class="c1"># self.assertIn(message, discussion.messages)</span>
        <span class="c1"># discussion.with_context(compute_name=&#39;Y&#39;).write({&#39;messages&#39;: [(4, message.id)]})</span>
        <span class="c1"># self.assertEqual(message.name, &#39;X&#39;)</span>

<div class="viewcode-block" id="One2manyCase.test_dont_write_the_existing_childs">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.test_dont_write_the_existing_childs">[docs]</a>
    <span class="k">def</span> <span class="nf">test_dont_write_the_existing_childs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test that the existing child should not be changed when adding a new child to the parent.</span>
<span class="sd">        This is the behaviour of the form view.&quot;&quot;&quot;</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_parent_m2o&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;parent&#39;</span><span class="p">,</span>
            <span class="s1">&#39;child_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">})],</span>
        <span class="p">})</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">child_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;child_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;B&#39;</span><span class="p">})]})</span></div>


<div class="viewcode-block" id="One2manyCase.test_create_with_commands">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.test_create_with_commands">[docs]</a>
    <span class="k">def</span> <span class="nf">test_create_with_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># create lines and warm up caches</span>
        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;line_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;product&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">})</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="s1">&#39;sept&#39;</span><span class="p">)],</span>
        <span class="p">})</span>
        <span class="n">line1</span><span class="p">,</span> <span class="n">line2</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">line_ids</span>

        <span class="c1"># INSERT, UPDATE of line1</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
                <span class="s1">&#39;line_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">line1</span><span class="o">.</span><span class="n">ids</span><span class="p">)],</span>
            <span class="p">})</span>

        <span class="c1"># INSERT order, INSERT thief, UPDATE of line1+line2</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
                <span class="s1">&#39;line_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">line1</span><span class="o">.</span><span class="n">ids</span><span class="p">)],</span>
            <span class="p">})</span>
            <span class="n">thief</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
                <span class="s1">&#39;line_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">set</span><span class="p">((</span><span class="n">line1</span> <span class="o">+</span> <span class="n">line2</span><span class="p">)</span><span class="o">.</span><span class="n">ids</span><span class="p">)],</span>
            <span class="p">})</span>

        <span class="c1"># the lines have been stolen by thief</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">line_ids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">thief</span><span class="o">.</span><span class="n">line_ids</span><span class="p">,</span> <span class="n">line1</span> <span class="o">+</span> <span class="n">line2</span><span class="p">)</span></div>


<div class="viewcode-block" id="One2manyCase.test_recomputation_ends">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.test_recomputation_ends">[docs]</a>
    <span class="k">def</span> <span class="nf">test_recomputation_ends</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Regression test for neverending recomputation. &quot;&quot;&quot;</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_parent_m2o&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;parent&#39;</span><span class="p">})</span>
        <span class="n">child</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_child_m2o&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">size1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

        <span class="c1"># delete parent, and check that recomputation ends</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span></div>


<div class="viewcode-block" id="One2manyCase.test_compute_stored_many2one_one2many">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.test_compute_stored_many2one_one2many">[docs]</a>
    <span class="k">def</span> <span class="nf">test_compute_stored_many2one_one2many</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.compute.container&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">member_ids</span><span class="p">)</span>
        <span class="n">member</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.compute.member&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">})</span>
        <span class="c1"># at this point, member.container_id must be computed for member to</span>
        <span class="c1"># appear in container.member_ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">member_ids</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">member_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Changing member.name will trigger recomputing member.container_id,</span>
        <span class="c1"># container.member_ids and container.member_count. Since we are setting</span>
        <span class="c1"># the name to bar, it will be detached from container, resulting in a</span>
        <span class="c1"># member_count of zero on the container.</span>
        <span class="n">member</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Bar&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">member_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Reattach member to container again</span>
        <span class="n">member</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Foo&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">member_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="One2manyCase.test_reward_line_delete">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.test_reward_line_delete">[docs]</a>
    <span class="k">def</span> <span class="nf">test_reward_line_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;line_ids&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;product&#39;</span><span class="p">:</span> <span class="s1">&#39;a&#39;</span><span class="p">}),</span>
                <span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;product&#39;</span><span class="p">:</span> <span class="s1">&#39;b&#39;</span><span class="p">}),</span>
                <span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;product&#39;</span><span class="p">:</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;reward&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}),</span>
            <span class="p">],</span>
        <span class="p">})</span>
        <span class="n">line0</span><span class="p">,</span> <span class="n">line1</span><span class="p">,</span> <span class="n">line2</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">line_ids</span>

        <span class="c1"># this is what the client sends to delete the 2nd line; it should not</span>
        <span class="c1"># crash when deleting the 2nd line automatically deletes the 3rd line</span>
        <span class="n">order</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
            <span class="s1">&#39;line_ids&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">line0</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                <span class="n">Command</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">line1</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                <span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">line2</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
            <span class="p">],</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">line_ids</span><span class="p">,</span> <span class="n">line0</span><span class="p">)</span>

        <span class="c1"># but linking a missing line on purpose is an error</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">MissingError</span><span class="p">):</span>
            <span class="n">order</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
                <span class="s1">&#39;line_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">line0</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">line1</span><span class="o">.</span><span class="n">id</span><span class="p">)],</span>
            <span class="p">})</span></div>


<div class="viewcode-block" id="One2manyCase.test_new_real_interactions">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.test_new_real_interactions">[docs]</a>
    <span class="k">def</span> <span class="nf">test_new_real_interactions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Test and specify the interactions between new and real records.</span>
<span class="sd">        Through m2o and o2m, with real/unreal records on both sides, the behavior</span>
<span class="sd">        varies greatly.  At least, the behavior will be clearly consistent and any</span>
<span class="sd">        change will have to adapt the current test.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">##############</span>
        <span class="c1"># REAL - NEW #</span>
        <span class="c1">##############</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_parent_m2o&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;parentB&#39;</span><span class="p">})</span>
        <span class="n">new_child</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_child_m2o&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>

        <span class="c1"># wanted behavior: when creating a new with a real parent id, the child</span>
        <span class="c1"># isn&#39;t present in the parent childs until true creation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">child_ids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_child</span><span class="o">.</span><span class="n">parent_id</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>

        <span class="c1"># current (wanted?) behavior: when adding a new record to a real record</span>
        <span class="c1"># o2m, the record is created, but not linked to the new in cache</span>
        <span class="c1"># REAL.O2M += NEW RECORD</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">child_ids</span> <span class="o">+=</span> <span class="n">new_child</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">child_ids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">child_ids</span><span class="p">,</span> <span class="n">new_child</span><span class="p">)</span>

        <span class="c1">#############</span>
        <span class="c1"># NEW - NEW #</span>
        <span class="c1">#############</span>
        <span class="c1"># wanted behavior: linking new records to new records is totally fine</span>
        <span class="n">new_parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_parent_m2o&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s1">&#39;parentC3PO&#39;</span><span class="p">,</span>
            <span class="s2">&quot;child_ids&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;C3&quot;</span><span class="p">})],</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_parent</span><span class="p">,</span> <span class="n">new_parent</span><span class="o">.</span><span class="n">child_ids</span><span class="o">.</span><span class="n">parent_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_parent</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">new_parent</span><span class="o">.</span><span class="n">child_ids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_parent</span><span class="o">.</span><span class="n">child_ids</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>

        <span class="n">new_child</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_child_m2o&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;PO&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">new_parent</span><span class="o">.</span><span class="n">child_ids</span> <span class="o">+=</span> <span class="n">new_child</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">new_child</span><span class="p">,</span> <span class="n">new_parent</span><span class="o">.</span><span class="n">child_ids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_parent</span><span class="o">.</span><span class="n">child_ids</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertListEqual</span><span class="p">(</span><span class="n">new_parent</span><span class="o">.</span><span class="n">child_ids</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;C3&#39;</span><span class="p">,</span> <span class="s1">&#39;PO&#39;</span><span class="p">])</span>

        <span class="n">new_child2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_child_m2o&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;R2D2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="n">new_parent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">new_child2</span><span class="p">,</span> <span class="n">new_parent</span><span class="o">.</span><span class="n">child_ids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_parent</span><span class="o">.</span><span class="n">child_ids</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertListEqual</span><span class="p">(</span><span class="n">new_parent</span><span class="o">.</span><span class="n">child_ids</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;C3&#39;</span><span class="p">,</span> <span class="s1">&#39;PO&#39;</span><span class="p">,</span> <span class="s1">&#39;R2D2&#39;</span><span class="p">])</span>

        <span class="c1">###############################</span>
        <span class="c1"># NEW TO REAL CONVERSION TEST #</span>
        <span class="c1">###############################</span>

        <span class="c1"># A bit out of scope, but was interesting to check everything was</span>
        <span class="c1"># working fine on the way.</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">new_parent</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="n">child_ids</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">new_parent</span><span class="p">)</span><span class="o">.</span><span class="n">child_ids</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_parent_m2o&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="o">.</span><span class="n">convert_to_write</span><span class="p">(</span><span class="n">new_parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">new_parent</span><span class="p">),</span>
            <span class="s1">&#39;child_ids&#39;</span><span class="p">:</span> <span class="n">child_ids</span><span class="o">.</span><span class="n">convert_to_write</span><span class="p">(</span><span class="n">new_parent</span><span class="o">.</span><span class="n">child_ids</span><span class="p">,</span> <span class="n">new_parent</span><span class="p">),</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">child_ids</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">parent</span><span class="o">.</span><span class="n">child_ids</span><span class="o">.</span><span class="n">parent_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">child_ids</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;C3&#39;</span><span class="p">,</span> <span class="s1">&#39;PO&#39;</span><span class="p">,</span> <span class="s1">&#39;R2D2&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="One2manyCase.test_parent_id">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.test_parent_id">[docs]</a>
    <span class="k">def</span> <span class="nf">test_parent_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Team</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.team&#39;</span><span class="p">]</span>
        <span class="n">Member</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.team.member&#39;</span><span class="p">]</span>

        <span class="n">team1</span> <span class="o">=</span> <span class="n">Team</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;ORM&#39;</span><span class="p">})</span>
        <span class="n">team2</span> <span class="o">=</span> <span class="n">Team</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Bugfix&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="n">team1</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="n">team3</span> <span class="o">=</span> <span class="n">Team</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Support&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="n">team2</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>

        <span class="n">Member</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Raphael&#39;</span><span class="p">,</span> <span class="s1">&#39;team_id&#39;</span><span class="p">:</span> <span class="n">team1</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="n">member2</span> <span class="o">=</span> <span class="n">Member</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Noura&#39;</span><span class="p">,</span> <span class="s1">&#39;team_id&#39;</span><span class="p">:</span> <span class="n">team3</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="n">Member</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Ivan&#39;</span><span class="p">,</span> <span class="s1">&#39;team_id&#39;</span><span class="p">:</span> <span class="n">team2</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>

        <span class="c1"># In this specific case...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">member2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">member2</span><span class="o">.</span><span class="n">team_id</span><span class="o">.</span><span class="n">parent_id</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># ...we had an infinite recursion on making the following search.</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">Team</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;member_ids&#39;</span><span class="p">,</span> <span class="s1">&#39;child_of&#39;</span><span class="p">,</span> <span class="n">member2</span><span class="o">.</span><span class="n">id</span><span class="p">)])</span>

        <span class="c1"># Also, test a simple infinite loop if record is marked as a parent of itself</span>
        <span class="n">team1</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">=</span> <span class="n">team1</span><span class="o">.</span><span class="n">id</span>
        <span class="c1"># Check that the search is not stuck in the loop</span>
        <span class="n">Team</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_of&#39;</span><span class="p">,</span> <span class="n">team1</span><span class="o">.</span><span class="n">id</span><span class="p">)])</span>
        <span class="n">Team</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;child_of&#39;</span><span class="p">,</span> <span class="n">team1</span><span class="o">.</span><span class="n">id</span><span class="p">)])</span></div>


<div class="viewcode-block" id="One2manyCase.test_create_one2many_with_unsearchable_field">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_one2many.One2manyCase.test_create_one2many_with_unsearchable_field">[docs]</a>
    <span class="nd">@mute_logger</span><span class="p">(</span><span class="s1">&#39;odoo.osv.expression&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_create_one2many_with_unsearchable_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># odoo.osv.expression is muted as reading a non-stored and unsearchable field will log an error and makes the runbot red</span>

        <span class="n">unsearchableO2M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.unsearchable.o2m&#39;</span><span class="p">]</span>

        <span class="c1"># Create a parent record</span>
        <span class="n">parent_record1</span> <span class="o">=</span> <span class="n">unsearchableO2M</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Parent 1&#39;</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="c1"># Create another parent record</span>
        <span class="n">parent_record2</span> <span class="o">=</span> <span class="n">unsearchableO2M</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Parent 2&#39;</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="n">children</span> <span class="o">=</span> <span class="p">{</span><span class="n">parent_record1</span><span class="o">.</span><span class="n">id</span> <span class="p">:</span> <span class="p">[],</span> <span class="n">parent_record2</span><span class="o">.</span><span class="n">id</span> <span class="p">:</span> <span class="p">[]}</span>
        <span class="c1"># Create child records linked to parent_record1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">unsearchableO2M</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Child </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;stored_parent_id&#39;</span><span class="p">:</span> <span class="n">parent_record1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="n">parent_record1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">parent_id</span><span class="p">,</span> <span class="n">parent_record1</span><span class="p">)</span>
            <span class="n">children</span><span class="p">[</span><span class="n">parent_record1</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># Create child records linked to parent_record2</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">unsearchableO2M</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Child </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;stored_parent_id&#39;</span><span class="p">:</span> <span class="n">parent_record2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="n">parent_record2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">parent_id</span><span class="p">,</span> <span class="n">parent_record2</span><span class="p">)</span>
            <span class="n">children</span><span class="p">[</span><span class="n">parent_record2</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># invalidating the cache to force reading one2many again</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>
        <span class="c1"># Make sure the parent_record1 only has its own child records</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent_record1</span><span class="o">.</span><span class="n">child_ids</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">children</span><span class="p">[</span><span class="n">parent_record1</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>

        <span class="c1"># Make sure the parent_record2 only has its own child records</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent_record2</span><span class="o">.</span><span class="n">child_ids</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">children</span><span class="p">[</span><span class="n">parent_record2</span><span class="o">.</span><span class="n">id</span><span class="p">])</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Amr.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>