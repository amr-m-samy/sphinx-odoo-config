<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>odoo.addons.test_new_api.tests.test_new_fields &mdash; Amr  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Amr
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modules.html">odoo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Amr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../../odoo.html">odoo</a></li>
      <li class="breadcrumb-item active">odoo.addons.test_new_api.tests.test_new_fields</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for odoo.addons.test_new_api.tests.test_new_fields</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># Part of Odoo. See LICENSE file for full copyright and licensing details.</span>

<span class="c1">#</span>
<span class="c1"># test cases for new-style fields</span>
<span class="c1">#</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>
<span class="kn">import</span> <span class="nn">psycopg2</span>

<span class="kn">from</span> <span class="nn">odoo</span> <span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">Command</span>
<span class="kn">from</span> <span class="nn">odoo.addons.base.tests.common</span> <span class="kn">import</span> <span class="n">TransactionCaseWithUserDemo</span>
<span class="kn">from</span> <span class="nn">odoo.exceptions</span> <span class="kn">import</span> <span class="n">AccessError</span><span class="p">,</span> <span class="n">MissingError</span><span class="p">,</span> <span class="n">UserError</span><span class="p">,</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">odoo.tests</span> <span class="kn">import</span> <span class="n">common</span>
<span class="kn">from</span> <span class="nn">odoo.tools</span> <span class="kn">import</span> <span class="n">mute_logger</span><span class="p">,</span> <span class="n">float_repr</span>
<span class="kn">from</span> <span class="nn">odoo.tools.date_utils</span> <span class="kn">import</span> <span class="n">add</span><span class="p">,</span> <span class="n">subtract</span><span class="p">,</span> <span class="n">start_of</span><span class="p">,</span> <span class="n">end_of</span>
<span class="kn">from</span> <span class="nn">odoo.tools.image</span> <span class="kn">import</span> <span class="n">image_data_uri</span>


<div class="viewcode-block" id="TestFields">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields">[docs]</a>
<span class="k">class</span> <span class="nc">TestFields</span><span class="p">(</span><span class="n">TransactionCaseWithUserDemo</span><span class="p">):</span>

<div class="viewcode-block" id="TestFields.setUp">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.setUp">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># for tests methods that create custom models/fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">reset_changes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">clear_all_caches</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestFields</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.discussion_0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;participants&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_demo</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>
        <span class="c1"># YTI FIX ME: The cache shouldn&#39;t be inconsistent (rco is gonna fix it)</span>
        <span class="c1"># self.env.ref(&#39;test_new_api.discussion_0&#39;).participants -&gt; 1 user</span>
        <span class="c1"># self.env.ref(&#39;test_new_api.discussion_0&#39;).invalidate()</span>
        <span class="c1"># self.env.ref(&#39;test_new_api.discussion_0&#39;).with_context(active_test=False).participants -&gt; 2 users</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.message_0_1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;author&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_demo</span><span class="o">.</span><span class="n">id</span><span class="p">})</span></div>


<div class="viewcode-block" id="TestFields.test_00_basics">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_00_basics">[docs]</a>
    <span class="k">def</span> <span class="nf">test_00_basics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test accessing new fields &quot;&quot;&quot;</span>
        <span class="c1"># find a discussion</span>
        <span class="n">discussion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.discussion_0&#39;</span><span class="p">)</span>

        <span class="c1"># read field as a record attribute or as a record item</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">discussion</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">discussion</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">discussion</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">discussion</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># read it with method read()</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">discussion</span><span class="o">.</span><span class="n">read</span><span class="p">([</span><span class="s1">&#39;name&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">discussion</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_01_basic_get_assertion">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_01_basic_get_assertion">[docs]</a>
    <span class="k">def</span> <span class="nf">test_01_basic_get_assertion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test item getter &quot;&quot;&quot;</span>
        <span class="c1"># field access works on single record</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.message_0_0&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">body</span>

        <span class="c1"># field access fails on multiple records</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([])</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">faulty</span> <span class="o">=</span> <span class="n">records</span><span class="o">.</span><span class="n">body</span></div>


<div class="viewcode-block" id="TestFields.test_01_basic_set_assertion">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_01_basic_set_assertion">[docs]</a>
    <span class="k">def</span> <span class="nf">test_01_basic_set_assertion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test item setter &quot;&quot;&quot;</span>
        <span class="c1"># field assignment works on single record</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.message_0_0&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">record</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s1">&#39;OK&#39;</span>

        <span class="c1"># field assignment on multiple records should assign value to all records</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([])</span>
        <span class="n">records</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s1">&#39;Updated&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">record</span><span class="p">:</span><span class="n">record</span><span class="o">.</span><span class="n">body</span><span class="o">==</span><span class="s1">&#39;Updated&#39;</span><span class="p">,</span> <span class="n">records</span><span class="p">)))</span>

        <span class="c1"># field assigmenent does not cache the wrong value when write overridden</span>
        <span class="n">record</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_05_unknown_fields">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_05_unknown_fields">[docs]</a>
    <span class="k">def</span> <span class="nf">test_05_unknown_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test ORM operations with unknown fields &quot;&quot;&quot;</span>
        <span class="n">cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">})</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;Invalid field&#39;</span><span class="p">):</span>
            <span class="n">cat</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;zzz&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">42</span><span class="p">)])</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;Invalid field&#39;</span><span class="p">):</span>
            <span class="n">cat</span><span class="o">.</span><span class="n">search</span><span class="p">([],</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;zzz&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;Invalid field&#39;</span><span class="p">):</span>
            <span class="n">cat</span><span class="o">.</span><span class="n">read</span><span class="p">([</span><span class="s1">&#39;zzz&#39;</span><span class="p">])</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;Invalid field&#39;</span><span class="p">):</span>
            <span class="n">cat</span><span class="o">.</span><span class="n">read_group</span><span class="p">([(</span><span class="s1">&#39;zzz&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">42</span><span class="p">)],</span> <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">],</span> <span class="n">groupby</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">])</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;Invalid field&#39;</span><span class="p">):</span>
            <span class="n">cat</span><span class="o">.</span><span class="n">read_group</span><span class="p">([],</span> <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;zzz&#39;</span><span class="p">],</span> <span class="n">groupby</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">])</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;Invalid field&#39;</span><span class="p">):</span>
            <span class="n">cat</span><span class="o">.</span><span class="n">read_group</span><span class="p">([],</span> <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;zzz:sum&#39;</span><span class="p">],</span> <span class="n">groupby</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">])</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;Invalid field&#39;</span><span class="p">):</span>
            <span class="n">cat</span><span class="o">.</span><span class="n">read_group</span><span class="p">([],</span> <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">],</span> <span class="n">groupby</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;zzz&#39;</span><span class="p">])</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;is not a valid aggregate&#39;</span><span class="p">):</span>
            <span class="n">cat</span><span class="o">.</span><span class="n">read_group</span><span class="p">([],</span> <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">],</span> <span class="n">groupby</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">],</span> <span class="n">orderby</span><span class="o">=</span><span class="s1">&#39;zzz&#39;</span><span class="p">)</span>
        <span class="c1"># exception: accept &#39;__count&#39; as field to aggregate</span>
        <span class="n">cat</span><span class="o">.</span><span class="n">read_group</span><span class="p">([],</span> <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;__count&#39;</span><span class="p">],</span> <span class="n">groupby</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">])</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;Invalid field&#39;</span><span class="p">):</span>
            <span class="n">cat</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;zzz&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">})</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;Invalid field&#39;</span><span class="p">):</span>
            <span class="n">cat</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;zzz&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">})</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="s1">&#39;Invalid field&#39;</span><span class="p">):</span>
            <span class="n">cat</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;zzz&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">})</span></div>


<div class="viewcode-block" id="TestFields.test_10_computed">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_10_computed">[docs]</a>
    <span class="k">def</span> <span class="nf">test_10_computed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; check definition of computed fields &quot;&quot;&quot;</span>
        <span class="c1"># by default function fields are not stored, readonly, not copied</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">compute_sudo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">readonly</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">copy</span><span class="p">)</span>

        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">compute_sudo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">readonly</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">copy</span><span class="p">)</span>

        <span class="c1"># stored editable computed fields are copied according to their type</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.compute.onchange&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;baz&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">compute_sudo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">readonly</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">copy</span><span class="p">)</span>

        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.compute.onchange&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;line_ids&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">compute_sudo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">readonly</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">copy</span><span class="p">)</span>  <span class="c1"># like a regular one2many field</span>

        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.compute.onchange&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;tag_ids&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">compute_sudo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">readonly</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">copy</span><span class="p">)</span>  <span class="c1"># like a regular many2many field</span></div>


<div class="viewcode-block" id="TestFields.test_10_computed_custom">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_10_computed_custom">[docs]</a>
    <span class="k">def</span> <span class="nf">test_10_computed_custom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; check definition of custom computed fields &quot;&quot;&quot;</span>
        <span class="c1"># Flush demo user before creating a new ir.model.fields to avoid</span>
        <span class="c1"># a deadlock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;x_bool_false_computed&#39;</span><span class="p">,</span>
            <span class="s1">&#39;model_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.model_test_new_api_message&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;field_description&#39;</span><span class="p">:</span> <span class="s1">&#39;A boolean computed to false&#39;</span><span class="p">,</span>
            <span class="s1">&#39;compute&#39;</span><span class="p">:</span> <span class="s2">&quot;for r in self: r[&#39;x_bool_false_computed&#39;] = False&quot;</span><span class="p">,</span>
            <span class="s1">&#39;store&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;ttype&#39;</span><span class="p">:</span> <span class="s1">&#39;boolean&#39;</span>
        <span class="p">})</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;x_bool_false_computed&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">field_depends</span><span class="p">[</span><span class="n">field</span><span class="p">])</span></div>


<div class="viewcode-block" id="TestFields.test_10_computed_custom_invalid_transitive_depends">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_10_computed_custom_invalid_transitive_depends">[docs]</a>
    <span class="k">def</span> <span class="nf">test_10_computed_custom_invalid_transitive_depends</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;ir.model.fields&quot;</span><span class="p">]),</span> <span class="s2">&quot;_check_depends&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;ir.model.fields&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;x_computed_custom_valid_depends&quot;</span><span class="p">,</span>
                <span class="s2">&quot;model_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s2">&quot;test_new_api.model_test_new_api_foo&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;manual&quot;</span><span class="p">,</span>
                <span class="s2">&quot;field_description&quot;</span><span class="p">:</span> <span class="s2">&quot;A compute with a valid depends&quot;</span><span class="p">,</span>
                <span class="s2">&quot;compute&quot;</span><span class="p">:</span> <span class="s2">&quot;for r in self: r[&#39;x_computed_custom_valid_depends&#39;] = False&quot;</span><span class="p">,</span>
                <span class="s2">&quot;depends&quot;</span><span class="p">:</span> <span class="s2">&quot;value1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;store&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;ttype&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;ir.model.fields&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;x_computed_custom_valid_transitive_depends&quot;</span><span class="p">,</span>
                <span class="s2">&quot;model_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s2">&quot;test_new_api.model_test_new_api_foo&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;manual&quot;</span><span class="p">,</span>
                <span class="s2">&quot;field_description&quot;</span><span class="p">:</span> <span class="s2">&quot;A compute with a valid transitive depends&quot;</span><span class="p">,</span>
                <span class="s2">&quot;compute&quot;</span><span class="p">:</span> <span class="s2">&quot;for r in self: r[&#39;x_computed_custom_valid_transitive_depends&#39;] = False&quot;</span><span class="p">,</span>
                <span class="s2">&quot;depends&quot;</span><span class="p">:</span> <span class="s2">&quot;x_computed_custom_valid_depends&quot;</span><span class="p">,</span>
                <span class="s2">&quot;store&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;ttype&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;ir.model.fields&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;x_computed_custom_invalid_depends&quot;</span><span class="p">,</span>
                <span class="s2">&quot;model_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s2">&quot;test_new_api.model_test_new_api_foo&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;manual&quot;</span><span class="p">,</span>
                <span class="s2">&quot;field_description&quot;</span><span class="p">:</span> <span class="s2">&quot;A compute with an invalid depends&quot;</span><span class="p">,</span>
                <span class="s2">&quot;compute&quot;</span><span class="p">:</span> <span class="s2">&quot;for r in self: r[&#39;x_computed_custom_invalid_depends&#39;] = False&quot;</span><span class="p">,</span>
                <span class="s2">&quot;depends&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span><span class="p">,</span>
                <span class="s2">&quot;store&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;ttype&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;ir.model.fields&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;x_computed_custom_invalid_transitive_depends&quot;</span><span class="p">,</span>
                <span class="s2">&quot;model_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s2">&quot;test_new_api.model_test_new_api_foo&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;manual&quot;</span><span class="p">,</span>
                <span class="s2">&quot;field_description&quot;</span><span class="p">:</span> <span class="s2">&quot;A compute with an invalid transitive depends&quot;</span><span class="p">,</span>
                <span class="s2">&quot;compute&quot;</span><span class="p">:</span> <span class="s2">&quot;for r in self: r[&#39;x_computed_custom_invalid_transitive_depends&#39;] = False&quot;</span><span class="p">,</span>
                <span class="s2">&quot;depends&quot;</span><span class="p">:</span> <span class="s2">&quot;x_computed_custom_invalid_depends&quot;</span><span class="p">,</span>
                <span class="s2">&quot;store&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;ttype&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;test_new_api.foo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span>
        <span class="n">get_trigger_tree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get_trigger_tree</span>
        <span class="n">value1</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s2">&quot;value1&quot;</span><span class="p">]</span>
        <span class="n">valid_depends</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s2">&quot;x_computed_custom_valid_depends&quot;</span><span class="p">]</span>
        <span class="n">valid_transitive_depends</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s2">&quot;x_computed_custom_valid_transitive_depends&quot;</span><span class="p">]</span>
        <span class="n">invalid_depends</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s2">&quot;x_computed_custom_invalid_depends&quot;</span><span class="p">]</span>
        <span class="n">invalid_transitive_depends</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s2">&quot;x_computed_custom_invalid_transitive_depends&quot;</span><span class="p">]</span>
        <span class="c1"># `x_computed_custom_valid_depends` in the triggers of the field `value1`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">valid_depends</span> <span class="ow">in</span> <span class="n">get_trigger_tree</span><span class="p">([</span><span class="n">value1</span><span class="p">])</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
        <span class="c1"># `x_computed_custom_valid_transitive_depends` in the triggers `x_computed_custom_valid_depends` and `value1`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">valid_transitive_depends</span> <span class="ow">in</span> <span class="n">get_trigger_tree</span><span class="p">([</span><span class="n">valid_depends</span><span class="p">])</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">valid_transitive_depends</span> <span class="ow">in</span> <span class="n">get_trigger_tree</span><span class="p">([</span><span class="n">value1</span><span class="p">])</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
        <span class="c1"># `x_computed_custom_invalid_depends` not in any triggers, as it was invalid and was skipped</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">sum</span><span class="p">(</span><span class="n">invalid_depends</span> <span class="ow">in</span> <span class="n">get_trigger_tree</span><span class="p">([</span><span class="n">field</span><span class="p">])</span><span class="o">.</span><span class="n">root</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="c1"># `x_computed_custom_invalid_transitive_depends` in the triggers of `x_computed_custom_invalid_depends` only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">invalid_transitive_depends</span> <span class="ow">in</span> <span class="n">get_trigger_tree</span><span class="p">([</span><span class="n">invalid_depends</span><span class="p">])</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">sum</span><span class="p">(</span><span class="n">invalid_transitive_depends</span> <span class="ow">in</span> <span class="n">get_trigger_tree</span><span class="p">([</span><span class="n">field</span><span class="p">])</span><span class="o">.</span><span class="n">root</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="mi">1</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_10_computed_stored_x_name">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_10_computed_stored_x_name">[docs]</a>
    <span class="nd">@mute_logger</span><span class="p">(</span><span class="s1">&#39;odoo.fields&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_10_computed_stored_x_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># create a custom model with two fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s2">&quot;ir.model&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;x_test_10_compute_store_x_name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;x_test_10_compute_store_x_name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;field_id&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;x_name&#39;</span><span class="p">,</span> <span class="s1">&#39;ttype&#39;</span><span class="p">:</span> <span class="s1">&#39;char&#39;</span><span class="p">}),</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;x_stuff_id&#39;</span><span class="p">,</span> <span class="s1">&#39;ttype&#39;</span><span class="p">:</span> <span class="s1">&#39;many2one&#39;</span><span class="p">,</span> <span class="s1">&#39;relation&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.model&#39;</span><span class="p">}),</span>
            <span class="p">],</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>
        <span class="c1"># set &#39;x_stuff_id&#39; refer to a model not loaded yet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            UPDATE ir_model_fields</span>
<span class="s2">            SET relation = &#39;not.loaded&#39;</span>
<span class="s2">            WHERE model = &#39;x_test_10_compute_store_x_name&#39; AND name = &#39;x_stuff_id&#39;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="c1"># set &#39;x_name&#39; be computed and depend on &#39;x_stuff_id&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            UPDATE ir_model_fields</span>
<span class="s2">            SET compute = &#39;pass&#39;, depends = &#39;x_stuff_id.x_custom_1&#39;</span>
<span class="s2">            WHERE model = &#39;x_test_10_compute_store_x_name&#39; AND name = &#39;x_name&#39;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="c1"># setting up models should not crash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_10_display_name">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_10_display_name">[docs]</a>
    <span class="k">def</span> <span class="nf">test_10_display_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test definition of automatic field &#39;display_name&#39; &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.discussion&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">display_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">automatic</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">compute</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">field_depends</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,))</span></div>


<div class="viewcode-block" id="TestFields.test_10_non_stored">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_10_non_stored">[docs]</a>
    <span class="k">def</span> <span class="nf">test_10_non_stored</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test non-stored fields &quot;&quot;&quot;</span>
        <span class="c1"># a field declared with store=False should not have a column</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;dummy&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">compute</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">inverse</span><span class="p">)</span>

        <span class="c1"># find messages</span>
        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([]):</span>
            <span class="c1"># check definition of field</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">body</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

            <span class="c1"># check recomputation after record is modified</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">size</span>
            <span class="n">message</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">body</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;!!!&quot;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># create a message, assign body, and check size in several environments</span>
        <span class="n">message1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">message2</span> <span class="o">=</span> <span class="n">message1</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_demo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message1</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message2</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">message1</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="s2">&quot;XXX&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message1</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message2</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># special case: computed field without dependency must be computed</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.mixed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">now</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_11_stored">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_11_stored">[docs]</a>
    <span class="k">def</span> <span class="nf">test_11_stored</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test stored fields &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">check_stored</span><span class="p">(</span><span class="n">disc</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot; Check the stored computed field on disc.messages &quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">disc</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">] </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">disc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="c1"># find the demo discussion, and check messages</span>
        <span class="n">discussion1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.discussion_0&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">discussion1</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span>
        <span class="n">check_stored</span><span class="p">(</span><span class="n">discussion1</span><span class="p">)</span>

        <span class="c1"># modify discussion name, and check again messages</span>
        <span class="n">discussion1</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Talking about stuff...&#39;</span>
        <span class="n">check_stored</span><span class="p">(</span><span class="n">discussion1</span><span class="p">)</span>

        <span class="c1"># switch message from discussion, and check again</span>

        <span class="c1"># See YTI FIXME</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>

        <span class="n">discussion2</span> <span class="o">=</span> <span class="n">discussion1</span><span class="o">.</span><span class="n">copy</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Another discussion&#39;</span><span class="p">})</span>
        <span class="n">message2</span> <span class="o">=</span> <span class="n">discussion1</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">message2</span><span class="o">.</span><span class="n">discussion</span> <span class="o">=</span> <span class="n">discussion2</span>
        <span class="n">check_stored</span><span class="p">(</span><span class="n">discussion2</span><span class="p">)</span>

        <span class="c1"># create a new discussion with messages, and check their name</span>
        <span class="n">user_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.user_root&#39;</span><span class="p">)</span>
        <span class="n">user_demo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_demo</span>
        <span class="n">discussion3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.discussion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Stuff&#39;</span><span class="p">,</span>
            <span class="s1">&#39;participants&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">user_root</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">user_demo</span><span class="o">.</span><span class="n">id</span><span class="p">)],</span>
            <span class="s1">&#39;messages&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;author&#39;</span><span class="p">:</span> <span class="n">user_root</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="s1">&#39;one&#39;</span><span class="p">}),</span>
                <span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;author&#39;</span><span class="p">:</span> <span class="n">user_demo</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="s1">&#39;two&#39;</span><span class="p">}),</span>
                <span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;author&#39;</span><span class="p">:</span> <span class="n">user_root</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="s1">&#39;three&#39;</span><span class="p">}),</span>
            <span class="p">],</span>
        <span class="p">})</span>
        <span class="n">check_stored</span><span class="p">(</span><span class="n">discussion3</span><span class="p">)</span>

        <span class="c1"># modify the discussion messages: edit the 2nd one, remove the last one</span>
        <span class="c1"># (keep modifications in that order, as they reproduce a former bug!)</span>
        <span class="n">discussion3</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
            <span class="s1">&#39;messages&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">discussion3</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                <span class="n">Command</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">discussion3</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;author&#39;</span><span class="p">:</span> <span class="n">user_root</span><span class="o">.</span><span class="n">id</span><span class="p">}),</span>
                <span class="n">Command</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">discussion3</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
            <span class="p">],</span>
        <span class="p">})</span>
        <span class="n">check_stored</span><span class="p">(</span><span class="n">discussion3</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_11_stored_protected">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_11_stored_protected">[docs]</a>
    <span class="k">def</span> <span class="nf">test_11_stored_protected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test protection against recomputation &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.compute.readonly&#39;</span><span class="p">]</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;bar&#39;</span><span class="p">]</span>

        <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;unprotected #1&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;unprotected #1&#39;</span><span class="p">)</span>

        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;unprotected #2&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;unprotected #2&#39;</span><span class="p">)</span>

        <span class="c1"># by protecting &#39;bar&#39;, we prevent it from being recomputed</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">protecting</span><span class="p">([</span><span class="n">field</span><span class="p">],</span> <span class="n">record</span><span class="p">):</span>
            <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;protected&#39;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;unprotected #2&#39;</span><span class="p">)</span>

            <span class="c1"># also works when nested</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">protecting</span><span class="p">([</span><span class="n">field</span><span class="p">],</span> <span class="n">record</span><span class="p">):</span>
                <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;protected&#39;</span><span class="p">})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;unprotected #2&#39;</span><span class="p">)</span>

            <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;protected&#39;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;unprotected #2&#39;</span><span class="p">)</span>

        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;unprotected #3&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;unprotected #3&#39;</span><span class="p">)</span>

        <span class="c1"># also works with duplicated fields</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">protecting</span><span class="p">([</span><span class="n">field</span><span class="p">,</span> <span class="n">field</span><span class="p">],</span> <span class="n">record</span><span class="p">):</span>
            <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;protected&#39;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;unprotected #3&#39;</span><span class="p">)</span>

        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;unprotected #4&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;unprotected #4&#39;</span><span class="p">)</span>

        <span class="c1"># we protect &#39;bar&#39; on a different record</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">protecting</span><span class="p">([</span><span class="n">field</span><span class="p">],</span> <span class="n">record</span><span class="p">):</span>
            <span class="n">record2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;unprotected&#39;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record2</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;unprotected&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_11_computed_access">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_11_computed_access">[docs]</a>
    <span class="k">def</span> <span class="nf">test_11_computed_access</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test computed fields with access right errors &quot;&quot;&quot;</span>
        <span class="n">User</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span>
        <span class="n">user1</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Aaaah&#39;</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="s1">&#39;a&#39;</span><span class="p">})</span>
        <span class="n">user2</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Boooh&#39;</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="s1">&#39;b&#39;</span><span class="p">})</span>
        <span class="n">user3</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Crrrr&#39;</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="s1">&#39;c&#39;</span><span class="p">})</span>
        <span class="c1"># add a rule to not give access to user2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.rule&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;model_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;res.users&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;domain_force&#39;</span><span class="p">:</span> <span class="s2">&quot;[(&#39;id&#39;, &#39;!=&#39;, </span><span class="si">%d</span><span class="s2">)]&quot;</span> <span class="o">%</span> <span class="n">user2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="c1"># DLE P72: Since we decided that we do not raise security access errors for data to which we had the occassion</span>
        <span class="c1"># to put the value in the cache, we need to invalidate the cache for user1, user2 and user3 in order</span>
        <span class="c1"># to test the below access error. Otherwise the above create calls set in the cache the information needed</span>
        <span class="c1"># to compute `company_type` (&#39;is_company&#39;), and doesn&#39;t need to trigger a read.</span>
        <span class="c1"># We need to force the read in order to test the security access</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>
        <span class="c1"># group users as a recordset, and read them as user demo</span>
        <span class="n">users</span> <span class="o">=</span> <span class="p">(</span><span class="n">user1</span> <span class="o">+</span> <span class="n">user2</span> <span class="o">+</span> <span class="n">user3</span><span class="p">)</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_demo</span><span class="p">)</span>
        <span class="n">user1</span><span class="p">,</span> <span class="n">user2</span><span class="p">,</span> <span class="n">user3</span> <span class="o">=</span> <span class="n">users</span>
        <span class="c1"># regression test: a bug invalidated the field&#39;s value from cache</span>
        <span class="n">user1</span><span class="o">.</span><span class="n">company_type</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">AccessError</span><span class="p">):</span>
            <span class="n">user2</span><span class="o">.</span><span class="n">company_type</span>
        <span class="n">user3</span><span class="o">.</span><span class="n">company_type</span></div>


<div class="viewcode-block" id="TestFields.test_12_recursive">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_12_recursive">[docs]</a>
    <span class="k">def</span> <span class="nf">test_12_recursive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test recursively dependent fields &quot;&quot;&quot;</span>
        <span class="n">Category</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.category&#39;</span><span class="p">]</span>
        <span class="n">abel</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Abel&#39;</span><span class="p">})</span>
        <span class="n">beth</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Bethany&#39;</span><span class="p">})</span>
        <span class="n">cath</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Catherine&#39;</span><span class="p">})</span>
        <span class="n">dean</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Dean&#39;</span><span class="p">})</span>
        <span class="n">ewan</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Ewan&#39;</span><span class="p">})</span>
        <span class="n">finn</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Finnley&#39;</span><span class="p">})</span>
        <span class="n">gabe</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Gabriel&#39;</span><span class="p">})</span>

        <span class="n">cath</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">finn</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">gabe</span>
        <span class="n">abel</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">beth</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">cath</span>
        <span class="n">dean</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">ewan</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">finn</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">abel</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s2">&quot;Gabriel / Catherine / Abel&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">beth</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s2">&quot;Gabriel / Catherine / Bethany&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cath</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s2">&quot;Gabriel / Catherine&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dean</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s2">&quot;Gabriel / Finnley / Dean&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ewan</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s2">&quot;Gabriel / Finnley / Ewan&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">finn</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s2">&quot;Gabriel / Finnley&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">gabe</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s2">&quot;Gabriel&quot;</span><span class="p">)</span>

        <span class="n">ewan</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">cath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ewan</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s2">&quot;Gabriel / Catherine / Ewan&quot;</span><span class="p">)</span>

        <span class="n">cath</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">finn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ewan</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s2">&quot;Gabriel / Finnley / Catherine / Ewan&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_12_recursive_recompute">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_12_recursive_recompute">[docs]</a>
    <span class="k">def</span> <span class="nf">test_12_recursive_recompute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test recomputation on recursively dependent field &quot;&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.recursive&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">})</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.recursive&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.recursive&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.recursive&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="s1">&#39;A / B&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="s1">&#39;A / B / C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="s1">&#39;A / B / C / D&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;A / B&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;A / B / C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;A / B / C / D&#39;</span><span class="p">)</span>

        <span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;A1&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="s1">&#39;A1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="s1">&#39;A1 / B&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="s1">&#39;A1 / B / C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="s1">&#39;A1 / B / C / D&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;A1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;A1 / B&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;A1 / B / C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;A1 / B / C / D&#39;</span><span class="p">)</span>

        <span class="n">b</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="s1">&#39;A1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="s1">&#39;B / C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="s1">&#39;B / C / D&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;A1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;B / C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;B / C / D&#39;</span><span class="p">)</span>

        <span class="c1"># rename several records to trigger several recomputations at once</span>
        <span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;X&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="s1">&#39;A1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="s1">&#39;X / X&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="s1">&#39;X / X / X&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;A1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;X / X&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;X / X / X&#39;</span><span class="p">)</span>

        <span class="c1"># delete b; both c and d are deleted in cascade; c should also be marked</span>
        <span class="c1"># to recompute, but recomputation should not fail...</span>
        <span class="n">b</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span> <span class="n">a</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_12_recursive_tree">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_12_recursive_tree">[docs]</a>
    <span class="k">def</span> <span class="nf">test_12_recursive_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">foo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.recursive.tree&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;foo()&#39;</span><span class="p">)</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">foo</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="n">foo</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;foo(bar())&#39;</span><span class="p">)</span>
        <span class="n">baz</span> <span class="o">=</span> <span class="n">foo</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="n">bar</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;foo(bar(baz()))&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_12_recursive_unlink">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_12_recursive_unlink">[docs]</a>
    <span class="k">def</span> <span class="nf">test_12_recursive_unlink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.recursive.order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">})</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.recursive.line&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;order_id&#39;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.recursive.task&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">line_id</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">task_ids</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">task_number</span><span class="p">)</span>

        <span class="c1"># Before deleting order, the following are marked to recompute:</span>
        <span class="c1">#  - task.line_id (recursive, depends on task.line_id.order_id.value)</span>
        <span class="c1">#  - line.task_number (implicitely depends on line.task_ids.line_id)</span>
        <span class="c1">#</span>
        <span class="c1"># If task.line_id is ever recomputed in order to mark line.task_number,</span>
        <span class="c1"># its recomputed value will be lost in the cache invalidation, and</span>
        <span class="c1"># there will be nothing left to write in the database afterwards!  This</span>
        <span class="c1"># makes the call to unlink() crash in that case.</span>
        <span class="c1">#</span>
        <span class="n">order</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>


<div class="viewcode-block" id="TestFields.test_12_recursive_context_dependent">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_12_recursive_context_dependent">[docs]</a>
    <span class="k">def</span> <span class="nf">test_12_recursive_context_dependent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.recursive&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">})</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.recursive&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.recursive&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.recursive&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">context_dependent_name</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">context_dependent_name</span><span class="p">,</span> <span class="s1">&#39;A / B&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">context_dependent_name</span><span class="p">,</span> <span class="s1">&#39;A / B / C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">context_dependent_name</span><span class="p">,</span> <span class="s1">&#39;A / B / C / D&#39;</span><span class="p">)</span>

        <span class="c1"># now let&#39;s swith to another context to update the dependency</span>
        <span class="n">a</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bozo</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;A1&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">context_dependent_name</span><span class="p">,</span> <span class="s1">&#39;A1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">context_dependent_name</span><span class="p">,</span> <span class="s1">&#39;A1 / B&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">context_dependent_name</span><span class="p">,</span> <span class="s1">&#39;A1 / B / C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">context_dependent_name</span><span class="p">,</span> <span class="s1">&#39;A1 / B / C / D&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_12_cascade">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_12_cascade">[docs]</a>
    <span class="k">def</span> <span class="nf">test_12_cascade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test computed field depending on computed field &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.message_0_0&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>
        <span class="n">double_size</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">double_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">double_size</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.cascade&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s2">&quot;Hi&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">baz</span><span class="p">,</span> <span class="s2">&quot;&lt;[Hi]&gt;&quot;</span><span class="p">)</span>
        <span class="n">record</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="s2">&quot;Ho&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">baz</span><span class="p">,</span> <span class="s2">&quot;&lt;[Ho]&gt;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_12_unlink_cascade_active_store">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_12_unlink_cascade_active_store">[docs]</a>
    <span class="k">def</span> <span class="nf">test_12_unlink_cascade_active_store</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Test that `unlink` on many records doesn&#39;t raise a RecursionError</span>
<span class="sd">        with a stored related `active` field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.emailmessage&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="p">[{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="p">}]</span> <span class="o">*</span> <span class="mi">101</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>


<div class="viewcode-block" id="TestFields.test_12_unlink_cascade_ir_rule_using_related">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_12_unlink_cascade_ir_rule_using_related">[docs]</a>
    <span class="k">def</span> <span class="nf">test_12_unlink_cascade_ir_rule_using_related</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Test that `unlink` on many records doesn&#39;t raise a RecursionError</span>
<span class="sd">        when there is an ir.rule with a stored related field to compute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.emailmessage&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="p">[{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="p">}]</span> <span class="o">*</span> <span class="mi">101</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Create an ir.rule, which forces to flush field &#39;active&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.rule&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;model_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_id</span><span class="p">(</span><span class="s1">&#39;test_new_api.emailmessage&#39;</span><span class="p">),</span>
            <span class="s1">&#39;groups&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.group_user&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">],</span>
            <span class="s1">&#39;domain_force&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">([(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]),</span>
        <span class="p">})</span>

        <span class="n">message</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_demo</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>


<div class="viewcode-block" id="TestFields.test_12_dynamic_depends">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_12_dynamic_depends">[docs]</a>
    <span class="k">def</span> <span class="nf">test_12_dynamic_depends</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;test_new_api.compute.dynamic.depends&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">field_depends</span><span class="p">[</span><span class="n">Model</span><span class="o">.</span><span class="n">full_name</span><span class="p">],</span> <span class="p">())</span>

        <span class="c1"># the dependencies of full_name are stored in a config parameter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.config_parameter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="s1">&#39;test_new_api.full_name&#39;</span><span class="p">,</span> <span class="s1">&#39;name1,name2&#39;</span><span class="p">)</span>

        <span class="c1"># this must re-evaluate the field&#39;s dependencies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">field_depends</span><span class="p">[</span><span class="n">Model</span><span class="o">.</span><span class="n">full_name</span><span class="p">],</span> <span class="p">(</span><span class="s1">&#39;name1&#39;</span><span class="p">,</span> <span class="s1">&#39;name2&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="TestFields.test_13_inverse">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_13_inverse">[docs]</a>
    <span class="k">def</span> <span class="nf">test_13_inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test inverse computation of fields &quot;&quot;&quot;</span>
        <span class="n">Category</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.category&#39;</span><span class="p">]</span>
        <span class="n">abel</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Abel&#39;</span><span class="p">})</span>
        <span class="n">beth</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Bethany&#39;</span><span class="p">})</span>
        <span class="n">cath</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Catherine&#39;</span><span class="p">})</span>
        <span class="n">dean</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Dean&#39;</span><span class="p">})</span>
        <span class="n">ewan</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Ewan&#39;</span><span class="p">})</span>
        <span class="n">finn</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Finnley&#39;</span><span class="p">})</span>
        <span class="n">gabe</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Gabriel&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ewan</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s2">&quot;Ewan&quot;</span><span class="p">)</span>

        <span class="n">ewan</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="s2">&quot;Abel / Bethany / Catherine / Erwan&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">beth</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">abel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cath</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">beth</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ewan</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">cath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ewan</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;Erwan&quot;</span><span class="p">)</span>

        <span class="c1"># check create/write with several records</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;display_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">}</span>
        <span class="n">foo1</span><span class="p">,</span> <span class="n">foo2</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">create</span><span class="p">([</span><span class="n">vals</span><span class="p">,</span> <span class="n">vals</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">foo1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;Foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">foo2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;Foo&#39;</span><span class="p">)</span>

        <span class="p">(</span><span class="n">foo1</span> <span class="o">+</span> <span class="n">foo2</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;display_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Bar&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">foo1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;Bar&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">foo2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;Bar&#39;</span><span class="p">)</span>

        <span class="c1"># create/write on &#39;foo&#39; should only invoke the compute method</span>
        <span class="n">log</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.compute.inverse&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;Hi&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;Hi&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;Hi&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;compute&#39;</span><span class="p">])</span>

        <span class="n">log</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;Ho&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;Ho&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;Ho&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;compute&#39;</span><span class="p">])</span>

        <span class="c1"># create/write on &#39;bar&#39; should only invoke the inverse method</span>
        <span class="n">log</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;Hi&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;Hi&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;Hi&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;inverse&#39;</span><span class="p">])</span>

        <span class="n">log</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;Ho&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;Ho&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;Ho&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;inverse&#39;</span><span class="p">])</span>

        <span class="c1"># Test compatibility multiple compute/inverse fields</span>
        <span class="n">log</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi_compute_inverse&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;bar1&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bar2&#39;</span><span class="p">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bar3&#39;</span><span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;1/2/3&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar1</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar2</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar3</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;inverse1&#39;</span><span class="p">,</span> <span class="s1">&#39;inverse23&#39;</span><span class="p">])</span>

        <span class="n">log</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;bar2&#39;</span><span class="p">:</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;bar3&#39;</span><span class="p">:</span> <span class="s1">&#39;5&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;1/4/5&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar1</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar2</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar3</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;inverse23&#39;</span><span class="p">])</span>

        <span class="n">log</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;bar1&#39;</span><span class="p">:</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;bar2&#39;</span><span class="p">:</span> <span class="s1">&#39;7&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;6/7/5&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar1</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar2</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar3</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;inverse1&#39;</span><span class="p">,</span> <span class="s1">&#39;inverse23&#39;</span><span class="p">])</span>

        <span class="n">log</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;A/B/C&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;A/B/C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar1</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar2</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar3</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;compute&#39;</span><span class="p">])</span>

        <span class="c1"># corner case: write on a field that is marked to compute</span>
        <span class="n">log</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="c1"># writing on &#39;foo&#39; marks &#39;bar1&#39;, &#39;bar2&#39;, &#39;bar3&#39; to compute</span>
        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;1/2/3&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c1"># writing on &#39;bar3&#39; must force the computation before updating</span>
        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;bar3&#39;</span><span class="p">:</span> <span class="s1">&#39;X&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;compute&#39;</span><span class="p">,</span> <span class="s1">&#39;inverse23&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;1/2/X&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar1</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar2</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar3</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;compute&#39;</span><span class="p">,</span> <span class="s1">&#39;inverse23&#39;</span><span class="p">])</span>

        <span class="n">log</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="c1"># writing on &#39;foo&#39; marks &#39;bar1&#39;, &#39;bar2&#39;, &#39;bar3&#39; to compute</span>
        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;A/B/C&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c1"># writing on &#39;bar1&#39;, &#39;bar2&#39;, &#39;bar3&#39; discards the computation</span>
        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;bar1&#39;</span><span class="p">:</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;bar2&#39;</span><span class="p">:</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;bar3&#39;</span><span class="p">:</span> <span class="s1">&#39;Z&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;inverse1&#39;</span><span class="p">,</span> <span class="s1">&#39;inverse23&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;X/Y/Z&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar1</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar2</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar3</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;inverse1&#39;</span><span class="p">,</span> <span class="s1">&#39;inverse23&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="TestFields.test_13_inverse_access">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_13_inverse_access">[docs]</a>
    <span class="k">def</span> <span class="nf">test_13_inverse_access</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test access rights on inverse fields &quot;&quot;&quot;</span>
        <span class="n">foo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">})</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">has_group</span><span class="p">(</span><span class="s1">&#39;base.group_system&#39;</span><span class="p">))</span>
        <span class="c1"># add group on non-stored inverse field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;groups&#39;</span><span class="p">,</span> <span class="s1">&#39;base.group_system&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">AccessError</span><span class="p">):</span>
            <span class="n">foo</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="s1">&#39;Forbidden&#39;</span></div>


<div class="viewcode-block" id="TestFields.test_13_inverse_with_unlink">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_13_inverse_with_unlink">[docs]</a>
    <span class="k">def</span> <span class="nf">test_13_inverse_with_unlink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test x2many delete command combined with an inverse field &quot;&quot;&quot;</span>

        <span class="n">country1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test country&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="s1">&#39;ZV&#39;</span><span class="p">})</span>
        <span class="n">country2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;other country&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="s1">&#39;ZX&#39;</span><span class="p">})</span>
        <span class="n">company</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test company&#39;</span><span class="p">,</span>
            <span class="s1">&#39;child_ids&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Child Company 1&#39;</span><span class="p">}),</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Child Company 2&#39;</span><span class="p">}),</span>
            <span class="p">]</span>
        <span class="p">})</span>
        <span class="n">child_company</span> <span class="o">=</span> <span class="n">company</span><span class="o">.</span><span class="n">child_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># check first that the field has an inverse and is not stored</span>
        <span class="n">field</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">company</span><span class="p">)</span><span class="o">.</span><span class="n">country_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">inverse</span><span class="p">)</span>

        <span class="n">company</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;country_id&#39;</span><span class="p">:</span> <span class="n">country1</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">company</span><span class="o">.</span><span class="n">country_id</span><span class="p">,</span> <span class="n">country1</span><span class="p">)</span>

        <span class="n">company</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
            <span class="s1">&#39;country_id&#39;</span><span class="p">:</span> <span class="n">country2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;child_ids&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">2</span><span class="p">,</span> <span class="n">child_company</span><span class="o">.</span><span class="n">id</span><span class="p">)],</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">company</span><span class="o">.</span><span class="n">country_id</span><span class="p">,</span> <span class="n">country2</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_14_search">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_14_search">[docs]</a>
    <span class="k">def</span> <span class="nf">test_14_search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test search on computed fields &quot;&quot;&quot;</span>
        <span class="n">discussion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.discussion_0&#39;</span><span class="p">)</span>

        <span class="c1"># determine message sizes</span>
        <span class="n">sizes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">discussion</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span>

        <span class="c1"># search for messages based on their size</span>
        <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">:</span>
            <span class="n">messages0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                <span class="p">[(</span><span class="s1">&#39;discussion&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">discussion</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="n">size</span><span class="p">)])</span>

            <span class="n">messages1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">discussion</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">:</span>
                    <span class="n">messages1</span> <span class="o">+=</span> <span class="n">message</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">messages0</span><span class="p">,</span> <span class="n">messages1</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_15_constraint">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_15_constraint">[docs]</a>
    <span class="k">def</span> <span class="nf">test_15_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test new-style Python constraints &quot;&quot;&quot;</span>
        <span class="n">discussion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.discussion_0&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>

        <span class="c1"># remove oneself from discussion participants: we can no longer create</span>
        <span class="c1"># messages in discussion</span>
        <span class="n">discussion</span><span class="o">.</span><span class="n">participants</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;discussion&#39;</span><span class="p">:</span> <span class="n">discussion</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="s1">&#39;Whatever&#39;</span><span class="p">})</span>

        <span class="c1"># make sure that assertRaises() does not leave fields to recompute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">fields_to_compute</span><span class="p">())</span>

        <span class="c1"># put back oneself into discussion participants: now we can create</span>
        <span class="c1"># messages in discussion</span>
        <span class="n">discussion</span><span class="o">.</span><span class="n">participants</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;discussion&#39;</span><span class="p">:</span> <span class="n">discussion</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="s1">&#39;Whatever&#39;</span><span class="p">})</span>

        <span class="c1"># check constraint on recomputed field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">discussion</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">):</span>
            <span class="n">discussion</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;X&quot;</span></div>


<div class="viewcode-block" id="TestFields.test_15_constraint_inverse">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_15_constraint_inverse">[docs]</a>
    <span class="k">def</span> <span class="nf">test_15_constraint_inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test constraint method on normal field and field with inverse &quot;&quot;&quot;</span>
        <span class="n">log</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.compute.inverse&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">,</span> <span class="n">log_constraint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># create/write with normal field only</span>
        <span class="n">log</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;Hi&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;constraint&#39;</span><span class="p">])</span>

        <span class="n">log</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;Ho&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;constraint&#39;</span><span class="p">])</span>

        <span class="c1"># create/write with inverse field only</span>
        <span class="n">log</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;Hi&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;inverse&#39;</span><span class="p">,</span> <span class="s1">&#39;constraint&#39;</span><span class="p">])</span>

        <span class="n">log</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;Ho&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;inverse&#39;</span><span class="p">,</span> <span class="s1">&#39;constraint&#39;</span><span class="p">])</span>

        <span class="c1"># create/write with both fields only</span>
        <span class="n">log</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;Hi&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;Hi&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;inverse&#39;</span><span class="p">,</span> <span class="s1">&#39;constraint&#39;</span><span class="p">])</span>

        <span class="n">log</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;Ho&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;Ho&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;inverse&#39;</span><span class="p">,</span> <span class="s1">&#39;constraint&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="TestFields.test_16_compute_unassigned">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_16_compute_unassigned">[docs]</a>
    <span class="k">def</span> <span class="nf">test_16_compute_unassigned</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.compute.unassigned&#39;</span><span class="p">]</span>

        <span class="c1"># real record</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">record</span><span class="o">.</span><span class="n">bar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bare</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bars</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bares</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># new record</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">record</span><span class="o">.</span><span class="n">bar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bare</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bars</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bares</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_16_compute_unassigned_access_error">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_16_compute_unassigned_access_error">[docs]</a>
    <span class="k">def</span> <span class="nf">test_16_compute_unassigned_access_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># create two records</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.compute.unassigned&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">([{},</span> <span class="p">{}])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>

        <span class="c1"># alter access rights: regular users cannot read &#39;records&#39;</span>
        <span class="n">access</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.access_test_new_api_compute_unassigned&#39;</span><span class="p">)</span>
        <span class="n">access</span><span class="o">.</span><span class="n">perm_read</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>

        <span class="c1"># switch to environment with user demo</span>
        <span class="n">records</span> <span class="o">=</span> <span class="n">records</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_demo</span><span class="p">)</span>

        <span class="c1"># check that records are not accessible</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">AccessError</span><span class="p">):</span>
            <span class="n">records</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bars</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">AccessError</span><span class="p">):</span>
            <span class="n">records</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bars</span>

        <span class="c1"># Modify the records and flush() changes with the current environment:</span>
        <span class="c1"># this should not trigger an access error, whatever the order in which</span>
        <span class="c1"># records are considered.  It may fail in the following scenario:</span>
        <span class="c1">#  - mark field &#39;bars&#39; to compute on records</span>
        <span class="c1">#  - access records[0].bars</span>
        <span class="c1">#     - recompute bars on records (both) -&gt; assign records[0] only</span>
        <span class="c1">#     - return records[0].bars from cache</span>
        <span class="c1">#  - access records[1].bars</span>
        <span class="c1">#     - recompute nothing (done already)</span>
        <span class="c1">#     - records[1].bars is not in cache</span>
        <span class="c1">#     - fetch records[1].bars -&gt; access error</span>
        <span class="n">records</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="s2">&quot;assign&quot;</span>
        <span class="n">records</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>

        <span class="c1"># try the other way around, too</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>
        <span class="n">records</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span>
        <span class="n">records</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="s2">&quot;assign&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span></div>


<div class="viewcode-block" id="TestFields.test_17_compute_depends_on_many2many">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_17_compute_depends_on_many2many">[docs]</a>
    <span class="k">def</span> <span class="nf">test_17_compute_depends_on_many2many</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user1</span><span class="p">,</span> <span class="n">user2</span><span class="p">,</span> <span class="n">user3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">([{},</span> <span class="p">{},</span> <span class="p">{}])</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;user_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">user1</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>

        <span class="n">field</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span><span class="o">.</span><span class="n">group_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">records_to_compute</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>

        <span class="c1"># should mark user2 and user3 to compute only</span>
        <span class="n">group</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;user_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">user1</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">user2</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">user3</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">records_to_compute</span><span class="p">(</span><span class="n">field</span><span class="p">),</span> <span class="n">user2</span> <span class="o">+</span> <span class="n">user3</span><span class="p">)</span>

        <span class="c1"># should mark user2 to compute only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
        <span class="n">group</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;user_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">user2</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">records_to_compute</span><span class="p">(</span><span class="n">field</span><span class="p">),</span> <span class="n">user2</span><span class="p">)</span>

        <span class="c1"># should mark user2 and user3 to compute only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
        <span class="n">group</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;user_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="n">user1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user2</span><span class="o">.</span><span class="n">id</span><span class="p">])]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">records_to_compute</span><span class="p">(</span><span class="n">field</span><span class="p">),</span> <span class="n">user2</span> <span class="o">+</span> <span class="n">user3</span><span class="p">)</span>

        <span class="c1"># should mark user3 to compute only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
        <span class="n">user3</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;group_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">records_to_compute</span><span class="p">(</span><span class="n">field</span><span class="p">),</span> <span class="n">user3</span><span class="p">)</span>

        <span class="c1"># similar with new records, but only check recomputation</span>
        <span class="n">user1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">new</span><span class="p">({})</span>
        <span class="n">user2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">new</span><span class="p">({})</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="s1">&#39;user_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">user1</span><span class="o">.</span><span class="n">id</span><span class="p">]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user1</span><span class="o">.</span><span class="n">group_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user2</span><span class="o">.</span><span class="n">group_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">group</span><span class="o">.</span><span class="n">user_ids</span> <span class="o">+=</span> <span class="n">user2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user1</span><span class="o">.</span><span class="n">group_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user2</span><span class="o">.</span><span class="n">group_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_20_float">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_20_float">[docs]</a>
    <span class="k">def</span> <span class="nf">test_20_float</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test rounding of float fields &quot;&quot;&quot;</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.mixed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT 1 FROM test_new_api_mixed WHERE id=</span><span class="si">%s</span><span class="s2"> AND number=</span><span class="si">%s</span><span class="s2">&quot;</span>

        <span class="c1"># 2.49609375 (exact float) must be rounded to 2.5</span>
        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="mf">2.49609375</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;2.5&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">rowcount</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>

        <span class="c1"># 1.1 (1.1000000000000000888178420 in float) must be 1.1 in database</span>
        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="mf">1.1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;1.1&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">rowcount</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_21_float_digits">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_21_float_digits">[docs]</a>
    <span class="k">def</span> <span class="nf">test_21_float_digits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test field description &quot;&quot;&quot;</span>
        <span class="n">precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.decimal_new_api_number&#39;</span><span class="p">)</span>
        <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.mixed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fields_get</span><span class="p">()[</span><span class="s1">&#39;number2&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">description</span><span class="p">[</span><span class="s1">&#39;digits&#39;</span><span class="p">],</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">precision</span><span class="o">.</span><span class="n">digits</span><span class="p">))</span></div>


<div class="viewcode-block" id="TestFields.check_monetary">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.check_monetary">[docs]</a>
    <span class="k">def</span> <span class="nf">check_monetary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># determine the possible roundings of amount</span>
        <span class="k">if</span> <span class="n">currency</span><span class="p">:</span>
            <span class="n">ramount</span> <span class="o">=</span> <span class="n">currency</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>
            <span class="n">samount</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">float_repr</span><span class="p">(</span><span class="n">ramount</span><span class="p">,</span> <span class="n">currency</span><span class="o">.</span><span class="n">decimal_places</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ramount</span> <span class="o">=</span> <span class="n">samount</span> <span class="o">=</span> <span class="n">amount</span>

        <span class="c1"># check the currency on record</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">currency_id</span><span class="p">,</span> <span class="n">currency</span><span class="p">)</span>

        <span class="c1"># check the value on the record</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span> <span class="p">[</span><span class="n">ramount</span><span class="p">,</span> <span class="n">samount</span><span class="p">],</span> <span class="n">msg</span><span class="p">)</span>

        <span class="c1"># check the value in the database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT amount FROM test_new_api_mixed WHERE id=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">samount</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_20_monetary">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_20_monetary">[docs]</a>
    <span class="k">def</span> <span class="nf">test_20_monetary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test monetary fields &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.mixed&#39;</span><span class="p">]</span>
        <span class="n">currency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.currency&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">amount</span> <span class="o">=</span> <span class="mf">14.70126</span>

        <span class="k">for</span> <span class="n">rounding</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
            <span class="c1"># first retrieve a currency corresponding to rounding</span>
            <span class="k">if</span> <span class="n">rounding</span><span class="p">:</span>
                <span class="n">currency</span> <span class="o">=</span> <span class="n">currency</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;rounding&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">rounding</span><span class="p">)],</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">currency</span><span class="p">,</span> <span class="s2">&quot;No currency found for rounding </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">rounding</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># rounding=0 corresponds to currency=False</span>
                <span class="n">currency</span> <span class="o">=</span> <span class="n">currency</span><span class="o">.</span><span class="n">browse</span><span class="p">()</span>

            <span class="c1"># case 1: create with amount and currency</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span> <span class="s1">&#39;currency_id&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_monetary</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="s1">&#39;create(amount, currency)&#39;</span><span class="p">)</span>

            <span class="c1"># case 2: assign amount</span>
            <span class="n">record</span><span class="o">.</span><span class="n">amount</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">record</span><span class="o">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">amount</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_monetary</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="s1">&#39;assign(amount)&#39;</span><span class="p">)</span>

            <span class="c1"># case 3: write with amount and currency</span>
            <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;currency_id&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
            <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span> <span class="s1">&#39;currency_id&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_monetary</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="s1">&#39;write(amount, currency)&#39;</span><span class="p">)</span>

            <span class="c1"># case 4: write with amount only</span>
            <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
            <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_monetary</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="s1">&#39;write(amount)&#39;</span><span class="p">)</span>

            <span class="c1"># case 5: write with amount on several records</span>
            <span class="n">records</span> <span class="o">=</span> <span class="n">record</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;currency_id&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
            <span class="n">records</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
            <span class="n">records</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">})</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_monetary</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="s1">&#39;multi write(amount)&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_20_monetary_opw_2223134">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_20_monetary_opw_2223134">[docs]</a>
    <span class="k">def</span> <span class="nf">test_20_monetary_opw_2223134</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test monetary fields with cache override &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.monetary_order&#39;</span><span class="p">]</span>
        <span class="n">currency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.USD&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">total</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT total FROM test_new_api_monetary_order WHERE id=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
            <span class="p">[</span><span class="n">total</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># create, and compute amount</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;currency_id&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;line_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;subtotal&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">})],</span>
        <span class="p">})</span>
        <span class="n">check</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># delete and add a line: the deletion of the line clears the cache, then</span>
        <span class="c1"># the recomputation of &#39;total&#39; must prefetch record.currency_id without</span>
        <span class="c1"># screwing up the new value in cache</span>
        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
            <span class="s1">&#39;line_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">line_ids</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;subtotal&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">})],</span>
        <span class="p">})</span>
        <span class="n">check</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_20_monetary_related">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_20_monetary_related">[docs]</a>
    <span class="k">def</span> <span class="nf">test_20_monetary_related</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test value rounding with related currency &quot;&quot;&quot;</span>
        <span class="n">currency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.USD&#39;</span><span class="p">)</span>
        <span class="n">monetary_base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.monetary_base&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;base_currency_id&#39;</span><span class="p">:</span> <span class="n">currency</span><span class="o">.</span><span class="n">id</span>
        <span class="p">})</span>
        <span class="n">monetary_related</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.monetary_related&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;monetary_id&#39;</span><span class="p">:</span> <span class="n">monetary_base</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;SELECT total FROM test_new_api_monetary_related WHERE id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">monetary_related</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="p">[</span><span class="n">total</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="mf">.33</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_20_like">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_20_like">[docs]</a>
    <span class="k">def</span> <span class="nf">test_20_like</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test filtered_domain() on char fields. &quot;&quot;&quot;</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi.tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">)]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;ilike&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">)]))</span>

        <span class="n">record</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Bar&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">)]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;ilike&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">)]))</span>

        <span class="n">record</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">)]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;ilike&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">)]))</span></div>


<div class="viewcode-block" id="TestFields.test_21_date">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_21_date">[docs]</a>
    <span class="k">def</span> <span class="nf">test_21_date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test date fields &quot;&quot;&quot;</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.mixed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>

        <span class="c1"># one may assign False or None</span>
        <span class="n">record</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>

        <span class="c1"># one may assign date but not datetime objects</span>
        <span class="n">record</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">date</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># DLE P41: We now support to assign datetime to date. Not sure this is the good practice though.</span>
        <span class="c1"># with self.assertRaises(TypeError):</span>
        <span class="c1">#     record.date = datetime(2012, 5, 1, 10, 45, 0)</span>

        <span class="c1"># one may assign dates and datetime in the default format, and it must be checked</span>
        <span class="n">record</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="s1">&#39;2012-05-01&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">date</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">record</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="s2">&quot;2012-05-01 10:45:00&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">date</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">record</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="s1">&#39;12-5-1&#39;</span>

        <span class="c1"># check filtered_domain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-02&#39;</span><span class="p">)]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">))]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;!=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]))</span>

        <span class="n">record</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-02&#39;</span><span class="p">)]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">))]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;!=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]))</span></div>


<div class="viewcode-block" id="TestFields.test_21_datetime">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_21_datetime">[docs]</a>
    <span class="k">def</span> <span class="nf">test_21_datetime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test datetime fields &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">fields</span><span class="o">.</span><span class="n">Datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">microsecond</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.mixed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>

        <span class="c1"># assign falsy value</span>
        <span class="n">record</span><span class="o">.</span><span class="n">moment</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">moment</span><span class="p">)</span>

        <span class="c1"># assign string</span>
        <span class="n">record</span><span class="o">.</span><span class="n">moment</span> <span class="o">=</span> <span class="s1">&#39;2012-05-01&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">moment</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">record</span><span class="o">.</span><span class="n">moment</span> <span class="o">=</span> <span class="s1">&#39;2012-05-01 06:00:00&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">moment</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">record</span><span class="o">.</span><span class="n">moment</span> <span class="o">=</span> <span class="s1">&#39;12-5-1&#39;</span>

        <span class="c1"># assign date or datetime</span>
        <span class="n">record</span><span class="o">.</span><span class="n">moment</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">moment</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">record</span><span class="o">.</span><span class="n">moment</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">moment</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="c1"># check filtered_domain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;moment&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-02&#39;</span><span class="p">)]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;moment&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">))]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;moment&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;moment&#39;</span><span class="p">,</span> <span class="s1">&#39;!=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;moment&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]))</span>

        <span class="n">record</span><span class="o">.</span><span class="n">moment</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;moment&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;2012-05-02&#39;</span><span class="p">)]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;moment&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="n">date</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">))]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;moment&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;moment&#39;</span><span class="p">,</span> <span class="s1">&#39;!=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">([(</span><span class="s1">&#39;moment&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]))</span></div>


<div class="viewcode-block" id="TestFields.test_21_date_datetime_helpers">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_21_date_datetime_helpers">[docs]</a>
    <span class="k">def</span> <span class="nf">test_21_date_datetime_helpers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test date/datetime fields helpers &quot;&quot;&quot;</span>
        <span class="n">_date</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Date</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s2">&quot;2077-10-23&quot;</span><span class="p">)</span>
        <span class="n">_datetime</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Datetime</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s2">&quot;2077-10-23 09:42:00&quot;</span><span class="p">)</span>

        <span class="c1"># addition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">add</span><span class="p">(</span><span class="n">_date</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2077</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">28</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">add</span><span class="p">(</span><span class="n">_datetime</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2077</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

        <span class="c1"># subtraction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">subtract</span><span class="p">(</span><span class="n">_date</span><span class="p">,</span> <span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2077</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">23</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">subtract</span><span class="p">(</span><span class="n">_datetime</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2077</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="c1"># start_of</span>
        <span class="c1"># year</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">start_of</span><span class="p">(</span><span class="n">_date</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2077</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">start_of</span><span class="p">(</span><span class="n">_datetime</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">),</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2077</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># quarter</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="mi">2077</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="mi">2077</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">q3</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="mi">2077</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">q4</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="mi">2077</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">start_of</span><span class="p">(</span><span class="n">_date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="s1">&#39;quarter&#39;</span><span class="p">),</span> <span class="n">q1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">start_of</span><span class="p">(</span><span class="n">_date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="s1">&#39;quarter&#39;</span><span class="p">),</span> <span class="n">q2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">start_of</span><span class="p">(</span><span class="n">_date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">7</span><span class="p">),</span> <span class="s1">&#39;quarter&#39;</span><span class="p">),</span> <span class="n">q3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">start_of</span><span class="p">(</span><span class="n">_date</span><span class="p">,</span> <span class="s1">&#39;quarter&#39;</span><span class="p">),</span> <span class="n">q4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">start_of</span><span class="p">(</span><span class="n">_datetime</span><span class="p">,</span> <span class="s1">&#39;quarter&#39;</span><span class="p">),</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">q4</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">))</span>

        <span class="c1"># month</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">start_of</span><span class="p">(</span><span class="n">_date</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2077</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">start_of</span><span class="p">(</span><span class="n">_datetime</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">),</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2077</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># week</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">start_of</span><span class="p">(</span><span class="n">_date</span><span class="p">,</span> <span class="s1">&#39;week&#39;</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2077</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">18</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">start_of</span><span class="p">(</span><span class="n">_datetime</span><span class="p">,</span> <span class="s1">&#39;week&#39;</span><span class="p">),</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2077</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">18</span><span class="p">))</span>

        <span class="c1"># day</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">start_of</span><span class="p">(</span><span class="n">_date</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">),</span> <span class="n">_date</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">start_of</span><span class="p">(</span><span class="n">_datetime</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">),</span> <span class="n">_datetime</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># hour</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">start_of</span><span class="p">(</span><span class="n">_date</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">start_of</span><span class="p">(</span><span class="n">_datetime</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">),</span> <span class="n">_datetime</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># invalid</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">start_of</span><span class="p">(</span><span class="n">_datetime</span><span class="p">,</span> <span class="s1">&#39;poop&#39;</span><span class="p">)</span>

        <span class="c1"># end_of</span>
        <span class="c1"># year</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">end_of</span><span class="p">(</span><span class="n">_date</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">),</span> <span class="n">_date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">31</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">end_of</span><span class="p">(</span><span class="n">_datetime</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">),</span>
                         <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">_date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">31</span><span class="p">),</span> <span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">))</span>

        <span class="c1"># quarter</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="mi">2077</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="mi">2077</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
        <span class="n">q3</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="mi">2077</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
        <span class="n">q4</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="mi">2077</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">end_of</span><span class="p">(</span><span class="n">_date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;quarter&#39;</span><span class="p">),</span> <span class="n">q1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">end_of</span><span class="p">(</span><span class="n">_date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span> <span class="s1">&#39;quarter&#39;</span><span class="p">),</span> <span class="n">q2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">end_of</span><span class="p">(</span><span class="n">_date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">month</span><span class="o">=</span><span class="mi">9</span><span class="p">),</span> <span class="s1">&#39;quarter&#39;</span><span class="p">),</span> <span class="n">q3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">end_of</span><span class="p">(</span><span class="n">_date</span><span class="p">,</span> <span class="s1">&#39;quarter&#39;</span><span class="p">),</span> <span class="n">q4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">end_of</span><span class="p">(</span><span class="n">_datetime</span><span class="p">,</span> <span class="s1">&#39;quarter&#39;</span><span class="p">),</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">q4</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">))</span>

        <span class="c1"># month</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">end_of</span><span class="p">(</span><span class="n">_date</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">),</span> <span class="n">_date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">31</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">end_of</span><span class="p">(</span><span class="n">_datetime</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">),</span>
                         <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2077</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span> <span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">))</span>

        <span class="c1"># week</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">end_of</span><span class="p">(</span><span class="n">_date</span><span class="p">,</span> <span class="s1">&#39;week&#39;</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2077</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">end_of</span><span class="p">(</span><span class="n">_datetime</span><span class="p">,</span> <span class="s1">&#39;week&#39;</span><span class="p">),</span>
                         <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2077</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span> <span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">))</span>

        <span class="c1"># day</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">end_of</span><span class="p">(</span><span class="n">_date</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">),</span> <span class="n">_date</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">end_of</span><span class="p">(</span><span class="n">_datetime</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">),</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">_datetime</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">))</span>

        <span class="c1"># hour</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">end_of</span><span class="p">(</span><span class="n">_date</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">end_of</span><span class="p">(</span><span class="n">_datetime</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">),</span>
                         <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">_datetime</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="n">_datetime</span><span class="o">.</span><span class="n">hour</span><span class="p">))</span>

        <span class="c1"># invalid</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">end_of</span><span class="p">(</span><span class="n">_datetime</span><span class="p">,</span> <span class="s1">&#39;crap&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_22_selection">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_22_selection">[docs]</a>
    <span class="k">def</span> <span class="nf">test_22_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test selection fields &quot;&quot;&quot;</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.mixed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>

        <span class="c1"># one may assign False or None</span>
        <span class="n">record</span><span class="o">.</span><span class="n">lang</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">lang</span><span class="p">)</span>

        <span class="c1"># one may assign a value, and it must be checked</span>
        <span class="k">for</span> <span class="n">language</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.lang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([]):</span>
            <span class="n">record</span><span class="o">.</span><span class="n">lang</span> <span class="o">=</span> <span class="n">language</span><span class="o">.</span><span class="n">code</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">record</span><span class="o">.</span><span class="n">lang</span> <span class="o">=</span> <span class="s1">&#39;zz_ZZ&#39;</span></div>


<div class="viewcode-block" id="TestFields.test_23_relation">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_23_relation">[docs]</a>
    <span class="k">def</span> <span class="nf">test_23_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test relation fields &quot;&quot;&quot;</span>
        <span class="n">demo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_demo</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.message_0_0&#39;</span><span class="p">)</span>

        <span class="c1"># check environment of record and related records</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">discussion</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>

        <span class="n">demo_env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">demo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">demo_env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>

        <span class="c1"># check environment of record and related records</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">discussion</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>

        <span class="c1"># &quot;migrate&quot; message into demo_env, and check again</span>
        <span class="n">demo_message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">demo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">demo_message</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">demo_env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">demo_message</span><span class="o">.</span><span class="n">discussion</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">demo_env</span><span class="p">)</span>

        <span class="c1"># See YTI FIXME</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>

        <span class="c1"># assign record&#39;s parent to a record in demo_env</span>
        <span class="n">message</span><span class="o">.</span><span class="n">discussion</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">discussion</span><span class="o">.</span><span class="n">copy</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Copy&#39;</span><span class="p">})</span>

        <span class="c1"># both message and its parent field must be in self.env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">discussion</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_24_reference">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_24_reference">[docs]</a>
    <span class="k">def</span> <span class="nf">test_24_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test reference fields. &quot;&quot;&quot;</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.mixed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>

        <span class="c1"># one may assign False or None</span>
        <span class="n">record</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">reference</span><span class="p">)</span>

        <span class="c1"># one may assign a user or a partner...</span>
        <span class="n">record</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">reference</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">record</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">partner_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">reference</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">partner_id</span><span class="p">)</span>
        <span class="c1"># ... but no record from a model that starts with &#39;ir.&#39;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">record</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([],</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_25_related">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_25_related">[docs]</a>
    <span class="k">def</span> <span class="nf">test_25_related</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test related fields. &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.message_0_0&#39;</span><span class="p">)</span>
        <span class="n">discussion</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">discussion</span>

        <span class="c1"># by default related fields are not stored</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;discussion_name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">readonly</span><span class="p">)</span>

        <span class="c1"># check value of related field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">discussion_name</span><span class="p">,</span> <span class="n">discussion</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># change discussion name, and check result</span>
        <span class="n">discussion</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Foo&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">discussion_name</span><span class="p">,</span> <span class="s1">&#39;Foo&#39;</span><span class="p">)</span>

        <span class="c1"># change discussion name via related field, and check result</span>
        <span class="n">message</span><span class="o">.</span><span class="n">discussion_name</span> <span class="o">=</span> <span class="s1">&#39;Bar&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">discussion</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;Bar&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">discussion_name</span><span class="p">,</span> <span class="s1">&#39;Bar&#39;</span><span class="p">)</span>

        <span class="c1"># change discussion name via related field on several records</span>
        <span class="n">discussion1</span> <span class="o">=</span> <span class="n">discussion</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;X1&#39;</span><span class="p">})</span>
        <span class="n">discussion2</span> <span class="o">=</span> <span class="n">discussion</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;X2&#39;</span><span class="p">})</span>
        <span class="n">discussion1</span><span class="o">.</span><span class="n">participants</span> <span class="o">=</span> <span class="n">discussion2</span><span class="o">.</span><span class="n">participants</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span>
        <span class="n">message1</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;discussion&#39;</span><span class="p">:</span> <span class="n">discussion1</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="n">message2</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;discussion&#39;</span><span class="p">:</span> <span class="n">discussion2</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message1</span><span class="o">.</span><span class="n">discussion_name</span><span class="p">,</span> <span class="s1">&#39;X1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message2</span><span class="o">.</span><span class="n">discussion_name</span><span class="p">,</span> <span class="s1">&#39;X2&#39;</span><span class="p">)</span>

        <span class="p">(</span><span class="n">message1</span> <span class="o">+</span> <span class="n">message2</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;discussion_name&#39;</span><span class="p">:</span> <span class="s1">&#39;X3&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">discussion1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;X3&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">discussion2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;X3&#39;</span><span class="p">)</span>

        <span class="c1"># search on related field, and check result</span>
        <span class="n">search_on_related</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;discussion_name&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;Bar&#39;</span><span class="p">)])</span>
        <span class="n">search_on_regular</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;discussion.name&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;Bar&#39;</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">search_on_related</span><span class="p">,</span> <span class="n">search_on_regular</span><span class="p">)</span>

        <span class="c1"># check that field attributes are copied</span>
        <span class="n">message_field</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">fields_get</span><span class="p">([</span><span class="s1">&#39;discussion_name&#39;</span><span class="p">])[</span><span class="s1">&#39;discussion_name&#39;</span><span class="p">]</span>
        <span class="n">discussion_field</span> <span class="o">=</span> <span class="n">discussion</span><span class="o">.</span><span class="n">fields_get</span><span class="p">([</span><span class="s1">&#39;name&#39;</span><span class="p">])[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message_field</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">],</span> <span class="n">discussion_field</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="TestFields.test_25_related_attributes">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_25_related_attributes">[docs]</a>
    <span class="k">def</span> <span class="nf">test_25_related_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test the attributes of related fields &quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;test_new_api.foo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">trim</span><span class="p">,</span> <span class="s2">&quot;The target field is defined with trim=False&quot;</span><span class="p">)</span>

        <span class="c1"># trim=True is the default on the field&#39;s class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">trim</span><span class="p">,</span> <span class="s2">&quot;By default, a Char field has trim=True&quot;</span><span class="p">)</span>

        <span class="c1"># the parameter &#39;trim&#39; is not set in text1&#39;s definition, so the field</span>
        <span class="c1"># retrieves its value from text.trim</span>
        <span class="n">text1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;test_new_api.bar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">text1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">text1</span><span class="o">.</span><span class="n">trim</span><span class="p">,</span> <span class="s2">&quot;The related field retrieves trim=False from target&quot;</span><span class="p">)</span>

        <span class="c1"># text2 is defined with trim=True, so it should get that value</span>
        <span class="n">text2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;test_new_api.bar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">text2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">text2</span><span class="o">.</span><span class="n">trim</span><span class="p">,</span> <span class="s2">&quot;The related field was defined with trim=True&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_25_related_single">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_25_related_single">[docs]</a>
    <span class="k">def</span> <span class="nf">test_25_related_single</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test related fields with a single field in the path. &quot;&quot;&quot;</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.related&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">related_name</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">related_related_name</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># check searching on related fields</span>
        <span class="n">records0</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">records0</span><span class="p">)</span>
        <span class="n">records1</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;related_name&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">records1</span><span class="p">,</span> <span class="n">records0</span><span class="p">)</span>
        <span class="n">records2</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;related_related_name&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">records2</span><span class="p">,</span> <span class="n">records0</span><span class="p">)</span>

        <span class="c1"># check writing on related fields</span>
        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;related_name&#39;</span><span class="p">:</span> <span class="s1">&#39;B&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">)</span>
        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;related_related_name&#39;</span><span class="p">:</span> <span class="s1">&#39;C&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_25_related_multi">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_25_related_multi">[docs]</a>
    <span class="k">def</span> <span class="nf">test_25_related_multi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test write() on several related fields based on a common computed field. &quot;&quot;&quot;</span>
        <span class="n">foo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.foo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;value1&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;value2&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
        <span class="n">oof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.foo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;value1&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;value2&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.bar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="n">foo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">value1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">value2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;value1&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;value2&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">value1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">value2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="c1"># modify &#39;name&#39;, and search on &#39;foo&#39;: this should flush &#39;name&#39;</span>
        <span class="n">bar</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;B&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bar</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="n">oof</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">bar</span><span class="p">,</span> <span class="n">bar</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">oof</span><span class="o">.</span><span class="n">ids</span><span class="p">)]))</span></div>


<div class="viewcode-block" id="TestFields.test_25_one2many_inverse_related">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_25_one2many_inverse_related">[docs]</a>
    <span class="k">def</span> <span class="nf">test_25_one2many_inverse_related</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.trigger.left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.trigger.right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">right_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">right</span><span class="o">.</span><span class="n">left_ids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">right</span><span class="o">.</span><span class="n">left_size</span><span class="p">)</span>

        <span class="c1"># create middle: this should trigger left.right_id by traversing</span>
        <span class="c1"># middle.left_id, and right.left_size by traversing left.right_id</span>
        <span class="c1"># after its computation!</span>
        <span class="n">middle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.trigger.middle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;left_id&#39;</span><span class="p">:</span> <span class="n">left</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;right_id&#39;</span><span class="p">:</span> <span class="n">right</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">right_id</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">right</span><span class="o">.</span><span class="n">left_ids</span><span class="p">,</span> <span class="n">left</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">right</span><span class="o">.</span><span class="n">left_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># delete middle: this should trigger left.right_id by traversing</span>
        <span class="c1"># middle.left_id, and right.left_size by traversing left.right_id</span>
        <span class="c1"># before its computation!</span>
        <span class="n">middle</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">right_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">right</span><span class="o">.</span><span class="n">left_ids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">right</span><span class="o">.</span><span class="n">left_size</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_26_inherited">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_26_inherited">[docs]</a>
    <span class="k">def</span> <span class="nf">test_26_inherited</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test inherited fields. &quot;&quot;&quot;</span>
        <span class="c1"># a bunch of fields are inherited from res_partner</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([]):</span>
            <span class="n">partner</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">partner_id</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;is_company&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="s1">&#39;country_id&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">field</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">partner</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">partner</span><span class="p">[</span><span class="n">field</span><span class="p">])</span></div>


<div class="viewcode-block" id="TestFields.test_27_company_dependent">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_27_company_dependent">[docs]</a>
    <span class="k">def</span> <span class="nf">test_27_company_dependent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test company-dependent fields. &quot;&quot;&quot;</span>
        <span class="c1"># consider three companies</span>
        <span class="n">company0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.main_company&#39;</span><span class="p">)</span>
        <span class="n">company1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">})</span>
        <span class="n">company2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;B&#39;</span><span class="p">})</span>

        <span class="c1"># create one user per company</span>
        <span class="n">user0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;company_id&#39;</span><span class="p">:</span> <span class="n">company0</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;company_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="n">company0</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">company1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">company2</span><span class="o">.</span><span class="n">id</span><span class="p">])]})</span>
        <span class="n">user1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Bar&#39;</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;company_id&#39;</span><span class="p">:</span> <span class="n">company1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;company_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="n">company0</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">company1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">company2</span><span class="o">.</span><span class="n">id</span><span class="p">])]})</span>
        <span class="n">user2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Baz&#39;</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;company_id&#39;</span><span class="p">:</span> <span class="n">company2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;company_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="n">company0</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">company1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">company2</span><span class="o">.</span><span class="n">id</span><span class="p">])]})</span>

        <span class="c1"># create values for many2one field</span>
        <span class="n">tag0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi.tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Qux&#39;</span><span class="p">})</span>
        <span class="n">tag1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi.tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Quux&#39;</span><span class="p">})</span>
        <span class="n">tag2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi.tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Quuz&#39;</span><span class="p">})</span>

        <span class="c1"># create default values for the company-dependent fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.property&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_set_default</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;test_new_api.company&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.property&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_set_default</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;test_new_api.company&#39;</span><span class="p">,</span> <span class="s1">&#39;default1&#39;</span><span class="p">,</span> <span class="n">company1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.property&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_set_default</span><span class="p">(</span><span class="s1">&#39;tag_id&#39;</span><span class="p">,</span> <span class="s1">&#39;test_new_api.company&#39;</span><span class="p">,</span> <span class="n">tag0</span><span class="p">)</span>

        <span class="c1"># assumption: users don&#39;t have access to &#39;ir.property&#39;</span>
        <span class="n">accesses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.access&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;model_id.model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;ir.property&#39;</span><span class="p">)])</span>
        <span class="n">accesses</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">([</span><span class="s1">&#39;perm_read&#39;</span><span class="p">,</span> <span class="s1">&#39;perm_write&#39;</span><span class="p">,</span> <span class="s1">&#39;perm_create&#39;</span><span class="p">,</span> <span class="s1">&#39;perm_unlink&#39;</span><span class="p">],</span> <span class="kc">False</span><span class="p">))</span>

        <span class="c1"># create/modify a record, and check the value for each user</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;main&#39;</span><span class="p">,</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="s1">&#39;1932-11-09&#39;</span><span class="p">,</span>
            <span class="s1">&#39;moment&#39;</span><span class="p">:</span> <span class="s1">&#39;1932-11-09 00:00:00&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tag_id&#39;</span><span class="p">:</span> <span class="n">tag1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user0</span><span class="p">)</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;main&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;default1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user2</span><span class="p">)</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user0</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">),</span> <span class="s1">&#39;1932-11-09&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user2</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user0</span><span class="p">)</span><span class="o">.</span><span class="n">moment</span><span class="p">),</span> <span class="s1">&#39;1932-11-09 00:00:00&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span><span class="o">.</span><span class="n">moment</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user2</span><span class="p">)</span><span class="o">.</span><span class="n">moment</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user0</span><span class="p">)</span><span class="o">.</span><span class="n">tag_id</span><span class="p">,</span> <span class="n">tag1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span><span class="o">.</span><span class="n">tag_id</span><span class="p">,</span> <span class="n">tag0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user2</span><span class="p">)</span><span class="o">.</span><span class="n">tag_id</span><span class="p">,</span> <span class="n">tag0</span><span class="p">)</span>

        <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
            <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="s1">&#39;1932-12-10&#39;</span><span class="p">,</span>
            <span class="s1">&#39;moment&#39;</span><span class="p">:</span> <span class="s1">&#39;1932-12-10 23:59:59&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tag_id&#39;</span><span class="p">:</span> <span class="n">tag2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user0</span><span class="p">)</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;main&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user2</span><span class="p">)</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user0</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">),</span> <span class="s1">&#39;1932-11-09&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">),</span> <span class="s1">&#39;1932-12-10&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user2</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user0</span><span class="p">)</span><span class="o">.</span><span class="n">moment</span><span class="p">),</span> <span class="s1">&#39;1932-11-09 00:00:00&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span><span class="o">.</span><span class="n">moment</span><span class="p">),</span> <span class="s1">&#39;1932-12-10 23:59:59&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user2</span><span class="p">)</span><span class="o">.</span><span class="n">moment</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user0</span><span class="p">)</span><span class="o">.</span><span class="n">tag_id</span><span class="p">,</span> <span class="n">tag1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span><span class="o">.</span><span class="n">tag_id</span><span class="p">,</span> <span class="n">tag2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user2</span><span class="p">)</span><span class="o">.</span><span class="n">tag_id</span><span class="p">,</span> <span class="n">tag0</span><span class="p">)</span>

        <span class="c1"># regression: duplicated records caused values to be browse(browse(id))</span>
        <span class="n">recs</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span> <span class="o">+</span> <span class="n">record</span> <span class="o">+</span> <span class="n">record</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">recs</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">tag_id</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>

        <span class="c1"># unlink value of a many2one (tag2), and check again</span>
        <span class="n">tag2</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user0</span><span class="p">)</span><span class="o">.</span><span class="n">tag_id</span><span class="p">,</span> <span class="n">tag1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span><span class="o">.</span><span class="n">tag_id</span><span class="p">,</span> <span class="n">tag0</span><span class="o">.</span><span class="n">browse</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user2</span><span class="p">)</span><span class="o">.</span><span class="n">tag_id</span><span class="p">,</span> <span class="n">tag0</span><span class="p">)</span>

        <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user0</span><span class="p">)</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;main&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user2</span><span class="p">)</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">)</span>

        <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user0</span><span class="p">)</span><span class="o">.</span><span class="n">with_company</span><span class="p">(</span><span class="n">company1</span><span class="p">)</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="s1">&#39;beta&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user0</span><span class="p">)</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;main&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user2</span><span class="p">)</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">)</span>

        <span class="c1"># add group on company-dependent field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">user0</span><span class="o">.</span><span class="n">has_group</span><span class="p">(</span><span class="s1">&#39;base.group_system&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">record</span><span class="p">)</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;groups&#39;</span><span class="p">,</span> <span class="s1">&#39;base.group_system&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">AccessError</span><span class="p">):</span>
            <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user0</span><span class="p">)</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="s1">&#39;forbidden&#39;</span>

        <span class="n">user0</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;groups_id&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.group_system&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>
        <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user0</span><span class="p">)</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="s1">&#39;yes we can&#39;</span>

        <span class="c1"># add ir.rule to prevent access on record</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user0</span><span class="o">.</span><span class="n">_is_internal</span><span class="p">())</span>
        <span class="n">rule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.rule&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;model_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_id</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">_name</span><span class="p">),</span>
            <span class="s1">&#39;groups&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.group_user&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">],</span>
            <span class="s1">&#39;domain_force&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;!=&#39;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">)]),</span>
        <span class="p">})</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">AccessError</span><span class="p">):</span>
            <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user0</span><span class="p">)</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="s1">&#39;forbidden&#39;</span>

        <span class="c1"># create company record and attribute</span>
        <span class="n">company_record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;ABC&#39;</span><span class="p">})</span>
        <span class="n">attribute_record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.company.attr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;company&#39;</span><span class="p">:</span> <span class="n">company_record</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">attribute_record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;ABC&#39;</span><span class="p">)</span>

        <span class="c1"># change quantity, &#39;bar&#39; should recompute to &#39;ABCABC&#39;</span>
        <span class="n">attribute_record</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">attribute_record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;ABCABC&#39;</span><span class="p">)</span>

        <span class="c1"># change company field &#39;foo&#39;, &#39;bar&#39; should recompute to &#39;DEFDEF&#39;</span>
        <span class="n">company_record</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="s1">&#39;DEF&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">attribute_record</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;DEF&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">attribute_record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;DEFDEF&#39;</span><span class="p">)</span>

        <span class="c1"># a low priviledge user should be able to search on company_dependent fields</span>
        <span class="n">company_record</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">groups_id</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.group_system&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">company_record</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_group</span><span class="p">(</span><span class="s1">&#39;base.group_system&#39;</span><span class="p">))</span>
        <span class="n">company_records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;DEF&#39;</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">company_records</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_28_company_dependent_search">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_28_company_dependent_search">[docs]</a>
    <span class="k">def</span> <span class="nf">test_28_company_dependent_search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Test the search on company-dependent fields in all corner cases.</span>
<span class="sd">            This assumes that filtered_domain() correctly filters records when</span>
<span class="sd">            its domain refers to company-dependent fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Property</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.property&#39;</span><span class="p">]</span>
        <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.company&#39;</span><span class="p">]</span>

        <span class="c1"># create 4 records for all cases: two with explicit truthy values, one</span>
        <span class="c1"># with an explicit falsy value, and one without an explicit value</span>
        <span class="n">records</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">create</span><span class="p">([{}]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>

        <span class="c1"># For each field, we assign values to the records, and test a number of</span>
        <span class="c1"># searches.  The search cases are given by comparison operators, and for</span>
        <span class="c1"># each operator, we test a number of possible operands.  Every search()</span>
        <span class="c1"># returns a subset of the records, and we compare it to an equivalent</span>
        <span class="c1"># search performed by filtered_domain().</span>

        <span class="k">def</span> <span class="nf">test_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">truthy_values</span><span class="p">,</span> <span class="n">operations</span><span class="p">):</span>
            <span class="c1"># set ir.properties to all records except the last one</span>
            <span class="n">Property</span><span class="o">.</span><span class="n">_set_multi</span><span class="p">(</span>
                <span class="n">field_name</span><span class="p">,</span> <span class="n">Model</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                <span class="p">{</span><span class="n">rec</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">rec</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">truthy_values</span> <span class="o">+</span> <span class="p">[</span><span class="kc">False</span><span class="p">])},</span>
                <span class="c1"># Using this sentinel for &#39;default_value&#39; forces the method to</span>
                <span class="c1"># create &#39;ir.property&#39; records for the value False. Without it,</span>
                <span class="c1"># no property would be created because False is the default</span>
                <span class="c1"># value.</span>
                <span class="n">default_value</span><span class="o">=</span><span class="nb">object</span><span class="p">(),</span>
            <span class="p">)</span>

            <span class="c1"># test without default value</span>
            <span class="n">test_cases</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">operations</span><span class="p">)</span>

            <span class="c1"># set default value to False</span>
            <span class="n">Property</span><span class="o">.</span><span class="n">_set_default</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">Model</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>
            <span class="n">test_cases</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

            <span class="c1"># set default value to truthy_values[0]</span>
            <span class="n">Property</span><span class="o">.</span><span class="n">_set_default</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">Model</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">truthy_values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>
            <span class="n">test_cases</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span> <span class="n">truthy_values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">test_cases</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">operator</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">operations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                    <span class="n">domain</span> <span class="o">=</span> <span class="p">[(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">value</span><span class="p">)]</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">):</span>
                        <span class="n">search_result</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">records</span><span class="o">.</span><span class="n">ids</span><span class="p">)]</span> <span class="o">+</span> <span class="n">domain</span><span class="p">)</span>
                        <span class="n">filter_result</span> <span class="o">=</span> <span class="n">records</span><span class="o">.</span><span class="n">filtered_domain</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                            <span class="n">search_result</span><span class="p">,</span> <span class="n">filter_result</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s2">&quot;Got values </span><span class="si">{</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">search_result</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;instead of </span><span class="si">{</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">filter_result</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="p">)</span>

        <span class="c1"># boolean fields</span>
        <span class="n">test_field</span><span class="p">(</span><span class="s1">&#39;truth&#39;</span><span class="p">,</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span> <span class="p">{</span>
            <span class="s1">&#39;=&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;!=&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="p">})</span>
        <span class="c1"># integer fields</span>
        <span class="n">test_field</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="p">{</span>
            <span class="s1">&#39;=&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;!=&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;&gt;=&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;&lt;=&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">})</span>
        <span class="c1"># float fields</span>
        <span class="n">test_field</span><span class="p">(</span><span class="s1">&#39;phi&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.61803</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">{</span>
            <span class="s1">&#39;=&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.61803</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;!=&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.61803</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.61803</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;&gt;=&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.61803</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;&lt;=&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.61803</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.61803</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">})</span>
        <span class="c1"># char fields</span>
        <span class="n">test_field</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;qwer&#39;</span><span class="p">,</span> <span class="s1">&#39;azer&#39;</span><span class="p">],</span> <span class="p">{</span>
            <span class="s1">&#39;like&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;qwer&#39;</span><span class="p">,</span> <span class="s1">&#39;azer&#39;</span><span class="p">),</span>
            <span class="s1">&#39;ilike&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;qwer&#39;</span><span class="p">,</span> <span class="s1">&#39;azer&#39;</span><span class="p">),</span>
            <span class="s1">&#39;not like&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;qwer&#39;</span><span class="p">,</span> <span class="s1">&#39;azer&#39;</span><span class="p">),</span>
            <span class="s1">&#39;not ilike&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;qwer&#39;</span><span class="p">,</span> <span class="s1">&#39;azer&#39;</span><span class="p">),</span>
            <span class="s1">&#39;=&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;qwer&#39;</span><span class="p">,</span> <span class="s1">&#39;azer&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;!=&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;qwer&#39;</span><span class="p">,</span> <span class="s1">&#39;azer&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;not in&#39;</span><span class="p">:</span> <span class="p">([</span><span class="s1">&#39;qwer&#39;</span><span class="p">,</span> <span class="s1">&#39;azer&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;qwer&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span> <span class="p">[</span><span class="kc">False</span><span class="p">],</span> <span class="p">[]),</span>
            <span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="p">([</span><span class="s1">&#39;qwer&#39;</span><span class="p">,</span> <span class="s1">&#39;azer&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;qwer&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span> <span class="p">[</span><span class="kc">False</span><span class="p">],</span> <span class="p">[]),</span>
        <span class="p">})</span>
        <span class="c1"># date fields</span>
        <span class="n">date1</span><span class="p">,</span> <span class="n">date2</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">22</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">23</span><span class="p">)</span>
        <span class="n">test_field</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">date1</span><span class="p">,</span> <span class="n">date2</span><span class="p">],</span> <span class="p">{</span>
            <span class="s1">&#39;=&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">date1</span><span class="p">,</span> <span class="n">date2</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;!=&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">date1</span><span class="p">,</span> <span class="n">date2</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">date1</span><span class="p">,</span> <span class="n">date2</span><span class="p">),</span>
            <span class="s1">&#39;&gt;=&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">date1</span><span class="p">,</span> <span class="n">date2</span><span class="p">),</span>
            <span class="s1">&#39;&lt;=&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">date1</span><span class="p">,</span> <span class="n">date2</span><span class="p">),</span>
            <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">date1</span><span class="p">,</span> <span class="n">date2</span><span class="p">),</span>
        <span class="p">})</span>
        <span class="c1"># datetime fields</span>
        <span class="n">moment1</span><span class="p">,</span> <span class="n">moment2</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">22</span><span class="p">),</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">23</span><span class="p">)</span>
        <span class="n">test_field</span><span class="p">(</span><span class="s1">&#39;moment&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">moment1</span><span class="p">,</span> <span class="n">moment2</span><span class="p">],</span> <span class="p">{</span>
            <span class="s1">&#39;=&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">moment1</span><span class="p">,</span> <span class="n">moment2</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;!=&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">moment1</span><span class="p">,</span> <span class="n">moment2</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">moment1</span><span class="p">,</span> <span class="n">moment2</span><span class="p">),</span>
            <span class="s1">&#39;&gt;=&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">moment1</span><span class="p">,</span> <span class="n">moment2</span><span class="p">),</span>
            <span class="s1">&#39;&lt;=&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">moment1</span><span class="p">,</span> <span class="n">moment2</span><span class="p">),</span>
            <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">moment1</span><span class="p">,</span> <span class="n">moment2</span><span class="p">),</span>
        <span class="p">})</span>
        <span class="c1"># many2one fields</span>
        <span class="n">tag1</span><span class="p">,</span> <span class="n">tag2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi.tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">([{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;one&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;two&#39;</span><span class="p">}])</span>
        <span class="n">test_field</span><span class="p">(</span><span class="s1">&#39;tag_id&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">tag1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">tag2</span><span class="o">.</span><span class="n">id</span><span class="p">],</span> <span class="p">{</span>
            <span class="s1">&#39;like&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">tag1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tag2</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="s1">&#39;ilike&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">tag1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tag2</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="s1">&#39;not like&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">tag1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tag2</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="s1">&#39;not ilike&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">tag1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tag2</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="s1">&#39;=&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">tag1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">tag2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;!=&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">tag1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">tag2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;in&#39;</span><span class="p">:</span> <span class="p">([</span><span class="n">tag1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">tag2</span><span class="o">.</span><span class="n">id</span><span class="p">],</span> <span class="p">[</span><span class="n">tag2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span> <span class="p">[</span><span class="kc">False</span><span class="p">],</span> <span class="p">[]),</span>
            <span class="s1">&#39;not in&#39;</span><span class="p">:</span> <span class="p">([</span><span class="n">tag1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">tag2</span><span class="o">.</span><span class="n">id</span><span class="p">],</span> <span class="p">[</span><span class="n">tag2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span> <span class="p">[</span><span class="kc">False</span><span class="p">],</span> <span class="p">[]),</span>
            <span class="s1">&#39;any&#39;</span><span class="p">:</span> <span class="p">([(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">tag1</span><span class="o">.</span><span class="n">name</span><span class="p">)],</span> <span class="p">[(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)],</span> <span class="p">[]),</span>
            <span class="s1">&#39;not any&#39;</span><span class="p">:</span> <span class="p">([(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">tag1</span><span class="o">.</span><span class="n">name</span><span class="p">)],</span> <span class="p">[(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)],</span> <span class="p">[]),</span>
        <span class="p">})</span></div>


<div class="viewcode-block" id="TestFields.test_29_company_dependent_html">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_29_company_dependent_html">[docs]</a>
    <span class="k">def</span> <span class="nf">test_29_company_dependent_html</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">company0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.main_company&#39;</span><span class="p">)</span>
        <span class="n">company1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">})</span>
        <span class="n">company2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;B&#39;</span><span class="p">})</span>

        <span class="n">user0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;company_id&#39;</span><span class="p">:</span> <span class="n">company0</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;company_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="n">company0</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">company1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">company2</span><span class="o">.</span><span class="n">id</span><span class="p">])]})</span>
        <span class="n">user1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Bar&#39;</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;company_id&#39;</span><span class="p">:</span> <span class="n">company1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;company_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="n">company0</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">company1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">company2</span><span class="o">.</span><span class="n">id</span><span class="p">])]})</span>
        <span class="n">user2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Baz&#39;</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;company_id&#39;</span><span class="p">:</span> <span class="n">company2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;company_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="n">company0</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">company1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">company2</span><span class="o">.</span><span class="n">id</span><span class="p">])]})</span>

        <span class="n">some_ugly_html_0</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;p&gt;Oops this should maybe be sanitized</span>
<span class="si">% i</span><span class="s2">f object.some_field and not object.oriented:</span>
<span class="s2">&lt;table&gt;</span>
<span class="s2">    </span><span class="si">% i</span><span class="s2">f object.other_field:</span>
<span class="s2">    &lt;tr style=&quot;margin: 0px; border: 10px solid black;&quot;&gt;</span>
<span class="s2">        $</span><span class="si">{object.mako_thing}</span>
<span class="s2">        &lt;td&gt;</span>
<span class="s2">    &lt;/tr&gt;</span>
<span class="s2">    &lt;tr class=&quot;custom_class&quot;&gt;</span>
<span class="s2">        This is some html.</span>
<span class="s2">    &lt;/tr&gt;</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndif</span>
<span class="s2">    &lt;tr&gt;</span>
<span class="si">%i</span><span class="s2">f object.dummy_field:</span>
<span class="s2">        &lt;p&gt;user0&lt;/p&gt;</span>
<span class="si">%e</span><span class="s2">ndif&quot;&quot;&quot;</span>

        <span class="n">some_ugly_html_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;p&gt;Oops this should maybe be sanitized</span>
<span class="si">% i</span><span class="s2">f object.some_field and not object.oriented:</span>
<span class="s2">&lt;table&gt;</span>
<span class="s2">    </span><span class="si">% i</span><span class="s2">f object.other_field:</span>
<span class="s2">    &lt;tr style=&quot;margin: 0px; border: 10px solid black;&quot;&gt;</span>
<span class="s2">        $</span><span class="si">{object.mako_thing}</span>
<span class="s2">        &lt;td&gt;</span>
<span class="s2">    &lt;/tr&gt;</span>
<span class="s2">    &lt;tr class=&quot;custom_class&quot;&gt;</span>
<span class="s2">        This is some html.</span>
<span class="s2">    &lt;/tr&gt;</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndif</span>
<span class="s2">    &lt;tr&gt;</span>
<span class="si">%i</span><span class="s2">f object.dummy_field:</span>
<span class="s2">        &lt;p&gt;user1&lt;/p&gt;</span>
<span class="si">%e</span><span class="s2">ndif&quot;&quot;&quot;</span>

        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;html1&#39;</span><span class="p">:</span> <span class="n">some_ugly_html_0</span><span class="p">,</span>
            <span class="s1">&#39;html2&#39;</span><span class="p">:</span> <span class="n">some_ugly_html_0</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user0</span><span class="p">)</span><span class="o">.</span><span class="n">html1</span><span class="p">,</span> <span class="n">some_ugly_html_0</span><span class="p">,</span> <span class="s1">&#39;Error in HTML field: content was sanitized but field has sanitize=False&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span><span class="o">.</span><span class="n">html1</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user2</span><span class="p">)</span><span class="o">.</span><span class="n">html1</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># sanitize should have closed tags left open in the original html for user0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;&lt;/table&gt;&#39;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user0</span><span class="p">)</span><span class="o">.</span><span class="n">html2</span><span class="p">,</span> <span class="s1">&#39;Error in HTML field: content does not seem to have been sanitized despise sanitize=True&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;&lt;/td&gt;&#39;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user0</span><span class="p">)</span><span class="o">.</span><span class="n">html2</span><span class="p">,</span> <span class="s1">&#39;Error in HTML field: content does not seem to have been sanitized despise sanitize=True&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;&lt;tr class=&quot;&#39;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user0</span><span class="p">)</span><span class="o">.</span><span class="n">html2</span><span class="p">,</span> <span class="s1">&#39;Class attr should have been stripped&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;&lt;tr style=&quot;&#39;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user0</span><span class="p">)</span><span class="o">.</span><span class="n">html2</span><span class="p">,</span> <span class="s1">&#39;Style attr should have been stripped&#39;</span><span class="p">)</span>

        <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
            <span class="s1">&#39;html1&#39;</span><span class="p">:</span> <span class="n">some_ugly_html_1</span><span class="p">,</span>
            <span class="s1">&#39;html2&#39;</span><span class="p">:</span> <span class="n">some_ugly_html_1</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user0</span><span class="p">)</span><span class="o">.</span><span class="n">html1</span><span class="p">,</span> <span class="n">some_ugly_html_0</span><span class="p">,</span> <span class="s1">&#39;Error in HTML field: content was sanitized but field has sanitize=False&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span><span class="o">.</span><span class="n">html1</span><span class="p">,</span> <span class="n">some_ugly_html_1</span><span class="p">,</span> <span class="s1">&#39;Error in HTML field: content was sanitized but field has sanitize=False&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user2</span><span class="p">)</span><span class="o">.</span><span class="n">html1</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># sanitize should have closed tags left open in the original html for user1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;&lt;/table&gt;&#39;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span><span class="o">.</span><span class="n">html2</span><span class="p">,</span> <span class="s1">&#39;Error in HTML field: content does not seem to have been sanitized despise sanitize=True&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;&lt;/td&gt;&#39;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span><span class="o">.</span><span class="n">html2</span><span class="p">,</span> <span class="s1">&#39;Error in HTML field: content does not seem to have been sanitized despise sanitize=True&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;&lt;tr class=&quot;&#39;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span><span class="o">.</span><span class="n">html2</span><span class="p">,</span> <span class="s1">&#39;Class attr should have been stripped&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;&lt;tr style=&quot;&#39;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user1</span><span class="p">)</span><span class="o">.</span><span class="n">html2</span><span class="p">,</span> <span class="s1">&#39;Style attr should have been stripped&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_30_read">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_30_read">[docs]</a>
    <span class="k">def</span> <span class="nf">test_30_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test computed fields as returned by read(). &quot;&quot;&quot;</span>
        <span class="n">discussion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.discussion_0&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">discussion</span><span class="o">.</span><span class="n">messages</span><span class="p">:</span>
            <span class="n">display_name</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">display_name</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">size</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">read</span><span class="p">([</span><span class="s1">&#39;display_name&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;display_name&#39;</span><span class="p">],</span> <span class="n">display_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span> <span class="n">size</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_31_prefetch">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_31_prefetch">[docs]</a>
    <span class="k">def</span> <span class="nf">test_31_prefetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test prefetch of records handle AccessError &quot;&quot;&quot;</span>
        <span class="n">Category</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.category&#39;</span><span class="p">]</span>
        <span class="n">cat1</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;NOACCESS&#39;</span><span class="p">})</span>
        <span class="n">cat2</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;ACCESS&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">cat1</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="n">cats</span> <span class="o">=</span> <span class="n">cat1</span> <span class="o">+</span> <span class="n">cat2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span> <span class="o">=</span> <span class="n">cats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cat2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;ACCESS&#39;</span><span class="p">)</span>
        <span class="c1"># both categories should be ready for prefetching</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertItemsEqual</span><span class="p">(</span><span class="n">cat2</span><span class="o">.</span><span class="n">_prefetch_ids</span><span class="p">,</span> <span class="n">cats</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
        <span class="c1"># but due to our (lame) overwrite of `read`, it should not forbid us to read records we have access to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">cat2</span><span class="o">.</span><span class="n">discussions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cat2</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">cat1</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">AccessError</span><span class="p">):</span>
            <span class="n">cat1</span><span class="o">.</span><span class="n">name</span></div>


<div class="viewcode-block" id="TestFields.test_32_prefetch_missing_error">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_32_prefetch_missing_error">[docs]</a>
    <span class="k">def</span> <span class="nf">test_32_prefetch_missing_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Test that prefetching non-column fields works in the presence of deleted records. &quot;&quot;&quot;</span>
        <span class="n">Discussion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.discussion&#39;</span><span class="p">]</span>

        <span class="c1"># add an ir.rule that forces reading field &#39;name&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.rule&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;model_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">Discussion</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;groups&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.group_user&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">],</span>
            <span class="s1">&#39;domain_force&#39;</span><span class="p">:</span> <span class="s2">&quot;[(&#39;name&#39;, &#39;!=&#39;, &#39;Super Secret discution&#39;)]&quot;</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="n">records</span> <span class="o">=</span> <span class="n">Discussion</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_demo</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">([</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;EXISTING&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;MISSING&#39;</span><span class="p">},</span>
        <span class="p">])</span>

        <span class="c1"># unpack to keep the prefetch on each recordset</span>
        <span class="n">existing</span><span class="p">,</span> <span class="n">deleted</span> <span class="o">=</span> <span class="n">records</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">existing</span><span class="o">.</span><span class="n">_prefetch_ids</span><span class="p">,</span> <span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>

        <span class="c1"># this invalidates the caches but the prefetching remains the same</span>
        <span class="n">deleted</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="c1"># this should not trigger a MissingError</span>
        <span class="n">existing</span><span class="o">.</span><span class="n">categories</span>

        <span class="c1"># invalidate &#39;categories&#39; for the assertQueryCount</span>
        <span class="n">records</span><span class="o">.</span><span class="n">invalidate_model</span><span class="p">([</span><span class="s1">&#39;categories&#39;</span><span class="p">])</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="c1"># &lt;categories&gt;.__get__(existing)</span>
            <span class="c1">#  -&gt; records._fetch_field([&#39;categories&#39;])</span>
            <span class="c1">#      -&gt; records._read([&#39;categories&#39;])</span>
            <span class="c1">#          -&gt; records.check_access_rule(&#39;read&#39;)</span>
            <span class="c1">#              -&gt; records._filter_access_rules_python(&#39;read&#39;)</span>
            <span class="c1">#                  -&gt; records.filtered_domain(...)</span>
            <span class="c1">#                      -&gt; &lt;name&gt;.__get__(existing)</span>
            <span class="c1">#                          -&gt; records._fetch_field([&#39;name&#39;])</span>
            <span class="c1">#                              -&gt; records._read([&#39;name&#39;, ...])</span>
            <span class="c1">#                                  -&gt; ONE QUERY to read [&#39;name&#39;, ...] of records</span>
            <span class="c1">#                                  -&gt; ONE QUERY for deleted.exists() / code: forbidden = missing.exists()</span>
            <span class="c1">#          -&gt; ONE QUERY for records.exists() / code: self = self.exists()</span>
            <span class="c1">#          -&gt; ONE QUERY to read the many2many of existing</span>
            <span class="n">existing</span><span class="o">.</span><span class="n">categories</span>

        <span class="c1"># this one must trigger a MissingError</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">MissingError</span><span class="p">):</span>
            <span class="n">deleted</span><span class="o">.</span><span class="n">categories</span>

        <span class="c1"># special case: should not fail</span>
        <span class="n">Discussion</span><span class="o">.</span><span class="n">browse</span><span class="p">([</span><span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">read</span><span class="p">([</span><span class="s1">&#39;categories&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="TestFields.test_40_real_vs_new">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_40_real_vs_new">[docs]</a>
    <span class="k">def</span> <span class="nf">test_40_real_vs_new</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test field access on new records vs real records. &quot;&quot;&quot;</span>
        <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.category&#39;</span><span class="p">]</span>
        <span class="n">real_record</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">})</span>
        <span class="n">new_origin</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Bar&#39;</span><span class="p">},</span> <span class="n">origin</span><span class="o">=</span><span class="n">real_record</span><span class="p">)</span>
        <span class="n">new_record</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Baz&#39;</span><span class="p">})</span>

        <span class="c1"># non-computed non-stored field: default value</span>
        <span class="n">real_record</span> <span class="o">=</span> <span class="n">real_record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">default_dummy</span><span class="o">=</span><span class="s1">&#39;WTF&#39;</span><span class="p">)</span>
        <span class="n">new_origin</span> <span class="o">=</span> <span class="n">new_origin</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">default_dummy</span><span class="o">=</span><span class="s1">&#39;WTF&#39;</span><span class="p">)</span>
        <span class="n">new_record</span> <span class="o">=</span> <span class="n">new_record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">default_dummy</span><span class="o">=</span><span class="s1">&#39;WTF&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">real_record</span><span class="o">.</span><span class="n">dummy</span><span class="p">,</span> <span class="s1">&#39;WTF&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_origin</span><span class="o">.</span><span class="n">dummy</span><span class="p">,</span> <span class="s1">&#39;WTF&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_record</span><span class="o">.</span><span class="n">dummy</span><span class="p">,</span> <span class="s1">&#39;WTF&#39;</span><span class="p">)</span>

        <span class="c1"># non-computed stored field: origin or default if no origin</span>
        <span class="n">real_record</span> <span class="o">=</span> <span class="n">real_record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">default_color</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">new_origin</span> <span class="o">=</span> <span class="n">new_origin</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">default_color</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">new_record</span> <span class="o">=</span> <span class="n">new_record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">default_color</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">real_record</span><span class="o">.</span><span class="n">color</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_origin</span><span class="o">.</span><span class="n">color</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_record</span><span class="o">.</span><span class="n">color</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span>

        <span class="c1"># computed non-stored field: always computed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">real_record</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;Foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_origin</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;Bar&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_record</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;Baz&#39;</span><span class="p">)</span>

        <span class="c1"># computed stored field: origin or computed if no origin</span>
        <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.recursive&#39;</span><span class="p">]</span>
        <span class="n">real_record</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">})</span>
        <span class="n">new_origin</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Bar&#39;</span><span class="p">},</span> <span class="n">origin</span><span class="o">=</span><span class="n">real_record</span><span class="p">)</span>
        <span class="n">new_record</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Baz&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">real_record</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;Foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_origin</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;Bar&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_record</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;Baz&#39;</span><span class="p">)</span>

        <span class="c1"># computed stored field with recomputation: always computed</span>
        <span class="n">real_record</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Fool&#39;</span>
        <span class="n">new_origin</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Barr&#39;</span>
        <span class="n">new_record</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Bazz&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">real_record</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;Fool&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_origin</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;Barr&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_record</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="s1">&#39;Bazz&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_40_new_defaults">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_40_new_defaults">[docs]</a>
    <span class="k">def</span> <span class="nf">test_40_new_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Test new records with defaults. &quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span>
        <span class="n">discussion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.discussion_0&#39;</span><span class="p">)</span>

        <span class="c1"># create a new message; fields have their default value if not given</span>
        <span class="n">new_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="s2">&quot;XXX&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_msg</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_msg</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="s2">&quot;XXX&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_msg</span><span class="o">.</span><span class="n">author</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>

        <span class="c1"># assign some fields; should have no side effect</span>
        <span class="n">new_msg</span><span class="o">.</span><span class="n">discussion</span> <span class="o">=</span> <span class="n">discussion</span>
        <span class="n">new_msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;YYY&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_msg</span><span class="o">.</span><span class="n">discussion</span><span class="p">,</span> <span class="n">discussion</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_msg</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="s2">&quot;YYY&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">new_msg</span><span class="p">,</span> <span class="n">discussion</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span>

        <span class="c1"># check computed values of fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_msg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">] </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">discussion</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_msg</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># extra tests for x2many fields with default</span>
        <span class="n">cat1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;Cat1&quot;</span><span class="p">})</span>
        <span class="n">cat2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;Cat2&quot;</span><span class="p">})</span>
        <span class="n">discussion</span> <span class="o">=</span> <span class="n">discussion</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">default_categories</span><span class="o">=</span><span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">cat1</span><span class="o">.</span><span class="n">id</span><span class="p">)])</span>
        <span class="c1"># no value gives the default value</span>
        <span class="n">new_disc</span> <span class="o">=</span> <span class="n">discussion</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_disc</span><span class="o">.</span><span class="n">categories</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="n">cat1</span><span class="p">)</span>
        <span class="c1"># value overrides default value</span>
        <span class="n">new_disc</span> <span class="o">=</span> <span class="n">discussion</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="s1">&#39;categories&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">cat2</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_disc</span><span class="o">.</span><span class="n">categories</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="n">cat2</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_40_new_fields">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_40_new_fields">[docs]</a>
    <span class="k">def</span> <span class="nf">test_40_new_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Test new records with relational fields. &quot;&quot;&quot;</span>
        <span class="c1"># create a new discussion with all kinds of relational fields</span>
        <span class="n">msg0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="s2">&quot;XXX&quot;</span><span class="p">})</span>
        <span class="n">msg1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="s2">&quot;WWW&quot;</span><span class="p">})</span>
        <span class="n">cat0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;AAA&#39;</span><span class="p">})</span>
        <span class="n">cat1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;DDD&#39;</span><span class="p">})</span>
        <span class="n">new_disc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.discussion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;Stuff&quot;</span><span class="p">,</span>
            <span class="s1">&#39;moderator&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span>
            <span class="s1">&#39;messages&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">msg0</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                <span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">msg1</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">Command</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">msg1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="s2">&quot;YYY&quot;</span><span class="p">}),</span>
                <span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="s2">&quot;ZZZ&quot;</span><span class="p">})</span>
            <span class="p">],</span>
            <span class="s1">&#39;categories&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">cat0</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                <span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">cat1</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">Command</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cat1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;BBB&quot;</span><span class="p">}),</span>
                <span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;CCC&quot;</span><span class="p">})</span>
            <span class="p">],</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_disc</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># many2one field values are actual records</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_disc</span><span class="o">.</span><span class="n">moderator</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>

        <span class="c1"># x2many fields values are new records</span>
        <span class="n">new_msg0</span><span class="p">,</span> <span class="n">new_msg1</span><span class="p">,</span> <span class="n">new_msg2</span> <span class="o">=</span> <span class="n">new_disc</span><span class="o">.</span><span class="n">messages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_msg0</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_msg1</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_msg2</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="n">new_cat0</span><span class="p">,</span> <span class="n">new_cat1</span><span class="p">,</span> <span class="n">new_cat2</span> <span class="o">=</span> <span class="n">new_disc</span><span class="o">.</span><span class="n">categories</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_cat0</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_cat1</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_cat2</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c1"># the x2many has its inverse field set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_msg0</span><span class="o">.</span><span class="n">discussion</span><span class="p">,</span> <span class="n">new_disc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_msg1</span><span class="o">.</span><span class="n">discussion</span><span class="p">,</span> <span class="n">new_disc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_msg2</span><span class="o">.</span><span class="n">discussion</span><span class="p">,</span> <span class="n">new_disc</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">msg0</span><span class="o">.</span><span class="n">discussion</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">msg1</span><span class="o">.</span><span class="n">discussion</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_cat0</span><span class="o">.</span><span class="n">discussions</span><span class="p">,</span> <span class="n">new_disc</span><span class="p">)</span>    <span class="c1"># add other discussions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_cat1</span><span class="o">.</span><span class="n">discussions</span><span class="p">,</span> <span class="n">new_disc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_cat2</span><span class="o">.</span><span class="n">discussions</span><span class="p">,</span> <span class="n">new_disc</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">new_disc</span><span class="p">,</span> <span class="n">cat0</span><span class="o">.</span><span class="n">discussions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">new_disc</span><span class="p">,</span> <span class="n">cat1</span><span class="o">.</span><span class="n">discussions</span><span class="p">)</span>

        <span class="c1"># new lines are connected to their origin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_msg0</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="n">msg0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_msg1</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="n">msg1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_msg2</span><span class="o">.</span><span class="n">_origin</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_cat0</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="n">cat0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_cat1</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="n">cat1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_cat2</span><span class="o">.</span><span class="n">_origin</span><span class="p">)</span>

        <span class="c1"># the field values are either specific, or the same as the origin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_msg0</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="s2">&quot;XXX&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_msg1</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="s2">&quot;YYY&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_msg2</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="s2">&quot;ZZZ&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg0</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="s2">&quot;XXX&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg1</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="s2">&quot;WWW&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_cat0</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;AAA&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_cat1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;BBB&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_cat2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;CCC&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cat0</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;AAA&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cat1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;DDD&quot;</span><span class="p">)</span>

        <span class="c1"># special case for many2one fields that define _inherits</span>
        <span class="n">new_email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.emailmessage&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="s2">&quot;XXX&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_email</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">new_email</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_email</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_email</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="s2">&quot;XXX&quot;</span><span class="p">)</span>

        <span class="n">new_email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.emailmessage&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">msg0</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_email</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_email</span><span class="o">.</span><span class="n">_origin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_email</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_email</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="n">msg0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_email</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="s2">&quot;XXX&quot;</span><span class="p">)</span>

        <span class="c1"># check that this does not generate an infinite recursion</span>
        <span class="n">new_disc</span><span class="o">.</span><span class="n">_convert_to_write</span><span class="p">(</span><span class="n">new_disc</span><span class="o">.</span><span class="n">_cache</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_40_new_convert_to_write">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_40_new_convert_to_write">[docs]</a>
    <span class="k">def</span> <span class="nf">test_40_new_convert_to_write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new_disc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.discussion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;Stuff&quot;</span><span class="p">,</span>
            <span class="s1">&#39;moderator&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span>
            <span class="s1">&#39;participants&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">ids</span><span class="p">)],</span>
        <span class="p">})</span>
        <span class="c1"># Put the user groups in the cache of the new record</span>
        <span class="n">new_disc</span><span class="o">.</span><span class="n">participants</span><span class="o">.</span><span class="n">groups_id</span>

        <span class="c1"># Check that the groups in the cache are not returned by convert_to_write</span>
        <span class="c1"># because no real change happened, the values are identical except that</span>
        <span class="c1"># self.env.user.groups_id._ids = (Id1, Id2, ...) whereas</span>
        <span class="c1"># new_disc.participants.groups_id._ids = (NewId(origin=Id1), NewId(origin=Id2), ...)</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">new_disc</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;participants&quot;</span><span class="p">)</span>
        <span class="c1"># make sure that there is no inverse field for discussions on res_users,</span>
        <span class="c1"># as the test depends on it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_disc</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">field_inverses</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
        <span class="n">convert</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_write</span><span class="p">(</span><span class="n">new_disc</span><span class="p">[</span><span class="s2">&quot;participants&quot;</span><span class="p">],</span> <span class="n">new_disc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">convert</span><span class="p">,</span> <span class="p">[(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span></div>


<div class="viewcode-block" id="TestFields.test_40_new_inherited_fields">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_40_new_inherited_fields">[docs]</a>
    <span class="k">def</span> <span class="nf">test_40_new_inherited_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Test the behavior of new records with inherited fields. &quot;&quot;&quot;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.emailmessage&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="s1">&#39;XXX&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="s1">&#39;XXX&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="s1">&#39;XXX&#39;</span><span class="p">)</span>

        <span class="n">email</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s1">&#39;YYY&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="s1">&#39;YYY&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="s1">&#39;YYY&#39;</span><span class="p">)</span>

        <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s1">&#39;ZZZ&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="s1">&#39;ZZZ&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="s1">&#39;ZZZ&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_40_new_ref_origin">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_40_new_ref_origin">[docs]</a>
    <span class="k">def</span> <span class="nf">test_40_new_ref_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Test the behavior of new records with ref/origin. &quot;&quot;&quot;</span>
        <span class="n">Discussion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.discussion&#39;</span><span class="p">]</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">Discussion</span><span class="o">.</span><span class="n">new</span>

        <span class="c1"># new records with identical/different refs</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">new</span><span class="p">()</span> <span class="o">+</span> <span class="n">new</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">new</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">new</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="n">x</span> <span class="o">==</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">],</span> <span class="p">[</span>
            <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">])</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">_origin</span><span class="p">)</span>

        <span class="c1"># new records with identical/different origins</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">Discussion</span><span class="o">.</span><span class="n">create</span><span class="p">([{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;A&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;B&quot;</span><span class="p">}])</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">new</span><span class="p">()</span> <span class="o">+</span> <span class="n">new</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">new</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">new</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="n">x</span> <span class="o">==</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">],</span> <span class="p">[</span>
            <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_origin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">xs</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">xs</span><span class="o">.</span><span class="n">_origin</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>

        <span class="c1"># new records with refs and origins</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>

        <span class="c1"># new discussion based on existing discussion</span>
        <span class="n">disc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.discussion_0&#39;</span><span class="p">)</span>
        <span class="n">new_disc</span> <span class="o">=</span> <span class="n">disc</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">disc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_disc</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_disc</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="n">disc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_disc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">disc</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># many2one field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_disc</span><span class="o">.</span><span class="n">moderator</span><span class="p">,</span> <span class="n">disc</span><span class="o">.</span><span class="n">moderator</span><span class="p">)</span>
        <span class="c1"># one2many field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">new_disc</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">new_disc</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span> <span class="n">disc</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_disc</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="n">disc</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span>
        <span class="c1"># many2many field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">new_disc</span><span class="o">.</span><span class="n">participants</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">new_disc</span><span class="o">.</span><span class="n">participants</span><span class="p">,</span> <span class="n">disc</span><span class="o">.</span><span class="n">participants</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_disc</span><span class="o">.</span><span class="n">participants</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="n">disc</span><span class="o">.</span><span class="n">participants</span><span class="p">)</span>

        <span class="c1"># provide many2one field as a dict of values; the value is a new record</span>
        <span class="c1"># with the given &#39;id&#39; as origin (if given, of course)</span>
        <span class="n">new_msg</span> <span class="o">=</span> <span class="n">disc</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>
            <span class="s1">&#39;discussion&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">disc</span><span class="o">.</span><span class="n">name</span><span class="p">},</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">new_msg</span><span class="o">.</span><span class="n">discussion</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_msg</span><span class="o">.</span><span class="n">discussion</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_msg</span><span class="o">.</span><span class="n">discussion</span><span class="o">.</span><span class="n">_origin</span><span class="p">)</span>

        <span class="n">new_msg</span> <span class="o">=</span> <span class="n">disc</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>
            <span class="s1">&#39;discussion&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">disc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">disc</span><span class="o">.</span><span class="n">id</span><span class="p">},</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">new_msg</span><span class="o">.</span><span class="n">discussion</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_msg</span><span class="o">.</span><span class="n">discussion</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_msg</span><span class="o">.</span><span class="n">discussion</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="n">disc</span><span class="p">)</span>

        <span class="c1"># check convert_to_write</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi.tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">})</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;lines&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tag</span><span class="o">.</span><span class="n">ids</span><span class="p">)]})],</span>
        <span class="p">})</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">rec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">_convert_to_write</span><span class="p">(</span><span class="n">new</span><span class="o">.</span><span class="n">_cache</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s1">&#39;lines&#39;</span><span class="p">],</span> <span class="p">[(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span></div>


<div class="viewcode-block" id="TestFields.test_41_new_compute">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_41_new_compute">[docs]</a>
    <span class="k">def</span> <span class="nf">test_41_new_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Check recomputation of fields on new records. &quot;&quot;&quot;</span>
        <span class="n">move</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.move&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;line_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}),</span> <span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})],</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">move</span><span class="o">.</span><span class="n">line_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">new_move</span> <span class="o">=</span> <span class="n">move</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">move</span><span class="p">)</span>
        <span class="n">new_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># move_id is fetched from origin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_line</span><span class="o">.</span><span class="n">move_id</span><span class="p">,</span> <span class="n">move</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_move</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">move</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># modifying new_line must trigger recomputation on new_move, even if</span>
        <span class="c1"># new_line.move_id is not new_move!</span>
        <span class="n">new_line</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_line</span><span class="o">.</span><span class="n">move_id</span><span class="p">,</span> <span class="n">move</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_move</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">move</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_41_new_one2many">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_41_new_one2many">[docs]</a>
    <span class="k">def</span> <span class="nf">test_41_new_one2many</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Check command on one2many field on new record. &quot;&quot;&quot;</span>
        <span class="n">move</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.move&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.move_line&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;move_id&#39;</span><span class="p">:</span> <span class="n">move</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>

        <span class="n">new_move</span> <span class="o">=</span> <span class="n">move</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">move</span><span class="p">)</span>
        <span class="n">new_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_move</span><span class="o">.</span><span class="n">line_ids</span><span class="p">,</span> <span class="n">new_line</span><span class="p">)</span>

        <span class="c1"># drop line, and create a new one</span>
        <span class="n">new_move</span><span class="o">.</span><span class="n">line_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">new_line</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_move</span><span class="o">.</span><span class="n">line_ids</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_move</span><span class="o">.</span><span class="n">line_ids</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_move</span><span class="o">.</span><span class="n">line_ids</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># assign line to new move without origin</span>
        <span class="n">new_move</span> <span class="o">=</span> <span class="n">move</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
        <span class="n">new_move</span><span class="o">.</span><span class="n">line_ids</span> <span class="o">=</span> <span class="n">line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">new_move</span><span class="o">.</span><span class="n">line_ids</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_move</span><span class="o">.</span><span class="n">line_ids</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_move</span><span class="o">.</span><span class="n">line_ids</span><span class="o">.</span><span class="n">move_id</span><span class="p">,</span> <span class="n">new_move</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_41_new_many2many">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_41_new_many2many">[docs]</a>
    <span class="k">def</span> <span class="nf">test_41_new_many2many</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">user0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;group_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>
        <span class="n">new_user0</span> <span class="o">=</span> <span class="n">user0</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">user0</span><span class="p">)</span>
        <span class="n">new_group</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>

        <span class="c1"># creating new_user1 shoud not fetch new_group.user_ids, which is the</span>
        <span class="c1"># inverse of field new_user1.group_ids</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">new_user1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="s1">&#39;group_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_user1</span><span class="o">.</span><span class="n">group_ids</span><span class="p">,</span> <span class="n">new_group</span><span class="p">)</span>

        <span class="c1"># accessing new_group.user_ids should fetch group.user_ids and patch</span>
        <span class="c1"># new_group.user_ids</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_group</span><span class="o">.</span><span class="n">user_ids</span><span class="p">,</span> <span class="n">new_user0</span> <span class="o">+</span> <span class="n">new_user1</span><span class="p">)</span>

        <span class="c1"># creating new_user2 should patch new_group.user_ids immediately, since</span>
        <span class="c1"># it is in cache</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">new_user2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="s1">&#39;group_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_user2</span><span class="o">.</span><span class="n">group_ids</span><span class="p">,</span> <span class="n">new_group</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_group</span><span class="o">.</span><span class="n">user_ids</span><span class="p">,</span> <span class="n">new_user0</span> <span class="o">+</span> <span class="n">new_user1</span> <span class="o">+</span> <span class="n">new_user2</span><span class="p">)</span>

        <span class="c1"># the patches on new_group.user_ids should not have changed group.user_ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">user_ids</span><span class="p">,</span> <span class="n">user0</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_41_new_related">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_41_new_related">[docs]</a>
    <span class="nd">@mute_logger</span><span class="p">(</span><span class="s1">&#39;odoo.addons.base.models.ir_model&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_41_new_related</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test the behavior of related fields starting on new records. &quot;&quot;&quot;</span>
        <span class="c1"># make discussions unreadable for demo user</span>
        <span class="n">access</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.access_discussion&#39;</span><span class="p">)</span>
        <span class="n">access</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;perm_read&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>

        <span class="c1"># create an environment for demo user</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_demo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">login</span><span class="p">,</span> <span class="s2">&quot;demo&quot;</span><span class="p">)</span>

        <span class="c1"># create a new message as demo user</span>
        <span class="n">discussion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.discussion_0&#39;</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="s1">&#39;discussion&#39;</span><span class="p">:</span> <span class="n">discussion</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">discussion</span><span class="p">,</span> <span class="n">discussion</span><span class="p">)</span>

        <span class="c1"># read the related field discussion_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">discussion</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">discussion_name</span><span class="p">,</span> <span class="n">discussion</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

        <span class="c1"># DLE P75: message.discussion.name is put in the cache as sudo thanks to the computation of message.discussion_name</span>
        <span class="c1"># As we decided that now if we had the chance to access the value at some point in the code, and that it was stored in the cache</span>
        <span class="c1"># it&#39;s not a big deal to no longer raise the accesserror, as we had the chance to get the value at some point</span>
        <span class="c1"># with self.assertRaises(AccessError):</span>
        <span class="c1">#     message.discussion.name</span>

<div class="viewcode-block" id="TestFields.test_42_new_related">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_42_new_related">[docs]</a>
    <span class="nd">@mute_logger</span><span class="p">(</span><span class="s1">&#39;odoo.addons.base.models.ir_model&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_42_new_related</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test the behavior of related fields traversing new records. &quot;&quot;&quot;</span>
        <span class="c1"># make discussions unreadable for demo user</span>
        <span class="n">access</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.access_discussion&#39;</span><span class="p">)</span>
        <span class="n">access</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;perm_read&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>

        <span class="c1"># create an environment for demo user</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_demo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">login</span><span class="p">,</span> <span class="s2">&quot;demo&quot;</span><span class="p">)</span>

        <span class="c1"># create a new discussion and a new message as demo user</span>
        <span class="n">discussion</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.discussion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Stuff&#39;</span><span class="p">})</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">new</span><span class="p">({</span><span class="s1">&#39;discussion&#39;</span><span class="p">:</span> <span class="n">discussion</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">discussion</span><span class="p">,</span> <span class="n">discussion</span><span class="p">)</span>

        <span class="c1"># read the related field discussion_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">discussion_name</span><span class="p">,</span> <span class="n">discussion</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_43_new_related">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_43_new_related">[docs]</a>
    <span class="k">def</span> <span class="nf">test_43_new_related</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test the behavior of one2many related fields &quot;&quot;&quot;</span>
        <span class="n">partner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.partner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;child_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Bar&#39;</span><span class="p">})],</span>
        <span class="p">})</span>
        <span class="n">multi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
        <span class="n">multi</span><span class="o">.</span><span class="n">partner</span> <span class="o">=</span> <span class="n">partner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">multi</span><span class="o">.</span><span class="n">partners</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;Bar&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="TestFields.test_50_defaults">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_50_defaults">[docs]</a>
    <span class="k">def</span> <span class="nf">test_50_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test default values. &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;discussion&#39;</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">]</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">default_get</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;author&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span><span class="p">})</span>

        <span class="n">defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.mixed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">default_get</span><span class="p">([</span><span class="s1">&#39;number&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="mf">3.14</span><span class="p">})</span></div>


<div class="viewcode-block" id="TestFields.test_50_search_many2one">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_50_search_many2one">[docs]</a>
    <span class="k">def</span> <span class="nf">test_50_search_many2one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test search through a path of computed fields&quot;&quot;&quot;</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
            <span class="p">[(</span><span class="s1">&#39;author_partner.name&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;Marc Demo&#39;</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.message_0_1&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="TestFields.test_51_search_many2one_ordered">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_51_search_many2one_ordered">[docs]</a>
    <span class="k">def</span> <span class="nf">test_51_search_many2one_ordered</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test search on many2one ordered by id &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            SELECT &quot;test_new_api_message&quot;.&quot;id&quot; FROM &quot;test_new_api_message&quot;</span>
<span class="s1">            WHERE (&quot;test_new_api_message&quot;.&quot;active&quot; = </span><span class="si">%s</span><span class="s1">)</span>
<span class="s1">            ORDER BY  &quot;test_new_api_message&quot;.&quot;discussion&quot;</span>
<span class="s1">        &#39;&#39;&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([],</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;discussion&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="TestFields.test_60_one2many_domain">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_60_one2many_domain">[docs]</a>
    <span class="k">def</span> <span class="nf">test_60_one2many_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test the cache consistency of a one2many field with a domain &quot;&quot;&quot;</span>
        <span class="n">discussion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.discussion_0&#39;</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">discussion</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">discussion</span><span class="o">.</span><span class="n">important_messages</span><span class="p">)</span>

        <span class="n">message</span><span class="o">.</span><span class="n">important</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">discussion</span><span class="o">.</span><span class="n">important_messages</span><span class="p">)</span>

        <span class="c1"># writing on very_important_messages should call its domain method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">discussion</span><span class="o">.</span><span class="n">very_important_messages</span><span class="p">)</span>
        <span class="n">discussion</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;very_important_messages&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">clear</span><span class="p">()]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">discussion</span><span class="o">.</span><span class="n">very_important_messages</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span></div>


<div class="viewcode-block" id="TestFields.test_60_many2many_domain">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_60_many2many_domain">[docs]</a>
    <span class="k">def</span> <span class="nf">test_60_many2many_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; test the cache consistency of a many2many field with a domain &quot;&quot;&quot;</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi.tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="n">tag</span><span class="o">.</span><span class="n">ids</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">record</span><span class="p">)</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;ilike&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)])</span>

        <span class="c1"># the tag is in the many2many</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>

        <span class="c1"># modify the tag; it should not longer be in the many2many</span>
        <span class="n">tag</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>

        <span class="c1"># modify again the tag; it should be back in the many2many</span>
        <span class="n">tag</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;baz&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_70_x2many_write">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_70_x2many_write">[docs]</a>
    <span class="k">def</span> <span class="nf">test_70_x2many_write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">discussion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.discussion_0&#39;</span><span class="p">)</span>
        <span class="c1"># See YTI FIXME</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>

        <span class="n">Message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.message&#39;</span><span class="p">]</span>
        <span class="c1"># There must be 3 messages, 0 important</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">discussion</span><span class="o">.</span><span class="n">messages</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">discussion</span><span class="o">.</span><span class="n">important_messages</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">discussion</span><span class="o">.</span><span class="n">very_important_messages</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">discussion</span><span class="o">.</span><span class="n">important_messages</span> <span class="o">=</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="s1">&#39;What is the answer?&#39;</span><span class="p">,</span>
            <span class="s1">&#39;important&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">})]</span>
        <span class="c1"># There must be 4 messages, 1 important</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">discussion</span><span class="o">.</span><span class="n">messages</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">discussion</span><span class="o">.</span><span class="n">important_messages</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">discussion</span><span class="o">.</span><span class="n">very_important_messages</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">discussion</span><span class="o">.</span><span class="n">very_important_messages</span> <span class="o">|=</span> <span class="n">Message</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>
            <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="s1">&#39;42&#39;</span><span class="p">,</span>
            <span class="s1">&#39;important&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="c1"># There must be 5 messages, 2 important</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">discussion</span><span class="o">.</span><span class="n">messages</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">discussion</span><span class="o">.</span><span class="n">important_messages</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">discussion</span><span class="o">.</span><span class="n">very_important_messages</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_70_relational_inverse">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_70_relational_inverse">[docs]</a>
    <span class="k">def</span> <span class="nf">test_70_relational_inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Check the consistency of relational fields with inverse(s). &quot;&quot;&quot;</span>
        <span class="n">discussion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.discussion_0&#39;</span><span class="p">)</span>
        <span class="n">demo_discussion</span> <span class="o">=</span> <span class="n">discussion</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_demo</span><span class="p">)</span>

        <span class="c1"># check that the demo user sees the same messages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">demo_discussion</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span> <span class="n">discussion</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span>

        <span class="c1"># See YTI FIXME</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>

        <span class="c1"># add a message as user demo</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="n">demo_discussion</span><span class="o">.</span><span class="n">messages</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">messages</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;discussion&#39;</span><span class="p">:</span> <span class="n">discussion</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">demo_discussion</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span> <span class="n">messages</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">demo_discussion</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span> <span class="n">discussion</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span>

        <span class="c1"># add a message as superuser</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="n">discussion</span><span class="o">.</span><span class="n">messages</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">messages</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;discussion&#39;</span><span class="p">:</span> <span class="n">discussion</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">discussion</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span> <span class="n">messages</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">demo_discussion</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span> <span class="n">discussion</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_71_relational_inverse">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_71_relational_inverse">[docs]</a>
    <span class="k">def</span> <span class="nf">test_71_relational_inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Check the consistency of relational fields with inverse(s). &quot;&quot;&quot;</span>
        <span class="n">move1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.move&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">move2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.move&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.move_line&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;move_id&#39;</span><span class="p">:</span> <span class="n">move1</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>

        <span class="n">line</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">prefetch_fields</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">move_id</span>

        <span class="c1"># Setting &#39;move_id&#39; updates the one2many field that is based on it,</span>
        <span class="c1"># which has a domain.  Here we check that evaluating the domain does not</span>
        <span class="c1"># accidentally override &#39;move_id&#39; (by prefetch).</span>
        <span class="n">line</span><span class="o">.</span><span class="n">move_id</span> <span class="o">=</span> <span class="n">move2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">move_id</span><span class="p">,</span> <span class="n">move2</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_72_relational_inverse">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_72_relational_inverse">[docs]</a>
    <span class="k">def</span> <span class="nf">test_72_relational_inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Check the consistency of relational fields with inverse(s). &quot;&quot;&quot;</span>
        <span class="n">move1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.move&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">move2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.move&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>

        <span class="c1"># makes sure that line.move_id is flushed before search</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.move_line&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;move_id&#39;</span><span class="p">:</span> <span class="n">move1</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="n">moves</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.move&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;line_ids&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">id</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">moves</span><span class="p">,</span> <span class="n">move1</span><span class="p">)</span>

        <span class="c1"># makes sure that line.move_id is flushed before search</span>
        <span class="n">line</span><span class="o">.</span><span class="n">move_id</span> <span class="o">=</span> <span class="n">move2</span>
        <span class="n">moves</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.move&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;line_ids&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">id</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">moves</span><span class="p">,</span> <span class="n">move2</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_73_relational_inverse">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_73_relational_inverse">[docs]</a>
    <span class="k">def</span> <span class="nf">test_73_relational_inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Check the consistency of relational fields with inverse(s). &quot;&quot;&quot;</span>
        <span class="n">discussion1</span><span class="p">,</span> <span class="n">discussion2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.discussion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">([</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;discussion1&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;discussion2&quot;</span><span class="p">},</span>
        <span class="p">])</span>
        <span class="n">category1</span><span class="p">,</span> <span class="n">category2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">([</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;category1&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;category2&quot;</span><span class="p">},</span>
        <span class="p">])</span>

        <span class="c1"># assumption: category12 and category21 are in different order, but are</span>
        <span class="c1"># in the same order when put in a set()</span>
        <span class="n">category12</span> <span class="o">=</span> <span class="n">category1</span> <span class="o">+</span> <span class="n">category2</span>
        <span class="n">category21</span> <span class="o">=</span> <span class="n">category2</span> <span class="o">+</span> <span class="n">category1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">category12</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">category21</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">category12</span><span class="o">.</span><span class="n">ids</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">category21</span><span class="o">.</span><span class="n">ids</span><span class="p">)))</span>

        <span class="c1"># make sure discussion1.categories is in cache; the write() below should</span>
        <span class="c1"># update the cache of discussion1.categories by appending category12.ids</span>
        <span class="n">discussion1</span><span class="o">.</span><span class="n">categories</span>
        <span class="n">category12</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;discussions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">discussion1</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">discussion1</span><span class="o">.</span><span class="n">categories</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">category12</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>

        <span class="c1"># make sure discussion2.categories is in cache; the write() below should</span>
        <span class="c1"># update the cache of discussion2.categories by appending category21.ids</span>
        <span class="n">discussion2</span><span class="o">.</span><span class="n">categories</span>
        <span class="n">category21</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;discussions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">discussion2</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">discussion2</span><span class="o">.</span><span class="n">categories</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">category21</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_80_copy">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_80_copy">[docs]</a>
    <span class="k">def</span> <span class="nf">test_80_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">discussion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.discussion_0&#39;</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.message_0_0&#39;</span><span class="p">)</span>
        <span class="n">message1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.message_0_1&#39;</span><span class="p">)</span>

        <span class="n">email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;test_new_api.emailmessage_0_0&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.lang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_activate_lang</span><span class="p">(</span><span class="s1">&#39;fr_FR&#39;</span><span class="p">)</span>

        <span class="c1"># set a translation for message.label</span>
        <span class="n">email</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="s1">&#39;fr_FR&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;bonjour&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="s1">&#39;fr_FR&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;bonjour&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">message1</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>

        <span class="c1"># setting the parent record should not copy its translations</span>
        <span class="n">email</span><span class="o">.</span><span class="n">copy</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message1</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="s1">&#39;fr_FR&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;bonjour&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">message1</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>

        <span class="c1"># setting a one2many should not copy translations on the lines</span>
        <span class="n">discussion</span><span class="o">.</span><span class="n">copy</span><span class="p">({</span><span class="s1">&#39;messages&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">message1</span><span class="o">.</span><span class="n">ids</span><span class="p">)]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="s1">&#39;fr_FR&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="s1">&#39;bonjour&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">message1</span><span class="o">.</span><span class="n">label</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_85_binary_guess_zip">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_85_binary_guess_zip">[docs]</a>
    <span class="k">def</span> <span class="nf">test_85_binary_guess_zip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">odoo.addons.base.tests.test_mimetypes</span> <span class="kn">import</span> <span class="n">ZIP</span>
        <span class="c1"># Regular ZIP files can be uploaded by non-admin users</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.binary_svg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_demo</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Test without attachment&#39;</span><span class="p">,</span>
            <span class="s1">&#39;image_wo_attachment&#39;</span><span class="p">:</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">ZIP</span><span class="p">),</span>
        <span class="p">})</span></div>


<div class="viewcode-block" id="TestFields.test_86_text_base64_guess_svg">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_86_text_base64_guess_svg">[docs]</a>
    <span class="k">def</span> <span class="nf">test_86_text_base64_guess_svg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">odoo.addons.base.tests.test_mimetypes</span> <span class="kn">import</span> <span class="n">SVG</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">UserError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.binary_svg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_demo</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Test without attachment&#39;</span><span class="p">,</span>
                <span class="s1">&#39;image_wo_attachment&#39;</span><span class="p">:</span> <span class="n">SVG</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span>
            <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Only admins can upload SVG files.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_90_binary_svg">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_90_binary_svg">[docs]</a>
    <span class="k">def</span> <span class="nf">test_90_binary_svg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">odoo.addons.base.tests.test_mimetypes</span> <span class="kn">import</span> <span class="n">SVG</span>
        <span class="c1"># This should work without problems</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.binary_svg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Test without attachment&#39;</span><span class="p">,</span>
            <span class="s1">&#39;image_wo_attachment&#39;</span><span class="p">:</span> <span class="n">SVG</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="c1"># And this gives error</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">UserError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.binary_svg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_demo</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Test without attachment&#39;</span><span class="p">,</span>
                <span class="s1">&#39;image_wo_attachment&#39;</span><span class="p">:</span> <span class="n">SVG</span><span class="p">,</span>
            <span class="p">})</span></div>


<div class="viewcode-block" id="TestFields.test_91_binary_svg_attachment">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_91_binary_svg_attachment">[docs]</a>
    <span class="k">def</span> <span class="nf">test_91_binary_svg_attachment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">odoo.addons.base.tests.test_mimetypes</span> <span class="kn">import</span> <span class="n">SVG</span>
        <span class="c1"># This doesn&#39;t neuter SVG with admin</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.binary_svg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Test without attachment&#39;</span><span class="p">,</span>
            <span class="s1">&#39;image_attachment&#39;</span><span class="p">:</span> <span class="n">SVG</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">attachment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.attachment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;res_model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">_name</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;res_field&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;image_attachment&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
        <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">attachment</span><span class="o">.</span><span class="n">mimetype</span><span class="p">,</span> <span class="s1">&#39;image/svg+xml&#39;</span><span class="p">)</span>
        <span class="c1"># ...but this should be neutered with demo user</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.binary_svg&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_demo</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Test without attachment&#39;</span><span class="p">,</span>
            <span class="s1">&#39;image_attachment&#39;</span><span class="p">:</span> <span class="n">SVG</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">attachment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.attachment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;res_model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">_name</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;res_field&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;image_attachment&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
        <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">attachment</span><span class="o">.</span><span class="n">mimetype</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_92_binary_self_avatar_svg">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_92_binary_self_avatar_svg">[docs]</a>
    <span class="k">def</span> <span class="nf">test_92_binary_self_avatar_svg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">odoo.addons.base.tests.test_mimetypes</span> <span class="kn">import</span> <span class="n">SVG</span>
        <span class="n">demo_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_demo</span>
        <span class="c1"># User demo changes his own avatar</span>
        <span class="n">demo_user</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">demo_user</span><span class="p">)</span><span class="o">.</span><span class="n">image_1920</span> <span class="o">=</span> <span class="n">SVG</span>
        <span class="c1"># The SVG file should have been neutered</span>
        <span class="n">attachment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.attachment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;res_model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">demo_user</span><span class="o">.</span><span class="n">partner_id</span><span class="o">.</span><span class="n">_name</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;res_field&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;image_1920&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">demo_user</span><span class="o">.</span><span class="n">partner_id</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
        <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">attachment</span><span class="o">.</span><span class="n">mimetype</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_93_monetary_related">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_93_monetary_related">[docs]</a>
    <span class="k">def</span> <span class="nf">test_93_monetary_related</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Check the currency field on related monetary fields. &quot;&quot;&quot;</span>
        <span class="c1"># check base field</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.monetary_base&#39;</span><span class="p">]</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">get_currency_field</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="s1">&#39;base_currency_id&#39;</span><span class="p">)</span>

        <span class="c1"># related fields must use the field &#39;currency_id&#39; or &#39;x_currency_id&#39;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.monetary_related&#39;</span><span class="p">]</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">related</span><span class="p">,</span> <span class="s1">&#39;monetary_id.amount&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">get_currency_field</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="s1">&#39;currency_id&#39;</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.monetary_custom&#39;</span><span class="p">]</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;x_amount&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">related</span><span class="p">,</span> <span class="s1">&#39;monetary_id.amount&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">get_currency_field</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="s1">&#39;x_currency_id&#39;</span><span class="p">)</span>

        <span class="c1"># inherited field must use the same field as its parent field</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.monetary_inherits&#39;</span><span class="p">]</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">related</span><span class="p">,</span> <span class="s1">&#39;monetary_id.amount&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">get_currency_field</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="s1">&#39;base_currency_id&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_94_image">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_94_image">[docs]</a>
    <span class="k">def</span> <span class="nf">test_94_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">4000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">),</span> <span class="s1">&#39;#4169E1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;PNG&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">image_w</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">),</span> <span class="s1">&#39;#4169E1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;PNG&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">image_h</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;image&#39;</span><span class="p">,</span>
            <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">image_w</span><span class="p">,</span>
            <span class="s1">&#39;image_128&#39;</span><span class="p">:</span> <span class="n">image_w</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="c1"># test create (no resize)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">image_w</span><span class="p">)</span>
        <span class="c1"># test create (resize, width limited)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_128</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">))</span>
        <span class="c1"># test create related store (resize, width limited)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_512</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
        <span class="c1"># test create related no store (resize, width limited)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_256</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span>
        <span class="c1"># test create related store on column (resize, width limited)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_64</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>

        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
            <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">image_h</span><span class="p">,</span>
            <span class="s1">&#39;image_128&#39;</span><span class="p">:</span> <span class="n">image_h</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="c1"># test write (no resize)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">image_h</span><span class="p">)</span>
        <span class="c1"># test write (resize, height limited)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_128</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span>
        <span class="c1"># test write related store (resize, height limited)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_512</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">))</span>
        <span class="c1"># test write related no store (resize, height limited)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_256</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
        <span class="c1"># test write related store on column (resize, width limited)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_64</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">))</span>

        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;image&#39;</span><span class="p">,</span>
            <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">image_h</span><span class="p">,</span>
            <span class="s1">&#39;image_128&#39;</span><span class="p">:</span> <span class="n">image_h</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="c1"># test create (no resize)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">image_h</span><span class="p">)</span>
        <span class="c1"># test create (resize, height limited)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_128</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span>
        <span class="c1"># test create related store (resize, height limited)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_512</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">))</span>
        <span class="c1"># test create related no store (resize, height limited)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_256</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
        <span class="c1"># test create related store on column (resize, width limited)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_64</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">))</span>

        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
            <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">image_w</span><span class="p">,</span>
            <span class="s1">&#39;image_128&#39;</span><span class="p">:</span> <span class="n">image_w</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="c1"># test write (no resize)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">image_w</span><span class="p">)</span>
        <span class="c1"># test write (resize, width limited)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_128</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">))</span>
        <span class="c1"># test write related store (resize, width limited)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_512</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
        <span class="c1"># test write related store (resize, width limited)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_256</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span>
        <span class="c1"># test write related store on column (resize, width limited)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_64</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>

        <span class="c1"># test create inverse store</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;image&#39;</span><span class="p">,</span>
            <span class="s1">&#39;image_512&#39;</span><span class="p">:</span> <span class="n">image_w</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_512</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">4000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_256</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_64</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
        <span class="c1"># test write inverse store</span>
        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
            <span class="s1">&#39;image_512&#39;</span><span class="p">:</span> <span class="n">image_h</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_512</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_256</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_64</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">))</span>

        <span class="c1"># test create inverse no store</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">image_no_postprocess</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;image&#39;</span><span class="p">,</span>
            <span class="s1">&#39;image_256&#39;</span><span class="p">:</span> <span class="n">image_w</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_512</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">4000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_256</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_64</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
        <span class="c1"># test write inverse no store</span>
        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
            <span class="s1">&#39;image_256&#39;</span><span class="p">:</span> <span class="n">image_h</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_512</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_256</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_64</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">))</span>

        <span class="c1"># test create inverse stored column</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">image_no_postprocess</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;image&#39;</span><span class="p">,</span>
            <span class="s1">&#39;image_64&#39;</span><span class="p">:</span> <span class="n">image_w</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_512</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">4000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_256</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_64</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
        <span class="c1"># test write inverse stored column</span>
        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
            <span class="s1">&#39;image_64&#39;</span><span class="p">:</span> <span class="n">image_h</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_512</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_256</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_64</span><span class="p">)))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">))</span>

        <span class="c1"># test bin_size</span>
        <span class="n">record_bin_size</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record_bin_size</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;31.54 Kb&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record_bin_size</span><span class="o">.</span><span class="n">image_512</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1.02 Kb&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record_bin_size</span><span class="o">.</span><span class="n">image_256</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;424.00 bytes&#39;</span><span class="p">)</span>
        <span class="c1"># non-attachment binary fields: value returned as str in a different</span>
        <span class="c1"># form, because coming from PostgreSQL instead of filestore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record_bin_size</span><span class="o">.</span><span class="n">image_64</span><span class="p">,</span> <span class="s1">&#39;148 bytes&#39;</span><span class="p">)</span>

        <span class="c1"># ensure image_data_uri works (value must be bytes and not string)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_256</span><span class="p">[:</span><span class="mi">8</span><span class="p">],</span> <span class="sa">b</span><span class="s1">&#39;iVBORw0K&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">image_data_uri</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image_256</span><span class="p">)[:</span><span class="mi">30</span><span class="p">],</span> <span class="s1">&#39;data:image/png;base64,iVBORw0K&#39;</span><span class="p">)</span>

        <span class="c1"># ensure invalid image raises</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">UserError</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">savepoint</span><span class="p">():</span>
            <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
                <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="s1">&#39;invalid image&#39;</span><span class="p">,</span>
            <span class="p">})</span>

        <span class="c1"># assignment of invalid image on new record does nothing, the value is</span>
        <span class="c1"># taken from origin instead (use-case: onchange)</span>
        <span class="n">new_record</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">record</span><span class="p">)</span>
        <span class="n">new_record</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="s1">&#39;31.54 Kb&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">image_h</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_record</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">image_h</span><span class="p">)</span>

        <span class="c1"># assignment to new record with origin should not do any query</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">new_record</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">image_w</span></div>


<div class="viewcode-block" id="TestFields.test_95_binary_bin_size_create">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_95_binary_bin_size_create">[docs]</a>
    <span class="k">def</span> <span class="nf">test_95_binary_bin_size_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">binary_value</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;content&#39;</span><span class="p">)</span>
        <span class="n">binary_size</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;7.00 bytes&#39;</span>

        <span class="k">def</span> <span class="nf">assertBinaryValue</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span> <span class="s1">&#39;binary_related_store&#39;</span><span class="p">,</span> <span class="s1">&#39;binary_related_no_store&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">value</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Incorrect result for </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># created and first read without context</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_binary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;binary&#39;</span><span class="p">:</span> <span class="n">binary_value</span><span class="p">})</span>
        <span class="n">record_no_bin_size</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">record_bin_size</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">binary_value</span><span class="p">)</span>
        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record_no_bin_size</span><span class="p">,</span> <span class="n">binary_value</span><span class="p">)</span>
        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record_bin_size</span><span class="p">,</span> <span class="n">binary_size</span><span class="p">)</span>

        <span class="c1"># created and first read with bin_size=False</span>
        <span class="n">record_no_bin_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_binary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;binary&#39;</span><span class="p">:</span> <span class="n">binary_value</span><span class="p">})</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_binary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">record_bin_size</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record_no_bin_size</span><span class="p">,</span> <span class="n">binary_value</span><span class="p">)</span>
        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">binary_value</span><span class="p">)</span>
        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record_bin_size</span><span class="p">,</span> <span class="n">binary_size</span><span class="p">)</span>

        <span class="c1"># created and first read with bin_size=True</span>
        <span class="n">record_bin_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_binary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;binary&#39;</span><span class="p">:</span> <span class="n">binary_value</span><span class="p">})</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_binary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">record_no_bin_size</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record_bin_size</span><span class="p">,</span> <span class="n">binary_size</span><span class="p">)</span>
        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record_no_bin_size</span><span class="p">,</span> <span class="n">binary_value</span><span class="p">)</span>
        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">binary_value</span><span class="p">)</span>

        <span class="c1"># created without context and flushed/invalidated with bin_size=True</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_binary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;binary&#39;</span><span class="p">:</span> <span class="n">binary_value</span><span class="p">})</span>
        <span class="n">record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>
        <span class="n">record_no_bin_size</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">record_bin_size</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">binary_value</span><span class="p">)</span>
        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record_no_bin_size</span><span class="p">,</span> <span class="n">binary_value</span><span class="p">)</span>
        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record_bin_size</span><span class="p">,</span> <span class="n">binary_size</span><span class="p">)</span>

        <span class="c1"># check computed binary field with arbitrary Python value</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_binary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">record_no_bin_size</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">record_bin_size</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">expected_value</span> <span class="o">=</span> <span class="p">[(</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">binary_computed</span><span class="p">,</span> <span class="n">expected_value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record_no_bin_size</span><span class="o">.</span><span class="n">binary_computed</span><span class="p">,</span> <span class="n">expected_value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record_bin_size</span><span class="o">.</span><span class="n">binary_computed</span><span class="p">,</span> <span class="n">expected_value</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_95_binary_bin_size_write">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_95_binary_bin_size_write">[docs]</a>
    <span class="k">def</span> <span class="nf">test_95_binary_bin_size_write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">binary_value</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;content&#39;</span><span class="p">)</span>
        <span class="n">binary_size</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;7.00 bytes&#39;</span>

        <span class="k">def</span> <span class="nf">assertBinaryValue</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span> <span class="s1">&#39;binary_related_store&#39;</span><span class="p">,</span> <span class="s1">&#39;binary_related_no_store&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">value</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Incorrect result for </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># created and written without context</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_binary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;binary&#39;</span><span class="p">:</span> <span class="n">binary_value</span><span class="p">})</span>
        <span class="n">record_no_bin_size</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">record_bin_size</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">binary_value</span><span class="p">)</span>
        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record_no_bin_size</span><span class="p">,</span> <span class="n">binary_value</span><span class="p">)</span>
        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record_bin_size</span><span class="p">,</span> <span class="n">binary_size</span><span class="p">)</span>

        <span class="c1"># created without context, written with bin_size=False</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_binary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;binary&#39;</span><span class="p">:</span> <span class="n">binary_value</span><span class="p">})</span>
        <span class="n">record_bin_size</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record_no_bin_size</span><span class="p">,</span> <span class="n">binary_value</span><span class="p">)</span>
        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">binary_value</span><span class="p">)</span>
        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record_bin_size</span><span class="p">,</span> <span class="n">binary_size</span><span class="p">)</span>

        <span class="c1"># created without context, written with bin_size=True</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_binary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;binary&#39;</span><span class="p">:</span> <span class="n">binary_value</span><span class="p">})</span>
        <span class="n">record_no_bin_size</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record_bin_size</span><span class="p">,</span> <span class="n">binary_size</span><span class="p">)</span>
        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record_no_bin_size</span><span class="p">,</span> <span class="n">binary_value</span><span class="p">)</span>
        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">binary_value</span><span class="p">)</span>

        <span class="c1"># created without context and flushed with bin_size=True</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_binary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;binary&#39;</span><span class="p">:</span> <span class="n">binary_value</span><span class="p">})</span>
        <span class="n">record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>
        <span class="n">record_no_bin_size</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">record_bin_size</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">binary_value</span><span class="p">)</span>
        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record_no_bin_size</span><span class="p">,</span> <span class="n">binary_value</span><span class="p">)</span>
        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record_bin_size</span><span class="p">,</span> <span class="n">binary_size</span><span class="p">)</span>

        <span class="c1"># created and written without context, flushed without bin_size</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_binary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">record</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;binary&#39;</span><span class="p">:</span> <span class="n">binary_value</span><span class="p">})</span>
        <span class="n">record</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>
        <span class="n">record_no_bin_size</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">record_bin_size</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">bin_size</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">binary_value</span><span class="p">)</span>
        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record_no_bin_size</span><span class="p">,</span> <span class="n">binary_value</span><span class="p">)</span>
        <span class="n">assertBinaryValue</span><span class="p">(</span><span class="n">record_bin_size</span><span class="p">,</span> <span class="n">binary_size</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_96_order_m2o">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_96_order_m2o">[docs]</a>
    <span class="k">def</span> <span class="nf">test_96_order_m2o</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">belgium</span><span class="p">,</span> <span class="n">congo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.country&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">([</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;Duchy of Brabant&quot;</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;Congo&quot;</span><span class="p">},</span>
        <span class="p">])</span>
        <span class="n">cities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.city&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">([</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;Brussels&quot;</span><span class="p">,</span> <span class="s1">&#39;country_id&#39;</span><span class="p">:</span> <span class="n">belgium</span><span class="o">.</span><span class="n">id</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;Kinshasa&quot;</span><span class="p">,</span> <span class="s1">&#39;country_id&#39;</span><span class="p">:</span> <span class="n">congo</span><span class="o">.</span><span class="n">id</span><span class="p">},</span>
        <span class="p">])</span>
        <span class="c1"># cities are sorted by country_id, name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cities</span><span class="o">.</span><span class="n">sorted</span><span class="p">()</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;Kinshasa&quot;</span><span class="p">,</span> <span class="s2">&quot;Brussels&quot;</span><span class="p">])</span>

        <span class="c1"># change order of countries, and check sorted()</span>
        <span class="n">belgium</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Belgium&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cities</span><span class="o">.</span><span class="n">sorted</span><span class="p">()</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;Brussels&quot;</span><span class="p">,</span> <span class="s2">&quot;Kinshasa&quot;</span><span class="p">])</span></div>


<div class="viewcode-block" id="TestFields.test_97_ir_rule_m2m_field">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_97_ir_rule_m2m_field">[docs]</a>
    <span class="k">def</span> <span class="nf">test_97_ir_rule_m2m_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensures m2m fields can&#39;t be read if the left records can&#39;t be read.</span>
<span class="sd">        Also makes sure reading m2m doesn&#39;t take more queries than necessary.&quot;&quot;&quot;</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi.tag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi.line&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;image&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">id</span><span class="p">)],</span>
        <span class="p">})</span>

        <span class="c1"># only one query as admin: reading pivot table</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># trick: if value is in cache, read() does not make any query</span>
            <span class="n">record</span><span class="o">.</span><span class="n">invalidate_recordset</span><span class="p">([</span><span class="s1">&#39;tags&#39;</span><span class="p">])</span>
            <span class="n">record</span><span class="o">.</span><span class="n">read</span><span class="p">([</span><span class="s1">&#39;tags&#39;</span><span class="p">])</span>

        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">})</span>
        <span class="n">record_user</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="c1"># prep the following query count by caching access check related data</span>
        <span class="n">record_user</span><span class="o">.</span><span class="n">invalidate_recordset</span><span class="p">([</span><span class="s1">&#39;tags&#39;</span><span class="p">])</span>
        <span class="n">record_user</span><span class="o">.</span><span class="n">read</span><span class="p">([</span><span class="s1">&#39;tags&#39;</span><span class="p">])</span>

        <span class="c1"># only one query as user: reading pivot table</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># trick: if value is in cache, read() does not make any query</span>
            <span class="n">record_user</span><span class="o">.</span><span class="n">invalidate_recordset</span><span class="p">([</span><span class="s1">&#39;tags&#39;</span><span class="p">])</span>
            <span class="n">record_user</span><span class="o">.</span><span class="n">read</span><span class="p">([</span><span class="s1">&#39;tags&#39;</span><span class="p">])</span>

        <span class="c1"># create a passing ir.rule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.rule&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;model_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;domain_force&#39;</span><span class="p">:</span> <span class="s2">&quot;[(&#39;id&#39;, &#39;=&#39;, </span><span class="si">%d</span><span class="s2">)]&quot;</span> <span class="o">%</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="c1"># prep the following query count by caching access check related data</span>
        <span class="n">record_user</span><span class="o">.</span><span class="n">invalidate_recordset</span><span class="p">([</span><span class="s1">&#39;tags&#39;</span><span class="p">])</span>
        <span class="n">record_user</span><span class="o">.</span><span class="n">read</span><span class="p">([</span><span class="s1">&#39;tags&#39;</span><span class="p">])</span>

        <span class="c1"># still only 1 query: reading pivot table</span>
        <span class="c1"># access rules are checked in python in this case</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># trick: if value is in cache, read() does not make any query</span>
            <span class="n">record_user</span><span class="o">.</span><span class="n">invalidate_recordset</span><span class="p">([</span><span class="s1">&#39;tags&#39;</span><span class="p">])</span>
            <span class="n">record_user</span><span class="o">.</span><span class="n">read</span><span class="p">([</span><span class="s1">&#39;tags&#39;</span><span class="p">])</span>

        <span class="c1"># create a blocking ir.rule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.rule&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;model_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;domain_force&#39;</span><span class="p">:</span> <span class="s2">&quot;[(&#39;id&#39;, &#39;!=&#39;, </span><span class="si">%d</span><span class="s2">)]&quot;</span> <span class="o">%</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="c1"># ensure ir.rule is applied even when reading m2m</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">AccessError</span><span class="p">):</span>
            <span class="n">record_user</span><span class="o">.</span><span class="n">read</span><span class="p">([</span><span class="s1">&#39;tags&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="TestFields.test_98_prefetch_translate">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_98_prefetch_translate">[docs]</a>
    <span class="k">def</span> <span class="nf">test_98_prefetch_translate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;test_new_api.prefetch&#39;</span><span class="p">]</span>

        <span class="c1"># translated &#39;_rec_name&#39; field should be prefetched</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">prefetch</span><span class="p">)</span>

        <span class="c1"># translated fields should be prefetch=True by default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">prefetch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">html_description</span><span class="o">.</span><span class="n">prefetch</span><span class="p">)</span>

        <span class="c1"># parameter &#39;prefetch&#39; can be always overridden</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">rare_description</span><span class="o">.</span><span class="n">prefetch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">rare_html_description</span><span class="o">.</span><span class="n">prefetch</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_98_unlink_recompute">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_98_unlink_recompute">[docs]</a>
    <span class="k">def</span> <span class="nf">test_98_unlink_recompute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">move</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.move&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;line_ids&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">})],</span>
        <span class="p">})</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">move</span><span class="o">.</span><span class="n">line_ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">move</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span>

        <span class="c1"># create an ir.rule for lines that uses move.quantity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.rule&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;model_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;domain_force&#39;</span><span class="p">:</span> <span class="s2">&quot;[(&#39;move_id.quantity&#39;, &#39;&gt;=&#39;, 0)]&quot;</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="c1"># unlink the line, and check the recomputation of move.quantity</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_demo</span>
        <span class="n">line</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">move</span><span class="o">.</span><span class="n">quantity</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestFields.test_99_prefetch_group">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_99_prefetch_group">[docs]</a>
    <span class="k">def</span> <span class="nf">test_99_prefetch_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.prefetch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">([{}</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT &quot;test_new_api_prefetch&quot;.&quot;id&quot;,</span>
<span class="s2">                   &quot;test_new_api_prefetch&quot;.&quot;name&quot;-&gt;&gt;</span><span class="si">%s</span><span class="s2">,</span>
<span class="s2">                   &quot;test_new_api_prefetch&quot;.&quot;description&quot;-&gt;&gt;</span><span class="si">%s</span><span class="s2">,</span>
<span class="s2">                   &quot;test_new_api_prefetch&quot;.&quot;html_description&quot;-&gt;&gt;</span><span class="si">%s</span><span class="s2">,</span>
<span class="s2">                   &quot;test_new_api_prefetch&quot;.&quot;create_uid&quot;,</span>
<span class="s2">                   &quot;test_new_api_prefetch&quot;.&quot;create_date&quot;,</span>
<span class="s2">                   &quot;test_new_api_prefetch&quot;.&quot;write_uid&quot;,</span>
<span class="s2">                   &quot;test_new_api_prefetch&quot;.&quot;write_date&quot;</span>
<span class="s2">            FROM &quot;test_new_api_prefetch&quot;</span>
<span class="s2">            WHERE (&quot;test_new_api_prefetch&quot;.&quot;id&quot; IN </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">]):</span>
            <span class="n">records</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>  <span class="c1"># fetch all fields with prefetch=True</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT</span>
<span class="s2">                &quot;test_new_api_prefetch&quot;.&quot;id&quot;,</span>
<span class="s2">                &quot;test_new_api_prefetch&quot;.&quot;harry&quot;,</span>
<span class="s2">                &quot;test_new_api_prefetch&quot;.&quot;hermione&quot;,</span>
<span class="s2">                &quot;test_new_api_prefetch&quot;.&quot;ron&quot;</span>
<span class="s2">            FROM &quot;test_new_api_prefetch&quot;</span>
<span class="s2">            WHERE (&quot;test_new_api_prefetch&quot;.&quot;id&quot; IN </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">]):</span>
            <span class="n">records</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;harry&#39;</span><span class="p">)</span>  <span class="c1"># fetch all fields with prefetch=&#39;Harry Potter&#39;</span>
            <span class="n">records</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;hermione&#39;</span><span class="p">)</span>  <span class="c1"># fetched already</span>
            <span class="n">records</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;ron&#39;</span><span class="p">)</span>  <span class="c1"># fetched already</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT</span>
<span class="s2">                &quot;test_new_api_prefetch&quot;.&quot;id&quot;,</span>
<span class="s2">                &quot;test_new_api_prefetch&quot;.&quot;hansel&quot;,</span>
<span class="s2">                &quot;test_new_api_prefetch&quot;.&quot;gretel&quot;</span>
<span class="s2">            FROM &quot;test_new_api_prefetch&quot;</span>
<span class="s2">            WHERE (&quot;test_new_api_prefetch&quot;.&quot;id&quot; IN </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">]):</span>
            <span class="n">records</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;hansel&#39;</span><span class="p">)</span>  <span class="c1"># fetch all fields with prefetch=&#39;Hansel and Gretel&#39;</span>
            <span class="n">records</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;gretel&#39;</span><span class="p">)</span>  <span class="c1"># fetched already</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">records</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>  <span class="c1"># fetch all fields with prefetch=True</span>
            <span class="n">records</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;hansel&#39;</span><span class="p">)</span>  <span class="c1"># fetch all fields with prefetch=&#39;Hansel and Gretel&#39;</span>
            <span class="n">records</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;harry&#39;</span><span class="p">)</span>  <span class="c1"># fetch all fields with prefetch=&#39;Harry Potter&#39;</span>
            <span class="n">records</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;rare_description&#39;</span><span class="p">)</span>  <span class="c1"># fetch that field only</span></div>


<div class="viewcode-block" id="TestFields.test_cache_key_invalidation">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFields.test_cache_key_invalidation">[docs]</a>
    <span class="k">def</span> <span class="nf">test_cache_key_invalidation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">company0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.main_company&#39;</span><span class="p">)</span>
        <span class="n">company1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">})</span>

        <span class="n">user0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;company_id&#39;</span><span class="p">:</span> <span class="n">company0</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;company_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="n">company0</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">company1</span><span class="o">.</span><span class="n">id</span><span class="p">])],</span>
        <span class="p">})</span>

        <span class="c1"># this uses company0</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">user0</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;main&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span><span class="p">,</span> <span class="n">company0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;main&#39;</span><span class="p">)</span>

        <span class="c1"># change the user&#39;s company, so we implicitly switch to company1</span>
        <span class="n">user0</span><span class="o">.</span><span class="n">company_id</span> <span class="o">=</span> <span class="n">company1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">company</span><span class="p">,</span> <span class="n">company1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TestX2many">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestX2many">[docs]</a>
<span class="k">class</span> <span class="nc">TestX2many</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">TransactionCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestX2many.setUpClass">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestX2many.setUpClass">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUpClass</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">user_portal</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;portal&#39;</span><span class="p">)])</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">partner_portal</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">user_portal</span><span class="o">.</span><span class="n">partner_id</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">user_portal</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.config_parameter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="s1">&#39;auth_password_policy.minlength&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">partner_portal</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.partner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Joel Willis&#39;</span><span class="p">,</span>
                <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="s1">&#39;joel.willis63@example.com&#39;</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">user_portal</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">no_reset_password</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
                <span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="s1">&#39;portal&#39;</span><span class="p">,</span>
                <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;portal&#39;</span><span class="p">,</span>
                <span class="s1">&#39;partner_id&#39;</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">partner_portal</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;groups_id&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="bp">cls</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.group_portal&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">])],</span>
            <span class="p">})</span></div>


<div class="viewcode-block" id="TestX2many.test_definition_many2many">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestX2many.test_definition_many2many">[docs]</a>
    <span class="k">def</span> <span class="nf">test_definition_many2many</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Test the definition of inherited many2many fields. &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi.line&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">relation</span><span class="p">,</span> <span class="s1">&#39;test_new_api_multi_line_test_new_api_multi_tag_rel&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">column1</span><span class="p">,</span> <span class="s1">&#39;test_new_api_multi_line_id&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">column2</span><span class="p">,</span> <span class="s1">&#39;test_new_api_multi_tag_id&#39;</span><span class="p">)</span>

        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi.line2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">relation</span><span class="p">,</span> <span class="s1">&#39;test_new_api_multi_line2_test_new_api_multi_tag_rel&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">column1</span><span class="p">,</span> <span class="s1">&#39;test_new_api_multi_line2_id&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">column2</span><span class="p">,</span> <span class="s1">&#39;test_new_api_multi_tag_id&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestX2many.test_10_ondelete_many2many">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestX2many.test_10_ondelete_many2many">[docs]</a>
    <span class="k">def</span> <span class="nf">test_10_ondelete_many2many</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test A can&#39;t be deleted when used on the relation.&quot;&quot;&quot;</span>
        <span class="n">record_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;a&#39;</span><span class="p">})</span>
        <span class="n">record_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_b&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;b&#39;</span><span class="p">})</span>
        <span class="n">record_a</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
            <span class="s1">&#39;a_restricted_b_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">record_b</span><span class="o">.</span><span class="n">ids</span><span class="p">)],</span>
        <span class="p">})</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">psycopg2</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">mute_logger</span><span class="p">(</span><span class="s1">&#39;odoo.sql_db&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">savepoint</span><span class="p">():</span>
                <span class="n">record_a</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="c1"># Test B is still cascade.</span>
        <span class="n">record_b</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">record_b</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span></div>


<div class="viewcode-block" id="TestX2many.test_11_ondelete_many2many">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestX2many.test_11_ondelete_many2many">[docs]</a>
    <span class="k">def</span> <span class="nf">test_11_ondelete_many2many</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test B can&#39;t be deleted when used on the relation.&quot;&quot;&quot;</span>
        <span class="n">record_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;a&#39;</span><span class="p">})</span>
        <span class="n">record_b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_b&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;b&#39;</span><span class="p">})</span>
        <span class="n">record_a</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
            <span class="s1">&#39;b_restricted_b_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">record_b</span><span class="o">.</span><span class="n">ids</span><span class="p">)],</span>
        <span class="p">})</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">psycopg2</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">mute_logger</span><span class="p">(</span><span class="s1">&#39;odoo.sql_db&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">savepoint</span><span class="p">():</span>
                <span class="n">record_b</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="c1"># Test A is still cascade.</span>
        <span class="n">record_a</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">record_a</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span></div>


<div class="viewcode-block" id="TestX2many.test_12_active_test_one2many">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestX2many.test_12_active_test_one2many">[docs]</a>
    <span class="k">def</span> <span class="nf">test_12_active_test_one2many</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_active_field&#39;</span><span class="p">]</span>

        <span class="n">parent</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">children_ids</span><span class="p">)</span>

        <span class="c1"># create with implicit active_test=True in context</span>
        <span class="n">child1</span><span class="p">,</span> <span class="n">child2</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">create</span><span class="p">([</span>
            <span class="p">{</span><span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
        <span class="p">])</span>
        <span class="n">act_children</span> <span class="o">=</span> <span class="n">child1</span>
        <span class="n">all_children</span> <span class="o">=</span> <span class="n">child1</span> <span class="o">+</span> <span class="n">child2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">children_ids</span><span class="p">,</span> <span class="n">act_children</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">children_ids</span><span class="p">,</span> <span class="n">act_children</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">children_ids</span><span class="p">,</span> <span class="n">all_children</span><span class="p">)</span>

        <span class="c1"># create with active_test=False in context</span>
        <span class="n">child3</span><span class="p">,</span> <span class="n">child4</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">([</span>
            <span class="p">{</span><span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
        <span class="p">])</span>
        <span class="n">act_children</span> <span class="o">=</span> <span class="n">child1</span> <span class="o">+</span> <span class="n">child3</span>
        <span class="n">all_children</span> <span class="o">=</span> <span class="n">child1</span> <span class="o">+</span> <span class="n">child2</span> <span class="o">+</span> <span class="n">child3</span> <span class="o">+</span> <span class="n">child4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">children_ids</span><span class="p">,</span> <span class="n">act_children</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">children_ids</span><span class="p">,</span> <span class="n">act_children</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">children_ids</span><span class="p">,</span> <span class="n">all_children</span><span class="p">)</span>

        <span class="c1"># replace active children</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;children_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="n">child1</span><span class="o">.</span><span class="n">id</span><span class="p">])]})</span>
        <span class="n">act_children</span> <span class="o">=</span> <span class="n">child1</span>
        <span class="n">all_children</span> <span class="o">=</span> <span class="n">child1</span> <span class="o">+</span> <span class="n">child2</span> <span class="o">+</span> <span class="n">child4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">children_ids</span><span class="p">,</span> <span class="n">act_children</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">children_ids</span><span class="p">,</span> <span class="n">act_children</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">children_ids</span><span class="p">,</span> <span class="n">all_children</span><span class="p">)</span>

        <span class="c1"># replace all children</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;children_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="n">child1</span><span class="o">.</span><span class="n">id</span><span class="p">])]})</span>
        <span class="n">act_children</span> <span class="o">=</span> <span class="n">child1</span>
        <span class="n">all_children</span> <span class="o">=</span> <span class="n">child1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">children_ids</span><span class="p">,</span> <span class="n">act_children</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">children_ids</span><span class="p">,</span> <span class="n">act_children</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">children_ids</span><span class="p">,</span> <span class="n">all_children</span><span class="p">)</span>

        <span class="c1"># check recomputation of inactive records</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;children_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">child4</span><span class="o">.</span><span class="n">ids</span><span class="p">)]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">child4</span><span class="o">.</span><span class="n">parent_active</span><span class="p">)</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">child4</span><span class="o">.</span><span class="n">parent_active</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestX2many.test_12_active_test_one2many_with_context">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestX2many.test_12_active_test_one2many_with_context">[docs]</a>
    <span class="k">def</span> <span class="nf">test_12_active_test_one2many_with_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_active_field&#39;</span><span class="p">]</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">all_children</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">create</span><span class="p">([</span>
            <span class="p">{</span><span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
        <span class="p">])</span>
        <span class="n">act_children</span> <span class="o">=</span> <span class="n">all_children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">children_ids</span><span class="p">,</span> <span class="n">act_children</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">children_ids</span><span class="p">,</span> <span class="n">act_children</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">children_ids</span><span class="p">,</span> <span class="n">all_children</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">all_children_ids</span><span class="p">,</span> <span class="n">all_children</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">all_children_ids</span><span class="p">,</span> <span class="n">all_children</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">all_children_ids</span><span class="p">,</span> <span class="n">all_children</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">active_children_ids</span><span class="p">,</span> <span class="n">act_children</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">active_children_ids</span><span class="p">,</span> <span class="n">act_children</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">active_children_ids</span><span class="p">,</span> <span class="n">act_children</span><span class="p">)</span>

        <span class="c1"># check read()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">children_ids</span><span class="p">,</span> <span class="n">act_children</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">all_children_ids</span><span class="p">,</span> <span class="n">all_children</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">active_children_ids</span><span class="p">,</span> <span class="n">act_children</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">children_ids</span><span class="p">,</span> <span class="n">all_children</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">all_children_ids</span><span class="p">,</span> <span class="n">all_children</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">active_children_ids</span><span class="p">,</span> <span class="n">act_children</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestX2many.test_12_active_test_one2many_search">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestX2many.test_12_active_test_one2many_search">[docs]</a>
    <span class="k">def</span> <span class="nf">test_12_active_test_one2many_search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_active_field&#39;</span><span class="p">]</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">all_children</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">create</span><span class="p">([</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
        <span class="p">])</span>

        <span class="c1"># a one2many field without context does not match its inactive children</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">Model</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;children_ids.name&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">Model</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;children_ids.name&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">)]))</span>

        <span class="c1"># a one2many field with active_test=False matches its inactive children</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">Model</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;all_children_ids.name&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">Model</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;all_children_ids.name&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">)]))</span></div>


<div class="viewcode-block" id="TestX2many.test_search_many2many">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestX2many.test_search_many2many">[docs]</a>
    <span class="k">def</span> <span class="nf">test_search_many2many</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Tests search on many2many fields. &quot;&quot;&quot;</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi.tag&#39;</span><span class="p">]</span>
        <span class="n">tagA</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">tagB</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">tagC</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">recs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi.line&#39;</span><span class="p">]</span>
        <span class="n">recW</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">recX</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">tagA</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>
        <span class="n">recY</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">tagB</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>
        <span class="n">recZ</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">tagA</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">tagB</span><span class="o">.</span><span class="n">id</span><span class="p">)]})</span>
        <span class="n">recs</span> <span class="o">=</span> <span class="n">recW</span> <span class="o">+</span> <span class="n">recX</span> <span class="o">+</span> <span class="n">recY</span> <span class="o">+</span> <span class="n">recZ</span>

        <span class="c1"># test &#39;in&#39;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">tagA</span> <span class="o">+</span> <span class="n">tagB</span><span class="p">)</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recX</span> <span class="o">+</span> <span class="n">recY</span> <span class="o">+</span> <span class="n">recZ</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">tagA</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recX</span> <span class="o">+</span> <span class="n">recZ</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">tagB</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recY</span> <span class="o">+</span> <span class="n">recZ</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">tagC</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">browse</span><span class="p">())</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="p">[])])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">browse</span><span class="p">())</span>

        <span class="c1"># test &#39;not in&#39;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">tagA</span> <span class="o">+</span> <span class="n">tagB</span><span class="p">)</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recs</span> <span class="o">-</span> <span class="n">recX</span> <span class="o">-</span> <span class="n">recY</span> <span class="o">-</span> <span class="n">recZ</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">,</span> <span class="n">tagA</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recs</span> <span class="o">-</span> <span class="n">recX</span> <span class="o">-</span> <span class="n">recZ</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">,</span> <span class="n">tagB</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recs</span> <span class="o">-</span> <span class="n">recY</span> <span class="o">-</span> <span class="n">recZ</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">,</span> <span class="n">tagC</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recs</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">,</span> <span class="p">[])])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recs</span><span class="p">)</span>

        <span class="c1"># special case: compare with False</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recW</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;!=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recs</span> <span class="o">-</span> <span class="n">recW</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestX2many.test_search_one2many">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestX2many.test_search_one2many">[docs]</a>
    <span class="k">def</span> <span class="nf">test_search_one2many</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Tests search on one2many fields. &quot;&quot;&quot;</span>
        <span class="n">recs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi&#39;</span><span class="p">]</span>
        <span class="n">recX</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;lines&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({}),</span> <span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({})]})</span>
        <span class="n">recY</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;lines&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({})]})</span>
        <span class="n">recZ</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">recs</span> <span class="o">=</span> <span class="n">recX</span> <span class="o">+</span> <span class="n">recY</span> <span class="o">+</span> <span class="n">recZ</span>
        <span class="n">line1</span><span class="p">,</span> <span class="n">line2</span><span class="p">,</span> <span class="n">line3</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">lines</span>
        <span class="n">line4</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;lines&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({})]})</span><span class="o">.</span><span class="n">lines</span>
        <span class="n">line0</span> <span class="o">=</span> <span class="n">line4</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>

        <span class="c1"># test &#39;in&#39;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">line1</span> <span class="o">+</span> <span class="n">line2</span> <span class="o">+</span> <span class="n">line3</span> <span class="o">+</span> <span class="n">line4</span><span class="p">)</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recX</span> <span class="o">+</span> <span class="n">recY</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">line1</span> <span class="o">+</span> <span class="n">line3</span> <span class="o">+</span> <span class="n">line4</span><span class="p">)</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recX</span> <span class="o">+</span> <span class="n">recY</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">line1</span> <span class="o">+</span> <span class="n">line4</span><span class="p">)</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recX</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">line4</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">browse</span><span class="p">())</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="p">[])])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">browse</span><span class="p">())</span>

        <span class="c1"># test &#39;not in&#39;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">line1</span> <span class="o">+</span> <span class="n">line2</span> <span class="o">+</span> <span class="n">line3</span><span class="p">)</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recs</span> <span class="o">-</span> <span class="n">recX</span> <span class="o">-</span> <span class="n">recY</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">line1</span> <span class="o">+</span> <span class="n">line3</span><span class="p">)</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recs</span> <span class="o">-</span> <span class="n">recX</span> <span class="o">-</span> <span class="n">recY</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">,</span> <span class="n">line1</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recs</span> <span class="o">-</span> <span class="n">recX</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">line1</span> <span class="o">+</span> <span class="n">line4</span><span class="p">)</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recs</span> <span class="o">-</span> <span class="n">recX</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">,</span> <span class="n">line4</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recs</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">,</span> <span class="p">[])])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recs</span><span class="p">)</span>

        <span class="c1"># test &#39;not in&#39; where the lines contain NULL values</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">line1</span> <span class="o">+</span> <span class="n">line0</span><span class="p">)</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recs</span> <span class="o">-</span> <span class="n">recX</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span><span class="p">,</span> <span class="n">line0</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recs</span><span class="p">)</span>

        <span class="c1"># special case: compare with False</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recZ</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="s1">&#39;!=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">recs</span> <span class="o">-</span> <span class="n">recZ</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestX2many.test_create_batch_m2m">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestX2many.test_create_batch_m2m">[docs]</a>
    <span class="k">def</span> <span class="nf">test_create_batch_m2m</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi.line&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">([{</span>
            <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)})</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)],</span>
        <span class="p">}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">tags</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestX2many.test_custom_m2m">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestX2many.test_custom_m2m">[docs]</a>
    <span class="k">def</span> <span class="nf">test_custom_m2m</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">model_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_id</span><span class="p">(</span><span class="s1">&#39;res.partner&#39;</span><span class="p">)</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;x_foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;field_description&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;model_id&#39;</span><span class="p">:</span> <span class="n">model_id</span><span class="p">,</span>
            <span class="s1">&#39;ttype&#39;</span><span class="p">:</span> <span class="s1">&#39;many2many&#39;</span><span class="p">,</span>
            <span class="s1">&#39;relation&#39;</span><span class="p">:</span> <span class="s1">&#39;res.country&#39;</span><span class="p">,</span>
            <span class="s1">&#39;store&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">unlink</span><span class="p">())</span></div>


<div class="viewcode-block" id="TestX2many.test_custom_m2m_related">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestX2many.test_custom_m2m_related">[docs]</a>
    <span class="k">def</span> <span class="nf">test_custom_m2m_related</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># this checks the ondelete of a related many2many field</span>
        <span class="n">model_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_get_id</span><span class="p">(</span><span class="s1">&#39;res.partner&#39;</span><span class="p">)</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;x_foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;field_description&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;model_id&#39;</span><span class="p">:</span> <span class="n">model_id</span><span class="p">,</span>
            <span class="s1">&#39;ttype&#39;</span><span class="p">:</span> <span class="s1">&#39;many2many&#39;</span><span class="p">,</span>
            <span class="s1">&#39;relation&#39;</span><span class="p">:</span> <span class="s1">&#39;res.partner.category&#39;</span><span class="p">,</span>
            <span class="s1">&#39;related&#39;</span><span class="p">:</span> <span class="s1">&#39;category_id&#39;</span><span class="p">,</span>
            <span class="s1">&#39;readonly&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;store&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">unlink</span><span class="p">())</span></div>


<div class="viewcode-block" id="TestX2many.test_sudo_commands">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestX2many.test_sudo_commands">[docs]</a>
    <span class="nd">@mute_logger</span><span class="p">(</span><span class="s1">&#39;odoo.addons.base.models.ir_model&#39;</span><span class="p">)</span>
    <span class="nd">@common</span><span class="o">.</span><span class="n">users</span><span class="p">(</span><span class="s1">&#39;portal&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_sudo_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test manipulating a x2many field using Commands with `sudo` or with another user (`with_user`)</span>
<span class="sd">        is not allowed when the destination model is flagged `_allow_sudo_commands = False` and the transaction user</span>
<span class="sd">        does not have the required access rights.</span>

<span class="sd">        This test asserts an AccessError is raised</span>
<span class="sd">        when a user attempts to pass Commands to a One2many and Many2many field</span>
<span class="sd">        targeting a model flagged with `_allow_sudo_commands = False`</span>
<span class="sd">        while using an environment with `sudo()` or `with_user(admin_user)`.</span>

<span class="sd">        The `with_user` are edge cases in some business codes, where a more-priviledged user is used temporary</span>
<span class="sd">        to perform an action, such as:</span>
<span class="sd">        - `Documents.with_user(share.create_uid)`</span>
<span class="sd">        - `request.env[&#39;sign.request&#39;].with_user(contract.hr_responsible_id).sudo()`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">admin_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.user_admin&#39;</span><span class="p">)</span>
        <span class="n">my_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">sudo</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># 1. one2many field `res.partner.user_ids`</span>
        <span class="c1"># Sanity checks</span>
        <span class="c1"># `res.partner` must be flagged as `_allow_sudo_commands = False` otherwise the test is pointless</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_allow_sudo_commands</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># in case the type of `res.partner.user_ids` changes in a future release.</span>
        <span class="c1"># if `res.partner.user_ids` is no longer a one2many, this test must be adapted.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.partner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;user_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;one2many&#39;</span><span class="p">)</span>
        <span class="n">my_partner</span> <span class="o">=</span> <span class="n">my_user</span><span class="o">.</span><span class="n">partner_id</span>

        <span class="k">for</span> <span class="n">Partner</span><span class="p">,</span> <span class="n">my_partner</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.partner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">admin_user</span><span class="p">),</span> <span class="n">my_partner</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">admin_user</span><span class="p">)),</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.partner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">(),</span> <span class="n">my_partner</span><span class="o">.</span><span class="n">sudo</span><span class="p">()),</span>
        <span class="p">]:</span>
            <span class="c1"># 1.0 Command.CREATE</span>
            <span class="c1"># Case: a public/portal user creating a new users with arbitrary values</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">AccessError</span><span class="p">,</span> <span class="s2">&quot;not allowed to create &#39;User&#39;&quot;</span><span class="p">):</span>
                <span class="n">Partner</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;user_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
                        <span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
                    <span class="p">})],</span>
                <span class="p">})</span>
            <span class="c1"># 1.1 Command.UPDATE</span>
            <span class="c1"># Case: a public/portal updating his user to add himself a group</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">AccessError</span><span class="p">,</span> <span class="s2">&quot;not allowed to modify &#39;User&#39;&quot;</span><span class="p">):</span>
                <span class="n">my_partner</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
                    <span class="s1">&#39;user_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">my_partner</span><span class="o">.</span><span class="n">user_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">{</span>
                        <span class="s1">&#39;groups_id&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.group_system&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">],</span>
                    <span class="p">})],</span>
                <span class="p">})</span>
            <span class="c1"># 1.2 Command.DELETE</span>
            <span class="c1"># Case: a public user deleting the public user to mess with the database</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">AccessError</span><span class="p">,</span> <span class="s2">&quot;not allowed to delete &#39;User&#39;&quot;</span><span class="p">):</span>
                <span class="n">my_partner</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
                    <span class="s1">&#39;user_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">my_partner</span><span class="o">.</span><span class="n">user_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">)],</span>
                <span class="p">})</span>
            <span class="c1"># 1.3 Command.UNLINK</span>
            <span class="c1"># Case: a public user unlinking the public partner and the public user to mess with the database</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">AccessError</span><span class="p">,</span> <span class="s2">&quot;not allowed to modify &#39;User&#39;&quot;</span><span class="p">):</span>
                <span class="n">my_partner</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
                    <span class="s1">&#39;user_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">my_partner</span><span class="o">.</span><span class="n">user_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">)],</span>
                <span class="p">})</span>
            <span class="c1"># 1.4 Command.LINK</span>
            <span class="c1"># Case: a public/portal user changing the `partner_id` of an admin,</span>
            <span class="c1"># to change the email address of the user and ask for a reset password.</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">AccessError</span><span class="p">,</span> <span class="s2">&quot;not allowed to modify &#39;User&#39;&quot;</span><span class="p">):</span>
                <span class="n">my_partner</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
                    <span class="s1">&#39;user_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">admin_user</span><span class="o">.</span><span class="n">id</span><span class="p">)],</span>
                <span class="p">})</span>
            <span class="c1"># 1.5 Command.CLEAR</span>
            <span class="c1"># Case: a public user unlinking the public partner and the public user just to mess with the database</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">AccessError</span><span class="p">,</span> <span class="s2">&quot;not allowed to modify &#39;User&#39;&quot;</span><span class="p">):</span>
                <span class="n">my_partner</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
                    <span class="s1">&#39;user_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">clear</span><span class="p">()],</span>
                <span class="p">})</span>
            <span class="c1"># 1.6 Command.SET</span>
            <span class="c1"># Case: a public/portal user changing the `partner_id` of an admin,</span>
            <span class="c1"># to change the email address of the user and ask for a reset password.</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">AccessError</span><span class="p">,</span> <span class="s2">&quot;not allowed to modify &#39;User&#39;&quot;</span><span class="p">):</span>
                <span class="n">my_partner</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
                    <span class="s1">&#39;user_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">set</span><span class="p">([</span><span class="n">admin_user</span><span class="o">.</span><span class="n">id</span><span class="p">])],</span>
                <span class="p">})</span>

        <span class="c1"># 2. many2many field `test_new_api.discussion.participants`</span>
        <span class="c1"># Sanity checks</span>
        <span class="c1"># `test_new_api.user` must be flagged as `_allow_sudo_commands = False` otherwise the test is pointless</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_allow_sudo_commands</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># in case the type of `test_new_api.discussion.participants` changes in a future release.</span>
        <span class="c1"># if `test_new_api.discussion.participants` is no longer a many2many, this test must be adapted.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;group_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s1">&#39;many2many&#39;</span><span class="p">)</span>
        <span class="n">public_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">admin_user</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;public&#39;</span>
        <span class="p">})</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">my_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">admin_user</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;group_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">public_group</span><span class="o">.</span><span class="n">id</span><span class="p">],</span>
        <span class="p">})</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">User</span><span class="p">,</span> <span class="n">my_user</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">admin_user</span><span class="p">),</span> <span class="n">my_user</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">admin_user</span><span class="p">)),</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.user&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">(),</span> <span class="n">my_user</span><span class="o">.</span><span class="n">sudo</span><span class="p">()),</span>
        <span class="p">]:</span>
            <span class="c1"># 2.0 Command.CREATE</span>
            <span class="c1"># Case: a public/portal user creating a new users with arbitrary values</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">AccessError</span><span class="p">,</span> <span class="s2">&quot;not allowed to create &#39;test_new_api.group&#39;&quot;</span><span class="p">):</span>
                <span class="n">User</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;group_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({})],</span>
                <span class="p">})</span>
            <span class="c1"># 2.1 Command.UPDATE</span>
            <span class="c1"># Case: a public/portal updating his user to add himself a group</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">AccessError</span><span class="p">,</span> <span class="s2">&quot;not allowed to modify &#39;test_new_api.group&#39;&quot;</span><span class="p">):</span>
                <span class="n">my_user</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
                    <span class="s1">&#39;group_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">my_user</span><span class="o">.</span><span class="n">group_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">{})],</span>
                <span class="p">})</span>
            <span class="c1"># 2.2 Command.DELETE</span>
            <span class="c1"># Case: a public user deleting the public user to mess with the database</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="n">AccessError</span><span class="p">,</span> <span class="s2">&quot;not allowed to delete &#39;test_new_api.group&#39;&quot;</span><span class="p">):</span>
                <span class="n">my_user</span><span class="o">.</span><span class="n">write</span><span class="p">({</span>
                    <span class="s1">&#39;group_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">my_user</span><span class="o">.</span><span class="n">group_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">)],</span>
                <span class="p">})</span></div>
</div>



<div class="viewcode-block" id="TestHtmlField">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestHtmlField">[docs]</a>
<span class="k">class</span> <span class="nc">TestHtmlField</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">TransactionCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestHtmlField.setUp">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestHtmlField.setUp">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestHtmlField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.mixed&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="TestHtmlField.test_00_sanitize">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestHtmlField.test_00_sanitize">[docs]</a>
    <span class="k">def</span> <span class="nf">test_00_sanitize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;comment1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sanitize</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;comment2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sanitize_attributes</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;comment2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip_classes</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;comment3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sanitize_attributes</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;comment3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip_classes</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">some_ugly_html</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;&lt;p&gt;Oops this should maybe be sanitized</span>
<span class="si">% i</span><span class="s2">f object.some_field and not object.oriented:</span>
<span class="s2">&lt;table&gt;</span>
<span class="s2">    </span><span class="si">% i</span><span class="s2">f object.other_field:</span>
<span class="s2">    &lt;tr style=&quot;margin: 0px; border: 10px solid black;&quot;&gt;</span>
<span class="s2">        $</span><span class="si">{object.mako_thing}</span>
<span class="s2">        &lt;td&gt;</span>
<span class="s2">    &lt;/tr&gt;</span>
<span class="s2">    &lt;tr class=&quot;custom_class&quot;&gt;</span>
<span class="s2">        This is some html.</span>
<span class="s2">    &lt;/tr&gt;</span>
<span class="s2">    </span><span class="si">% e</span><span class="s2">ndif</span>
<span class="s2">    &lt;tr&gt;</span>
<span class="si">%i</span><span class="s2">f object.dummy_field:</span>
<span class="s2">        &lt;p&gt;Youpie&lt;/p&gt;</span>
<span class="si">%e</span><span class="s2">ndif&quot;&quot;&quot;</span>

        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;comment1&#39;</span><span class="p">:</span> <span class="n">some_ugly_html</span><span class="p">,</span>
            <span class="s1">&#39;comment2&#39;</span><span class="p">:</span> <span class="n">some_ugly_html</span><span class="p">,</span>
            <span class="s1">&#39;comment3&#39;</span><span class="p">:</span> <span class="n">some_ugly_html</span><span class="p">,</span>
            <span class="s1">&#39;comment4&#39;</span><span class="p">:</span> <span class="n">some_ugly_html</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">comment1</span><span class="p">,</span> <span class="n">some_ugly_html</span><span class="p">,</span> <span class="s1">&#39;Error in HTML field: content was sanitized but field has sanitize=False&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;&lt;tr class=&quot;&#39;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">comment2</span><span class="p">)</span>

        <span class="c1"># sanitize should have closed tags left open in the original html</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;&lt;/table&gt;&#39;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">comment3</span><span class="p">,</span> <span class="s1">&#39;Error in HTML field: content does not seem to have been sanitized despise sanitize=True&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;&lt;/td&gt;&#39;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">comment3</span><span class="p">,</span> <span class="s1">&#39;Error in HTML field: content does not seem to have been sanitized despise sanitize=True&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;&lt;tr style=&quot;&#39;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">comment3</span><span class="p">,</span> <span class="s1">&#39;Style attr should not have been stripped&#39;</span><span class="p">)</span>
        <span class="c1"># sanitize does not keep classes if asked to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;&lt;tr class=&quot;&#39;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">comment3</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;&lt;tr style=&quot;&#39;</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">comment4</span><span class="p">,</span> <span class="s1">&#39;Style attr should have been stripped&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestHtmlField.test_01_sanitize_groups">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestHtmlField.test_01_sanitize_groups">[docs]</a>
    <span class="k">def</span> <span class="nf">test_01_sanitize_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;comment5&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sanitize</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;comment5&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sanitize_overridable</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">internal_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test internal user&#39;</span><span class="p">,</span>
            <span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="s1">&#39;test_sanitize&#39;</span><span class="p">,</span>
            <span class="s1">&#39;groups_id&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.group_user&#39;</span><span class="p">)])],</span>
        <span class="p">})</span>
        <span class="n">bypass_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;test bypass user&#39;</span><span class="p">,</span>
            <span class="s1">&#39;login&#39;</span><span class="p">:</span> <span class="s1">&#39;test_sanitize2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;groups_id&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.group_user&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.group_sanitize_override&#39;</span><span class="p">)])],</span>
        <span class="p">})</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.mixed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>

        <span class="c1"># 1. Test normalize case: diff due to normalize should not prevent the</span>
        <span class="c1">#    changes</span>
        <span class="n">val</span> <span class="o">=</span> <span class="s1">&#39;&lt;blockquote&gt;Something&lt;/blockquote&gt;&#39;</span>
        <span class="n">normalized_val</span> <span class="o">=</span> <span class="s1">&#39;&lt;blockquote data-o-mail-quote-node=&quot;1&quot; data-o-mail-quote=&quot;1&quot;&gt;Something&lt;/blockquote&gt;&#39;</span>
        <span class="n">write_vals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;comment5&#39;</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>

        <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">internal_user</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">write_vals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">comment5</span><span class="p">,</span> <span class="n">normalized_val</span><span class="p">,</span>
                         <span class="s2">&quot;should be normalized (not in groups)&quot;</span><span class="p">)</span>
        <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">bypass_user</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">write_vals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">comment5</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span>
                         <span class="s2">&quot;should not be normalized (has group)&quot;</span><span class="p">)</span>
        <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">internal_user</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">write_vals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">comment5</span><span class="p">,</span> <span class="n">normalized_val</span><span class="p">,</span>
                         <span class="s2">&quot;should be normalized (not in groups) despite admin previous diff&quot;</span><span class="p">)</span>

        <span class="c1"># 2. Test main use case: prevent restricted user to wipe non restricted</span>
        <span class="c1">#    user previous change</span>
        <span class="n">val</span> <span class="o">=</span> <span class="s1">&#39;&lt;script&gt;&lt;/script&gt;&#39;</span>
        <span class="n">write_vals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;comment5&#39;</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>

        <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">internal_user</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">write_vals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">comment5</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                         <span class="s2">&quot;should be sanitized (not in groups)&quot;</span><span class="p">)</span>
        <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">bypass_user</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">write_vals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">comment5</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span>
                         <span class="s2">&quot;should not be sanitized (has group)&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">UserError</span><span class="p">):</span>
            <span class="c1"># should crash (not in groups and sanitize would break content of</span>
            <span class="c1"># other user that bypassed the sanitize)</span>
            <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">internal_user</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">write_vals</span><span class="p">)</span>

        <span class="c1"># 3. Make sure field compare in `_convert` is working as expected with</span>
        <span class="c1">#    special content / format</span>
        <span class="n">val</span> <span class="o">=</span> <span class="s1">&#39;&lt;span  attr1 =&quot;att1&quot;   attr2=</span><span class="se">\&#39;</span><span class="s1">attr2</span><span class="se">\&#39;</span><span class="s1">&gt;é@&amp;nbsp;&lt;/span&gt;&lt;p&gt;&lt;span/&gt;&lt;/p&gt;&#39;</span>
        <span class="n">write_vals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;comment5&#39;</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
        <span class="c1"># Once sent through `html_sanitize()` this is becoming:</span>
        <span class="c1"># `&lt;span attr1=&quot;att1&quot; attr2=&quot;attr2&quot;&gt;é@\xa0&lt;/span&gt;&lt;p&gt;&lt;span&gt;&lt;/span&gt;&lt;/p&gt;`</span>
        <span class="c1"># Notice those change:</span>
        <span class="c1"># -     `attr1 =` -&gt; `attr1=`    (space before `=`)</span>
        <span class="c1"># -    `   attr2` -&gt; ` attr2`    (multi space -&gt; single space)</span>
        <span class="c1"># -  `=\&#39;attr2\&#39;` -&gt; `=&quot;attr2&quot;`  (escaped single quote -&gt; double quote)</span>
        <span class="c1"># -      `&amp;nbsp;` -&gt; `\xa0`</span>
        <span class="c1"># Still, those 2 archs should be considered equals and not raise</span>

        <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">bypass_user</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">write_vals</span><span class="p">)</span>
        <span class="c1"># Next write shouldn&#39;t raise a sanitize right error</span>
        <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">internal_user</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">write_vals</span><span class="p">)</span>

        <span class="c1"># 4. Ensure our exception handling is fine</span>
        <span class="n">val</span> <span class="o">=</span> <span class="s1">&#39;&lt;!-- I am a comment --&gt;&#39;</span>
        <span class="n">write_vals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;comment5&#39;</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
        <span class="n">record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">internal_user</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">write_vals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">comment5</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                         <span class="s2">&quot;should be sanitized (not in groups)&quot;</span><span class="p">)</span>

        <span class="c1"># extra test with new record having &#39;record&#39; as origin</span>
        <span class="n">new_record</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">record</span><span class="p">)</span>
        <span class="n">new_record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">bypass_user</span><span class="p">)</span><span class="o">.</span><span class="n">comment5</span>

        <span class="c1"># this was causing an infinite recursion (see explanation in fields.py)</span>
        <span class="n">new_record</span><span class="o">.</span><span class="n">invalidate_recordset</span><span class="p">()</span>
        <span class="n">new_record</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="n">internal_user</span><span class="p">)</span><span class="o">.</span><span class="n">comment5</span></div>


<div class="viewcode-block" id="TestHtmlField.test_onchange_sanitize">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestHtmlField.test_onchange_sanitize">[docs]</a>
    <span class="nd">@patch</span><span class="p">(</span><span class="s1">&#39;odoo.fields.html_sanitize&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="s1">&#39;&lt;p&gt;comment&lt;/p&gt;&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_onchange_sanitize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patch</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;test_new_api.mixed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">comment2</span><span class="o">.</span><span class="n">sanitize</span><span class="p">)</span>

        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.mixed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;comment2&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;p&gt;comment&lt;/p&gt;&#39;</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="c1"># in a perfect world this should be 1, but at the moment the value is</span>
        <span class="c1"># sanitized more than once during creation of the record</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">call_count</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># new value needs to be validated, so it is sanitized once more</span>
        <span class="n">record</span><span class="o">.</span><span class="n">comment2</span> <span class="o">=</span> <span class="s1">&#39;&lt;p&gt;comment&lt;/p&gt;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">call_count</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># the value is already sanitized for flushing</span>
        <span class="n">record</span><span class="o">.</span><span class="n">flush_recordset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">call_count</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># value coming from db does not need to be sanitized</span>
        <span class="n">record</span><span class="o">.</span><span class="n">invalidate_recordset</span><span class="p">()</span>
        <span class="n">record</span><span class="o">.</span><span class="n">comment2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">call_count</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># value coming from db during an onchange does not need to be sanitized</span>
        <span class="n">new_record</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="n">record</span><span class="p">)</span>
        <span class="n">new_record</span><span class="o">.</span><span class="n">comment2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">call_count</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TestMagicFields">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestMagicFields">[docs]</a>
<span class="k">class</span> <span class="nc">TestMagicFields</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">TransactionCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestMagicFields.test_write_date">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestMagicFields.test_write_date">[docs]</a>
    <span class="k">def</span> <span class="nf">test_write_date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.discussion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Booba&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">create_uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">write_uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestMagicFields.test_mro_mixin">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestMagicFields.test_mro_mixin">[docs]</a>
    <span class="k">def</span> <span class="nf">test_mro_mixin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#                               Mixin</span>
        <span class="c1">#                                |</span>
        <span class="c1">#                                |</span>
        <span class="c1">#                                |</span>
        <span class="c1">#   ExtendedDisplay    &#39;test_new_api.mixin&#39;    Display    &#39;base&#39;</span>
        <span class="c1">#         |                      |                |         |</span>
        <span class="c1">#         +----------------------+-+--------------+---------+</span>
        <span class="c1">#                                  |</span>
        <span class="c1">#                       &#39;test_new_api.display&#39;</span>
        <span class="c1">#</span>
        <span class="c1"># The field &#39;display_name&#39; is defined as store=True on the class Display</span>
        <span class="c1"># above.  The field &#39;display_name&#39; on the model &#39;test_new_api.mixin&#39; is</span>
        <span class="c1"># expected to be automatic and non-stored.  But the field &#39;display_name&#39;</span>
        <span class="c1"># on the model &#39;test_new_api.display&#39; should not be automatic: it must</span>
        <span class="c1"># correspond to the definition given in class Display, even if the MRO</span>
        <span class="c1"># of the model shows the automatic field on the mixin model before the</span>
        <span class="c1"># actual definition.</span>
        <span class="n">registry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span>
        <span class="n">models</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">models</span>

        <span class="c1"># check setup of models in alphanumeric order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>
        <span class="n">registry</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">registry</span><span class="p">[</span><span class="s1">&#39;test_new_api.display&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">display_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">automatic</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">)</span>

        <span class="c1"># check setup of models in reverse alphanumeric order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
        <span class="n">registry</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">registry</span><span class="p">[</span><span class="s1">&#39;test_new_api.display&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">display_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">automatic</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TestParentStore">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestParentStore">[docs]</a>
<span class="k">class</span> <span class="nc">TestParentStore</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">TransactionCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestParentStore.setUp">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestParentStore.setUp">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TestParentStore</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="c1"># make a tree of categories:</span>
        <span class="c1">#   0</span>
        <span class="c1">#  /|\</span>
        <span class="c1"># 1 2 3</span>
        <span class="c1">#    /|\</span>
        <span class="c1">#   4 5 6</span>
        <span class="c1">#      /|\</span>
        <span class="c1">#     7 8 9</span>
        <span class="n">Cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.category&#39;</span><span class="p">]</span>
        <span class="n">cat0</span> <span class="o">=</span> <span class="n">Cat</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">})</span>
        <span class="n">cat1</span> <span class="o">=</span> <span class="n">Cat</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">cat0</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="n">cat2</span> <span class="o">=</span> <span class="n">Cat</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">cat0</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="n">cat3</span> <span class="o">=</span> <span class="n">Cat</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">cat0</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="n">cat4</span> <span class="o">=</span> <span class="n">Cat</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">cat3</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="n">cat5</span> <span class="o">=</span> <span class="n">Cat</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">cat3</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="n">cat6</span> <span class="o">=</span> <span class="n">Cat</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">cat3</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="n">cat7</span> <span class="o">=</span> <span class="n">Cat</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">cat6</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="n">cat8</span> <span class="o">=</span> <span class="n">Cat</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;8&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">cat6</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="n">cat9</span> <span class="o">=</span> <span class="n">Cat</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;9&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="n">cat6</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cats</span> <span class="o">=</span> <span class="n">Cat</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">cat0</span><span class="p">,</span> <span class="n">cat1</span><span class="p">,</span> <span class="n">cat2</span><span class="p">,</span> <span class="n">cat3</span><span class="p">,</span> <span class="n">cat4</span><span class="p">,</span>
                                <span class="n">cat5</span><span class="p">,</span> <span class="n">cat6</span><span class="p">,</span> <span class="n">cat7</span><span class="p">,</span> <span class="n">cat8</span><span class="p">,</span> <span class="n">cat9</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestParentStore.cats">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestParentStore.cats">[docs]</a>
    <span class="k">def</span> <span class="nf">cats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">indexes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the given categories. &quot;&quot;&quot;</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cats</span><span class="o">.</span><span class="n">ids</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cats</span><span class="o">.</span><span class="n">browse</span><span class="p">([</span><span class="n">ids</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">])</span></div>


<div class="viewcode-block" id="TestParentStore.assertChildOf">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestParentStore.assertChildOf">[docs]</a>
    <span class="k">def</span> <span class="nf">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">children</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">category</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;child_of&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">.</span><span class="n">ids</span><span class="p">)]),</span> <span class="n">children</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestParentStore.assertParentOf">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestParentStore.assertParentOf">[docs]</a>
    <span class="k">def</span> <span class="nf">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">parents</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">category</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_of&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">.</span><span class="n">ids</span><span class="p">)]),</span> <span class="n">parents</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestParentStore.test_base">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestParentStore.test_base">[docs]</a>
    <span class="k">def</span> <span class="nf">test_base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Check the initial tree structure. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span></div>


<div class="viewcode-block" id="TestParentStore.test_base_compute">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestParentStore.test_base_compute">[docs]</a>
    <span class="k">def</span> <span class="nf">test_base_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Check the tree structure after computation from scratch. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">()</span><span class="o">.</span><span class="n">_parent_store_compute</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span></div>


<div class="viewcode-block" id="TestParentStore.test_delete">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestParentStore.test_delete">[docs]</a>
    <span class="k">def</span> <span class="nf">test_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Delete a node. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span></div>


<div class="viewcode-block" id="TestParentStore.test_move_1_0">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestParentStore.test_move_1_0">[docs]</a>
    <span class="k">def</span> <span class="nf">test_move_1_0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Move a node to a root position. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span></div>


<div class="viewcode-block" id="TestParentStore.test_move_1_1">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestParentStore.test_move_1_1">[docs]</a>
    <span class="k">def</span> <span class="nf">test_move_1_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Move a node into an empty subtree. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span></div>


<div class="viewcode-block" id="TestParentStore.test_move_1_N">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestParentStore.test_move_1_N">[docs]</a>
    <span class="k">def</span> <span class="nf">test_move_1_N</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Move a node into a non-empty subtree. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span></div>


<div class="viewcode-block" id="TestParentStore.test_move_N_0">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestParentStore.test_move_N_0">[docs]</a>
    <span class="k">def</span> <span class="nf">test_move_N_0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Move multiple nodes to root position. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span></div>


<div class="viewcode-block" id="TestParentStore.test_move_N_1">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestParentStore.test_move_N_1">[docs]</a>
    <span class="k">def</span> <span class="nf">test_move_N_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Move multiple nodes to an empty subtree. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span></div>


<div class="viewcode-block" id="TestParentStore.test_move_N_N">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestParentStore.test_move_N_N">[docs]</a>
    <span class="k">def</span> <span class="nf">test_move_N_N</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Move multiple nodes to a non- empty subtree. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertChildOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertParentOf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span></div>


<div class="viewcode-block" id="TestParentStore.test_move_1_cycle">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestParentStore.test_move_1_cycle">[docs]</a>
    <span class="k">def</span> <span class="nf">test_move_1_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Move a node to create a cycle. &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">UserError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">})</span></div>


<div class="viewcode-block" id="TestParentStore.test_move_N_cycle">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestParentStore.test_move_N_cycle">[docs]</a>
    <span class="k">def</span> <span class="nf">test_move_N_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Move multiple nodes to create a cycle. &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">UserError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">})</span></div>


<div class="viewcode-block" id="TestParentStore.test_compute_depend_parent_path">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestParentStore.test_compute_depend_parent_path">[docs]</a>
    <span class="k">def</span> <span class="nf">test_compute_depend_parent_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># change parent of node to have 2 parents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># change parent of node to root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># change grand-parent of nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># add a new node: one query to INSERT, one query to UPDATE parent_path</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">cat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cats</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cat</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TestRequiredMany2one">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestRequiredMany2one">[docs]</a>
<span class="k">class</span> <span class="nc">TestRequiredMany2one</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">TransactionCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestRequiredMany2one.test_explicit_ondelete">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestRequiredMany2one.test_explicit_ondelete">[docs]</a>
    <span class="k">def</span> <span class="nf">test_explicit_ondelete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.req_m2o&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">ondelete</span><span class="p">,</span> <span class="s1">&#39;cascade&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestRequiredMany2one.test_implicit_ondelete">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestRequiredMany2one.test_implicit_ondelete">[docs]</a>
    <span class="k">def</span> <span class="nf">test_implicit_ondelete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.req_m2o&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;bar&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">ondelete</span><span class="p">,</span> <span class="s1">&#39;restrict&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestRequiredMany2one.test_explicit_set_null">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestRequiredMany2one.test_explicit_set_null">[docs]</a>
    <span class="k">def</span> <span class="nf">test_explicit_set_null</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.req_m2o&#39;</span><span class="p">]</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">]</span>

        <span class="c1"># clean up registry after this test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">reset_changes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;ondelete&#39;</span><span class="p">,</span> <span class="s1">&#39;set null&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">field</span><span class="o">.</span><span class="n">setup_nonrelated</span><span class="p">(</span><span class="n">Model</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TestRequiredMany2oneTransient">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestRequiredMany2oneTransient">[docs]</a>
<span class="k">class</span> <span class="nc">TestRequiredMany2oneTransient</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">TransactionCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestRequiredMany2oneTransient.test_explicit_ondelete">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestRequiredMany2oneTransient.test_explicit_ondelete">[docs]</a>
    <span class="k">def</span> <span class="nf">test_explicit_ondelete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.req_m2o_transient&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">ondelete</span><span class="p">,</span> <span class="s1">&#39;restrict&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestRequiredMany2oneTransient.test_implicit_ondelete">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestRequiredMany2oneTransient.test_implicit_ondelete">[docs]</a>
    <span class="k">def</span> <span class="nf">test_implicit_ondelete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.req_m2o_transient&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;bar&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">ondelete</span><span class="p">,</span> <span class="s1">&#39;cascade&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestRequiredMany2oneTransient.test_explicit_set_null">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestRequiredMany2oneTransient.test_explicit_set_null">[docs]</a>
    <span class="k">def</span> <span class="nf">test_explicit_set_null</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.req_m2o_transient&#39;</span><span class="p">]</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">]</span>

        <span class="c1"># clean up registry after this test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">reset_changes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;ondelete&#39;</span><span class="p">,</span> <span class="s1">&#39;set null&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">field</span><span class="o">.</span><span class="n">setup_nonrelated</span><span class="p">(</span><span class="n">Model</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TestMany2oneReference">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestMany2oneReference">[docs]</a>
<span class="nd">@common</span><span class="o">.</span><span class="n">tagged</span><span class="p">(</span><span class="s1">&#39;m2oref&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestMany2oneReference</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">TransactionCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestMany2oneReference.test_delete_m2o_reference_records">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestMany2oneReference.test_delete_m2o_reference_records">[docs]</a>
    <span class="k">def</span> <span class="nf">test_delete_m2o_reference_records</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_many2one_reference&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT max(id) FROM test_new_api_model_many2one_reference&quot;</span><span class="p">)</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="c1"># fake record to emulate the unlink of a non-existant record</span>
        <span class="n">foo</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">unlink</span><span class="p">())</span></div>


<div class="viewcode-block" id="TestMany2oneReference.test_search_inverse_one2many_autojoin">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestMany2oneReference.test_search_inverse_one2many_autojoin">[docs]</a>
    <span class="k">def</span> <span class="nf">test_search_inverse_one2many_autojoin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.inverse_m2o_ref&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>

        <span class="c1"># the one2many field &#39;model_ids&#39; should be auto_join=True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">record</span><span class="p">)</span><span class="o">.</span><span class="n">model_ids</span><span class="p">,</span> <span class="s1">&#39;auto_join&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># create a reference to record</span>
        <span class="n">reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_many2one_reference&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;res_id&#39;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="n">reference</span><span class="o">.</span><span class="n">res_model</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">_name</span>

        <span class="c1"># the model field &#39;res_model&#39; is not in database yet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">has_dirty_fields</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span><span class="o">.</span><span class="n">res_model</span><span class="p">]))</span>

        <span class="c1"># searching on the one2many should flush the field &#39;res_model&#39;</span>
        <span class="n">records</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;model_ids.create_date&#39;</span><span class="p">,</span> <span class="s1">&#39;!=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">records</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TestSelectionDeleteUpdate">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionDeleteUpdate">[docs]</a>
<span class="nd">@common</span><span class="o">.</span><span class="n">tagged</span><span class="p">(</span><span class="s1">&#39;selection_abstract&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestSelectionDeleteUpdate</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">TransactionCase</span><span class="p">):</span>

    <span class="n">MODEL_ABSTRACT</span> <span class="o">=</span> <span class="s1">&#39;test_new_api.state_mixin&#39;</span>

<div class="viewcode-block" id="TestSelectionDeleteUpdate.setUp">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionDeleteUpdate.setUp">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="c1"># enable unlinking ir.model.fields.selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">,</span> <span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestSelectionDeleteUpdate.test_unlink_asbtract">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionDeleteUpdate.test_unlink_asbtract">[docs]</a>
    <span class="k">def</span> <span class="nf">test_unlink_asbtract</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.fields.selection&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;field_id.model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MODEL_ABSTRACT</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;field_id.name&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;confirmed&#39;</span><span class="p">),</span>
        <span class="p">],</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="TestSelectionUpdates">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionUpdates">[docs]</a>
<span class="nd">@common</span><span class="o">.</span><span class="n">tagged</span><span class="p">(</span><span class="s1">&#39;selection_update_base&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestSelectionUpdates</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">TransactionCase</span><span class="p">):</span>
    <span class="n">MODEL_BASE</span> <span class="o">=</span> <span class="s1">&#39;test_new_api.model_selection_base&#39;</span>
    <span class="n">MODEL_RELATED</span> <span class="o">=</span> <span class="s1">&#39;test_new_api.model_selection_related&#39;</span>
    <span class="n">MODEL_RELATED_UPDATE</span> <span class="o">=</span> <span class="s1">&#39;test_new_api.model_selection_related_updatable&#39;</span>

<div class="viewcode-block" id="TestSelectionUpdates.setUpClass">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionUpdates.setUpClass">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUpClass</span><span class="p">()</span>
        <span class="c1"># Specifying a lang in env/context should not increase query counts</span>
        <span class="c1"># of CRUD operations</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;lang&#39;</span><span class="p">:</span> <span class="s1">&#39;en-US&#39;</span><span class="p">})</span></div>


<div class="viewcode-block" id="TestSelectionUpdates.test_selection">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionUpdates.test_selection">[docs]</a>
    <span class="k">def</span> <span class="nf">test_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_BASE</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>   <span class="c1"># warming up</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_BASE</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_BASE</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">})</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">record</span><span class="o">.</span><span class="n">my_selection</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span></div>


<div class="viewcode-block" id="TestSelectionUpdates.test_selection_related_readonly">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionUpdates.test_selection_related_readonly">[docs]</a>
    <span class="k">def</span> <span class="nf">test_selection_related_readonly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">related_record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_BASE</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">})</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>  <span class="c1"># defaults (readonly related field), INSERT</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_RELATED</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="n">related_record</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">record</span><span class="o">.</span><span class="n">related_selection</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span></div>


<div class="viewcode-block" id="TestSelectionUpdates.test_selection_related">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionUpdates.test_selection_related">[docs]</a>
    <span class="k">def</span> <span class="nf">test_selection_related</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">related_record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_BASE</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">})</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>  <span class="c1"># defaults (related field), INSERT</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_RELATED_UPDATE</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;selection_id&#39;</span><span class="p">:</span> <span class="n">related_record</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">record</span><span class="o">.</span><span class="n">related_selection</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span></div>
</div>



<div class="viewcode-block" id="TestSelectionOndelete">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionOndelete">[docs]</a>
<span class="nd">@common</span><span class="o">.</span><span class="n">tagged</span><span class="p">(</span><span class="s1">&#39;selection_ondelete_base&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestSelectionOndelete</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">TransactionCase</span><span class="p">):</span>

    <span class="n">MODEL_BASE</span> <span class="o">=</span> <span class="s1">&#39;test_new_api.model_selection_base&#39;</span>
    <span class="n">MODEL_REQUIRED</span> <span class="o">=</span> <span class="s1">&#39;test_new_api.model_selection_required&#39;</span>
    <span class="n">MODEL_NONSTORED</span> <span class="o">=</span> <span class="s1">&#39;test_new_api.model_selection_non_stored&#39;</span>
    <span class="n">MODEL_WRITE_OVERRIDE</span> <span class="o">=</span> <span class="s1">&#39;test_new_api.model_selection_required_for_write_override&#39;</span>

<div class="viewcode-block" id="TestSelectionOndelete.setUp">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionOndelete.setUp">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="c1"># enable unlinking ir.model.fields.selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">,</span> <span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_unlink_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.fields.selection&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;field_id.model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">model</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;field_id.name&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;my_selection&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">option</span><span class="p">),</span>
        <span class="p">],</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

<div class="viewcode-block" id="TestSelectionOndelete.test_ondelete_default">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionOndelete.test_ondelete_default">[docs]</a>
    <span class="k">def</span> <span class="nf">test_ondelete_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># create some records, one of which having the extended selection option</span>
        <span class="n">rec1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">})</span>
        <span class="n">rec2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span>
        <span class="n">rec3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">})</span>

        <span class="c1"># test that all values are correct before the removal of the value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec1</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec2</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec3</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">)</span>

        <span class="c1"># unlink the extended option (simulates a module uninstall)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unlink_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">)</span>

        <span class="c1"># verify that the ondelete policy has succesfully been applied</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec1</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec2</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec3</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>   <span class="c1"># reset to default</span></div>


<div class="viewcode-block" id="TestSelectionOndelete.test_ondelete_base_null_explicit">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionOndelete.test_ondelete_base_null_explicit">[docs]</a>
    <span class="k">def</span> <span class="nf">test_ondelete_base_null_explicit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rec1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_BASE</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">})</span>
        <span class="n">rec2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_BASE</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span>
        <span class="n">rec3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_BASE</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;quux&#39;</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec1</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec2</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec3</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;quux&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_unlink_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_BASE</span><span class="p">,</span> <span class="s1">&#39;quux&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec1</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec2</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">rec3</span><span class="o">.</span><span class="n">my_selection</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestSelectionOndelete.test_ondelete_base_null_implicit">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionOndelete.test_ondelete_base_null_implicit">[docs]</a>
    <span class="k">def</span> <span class="nf">test_ondelete_base_null_implicit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rec1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_BASE</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">})</span>
        <span class="n">rec2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_BASE</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span>
        <span class="n">rec3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_BASE</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;ham&#39;</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec1</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec2</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec3</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;ham&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_unlink_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_BASE</span><span class="p">,</span> <span class="s1">&#39;ham&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec1</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec2</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">rec3</span><span class="o">.</span><span class="n">my_selection</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestSelectionOndelete.test_ondelete_cascade">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionOndelete.test_ondelete_cascade">[docs]</a>
    <span class="k">def</span> <span class="nf">test_ondelete_cascade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rec1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">})</span>
        <span class="n">rec2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span>
        <span class="n">rec3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;eggs&#39;</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec1</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec2</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec3</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;eggs&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_unlink_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span><span class="p">,</span> <span class="s1">&#39;eggs&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec1</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec2</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">rec3</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span></div>


<div class="viewcode-block" id="TestSelectionOndelete.test_ondelete_literal">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionOndelete.test_ondelete_literal">[docs]</a>
    <span class="k">def</span> <span class="nf">test_ondelete_literal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rec1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">})</span>
        <span class="n">rec2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span>
        <span class="n">rec3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;bacon&#39;</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec1</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec2</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec3</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;bacon&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_unlink_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span><span class="p">,</span> <span class="s1">&#39;bacon&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec1</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec2</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec3</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestSelectionOndelete.test_ondelete_multiple_explicit">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionOndelete.test_ondelete_multiple_explicit">[docs]</a>
    <span class="k">def</span> <span class="nf">test_ondelete_multiple_explicit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rec1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">})</span>
        <span class="n">rec2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;eevee&#39;</span><span class="p">})</span>
        <span class="n">rec3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;pikachu&#39;</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec1</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec2</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;eevee&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec3</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;pikachu&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_unlink_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span><span class="p">,</span> <span class="s1">&#39;eevee&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unlink_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span><span class="p">,</span> <span class="s1">&#39;pikachu&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec1</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec2</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec3</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestSelectionOndelete.test_ondelete_callback">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionOndelete.test_ondelete_callback">[docs]</a>
    <span class="k">def</span> <span class="nf">test_ondelete_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;knickers&#39;</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;knickers&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_unlink_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span><span class="p">,</span> <span class="s1">&#39;knickers&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">active</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestSelectionOndelete.test_non_stored_selection">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionOndelete.test_non_stored_selection">[docs]</a>
    <span class="k">def</span> <span class="nf">test_non_stored_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_NONSTORED</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">rec</span><span class="o">.</span><span class="n">my_selection</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_unlink_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_NONSTORED</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">my_selection</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestSelectionOndelete.test_required_base_selection_field">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionOndelete.test_required_base_selection_field">[docs]</a>
    <span class="k">def</span> <span class="nf">test_required_base_selection_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># test that no ondelete action is executed on a required selection field that is not</span>
        <span class="c1"># extended, only required fields that extend it with selection_add should</span>
        <span class="c1"># have ondelete actions defined</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_unlink_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestSelectionOndelete.test_write_override_selection">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionOndelete.test_write_override_selection">[docs]</a>
    <span class="nd">@mute_logger</span><span class="p">(</span><span class="s1">&#39;odoo.addons.base.models.ir_model&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_write_override_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># test that on override to write that raises an error does not prevent the ondelete</span>
        <span class="c1"># policy from executing and cleaning up what needs to be cleaned up</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_WRITE_OVERRIDE</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;my_selection&#39;</span><span class="p">:</span> <span class="s1">&#39;divinity&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;divinity&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_unlink_option</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_WRITE_OVERRIDE</span><span class="p">,</span> <span class="s1">&#39;divinity&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">my_selection</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TestSelectionOndeleteAdvanced">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionOndeleteAdvanced">[docs]</a>
<span class="nd">@common</span><span class="o">.</span><span class="n">tagged</span><span class="p">(</span><span class="s1">&#39;selection_ondelete_advanced&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestSelectionOndeleteAdvanced</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">TransactionCase</span><span class="p">):</span>

    <span class="n">MODEL_BASE</span> <span class="o">=</span> <span class="s1">&#39;test_new_api.model_selection_base&#39;</span>
    <span class="n">MODEL_REQUIRED</span> <span class="o">=</span> <span class="s1">&#39;test_new_api.model_selection_required&#39;</span>

<div class="viewcode-block" id="TestSelectionOndeleteAdvanced.setUp">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionOndeleteAdvanced.setUp">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="c1"># necessary cleanup for resetting changes in the registry</span>
        <span class="k">for</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MODEL_BASE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span><span class="p">):</span>
            <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="nb">setattr</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="s1">&#39;_BaseModel__base_classes&#39;</span><span class="p">,</span> <span class="n">Model</span><span class="o">.</span><span class="n">_BaseModel__base_classes</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestSelectionOndeleteAdvanced.test_ondelete_unexisting_policy">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionOndeleteAdvanced.test_ondelete_unexisting_policy">[docs]</a>
    <span class="k">def</span> <span class="nf">test_ondelete_unexisting_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="n">_module</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">_inherit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span>

            <span class="n">my_selection</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Selection</span><span class="p">(</span><span class="n">selection_add</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;random&#39;</span><span class="p">,</span> <span class="s2">&quot;Random stuff&quot;</span><span class="p">),</span>
            <span class="p">],</span> <span class="n">ondelete</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;random&#39;</span><span class="p">:</span> <span class="s1">&#39;poop&#39;</span><span class="p">})</span>

        <span class="n">Foo</span><span class="o">.</span><span class="n">_build_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestSelectionOndeleteAdvanced.test_ondelete_default_no_default">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionOndeleteAdvanced.test_ondelete_default_no_default">[docs]</a>
    <span class="k">def</span> <span class="nf">test_ondelete_default_no_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="n">_module</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">_inherit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MODEL_BASE</span>

            <span class="n">my_selection</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Selection</span><span class="p">(</span><span class="n">selection_add</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;corona&#39;</span><span class="p">,</span> <span class="s2">&quot;Corona beers suck&quot;</span><span class="p">),</span>
            <span class="p">],</span> <span class="n">ondelete</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;corona&#39;</span><span class="p">:</span> <span class="s1">&#39;set default&#39;</span><span class="p">})</span>

        <span class="n">Foo</span><span class="o">.</span><span class="n">_build_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestSelectionOndeleteAdvanced.test_ondelete_value_no_valid">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionOndeleteAdvanced.test_ondelete_value_no_valid">[docs]</a>
    <span class="k">def</span> <span class="nf">test_ondelete_value_no_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="n">_module</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">_inherit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MODEL_BASE</span>

            <span class="n">my_selection</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Selection</span><span class="p">(</span><span class="n">selection_add</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;westvleteren&#39;</span><span class="p">,</span> <span class="s2">&quot;Westvleteren beers is overrated&quot;</span><span class="p">),</span>
            <span class="p">],</span> <span class="n">ondelete</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;westvleteren&#39;</span><span class="p">:</span> <span class="s1">&#39;set foooo&#39;</span><span class="p">})</span>

        <span class="n">Foo</span><span class="o">.</span><span class="n">_build_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestSelectionOndeleteAdvanced.test_ondelete_required_null_explicit">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionOndeleteAdvanced.test_ondelete_required_null_explicit">[docs]</a>
    <span class="k">def</span> <span class="nf">test_ondelete_required_null_explicit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="n">_module</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">_inherit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span>

            <span class="n">my_selection</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Selection</span><span class="p">(</span><span class="n">selection_add</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;brap&#39;</span><span class="p">,</span> <span class="s2">&quot;Brap&quot;</span><span class="p">),</span>
            <span class="p">],</span> <span class="n">ondelete</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;brap&#39;</span><span class="p">:</span> <span class="s1">&#39;set null&#39;</span><span class="p">})</span>

        <span class="n">Foo</span><span class="o">.</span><span class="n">_build_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestSelectionOndeleteAdvanced.test_ondelete_required_null_implicit">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSelectionOndeleteAdvanced.test_ondelete_required_null_implicit">[docs]</a>
    <span class="k">def</span> <span class="nf">test_ondelete_required_null_implicit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="n">_module</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">_inherit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MODEL_REQUIRED</span>

            <span class="n">my_selection</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Selection</span><span class="p">(</span><span class="n">selection_add</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;boing&#39;</span><span class="p">,</span> <span class="s2">&quot;Boyoyoyoing&quot;</span><span class="p">),</span>
            <span class="p">])</span>

        <span class="n">Foo</span><span class="o">.</span><span class="n">_build_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TestFieldParametersValidation">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFieldParametersValidation">[docs]</a>
<span class="k">class</span> <span class="nc">TestFieldParametersValidation</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">TransactionCase</span><span class="p">):</span>
<div class="viewcode-block" id="TestFieldParametersValidation.test_invalid_parameter">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestFieldParametersValidation.test_invalid_parameter">[docs]</a>
    <span class="k">def</span> <span class="nf">test_invalid_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="n">_module</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">_name</span> <span class="o">=</span> <span class="n">_description</span> <span class="o">=</span> <span class="s1">&#39;test_new_api.field_parameter_validation&#39;</span>

            <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">invalid_parameter</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

        <span class="n">Foo</span><span class="o">.</span><span class="n">_build_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="fm">__delitem__</span><span class="p">,</span> <span class="n">Foo</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertLogs</span><span class="p">(</span><span class="s1">&#39;odoo.fields&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;WARNING&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
            <span class="s2">&quot;WARNING:odoo.fields:Field test_new_api.field_parameter_validation.name: &quot;</span>
            <span class="s2">&quot;unknown parameter &#39;invalid_parameter&#39;&quot;</span>
        <span class="p">))</span></div>
</div>



<div class="viewcode-block" id="select">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.select">[docs]</a>
<span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">fnames</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return the expected query string to SELECT the given columns. &quot;&quot;&quot;</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_table</span>
    <span class="n">terms</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s1">&quot;.&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;SELECT </span><span class="si">{</span><span class="n">terms</span><span class="si">}</span><span class="s1"> FROM &quot;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s1">&quot; WHERE (&quot;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s1">&quot;.&quot;id&quot; IN %s)&#39;</span></div>



<div class="viewcode-block" id="insert">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.insert">[docs]</a>
<span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">fnames</span><span class="p">,</span> <span class="n">rowcount</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return the expected query string to INSERT the given columns. &quot;&quot;&quot;</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fnames</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;create_uid&#39;</span><span class="p">,</span> <span class="s1">&#39;create_date&#39;</span><span class="p">,</span> <span class="s1">&#39;write_uid&#39;</span><span class="p">,</span> <span class="s1">&#39;write_date&#39;</span><span class="p">))</span>
    <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">)</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rowcount</span><span class="p">))</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;INSERT INTO &quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">_table</span><span class="si">}</span><span class="s1">&quot; (</span><span class="si">{</span><span class="n">header</span><span class="si">}</span><span class="s1">) VALUES </span><span class="si">{</span><span class="n">template</span><span class="si">}</span><span class="s1"> RETURNING &quot;id&quot;&#39;</span></div>



<div class="viewcode-block" id="update">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.update">[docs]</a>
<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">fnames</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return the expected query string to UPDATE the given columns. &quot;&quot;&quot;</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fnames</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;write_uid&#39;</span><span class="p">,</span> <span class="s1">&#39;write_date&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39;UPDATE &quot;</span><span class="si">{}</span><span class="s1">&quot; SET </span><span class="si">{}</span><span class="s1"> WHERE id IN </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span>
        <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot; = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">),</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="TestSubqueries">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSubqueries">[docs]</a>
<span class="k">class</span> <span class="nc">TestSubqueries</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">TransactionCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Test the subqueries made by search() with relational fields. &quot;&quot;&quot;</span>
    <span class="n">maxDiff</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="TestSubqueries.test_and_many2one_with_subfield">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSubqueries.test_and_many2one_with_subfield">[docs]</a>
    <span class="k">def</span> <span class="nf">test_and_many2one_with_subfield</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">            FROM &quot;test_new_api_multi&quot;</span>
<span class="s2">            WHERE (&quot;test_new_api_multi&quot;.&quot;partner&quot; IN (</span>
<span class="s2">                SELECT &quot;res_partner&quot;.&quot;id&quot;</span>
<span class="s2">                FROM &quot;res_partner&quot;</span>
<span class="s2">                WHERE ((&quot;res_partner&quot;.&quot;name&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                   AND (&quot;res_partner&quot;.&quot;phone&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                )</span>
<span class="s2">            ))</span>
<span class="s2">            ORDER BY &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
                <span class="p">(</span><span class="s1">&#39;partner.name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;jack&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;partner.phone&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;01234&#39;</span><span class="p">),</span>
            <span class="p">])</span></div>


<div class="viewcode-block" id="TestSubqueries.test_or_many2one_with_subfield">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSubqueries.test_or_many2one_with_subfield">[docs]</a>
    <span class="k">def</span> <span class="nf">test_or_many2one_with_subfield</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">            FROM &quot;test_new_api_multi&quot;</span>
<span class="s2">            WHERE (&quot;test_new_api_multi&quot;.&quot;partner&quot; IN (</span>
<span class="s2">                SELECT &quot;res_partner&quot;.&quot;id&quot;</span>
<span class="s2">                FROM &quot;res_partner&quot;</span>
<span class="s2">                WHERE ((&quot;res_partner&quot;.&quot;name&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                    OR (&quot;res_partner&quot;.&quot;phone&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                )</span>
<span class="s2">            ))</span>
<span class="s2">            ORDER BY &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
                <span class="s1">&#39;|&#39;</span><span class="p">,</span>
                    <span class="p">(</span><span class="s1">&#39;partner.name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;jack&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;partner.phone&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;01234&#39;</span><span class="p">),</span>
            <span class="p">])</span></div>


<div class="viewcode-block" id="TestSubqueries.test_not_and_many2one_with_subfield">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSubqueries.test_not_and_many2one_with_subfield">[docs]</a>
    <span class="k">def</span> <span class="nf">test_not_and_many2one_with_subfield</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">            FROM &quot;test_new_api_multi&quot;</span>
<span class="s2">            WHERE ((&quot;test_new_api_multi&quot;.&quot;partner&quot; NOT IN (</span>
<span class="s2">                SELECT &quot;res_partner&quot;.&quot;id&quot;</span>
<span class="s2">                FROM &quot;res_partner&quot;</span>
<span class="s2">                WHERE ((&quot;res_partner&quot;.&quot;name&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                    AND (&quot;res_partner&quot;.&quot;phone&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                )</span>
<span class="s2">            )) OR &quot;test_new_api_multi&quot;.&quot;partner&quot; IS NULL)</span>
<span class="s2">            ORDER BY &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
                <span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">,</span>
                    <span class="p">(</span><span class="s1">&#39;partner.name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;jack&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;partner.phone&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;01234&#39;</span><span class="p">),</span>
            <span class="p">])</span></div>


<div class="viewcode-block" id="TestSubqueries.test_not_or_many2one_with_subfield">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSubqueries.test_not_or_many2one_with_subfield">[docs]</a>
    <span class="k">def</span> <span class="nf">test_not_or_many2one_with_subfield</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">            FROM &quot;test_new_api_multi&quot;</span>
<span class="s2">            WHERE ((&quot;test_new_api_multi&quot;.&quot;partner&quot; NOT IN (</span>
<span class="s2">                SELECT &quot;res_partner&quot;.&quot;id&quot;</span>
<span class="s2">                FROM &quot;res_partner&quot;</span>
<span class="s2">                WHERE ((&quot;res_partner&quot;.&quot;name&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                    OR (&quot;res_partner&quot;.&quot;phone&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                )</span>
<span class="s2">            )) OR &quot;test_new_api_multi&quot;.&quot;partner&quot; IS NULL)</span>
<span class="s2">            ORDER BY &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
                <span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span>
                    <span class="p">(</span><span class="s1">&#39;partner.name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;jack&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;partner.phone&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;01234&#39;</span><span class="p">),</span>
            <span class="p">])</span></div>


<div class="viewcode-block" id="TestSubqueries.test_or_autojoined_many2one_with_subfield">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSubqueries.test_or_autojoined_many2one_with_subfield">[docs]</a>
    <span class="k">def</span> <span class="nf">test_or_autojoined_many2one_with_subfield</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;partner&#39;</span><span class="p">],</span> <span class="s1">&#39;auto_join&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">            FROM &quot;test_new_api_multi&quot;</span>
<span class="s2">            LEFT JOIN &quot;res_partner&quot; AS &quot;test_new_api_multi__partner&quot;</span>
<span class="s2">                ON (&quot;test_new_api_multi&quot;.&quot;partner&quot; = &quot;test_new_api_multi__partner&quot;.&quot;id&quot;)</span>
<span class="s2">            WHERE (</span>
<span class="s2">                (&quot;test_new_api_multi__partner&quot;.&quot;name&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                OR (&quot;test_new_api_multi__partner&quot;.&quot;phone&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">            )</span>
<span class="s2">            ORDER BY &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
                <span class="s1">&#39;|&#39;</span><span class="p">,</span>
                    <span class="p">(</span><span class="s1">&#39;partner.name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;jack&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;partner.phone&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;01234&#39;</span><span class="p">),</span>
            <span class="p">])</span></div>


<div class="viewcode-block" id="TestSubqueries.test_not_or_autojoined_many2one_with_subfield">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSubqueries.test_not_or_autojoined_many2one_with_subfield">[docs]</a>
    <span class="k">def</span> <span class="nf">test_not_or_autojoined_many2one_with_subfield</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;partner&#39;</span><span class="p">],</span> <span class="s1">&#39;auto_join&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">            FROM &quot;test_new_api_multi&quot;</span>
<span class="s2">            LEFT JOIN &quot;res_partner&quot; AS &quot;test_new_api_multi__partner&quot;</span>
<span class="s2">                ON (&quot;test_new_api_multi&quot;.&quot;partner&quot; = &quot;test_new_api_multi__partner&quot;.&quot;id&quot;)</span>
<span class="s2">            WHERE (</span>
<span class="s2">                &quot;test_new_api_multi__partner&quot;.&quot;id&quot; IS NULL OR (</span>
<span class="s2">                    NOT ((</span>
<span class="s2">                        (&quot;test_new_api_multi__partner&quot;.&quot;name&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                        OR (&quot;test_new_api_multi__partner&quot;.&quot;phone&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                    ))</span>
<span class="s2">                )</span>
<span class="s2">            )</span>
<span class="s2">            ORDER BY &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
                <span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">,</span>
                    <span class="p">(</span><span class="s1">&#39;partner.name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;jack&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;partner.phone&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;01234&#39;</span><span class="p">),</span>
            <span class="p">])</span></div>


<div class="viewcode-block" id="TestSubqueries.test_mixed_and_or_many2one_with_subfield">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSubqueries.test_mixed_and_or_many2one_with_subfield">[docs]</a>
    <span class="k">def</span> <span class="nf">test_mixed_and_or_many2one_with_subfield</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">            FROM &quot;test_new_api_multi&quot;</span>
<span class="s2">            WHERE (&quot;test_new_api_multi&quot;.&quot;partner&quot; IN (</span>
<span class="s2">                SELECT &quot;res_partner&quot;.&quot;id&quot;</span>
<span class="s2">                FROM &quot;res_partner&quot;</span>
<span class="s2">                WHERE (</span>
<span class="s2">                    (&quot;res_partner&quot;.&quot;email&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                    AND ((&quot;res_partner&quot;.&quot;name&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                      OR (&quot;res_partner&quot;.&quot;phone&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                    )</span>
<span class="s2">                )</span>
<span class="s2">            ))</span>
<span class="s2">            ORDER BY &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
                <span class="p">(</span><span class="s1">&#39;partner.email&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;@sgc.us&#39;</span><span class="p">),</span>
                <span class="s1">&#39;|&#39;</span><span class="p">,</span>
                    <span class="p">(</span><span class="s1">&#39;partner.name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;jack&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;partner.phone&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;01234&#39;</span><span class="p">),</span>
            <span class="p">])</span></div>


<div class="viewcode-block" id="TestSubqueries.test_mixed_and_or_not_many2one_with_subfield">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSubqueries.test_mixed_and_or_not_many2one_with_subfield">[docs]</a>
    <span class="k">def</span> <span class="nf">test_mixed_and_or_not_many2one_with_subfield</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">            FROM &quot;test_new_api_multi&quot;</span>
<span class="s2">            WHERE (</span>
<span class="s2">                (</span>
<span class="s2">                    (</span>
<span class="s2">                        (</span><span class="si">{many2one}</span><span class="s2"> IN (</span>
<span class="s2">                            </span><span class="si">{subselect}</span><span class="s2"> WHERE (&quot;res_partner&quot;.&quot;function&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                        )) OR ((</span><span class="si">{many2one}</span><span class="s2"> NOT IN (</span>
<span class="s2">                            </span><span class="si">{subselect}</span><span class="s2"> WHERE (</span>
<span class="s2">                                (&quot;res_partner&quot;.&quot;phone&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                                AND (&quot;res_partner&quot;.&quot;mobile&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                            )))</span>
<span class="s2">                            OR &quot;test_new_api_multi&quot;.&quot;partner&quot; IS NULL</span>
<span class="s2">                        )</span>
<span class="s2">                    ) AND (</span><span class="si">{many2one}</span><span class="s2"> IN (</span>
<span class="s2">                        </span><span class="si">{subselect}</span><span class="s2"> WHERE (</span>
<span class="s2">                            (&quot;res_partner&quot;.&quot;name&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                            OR (&quot;res_partner&quot;.&quot;email&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                        )</span>
<span class="s2">                    ))</span>
<span class="s2">                ) AND ((</span><span class="si">{many2one}</span><span class="s2"> NOT IN (</span>
<span class="s2">                    </span><span class="si">{subselect}</span><span class="s2"> WHERE (&quot;res_partner&quot;.&quot;website&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                    ))</span>
<span class="s2">                    OR &quot;test_new_api_multi&quot;.&quot;partner&quot; IS NULL</span>
<span class="s2">                )</span>
<span class="s2">            )</span>
<span class="s2">            ORDER BY &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">many2one</span><span class="o">=</span><span class="s1">&#39;&quot;test_new_api_multi&quot;.&quot;partner&quot;&#39;</span><span class="p">,</span>
            <span class="n">subselect</span><span class="o">=</span><span class="s1">&#39;SELECT &quot;res_partner&quot;.&quot;id&quot; FROM &quot;res_partner&quot;&#39;</span><span class="p">,</span>
        <span class="p">)]):</span>
            <span class="c1"># (function or not (phone and mobile)) and not website and (name or email)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
                <span class="s1">&#39;&amp;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;|&#39;</span><span class="p">,</span>
                        <span class="p">(</span><span class="s1">&#39;partner.function&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;Colonel&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">,</span>
                            <span class="p">(</span><span class="s1">&#39;partner.phone&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;+01&#39;</span><span class="p">),</span>
                            <span class="p">(</span><span class="s1">&#39;partner.mobile&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;+01&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;partner.website&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;sgc.us&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;|&#39;</span><span class="p">,</span>
                        <span class="p">(</span><span class="s1">&#39;partner.name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;jack&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s1">&#39;partner.email&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;@sgc.us&#39;</span><span class="p">),</span>
            <span class="p">])</span></div>


<div class="viewcode-block" id="TestSubqueries.test_and_one2many_with_subfield">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSubqueries.test_and_one2many_with_subfield">[docs]</a>
    <span class="k">def</span> <span class="nf">test_and_one2many_with_subfield</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">            FROM &quot;test_new_api_multi&quot;</span>
<span class="s2">            WHERE ((&quot;test_new_api_multi&quot;.&quot;id&quot; IN (</span>
<span class="s2">                SELECT &quot;test_new_api_multi_line&quot;.&quot;multi&quot;</span>
<span class="s2">                FROM &quot;test_new_api_multi_line&quot;</span>
<span class="s2">                WHERE (&quot;test_new_api_multi_line&quot;.&quot;name&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                      AND &quot;test_new_api_multi_line&quot;.&quot;multi&quot; IS NOT NULL</span>
<span class="s2">            )) AND (&quot;test_new_api_multi&quot;.&quot;id&quot; IN (</span>
<span class="s2">                SELECT &quot;test_new_api_multi_line&quot;.&quot;multi&quot;</span>
<span class="s2">                FROM &quot;test_new_api_multi_line&quot;</span>
<span class="s2">                WHERE (&quot;test_new_api_multi_line&quot;.&quot;name&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                      AND &quot;test_new_api_multi_line&quot;.&quot;multi&quot; IS NOT NULL</span>
<span class="s2">            )))</span>
<span class="s2">            ORDER BY &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
                <span class="p">(</span><span class="s1">&#39;lines.name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;lines.name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">),</span>
            <span class="p">])</span></div>


<div class="viewcode-block" id="TestSubqueries.test_or_one2many_with_subfield">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSubqueries.test_or_one2many_with_subfield">[docs]</a>
    <span class="k">def</span> <span class="nf">test_or_one2many_with_subfield</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">            FROM &quot;test_new_api_multi&quot;</span>
<span class="s2">            WHERE (&quot;test_new_api_multi&quot;.&quot;id&quot; IN (</span>
<span class="s2">                SELECT &quot;test_new_api_multi_line&quot;.&quot;multi&quot;</span>
<span class="s2">                FROM &quot;test_new_api_multi_line&quot;</span>
<span class="s2">                WHERE ((&quot;test_new_api_multi_line&quot;.&quot;name&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                    OR (&quot;test_new_api_multi_line&quot;.&quot;name&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                ) AND &quot;test_new_api_multi_line&quot;.&quot;multi&quot; IS NOT NULL</span>
<span class="s2">            ))</span>
<span class="s2">            ORDER BY &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
                <span class="s1">&#39;|&#39;</span><span class="p">,</span>
                    <span class="p">(</span><span class="s1">&#39;lines.name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;lines.name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">),</span>
            <span class="p">])</span></div>


<div class="viewcode-block" id="TestSubqueries.test_mixed_and_or_one2many_with_subfield">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSubqueries.test_mixed_and_or_one2many_with_subfield">[docs]</a>
    <span class="k">def</span> <span class="nf">test_mixed_and_or_one2many_with_subfield</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">            FROM &quot;test_new_api_multi&quot;</span>
<span class="s2">            WHERE ((&quot;test_new_api_multi&quot;.&quot;id&quot; IN (</span>
<span class="s2">                SELECT &quot;test_new_api_multi_line&quot;.&quot;multi&quot;</span>
<span class="s2">                FROM &quot;test_new_api_multi_line&quot;</span>
<span class="s2">                WHERE (&quot;test_new_api_multi_line&quot;.&quot;name&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                   AND &quot;test_new_api_multi_line&quot;.&quot;multi&quot; IS NOT NULL)</span>
<span class="s2">            ) AND (&quot;test_new_api_multi&quot;.&quot;id&quot; IN (</span>
<span class="s2">                SELECT &quot;test_new_api_multi_line&quot;.&quot;multi&quot;</span>
<span class="s2">                FROM &quot;test_new_api_multi_line&quot;</span>
<span class="s2">                WHERE ((&quot;test_new_api_multi_line&quot;.&quot;name&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                    OR (&quot;test_new_api_multi_line&quot;.&quot;name&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                ) AND &quot;test_new_api_multi_line&quot;.&quot;multi&quot; IS NOT NULL</span>
<span class="s2">            )))</span>
<span class="s2">            ORDER BY &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
                <span class="p">(</span><span class="s1">&#39;lines.name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">),</span>
                <span class="s1">&#39;|&#39;</span><span class="p">,</span>
                    <span class="p">(</span><span class="s1">&#39;lines.name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;lines.name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">),</span>
            <span class="p">])</span></div>


<div class="viewcode-block" id="TestSubqueries.test_and_many2many_with_subfield">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSubqueries.test_and_many2many_with_subfield">[docs]</a>
    <span class="k">def</span> <span class="nf">test_and_many2many_with_subfield</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">            FROM &quot;test_new_api_multi&quot;</span>
<span class="s2">            WHERE (EXISTS (</span>
<span class="s2">                SELECT 1</span>
<span class="s2">                FROM &quot;test_new_api_multi_test_new_api_multi_tag_rel&quot; AS &quot;test_new_api_multi__tags&quot;</span>
<span class="s2">                WHERE &quot;test_new_api_multi__tags&quot;.&quot;test_new_api_multi_id&quot; = &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">                AND &quot;test_new_api_multi__tags&quot;.&quot;test_new_api_multi_tag_id&quot; IN (</span>
<span class="s2">                    SELECT &quot;test_new_api_multi_tag&quot;.&quot;id&quot;</span>
<span class="s2">                    FROM &quot;test_new_api_multi_tag&quot;</span>
<span class="s2">                    WHERE (&quot;test_new_api_multi_tag&quot;.&quot;name&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                )</span>
<span class="s2">            ) AND EXISTS (</span>
<span class="s2">                SELECT 1</span>
<span class="s2">                FROM &quot;test_new_api_multi_test_new_api_multi_tag_rel&quot; AS &quot;test_new_api_multi__tags&quot;</span>
<span class="s2">                WHERE &quot;test_new_api_multi__tags&quot;.&quot;test_new_api_multi_id&quot; = &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">                AND &quot;test_new_api_multi__tags&quot;.&quot;test_new_api_multi_tag_id&quot; IN (</span>
<span class="s2">                    SELECT &quot;test_new_api_multi_tag&quot;.&quot;id&quot;</span>
<span class="s2">                    FROM &quot;test_new_api_multi_tag&quot;</span>
<span class="s2">                    WHERE (&quot;test_new_api_multi_tag&quot;.&quot;name&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                )</span>
<span class="s2">            ))</span>
<span class="s2">            ORDER BY &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
                <span class="p">(</span><span class="s1">&#39;tags.name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;tags.name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">),</span>
            <span class="p">])</span></div>


<div class="viewcode-block" id="TestSubqueries.test_or_many2many_with_subfield">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSubqueries.test_or_many2many_with_subfield">[docs]</a>
    <span class="k">def</span> <span class="nf">test_or_many2many_with_subfield</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">            FROM &quot;test_new_api_multi&quot;</span>
<span class="s2">            WHERE EXISTS (</span>
<span class="s2">                SELECT 1</span>
<span class="s2">                FROM &quot;test_new_api_multi_test_new_api_multi_tag_rel&quot; AS &quot;test_new_api_multi__tags&quot;</span>
<span class="s2">                WHERE &quot;test_new_api_multi__tags&quot;.&quot;test_new_api_multi_id&quot; = &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">                AND &quot;test_new_api_multi__tags&quot;.&quot;test_new_api_multi_tag_id&quot; IN (</span>
<span class="s2">                    SELECT &quot;test_new_api_multi_tag&quot;.&quot;id&quot;</span>
<span class="s2">                    FROM &quot;test_new_api_multi_tag&quot;</span>
<span class="s2">                    WHERE ((&quot;test_new_api_multi_tag&quot;.&quot;name&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                        OR (&quot;test_new_api_multi_tag&quot;.&quot;name&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                    )</span>
<span class="s2">                )</span>
<span class="s2">            )</span>
<span class="s2">            ORDER BY &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
                <span class="s1">&#39;|&#39;</span><span class="p">,</span>
                    <span class="p">(</span><span class="s1">&#39;tags.name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;tags.name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">),</span>
            <span class="p">])</span></div>


<div class="viewcode-block" id="TestSubqueries.test_mixed_and_or_many2many_with_subfield">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestSubqueries.test_mixed_and_or_many2many_with_subfield">[docs]</a>
    <span class="k">def</span> <span class="nf">test_mixed_and_or_many2many_with_subfield</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">            FROM &quot;test_new_api_multi&quot;</span>
<span class="s2">            WHERE (</span>
<span class="s2">                EXISTS (</span>
<span class="s2">                    SELECT 1</span>
<span class="s2">                    FROM &quot;test_new_api_multi_test_new_api_multi_tag_rel&quot; AS &quot;test_new_api_multi__tags&quot;</span>
<span class="s2">                    WHERE &quot;test_new_api_multi__tags&quot;.&quot;test_new_api_multi_id&quot; = &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">                    AND &quot;test_new_api_multi__tags&quot;.&quot;test_new_api_multi_tag_id&quot; IN (</span>
<span class="s2">                        SELECT &quot;test_new_api_multi_tag&quot;.&quot;id&quot;</span>
<span class="s2">                        FROM &quot;test_new_api_multi_tag&quot;</span>
<span class="s2">                        WHERE (&quot;test_new_api_multi_tag&quot;.&quot;name&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                    )</span>
<span class="s2">                ) AND EXISTS (</span>
<span class="s2">                    SELECT 1</span>
<span class="s2">                    FROM &quot;test_new_api_multi_test_new_api_multi_tag_rel&quot; AS &quot;test_new_api_multi__tags&quot;</span>
<span class="s2">                    WHERE &quot;test_new_api_multi__tags&quot;.&quot;test_new_api_multi_id&quot; = &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">                    AND &quot;test_new_api_multi__tags&quot;.&quot;test_new_api_multi_tag_id&quot; IN (</span>
<span class="s2">                        SELECT &quot;test_new_api_multi_tag&quot;.&quot;id&quot;</span>
<span class="s2">                        FROM &quot;test_new_api_multi_tag&quot;</span>
<span class="s2">                        WHERE ((&quot;test_new_api_multi_tag&quot;.&quot;name&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                            OR (&quot;test_new_api_multi_tag&quot;.&quot;name&quot;::text LIKE </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">                        )</span>
<span class="s2">                    )</span>
<span class="s2">                )</span>
<span class="s2">            )</span>
<span class="s2">            ORDER BY &quot;test_new_api_multi&quot;.&quot;id&quot;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.multi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([</span>
                <span class="p">(</span><span class="s1">&#39;tags.name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">),</span>
                <span class="s1">&#39;|&#39;</span><span class="p">,</span>
                    <span class="p">(</span><span class="s1">&#39;tags.name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;tags.name&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">),</span>
            <span class="p">])</span></div>
</div>



<div class="viewcode-block" id="TestComputeQueries">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestComputeQueries">[docs]</a>
<span class="k">class</span> <span class="nc">TestComputeQueries</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">TransactionCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Test the queries made by create() with computed fields. &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestComputeQueries.test_compute_readonly">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestComputeQueries.test_compute_readonly">[docs]</a>
    <span class="k">def</span> <span class="nf">test_compute_readonly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.compute.readonly&#39;</span><span class="p">]</span>
        <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>

        <span class="c1"># no value, no default</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="n">insert</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">),</span> <span class="n">update</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)]):</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;Foo&#39;</span><span class="p">)</span>

        <span class="c1"># some value, no default</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="n">insert</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">),</span> <span class="n">update</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)]):</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;Bar&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;Foo&#39;</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">default_bar</span><span class="o">=</span><span class="s1">&#39;Def&#39;</span><span class="p">)</span>

        <span class="c1"># no value, some default</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="n">insert</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">),</span> <span class="n">update</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)]):</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;Foo&#39;</span><span class="p">)</span>

        <span class="c1"># some value, some default</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="n">insert</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">),</span> <span class="n">update</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)]):</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;Bar&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;Foo&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestComputeQueries.test_compute_readwrite">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestComputeQueries.test_compute_readwrite">[docs]</a>
    <span class="k">def</span> <span class="nf">test_compute_readwrite</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.compute.readwrite&#39;</span><span class="p">]</span>
        <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>

        <span class="c1"># no value, no default</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="n">insert</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">),</span> <span class="n">update</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)]):</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;Foo&#39;</span><span class="p">)</span>

        <span class="c1"># some value, no default</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="n">insert</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)]):</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;Bar&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;Bar&#39;</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">default_bar</span><span class="o">=</span><span class="s1">&#39;Def&#39;</span><span class="p">)</span>

        <span class="c1"># no value, some default</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="n">insert</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)]):</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;Def&#39;</span><span class="p">)</span>

        <span class="c1"># some value, some default</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="n">insert</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)]):</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;Bar&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;Bar&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestComputeQueries.test_compute_inverse">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestComputeQueries.test_compute_inverse">[docs]</a>
    <span class="k">def</span> <span class="nf">test_compute_inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.compute.inverse&#39;</span><span class="p">]</span>
        <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>

        <span class="c1"># no value, no default</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="n">insert</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">),</span> <span class="n">update</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)]):</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;Foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;Foo&#39;</span><span class="p">)</span>

        <span class="c1"># some value, no default</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="n">insert</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">),</span> <span class="n">update</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)]):</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;Bar&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;Bar&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;Bar&#39;</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">default_bar</span><span class="o">=</span><span class="s1">&#39;Def&#39;</span><span class="p">)</span>

        <span class="c1"># no value, some default</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="n">insert</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">),</span> <span class="n">update</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)]):</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;Def&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;Def&#39;</span><span class="p">)</span>

        <span class="c1"># some value, some default</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="n">insert</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">),</span> <span class="n">update</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)]):</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;Bar&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="s1">&#39;Bar&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;Bar&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestComputeQueries.test_multi_create">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestComputeQueries.test_multi_create">[docs]</a>
    <span class="k">def</span> <span class="nf">test_multi_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.foo&#39;</span><span class="p">]</span>
        <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="n">insert</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;value1&#39;</span><span class="p">,</span> <span class="s1">&#39;value2&#39;</span><span class="p">,</span> <span class="n">rowcount</span><span class="o">=</span><span class="mi">4</span><span class="p">)]):</span>
            <span class="n">create_values</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo1&#39;</span><span class="p">,</span> <span class="s1">&#39;value1&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo2&#39;</span><span class="p">,</span> <span class="s1">&#39;value2&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo3&#39;</span><span class="p">},</span>
                <span class="p">{},</span>
            <span class="p">]</span>
            <span class="n">records</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">create_values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;Foo1&#39;</span><span class="p">,</span> <span class="s1">&#39;Foo2&#39;</span><span class="p">,</span> <span class="s1">&#39;Foo3&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;value1&#39;</span><span class="p">),</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;value2&#39;</span><span class="p">),</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="TestComputeQueries.test_partial_compute_batching">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestComputeQueries.test_partial_compute_batching">[docs]</a>
    <span class="k">def</span> <span class="nf">test_partial_compute_batching</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Create several &#39;new&#39; records and check that the partial compute</span>
<span class="sd">        method is called only once.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.order&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">new</span><span class="p">({</span>
            <span class="s1">&#39;line_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;reward&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="n">OrderLine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;test_new_api.order.line&#39;</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span>
            <span class="n">OrderLine</span><span class="p">,</span>
            <span class="s1">&#39;_compute_has_been_rewarded&#39;</span><span class="p">,</span>
            <span class="n">side_effect</span><span class="o">=</span><span class="n">OrderLine</span><span class="o">.</span><span class="n">_compute_has_been_rewarded</span><span class="p">,</span>
            <span class="n">autospec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">patch_compute</span><span class="p">:</span>
            <span class="n">order</span><span class="o">.</span><span class="n">line_ids</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="s1">&#39;has_been_rewarded&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">patch_compute</span><span class="o">.</span><span class="n">call_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="test_shared_cache">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.test_shared_cache">[docs]</a>
<span class="k">class</span> <span class="nc">test_shared_cache</span><span class="p">(</span><span class="n">TransactionCaseWithUserDemo</span><span class="p">):</span>
<div class="viewcode-block" id="test_shared_cache.test_shared_cache_computed_field">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.test_shared_cache.test_shared_cache_computed_field">[docs]</a>
    <span class="k">def</span> <span class="nf">test_shared_cache_computed_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Test case: Check that the shared cache is not used if a compute_sudo stored field</span>
        <span class="c1"># is computed IF there is an ir.rule defined on this specific model.</span>

        <span class="c1"># Real life example:</span>
        <span class="c1"># A user can only see its own timesheets on a task, but the field &quot;Planned Hours&quot;,</span>
        <span class="c1"># which is stored-compute_sudo, should take all the timesheet lines into account</span>
        <span class="c1"># However, when adding a new line and then recomputing the value, no existing line</span>
        <span class="c1"># from another user is binded on self, then the value is erased and saved on the</span>
        <span class="c1"># database.</span>

        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_shared_cache_compute_parent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Shared Task&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_shared_cache_compute_line&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="s1">&#39;base.user_admin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">total_amount</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>  <span class="c1"># Start fresh, as it would be the case on 2 different sessions.</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">with_user</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_demo</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">common</span><span class="o">.</span><span class="n">Form</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="k">as</span> <span class="n">task_form</span><span class="p">:</span>
            <span class="c1"># Use demo has no access to the already existing line</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">task_form</span><span class="o">.</span><span class="n">line_ids</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># But see the real total_amount</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">task_form</span><span class="o">.</span><span class="n">total_amount</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Now let&#39;s add a new line (and retrigger the compute method)</span>
            <span class="k">with</span> <span class="n">task_form</span><span class="o">.</span><span class="n">line_ids</span><span class="o">.</span><span class="n">new</span><span class="p">()</span> <span class="k">as</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">line</span><span class="o">.</span><span class="n">amount</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="c1"># The new value for total_amount, should be 3, not 2.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">task_form</span><span class="o">.</span><span class="n">total_amount</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TestUnlinkConstraints">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestUnlinkConstraints">[docs]</a>
<span class="nd">@common</span><span class="o">.</span><span class="n">tagged</span><span class="p">(</span><span class="s1">&#39;unlink_constraints&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestUnlinkConstraints</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">TransactionCase</span><span class="p">):</span>
<div class="viewcode-block" id="TestUnlinkConstraints.setUpClass">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestUnlinkConstraints.setUpClass">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUpClass</span><span class="p">()</span>
        <span class="n">MODEL</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.model_constrained_unlinks&#39;</span><span class="p">]</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">deletable_bar</span> <span class="o">=</span> <span class="n">MODEL</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">undeletable_bar</span> <span class="o">=</span> <span class="n">MODEL</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">})</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">deletable_foo</span> <span class="o">=</span> <span class="n">MODEL</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;formaggio&#39;</span><span class="p">})</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">undeletable_foo</span> <span class="o">=</span> <span class="n">MODEL</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;prosciutto&#39;</span><span class="p">})</span>

        <span class="kn">from</span> <span class="nn">odoo.addons.base.models.ir_model</span> <span class="kn">import</span> <span class="n">MODULE_UNINSTALL_FLAG</span>
        <span class="n">uninstall</span> <span class="o">=</span> <span class="p">{</span><span class="n">MODULE_UNINSTALL_FLAG</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">undeletable_bar_uninstall</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">undeletable_bar</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">**</span><span class="n">uninstall</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">undeletable_foo_uninstall</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">undeletable_foo</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">**</span><span class="n">uninstall</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestUnlinkConstraints.test_unlink_constraint_manual_bar">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestUnlinkConstraints.test_unlink_constraint_manual_bar">[docs]</a>
    <span class="k">def</span> <span class="nf">test_unlink_constraint_manual_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deletable_bar</span><span class="o">.</span><span class="n">unlink</span><span class="p">())</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Nooooooooo bar can&#39;t be greater than five!!&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">undeletable_bar</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>


<div class="viewcode-block" id="TestUnlinkConstraints.test_unlink_constraint_uninstall_bar">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestUnlinkConstraints.test_unlink_constraint_uninstall_bar">[docs]</a>
    <span class="k">def</span> <span class="nf">test_unlink_constraint_uninstall_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deletable_bar</span><span class="o">.</span><span class="n">unlink</span><span class="p">())</span>
        <span class="c1"># should succeed since it&#39;s at_uninstall=False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">undeletable_bar_uninstall</span><span class="o">.</span><span class="n">unlink</span><span class="p">())</span></div>


<div class="viewcode-block" id="TestUnlinkConstraints.test_unlink_constraint_manual_foo">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestUnlinkConstraints.test_unlink_constraint_manual_foo">[docs]</a>
    <span class="k">def</span> <span class="nf">test_unlink_constraint_manual_foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deletable_foo</span><span class="o">.</span><span class="n">unlink</span><span class="p">())</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;You didn&#39;t say if you wanted it crudo or cotto...&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">undeletable_foo</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>


<div class="viewcode-block" id="TestUnlinkConstraints.test_unlink_constraint_uninstall_foo">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestUnlinkConstraints.test_unlink_constraint_uninstall_foo">[docs]</a>
    <span class="k">def</span> <span class="nf">test_unlink_constraint_uninstall_foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deletable_foo</span><span class="p">)</span>
        <span class="c1"># should fail since it&#39;s at_uninstall=True</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;You didn&#39;t say if you wanted it crudo or cotto...&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">undeletable_foo_uninstall</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="TestWrongRelatedError">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestWrongRelatedError">[docs]</a>
<span class="nd">@common</span><span class="o">.</span><span class="n">tagged</span><span class="p">(</span><span class="s1">&#39;wrong_related_path&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestWrongRelatedError</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">TransactionCase</span><span class="p">):</span>
<div class="viewcode-block" id="TestWrongRelatedError.test_wrong_related_path">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestWrongRelatedError.test_wrong_related_path">[docs]</a>
    <span class="k">def</span> <span class="nf">test_wrong_related_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="n">_module</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">_name</span> <span class="o">=</span> <span class="n">_description</span> <span class="o">=</span> <span class="s1">&#39;test_new_api.wrong_related_path&#39;</span>

            <span class="n">foo_id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;test_new_api.foo&#39;</span><span class="p">)</span>
            <span class="n">foo_non_existing</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">related</span><span class="o">=</span><span class="s1">&#39;foo_id.non_existing_field&#39;</span><span class="p">)</span>
        <span class="n">Foo</span><span class="o">.</span><span class="n">_build_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="fm">__delitem__</span><span class="p">,</span> <span class="n">Foo</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

        <span class="n">errMsg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Field non_existing_field referenced in related field definition &quot;</span>
            <span class="s2">&quot;test_new_api.wrong_related_path.foo_non_existing does not exist.&quot;</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="n">errMsg</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TestPrecomputeModel">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestPrecomputeModel">[docs]</a>
<span class="k">class</span> <span class="nc">TestPrecomputeModel</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">TransactionCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestPrecomputeModel.test_precompute_consistency">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestPrecomputeModel.test_precompute_consistency">[docs]</a>
    <span class="k">def</span> <span class="nf">test_precompute_consistency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;test_new_api.precompute&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">compute</span><span class="p">,</span> <span class="n">Model</span><span class="o">.</span><span class="n">upper</span><span class="o">.</span><span class="n">compute</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">precompute</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">upper</span><span class="o">.</span><span class="n">precompute</span><span class="p">)</span>

        <span class="c1"># see what happens if not both are precompute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">reset_changes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="s1">&#39;precompute&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertWarns</span><span class="p">(</span><span class="ne">UserWarning</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">field_computed</span></div>


<div class="viewcode-block" id="TestPrecomputeModel.test_precompute_dependencies_base">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestPrecomputeModel.test_precompute_dependencies_base">[docs]</a>
    <span class="k">def</span> <span class="nf">test_precompute_dependencies_base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;test_new_api.precompute&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">precompute</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">upper</span><span class="o">.</span><span class="n">precompute</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">lowup</span><span class="o">.</span><span class="n">precompute</span><span class="p">)</span>

        <span class="c1"># see what happens if precompute depends on non-precompute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">reset_changes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="s1">&#39;precompute&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="s1">&#39;precompute&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertWarns</span><span class="p">(</span><span class="ne">UserWarning</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get_trigger_tree</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>


<div class="viewcode-block" id="TestPrecomputeModel.test_precompute_dependencies_many2one">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestPrecomputeModel.test_precompute_dependencies_many2one">[docs]</a>
    <span class="k">def</span> <span class="nf">test_precompute_dependencies_many2one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;test_new_api.precompute&#39;</span><span class="p">]</span>
        <span class="n">Partner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;res.partner&#39;</span><span class="p">]</span>

        <span class="c1"># Model.commercial_id depends on partner_id.commercial_partner_id, and</span>
        <span class="c1"># precomputation is valid when traversing many2one fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">commercial_id</span><span class="o">.</span><span class="n">precompute</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">Partner</span><span class="o">.</span><span class="n">commercial_partner_id</span><span class="o">.</span><span class="n">precompute</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestPrecomputeModel.test_precompute_dependencies_one2many">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestPrecomputeModel.test_precompute_dependencies_one2many">[docs]</a>
    <span class="k">def</span> <span class="nf">test_precompute_dependencies_one2many</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;test_new_api.precompute&#39;</span><span class="p">]</span>
        <span class="n">Line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;test_new_api.precompute.line&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">precompute</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">Line</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">precompute</span><span class="p">)</span>

        <span class="c1"># see what happens if precompute depends on non-precompute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">reset_changes</span><span class="p">)</span>
        <span class="c1"># ensure that Model.size.precompute is restored after setup_models()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="s1">&#39;precompute&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">Line</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="s1">&#39;precompute&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertWarns</span><span class="p">(</span><span class="ne">UserWarning</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">setup_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get_trigger_tree</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></div>
</div>



<div class="viewcode-block" id="TestPrecompute">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestPrecompute">[docs]</a>
<span class="k">class</span> <span class="nc">TestPrecompute</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">TransactionCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestPrecompute.test_precompute">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestPrecompute.test_precompute">[docs]</a>
    <span class="k">def</span> <span class="nf">test_precompute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.precompute&#39;</span><span class="p">]</span>

        <span class="c1"># warmup</span>
        <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;line_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})]})</span>

        <span class="c1"># the creation makes one insert query for the main record, and one for the line</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span>
            <span class="n">insert</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="s1">&#39;upper&#39;</span><span class="p">,</span> <span class="s1">&#39;lowup&#39;</span><span class="p">,</span> <span class="s1">&#39;commercial_id&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">),</span>
            <span class="n">insert</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">line_ids</span><span class="p">,</span> <span class="s1">&#39;parent_id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">),</span>
        <span class="p">]):</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">,</span> <span class="s1">&#39;line_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Command</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})]})</span>

        <span class="c1"># check the values in the database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SELECT * FROM &quot;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">_table</span><span class="si">}</span><span class="s1">&quot; WHERE id=%s&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
        <span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="s1">&#39;Foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">],</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">],</span> <span class="s1">&#39;FOO&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;lowup&#39;</span><span class="p">],</span> <span class="s1">&#39;fooFOO&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestPrecompute.test_precompute_combo">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestPrecompute.test_precompute_combo">[docs]</a>
    <span class="k">def</span> <span class="nf">test_precompute_combo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.precompute.combo&#39;</span><span class="p">]</span>

        <span class="c1"># warmup</span>
        <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="n">QUERIES</span> <span class="o">=</span> <span class="p">[</span><span class="n">insert</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;reader&#39;</span><span class="p">,</span> <span class="s1">&#39;editer&#39;</span><span class="p">,</span> <span class="s1">&#39;setter&#39;</span><span class="p">)]</span>

        <span class="c1"># no value at all</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">(</span><span class="n">QUERIES</span><span class="p">):</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">reader</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">editer</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">setter</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>

        <span class="c1"># default value</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">(</span><span class="n">QUERIES</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertLogs</span><span class="p">(</span><span class="s1">&#39;precompute_setter&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;WARNING&#39;</span><span class="p">):</span>
            <span class="n">defaults</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">default_reader</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">default_editer</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="n">default_setter</span><span class="o">=</span><span class="s1">&#39;Z&#39;</span><span class="p">)</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">**</span><span class="n">defaults</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">reader</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">editer</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">setter</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">)</span>

        <span class="c1"># explicit value</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">(</span><span class="n">QUERIES</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertLogs</span><span class="p">(</span><span class="s1">&#39;precompute_setter&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;WARNING&#39;</span><span class="p">):</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;reader&#39;</span><span class="p">:</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;editer&#39;</span><span class="p">:</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;setter&#39;</span><span class="p">:</span> <span class="s1">&#39;Z&#39;</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">reader</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">editer</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">setter</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestPrecompute.test_precompute_editable">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestPrecompute.test_precompute_editable">[docs]</a>
    <span class="k">def</span> <span class="nf">test_precompute_editable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.precompute.editable&#39;</span><span class="p">]</span>

        <span class="c1"># no value for bar, no value for baz</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;COMPUTED&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">baz</span><span class="p">,</span> <span class="s1">&#39;COMPUTED&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">baz2</span><span class="p">,</span> <span class="s1">&#39;COMPUTED&#39;</span><span class="p">)</span>

        <span class="c1"># value for bar, no value for baz</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">baz</span><span class="p">,</span> <span class="s1">&#39;COMPUTED&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">baz2</span><span class="p">,</span> <span class="s1">&#39;COMPUTED&#39;</span><span class="p">)</span>

        <span class="c1"># no value for bar, value for baz: the computation of bar should not</span>
        <span class="c1"># recompute baz in memory, in case a third field depends on it</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;COMPUTED&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">baz</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">baz2</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">)</span>

        <span class="c1"># value for bar, value for baz</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">baz</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">baz2</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestPrecompute.test_precompute_readonly">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestPrecompute.test_precompute_readonly">[docs]</a>
    <span class="k">def</span> <span class="nf">test_precompute_readonly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensures</span>
<span class="sd">        - a stored, precomputed, readonly field cannot be altered by the user,</span>
<span class="sd">        - a stored, precomputed, readonly field,</span>
<span class="sd">          but with a states attributes changing the readonly of the field according to the state of the record,</span>
<span class="sd">          can be altered by the user.</span>
<span class="sd">        The `bar` field is store=True, precompute=True, readonly=True</span>
<span class="sd">        The `baz` field is store=True, precompute=True, readonly=False,</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.precompute.readonly&#39;</span><span class="p">]</span>

        <span class="c1"># no value for bar, no value for baz</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;COMPUTED&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">baz</span><span class="p">,</span> <span class="s1">&#39;COMPUTED&#39;</span><span class="p">)</span>

        <span class="c1"># value for bar, no value for baz</span>
        <span class="c1"># bar is readonly, it must ignore the value for bar in the create values</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;COMPUTED&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">baz</span><span class="p">,</span> <span class="s1">&#39;COMPUTED&#39;</span><span class="p">)</span>

        <span class="c1"># no value for bar, value for baz</span>
        <span class="c1"># baz is readonly=False</span>
        <span class="c1"># the value for baz must be taken into account</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;COMPUTED&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">baz</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">)</span>

        <span class="c1"># value for bar, value for baz</span>
        <span class="c1"># bar must be ignored</span>
        <span class="c1"># baz must be taken into account</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;COMPUTED&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">baz</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestPrecompute.test_precompute_required">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestPrecompute.test_precompute_required">[docs]</a>
    <span class="k">def</span> <span class="nf">test_precompute_required</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.precompute.required&#39;</span><span class="p">]</span>

        <span class="n">field</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">related</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">required</span><span class="p">)</span>

        <span class="n">partner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.partner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">})</span>

        <span class="c1"># this will crash if field is not precomputed</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;partner_id&#39;</span><span class="p">:</span> <span class="n">partner</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;Foo&#39;</span><span class="p">)</span>

        <span class="c1"># check the queries being made</span>
        <span class="n">QUERIES</span> <span class="o">=</span> <span class="p">[</span><span class="n">insert</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;partner_id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">(</span><span class="n">QUERIES</span><span class="p">):</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;partner_id&#39;</span><span class="p">:</span> <span class="n">partner</span><span class="o">.</span><span class="n">id</span><span class="p">})</span></div>


<div class="viewcode-block" id="TestPrecompute.test_precompute_batch">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestPrecompute.test_precompute_batch">[docs]</a>
    <span class="k">def</span> <span class="nf">test_precompute_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.precompute.required&#39;</span><span class="p">]</span>

        <span class="n">partners</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.partner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">([</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="s2">&quot;Foo Bar Baz&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="p">])</span>

        <span class="c1"># warmup</span>
        <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="s1">&#39;partner_id&#39;</span><span class="p">:</span> <span class="n">partners</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>

        <span class="c1"># check the number of queries: 1 SELECT + 1 INSERT</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">([{</span><span class="s1">&#39;partner_id&#39;</span><span class="p">:</span> <span class="n">pid</span><span class="p">}</span> <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">partners</span><span class="o">.</span><span class="n">ids</span><span class="p">])</span></div>


<div class="viewcode-block" id="TestPrecompute.test_precompute_monetary">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestPrecompute.test_precompute_monetary">[docs]</a>
    <span class="k">def</span> <span class="nf">test_precompute_monetary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make sure the rounding of monetaries correctly prefetches currency fields&quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.precompute.monetary&#39;</span><span class="p">]</span>
        <span class="n">currency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.currency&#39;</span><span class="p">]</span>

        <span class="c1"># warmup</span>
        <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>

        <span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">fname</span> <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">currency</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">prefetch</span><span class="p">]</span>
        <span class="n">QUERIES</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">select</span><span class="p">(</span><span class="n">currency</span><span class="p">,</span> <span class="o">*</span><span class="n">fnames</span><span class="p">),</span>
            <span class="n">insert</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;amount&#39;</span><span class="p">,</span> <span class="s1">&#39;currency_id&#39;</span><span class="p">),</span>
            <span class="n">select</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;currency_id&#39;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">(</span><span class="n">QUERIES</span><span class="p">):</span>
            <span class="n">model</span><span class="o">.</span><span class="n">create</span><span class="p">({})</span></div>
</div>



<div class="viewcode-block" id="TestModifiedPerformance">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestModifiedPerformance">[docs]</a>
<span class="k">class</span> <span class="nc">TestModifiedPerformance</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">TransactionCase</span><span class="p">):</span>

<div class="viewcode-block" id="TestModifiedPerformance.setUpClass">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestModifiedPerformance.setUpClass">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">setUpClass</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">Modified</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.modified&#39;</span><span class="p">]</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">ModifiedLine</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;test_new_api.modified.line&#39;</span><span class="p">]</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">modified_a</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">Modified</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Test&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">modified_line_a</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ModifiedLine</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;modified_id&#39;</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">modified_a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">modified_line_a_child</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ModifiedLine</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;modified_id&#39;</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">modified_a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">modified_line_a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">modified_line_a_child_child</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ModifiedLine</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
            <span class="s1">&#39;modified_id&#39;</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">modified_a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;quantity&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">&#39;parent_id&#39;</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">modified_line_a_child</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">invalidate_all</span><span class="p">()</span>  <span class="c1"># Clean the cache</span></div>


<div class="viewcode-block" id="TestModifiedPerformance.test_modified_trigger_related">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestModifiedPerformance.test_modified_trigger_related">[docs]</a>
    <span class="k">def</span> <span class="nf">test_modified_trigger_related</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="c1"># No queries because `modified_name` has a empty cache</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modified_a</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Other&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modified_line_a</span><span class="o">.</span><span class="n">modified_name</span><span class="p">,</span> <span class="s1">&#39;Other&#39;</span><span class="p">)</span>  <span class="c1"># check</span></div>


<div class="viewcode-block" id="TestModifiedPerformance.test_modified_trigger_no_store_compute">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestModifiedPerformance.test_modified_trigger_no_store_compute">[docs]</a>
    <span class="k">def</span> <span class="nf">test_modified_trigger_no_store_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="c1"># No queries because `total_quantity` has a empty cache</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modified_line_a</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="mi">8</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modified_a</span><span class="o">.</span><span class="n">total_quantity</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestModifiedPerformance.test_modified_trigger_recursive_empty_cache">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestModifiedPerformance.test_modified_trigger_recursive_empty_cache">[docs]</a>
    <span class="k">def</span> <span class="nf">test_modified_trigger_recursive_empty_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="c1"># No queries because `total_price` has a empty cache</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modified_line_a_child_child</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modified_line_a</span><span class="o">.</span><span class="n">total_price</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modified_line_a</span><span class="o">.</span><span class="n">total_price_quantity</span><span class="p">,</span> <span class="mi">35</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modified_line_a_child</span><span class="o">.</span><span class="n">total_price</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modified_line_a_child</span><span class="o">.</span><span class="n">total_price_quantity</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestModifiedPerformance.test_modified_trigger_recursive_fill_cache">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestModifiedPerformance.test_modified_trigger_recursive_fill_cache">[docs]</a>
    <span class="k">def</span> <span class="nf">test_modified_trigger_recursive_fill_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modified_line_a</span><span class="o">.</span><span class="n">total_price</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modified_line_a</span><span class="o">.</span><span class="n">total_price_quantity</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueryCount</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="c1"># No query because the `modified_line_a.total_price` has fetch every data needed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modified_line_a_child_child</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modified_line_a</span><span class="o">.</span><span class="n">total_price_quantity</span><span class="p">,</span> <span class="mi">35</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modified_line_a</span><span class="o">.</span><span class="n">total_price</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestModifiedPerformance.test_modified_trigger_recursive_partial_invalidate">
<a class="viewcode-back" href="../../../../../odoo.addons.test_new_api.tests.html#odoo.addons.test_new_api.tests.test_new_fields.TestModifiedPerformance.test_modified_trigger_recursive_partial_invalidate">[docs]</a>
    <span class="k">def</span> <span class="nf">test_modified_trigger_recursive_partial_invalidate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modified_line_a_child</span><span class="o">.</span><span class="n">total_price_quantity</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modified_line_a_child_child</span><span class="o">.</span><span class="n">invalidate_recordset</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">modified_line_a_child</span><span class="o">.</span><span class="n">price</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQueries</span><span class="p">([</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT &quot;test_new_api_modified_line&quot;.&quot;id&quot;,</span>
<span class="s2">                   &quot;test_new_api_modified_line&quot;.&quot;modified_id&quot;,</span>
<span class="s2">                   &quot;test_new_api_modified_line&quot;.&quot;quantity&quot;,</span>
<span class="s2">                   &quot;test_new_api_modified_line&quot;.&quot;parent_id&quot;,</span>
<span class="s2">                   &quot;test_new_api_modified_line&quot;.&quot;create_uid&quot;,</span>
<span class="s2">                   &quot;test_new_api_modified_line&quot;.&quot;create_date&quot;</span>
<span class="s2">            FROM &quot;test_new_api_modified_line&quot;</span>
<span class="s2">            WHERE (&quot;test_new_api_modified_line&quot;.&quot;id&quot; IN </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT &quot;test_new_api_modified_line&quot;.&quot;id&quot;,</span>
<span class="s2">                   &quot;test_new_api_modified_line&quot;.&quot;parent_id&quot;</span>
<span class="s2">            FROM &quot;test_new_api_modified_line&quot;</span>
<span class="s2">            WHERE (&quot;test_new_api_modified_line&quot;.&quot;id&quot; IN </span><span class="si">%s</span><span class="s2">)</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">],</span> <span class="n">flush</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="c1"># Two requests:</span>
            <span class="c1"># - one for fetch modified_line_a_child_child data (invalidate just before)</span>
            <span class="c1"># - one because modified_line_a_child.parent_id (invalidate just before because we invalidate inverse in `_invalidate_cache`,</span>
            <span class="c1"># see TODO) -&gt; We should change that</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modified_line_a_child_child</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modified_line_a_child_child</span><span class="o">.</span><span class="n">total_price_quantity</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modified_line_a_child</span><span class="o">.</span><span class="n">total_price_quantity</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modified_line_a</span><span class="o">.</span><span class="n">total_price_quantity</span><span class="p">,</span> <span class="mi">35</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modified_line_a</span><span class="o">.</span><span class="n">total_price</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Amr.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>