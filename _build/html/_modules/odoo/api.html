<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>odoo.api &mdash; Amr  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Amr
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">odoo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Amr</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../odoo.html">odoo</a></li>
      <li class="breadcrumb-item active">odoo.api</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for odoo.api</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># Part of Odoo. See LICENSE file for full copyright and licensing details.</span>

<span class="sd">&quot;&quot;&quot;The Odoo API module defines Odoo Environments and method decorators.</span>

<span class="sd">.. todo:: Document this module</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;Environment&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Meta&#39;</span><span class="p">,</span>
    <span class="s1">&#39;model&#39;</span><span class="p">,</span>
    <span class="s1">&#39;constrains&#39;</span><span class="p">,</span> <span class="s1">&#39;depends&#39;</span><span class="p">,</span> <span class="s1">&#39;onchange&#39;</span><span class="p">,</span> <span class="s1">&#39;returns&#39;</span><span class="p">,</span>
    <span class="s1">&#39;call_kw&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Mapping</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">signature</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>
<span class="kn">from</span> <span class="nn">weakref</span> <span class="kn">import</span> <span class="n">WeakSet</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">decorator</span> <span class="kn">import</span> <span class="n">decoratorx</span> <span class="k">as</span> <span class="n">decorator</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">decorator</span> <span class="kn">import</span> <span class="n">decorator</span>

<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">AccessError</span><span class="p">,</span> <span class="n">CacheMiss</span>
<span class="kn">from</span> <span class="nn">.tools</span> <span class="kn">import</span> <span class="n">clean_context</span><span class="p">,</span> <span class="n">frozendict</span><span class="p">,</span> <span class="n">lazy_property</span><span class="p">,</span> <span class="n">OrderedSet</span><span class="p">,</span> <span class="n">Query</span><span class="p">,</span> <span class="n">SQL</span><span class="p">,</span> <span class="n">StackMap</span>
<span class="kn">from</span> <span class="nn">.tools.translate</span> <span class="kn">import</span> <span class="n">_</span>

<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># The following attributes are used, and reflected on wrapping methods:</span>
<span class="c1">#  - method._constrains: set by @constrains, specifies constraint dependencies</span>
<span class="c1">#  - method._depends: set by @depends, specifies compute dependencies</span>
<span class="c1">#  - method._returns: set by @returns, specifies return model</span>
<span class="c1">#  - method._onchange: set by @onchange, specifies onchange fields</span>
<span class="c1">#  - method.clear_cache: set by @ormcache, used to clear the cache</span>
<span class="c1">#  - method._ondelete: set by @ondelete, used to raise errors for unlink operations</span>
<span class="c1">#</span>
<span class="c1"># On wrapping method only:</span>
<span class="c1">#  - method._api: decorator function, used for re-applying decorator</span>
<span class="c1">#</span>

<span class="n">INHERITED_ATTRS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;_returns&#39;</span><span class="p">,)</span>


<span class="k">class</span> <span class="nc">Params</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>


<div class="viewcode-block" id="Meta">
<a class="viewcode-back" href="../../odoo.html#odoo.api.Meta">[docs]</a>
<span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Metaclass that automatically decorates traditional-style methods by</span>
<span class="sd">        guessing their API. It also implements the inheritance of the</span>
<span class="sd">        :func:`returns` decorators.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="c1"># dummy parent class to catch overridden methods decorated with &#39;returns&#39;</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="nb">type</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="c1"># make the method inherit from decorators</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">propagate</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="nb">type</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">attrsetter</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return a function that sets ``attr`` on its argument and returns it. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="k">lambda</span> <span class="n">method</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">or</span> <span class="n">method</span>

<span class="k">def</span> <span class="nf">propagate</span><span class="p">(</span><span class="n">method1</span><span class="p">,</span> <span class="n">method2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Propagate decorators from ``method1`` to ``method2``, and return the</span>
<span class="sd">        resulting method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">method1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">INHERITED_ATTRS</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">method1</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">method2</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">method2</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">method1</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">method2</span>


<div class="viewcode-block" id="constrains">
<a class="viewcode-back" href="../../odoo.html#odoo.api.constrains">[docs]</a>
<span class="k">def</span> <span class="nf">constrains</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorate a constraint checker.</span>

<span class="sd">    Each argument must be a field name used in the check::</span>

<span class="sd">        @api.constrains(&#39;name&#39;, &#39;description&#39;)</span>
<span class="sd">        def _check_description(self):</span>
<span class="sd">            for record in self:</span>
<span class="sd">                if record.name == record.description:</span>
<span class="sd">                    raise ValidationError(&quot;Fields name and description must be different&quot;)</span>

<span class="sd">    Invoked on the records on which one of the named fields has been modified.</span>

<span class="sd">    Should raise :exc:`~odoo.exceptions.ValidationError` if the</span>
<span class="sd">    validation failed.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        ``@constrains`` only supports simple field names, dotted names</span>
<span class="sd">        (fields of relational fields e.g. ``partner_id.customer``) are not</span>
<span class="sd">        supported and will be ignored.</span>

<span class="sd">        ``@constrains`` will be triggered only if the declared fields in the</span>
<span class="sd">        decorated method are included in the ``create`` or ``write`` call.</span>
<span class="sd">        It implies that fields not present in a view will not trigger a call</span>
<span class="sd">        during a record creation. A override of ``create`` is necessary to make</span>
<span class="sd">        sure a constraint will always be triggered (e.g. to test the absence of</span>
<span class="sd">        value).</span>

<span class="sd">    One may also pass a single function as argument.  In that case, the field</span>
<span class="sd">    names are given by calling the function with a model instance.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">attrsetter</span><span class="p">(</span><span class="s1">&#39;_constrains&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">ondelete</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">at_uninstall</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mark a method to be executed during :meth:`~odoo.models.BaseModel.unlink`.</span>

<span class="sd">    The goal of this decorator is to allow client-side errors when unlinking</span>
<span class="sd">    records if, from a business point of view, it does not make sense to delete</span>
<span class="sd">    such records. For instance, a user should not be able to delete a validated</span>
<span class="sd">    sales order.</span>

<span class="sd">    While this could be implemented by simply overriding the method ``unlink``</span>
<span class="sd">    on the model, it has the drawback of not being compatible with module</span>
<span class="sd">    uninstallation. When uninstalling the module, the override could raise user</span>
<span class="sd">    errors, but we shouldn&#39;t care because the module is being uninstalled, and</span>
<span class="sd">    thus **all** records related to the module should be removed anyway.</span>

<span class="sd">    This means that by overriding ``unlink``, there is a big chance that some</span>
<span class="sd">    tables/records may remain as leftover data from the uninstalled module. This</span>
<span class="sd">    leaves the database in an inconsistent state. Moreover, there is a risk of</span>
<span class="sd">    conflicts if the module is ever reinstalled on that database.</span>

<span class="sd">    Methods decorated with ``@ondelete`` should raise an error following some</span>
<span class="sd">    conditions, and by convention, the method should be named either</span>
<span class="sd">    ``_unlink_if_&lt;condition&gt;`` or ``_unlink_except_&lt;not_condition&gt;``.</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        @api.ondelete(at_uninstall=False)</span>
<span class="sd">        def _unlink_if_user_inactive(self):</span>
<span class="sd">            if any(user.active for user in self):</span>
<span class="sd">                raise UserError(&quot;Can&#39;t delete an active user!&quot;)</span>

<span class="sd">        # same as above but with _unlink_except_* as method name</span>
<span class="sd">        @api.ondelete(at_uninstall=False)</span>
<span class="sd">        def _unlink_except_active_user(self):</span>
<span class="sd">            if any(user.active for user in self):</span>
<span class="sd">                raise UserError(&quot;Can&#39;t delete an active user!&quot;)</span>

<span class="sd">    :param bool at_uninstall: Whether the decorated method should be called if</span>
<span class="sd">        the module that implements said method is being uninstalled. Should</span>
<span class="sd">        almost always be ``False``, so that module uninstallation does not</span>
<span class="sd">        trigger those errors.</span>

<span class="sd">    .. danger::</span>
<span class="sd">        The parameter ``at_uninstall`` should only be set to ``True`` if the</span>
<span class="sd">        check you are implementing also applies when uninstalling the module.</span>

<span class="sd">        For instance, it doesn&#39;t matter if when uninstalling ``sale``, validated</span>
<span class="sd">        sales orders are being deleted because all data pertaining to ``sale``</span>
<span class="sd">        should be deleted anyway, in that case ``at_uninstall`` should be set to</span>
<span class="sd">        ``False``.</span>

<span class="sd">        However, it makes sense to prevent the removal of the default language</span>
<span class="sd">        if no other languages are installed, since deleting the default language</span>
<span class="sd">        will break a lot of basic behavior. In this case, ``at_uninstall``</span>
<span class="sd">        should be set to ``True``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">attrsetter</span><span class="p">(</span><span class="s1">&#39;_ondelete&#39;</span><span class="p">,</span> <span class="n">at_uninstall</span><span class="p">)</span>


<div class="viewcode-block" id="onchange">
<a class="viewcode-back" href="../../odoo.html#odoo.api.onchange">[docs]</a>
<span class="k">def</span> <span class="nf">onchange</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a decorator to decorate an onchange method for given fields.</span>

<span class="sd">    In the form views where the field appears, the method will be called</span>
<span class="sd">    when one of the given fields is modified. The method is invoked on a</span>
<span class="sd">    pseudo-record that contains the values present in the form. Field</span>
<span class="sd">    assignments on that record are automatically sent back to the client.</span>

<span class="sd">    Each argument must be a field name::</span>

<span class="sd">        @api.onchange(&#39;partner_id&#39;)</span>
<span class="sd">        def _onchange_partner(self):</span>
<span class="sd">            self.message = &quot;Dear %s&quot; % (self.partner_id.name or &quot;&quot;)</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        return {</span>
<span class="sd">            &#39;warning&#39;: {&#39;title&#39;: &quot;Warning&quot;, &#39;message&#39;: &quot;What is this?&quot;, &#39;type&#39;: &#39;notification&#39;},</span>
<span class="sd">        }</span>

<span class="sd">    If the type is set to notification, the warning will be displayed in a notification.</span>
<span class="sd">    Otherwise it will be displayed in a dialog as default.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        ``@onchange`` only supports simple field names, dotted names</span>
<span class="sd">        (fields of relational fields e.g. ``partner_id.tz``) are not</span>
<span class="sd">        supported and will be ignored</span>

<span class="sd">    .. danger::</span>

<span class="sd">        Since ``@onchange`` returns a recordset of pseudo-records,</span>
<span class="sd">        calling any one of the CRUD methods</span>
<span class="sd">        (:meth:`create`, :meth:`read`, :meth:`write`, :meth:`unlink`)</span>
<span class="sd">        on the aforementioned recordset is undefined behaviour,</span>
<span class="sd">        as they potentially do not exist in the database yet.</span>

<span class="sd">        Instead, simply set the record&#39;s field like shown in the example</span>
<span class="sd">        above or call the :meth:`update` method.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        It is not possible for a ``one2many`` or ``many2many`` field to modify</span>
<span class="sd">        itself via onchange. This is a webclient limitation - see `#2693 &lt;https://github.com/odoo/odoo/issues/2693&gt;`_.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">attrsetter</span><span class="p">(</span><span class="s1">&#39;_onchange&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span></div>



<div class="viewcode-block" id="depends">
<a class="viewcode-back" href="../../odoo.html#odoo.api.depends">[docs]</a>
<span class="k">def</span> <span class="nf">depends</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return a decorator that specifies the field dependencies of a &quot;compute&quot;</span>
<span class="sd">        method (for new-style function fields). Each argument must be a string</span>
<span class="sd">        that consists in a dot-separated sequence of field names::</span>

<span class="sd">            pname = fields.Char(compute=&#39;_compute_pname&#39;)</span>

<span class="sd">            @api.depends(&#39;partner_id.name&#39;, &#39;partner_id.is_company&#39;)</span>
<span class="sd">            def _compute_pname(self):</span>
<span class="sd">                for record in self:</span>
<span class="sd">                    if record.partner_id.is_company:</span>
<span class="sd">                        record.pname = (record.partner_id.name or &quot;&quot;).upper()</span>
<span class="sd">                    else:</span>
<span class="sd">                        record.pname = record.partner_id.name</span>

<span class="sd">        One may also pass a single function as argument. In that case, the</span>
<span class="sd">        dependencies are given by calling the function with the field&#39;s model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Compute method cannot depend on field &#39;id&#39;.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">attrsetter</span><span class="p">(</span><span class="s1">&#39;_depends&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">depends_context</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return a decorator that specifies the context dependencies of a</span>
<span class="sd">    non-stored &quot;compute&quot; method.  Each argument is a key in the context&#39;s</span>
<span class="sd">    dictionary::</span>

<span class="sd">        price = fields.Float(compute=&#39;_compute_product_price&#39;)</span>

<span class="sd">        @api.depends_context(&#39;pricelist&#39;)</span>
<span class="sd">        def _compute_product_price(self):</span>
<span class="sd">            for product in self:</span>
<span class="sd">                if product.env.context.get(&#39;pricelist&#39;):</span>
<span class="sd">                    pricelist = self.env[&#39;product.pricelist&#39;].browse(product.env.context[&#39;pricelist&#39;])</span>
<span class="sd">                else:</span>
<span class="sd">                    pricelist = self.env[&#39;product.pricelist&#39;].get_default_pricelist()</span>
<span class="sd">                product.price = pricelist._get_products_price(product).get(product.id, 0.0)</span>

<span class="sd">    All dependencies must be hashable.  The following keys have special</span>
<span class="sd">    support:</span>

<span class="sd">    * `company` (value in context or current company id),</span>
<span class="sd">    * `uid` (current user id and superuser flag),</span>
<span class="sd">    * `active_test` (value in env.context or value in field.context).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">attrsetter</span><span class="p">(</span><span class="s1">&#39;_depends_context&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>


<div class="viewcode-block" id="returns">
<a class="viewcode-back" href="../../odoo.html#odoo.api.returns">[docs]</a>
<span class="k">def</span> <span class="nf">returns</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">downgrade</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">upgrade</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return a decorator for methods that return instances of ``model``.</span>

<span class="sd">        :param model: a model name, or ``&#39;self&#39;`` for the current model</span>

<span class="sd">        :param downgrade: a function ``downgrade(self, value, *args, **kwargs)``</span>
<span class="sd">            to convert the record-style ``value`` to a traditional-style output</span>

<span class="sd">        :param upgrade: a function ``upgrade(self, value, *args, **kwargs)``</span>
<span class="sd">            to convert the traditional-style ``value`` to a record-style output</span>

<span class="sd">        The arguments ``self``, ``*args`` and ``**kwargs`` are the ones passed</span>
<span class="sd">        to the method in the record-style.</span>

<span class="sd">        The decorator adapts the method output to the api style: ``id``, ``ids`` or</span>
<span class="sd">        ``False`` for the traditional style, and recordset for the record style::</span>

<span class="sd">            @model</span>
<span class="sd">            @returns(&#39;res.partner&#39;)</span>
<span class="sd">            def find_partner(self, arg):</span>
<span class="sd">                ...     # return some record</span>

<span class="sd">            # output depends on call style: traditional vs record style</span>
<span class="sd">            partner_id = model.find_partner(cr, uid, arg, context=context)</span>

<span class="sd">            # recs = model.browse(cr, uid, ids, context)</span>
<span class="sd">            partner_record = recs.find_partner(arg)</span>

<span class="sd">        Note that the decorated method must satisfy that convention.</span>

<span class="sd">        Those decorators are automatically *inherited*: a method that overrides</span>
<span class="sd">        a decorated existing method will be decorated with the same</span>
<span class="sd">        ``@returns(model)``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">attrsetter</span><span class="p">(</span><span class="s1">&#39;_returns&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">downgrade</span><span class="p">,</span> <span class="n">upgrade</span><span class="p">))</span></div>



<span class="k">def</span> <span class="nf">downgrade</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Convert ``value`` returned by ``method`` on ``self`` to traditional style. &quot;&quot;&quot;</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s1">&#39;_returns&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">spec</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">convert</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">spec</span>
    <span class="k">if</span> <span class="n">convert</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">signature</span><span class="p">(</span><span class="n">convert</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">convert</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">convert</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">ids</span>


<span class="k">def</span> <span class="nf">split_context</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Extract the context from a pair of positional and keyword arguments.</span>
<span class="sd">        Return a triple ``context, args, kwargs``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># altering kwargs is a cause of errors, for instance when retrying a request</span>
    <span class="c1"># after a serialization error: the retry is done without context!</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>


<span class="k">def</span> <span class="nf">autovacuum</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorate a method so that it is called by the daily vacuum cron job (model</span>
<span class="sd">    ``ir.autovacuum``).  This is typically used for garbage-collection-like</span>
<span class="sd">    tasks that do not deserve a specific cron job.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: autovacuum methods must be private&quot;</span> <span class="o">%</span> <span class="n">method</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="n">method</span><span class="o">.</span><span class="n">_autovacuum</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">method</span>


<div class="viewcode-block" id="model">
<a class="viewcode-back" href="../../odoo.html#odoo.api.model">[docs]</a>
<span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Decorate a record-style method where ``self`` is a recordset, but its</span>
<span class="sd">        contents is not relevant, only the model is. Such a method::</span>

<span class="sd">            @api.model</span>
<span class="sd">            def method(self, args):</span>
<span class="sd">                ...</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;create&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">model_create_single</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="n">method</span><span class="o">.</span><span class="n">_api</span> <span class="o">=</span> <span class="s1">&#39;model&#39;</span>
    <span class="k">return</span> <span class="n">method</span></div>



<span class="n">_create_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;.create&#39;</span><span class="p">)</span>


<span class="nd">@decorator</span>
<span class="k">def</span> <span class="nf">_model_create_single</span><span class="p">(</span><span class="n">create</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="c1"># &#39;create&#39; expects a dict and returns a record</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">_create_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.create() called with </span><span class="si">%d</span><span class="s2"> dicts&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">()</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span> <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">model_create_single</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Decorate a method that takes a dictionary and creates a single record.</span>
<span class="sd">        The method may be called with either a single dict or a list of dicts::</span>

<span class="sd">            record = model.create(vals)</span>
<span class="sd">            records = model.create([vals, ...])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_create_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The model </span><span class="si">%s</span><span class="s2"> is not overriding the create method in batch&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">.</span><span class="vm">__module__</span><span class="p">)</span>
    <span class="n">wrapper</span> <span class="o">=</span> <span class="n">_model_create_single</span><span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="c1"># pylint: disable=no-value-for-parameter</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="n">_api</span> <span class="o">=</span> <span class="s1">&#39;model_create&#39;</span>
    <span class="k">return</span> <span class="n">wrapper</span>


<span class="nd">@decorator</span>
<span class="k">def</span> <span class="nf">_model_create_multi</span><span class="p">(</span><span class="n">create</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="c1"># &#39;create&#39; expects a list of dicts and returns a recordset</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="n">arg</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">model_create_multi</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Decorate a method that takes a list of dictionaries and creates multiple</span>
<span class="sd">        records. The method may be called with either a single dict or a list of</span>
<span class="sd">        dicts::</span>

<span class="sd">            record = model.create(vals)</span>
<span class="sd">            records = model.create([vals, ...])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wrapper</span> <span class="o">=</span> <span class="n">_model_create_multi</span><span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="c1"># pylint: disable=no-value-for-parameter</span>
    <span class="n">wrapper</span><span class="o">.</span><span class="n">_api</span> <span class="o">=</span> <span class="s1">&#39;model_create&#39;</span>
    <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">def</span> <span class="nf">_call_kw_model</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
    <span class="n">context</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">split_context</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
    <span class="n">recs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">context</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;call </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">recs</span><span class="p">,</span> <span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">Params</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">recs</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">downgrade</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">recs</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_call_kw_model_create</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># special case for method &#39;create&#39;</span>
    <span class="n">context</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">split_context</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
    <span class="n">recs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">context</span> <span class="ow">or</span> <span class="p">{})</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;call </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">recs</span><span class="p">,</span> <span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">Params</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">recs</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Mapping</span><span class="p">)</span> <span class="k">else</span> <span class="n">result</span><span class="o">.</span><span class="n">ids</span>


<span class="k">def</span> <span class="nf">_call_kw_multi</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ids</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">context</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">split_context</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
    <span class="n">recs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">context</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;call </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">recs</span><span class="p">,</span> <span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">Params</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">recs</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">downgrade</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">recs</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>


<div class="viewcode-block" id="call_kw">
<a class="viewcode-back" href="../../odoo.html#odoo.api.call_kw">[docs]</a>
<span class="k">def</span> <span class="nf">call_kw</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Invoke the given method ``name`` on the recordset ``model``. &quot;&quot;&quot;</span>
    <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">method</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The method &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; does not exist on the model &#39;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="n">api</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s1">&#39;_api&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">api</span> <span class="o">==</span> <span class="s1">&#39;model&#39;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">_call_kw_model</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">api</span> <span class="o">==</span> <span class="s1">&#39;model_create&#39;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">_call_kw_model_create</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">_call_kw_multi</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="Environment">
<a class="viewcode-back" href="../../odoo.html#odoo.api.Environment">[docs]</a>
<span class="k">class</span> <span class="nc">Environment</span><span class="p">(</span><span class="n">Mapping</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; The environment stores various contextual data used by the ORM:</span>

<span class="sd">    - :attr:`cr`: the current database cursor (for database queries);</span>
<span class="sd">    - :attr:`uid`: the current user id (for access rights checks);</span>
<span class="sd">    - :attr:`context`: the current context dictionary (arbitrary metadata);</span>
<span class="sd">    - :attr:`su`: whether in superuser mode.</span>

<span class="sd">    It provides access to the registry by implementing a mapping from model</span>
<span class="sd">    names to models. It also holds a cache for records, and a data</span>
<span class="sd">    structure to manage recomputations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Environment.reset">
<a class="viewcode-back" href="../../odoo.html#odoo.api.Environment.reset">[docs]</a>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Reset the transaction, see :meth:`Transaction.reset`. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">su</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">uid_origin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="o">==</span> <span class="n">SUPERUSER_ID</span><span class="p">:</span>
            <span class="n">su</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># isinstance(uid, int) is to handle `RequestUID`</span>
        <span class="n">uid_origin</span> <span class="o">=</span> <span class="n">uid_origin</span> <span class="ow">or</span> <span class="p">(</span><span class="n">uid</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">uid_origin</span> <span class="o">==</span> <span class="n">SUPERUSER_ID</span><span class="p">:</span>
            <span class="n">uid_origin</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">assert</span> <span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="c1"># determine transaction object</span>
        <span class="n">transaction</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">transaction</span>
        <span class="k">if</span> <span class="n">transaction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">transaction</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">transaction</span> <span class="o">=</span> <span class="n">Transaction</span><span class="p">(</span><span class="n">Registry</span><span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">dbname</span><span class="p">))</span>

        <span class="c1"># if env already exists, return it</span>
        <span class="k">for</span> <span class="n">env</span> <span class="ow">in</span> <span class="n">transaction</span><span class="o">.</span><span class="n">envs</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">su</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">uid_origin</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">su</span><span class="p">,</span> <span class="n">uid_origin</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">env</span>

        <span class="c1"># otherwise create environment, and add it in the set</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">BaseCursor</span><span class="p">)</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">su</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">frozendict</span><span class="p">(</span><span class="n">context</span><span class="p">),</span> <span class="n">su</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uid_origin</span> <span class="o">=</span> <span class="n">uid_origin</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all</span> <span class="o">=</span> <span class="n">transaction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">registry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_key</span> <span class="o">=</span> <span class="p">{}</span>                    <span class="c1"># memo {field: cache_key}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_protected</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">protected</span>
        <span class="n">transaction</span><span class="o">.</span><span class="n">envs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="c1">#</span>
    <span class="c1"># Mapping methods</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Test whether the given model exists. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return an empty recordset from the given model. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">model_name</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="p">(),</span> <span class="p">())</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return an iterator on model names. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the size of the model registry. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">su</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return an environment based on ``self`` with modified parameters.</span>

<span class="sd">        :param cr: optional database cursor to change the current cursor</span>
<span class="sd">        :type cursor: :class:`~odoo.sql_db.Cursor`</span>
<span class="sd">        :param user: optional user/user id to change the current user</span>
<span class="sd">        :type user: int or :class:`res.users record&lt;~odoo.addons.base.models.res_users.Users&gt;`</span>
<span class="sd">        :param dict context: optional context dictionary to change the current context</span>
<span class="sd">        :param bool su: optional boolean to change the superuser mode</span>
<span class="sd">        :returns: environment with specified args (new or existing one)</span>
<span class="sd">        :rtype: :class:`Environment`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span> <span class="k">if</span> <span class="n">cr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cr</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span> <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">clean_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span> <span class="k">if</span> <span class="n">su</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">su</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span>
        <span class="n">su</span> <span class="o">=</span> <span class="p">(</span><span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">su</span><span class="p">)</span> <span class="k">if</span> <span class="n">su</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">su</span>
        <span class="k">return</span> <span class="n">Environment</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">su</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid_origin</span><span class="p">)</span>

<div class="viewcode-block" id="Environment.ref">
<a class="viewcode-back" href="../../odoo.html#odoo.api.Environment.ref">[docs]</a>
    <span class="k">def</span> <span class="nf">ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_id</span><span class="p">,</span> <span class="n">raise_if_not_found</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the record corresponding to the given ``xml_id``.</span>

<span class="sd">        :param str xml_id: record xml_id, under the format ``&lt;module.id&gt;``</span>
<span class="sd">        :param bool raise_if_not_found: whether the method should raise if record is not found</span>
<span class="sd">        :returns: Found record or None</span>
<span class="sd">        :raise ValueError: if record wasn&#39;t found and ``raise_if_not_found`` is True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res_model</span><span class="p">,</span> <span class="n">res_id</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_xmlid_to_res_model_res_id</span><span class="p">(</span>
            <span class="n">xml_id</span><span class="p">,</span> <span class="n">raise_if_not_found</span><span class="o">=</span><span class="n">raise_if_not_found</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">res_model</span> <span class="ow">and</span> <span class="n">res_id</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">res_model</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">res_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">record</span>
            <span class="k">if</span> <span class="n">raise_if_not_found</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No record found for unique ID </span><span class="si">%s</span><span class="s1">. It may have been deleted.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xml_id</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Environment.is_superuser">
<a class="viewcode-back" href="../../odoo.html#odoo.api.Environment.is_superuser">[docs]</a>
    <span class="k">def</span> <span class="nf">is_superuser</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return whether the environment is in superuser mode. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">su</span></div>


<div class="viewcode-block" id="Environment.is_admin">
<a class="viewcode-back" href="../../odoo.html#odoo.api.Environment.is_admin">[docs]</a>
    <span class="k">def</span> <span class="nf">is_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return whether the current user has group &quot;Access Rights&quot;, or is in</span>
<span class="sd">            superuser mode. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">su</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">_is_admin</span><span class="p">()</span></div>


<div class="viewcode-block" id="Environment.is_system">
<a class="viewcode-back" href="../../odoo.html#odoo.api.Environment.is_system">[docs]</a>
    <span class="k">def</span> <span class="nf">is_system</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return whether the current user has group &quot;Settings&quot;, or is in</span>
<span class="sd">            superuser mode. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">su</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">_is_system</span><span class="p">()</span></div>


    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the current user (as an instance).</span>

<span class="sd">        :returns: current user - sudoed</span>
<span class="sd">        :rtype: :class:`res.users record&lt;~odoo.addons.base.models.res_users.Users&gt;`&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">(</span><span class="n">su</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">company</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the current company (as an instance).</span>

<span class="sd">        If not specified in the context (`allowed_company_ids`),</span>
<span class="sd">        fallback on current user main company.</span>

<span class="sd">        :raise AccessError: invalid or unauthorized `allowed_company_ids` context key content.</span>
<span class="sd">        :return: current company (default=`self.user.company_id`), with the current environment</span>
<span class="sd">        :rtype: :class:`res.company record&lt;~odoo.addons.base.models.res_company.Company&gt;`</span>

<span class="sd">        .. warning::</span>

<span class="sd">            No sanity checks applied in sudo mode!</span>
<span class="sd">            When in sudo mode, a user can access any company,</span>
<span class="sd">            even if not in his allowed companies.</span>

<span class="sd">            This allows to trigger inter-company modifications,</span>
<span class="sd">            even if the current user doesn&#39;t have access to</span>
<span class="sd">            the targeted company.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">company_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;allowed_company_ids&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">company_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">su</span><span class="p">:</span>
                <span class="n">user_company_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">_get_company_ids</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">company_ids</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">user_company_ids</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">AccessError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Access to unauthorized or invalid companies.&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;res.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">company_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">company_id</span><span class="o">.</span><span class="n">with_env</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">companies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a recordset of the enabled companies by the user.</span>

<span class="sd">        If not specified in the context(`allowed_company_ids`),</span>
<span class="sd">        fallback on current user companies.</span>

<span class="sd">        :raise AccessError: invalid or unauthorized `allowed_company_ids` context key content.</span>
<span class="sd">        :return: current companies (default=`self.user.company_ids`), with the current environment</span>
<span class="sd">        :rtype: :class:`res.company recordset&lt;~odoo.addons.base.models.res_company.Company&gt;`</span>

<span class="sd">        .. warning::</span>

<span class="sd">            No sanity checks applied in sudo mode !</span>
<span class="sd">            When in sudo mode, a user can access any company,</span>
<span class="sd">            even if not in his allowed companies.</span>

<span class="sd">            This allows to trigger inter-company modifications,</span>
<span class="sd">            even if the current user doesn&#39;t have access to</span>
<span class="sd">            the targeted company.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">company_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;allowed_company_ids&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">user_company_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">_get_company_ids</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">company_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">su</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">company_ids</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">user_company_ids</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">AccessError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Access to unauthorized or invalid companies.&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;res.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">company_ids</span><span class="p">)</span>
        <span class="c1"># By setting the default companies to all user companies instead of the main one</span>
        <span class="c1"># we save a lot of potential trouble in all &quot;out of context&quot; calls, such as</span>
        <span class="c1"># /mail/redirect or /web/image, etc. And it is not unsafe because the user does</span>
        <span class="c1"># have access to these other companies. The risk of exposing foreign records</span>
        <span class="c1"># (wrt to the context) is low because all normal RPCs will have a proper</span>
        <span class="c1"># allowed_company_ids.</span>
        <span class="c1"># Examples:</span>
        <span class="c1">#   - when printing a report for several records from several companies</span>
        <span class="c1">#   - when accessing to a record from the notification email template</span>
        <span class="c1">#   - when loading an binary image on a template</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;res.company&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">user_company_ids</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lang</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the current language code.</span>

<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">)</span>
        <span class="c1"># _lang_get_id is cached and used to validate lang before return,</span>
        <span class="c1"># because &#39;env.lang&#39; may be injected in SQL queries</span>
        <span class="k">return</span> <span class="n">lang</span> <span class="k">if</span> <span class="n">lang</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;res.lang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_lang_get_id</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

<div class="viewcode-block" id="Environment.clear">
<a class="viewcode-back" href="../../odoo.html#odoo.api.Environment.clear">[docs]</a>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Clear all record caches, and discard all fields to recompute.</span>
<span class="sd">            This may be useful when recovering from a failed ORM operation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lazy_property</span><span class="o">.</span><span class="n">reset_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_key</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>


<div class="viewcode-block" id="Environment.invalidate_all">
<a class="viewcode-back" href="../../odoo.html#odoo.api.Environment.invalidate_all">[docs]</a>
    <span class="k">def</span> <span class="nf">invalidate_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Invalidate the cache of all records.</span>

<span class="sd">        :param flush: whether pending updates should be flushed before invalidation.</span>
<span class="sd">            It is ``True`` by default, which ensures cache consistency.</span>
<span class="sd">            Do not use this parameter unless you know what you are doing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">flush</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_recompute_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Process all pending computations. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_to_compute</span><span class="p">()):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">_recompute_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

<div class="viewcode-block" id="Environment.flush_all">
<a class="viewcode-back" href="../../odoo.html#odoo.api.Environment.flush_all">[docs]</a>
    <span class="k">def</span> <span class="nf">flush_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Flush all pending computations and updates to the database. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recompute_all</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">OrderedSet</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">model_name</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get_dirty_fields</span><span class="p">()):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">flush_model</span><span class="p">()</span></div>


<div class="viewcode-block" id="Environment.is_protected">
<a class="viewcode-back" href="../../odoo.html#odoo.api.Environment.is_protected">[docs]</a>
    <span class="k">def</span> <span class="nf">is_protected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return whether `record` is protected against invalidation or</span>
<span class="sd">            recomputation for `field`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protected</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">())</span></div>


<div class="viewcode-block" id="Environment.protected">
<a class="viewcode-back" href="../../odoo.html#odoo.api.Environment.protected">[docs]</a>
    <span class="k">def</span> <span class="nf">protected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the recordset for which ``field`` should not be invalidated or recomputed. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_protected</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">()))</span></div>


<div class="viewcode-block" id="Environment.protecting">
<a class="viewcode-back" href="../../odoo.html#odoo.api.Environment.protecting">[docs]</a>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">protecting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">records</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Prevent the invalidation or recomputation of fields on records.</span>
<span class="sd">        The parameters are either:</span>

<span class="sd">        - ``what`` a collection of fields and ``records`` a recordset, or</span>
<span class="sd">        - ``what`` a collection of pairs ``(fields, records)``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">protected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protected</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">protected</span><span class="o">.</span><span class="n">pushmap</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">records</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Handle first signature</span>
                <span class="n">ids_by_field</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span><span class="p">:</span> <span class="n">records</span><span class="o">.</span><span class="n">_ids</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">what</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Handle second signature</span>
                <span class="n">ids_by_field</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">fields</span><span class="p">,</span> <span class="n">what_records</span> <span class="ow">in</span> <span class="n">what</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                        <span class="n">ids_by_field</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">what_records</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">rec_ids</span> <span class="ow">in</span> <span class="n">ids_by_field</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="n">protected</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                <span class="n">protected</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">ids</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">rec_ids</span><span class="p">)</span> <span class="k">if</span> <span class="n">ids</span> <span class="k">else</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">rec_ids</span><span class="p">)</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">protected</span><span class="o">.</span><span class="n">popmap</span><span class="p">()</span></div>


<div class="viewcode-block" id="Environment.fields_to_compute">
<a class="viewcode-back" href="../../odoo.html#odoo.api.Environment.fields_to_compute">[docs]</a>
    <span class="k">def</span> <span class="nf">fields_to_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return a view on the field to compute. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">tocompute</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>


<div class="viewcode-block" id="Environment.records_to_compute">
<a class="viewcode-back" href="../../odoo.html#odoo.api.Environment.records_to_compute">[docs]</a>
    <span class="k">def</span> <span class="nf">records_to_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the records to compute for ``field``. &quot;&quot;&quot;</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">tocompute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span></div>


<div class="viewcode-block" id="Environment.is_to_compute">
<a class="viewcode-back" href="../../odoo.html#odoo.api.Environment.is_to_compute">[docs]</a>
    <span class="k">def</span> <span class="nf">is_to_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return whether ``field`` must be computed on ``record``. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">tocompute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">())</span></div>


<div class="viewcode-block" id="Environment.not_to_compute">
<a class="viewcode-back" href="../../odoo.html#odoo.api.Environment.not_to_compute">[docs]</a>
    <span class="k">def</span> <span class="nf">not_to_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">records</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the subset of ``records`` for which ``field`` must not be computed. &quot;&quot;&quot;</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">tocompute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">())</span>
        <span class="k">return</span> <span class="n">records</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">id_</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">records</span><span class="o">.</span><span class="n">_ids</span> <span class="k">if</span> <span class="n">id_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">)</span></div>


<div class="viewcode-block" id="Environment.add_to_compute">
<a class="viewcode-back" href="../../odoo.html#odoo.api.Environment.add_to_compute">[docs]</a>
    <span class="k">def</span> <span class="nf">add_to_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">records</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Mark ``field`` to be computed on ``records``. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">records</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">records</span>
        <span class="k">assert</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">compute</span><span class="p">,</span> <span class="s2">&quot;Cannot add to recompute no-store or no-computed field&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">tocompute</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span></div>


<div class="viewcode-block" id="Environment.remove_to_compute">
<a class="viewcode-back" href="../../odoo.html#odoo.api.Environment.remove_to_compute">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_to_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">records</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Mark ``field`` as computed on ``records``. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">records</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">tocompute</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">ids</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">tocompute</span><span class="p">[</span><span class="n">field</span><span class="p">]</span></div>


<div class="viewcode-block" id="Environment.norecompute">
<a class="viewcode-back" href="../../odoo.html#odoo.api.Environment.norecompute">[docs]</a>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">norecompute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Deprecated: It does nothing, recomputation is delayed by default. &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;`norecompute` is useless. Deprecated since 17.0.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">yield</span></div>


<div class="viewcode-block" id="Environment.cache_key">
<a class="viewcode-back" href="../../odoo.html#odoo.api.Environment.cache_key">[docs]</a>
    <span class="k">def</span> <span class="nf">cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the cache key of the given ``field``. &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_key</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">get_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;company&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">company</span><span class="o">.</span><span class="n">id</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;uid&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">su</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;lang&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">get_context</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;active_test&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">get_context</span><span class="p">(</span><span class="s1">&#39;active_test&#39;</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active_test&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;bin_size&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">get_context</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">get_context</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">hash</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                            <span class="s2">&quot;Can only create cache keys from hashable values, &quot;</span>
                            <span class="s2">&quot;got non-hashable value </span><span class="si">{!r}</span><span class="s2"> at context key </span><span class="si">{!r}</span><span class="s2"> &quot;</span>
                            <span class="s2">&quot;(dependency of field </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                        <span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>  <span class="c1"># we don&#39;t need to chain the exception created 2 lines above</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">val</span>

            <span class="n">result</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">field_depends_context</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_key</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">return</span> <span class="n">result</span></div>
</div>



<span class="k">class</span> <span class="nc">Transaction</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; A object holding ORM data structures for a transaction. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">registry</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">registry</span>
        <span class="c1"># weak set of environments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">envs</span> <span class="o">=</span> <span class="n">WeakSet</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">()</span>  <span class="c1"># make the weakset OrderedWeakSet</span>
        <span class="c1"># cache for all records</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">Cache</span><span class="p">()</span>
        <span class="c1"># fields to protect {field: ids}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protected</span> <span class="o">=</span> <span class="n">StackMap</span><span class="p">()</span>
        <span class="c1"># pending computations {field: ids}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tocompute</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">OrderedSet</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Flush pending computations and updates in the transaction. &quot;&quot;&quot;</span>
        <span class="n">env_to_flush</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">env</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">env</span><span class="o">.</span><span class="n">uid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">env_to_flush</span> <span class="o">=</span> <span class="n">env</span>
                <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">uid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">env_to_flush</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">env_to_flush</span><span class="o">.</span><span class="n">flush_all</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Clear the caches and pending computations and updates in the translations. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tocompute</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Reset the transaction.  This clears the transaction, and reassigns</span>
<span class="sd">            the registry on all its environments.  This operation is strongly</span>
<span class="sd">            recommended after reloading the registry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">Registry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">db_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">env</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">envs</span><span class="p">:</span>
            <span class="n">env</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span>
            <span class="n">lazy_property</span><span class="o">.</span><span class="n">reset_all</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
            <span class="n">env</span><span class="o">.</span><span class="n">_cache_key</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>


<span class="c1"># sentinel value for optional parameters</span>
<span class="n">NOTHING</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
<span class="n">EMPTY_DICT</span> <span class="o">=</span> <span class="n">frozendict</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Cache</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Implementation of the cache of records.</span>

<span class="sd">    For most fields, the cache is simply a mapping from a record and a field to</span>
<span class="sd">    a value.  In the case of context-dependent fields, the mapping also depends</span>
<span class="sd">    on the environment of the given record.  For the sake of performance, the</span>
<span class="sd">    cache is first partitioned by field, then by record.  This makes some</span>
<span class="sd">    common ORM operations pretty fast, like determining which records have a</span>
<span class="sd">    value for a given field, or invalidating a given field on all possible</span>
<span class="sd">    records.</span>

<span class="sd">    The cache can also mark some entries as &quot;dirty&quot;.  Dirty entries essentially</span>
<span class="sd">    marks values that are different from the database.  They represent database</span>
<span class="sd">    updates that haven&#39;t been done yet.  Note that dirty entries only make</span>
<span class="sd">    sense for stored fields.  Note also that if a field is dirty on a given</span>
<span class="sd">    record, and the field is context-dependent, then all the values of the</span>
<span class="sd">    record for that field are considered dirty.  For the sake of consistency,</span>
<span class="sd">    the values that should be in the database must be in a context where all</span>
<span class="sd">    the field&#39;s context keys are ``None``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># {field: {record_id: value}, field: {context_key: {record_id: value}}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

        <span class="c1"># {field: set[id]} stores the fields and ids that are changed in the</span>
        <span class="c1"># cache, but not yet written in the database; their changed values are</span>
        <span class="c1"># in `_data`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">OrderedSet</span><span class="p">)</span>

        <span class="c1"># {field: {record_id: ids}} record ids to be added to the values of</span>
        <span class="c1"># x2many fields if they are not in cache yet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_patches</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># for debugging: show the cache content and dirty flags as stars</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">field_cache</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="n">dirty_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">())</span>
            <span class="k">if</span> <span class="n">field_cache</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">field_cache</span><span class="p">)),</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">key</span><span class="p">:</span> <span class="p">{</span>
                        <span class="n">Starred</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span> <span class="k">if</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">dirty_ids</span> <span class="k">else</span> <span class="n">id_</span><span class="p">:</span> <span class="n">val</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;binary&#39;</span> <span class="k">else</span> <span class="s1">&#39;&lt;binary&gt;&#39;</span>
                        <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">key_cache</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">}</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_cache</span> <span class="ow">in</span> <span class="n">field_cache</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">Starred</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span> <span class="k">if</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">dirty_ids</span> <span class="k">else</span> <span class="n">id_</span><span class="p">:</span> <span class="n">val</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;binary&#39;</span> <span class="k">else</span> <span class="s1">&#39;&lt;binary&gt;&#39;</span>
                    <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">field_cache</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_field_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the field cache of the given field, but not for modifying it. &quot;&quot;&quot;</span>
        <span class="n">field_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">EMPTY_DICT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_cache</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">field_depends_context</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
            <span class="n">field_cache</span> <span class="o">=</span> <span class="n">field_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache_key</span><span class="p">(</span><span class="n">field</span><span class="p">),</span> <span class="n">EMPTY_DICT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">field_cache</span>

    <span class="k">def</span> <span class="nf">_set_field_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the field cache of the given field for modifying it. &quot;&quot;&quot;</span>
        <span class="n">field_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">field_depends_context</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
            <span class="n">field_cache</span> <span class="o">=</span> <span class="n">field_cache</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache_key</span><span class="p">(</span><span class="n">field</span><span class="p">),</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="n">field_cache</span>

    <span class="k">def</span> <span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return whether ``record`` has a value for ``field``. &quot;&quot;&quot;</span>
        <span class="n">field_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_field_cache</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">:</span>
            <span class="n">cache_value</span> <span class="o">=</span> <span class="n">field_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">EMPTY_DICT</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cache_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="n">lang</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">_lang</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">cache_value</span>

        <span class="k">return</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">field_cache</span>

    <span class="k">def</span> <span class="nf">contains_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return whether ``field`` has a value for at least one record. &quot;&quot;&quot;</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># &#39;cache&#39; keys are tuples if &#39;field&#39; is context-dependent, record ids otherwise</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">cache</span><span class="p">)),</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">value</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cache</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">NOTHING</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the value of ``field`` for ``record``. &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">field_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_field_cache</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="n">cache_value</span> <span class="o">=</span> <span class="n">field_cache</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span> <span class="ow">and</span> <span class="n">cache_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lang</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">_lang</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">cache_value</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">cache_value</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="n">NOTHING</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CacheMiss</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="kn">from</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dirty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check_dirty</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Set the value of ``field`` for ``record``.</span>
<span class="sd">        One can normally make a clean field dirty but not the other way around.</span>
<span class="sd">        Updating a dirty field without ``dirty=True`` is a programming error and</span>
<span class="sd">        raises an exception.</span>

<span class="sd">        :param dirty: whether ``field`` must be made dirty on ``record`` after</span>
<span class="sd">            the update</span>
<span class="sd">        :param check_dirty: whether updating a dirty field without making it</span>
<span class="sd">            dirty must raise an exception</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_field_cache</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="n">record_id</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span>

        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># only for model translated fields</span>
            <span class="n">lang</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span> <span class="ow">or</span> <span class="s1">&#39;en_US&#39;</span>
            <span class="n">cache_value</span> <span class="o">=</span> <span class="n">field_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">record_id</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">cache_value</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">cache_value</span>

        <span class="n">field_cache</span><span class="p">[</span><span class="n">record_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_dirty</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">dirty</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">field</span><span class="o">.</span><span class="n">column_type</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span> <span class="n">record_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">record_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">field_depends_context</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                <span class="c1"># put the values under conventional context key values {&#39;context_key&#39;: None},</span>
                <span class="c1"># in order to ease the retrieval of those values to flush them</span>
                <span class="n">context_none</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">field_depends_context</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
                <span class="n">record</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">with_env</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context_none</span><span class="p">))</span>
                <span class="n">field_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_field_cache</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="n">field_cache</span><span class="p">[</span><span class="n">record_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">record_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">()):</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;cache.set() removing flag dirty on </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">stack_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">records</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">dirty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check_dirty</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Set the values of ``field`` for several ``records``.</span>
<span class="sd">        One can normally make a clean field dirty but not the other way around.</span>
<span class="sd">        Updating a dirty field without ``dirty=True`` is a programming error and</span>
<span class="sd">        raises an exception.</span>

<span class="sd">        :param dirty: whether ``field`` must be made dirty on ``record`` after</span>
<span class="sd">            the update</span>
<span class="sd">        :param check_dirty: whether updating a dirty field without making it</span>
<span class="sd">            dirty must raise an exception</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">:</span>
            <span class="c1"># only for model translated fields</span>
            <span class="n">lang</span> <span class="o">=</span> <span class="n">records</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span> <span class="ow">or</span> <span class="s1">&#39;en_US&#39;</span>
            <span class="n">field_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_field_cache</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="n">cache_values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">cache_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cache_value</span> <span class="o">=</span> <span class="n">field_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                    <span class="n">cache_value</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="n">cache_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cache_value</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">cache_values</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_raw</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">dirty</span><span class="p">,</span> <span class="n">check_dirty</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">records</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">dirty</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check_dirty</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; This is a variant of method :meth:`~update` without the logic for</span>
<span class="sd">        translated fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_field_cache</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="n">field_cache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_dirty</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">dirty</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">field</span><span class="o">.</span><span class="n">column_type</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">records</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">field_depends_context</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                <span class="c1"># put the values under conventional context key values {&#39;context_key&#39;: None},</span>
                <span class="c1"># in order to ease the retrieval of those values to flush them</span>
                <span class="n">context_none</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">field_depends_context</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
                <span class="n">records</span> <span class="o">=</span> <span class="n">records</span><span class="o">.</span><span class="n">with_env</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context_none</span><span class="p">))</span>
                <span class="n">field_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_field_cache</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="n">field_cache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dirty_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dirty_ids</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dirty_ids</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">):</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;cache.update() removing flag dirty on </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">records</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">stack_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">insert_missing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">records</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Set the values of ``field`` for the records in ``records`` that</span>
<span class="sd">        don&#39;t have a value yet.  In other words, this does not overwrite</span>
<span class="sd">        existing values in cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_field_cache</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">records</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prefetch_langs&#39;</span><span class="p">):</span>
                <span class="n">langs</span> <span class="o">=</span> <span class="p">{</span><span class="n">lang</span> <span class="k">for</span> <span class="n">lang</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">records</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.lang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_installed</span><span class="p">()}</span> <span class="o">|</span> <span class="p">{</span><span class="s1">&#39;en_US&#39;</span><span class="p">}</span>
                <span class="n">_langs</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">langs</span><span class="p">}</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">_lang</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">env</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">field_cache</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">id_</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">_langs</span><span class="p">:</span>  <span class="c1"># fallback missing _lang to lang if exists</span>
                            <span class="n">val</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">langs</span> <span class="ow">and</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">val</span><span class="p">})</span>
                        <span class="n">field_cache</span><span class="p">[</span><span class="n">id_</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="o">**</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">langs</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;en_US&#39;</span><span class="p">]),</span>  <span class="c1"># fallback missing lang to en_US</span>
                            <span class="o">**</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">_langs</span><span class="p">,</span> <span class="n">val</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_en_US&#39;</span><span class="p">)),</span>  <span class="c1"># fallback missing _lang to _en_US</span>
                            <span class="o">**</span><span class="n">val</span>
                        <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lang</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">_lang</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">field_cache</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">id_</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cache_value</span> <span class="o">=</span> <span class="n">field_cache</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">id_</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="k">if</span> <span class="n">cache_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">cache_value</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
                <span class="n">field_cache</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">id_</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">records</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">new_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Apply a patch to an x2many field on new records. The patch consists</span>
<span class="sd">        in adding new_id to its value in cache. If the value is not in cache</span>
<span class="sd">        yet, it will be applied once the value is put in cache with method</span>
<span class="sd">        :meth:`patch_and_set`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">new_id</span><span class="p">,</span> <span class="s2">&quot;Cache.patch can only be called with a new id&quot;</span>
        <span class="n">field_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_field_cache</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">id_</span><span class="p">,</span> <span class="s2">&quot;Cache.patch can only be called with new records&quot;</span>
            <span class="k">if</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">field_cache</span><span class="p">:</span>
                <span class="n">field_cache</span><span class="p">[</span><span class="n">id_</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">field_cache</span><span class="p">[</span><span class="n">id_</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">new_id</span><span class="p">,)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_patches</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">id_</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">patch_and_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Set the value of ``field`` for ``record``, like :meth:`set`, but</span>
<span class="sd">        apply pending patches to ``value`` and return the value actually put</span>
<span class="sd">        in cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_patches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patches</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_patches</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">field_patches</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">())</span>
            <span class="k">if</span> <span class="n">ids</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">value</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ids</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Remove the value of ``field`` for ``record``. &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">field_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_field_cache</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">field_cache</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">get_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">records</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the cached values of ``field`` for ``records``. &quot;&quot;&quot;</span>
        <span class="n">field_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_field_cache</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">record_id</span> <span class="ow">in</span> <span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">field_cache</span><span class="p">[</span><span class="n">record_id</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">get_until_miss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">records</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the cached values of ``field`` for ``records`` until a value is not found. &quot;&quot;&quot;</span>
        <span class="n">field_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_field_cache</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">:</span>
            <span class="n">lang</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">_lang</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="n">id_</span><span class="p">):</span>
                <span class="n">cache_value</span> <span class="o">=</span> <span class="n">field_cache</span><span class="p">[</span><span class="n">id_</span><span class="p">]</span>
                <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">cache_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cache_value</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">get_value</span> <span class="o">=</span> <span class="n">field_cache</span><span class="o">.</span><span class="fm">__getitem__</span>

        <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">record_id</span> <span class="ow">in</span> <span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_value</span><span class="p">(</span><span class="n">record_id</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">vals</span>

    <span class="k">def</span> <span class="nf">get_records_different_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">records</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the subset of ``records`` that has not ``value`` for ``field``. &quot;&quot;&quot;</span>
        <span class="n">field_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_field_cache</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">:</span>
            <span class="n">lang</span> <span class="o">=</span> <span class="n">records</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span> <span class="ow">or</span> <span class="s1">&#39;en_US&#39;</span>

            <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="n">id_</span><span class="p">):</span>
                <span class="n">cache_value</span> <span class="o">=</span> <span class="n">field_cache</span><span class="p">[</span><span class="n">id_</span><span class="p">]</span>
                <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">cache_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cache_value</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">get_value</span> <span class="o">=</span> <span class="n">field_cache</span><span class="o">.</span><span class="fm">__getitem__</span>

        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">record_id</span> <span class="ow">in</span> <span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">get_value</span><span class="p">(</span><span class="n">record_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record_id</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">records</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the fields with a value for ``record``. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;id&#39;</span> <span class="ow">and</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_field_cache</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">field</span>

    <span class="k">def</span> <span class="nf">get_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">all_contexts</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the records of ``model`` that have a value for ``field``.</span>
<span class="sd">        By default the method checks for values in the current context of ``model``.</span>
<span class="sd">        But when ``all_contexts`` is true, it checks for values *in all contexts*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">all_contexts</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">field_depends_context</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
            <span class="n">field_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">EMPTY_DICT</span><span class="p">)</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">(</span><span class="n">id_</span> <span class="k">for</span> <span class="n">sub_cache</span> <span class="ow">in</span> <span class="n">field_cache</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">sub_cache</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_field_cache</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_missing_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">records</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the ids of ``records`` that have no value for ``field``. &quot;&quot;&quot;</span>
        <span class="n">field_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_field_cache</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">:</span>
            <span class="n">lang</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">_lang</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">record_id</span> <span class="ow">in</span> <span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">:</span>
                <span class="n">cache_value</span> <span class="o">=</span> <span class="n">field_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">record_id</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cache_value</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">cache_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">cache_value</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">record_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">record_id</span> <span class="ow">in</span> <span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">record_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field_cache</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">record_id</span>

    <span class="k">def</span> <span class="nf">get_dirty_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the fields that have dirty records in cache. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_dirty_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the records that for which ``field`` is dirty in cache. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">()))</span>

    <span class="k">def</span> <span class="nf">has_dirty_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">records</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return whether any of the given records has dirty fields.</span>

<span class="sd">        :param fields: a collection of fields or ``None``; the value ``None`` is</span>
<span class="sd">            interpreted as any field on ``records``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">any</span><span class="p">(</span>
                <span class="ow">not</span> <span class="n">ids</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="n">records</span><span class="o">.</span><span class="n">_name</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear_dirty_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Make the given field clean on all records, and return the ids of the</span>
<span class="sd">        formerly dirty records for the field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">())</span>

    <span class="k">def</span> <span class="nf">invalidate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Invalidate the cache, partially or totally depending on ``spec``.</span>

<span class="sd">        If a field is context-dependent, invalidating it for a given record</span>
<span class="sd">        actually invalidates all the values of that field on the record.  In</span>
<span class="sd">        other words, the field is invalidated for the record in all</span>
<span class="sd">        environments.</span>

<span class="sd">        This operation is unsafe by default, and must be used with care.</span>
<span class="sd">        Indeed, invalidating a dirty field on a record may lead to an error,</span>
<span class="sd">        because doing so drops the value to be written in database.</span>

<span class="sd">            spec = [(field, ids), (field, None), ...]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">spec</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">cache</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">caches</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">cache</span><span class="p">)),</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">cache</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">field_cache</span> <span class="ow">in</span> <span class="n">caches</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                        <span class="n">field_cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">id_</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Invalidate the cache and its dirty flags. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_patches</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Check the consistency of the cache for the given environment. &quot;&quot;&quot;</span>
        <span class="n">depends_context</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">field_depends_context</span>
        <span class="n">invalids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">field_cache</span><span class="p">):</span>
            <span class="c1"># ignore new records and records to flush</span>
            <span class="n">dirty_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">())</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">id_</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">field_cache</span> <span class="k">if</span> <span class="n">id_</span> <span class="ow">and</span> <span class="n">id_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dirty_ids</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="c1"># select the column for the given ids</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_table_query</span><span class="p">)</span>
            <span class="n">sql_id</span> <span class="o">=</span> <span class="n">SQL</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span>
            <span class="n">sql_field</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_field_to_sql</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;binary&#39;</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">model</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bin_size&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">model</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bin_size_&#39;</span> <span class="o">+</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">sql_field</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;pg_size_pretty(length(</span><span class="si">%s</span><span class="s1">)::bigint)&#39;</span><span class="p">,</span> <span class="n">sql_field</span><span class="p">)</span>
            <span class="n">query</span><span class="o">.</span><span class="n">add_where</span><span class="p">(</span><span class="n">SQL</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> IN </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sql_id</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ids</span><span class="p">)))</span>
            <span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">sql_id</span><span class="p">,</span> <span class="n">sql_field</span><span class="p">))</span>

            <span class="c1"># compare returned values with corresponding values in cache</span>
            <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
                <span class="n">cached</span> <span class="o">=</span> <span class="n">field_cache</span><span class="p">[</span><span class="n">id_</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">cached</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">value</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cached</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">invalids</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">model</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">id_</span><span class="p">),</span> <span class="n">field</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;cached&#39;</span><span class="p">:</span> <span class="n">cached</span><span class="p">,</span> <span class="s1">&#39;fetched&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">}))</span>

        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">field_cache</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># check column fields only</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">column_type</span> <span class="ow">or</span> <span class="nb">callable</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">model</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">depends_context</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">context_keys</span><span class="p">,</span> <span class="n">inner_cache</span> <span class="ow">in</span> <span class="n">field_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">context</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">depends_context</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">context_keys</span><span class="p">))</span>
                    <span class="k">if</span> <span class="s1">&#39;company&#39;</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
                        <span class="c1"># the cache key &#39;company&#39; actually comes from context</span>
                        <span class="c1"># key &#39;allowed_company_ids&#39; (see property env.company</span>
                        <span class="c1"># and method env.cache_key())</span>
                        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;allowed_company_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;company&#39;</span><span class="p">)]</span>
                    <span class="n">process</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">context</span><span class="p">),</span> <span class="n">field</span><span class="p">,</span> <span class="n">inner_cache</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">process</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">field_cache</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">invalids</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Invalid cache: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pformat</span><span class="p">(</span><span class="n">invalids</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">Starred</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Simple helper class to ``repr`` a value with a star suffix. &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">!r}</span><span class="s2">*&quot;</span>


<span class="c1"># keep those imports here in order to handle cyclic dependencies correctly</span>
<span class="kn">from</span> <span class="nn">odoo</span> <span class="kn">import</span> <span class="n">SUPERUSER_ID</span>
<span class="kn">from</span> <span class="nn">odoo.modules.registry</span> <span class="kn">import</span> <span class="n">Registry</span>
<span class="kn">from</span> <span class="nn">.sql_db</span> <span class="kn">import</span> <span class="n">BaseCursor</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Amr.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>